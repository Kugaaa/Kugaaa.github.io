<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.1 - å¿«é€Ÿå¼€å§‹</title>
      <link href="/%E5%BC%80%E5%8F%91/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.1%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B.html"/>
      <url>/%E5%BC%80%E5%8F%91/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.1%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p><strong>LangChain</strong> æ˜¯ä¸€ä¸ªåŸºäºè¯­è¨€æ¨¡å‹å¼€å‘åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚å®ƒå¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><strong>æ•°æ®æ„ŸçŸ¥</strong>ï¼šå°†è¯­è¨€æ¨¡å‹ä¸å…¶ä»–æ•°æ®æºè¿æ¥èµ·æ¥</li><li><strong>ä¸»ä½“æ€§</strong>ï¼šå…è®¸è¯­è¨€æ¨¡å‹ä¸å…¶ç¯å¢ƒè¿›è¡Œäº¤äº’</li></ul><p>LangChain çš„ä¸»è¦ä»·å€¼åŒ…æ‹¬ï¼š</p><ol><li><strong>ç»„ä»¶</strong>ï¼šç”¨äºå¤„ç†è¯­è¨€æ¨¡å‹çš„æŠ½è±¡ï¼Œä»¥åŠæ¯ä¸ªæŠ½è±¡çš„ä¸€ç³»åˆ—å®ç°ã€‚ç»„ä»¶æ˜¯æ¨¡å—åŒ–ä¸”æ˜“äºä½¿ç”¨çš„ï¼Œæ— è®ºæ‚¨æ˜¯å¦ä½¿ç”¨ LangChain æ¡†æ¶çš„å…¶ä»–éƒ¨åˆ†ï¼Œéƒ½å¯ä»¥è½»æ¾ä½¿ç”¨</li><li><strong>ç°æˆçš„ç®¡é“</strong>ï¼šç”¨äºå®Œæˆç‰¹å®šé«˜çº§ä»»åŠ¡çš„ç»“æ„åŒ–ç»„ä»¶ç»„åˆ</li></ol><p>ç°æˆçš„ç®¡é“ä½¿å¾—å…¥é—¨å˜å¾—å®¹æ˜“ã€‚å¯¹äºæ›´å¤æ‚çš„åº”ç”¨ç¨‹åºå’Œç»†è‡´å…¥å¾®çš„ç”¨ä¾‹ï¼Œç»„ä»¶ä½¿å¾—è‡ªå®šä¹‰ç°æœ‰ç®¡é“æˆ–æ„å»ºæ–°ç®¡é“å˜å¾—å®¹æ˜“</p><br><p>å®è·µç¤ºä¾‹ï¼š</p><ul><li>èŠå¤©æœºå™¨äºº</li><li>ä½¿ç”¨æ•°æ®æºå›ç­”é—®é¢˜ï¼ˆçŸ¥è¯†åº“ï¼‰</li><li>åˆ†æç»“æ„åŒ–æ•°æ®</li></ul><h2 id="æ¨¡å—"><a href="#æ¨¡å—" class="headerlink" title="æ¨¡å—"></a>æ¨¡å—</h2><p>LangChain ä¸ºä»¥ä¸‹æ¨¡å—æä¾›æ ‡å‡†ã€å¯æ‰©å±•çš„æ¥å£å’Œå¤–éƒ¨é›†æˆï¼ˆåŠŸèƒ½æ¨¡å—ï¼‰</p><ul><li><strong>æ¨¡å‹ I&#x2F;O</strong>ï¼šä¸è¯­è¨€æ¨¡å‹è¿›è¡Œæ¥å£</li><li><strong>æ£€ç´¢</strong>ï¼šä¸ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„æ•°æ®è¿›è¡Œæ¥å£</li><li><strong>ç®¡é“</strong>ï¼šæ„å»ºè°ƒç”¨åºåˆ—</li><li><strong>ä»£ç†</strong>ï¼šè®©ç®¡é“æ ¹æ®é«˜çº§æŒ‡ä»¤é€‰æ‹©ä½¿ç”¨å“ªäº›å·¥å…·</li><li><strong>å†…å­˜</strong>ï¼šåœ¨ç®¡é“è¿è¡ŒæœŸé—´ä¿æŒåº”ç”¨ç¨‹åºçŠ¶æ€</li><li><strong>å›è°ƒ</strong>ï¼šè®°å½•å’Œæµå¼ä¼ è¾“ä»»ä½•ç®¡é“çš„ä¸­é—´æ­¥éª¤</li></ul><h1 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h1><h2 id="LangChain"><a href="#LangChain" class="headerlink" title="LangChain"></a>LangChain</h2><p>LangChain Python ç‰ˆæœ¬çš„å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install langchain </span><br></pre></td></tr></table></figure><h2 id="OpenAI"><a href="#OpenAI" class="headerlink" title="OpenAI"></a>OpenAI</h2><p>ä½¿ç”¨ LangChain é€šå¸¸éœ€è¦ä¸ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å‹æä¾›è€…ã€æ•°æ®å­˜å‚¨ã€APIç­‰è¿›è¡Œé›†æˆ</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ OpenAI çš„æ¨¡å‹ API</p><p>æœ¬ç¤ºä¾‹ä½¿ç”¨å¾®è½¯ Azure çš„æ¨¡å‹ API</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install openai</span><br></pre></td></tr></table></figure><h1 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h1><h2 id="æ„å»ºæ¨¡å—"><a href="#æ„å»ºæ¨¡å—" class="headerlink" title="æ„å»ºæ¨¡å—"></a>æ„å»ºæ¨¡å—</h2><p>LangChain æä¾›äº†è®¸å¤šå¯ä»¥ç”¨æ¥æ„å»ºè¯­è¨€æ¨¡å‹åº”ç”¨ç¨‹åºçš„æ¨¡å—</p><p>è¿™äº›æ¨¡å—å¯ä»¥ä½œä¸ºç®€å•åº”ç”¨ç¨‹åºä¸­çš„ç‹¬ç«‹æ¨¡å—ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆåœ¨ä¸€èµ·ç”¨äºæ›´å¤æ‚çš„ç”¨ä¾‹</p><p>LangChain åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒæ„å»ºæ¨¡å—æ˜¯ LLMChainï¼Œå®ƒç»“åˆäº†ä¸‰ä¸ªæ–¹é¢ï¼š</p><ul><li><strong>LLM</strong>ï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰ï¼šè¯­è¨€æ¨¡å‹æ˜¯æ ¸å¿ƒæ¨ç†å¼•æ“ï¼›è¦ä½¿ç”¨ LangChainï¼Œæ‚¨éœ€è¦äº†è§£ä¸åŒç±»å‹çš„è¯­è¨€æ¨¡å‹ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬</li><li><strong>Prompt Templates</strong>ï¼ˆæç¤ºè¯æ¨¡æ¿ï¼‰ï¼šæä¾›è¯­è¨€æ¨¡å‹çš„æŒ‡ä»¤ï¼›è¿™æ§åˆ¶äº†è¯­è¨€æ¨¡å‹çš„è¾“å‡ºï¼Œå› æ­¤äº†è§£å¦‚ä½•æ„å»ºæç¤ºå’Œä¸åŒçš„æç¤ºç­–ç•¥è‡³å…³é‡è¦</li><li><strong>Output Parsers</strong>ï¼ˆè¾“å‡ºè§£æå™¨ï¼‰ï¼šå°† LLM çš„åŸå§‹å“åº”è½¬æ¢ä¸ºæ›´æ˜“å¤„ç†çš„æ ¼å¼ï¼Œä½¿å¾—åœ¨ä¸‹æ¸¸ä½¿ç”¨è¾“å‡ºå˜å¾—å®¹æ˜“</li></ul><h2 id="LLMs"><a href="#LLMs" class="headerlink" title="LLMs"></a>LLMs</h2><p>LangChain ä¸­æœ‰ä¸¤ç§ç±»å‹çš„è¯­è¨€æ¨¡å‹ï¼Œç§°ä¸ºï¼š</p><ul><li><strong>LLMs</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªä»¥å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥å¹¶è¿”å›å­—ç¬¦ä¸²çš„è¯­è¨€æ¨¡å‹</li><li><strong>ChatModels</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªä»¥æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥å¹¶è¿”å›æ¶ˆæ¯çš„è¯­è¨€æ¨¡å‹</li></ul><p>LLMs çš„è¾“å…¥&#x2F;è¾“å‡ºç®€å•æ˜“æ‡‚ï¼Œæ˜¯å­—ç¬¦ä¸²</p><p>ä½†æ˜¯ ChatModels è¾“å…¥æ˜¯ä¸€ä¸ª <code>ChatMessage</code> åˆ—è¡¨ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªå•ç‹¬çš„ <code>ChatMessage</code>ï¼Œä¸€ä¸ª <code>ChatMessage</code> å…·æœ‰ä¸¤ä¸ªå¿…éœ€çš„ç»„ä»¶ï¼š</p><ul><li><code>content</code>: è¿™æ˜¯æ¶ˆæ¯çš„å†…å®¹</li><li><code>role</code>: è¿™æ˜¯<code>ChatMessage</code>æ¥è‡ªçš„å®ä½“çš„è§’è‰²</li></ul><p>LangChain æä¾›äº†å‡ ä¸ªå¯¹è±¡ï¼Œç”¨äºæ–¹ä¾¿åœ°åŒºåˆ†ä¸åŒçš„è§’è‰²ï¼š</p><ul><li><code>HumanMessage</code>ï¼šæ¥è‡ªäººç±»&#x2F;ç”¨æˆ·çš„ <code>ChatMessage</code></li><li><code>AIMessage</code>ï¼šæ¥è‡ªAI&#x2F;åŠ©æ‰‹çš„ <code>ChatMessage</code></li><li><code>SystemMessage</code>ï¼šæ¥è‡ªç³»ç»Ÿçš„ <code>ChatMessage</code></li><li><code>FunctionMessage</code>ï¼šæ¥è‡ªå‡½æ•°è°ƒç”¨çš„ <code>ChatMessage</code></li></ul><p>å¦‚æœè¿™äº›è§’è‰²éƒ½ä¸åˆé€‚ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>ChatMessage</code> ç±»æ‰‹åŠ¨æŒ‡å®šè§’è‰²ï¼Œæœ‰å…³å¦‚ä½•æœ€æœ‰æ•ˆåœ°ä½¿ç”¨è¿™äº›ä¸åŒçš„æ¶ˆæ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æˆ‘ä»¬çš„æç¤ºæŒ‡å—</p><p>LangChain ä¸ºä¸¤è€…æä¾›äº†ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œä½†äº†è§£è¿™ç§å·®å¼‚ä»¥ä¾¿ä¸ºç»™å®šçš„è¯­è¨€æ¨¡å‹æ„å»ºæç¤ºéå¸¸æœ‰ç”¨<br>LangChain æä¾›çš„æ ‡å‡†æ¥å£æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li><code>predict</code>ï¼šæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</li><li><code>predict_messages</code>ï¼šæ¥å—ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨ï¼Œè¿”å›ä¸€ä¸ªæ¶ˆæ¯</li></ul><br><p>ä¸¤è€…çš„åŒºåˆ«ï¼Œé¦–å…ˆï¼Œè®©æˆ‘ä»¬å¯¼å…¥ LLM å’Œ ChatModel</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.llms <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">llm = OpenAI()</span><br><span class="line">chat_model = ChatOpenAI()</span><br><span class="line"></span><br><span class="line">llm.predict(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;Hi&quot;</span></span><br><span class="line"></span><br><span class="line">chat_model.predict(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;Hi&quot;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>predict</code> æ–¹æ³•å¯¹å­—ç¬¦ä¸²è¾“å…¥è¿›è¡Œå¤„ç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;What would be a good company name for a company that makes colorful socks?&quot;</span></span><br><span class="line"></span><br><span class="line">llm.predict(text)</span><br><span class="line"><span class="comment"># &gt;&gt; Feetful of Fun</span></span><br><span class="line"></span><br><span class="line">chat_model.predict(text)</span><br><span class="line"><span class="comment"># &gt;&gt; Socks O&#x27;Color</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>predict_messages</code> æ–¹æ³•å¯¹æ¶ˆæ¯åˆ—è¡¨è¿›è¡Œå¤„ç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.schema <span class="keyword">import</span> HumanMessage</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;åˆ¶é€ å¤šå½©è¢œå­çš„å…¬å¸çš„å¥½åå­—æ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span></span><br><span class="line">messages = [HumanMessage(content=text)]</span><br><span class="line"></span><br><span class="line">llm.predict_messages(messages)</span><br><span class="line"><span class="comment"># &gt;&gt; Feetful of Fun</span></span><br><span class="line"></span><br><span class="line">chat_model.predict_messages(messages)</span><br><span class="line"><span class="comment"># &gt;&gt; Socks O&#x27;Color</span></span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸¤ç§æ–¹æ³•ï¼Œè¿˜å¯ä»¥å°†å‚æ•°ä½œä¸ºå…³é”®å­—å‚æ•°ä¼ é€’ï¼Œä¾‹å¦‚å¯ä»¥ä¼ å…¥ <code>temperature=0</code> æ¥è°ƒæ•´ä½¿ç”¨çš„æ¸©åº¦ï¼Œè¯¥æ¸©åº¦å°†è¦†ç›–å¯¹è±¡çš„é…ç½®</p><p>éœ€è¦æ³¨æ„åœ¨è¿è¡Œæ—¶ä¼ å…¥çš„ä»»ä½•å€¼éƒ½å°†å§‹ç»ˆè¦†ç›–å¯¹è±¡çš„é…ç½®</p><h2 id="AzureOpenAI-LLM"><a href="#AzureOpenAI-LLM" class="headerlink" title="AzureOpenAI LLM"></a>AzureOpenAI LLM</h2><p>æœ¬ç¤ºä¾‹ä½¿ç”¨å¾®è½¯ Azure çš„æ¨¡å‹ API</p><p>å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://learn.microsoft.com/zh-cn/azure/machine-learning/prompt-flow/how-to-integrate-with-langchain?view=azureml-api-2">åœ¨æç¤ºæµä¸­ä¸ LangChain é›†æˆ - Azure Machine Learning | Microsoft Learn</a><br>æˆ–è€… LangChain çš„ LLM Integrations æ–‡æ¡£ <a href="https://python.langchain.com.cn/docs/modules/model_io/models/llms/integrations/azure_openai_example">Azure OpenAI | ğŸ¦œï¸ğŸ”— Langchain</a> | <a href="https://python.langchain.com.cn/docs/modules/model_io/models/chat/integrations/azure_chat_openai">Azure | ğŸ¦œï¸ğŸ”— Langchain</a></p><p>åˆ›å»º <code>LLM</code> å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.llms.openai <span class="keyword">import</span> AzureOpenAI</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_TYPE&quot;</span>] = <span class="string">&quot;azure&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_VERSION&quot;</span>] = <span class="string">&quot;2023-03-15-preview&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_KEY&quot;</span>] = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">llm = AzureOpenAI(</span><br><span class="line">    deployment_name=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    azure_endpoint=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    model_name=<span class="string">&quot;gpt-35-turbo-16k&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">result = llm.predict(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½ä¼šæ¥æ”¶åˆ°é”™è¯¯çš„è¿”å›</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;error&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;code&#x27;<span class="punctuation">:</span> &#x27;OperationNotSupported&#x27;<span class="punctuation">,</span> &#x27;message&#x27;<span class="punctuation">:</span> &#x27;The completion operation does not work with the specified model<span class="punctuation">,</span> gpt<span class="number">-35</span>-turbo<span class="number">-16</span>k. Please choose different model and try again. You can learn more about which models can be used with each operation here<span class="punctuation">:</span> https<span class="punctuation">:</span><span class="comment">//go.microsoft.com/fwlink/?linkid=2197993.&#x27;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯ <code>gpt-35-turbo-16k</code> æ¨¡å‹ä¸èƒ½ç”¨äº <code>AzureOpenAI</code> å¯¹è±¡ï¼Œåº”è¯¥ä½¿ç”¨ <code>AzureChatOpenAI</code>ï¼›æˆ‘ç†è§£ Azure çš„ AI æœåŠ¡å¯¹æ–‡æœ¬å¤„ç†ï¼ˆLangChain ä¸­çš„ LLMsï¼‰å’Œé—®ç­”ã€èŠå¤©ï¼ˆLangChain ä¸­çš„ ChatModelsï¼‰åšäº†åŒºåˆ†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ AzureChatOpenAI</span></span><br><span class="line">llm = AzureChatOpenAI(</span><br><span class="line">    deployment_name=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    azure_endpoint=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    model_name=<span class="string">&quot;gpt-35-turbo-16k&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="æç¤ºæ¨¡æ¿"><a href="#æç¤ºæ¨¡æ¿" class="headerlink" title="æç¤ºæ¨¡æ¿"></a>æç¤ºæ¨¡æ¿</h2><p>æç¤ºæ¨¡æ¿å¯ä»¥å°†ç”¨æˆ·è¾“å…¥è½¬åŒ–ä¸ºå®Œå…¨æ ¼å¼åŒ–çš„æç¤ºçš„æ‰€æœ‰é€»è¾‘ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•åº”ç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prompt = PromptTemplate.from_template(<span class="string">&quot;please tell me in which country is &#123;city_name&#125; located?&quot;</span>)</span><br><span class="line">text = prompt.<span class="built_in">format</span>(city_name=<span class="string">&quot;BeiJing&quot;</span>)</span><br><span class="line"><span class="comment"># text = please tell me in which country is BeiJing located?</span></span><br><span class="line">result = llm.predict(text)</span><br><span class="line"><span class="comment"># &gt;&gt; Beijing is located in China. </span></span><br></pre></td></tr></table></figure><p>æç¤ºæ¨¡æ¿ä¸ä»…æ˜¯ç”¨äºå°†å­—ç¬¦ä¸²è¿›è¡Œæ ¼å¼åŒ–ï¼Œä¸»è¦çš„ä¼˜åŠ¿ï¼š</p><ul><li>å¤šæç¤ºä¸­æŠ½å‡ºå…±åŒå˜é‡ï¼Œåªæ ¼å¼åŒ–ä¸€æ¬¡</li><li>ç”Ÿæˆæ¶ˆæ¯åˆ—è¡¨ï¼Œç³»ç»Ÿæ¶ˆæ¯ã€è§’è‰²æ¶ˆæ¯ç­‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;You are a helpful assistant that translates &#123;input_language&#125; to &#123;output_language&#125;.&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line">human_template = <span class="string">&quot;&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])</span><br><span class="line">messages = chat_prompt.format_messages(input_language=<span class="string">&quot;English&quot;</span>, output_language=<span class="string">&quot;French&quot;</span>, text=<span class="string">&quot;I love programming.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(messages)</span><br><span class="line"><span class="comment"># &gt;&gt; [SystemMessage(content=&#x27;You are a helpful assistant that translates English to French.&#x27;), HumanMessage(content=&#x27;I love programming.&#x27;)]</span></span><br></pre></td></tr></table></figure><p>æ›´å¤šè¯¦è§åç»­æç¤ºè¯ç›¸å…³å†…å®¹</p><h2 id="è¾“å‡ºè§£æå™¨"><a href="#è¾“å‡ºè§£æå™¨" class="headerlink" title="è¾“å‡ºè§£æå™¨"></a>è¾“å‡ºè§£æå™¨</h2><p><code>OutputParsers</code> å°† LLM çš„åŸå§‹è¾“å‡ºè½¬æ¢ä¸ºå¯ä»¥åœ¨ä¸‹æ¸¸ä½¿ç”¨çš„æ ¼å¼<br>è¾“å‡ºè§£æå™¨æœ‰å‡ ç§ä¸»è¦ç±»å‹ï¼š</p><ul><li>å°† LLM çš„æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„åŒ–ä¿¡æ¯ï¼ˆä¾‹å¦‚ JSONï¼‰</li><li>å°† ChatMessage è½¬æ¢ä¸ºå­—ç¬¦ä¸²</li><li>å°†é™¤æ¶ˆæ¯ä¹‹å¤–çš„å…¶ä»–ä¿¡æ¯ï¼ˆå¦‚ OpenAI å‡½æ•°è°ƒç”¨ï¼‰è½¬æ¢ä¸ºå­—ç¬¦ä¸²</li></ul><p>å®˜æ–¹ä¾‹å­ä¸­å®ç°äº†ä¸€ä¸ª<strong>å°†é€—å·åˆ†éš”çš„åˆ—è¡¨è½¬æ¢ä¸ºåˆ—è¡¨</strong>çš„è§£æå™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.schema <span class="keyword">import</span> BaseOutputParser</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommaSeparatedListOutputParser</span>(<span class="title class_ inherited__">BaseOutputParser</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parse the output of an LLM call to a comma-separated list.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, text: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Parse the output of an LLM call.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> text.strip().split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line"></span><br><span class="line">CommaSeparatedListOutputParser().parse(<span class="string">&quot;hi, bye&quot;</span>)</span><br><span class="line"><span class="comment"># &gt;&gt; [&#x27;hi&#x27;, &#x27;bye&#x27;]</span></span><br></pre></td></tr></table></figure><h2 id="LLMChain"><a href="#LLMChain" class="headerlink" title="LLMChain"></a>LLMChain</h2><p>ç°åœ¨å¯ä»¥å°†æ‰€æœ‰è¿™äº›ç»„åˆæˆä¸€ä¸ªé“¾ç»„ä»¶</p><p>è¿™ä¸ªé“¾ç»„ä»¶å°†æ¥æ”¶è¾“å…¥å˜é‡ï¼Œå°†å…¶ä¼ é€’ç»™æç¤ºæ¨¡æ¿ä»¥åˆ›å»ºæç¤ºï¼Œå°†æç¤ºä¼ é€’ç»™ LLMï¼Œç„¶åé€šè¿‡ä¸€ä¸ªï¼ˆå¯é€‰çš„ï¼‰è¾“å‡ºè§£æå™¨å°†è¾“å‡ºè§£æåè¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> AzureChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.prompts.chat <span class="keyword">import</span> (</span><br><span class="line">    ChatPromptTemplate,</span><br><span class="line">    SystemMessagePromptTemplate,</span><br><span class="line">    HumanMessagePromptTemplate,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> langchain.schema <span class="keyword">import</span> BaseOutputParser</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommaSeparatedListOutputParser</span>(<span class="title class_ inherited__">BaseOutputParser</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parse the output of an LLM call to a comma-separated list.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, text: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Parse the output of an LLM call.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> text.strip().split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_TYPE&quot;</span>] = <span class="string">&quot;azure&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_VERSION&quot;</span>] = <span class="string">&quot;2023-03-15-preview&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_KEY&quot;</span>] = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">chat_model = AzureChatOpenAI(</span><br><span class="line">    deployment_name=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    azure_endpoint=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    model_name=<span class="string">&quot;gpt-35-turbo-16k&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;You are a helpful assistant who generates comma separated lists.</span></span><br><span class="line"><span class="string">A user will pass in a category, and you should generate 5 objects in that category in a comma separated list.</span></span><br><span class="line"><span class="string">ONLY return a comma separated list, and nothing more.&quot;&quot;&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line">human_template = <span class="string">&quot;&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br><span class="line"></span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])</span><br><span class="line">chain = LLMChain(</span><br><span class="line">    llm=chat_model,</span><br><span class="line">    prompt=chat_prompt,</span><br><span class="line">    output_parser=CommaSeparatedListOutputParser()</span><br><span class="line">)</span><br><span class="line">result = chain.run(<span class="string">&quot;DC super hero&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; [&#x27;Superman&#x27;, &#x27;Batman&#x27;, &#x27;Wonder Woman&#x27;, &#x27;The Flash&#x27;, &#x27;Aquaman&#x27;]</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­è®© AI æˆä¸ºä¸€ä¸ªè¾“å‡º 5 ä¸ªæŒ‡å®šåˆ†ç±»ä¸‹å¯¹è±¡ï¼Œå¹¶ä¸”ä½¿ç”¨é€—å·åˆ†éš”çš„åŠ©æ‰‹</p><h1 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h1><p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åˆ›å»º LangChain åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒæ„å»ºå— - LLMChains</p><p>åœ¨æ‰€æœ‰è¿™äº›ç»„ä»¶ï¼ˆLLMsã€promptsã€è¾“å‡ºè§£æå™¨ï¼‰ä¸­è¿˜æœ‰å¾ˆå¤šå¾®å¦™ä¹‹å¤„ï¼Œä¼šåœ¨åé¢æŒç»­å­¦ä¹ </p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://python.langchain.com.cn/docs/get_started/quickstart">å¿«é€Ÿå…¥é—¨ | ğŸ¦œï¸ğŸ”— Langchain</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LangChain </tag>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Neon City</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Neon%20City.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Neon%20City.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://assets-prd.punchdrink.com/wp-content/uploads/2023/11/03141805/Vertical_NeonCity-500x688.jpg"></p><h1 id="éœ“è™¹éƒ½å¸‚-Neon-City"><a href="#éœ“è™¹éƒ½å¸‚-Neon-City" class="headerlink" title="éœ“è™¹éƒ½å¸‚ Neon City"></a>éœ“è™¹éƒ½å¸‚ Neon City</h1><p>åœ¨è¿™åœºæœ‰è¶£çš„ highball æ¯”èµ›ä¸­ï¼ŒNine Bar çš„è€æ¿ Lily Wang å’Œ Joe Briglio å±•ç¤ºäº†ä»–ä»¬æœ€å–œæ¬¢çš„å¤å­£ç¾é£Ÿä¹‹ä¸€çš„å‘³é“ï¼šæ„å¤§åˆ©å†°ï¼Œå°½ç®¡æœ‰ä¸€äº›æ„æƒ³ä¸åˆ°çš„æ·»åŠ </p><p>Lily Wang å’Œ Joe Briglio å°† Nine Bar æè¿°ä¸º â€œäºšæ´²é£æ ¼çš„é¸¡å°¾é…’é…’å§â€ï¼ŒNeon City ä»¥çƒ§é…’ï¼ˆshochuï¼‰ä¸ºåŸºç¡€ï¼Œè¾…ä»¥æ¸…é…’ï¼ˆsakeï¼‰ã€å¯å°”å¿…æ€ï¼ˆCalpicoï¼‰å’Œç™½é…’ï¼ˆbaijiuï¼‰</p><p>æ‰€æœ‰è¿™äº›ç»“åˆåœ¨ä¸€èµ·å½¢æˆäº†å±‚æ¬¡åˆ†æ˜çš„åŸºç¡€ï¼Œå¼€èƒƒåˆ©å£é…’å’Œæ–°é²œæŸ æª¬æ±å¸¦æ¥äº†é¥®æ–™çµæ„Ÿä¸­é¢„æœŸçš„æµ“éƒæŸ‘æ©˜å‘³ã€‚Lily Wang å½¢å®¹å®ƒ â€œè®©äººè€³ç›®ä¸€æ–°ï¼Œæœ‰ç‚¹æ—¶é«¦ï¼Œæ‹¥æœ‰ä»¤äººæ„‰å¿«çš„é…¸å‘³â€</p><h1 id="åŸæ–™"><a href="#åŸæ–™" class="headerlink" title="åŸæ–™"></a>åŸæ–™</h1><p><em>Serving: 1</em></p><ul><li>çƒ§é…’ï¼ˆæœ€å¥½æ˜¯ Mizu Saga å¤§éº¦çƒ§é…’ï¼‰ - 1 ç›å¸</li><li>æ¸…é…’ï¼ˆæœ€å¥½æ˜¯ Joto æŸšå­æ¸…é…’ï¼‰ - 0.75 ç›å¸</li><li>å¯å°”å¿…æ€ - 0.75 ç›å¸</li><li>å¼€èƒƒåˆ©å£é…’ï¼ˆæœ€å¥½æ˜¯ St. Agrestis Paradisoï¼‰- 0.5 ç›å¸</li><li>ç™½é…’ï¼ˆæœ€å¥½æ˜¯ Ming Riverï¼‰ - 0.25 ç›å¸</li><li>æŸ æª¬æ± - 0.25 ç›å¸</li><li>Topo Chico - åŠ æ»¡</li></ul><p><strong>è£…é¥°</strong>ï¼šæ©™å­ç‰‡</p><h1 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h1><ul><li>å°†é™¤ Topo Chico å¤–çš„æ‰€æœ‰åŸæ–™æ”¾å…¥åŠ å†°çš„æµ·æ³¢æ¯ä¸­æ··åˆ</li><li>åŠ æ»¡ Topo Chico</li><li>ç”¨ä¸€ç‰‡æ©™å­ç‰‡è£…é¥°</li></ul><h1 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h1><h2 id="Ming-River-Baijiu"><a href="#Ming-River-Baijiu" class="headerlink" title="Ming River Baijiu"></a>Ming River Baijiu</h2><p>æœ‰æ„æ€çš„æ˜¯è¿™ä¸ª â€ä¸œæ–¹é£æ ¼â€œ çš„é…æ–¹é‡Œç”¨åˆ°äº†çƒ§é…’ã€æ¸…é…’å’Œç™½é…’</p><p>ç™½é…’æåˆ°çš„ <em>Ming River</em>ï¼Œä¸­æ–‡åä¸ºæ˜æ±Ÿç™½é…’ï¼Œæ˜¯æ³¸å·è€çª–å…¬å¸å‡ºå“çš„ä¸€æ¬¾æµ·å¤–äº§å“ï¼Œä¸“é—¨é’ˆå¯¹å›½å¤–å¸‚åœº</p><p><a href="https://shopmingriver.com/">Welcome - Shop Ming River</a></p><p><a href="https://zhuanlan.zhihu.com/p/71534144">é‚£äº›åœ¨insä¸Šçˆ†ç«çš„ç™½é…’ï¼å‡­ä»€ä¹ˆè®©å¤–å›½äººç–¯ç‹‚ï¼Ÿ</a></p><p>åŒ…è£…çœ‹èµ·æ¥ç¡®å®æ¯”å›½å†…å¸‚åœºç™½é…’æ›´é€‚åˆæµ·å¤–å®¡ç¾</p><p><img src="https://shopmingriver.com/wp-content/themes/shop-ming-river/images/header.jpg" alt="Ming River"></p><h2 id="Topo-Chico"><a href="#Topo-Chico" class="headerlink" title="Topo Chico"></a>Topo Chico</h2><p>Topo Chico æ˜¯ä¸€å®¶å¢¨è¥¿å“¥è½¯é¥®æ–™ç”Ÿäº§å•†ï¼Œä¸»è¦ç”Ÿäº§çŸ¿æ³‰æ°´ï¼Œè‹æ‰“é¥®æ–™ç­‰ï¼›è¢«å¯å£å¯ä¹æ”¶è´­</p><blockquote><p>Topo Chico æ°”æ³¡æ°´é•¿æœŸä»¥æ¥è¢«ç”¨äºè°ƒåˆ¶é…’ç²¾é¥®æ–™ï¼Œè¿™ç§å’Œé…’ç²¾çš„ â€œç¼˜åˆ†â€ ä¹Ÿæˆä¸ºäº† Topo Chico ç¡¬è‹æ‰“æ°”æ³¡é…’çš„ç ”å‘çµæ„Ÿ</p><p>2020 å¹´ 10 æœˆï¼Œå¯å£å¯ä¹è®¡åˆ’ä¸å•¤é…’å·¨å¤´ Molson Coors åˆä½œï¼Œäº 2021 ä¸ŠåŠå¹´åœ¨ç¾å›½æ¨å‡º Topo Chico ç¡¬è‹æ‰“æ°”æ³¡é…’</p></blockquote><p><img src="https://image.9928.tv/UserFiles/tangjiuhui/20220414/20220414105716.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†ç‰‡ä¸ç­‰äºåˆ†å¸ƒå¼</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F.html</url>
      
        <content type="html"><![CDATA[<p>åˆ†ç‰‡ï¼ˆshardingï¼‰æ˜¯ä¸€ç§å°†æ•°æ®å’Œè´Ÿè½½åˆ†å¸ƒåœ¨å‡ ä¸ªç‹¬ç«‹æ•°æ®åº“å®ä¾‹ä¸­çš„æŠ€æœ¯</p><p>è¯¥æ–¹æ³•é€šè¿‡å°†åŸå§‹æ•°æ®é›†æ‹†åˆ†ä¸ºç¢ç‰‡ï¼ˆshardsï¼‰æ¥åˆ©ç”¨æ°´å¹³å¯ä¼¸ç¼©æ€§ï¼Œç„¶åå°†å…¶åˆ†å¸ƒåœ¨å¤šä¸ªæ•°æ®åº“å®ä¾‹ä¸­</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1yg3PV8O2RO4YegyiYeiItA.png" class="" title="img"><p>ä½†æ˜¯ï¼Œå³ä½¿åŠ¨è¯ <em>distributes</em> å‡ºç°åœ¨åˆ†ç‰‡çš„å®šä¹‰ä¸­ï¼Œåˆ†ç‰‡æ•°æ®åº“ä¹Ÿä¸æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“</p><h1 id="åˆ†ç‰‡è§£å†³æ–¹æ¡ˆ"><a href="#åˆ†ç‰‡è§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†ç‰‡è§£å†³æ–¹æ¡ˆ"></a>åˆ†ç‰‡è§£å†³æ–¹æ¡ˆ</h1><p>æ¯ä¸ªåˆ†ç‰‡è§£å†³æ–¹æ¡ˆåœ¨å…¶æ¶æ„ä¸­éƒ½æœ‰ä¸€ä¸ªè‡³å…³é‡è¦çš„ç»„ä»¶</p><p>è¯¥ç»„ä»¶è¢«å®šä¹‰ä¸ºå„ç§å„æ ·çš„åå­—ï¼Œä¾‹å¦‚ï¼šåè°ƒè€…ï¼ˆcoordinatorï¼‰ã€è·¯ç”±å™¨ï¼ˆrouterï¼‰ã€ä»£ç†äººï¼ˆdirectorï¼‰</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1kp39_8mQ0E9bIO0Lw3PGFw.png" class="" title="img"><p>åè°ƒè€…æ˜¯å”¯ä¸€çŸ¥é“æ•°æ®åˆ†å¸ƒçš„ç»„ä»¶ï¼Œå®ƒæ˜ å°„å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°ç‰¹æ®Šçš„åˆ†ç‰‡ä¸Šï¼Œæ¥ç€æ˜ å°„åˆ°å¯¹åº”çš„æ•°æ®åº“å®ä¾‹</p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯å¿…é¡»é€šè¿‡åè°ƒè€…è·¯ç”±å®ƒä»¬çš„è¯·æ±‚</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼šå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯å¸Œæœ›æ’å…¥ä¸€æ¡æ•°æ®åˆ° <code>Car</code> è¿™å¼ è¡¨ï¼Œè¯¥è¯·æ±‚é¦–å…ˆä¼šæäº¤åˆ°åè°ƒè€…ï¼›åè°ƒè€…ä¼šæ˜ å°„è¯¥è®°å½•çš„ä¸»é”®ï¼ˆåŸæ–‡ä¸­æ˜¯ <em>primary key</em>ï¼Œè¿™é‡Œåº”è¯¥ä¸»è¦æŒ‡åˆ†è¡¨é”®ï¼‰åˆ°å…¶ä¸­ä¸€ä¸ªåˆ†ç‰‡ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™è´Ÿè´£è¯¥åˆ†ç‰‡çš„æ•°æ®åº“å®ä¾‹</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1YNUB6y8WJnp0CCVAXSjQ0g.png" class="" title="img"><p>åœ¨ä¸Šè¿°ç¤ºæ„å›¾ä¸­ï¼Œé¦–å…ˆåè°ƒè€…æ˜ å°„é”® <code>121</code> åˆ°åˆ†ç‰‡ <code>10</code>ï¼Œæ¥ç€æ’å…¥æ•°æ®åˆ°æŒæœ‰åˆ†ç‰‡ <code>10</code>ï¼Œå³è¡¨ <code>car_10</code> çš„æ•°æ®åº“å®ä¾‹ä¸Š</p><p>å¯æ˜¯äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆåœ¨åˆ†ç‰‡è§£å†³æ–¹æ¡ˆä¸­éœ€è¦ä¸€ä¸ªåè°ƒè€…çš„è§’è‰²ï¼Ÿç­”æ¡ˆæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼šåˆ†ç‰‡å­˜å‚¨åœ¨ä¸ºå•æœåŠ¡å™¨éƒ¨ç½²è®¾è®¡çš„æ•°æ®åº“å®ä¾‹ä¸Š</p><blockquote><p><em>These database instances do not communicate with each other, nor do they support any protocols that would facilitate such communication. Unaware of each other, they exist in their own isolated environments, oblivious to the fact that they are part of a larger system.</em></p><p>è¿™äº›æ•°æ®åº“å®ä¾‹ä¸ç›¸äº’é€šä¿¡ï¼Œä¹Ÿä¸æ”¯æŒä»»ä½•æœ‰åŠ©äºè¿™ç§é€šä¿¡çš„åè®®ã€‚å®ƒä»¬å½¼æ­¤ä¸çŸ¥æƒ…ï¼Œå­˜åœ¨äºè‡ªå·±å­¤ç«‹çš„ç¯å¢ƒä¸­ï¼Œå¿½ç•¥äº†å®ƒä»¬æ˜¯ä¸€ä¸ªæ›´å¤§ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†è¿™ä¸€äº‹å®</p></blockquote><p>å› æ­¤åœ¨åˆ†ç‰‡è§£å†³æ–¹æ¡ˆä¸­åè°ƒè€…æ˜¯ä¸å¯æˆ–ç¼ºçš„è§’è‰²ï¼›å¦‚æœä½ æœ‰å…´è¶£æ·±å…¥ç ”ç©¶ç¢ç‰‡æ•°æ®åº“æ¶æ„ï¼Œå¯ä»¥è€ƒè™‘æ¢ç´¢ CitusData æˆ– Azure CosmosDB for PostgreSQLã€Vitess for MySQLã€Oracle åˆ†å¸ƒå¼è‡ªæ²»æ•°æ®åº“å’Œ MongoDB sharded Cluster</p><h1 id="åˆ†å¸ƒå¼æ•°æ®åº“"><a href="#åˆ†å¸ƒå¼æ•°æ®åº“" class="headerlink" title="åˆ†å¸ƒå¼æ•°æ®åº“"></a>åˆ†å¸ƒå¼æ•°æ®åº“</h1><p>ä¸åˆ†ç‰‡æ•°æ®åº“è§£å†³æ–¹æ¡ˆéå¸¸ç›¸ä¼¼ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¹Ÿä½¿ç”¨ç±»ä¼¼çš„åˆ†ç‰‡æŠ€æœ¯åœ¨æ•°æ®åº“èŠ‚ç‚¹é›†ç¾¤ä¸­å­˜å‚¨å’Œè¯»å–æ•°æ®</p><p>ä¸åŒçš„æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸ä¾é åè°ƒè€…ç»„ä»¶</p><p><strong>åˆ†å¸ƒå¼æ•°æ®åº“å»ºç«‹åœ¨ä¸€ä¸ªæ— å…±äº«çš„ä½“ç³»ç»“æ„ä¸Š</strong>ï¼Œè¯¥ä½“ç³»ç»“æ„æ²¡æœ‰åƒåè°ƒè€…è¿™æ ·çš„å•ä¸€ç»„ä»¶ï¼Œæ‰¿æ‹…ç€è®¸å¤šå†³ç­–çš„è´Ÿæ‹…ï¼š</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1deOgcXccWs9lKUSgLPNOww.png" class="" title="img"><p><em>é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½çŸ¥é“å½¼æ­¤ï¼Œä»è€ŒçŸ¥é“æ•°æ®åˆ†å¸ƒï¼›é€šè¿‡ç›´æ¥é€šä¿¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å°†å®¢æˆ·ç«¯è¯·æ±‚è·¯ç”±åˆ°é€‚å½“çš„åˆ†ç‰‡æ‰€æœ‰è€…ï¼›æ­¤å¤–å®ƒä»¬è¿˜å¯ä»¥æ‰§è¡Œå’Œåè°ƒå¤šèŠ‚ç‚¹äº‹åŠ¡ï¼Œå½“ç¼©æ”¾åˆ°æ›´å¤šèŠ‚ç‚¹æ—¶ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨é‡æ–°å¹³è¡¡å’Œæ‹†åˆ†åˆ†ç‰‡ï¼›èŠ‚ç‚¹ç»´æŠ¤æ•°æ®çš„å†—ä½™å‰¯æœ¬ï¼ˆåŸºäºé…ç½®çš„å¤åˆ¶å› å­ï¼‰ï¼Œå³ä½¿æŸäº›èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹ç»§ç»­æ“ä½œ</em></p><p>æ‰€æœ‰è¿™äº›å¯¹å®¢æˆ·ç«¯æ¥è¯´éƒ½æ˜¯é€æ˜çš„ï¼Œå®¢æˆ·ç«¯åªéœ€ä¸ä»»ä½•èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå¹¶å…è®¸è¯¥èŠ‚ç‚¹ç®¡ç†åˆ†å¸ƒå¼æ–¹é¢</p><p>ä¸¾ä¸ªä¾‹å­ï¼šä¸€ä¸ªå®¢æˆ·ç«¯å¯èƒ½è¿æ¥åˆ° <code>node1</code> ç„¶åæ’å…¥äº†ä¸€æ¡ <code>Car</code> çš„æ–°æ•°æ®ï¼Œid ä¸º <code>121</code>ï¼›å¦‚æœ <code>node1</code> æ˜¯åˆ†ç‰‡çš„æ‰€æœ‰è€…ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨æœ¬åœ°å­˜å‚¨è®°å½•ï¼Œå¹¶ä¸”é‡‡ç”¨ä¸€è‡´æ€§ç®—æ³•ï¼ˆconsensus algorithmï¼‰å°†å˜æ›´å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹çš„å­é›†ï¼›å¦‚æœä¸æ˜¯æ‰€æœ‰è€…ï¼Œ<code>node1</code> ä¼šå°†è¯·æ±‚è½¬å‘ç»™åˆ†ç‰‡çš„æŒæœ‰è€…ï¼Œæ¯”å¦‚ <code>node4</code></p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1weEdq2BxIpf6GiLjipns5Q.png" class="" title="img"><p>å¦‚æœä½ æœ‰å…´è¶£æ¢ç´¢çœŸæ­£çš„åˆ†å¸ƒå¼æ•°æ®åº“çš„ä½“ç³»ç»“æ„ï¼Œå¯ä»¥è€ƒè™‘ç ”ç©¶ Google Spannerã€YugabyteDBã€CockratchDBã€Apache Cassandra æˆ– Apache Ignite</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨æ•°æ®åº“é¢†åŸŸï¼Œåˆ†ç‰‡å’Œåˆ†å‘ç»å¸¸è¢«æ··ä¸ºä¸€è°ˆï¼Œä½†å®ƒä»¬æœ‰ä¸åŒçš„ç”¨é€”</p><p>è™½ç„¶åˆ†ç‰‡æ¶‰åŠåœ¨å¤šä¸ªç‹¬ç«‹å®ä¾‹ä¹‹é—´æ‹†åˆ†æ•°æ®ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ç³»ç»Ÿæ˜¯åˆ†å¸ƒå¼çš„ï¼›åœ¨åˆ†ç‰‡è§£å†³æ–¹æ¡ˆä¸­å­˜åœ¨ä¸€ä¸ªåè°ƒè€…ï¼Œå®ƒå°†å®¢æˆ·ç«¯è¯·æ±‚å¼•å¯¼åˆ°é€‚å½“çš„åˆ†ç‰‡ï¼Œè¿™æ˜¯ä¸¤è€…ä¹‹é—´æ˜¾è‘—çš„åŒºåˆ«</p><p>å¦ä¸€æ–¹é¢ï¼Œå»ºç«‹åœ¨æ— å…±äº«ä½“ç³»ç»“æ„ä¸Šçš„åˆ†å¸ƒå¼æ•°æ®åº“ç¼ºå°‘è¿™ç§é›†ä¸­å¼åè°ƒè€…ï¼Œè¿™äº›ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹ç›¸äº’äº†è§£ï¼Œç®¡ç†æ•°æ®åˆ†å‘ï¼Œå¹¶æ— ç¼å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</p><p>è¿™ä¸¤ç§ä½“ç³»ç»“æ„éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹ï¼Œäº†è§£å®ƒä»¬çš„ç»†å¾®å·®åˆ«å¯¹äºæ˜æ™ºçš„æ•°æ®åº“è®¾è®¡å’Œé€‰æ‹©è‡³å…³é‡è¦</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://medium.com/@magda7817/sharded-does-not-imply-distributed-572fdafc4040">Sharded Does Not Imply Distributed | by Denis Magda | Sep, 2023 | Medium</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LiteFlow - ç»„ä»¶çš„è¶…æ—¶æ—¶é—´</title>
      <link href="/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow%20-%20%E7%BB%84%E4%BB%B6%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4.html"/>
      <url>/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow%20-%20%E7%BB%84%E4%BB%B6%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p><a href="https://gitee.com/dromara/liteFlow/issues/I7I3LL">å…è®¸å¯¹ELä¸­çš„æ¯â¼€ä¸ªç»„ä»¶è®¾ç½®è¶…æ—¶æ—¶é—´æ§åˆ¶ Â· Issue #I7I3LL Â· dromara&#x2F;liteFlow - Gitee.com</a></p><p>issue ä¸­éœ€æ±‚äº†æ›´ç»†ç²’åº¦çš„è¶…æ—¶æ—¶é—´è®¾ç½®ï¼Œå…è®¸ EL ä¸­çš„æ¯â¼€ä¸ªç»„ä»¶è®¾ç½®è¶…æ—¶æ—¶é—´æ§åˆ¶</p><p>å¦‚ä½•ä½¿ç”¨å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£</p><p><a href="https://liteflow.cc/pages/fd5984/#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">â±ï¸è¶…æ—¶æ§åˆ¶ | LiteFlow</a></p><h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><h2 id="EL-å…³é”®å­—"><a href="#EL-å…³é”®å­—" class="headerlink" title="EL å…³é”®å­—"></a>EL å…³é”®å­—</h2><p>åœ¨ EL è§£æå™¨ä¸­æ³¨å†Œç›¸å…³çš„è¡¨è¾¾å¼å’Œ <code>BaseOperator</code> å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ELè§£æå¼•æ“</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ExpressRunner</span> <span class="variable">EXPRESS_RUNNER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressRunner</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–QLExpressçš„Runner</span></span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.THEN, <span class="keyword">new</span> <span class="title class_">ThenOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.WHEN, <span class="keyword">new</span> <span class="title class_">WhenOperator</span>());</span><br><span class="line">...</span><br><span class="line">   <span class="comment">// è¿™é‡Œ MAX_WAIT_SECONDS = maxWaitSeconds</span></span><br><span class="line">EXPRESS_RUNNER.addFunctionAndClassMethod(ChainConstant.MAX_WAIT_SECONDS, Object.class, <span class="keyword">new</span> <span class="title class_">MaxWaitSecondsOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunctionAndClassMethod(ChainConstant.PARALLEL, Object.class, <span class="keyword">new</span> <span class="title class_">ParallelOperator</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MaxWaitSecondsOperator"><a href="#MaxWaitSecondsOperator" class="headerlink" title="MaxWaitSecondsOperator"></a>MaxWaitSecondsOperator</h2><p><code>MaxWaitSecondsOperator</code> å®ç°è‡ª <code>BaseOperator</code></p><blockquote><p><code>BaseOperator</code> ä¸ºäº†å¼ºåŒ– <code>executeInner</code> æ–¹æ³•ï¼Œä¼šæ•è·æŠ›å‡ºçš„ <code>QLException</code> é”™è¯¯ï¼Œè¾“å‡ºå‹å¥½çš„é”™è¯¯æç¤º</p></blockquote><p><code>build</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Condition <span class="title function_">build</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="comment">// æ ¡éªŒå‚æ•°æ•°é‡</span></span><br><span class="line">    OperatorHelper.checkObjectSizeEqTwo(objects);</span><br><span class="line">  <span class="comment">// è½¬æ¢å‚æ•° 1 ä¸ºæ‰§è¡Œå¯¹è±¡</span></span><br><span class="line">    <span class="type">Executable</span> <span class="variable">executable</span> <span class="operator">=</span> OperatorHelper.convert(objects[<span class="number">0</span>], Executable.class);</span><br><span class="line">    <span class="comment">// è·å–ä¼ å…¥çš„æ—¶é—´å‚æ•°</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">maxWaitSeconds</span> <span class="operator">=</span> OperatorHelper.convert(objects[<span class="number">1</span>], Integer.class);</span><br><span class="line">    <span class="keyword">if</span> (executable <span class="keyword">instanceof</span> WhenCondition) &#123;</span><br><span class="line">        <span class="comment">// WhenConditionï¼Œç›´æ¥è®¾ç½®ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        <span class="type">WhenCondition</span> <span class="variable">whenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, WhenCondition.class);</span><br><span class="line">        whenCondition.setMaxWaitTime(maxWaitSeconds);</span><br><span class="line">        whenCondition.setMaxWaitTimeUnit(TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> whenCondition;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (executable <span class="keyword">instanceof</span> FinallyCondition) &#123;</span><br><span class="line">        <span class="comment">// FINALLYï¼ŒæŠ¥é”™</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrFormatter.format(<span class="string">&quot;The caller [&#123;&#125;] cannot use the keyword \&quot;maxWaitSeconds&#x27;\&quot;&quot;</span>, executable.toString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QLException</span>(errorMsg);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (containsFinally(executable)) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç† THEN ä¸­çš„ FINALLY</span></span><br><span class="line">        <span class="type">ThenCondition</span> <span class="variable">thenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, ThenCondition.class);</span><br><span class="line">        <span class="keyword">return</span> handleFinally(thenCondition, maxWaitSeconds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…¶ä»–æƒ…å†µï¼Œè¢« WHEN åŒ…è£…</span></span><br><span class="line">        <span class="keyword">return</span> wrappedByTimeout(executable, maxWaitSeconds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p><ul><li>æ ¡éªŒ &amp; å‡†å¤‡å·¥ä½œ<ul><li>æ ¡éªŒå‚æ•°æ•°é‡ï¼›å‚æ•°æ•°é‡éœ€è¦ä¸º 2ï¼ˆæ‰§è¡Œå¯¹è±¡ã€è¶…æ—¶æ—¶é—´ï¼‰</li><li>è½¬æ¢ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ‰§è¡Œå¯¹è±¡ï¼›è°ƒç”¨ <code>OperatorHelper.convert</code>ï¼Œé€»è¾‘ä¸­å¾ˆå¤šå¯¹è±¡éƒ½ç”¨ <code>Object</code> å¼•ç”¨æ‰¿æ¥ï¼Œåœ¨è½¬æ¢æ–¹æ³•ä¸­è¿›è¡Œæ ¡éªŒï¼›ä¸ªäººç†è§£æ˜¯ç‰ºç‰²äº†ä¸€äº›å¯è¯»æ€§æ¢å–äº†å¼€å‘çš„çµæ´»æ€§</li><li>è·å–è¶…æ—¶æ—¶é—´å‚æ•°</li></ul></li><li>åŒ…è£… Condition<ul><li><code>WhenCondition</code> ç›´æ¥è®¾ç½®ç­‰å¾…æ—¶é—´</li><li><code>FinallyCondition</code> ä¸å…è®¸è®¾ç½®è¶…æ—¶æ—¶é—´</li><li><code>ThenCondition</code> ä¸­å¦‚æœåŒ…å« <code>FinallyCondition</code>ï¼Œä¼šåœ¨ <code>handleFinally</code> æ–¹æ³•ä¸­åŒ…è£…æˆä¸€ä¸ª <code>WhenCondition</code>ï¼Œå¤–å±‚å¥—ä¸€ä¸ª <code>ThenCondition</code>ï¼Œå°† <code>FinallyCondition</code> æ’é™¤å‡ºå»ï¼Œæ—¶é—´è®¾ç½®åœ¨é‡Œå±‚çš„ <code>WhenCondition</code> ä¸­</li><li>å…¶ä»–åˆ™è¢«åŒ…è£…æˆ <code>TimeoutCondition</code>ï¼›<code>TimeoutCondition</code> æ˜¯ <code>WhenCondition</code> çš„å®ç°ï¼ŒåŒºåˆ«åœ¨äºå°†æ‰§è¡Œå¯¹è±¡æŠ›å‡ºçš„ <code>WhenTimeoutException</code> è½¬æ¢ä¸º <code>TimeoutException</code></li></ul></li></ul><h2 id="WhenCondition"><a href="#WhenCondition" class="headerlink" title="WhenCondition"></a>WhenCondition</h2><p><code>WhenCondition</code> åœ¨æ—©æœŸç‰ˆæœ¬å°±æ”¯æŒè¶…æ—¶è®¾ç½®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># å¼‚æ­¥çº¿ç¨‹æœ€â»“çš„ç­‰å¾…æ—¶é—´(åªâ½¤äºwhen)ï¼Œé»˜è®¤å€¼ä¸º15000</span><br><span class="line">liteflow.when-max-wait-time=15000</span><br><span class="line"></span><br><span class="line"># å¼‚æ­¥çº¿ç¨‹æœ€â»“çš„ç­‰å¾…æ—¶é—´å•ä½(åªâ½¤äºwhen)ï¼Œé»˜è®¤å€¼ä¸ºMILLISECONDSï¼Œæ¯«ç§’</span><br><span class="line">liteflow.when-max-wait-time-unit=MILLISECONDS</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯¹äº <code>WhenCondition</code> çš„å¤„ç†åªéœ€è¦è®¾ç½®åˆé€‚çš„å±æ€§å€¼å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (executable <span class="keyword">instanceof</span> WhenCondition) &#123;</span><br><span class="line">        <span class="comment">// WhenConditionï¼Œç›´æ¥è®¾ç½®ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        <span class="type">WhenCondition</span> <span class="variable">whenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, WhenCondition.class);</span><br><span class="line">        whenCondition.setMaxWaitTime(maxWaitSeconds);</span><br><span class="line">        whenCondition.setMaxWaitTimeUnit(TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> whenCondition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>WhenCondition</code> æ‰§è¡Œæ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ª <code>ScheduledThreadPoolExecutor</code> æ¥å®ç°è¶…æ—¶æ•ˆæœ</p><p>å…·ä½“æµç¨‹å¯ä»¥é˜…è¯» [LiteFlow - WhenCondition å’Œå¼‚æ­¥è¶…æ—¶æœºåˆ¶ | è´«ç˜ ä¹‹åœ° (kuga.fun)](<a href="https://www.kuga.fun/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow">https://www.kuga.fun/å¼€å‘/LiteFlow/LiteFlow</a> WhenCondition å’Œå¼‚æ­¥è¶…æ—¶æœºåˆ¶.html)</p><h2 id="FinallyCondition"><a href="#FinallyCondition" class="headerlink" title="FinallyCondition"></a>FinallyCondition</h2><p><code>FinallyCondition</code> ä¸å…è®¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (executable <span class="keyword">instanceof</span> FinallyCondition) &#123;</span><br><span class="line">            <span class="comment">// FINALLYï¼ŒæŠ¥é”™</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrFormatter.format(<span class="string">&quot;The caller [&#123;&#125;] cannot use the keyword \&quot;maxWaitSeconds&#x27;\&quot;&quot;</span>, executable.toString());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QLException</span>(errorMsg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ <code>FinallyCondition</code> ä¸èƒ½è®¾ç½®è¶…æ—¶æ—¶é—´å‘¢</p><p>åœ¨ issue é‡Œå¯ä»¥çœ‹åˆ°è¿™æ ·çš„è¡¨è¾¾</p><blockquote><p>å¦‚æœä¸ä½¿ç”¨ <code>maxWaitSeconds</code> åˆ™è¡¨ç¤ºä¸ä½¿ç”¨è¶…æ—¶æ§åˆ¶ã€‚<br>æ­¤å¤–ï¼Œ<code>FINALLY</code> ä¸èƒ½ä½¿ç”¨ <code>maxWaitSeconds</code>ï¼Œå…¶ä¸€å®šä¼šè¢«æ‰§è¡Œ</p></blockquote><p>è¿™æ ·çš„å®ç°åº”è¯¥æ˜¯ä¸ºäº†é¿å…ä½œä¸ºå…œåº•çš„åç½®å¤„ç†ï¼Œå› ä¸ºè¶…æ—¶åè€Œæ— æ³•æ­£å¸¸æ‰§è¡Œäº†</p><h2 id="ThenCondition"><a href="#ThenCondition" class="headerlink" title="ThenCondition"></a>ThenCondition</h2><p>è¿™ä¸ª case çš„å…¥å£æ˜¯ä¸€ä¸ªåˆ¤æ–­æ–¹æ³• <code>containsFinally</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­ THEN ä¸­æ˜¯å¦å«æœ‰ FINALLY ç»„ä»¶</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> executable åˆ¤æ–­å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å«æœ‰ FINALLY ç»„ä»¶è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsFinally</span><span class="params">(Executable executable)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> executable <span class="keyword">instanceof</span> ThenCondition</span><br><span class="line">            &amp;&amp; CollUtil.isNotEmpty(((ThenCondition) executable).getFinallyConditionList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®åˆ¤æ–­äº†ä¸¤éƒ¨åˆ†å†…å®¹ï¼š</p><ul><li><code>executable</code> å¯¹è±¡æ˜¯ä¸€ä¸ª <code>ThenCondition</code></li><li>è¿™ä¸ª <code>ThenCondition</code> åç½®å¤„ç†å™¨ä¸ä¸ºç©º</li></ul><br><p>æ»¡è¶³æ¡ä»¶åå°±ä¼šè¿›å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (containsFinally(executable)) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç† THEN ä¸­çš„ FINALLY</span></span><br><span class="line">        <span class="type">ThenCondition</span> <span class="variable">thenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, ThenCondition.class);</span><br><span class="line">        <span class="keyword">return</span> handleFinally(thenCondition, maxWaitSeconds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œé¦–å…ˆæå–äº† <code>ThenCondition</code> å¯¹è±¡</p><p>ç„¶åè°ƒç”¨ <code>handleFinally</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°† FINALLY æ’é™¤åœ¨è¶…æ—¶æ§åˆ¶ä¹‹å¤–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> thenCondition  å¾…å¤„ç†çš„ ThenCondition</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxWaitSeconds æœ€å¤§ç­‰å¾…ç§’æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å¤„ç†åçš„ ThenCondition</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ThenCondition <span class="title function_">handleFinally</span><span class="params">(ThenCondition thenCondition, Integer maxWaitSeconds)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿›è¡Œå¦‚ä¸‹è½¬æ¢</span></span><br><span class="line">    <span class="comment">// THEN(PRE(a),b,FINALLY(c))</span></span><br><span class="line">    <span class="comment">// =&gt; THEN(</span></span><br><span class="line">    <span class="comment">//      WHEN(THEN(PRE(a),b)),</span></span><br><span class="line">    <span class="comment">//      FINALLY(c))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰å¤–å±‚ THEN</span></span><br><span class="line">    <span class="type">ThenCondition</span> <span class="variable">outerThenCondition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThenCondition</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠŠ FINALLY è½¬ç§»åˆ°å¤–å±‚ THEN</span></span><br><span class="line">    List&lt;Executable&gt; finallyList = thenCondition.getExecutableList(ConditionKey.FINALLY_KEY);</span><br><span class="line">    finallyList.forEach(executable</span><br><span class="line">            -&gt; outerThenCondition</span><br><span class="line">            .addFinallyCondition((FinallyCondition) executable));</span><br><span class="line">    finallyList.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ…è£…å†…éƒ¨ THEN</span></span><br><span class="line">    <span class="type">WhenCondition</span> <span class="variable">whenCondition</span> <span class="operator">=</span> wrappedByTimeout(thenCondition, maxWaitSeconds);</span><br><span class="line">    outerThenCondition.addExecutable(whenCondition);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outerThenCondition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸ºäº†å®ç°æ­£å¸¸æ‰§è¡Œ <code>THEN</code> æ“ä½œçš„è¶…æ—¶è€Œä¸å½±å“åˆ°åç½®ç»„ä»¶ï¼Œé€‰æ‹©å¯¹ <code>ThenCondition</code> è¿›äº†ä¸€å±‚åŒ…è£…</p><p>è¿™é‡ŒåŒ…è£…çš„ç›®çš„ï¼š</p><ul><li>å°† <code>ThenCondition</code> åŒ…è£…ä¸º <code>WhenCondition</code> ä½¿å…¶æ”¯æŒè¶…æ—¶ï¼ˆå› ä¸º <code>WHEN</code> åŸç”Ÿæ”¯æŒè¶…æ—¶ï¼‰</li><li>æœ€å¤–å±‚åŒ…è£…ä¸€å±‚ <code>ThenCondition</code> å°† <code>FinallyCondition</code> æ”¾åœ¨å¤–é¢é¿å…è¶…æ—¶å½±å“ï¼ˆå› ä¸º <code>WHEN</code> ä¹Ÿä¸æ”¯æŒåç½®å¤„ç†ï¼‰</li></ul><p>æœ€ç»ˆå°†åŒ…è£…å¥½çš„ <code>ThenCondition</code> è¿”å›ä¸Šæ¸¸ä¸šåŠ¡ä½¿ç”¨</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>å¯¹äºå…¶ä»–çš„ç±»å‹ï¼Œä¼šè¢«åŒ…è£…ä¸º <code>TimeoutCondition</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†ä¸€ä¸ª Executable åŒ…è£…ä¸ºå¸¦æœ‰å•ç‹¬è¶…æ—¶æ§åˆ¶çš„ TimeoutCondition</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> executable     å¾…åŒ…è£…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxWaitSeconds æœ€å¤§ç­‰å¾…ç§’æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> åŒ…è£…åçš„ TimeoutCondition</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> TimeoutCondition <span class="title function_">wrappedByTimeout</span><span class="params">(Executable executable, Integer maxWaitSeconds)</span> &#123;</span><br><span class="line">    <span class="type">TimeoutCondition</span> <span class="variable">timeoutCondition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeoutCondition</span>();</span><br><span class="line">    timeoutCondition.addExecutable(executable);</span><br><span class="line">    timeoutCondition.setMaxWaitTime(maxWaitSeconds);</span><br><span class="line">    timeoutCondition.setMaxWaitTimeUnit(TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> timeoutCondition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TimeoutCondition</code> æœ¬è´¨ä¸Šæ˜¯ <code>WhenCondition</code> çš„å­ç±»ï¼Œä¼˜åŒ–äº†è¶…æ—¶æ—¥å¿—</p><h1 id="æ—¥å¿—å¤„ç†"><a href="#æ—¥å¿—å¤„ç†" class="headerlink" title="æ—¥å¿—å¤„ç†"></a>æ—¥å¿—å¤„ç†</h1><p>ä¸€å¼€å§‹å†™è¿™ä¸ªæ ‡é¢˜æ˜¯å› ä¸ºæ„Ÿè§‰ <code>ThenCondition</code> çš„åŒ…è£…ä¼šå½±å“åˆ°æ—¥å¿—çš„è¾“å‡ºï¼ˆæ¯•ç«ŸåŒ…è£…äº†ä¸€ä¸ª <code>WhenCondition</code> å’Œä¸€ä¸ª <code>ThenCondition</code>ï¼‰</p><p>ä½†æ˜¯åˆçœ‹äº†ä¸€ä¸‹ä»£ç å‘ç°æ—¥å¿—æ˜¯åªæœ‰ <code>Component</code> æ‰ä¼šè¾“å‡ºçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getExecuteStepStr</span><span class="params">(<span class="type">boolean</span> withTimeSpent)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    CmpStep cmpStep;</span><br><span class="line">    <span class="keyword">for</span> (Iterator&lt;CmpStep&gt; it = executeSteps.iterator(); it.hasNext();) &#123;</span><br><span class="line">        cmpStep = it.next();</span><br><span class="line">        <span class="keyword">if</span> (withTimeSpent) &#123;</span><br><span class="line">            str.append(cmpStep.buildStringWithTime());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            str.append(cmpStep.buildString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">            str.append(<span class="string">&quot;==&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.executeStepsStr = str.toString();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.executeStepsStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æƒ³åˆ°åˆçœ‹åˆ°çš„ä¸€ä¸ª issue</p><p><a href="https://gitee.com/dromara/liteFlow/issues/I8B0MI">å¸Œæœ›æ¡†æ¶å¯¹å¹¶è¡Œæ—¥å¿—è¿›è¡Œä¼˜åŒ– Â· Issue #I8B0MI Â· dromara&#x2F;liteFlow - Gitee.com</a></p><p>è¿™é‡Œä¼šä¸ä¼šäº§ç”Ÿå½±å“ï¼Ÿ</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><table><thead><tr><th align="center">ç±»å‹</th><th align="center">æ“ä½œ</th></tr></thead><tbody><tr><td align="center">WhenCondition</td><td align="center">ç›´æ¥è®¾ç½®å±æ€§</td></tr><tr><td align="center">FinallyCondition</td><td align="center">ä¸å…è®¸</td></tr><tr><td align="center">ThenCondition</td><td align="center">å†…éƒ¨é€»è¾‘åŒ…è£…ä¸º <code>WHEN</code>ï¼Œå¤–éƒ¨åŒ…è£…ä¸€ä¸ª <code>THEN</code>ï¼Œå°†åç½®å¤„ç†å™¨ç§»è‡³å¤–éƒ¨</td></tr><tr><td align="center">å…¶ä»–</td><td align="center">åŒ…è£…ä¸º <code>WhenCondition</code> çš„å­ç±» <code>TimeoutCondition</code></td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°éšç€è¿­ä»£å…³é”®å­—è¶Šæ¥è¶Šå¤š</p><p>åŠŸèƒ½å’ŒåŠŸèƒ½ä¹‹é—´äº’ç›¸å½±å“ä¹Ÿè¶Šæ¥è¶Šå¤§</p><p>ä¸€ä¸ªåŠŸèƒ½çš„æ·»åŠ éœ€è¦è€ƒè™‘å¯¹ä¸åŒå·²æœ‰åŠŸèƒ½çš„å½±å“ï¼Œéœ€è¦å¯¹åº”å‡ºä¸åŒçš„å®ç°æ–¹å¼</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LiteFlow </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata æ”¹è‰¯ç‰ˆé›ªèŠ±ç®—æ³•</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Seata%20%E6%94%B9%E8%89%AF%E7%89%88%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Seata%20%E6%94%B9%E8%89%AF%E7%89%88%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95.html</url>
      
        <content type="html"><![CDATA[<h1 id="é›ªèŠ±ç®—æ³•"><a href="#é›ªèŠ±ç®—æ³•" class="headerlink" title="é›ªèŠ±ç®—æ³•"></a>é›ªèŠ±ç®—æ³•</h1><p>é›ªèŠ±ç®—æ³•ï¼ˆSnowflake Algorithmï¼‰æ˜¯ä¸€ç§ç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUnique Identifierï¼‰çš„ç®—æ³•</p><p>å®ƒæœ€åˆç”± Twitter å¼€å‘å¹¶å¼€æºï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”Ÿæˆå…¨å±€å”¯ä¸€ ID</p><br><p>é›ªèŠ±ç®—æ³•çš„åŸç†å°±æ˜¯ç”Ÿæˆä¸€ä¸ªçš„ 64 ä½æ¯”ç‰¹ä½çš„ long ç±»å‹çš„ ID</p><ul><li>ç¬¦å·ä½ï¼ˆ1 ä½ï¼‰ï¼šå›ºå®šå›ºå®šä¸º 1ï¼Œå› ä¸º ID éƒ½ä¸ºæ­£æ•°</li><li>æ—¶é—´æˆ³ï¼ˆ41 ä½ï¼‰ï¼šæ¯«ç§’çº§åˆ«çš„æ—¶é—´æˆ³ï¼Œå¤§çº¦å¯ä»¥ä½¿ç”¨ 69 å¹´ï¼ˆäº‹å®ä¸Šå¾ˆå¤šå®ç°ä¼šå‡å»ä¸€ä¸ª offsetï¼‰</li><li>æœºå™¨ç ï¼ˆ10 ä½ï¼‰ï¼šåˆ†å¸ƒå¼æœåŠ¡ IDï¼Œ2 ^ 10 &#x3D; 1024 å°æœºå™¨</li><li>åºåˆ—å·ï¼ˆ12 ä½ï¼‰ï¼šåŒä¸€æ—¶é—´æˆ³ã€åŒä¸€æœºå™¨ä¸‹ï¼Œé€šè¿‡åºåˆ—å·è‡ªå¢è¿›è¡Œ ID ç”Ÿæˆï¼Œå³åŒä¸€æ¯«ç§’ä¸‹å¯ä»¥ç”Ÿæˆ 2 ^ 12 &#x3D; 4096 ä¸ªä¸åŒçš„ ID</li></ul><br><p>64 ä½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><span style="color: green;">0</span> - <span style="color: red;">00000000000000000000000000000000000000000</span> - <span style="color: blue;">0000000000</span> - <span style="color: orange;">000000000000</span></p><ul><li><span style="color: green;">ç¬¦å·ä½ï¼ˆ1 ä½ï¼‰</span></li><li><span style="color: red;">æ—¶é—´æˆ³ï¼ˆ41 ä½ï¼‰</span></li><li><span style="color: blue;">æœºå™¨ç ï¼ˆ10 ä½ï¼‰</span></li><li><span style="color: orange;">åºåˆ—å·ï¼ˆ12 ä½ï¼‰</span></li></ul><h1 id="Seata-æ”¹è‰¯"><a href="#Seata-æ”¹è‰¯" class="headerlink" title="Seata æ”¹è‰¯"></a>Seata æ”¹è‰¯</h1><p>åœ¨è€ç‰ˆ Seataï¼ˆ1.4 ä»¥å‰ï¼‰ï¼Œå†…ç½®çš„ UUID ç”Ÿæˆå™¨çš„å®ç°åŸºäºæ ‡å‡†ç‰ˆçš„é›ªèŠ±ç®—æ³•</p><p>åœ¨åç»­çš„æ›´æ–°ä¸­ Seata å¯¹æ ‡å‡†é›ªèŠ±ç®—æ³•è¿›è¡Œäº†æ”¹è‰¯</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>Seata è®¤ä¸ºæ ‡å‡†çš„é›ªèŠ±ç®—æ³•æœ‰ä»¥ä¸‹å‡ ä¸ªç¼ºç‚¹</p><ul><li><strong>æ—¶é’Ÿæ•æ„Ÿ</strong>ï¼šå› ä¸º ID ç”Ÿæˆæ€»æ˜¯å’Œå½“å‰æ“ä½œç³»ç»Ÿçš„æ—¶é—´æˆ³ç»‘å®šçš„ï¼ˆåˆ©ç”¨äº†æ—¶é—´çš„å•è°ƒé€’å¢æ€§ï¼‰ï¼Œå¦‚æœæœåŠ¡å‘ç”Ÿäº†æ—¶é’Ÿå›æ‹¨ï¼Œç”Ÿæˆçš„ ID å°±ä¼šé‡å¤ï¼›å½“ç„¶ä¸€äº›å®ç°ä¼šé¿å…è¯¥é—®é¢˜ï¼Œæ–¹æ¡ˆä¸€èˆ¬æ˜¯è®°å½•ä¸Šæ¬¡ç”Ÿæˆ ID æ—¶çš„æ—¶é—´æˆ³ï¼Œå¦‚æœå‘ç°å½“å‰æ—¶é—´å°äºè®°å½•æ—¶é—´ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†æ—¶é’Ÿå›æ‹¨ï¼Œåˆ™æ‹’ç»æœåŠ¡<br>æ„å‘³ç€å‡ºç°æ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´æœåŠ¡åœ¨ä¸€å®šæ—¶é—´å†…ä¸å¯ç”¨</li><li><strong>çªå‘æ€§èƒ½æœ‰é™</strong>ï¼šåºåˆ—å·çš„ä½é•¿åº¦ä¸º 12ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ ms å¹¶å‘éƒ½å¿…é¡»ä½äº 4096ï¼›ä¸€äº›å®ç°ä¼šè‡ªæ—‹ç­‰å¾…ï¼Œå½“å·®è·è¾ƒå¤§æ—¶åˆ™æŠ›å‡ºé™æµå¼‚å¸¸ç­‰æ‹’ç»æœåŠ¡</li></ul><h2 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h2><p>æ”¹è¿›çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>è§£é™¤ä¸æ“ä½œç³»ç»Ÿæ—¶é—´æˆ³çš„æ—¶åˆ»ç»‘å®š</strong></p><p>ç”Ÿæˆå™¨åªåœ¨åˆå§‹åŒ–æ—¶è·å–äº†ç³»ç»Ÿå½“å‰çš„æ—¶é—´æˆ³ï¼Œä½œä¸ºåˆå§‹æ—¶é—´æˆ³ï¼Œ ä½†ä¹‹åå°±ä¸å†ä¸ç³»ç»Ÿæ—¶é—´æˆ³ä¿æŒåŒæ­¥äº†ï¼›éšå ID çš„é€’å¢ï¼Œåªé€’å¢åºåˆ—å·ï¼›å½“åºåˆ—å·æº¢å‡ºæ—¶ï¼Œè¿›ä½åˆ°æ—¶é—´æˆ³ä½ï¼ˆä½ 12 ä½æ»¡ï¼‰ï¼Œåºåˆ—å·é‡æ–°å½’é›¶</p><p>ä¸ºäº†æ–¹ä¾¿è¿™ç§æº¢å‡ºè¿›ä½ï¼ŒSeata è°ƒæ•´äº† 64 ä½ ID çš„ä½åˆ†é…ç­–ç•¥</p><p><span style="color: green;">0</span>  - <span style="color: blue;">0000000000</span> - <span style="color: red;">00000000000000000000000000000000000000000</span> - <span style="color: orange;">000000000000</span></p><ul><li><span style="color: green;">ç¬¦å·ä½ï¼ˆ1 ä½ï¼‰</span></li><li><span style="color: blue;">æœºå™¨ç ï¼ˆ10 ä½ï¼‰</span></li><li><span style="color: red;">æ—¶é—´æˆ³ï¼ˆ41 ä½ï¼‰</span></li><li><span style="color: orange;">åºåˆ—å·ï¼ˆ12 ä½ï¼‰</span></li></ul><hr><p>è¿™æ ·æ—¶é—´æˆ³å’Œåºåˆ—å·åœ¨å†…å­˜ä¸Šæ˜¯è¿åœ¨ä¸€å—çš„ï¼Œåœ¨å®ç°ä¸Šå°±å¾ˆå®¹æ˜“ç”¨ä¸€ä¸ª <code>AtomicLong</code> æ¥åŒæ—¶è®°å½•å—æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * timestamp and sequence mix in one Long</span></span><br><span class="line"><span class="comment"> * highest 11 bit: not used</span></span><br><span class="line"><span class="comment"> * middle  41 bit: timestamp</span></span><br><span class="line"><span class="comment"> * lowest  12 bit: sequence</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> AtomicLong timestampAndSequence;</span><br></pre></td></tr></table></figure><p>é«˜ 11 ä½ï¼ˆç¬¦å·ä½ + æœºå™¨ç ï¼‰åœ¨æœåŠ¡å¯åŠ¨æ—¶å°±å·²ç»ç¡®å®šï¼ŒæœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šå˜åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * business meaning: machine ID (0 ~ 1023)</span></span><br><span class="line"><span class="comment"> * actual layout in memory:</span></span><br><span class="line"><span class="comment"> * highest 1 bit: 0</span></span><br><span class="line"><span class="comment"> * middle 10 bit: workerId</span></span><br><span class="line"><span class="comment"> * lowest 53 bit: all 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> workerId;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ç”Ÿæˆ UUID çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// è·å¾—é€’å¢åçš„æ—¶é—´æˆ³å’Œåºåˆ—å·</span></span><br><span class="line">   <span class="type">long</span> <span class="variable">next</span> <span class="operator">=</span> timestampAndSequence.incrementAndGet();</span><br><span class="line">   <span class="comment">// æˆªå–ä½53ä½</span></span><br><span class="line">   <span class="type">long</span> <span class="variable">timestampWithSequence</span> <span class="operator">=</span> next &amp; timestampAndSequenceMask;</span><br><span class="line">   <span class="comment">// è·Ÿå…ˆå‰ä¿å­˜å¥½çš„é«˜11ä½è¿›è¡Œä¸€ä¸ªæˆ–çš„ä½è¿ç®—</span></span><br><span class="line">   <span class="keyword">return</span> workerId | timestampWithSequence;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ”¶ç›Š"><a href="#æ”¶ç›Š" class="headerlink" title="æ”¶ç›Š"></a>æ”¶ç›Š</h2><p>ç”±ä¸Šå¯ä»¥å‘ç°ï¼Œé—®é¢˜å¾—åˆ°äº†æ”¹å–„ï¼š</p><ul><li>ç”Ÿæˆå™¨ä¸å†æœ‰ 4096&#x2F;ms çš„çªå‘æ€§èƒ½é™åˆ¶äº†ï¼›å¦‚æœæŸä¸ªæ—¶é—´æˆ³çš„åºåˆ—å·ç©ºé—´è€—å°½ï¼Œå®ƒä¼šç›´æ¥æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æˆ³</li><li>ç”Ÿæˆå™¨å¼±ä¾èµ–äºæ“ä½œç³»ç»Ÿæ—¶é’Ÿï¼›åœ¨è¿è¡ŒæœŸé—´ï¼Œç”Ÿæˆå™¨ä¸å—æ—¶é’Ÿå›æ‹¨çš„å½±å“<br>æ— è®ºæ˜¯äººä¸ºå›æ‹¨è¿˜æ˜¯æœºå™¨çš„æ—¶é’Ÿæ¼‚ç§»ï¼Œ å› ä¸ºç”Ÿæˆå™¨ä»…åœ¨å¯åŠ¨æ—¶è·å–äº†ä¸€éç³»ç»Ÿæ—¶é’Ÿï¼Œä¹‹åä¸¤è€…ä¸å†ä¿æŒåŒæ­¥ï¼› å¯èƒ½äº§ç”Ÿé‡å¤ ID çš„åªæœ‰åœ¨é‡å¯æ—¶çš„å¤§å¹…åº¦æ—¶é’Ÿå›æ‹¨</li><li>å¯¹äºæ¨è¿›åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æˆ³çš„ â€œè¶…å‰æ¶ˆè´¹â€ é—®é¢˜ï¼Œå¦‚æœç”Ÿæˆå™¨å†…çš„æ—¶é—´æˆ³å¤§å¤§è¶…å‰äºç³»ç»Ÿçš„æ—¶é—´æˆ³ï¼Œ ä»è€Œåœ¨é‡å¯æ—¶é€ æˆ ID é‡å¤ï¼Ÿå®é™…ä¸Šä¸å¯èƒ½ï¼Œè¾¾åˆ°è¿™ç§æƒ…å†µéœ€è¦ç‰¹åˆ«å¤§çš„ QPS</li></ul><h1 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h1><h2 id="Work-ID-ä¼˜åŒ–"><a href="#Work-ID-ä¼˜åŒ–" class="headerlink" title="Work ID ä¼˜åŒ–"></a>Work ID ä¼˜åŒ–</h2><p>Work ID æ˜¯åˆ†å¸ƒå¼ä¸‹çš„æœºå™¨ç ï¼ŒåŸºæœ¬è¦æ±‚æ˜¯æ¯ä¸ªå®ä¾‹æ‹¥æœ‰å”¯ä¸€çš„æ ‡è¯†</p><p>å¸¸è§çš„ç¡®å®š Work ID çš„æ–¹å¼ï¼š</p><ul><li><strong>æ‰‹åŠ¨é…ç½®</strong></li><li><strong>åŸºäºç½‘ç»œä¿¡æ¯</strong>ï¼šå› ä¸ºç½‘ç»œä¿¡æ¯ä¸€èˆ¬å¸¦æœ‰å”¯ä¸€æ€§ï¼Œä¾‹å¦‚ä½¿ç”¨ IP åœ°å€ã€MAC åœ°å€ã€ä¸»æœºåç­‰ä½œä¸º Work ID çš„ä¸€éƒ¨åˆ†</li><li><strong>è‡ªåŠ¨åŒ–ç”Ÿæˆ</strong>ï¼šä½¿ç”¨ä¸€äº›å·¥å…·è¿›è¡Œç”Ÿæˆï¼Œæ¯”å¦‚ä¾èµ– ZK èŠ‚ç‚¹æ¥è¿›è¡Œå”¯ä¸€çš„ä¿è¯</li></ul><p>æ— è®ºé€‰æ‹©å“ªç§æ–¹æ³•ï¼Œéƒ½éœ€è¦ç¡®ä¿æ¯ä¸ªæœºå™¨æˆ–èŠ‚ç‚¹çš„ Work ID æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¿æŒç¨³å®šï¼›è¿™æ ·å¯ä»¥é¿å…ç”Ÿæˆé‡å¤çš„ IDï¼Œç¡®ä¿æ•´ä¸ªç³»ç»Ÿçš„æ­£ç¡®è¿è¡Œ</p><p>Seata åŸºäºç½‘ç»œä¿¡æ¯è¿›è¡Œ Work ID çš„ç¡®å®šï¼Œæˆªå–æœ¬åœ° IPv4 åœ°å€çš„ä½ 10 ä½ä½œä¸º Work IDï¼Œå¾ˆæ˜æ˜¾è¿™æ ·ä¼šé€ æˆ Work ID é‡å¤ï¼Œä¾‹å¦‚å¦‚ä¸‹ IP</p><ul><li>192.168.4.10</li><li>192.168.8.10</li></ul><p>ä¼˜åŒ–åå°†ä¼˜å…ˆä½¿ç”¨ç½‘å¡ MAC åœ°å€æˆªå–ï¼Œè‹¥æœ¬æœºæœªé…ç½®æœ‰æ•ˆçš„ç½‘å¡ï¼Œåˆ™åœ¨ <code>[0, 1023]</code> ä¸­éšæœºæŒ‘ä¸€ä¸ªä½œä¸º IDï¼ˆå…¶å®åº”è¯¥ä¾ç„¶å­˜åœ¨é‡å¤é—®é¢˜ï¼Œåªæ˜¯å‡å°‘äº†æ¦‚ç‡ï¼›æ„Ÿè§‰è¿˜æ˜¯ç¾å›¢çš„ leaf ç­‰ä½¿ç”¨ ZK æ–¹å¼æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯ä¼šå¼•å…¥æ–°ä¸­é—´ä»¶ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ï¼‰</p><h2 id="å•è°ƒé€’å¢å’Œé¡µåˆ†è£‚"><a href="#å•è°ƒé€’å¢å’Œé¡µåˆ†è£‚" class="headerlink" title="å•è°ƒé€’å¢å’Œé¡µåˆ†è£‚"></a>å•è°ƒé€’å¢å’Œé¡µåˆ†è£‚</h2><p>Seata æ”¹è‰¯åçš„é›ªèŠ±ç®—æ³•æ˜¯å¦æ˜¯å•è°ƒé€’å¢çš„ï¼Ÿ</p><p>åœ¨æ ‡å‡†é›ªèŠ±ç®—æ³•ä¸­ï¼Œæ—¶é—´æˆ³æ’åœ¨æœºå™¨ç ä¹‹å‰ï¼Œå³å¤šèŠ‚ç‚¹æœåŠ¡ï¼Œä¾ç„¶å¯ä»¥ä¿è¯ä¸€å®šç¨‹åº¦ä¸Šæœ‰åºï¼ˆåŒä¸€ ms å†…ç”Ÿæˆçš„ ID å¯èƒ½æ— åºï¼Œä¸åŒ ms ä¹‹é—´å•è°ƒé€’å¢ï¼‰</p><p>åœ¨ Seata æ”¹è‰¯åçš„é›ªèŠ±ç®—æ³•ä¸­ï¼Œæœºå™¨ç åœ¨æ—¶é—´æˆ³ä¹‹å‰ï¼Œè¿›ä¸€æ­¥åŠ å¤§äº†è¿™ç§æ— åºæ€§</p><br><p>é‚£ä¹ˆè¿™ç§æ— åºæ€§æ˜¯å¦ä¼šé€ æˆé¡µåˆ†è£‚ï¼Ÿ</p><p>æŒ‰ç…§ Seata çš„è§£é‡Šæ˜¯çŸ­æ—¶æœŸå†…ä¼šé€ æˆï¼Œä½†åœ¨æœ‰é™æ¬¡åˆ†è£‚åï¼Œä¸ä¼šè¿›è¡Œæ–°çš„é¡µåˆ†è£‚ï¼Œå› ä¸º Work ID æ˜¯æœ‰é™çš„ï¼Œæœ€ç»ˆä¸€å®šä¼šå‡ºç°èƒ½å®¹çº³å›ºå®š Work ID çš„é¡µ</p><blockquote><p>åˆ°è¾¾ç»ˆæ€åï¼Œåç»­çš„IDåªä¼šåœ¨è¯¥IDæ‰€å±çš„å­åºåˆ—ä¸Šè¿›è¡Œé¡ºåºå¢é•¿ï¼Œè€Œä¸ä¼šé€ æˆé¡µåˆ†è£‚</p><p>è¯¥çŠ¶æ€ä¸‹çš„é¡ºåºå¢é•¿ä¸ auto_increment çš„é¡ºåºå¢é•¿çš„åŒºåˆ«æ˜¯ï¼Œå‰è€…æœ‰ 1024 ä¸ªå¢é•¿ä½ç‚¹ï¼ˆå„ä¸ªå­åºåˆ—çš„å°¾éƒ¨ï¼‰ï¼Œåè€…åªæœ‰å°¾éƒ¨ä¸€ä¸ª</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥å›ç­”å¼€å¤´æ‰€æå‡ºçš„é—®é¢˜äº†ï¼šæ–°ç®—æ³•ä»å…¨å±€æ¥çœ‹çš„ç¡®ä¸æ˜¯å…¨å±€é€’å¢çš„ï¼Œä½†è¯¥ç®—æ³•æ˜¯<strong>æ”¶æ•›</strong>çš„ï¼Œè¾¾åˆ°ç¨³æ€åï¼Œæ–°ç®—æ³•åŒæ ·èƒ½è¾¾æˆåƒå…¨å±€é¡ºåºé€’å¢ä¸€æ ·çš„æ•ˆæœ</p></blockquote><h2 id="ç†è®ºä¸Šä¾ç„¶å­˜åœ¨çš„é—®é¢˜"><a href="#ç†è®ºä¸Šä¾ç„¶å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="ç†è®ºä¸Šä¾ç„¶å­˜åœ¨çš„é—®é¢˜"></a>ç†è®ºä¸Šä¾ç„¶å­˜åœ¨çš„é—®é¢˜</h2><p>è™½ç„¶ Seata ä¸€è‡´åœ¨è®ºè¯æ”¹è¿›å ID ç”Ÿæˆæ–¹å¼çš„ä¼˜åŠ¿ï¼Œä½†æˆ‘è§‰å¾—ä»ç†è®ºä¸Šæ¥çœ‹ä¾ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼ˆè™½ç„¶å¾ˆå¤šé—®é¢˜ä»åº”ç”¨å±‚é¢è€ƒè™‘è®¤ä¸ºæ— æ³•å‡ºç°ï¼Œä½†å¹¶ä¸æ˜¯ä»ç†è®ºå±‚é¢è§£å†³ï¼‰</p><ul><li><strong>æ—¶é’Ÿå›æ‹¨åé‡å¯æœåŠ¡</strong>ï¼šè™½ç„¶ ID ç”Ÿæˆè¿‡ç¨‹ä¸­ä¸ä¾èµ–æ—¶é—´æˆ³ï¼Œä½†å¦‚æœå›æ‹¨æ—¶é—´å¤ªé•¿ã€éƒ¨ç½²æ—¶é—´çŸ­ä¾ç„¶ä¼šå¯¼è‡´ ID é‡å¤çš„é—®é¢˜<ul><li>åº”ç”¨å±‚é¢ï¼šä¸ä¼šæœ‰å¤ªé•¿æ—¶é—´å›æ‹¨ï¼ŒæœåŠ¡éƒ¨ç½²éœ€è¦ä¸€å®šæ—¶é—´</li></ul></li><li><strong>è¶…å‰æ¶ˆè´¹</strong>ï¼šè™½ç„¶ QPS &#x3D; 400w&#x2F;sï¼Œä½†ç†è®ºä¸Šä»ç„¶å­˜åœ¨è¶…å‰æ¶ˆè´¹ï¼Œé‡æ–°éƒ¨ç½²å ID é‡å¤é—®é¢˜<ul><li>åº”ç”¨å±‚é¢ï¼šå¯¹ QPS çš„è¦æ±‚åŸºæœ¬ä¸å¯èƒ½è¾¾åˆ°</li></ul></li><li><strong>Work ID é‡å¤</strong>ï¼šä¸Šè¿° Work ID ç”Ÿæˆæ“ä½œä¾ç„¶ä¼šå­˜åœ¨é‡å¤é—®é¢˜ï¼Œåªä¸è¿‡æ¦‚ç‡è¾ƒå°</li><li><strong>é¡µåˆå¹¶å¯¼è‡´çš„é¡µåˆ†è£‚æ— æ³•æ”¶æ•›</strong>ï¼šè¯¦æƒ…è§ <a href="http://seata.io/zh-cn/blog/seata-snowflake-explain">å…³äºæ–°ç‰ˆé›ªèŠ±ç®—æ³•çš„ç­”ç–‘ | Seata</a></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://seata.io/zh-cn/blog/seata-analysis-UUID-generator/">SeataåŸºäºæ”¹è‰¯ç‰ˆé›ªèŠ±ç®—æ³•çš„åˆ†å¸ƒå¼UUIDç”Ÿæˆå™¨åˆ†æ | Seata</a></p><p><a href="http://seata.io/zh-cn/blog/seata-snowflake-explain">å…³äºæ–°ç‰ˆé›ªèŠ±ç®—æ³•çš„ç­”ç–‘ | Seata</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ OpenAI API è¿›è¡Œ Prompt å·¥ç¨‹çš„æœ€ä½³å®è·µ</title>
      <link href="/%E5%BC%80%E5%8F%91/AI/%E4%BD%BF%E7%94%A8%20OpenAI%20API%20%E8%BF%9B%E8%A1%8C%20Prompt%20%E5%B7%A5%E7%A8%8B%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"/>
      <url>/%E5%BC%80%E5%8F%91/AI/%E4%BD%BF%E7%94%A8%20OpenAI%20API%20%E8%BF%9B%E8%A1%8C%20Prompt%20%E5%B7%A5%E7%A8%8B%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html</url>
      
        <content type="html"><![CDATA[<h1 id="Prompt-å·¥ç¨‹çš„å·¥ä½œåŸç†"><a href="#Prompt-å·¥ç¨‹çš„å·¥ä½œåŸç†" class="headerlink" title="Prompt å·¥ç¨‹çš„å·¥ä½œåŸç†"></a>Prompt å·¥ç¨‹çš„å·¥ä½œåŸç†</h1><p>ç”±äºæŒ‡å¯¼éµå¾ªæ¨¡å‹çš„è®­ç»ƒæ–¹å¼æˆ–è®­ç»ƒæ•°æ®ï¼Œæœ‰ä¸€äº›ç‰¹å®šçš„æç¤ºæ ¼å¼æ•ˆæœç‰¹åˆ«å¥½ï¼Œä¸æ‰‹å¤´çš„ä»»åŠ¡æ›´ä¸ºä¸€è‡´</p><p>ä¸‹é¢æˆ‘ä»¬ä»‹ç»äº†ä¸€äº›æç¤ºæ ¼å¼ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™äº›æ ¼å¼è¿è¡Œå¯é ï¼Œä½†å¯ä»¥éšæ„æ¢ç´¢ä¸åŒçš„æ ¼å¼ï¼Œè¿™äº›æ ¼å¼å¯èƒ½æœ€é€‚åˆæ‚¨çš„ä»»åŠ¡</p><h1 id="ç»éªŒæ³•åˆ™å’Œç¤ºä¾‹"><a href="#ç»éªŒæ³•åˆ™å’Œç¤ºä¾‹" class="headerlink" title="ç»éªŒæ³•åˆ™å’Œç¤ºä¾‹"></a>ç»éªŒæ³•åˆ™å’Œç¤ºä¾‹</h1><p><strong>æ³¨æ„ï¼š</strong> <code>&#123;text input here&#125;</code> æ˜¯å®é™…æ–‡æœ¬ &#x2F; ä¸Šä¸‹æ–‡çš„å ä½ç¬¦</p><h2 id="ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬"><a href="#ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬" class="headerlink" title="ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬"></a>ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬</h2><p>ä¸ºäº†æœ€å¥½çš„ç»“æœï¼Œæˆ‘ä»¬é€šå¸¸å»ºè®®ä½¿ç”¨æœ€æ–°ã€åŠŸèƒ½æœ€å¼ºçš„æ¨¡å‹</p><p>æˆªè‡³ 2022 å¹´ 11 æœˆï¼Œæœ€ä½³é€‰æ‹©æ˜¯ç”¨äºæ–‡æœ¬ç”Ÿæˆçš„ <code>text-davinci-003</code> æ¨¡å‹å’Œç”¨äºä»£ç ç”Ÿæˆçš„ <code>code-davinci-002</code> æ¨¡å‹</p><h2 id="æç¤ºæ”¾åœ¨å¼€å¤´å¹¶ä¸”ä½¿ç”¨-æˆ–è€…-â€œâ€â€-åˆ†éš”æç¤ºå’Œå†…å®¹"><a href="#æç¤ºæ”¾åœ¨å¼€å¤´å¹¶ä¸”ä½¿ç”¨-æˆ–è€…-â€œâ€â€-åˆ†éš”æç¤ºå’Œå†…å®¹" class="headerlink" title="æç¤ºæ”¾åœ¨å¼€å¤´å¹¶ä¸”ä½¿ç”¨ ### æˆ–è€… â€œâ€â€ åˆ†éš”æç¤ºå’Œå†…å®¹"></a>æç¤ºæ”¾åœ¨å¼€å¤´å¹¶ä¸”ä½¿ç”¨ ### æˆ–è€… â€œâ€â€ åˆ†éš”æç¤ºå’Œå†…å®¹</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Summarize the text below as a bullet point list of the most important points.</span><br><span class="line"></span><br><span class="line">&#123;text input here&#125;</span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Summarize the text below as a bullet point list of the most important points.</span><br><span class="line"></span><br><span class="line">Text: &quot;&quot;&quot;</span><br><span class="line">&#123;text input here&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure><h2 id="å¯¹æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€ç»“æœã€é•¿åº¦ã€æ ¼å¼ã€é£æ ¼ç­‰è¿›è¡Œå…·ä½“å’Œå°½å¯èƒ½è¯¦ç»†çš„æè¿°"><a href="#å¯¹æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€ç»“æœã€é•¿åº¦ã€æ ¼å¼ã€é£æ ¼ç­‰è¿›è¡Œå…·ä½“å’Œå°½å¯èƒ½è¯¦ç»†çš„æè¿°" class="headerlink" title="å¯¹æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€ç»“æœã€é•¿åº¦ã€æ ¼å¼ã€é£æ ¼ç­‰è¿›è¡Œå…·ä½“å’Œå°½å¯èƒ½è¯¦ç»†çš„æè¿°"></a>å¯¹æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€ç»“æœã€é•¿åº¦ã€æ ¼å¼ã€é£æ ¼ç­‰è¿›è¡Œå…·ä½“å’Œå°½å¯èƒ½è¯¦ç»†çš„æè¿°</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Write a poem about OpenAI. </span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Write a short inspiring poem about OpenAI, focusing on the recent DALL-E product launch (DALL-E is a text to image ML model) in the style of a &#123;famous poet&#125;</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡ç¤ºä¾‹é˜æ˜æ‰€éœ€çš„è¾“å‡ºæ ¼å¼"><a href="#é€šè¿‡ç¤ºä¾‹é˜æ˜æ‰€éœ€çš„è¾“å‡ºæ ¼å¼" class="headerlink" title="é€šè¿‡ç¤ºä¾‹é˜æ˜æ‰€éœ€çš„è¾“å‡ºæ ¼å¼"></a>é€šè¿‡ç¤ºä¾‹é˜æ˜æ‰€éœ€çš„è¾“å‡ºæ ¼å¼</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Extract the entities mentioned in the text below. Extract the following 4 entity types: company names, people names, specific topics and themes.</span><br><span class="line"></span><br><span class="line">Text: &#123;text&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºå’Œå‘ŠçŸ¥ï¼Œå½“æ˜¾ç¤ºç‰¹å®šçš„æ ¼å¼è¦æ±‚æ—¶ï¼Œæ¨¡å‹çš„å“åº”ä¼šæ›´å¥½</p><p>è¿™ä¹Ÿä½¿å¾—ä»¥ç¼–ç¨‹æ–¹å¼å¯é åœ°è§£æå¤šä¸ªè¾“å‡ºå˜å¾—æ›´åŠ å®¹æ˜“</p><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Extract the important entities mentioned in the text below. First extract all company names, then extract all people names, then extract specific topics which fit the content and finally extract general overarching themes</span><br><span class="line"></span><br><span class="line">Desired format:</span><br><span class="line">Company names: &lt;comma_separated_list_of_company_names&gt;</span><br><span class="line">People names: -||-</span><br><span class="line">Specific topics: -||-</span><br><span class="line">General themes: -||-</span><br><span class="line"></span><br><span class="line">Text: &#123;text&#125;</span><br></pre></td></tr></table></figure><h2 id="ä»é›¶æ ·æœ¬å¼€å§‹ï¼Œç„¶åæ˜¯å°‘é‡æ ·æœ¬ï¼Œå®ƒä»¬éƒ½ä¸èµ·ä½œç”¨åˆ™å¾®è°ƒ"><a href="#ä»é›¶æ ·æœ¬å¼€å§‹ï¼Œç„¶åæ˜¯å°‘é‡æ ·æœ¬ï¼Œå®ƒä»¬éƒ½ä¸èµ·ä½œç”¨åˆ™å¾®è°ƒ" class="headerlink" title="ä»é›¶æ ·æœ¬å¼€å§‹ï¼Œç„¶åæ˜¯å°‘é‡æ ·æœ¬ï¼Œå®ƒä»¬éƒ½ä¸èµ·ä½œç”¨åˆ™å¾®è°ƒ"></a>ä»é›¶æ ·æœ¬å¼€å§‹ï¼Œç„¶åæ˜¯å°‘é‡æ ·æœ¬ï¼Œå®ƒä»¬éƒ½ä¸èµ·ä½œç”¨åˆ™å¾®è°ƒ</h2><p><strong>é›¶æ ·æœ¬ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Extract keywords from the below text.</span><br><span class="line"></span><br><span class="line">Text: &#123;text&#125;</span><br><span class="line"></span><br><span class="line">Keywords:</span><br></pre></td></tr></table></figure><p><strong>å°‘é‡æ ·æœ¬ - ä¸¾å‡ ä¸ªä¾‹å­</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Extract keywords from the corresponding texts below.</span><br><span class="line"></span><br><span class="line">Text 1: Stripe provides APIs that web developers can use to integrate payment processing into their websites and mobile applications.</span><br><span class="line">Keywords 1: Stripe, payment processing, APIs, web developers, websites, mobile applications</span><br><span class="line">##</span><br><span class="line">Text 2: OpenAI has trained cutting-edge language models that are very good at understanding and generating text. Our API provides access to these models and can be used to solve virtually any task that involves processing language.</span><br><span class="line">Keywords 2: OpenAI, language models, text processing, API.</span><br><span class="line">##</span><br><span class="line">Text 3: &#123;text&#125;</span><br><span class="line">Keywords 3:</span><br></pre></td></tr></table></figure><p><strong>å¾®è°ƒï¼šè¯·å‚é˜…æ­¤å¤„çš„å¾®è°ƒæœ€ä½³å®è·µ <a href="https://docs.google.com/document/d/1h-GTjNDDKPKU_Rsd0t1lXCAnHltaXTAzQ8K2HRhQf9U/edit#">here</a></strong></p><h2 id="å‡å°‘æ¨¡ç³Šã€ä¸å‡†ç¡®çš„æè¿°"><a href="#å‡å°‘æ¨¡ç³Šã€ä¸å‡†ç¡®çš„æè¿°" class="headerlink" title="å‡å°‘æ¨¡ç³Šã€ä¸å‡†ç¡®çš„æè¿°"></a>å‡å°‘æ¨¡ç³Šã€ä¸å‡†ç¡®çš„æè¿°</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The description for this product should be fairly short, a few sentences only, and not too much more.</span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Use a 3 to 5 sentence paragraph to describe this product.</span><br></pre></td></tr></table></figure><h2 id="ä¸å…¶è¯´ä¸è¯¥åšä»€ä¹ˆä¸å¦‚è¯´è¯¥åšä»€ä¹ˆ"><a href="#ä¸å…¶è¯´ä¸è¯¥åšä»€ä¹ˆä¸å¦‚è¯´è¯¥åšä»€ä¹ˆ" class="headerlink" title="ä¸å…¶è¯´ä¸è¯¥åšä»€ä¹ˆä¸å¦‚è¯´è¯¥åšä»€ä¹ˆ"></a>ä¸å…¶è¯´ä¸è¯¥åšä»€ä¹ˆä¸å¦‚è¯´è¯¥åšä»€ä¹ˆ</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following is a conversation between an Agent and a Customer. DO NOT ASK USERNAME OR PASSWORD. DO NOT REPEAT.</span><br><span class="line"></span><br><span class="line">Customer: I canâ€™t log in to my account.</span><br><span class="line">Agent:</span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following is a conversation between an Agent and a Customer. The agent will attempt to diagnose the problem and suggest a solution, whilst refraining from asking any questions related to PII. Instead of asking for PII, such as username or password, refer the user to the help article www.samplewebsite.com/help/faq</span><br><span class="line"></span><br><span class="line">Customer: I canâ€™t log in to my account.</span><br><span class="line">Agent:</span><br></pre></td></tr></table></figure><h2 id="ä»£ç ç”Ÿæˆç‰¹æœ‰-ä½¿ç”¨å¼•å¯¼è¯å¼•å¯¼æ¨¡å‹"><a href="#ä»£ç ç”Ÿæˆç‰¹æœ‰-ä½¿ç”¨å¼•å¯¼è¯å¼•å¯¼æ¨¡å‹" class="headerlink" title="ä»£ç ç”Ÿæˆç‰¹æœ‰ - ä½¿ç”¨å¼•å¯¼è¯å¼•å¯¼æ¨¡å‹"></a>ä»£ç ç”Ÿæˆç‰¹æœ‰ - ä½¿ç”¨å¼•å¯¼è¯å¼•å¯¼æ¨¡å‹</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Write a simple python function that</span><br><span class="line"># 1. Ask me for a number in mile</span><br><span class="line"># 2. It converts miles to kilometers</span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹æ–¹çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæ·»åŠ  â€œimportâ€ å¯¹æ¨¡å‹è¿›è¡Œæç¤ºï¼Œå®ƒåº”è¯¥ä½¿ç”¨ Python è¿›è¡Œç¼–å†™ï¼ˆç±»ä¼¼åœ°ï¼Œâ€SELECTâ€ æ˜¯ä¸€ä¸ªé’ˆå¯¹ SQL è¯­å¥å¥½çš„æç¤ºï¼‰</p><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Write a simple python function that</span><br><span class="line"># 1. Ask me for a number in mile</span><br><span class="line"># 2. It converts miles to kilometers</span><br><span class="line"> </span><br><span class="line">import</span><br></pre></td></tr></table></figure><h1 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h1><p>é€šå¸¸ï¼Œæˆ‘ä»¬å‘ç° <code>model</code> å’Œ <code>temperature</code> æ˜¯æ”¹å˜æ¨¡å‹è¾“å‡ºæœ€å¸¸ç”¨çš„å‚æ•°</p><ul><li><code>model</code> - æ›´é«˜æ€§èƒ½çš„æ¨¡å‹æˆæœ¬æ›´é«˜ï¼Œå»¶è¿Ÿä¹Ÿæ›´é«˜</li><li><code>temperature</code> - è¡¡é‡æ¨¡å‹è¾“å‡ºä¸å¤ªå¯èƒ½çš„ tokens çš„æŒ‡æ ‡ï¼›æ¸©åº¦è¶Šé«˜ï¼Œè¾“å‡ºå°±è¶Šéšæœºï¼ˆé€šå¸¸æ˜¯åˆ›é€ æ€§çš„ï¼‰ï¼›ç„¶è€Œè¿™å¹¶ä¸ç­‰åŒäºâ€œçœŸå®æ€§â€ï¼›å¯¹äºå¤§å¤šæ•°å®é™…ç”¨ä¾‹ï¼Œå¦‚æ•°æ®æå–å’ŒçœŸå®é—®ç­”ï¼Œ0 çš„å‚æ•°æ˜¯æœ€å¥½çš„</li><li><code>max_tokens</code> - ä¸èƒ½æ§åˆ¶è¾“å‡ºçš„é•¿åº¦ï¼Œæ˜¯ä¸€ä¸ªé’ˆå¯¹ token ç”Ÿæˆçš„ç¡¬æˆªæ­¢é™åˆ¶ï¼›ç†æƒ³æƒ…å†µä¸‹ä½ ä¸ä¼šç»å¸¸è¾¾åˆ°è¿™ä¸ªæé™ï¼Œå› ä¸ºå½“ä½ çš„æ¨¡å‹è®¤ä¸ºå®ƒå·²ç»å®Œæˆæ—¶ï¼Œæˆ–è€…å½“å®ƒè¾¾åˆ°ä½ å®šä¹‰çš„åœæ­¢åºåˆ—æ—¶ï¼Œå®ƒå°±ä¼šåœæ­¢</li><li><code>stop</code> - ä¸€ç»„å­—ç¬¦ï¼ˆæ ‡è®°ï¼‰ï¼Œç”Ÿæˆåå°†å¯¼è‡´æ–‡æœ¬ç”Ÿæˆåœæ­¢</li></ul><p>æ›´å¤šçš„å‚æ•°æè¿°å‚è€ƒ <a href="https://beta.openai.com/docs/api-reference/completions/create">API reference</a></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://help.openai.com/en/articles/6654000-best-practices-for-prompt-engineering-with-openai-api">Best practices for prompt engineering with OpenAI API | OpenAI Help Center</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prompt Engineer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Guava EventBus</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Guava%20EventBus.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Guava%20EventBus.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>EventBus å…è®¸ç»„ä»¶ä¹‹é—´é€šè¿‡å‘å¸ƒè®¢é˜…æ–¹å¼è¿›è¡Œäº¤äº’ï¼Œè€Œä¸éœ€è¦ç»„ä»¶ä¹‹é—´è¿›è¡Œæ˜¾å¼çš„æ³¨å†Œï¼ˆä¹Ÿæ„å‘³ç€äº’ç›¸äº†è§£å…¶å­˜åœ¨ï¼‰</p><p>å®ƒè¢«è®¾è®¡ä¸“é—¨ç”¨äºä½¿ç”¨æ˜¾å¼æ³¨å†Œæ¥æ›¿ä»£ä¼ ç»Ÿçš„ Java è¿›ç¨‹å†…äº‹ä»¶åˆ†å‘</p><p>å®ƒä¸æ˜¯é€šç”¨çš„å‘å¸ƒè®¢é˜…ç³»ç»Ÿï¼Œä¹Ÿä¸æ˜¯ç”¨äºè¿›ç¨‹é—´é€šä¿¡çš„ç³»ç»Ÿ</p><h1 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h1><p>æ‘˜è‡ª Github Guava Document <a href="https://github.com/google/guava/wiki/EventBusExplained">EventBusExplained Â· google&#x2F;guava Wiki Â· GitHub</a></p><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰å‡ºç±»å’Œè®¢é˜…çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventBusChangeRecorder</span> &#123;</span><br><span class="line">  <span class="meta">@Subscribe</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordCustomerChange</span><span class="params">(ChangeEvent e)</span> &#123;</span><br><span class="line">    recordChange(e.getChange());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ä»»æ„åœ°æ–¹è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">eventBus.register(<span class="keyword">new</span> <span class="title class_">EventBusChangeRecorder</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹‹åè¿›è¡Œæ¶ˆæ¯çš„å‘é€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeCustomer</span><span class="params">()</span></span><br><span class="line">  <span class="type">ChangeEvent</span> <span class="variable">event</span> <span class="operator">=</span> getChangeEvent();</span><br><span class="line">  eventBus.post(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸€åˆ†é’ŸæŒ‡å—"><a href="#ä¸€åˆ†é’ŸæŒ‡å—" class="headerlink" title="ä¸€åˆ†é’ŸæŒ‡å—"></a>ä¸€åˆ†é’ŸæŒ‡å—</h2><p>è½¬æ¢ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ä»¥äº‹ä»¶è®¢é˜…ä¸ºåŸºç¡€çš„ç³»ç»Ÿæ¥ä½¿ç”¨ EventBus æ˜¯å®¹æ˜“çš„</p><h3 id="è®¢é˜…è€…ï¼ˆFor-Listenersï¼‰"><a href="#è®¢é˜…è€…ï¼ˆFor-Listenersï¼‰" class="headerlink" title="è®¢é˜…è€…ï¼ˆFor Listenersï¼‰"></a>è®¢é˜…è€…ï¼ˆFor Listenersï¼‰</h3><p>è®¢é˜…ç‰¹å®šç±»å‹çš„äº‹ä»¶ï¼ˆä¾‹å¦‚ <code>CustomerChangeEvent</code>ï¼‰</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šå®ç°ä¸€ä¸ªå’Œäº‹ä»¶ç›¸å…³çš„æ¥å£ï¼Œä¾‹å¦‚ <code>CustomerChangeEventListener</code></li><li>EventBusï¼šåˆ›å»ºä¸€ä¸ªæ–¹æ³•ï¼Œ<code>CustomerChangeEvent</code> ä½œä¸ºè¿™ä¸ªæ–¹æ³•å”¯ä¸€çš„å‚æ•°ï¼Œç„¶ååœ¨æ–¹æ³•ä¸Šæ ‡è®° <code>@Subscribe</code> æ³¨è§£</li></ul><p>å‘äº‹ä»¶ç”Ÿäº§è€…æ³¨å†Œä½ çš„è®¢é˜…è€…æ–¹æ³•</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šå°†å¯¹è±¡ä¼ é€’ç»™æ¯ä¸ªç”Ÿäº§è€…çš„ <code>registerCustomerChangeEventListener</code> æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¾ˆå°‘åœ¨å…¬å…±æ¥å£ä¸­å®šä¹‰ï¼Œå› æ­¤é™¤äº†äº†è§£æ¯ä¸ªå¯èƒ½çš„ç”Ÿäº§è€…ï¼Œè¿˜å¿…é¡»äº†è§£å…¶ç±»å‹</li><li>EventBusï¼šå°†æ–¹æ³•æ‰€åœ¨å¯¹è±¡é€šè¿‡ <code>EventBus.register(Object)</code> æ–¹æ³•æ³¨å†Œåœ¨ä¸€ä¸ª <code>EventBus</code> å¯¹è±¡ä¸Šï¼Œéœ€è¦ç¡®ä¿æ¶ˆæ¯ç”Ÿäº§è€…ä½¿ç”¨çš„ <code>EventBus</code>  å®ä¾‹å’Œè¿›è¡Œæ–¹æ³•æ³¨å†Œçš„æ˜¯åŒä¸€ä¸ª</li></ul><p>è®¢é˜…ä¸€ä¸ªæ™®é€šäº‹ä»¶çš„è¶…ç±»ï¼ˆsupertypeï¼›ä¾‹å¦‚ <code>EventObject</code> æˆ–è€… <code>Object</code>ï¼‰</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šä¸å®¹æ˜“å®ç°</li><li>EventBusï¼šäº‹ä»¶ä¼šè‡ªåŠ¨åˆ†é…ç»™è¶…ç±»çš„è®¢é˜…è€…ï¼Œå…è®¸é’ˆå¯¹æ¥å£ï¼ˆInterfaceï¼‰çš„è®¢é˜…è€…æˆ–è€…é’ˆå¯¹ <code>Object</code> çš„ â€œé€šé…ç¬¦è®¢é˜…è€…â€</li></ul><p>è¦è®¢é˜…æˆ–æ£€æµ‹åœ¨æ²¡æœ‰åˆé€‚äº‹ä»¶è®¢é˜…è€…å­˜åœ¨çš„äº‹ä»¶</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šåœ¨æ¯ä¸ªäº‹ä»¶è°ƒåº¦æ–¹æ³•ä¸Šæ·»åŠ ä»£ç ï¼ˆå¯èƒ½ä½¿ç”¨ AOPï¼‰</li><li>EventBusï¼šè®¢é˜… <code>DeadEvent</code>ï¼Œéšå <code>EventBus</code> å°†ä¼šé€šçŸ¥ä½ ä»»ä½•å·²ç»å·²ç»ç”Ÿäº§ä½†æ˜¯æ²¡æœ‰æ¶ˆè´¹äº¤ä»˜çš„äº‹ä»¶ï¼ˆä¾¿ä¸è°ƒè¯•ï¼‰</li></ul><h3 id="ç”Ÿäº§è€…ï¼ˆFor-Producersï¼‰"><a href="#ç”Ÿäº§è€…ï¼ˆFor-Producersï¼‰" class="headerlink" title="ç”Ÿäº§è€…ï¼ˆFor Producersï¼‰"></a>ç”Ÿäº§è€…ï¼ˆFor Producersï¼‰</h3><p>è·Ÿè¸ªè®¢é˜…è€…å¤„ç†äº‹ä»¶</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šå†™ä»£ç ç®¡ç†è®¢é˜…è€…åˆ—è¡¨ï¼ŒåŒ…æ‹¬åŒæ­¥ï¼Œæˆ–è€…ä½¿ç”¨å…¬å…±ç±»ä¾‹å¦‚ <code>EventListenerList</code></li><li>EventBusï¼š<code>EventBus</code> å·²ç»ä¸ºä½ å®ç°äº†</li></ul><p>æ´¾å‘äº‹ä»¶ç»™è®¢é˜…è€…</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šæ˜¾å¼å®ç°ä¸€ä¸ªå‘å„ä¸ªäº‹ä»¶è®¢é˜…è€…åˆ†é…äº‹ä»¶çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬é”™è¯¯éš”ç¦»å’Œå¼‚æ­¥ï¼ˆå¦‚æœå¸Œæœ›å¦‚æ­¤ï¼‰</li><li>EventBusï¼šä¼ é€’æ¶ˆæ¯å¯¹è±¡ç»™ä¸€ä¸ª <code>EventBus</code> å®ä¾‹çš„ <code>EventBus.post(Object)</code> æ–¹æ³•</li></ul><h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>EventBus ç³»ç»Ÿå’Œä»£ç ä½¿ç”¨ä»¥ä¸‹æœ¯è¯­æ¥è®¨è®ºäº‹ä»¶åˆ†å‘</p><table><thead><tr><th align="center">æœ¯è¯­</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">Event</td><td align="center">ä»»ä½•å¯èƒ½ä¼šè¢«ä¼ é€’ç»™ä¸€ä¸ªæ€»çº¿çš„å¯¹è±¡</td></tr><tr><td align="center">Subcribing</td><td align="center">æ³¨å†Œä¸€ä¸ª listener ç»™ <code>EventBus</code> çš„è¡Œä¸ºï¼Œä»¥ä¾¿å…¶å¤„ç†æ–¹æ³•å°†ä¼šæ¥æ”¶äº‹ä»¶</td></tr><tr><td align="center">Listener</td><td align="center">ä¸€ä¸ªå¸Œæœ›æ¥æ”¶äº‹ä»¶çš„å¯¹è±¡ï¼Œæš´éœ²å¤„ç†æ–¹æ³•ï¼ˆhandler methodï¼‰</td></tr><tr><td align="center">Handler method</td><td align="center">ä¸€ä¸ª public æ–¹æ³•ï¼Œ<code>EventBus</code> å¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•å¤„ç†äº‹ä»¶ï¼›ä½¿ç”¨ <code>@Subcribe</code> æ³¨è§£è¿›è¡Œæ ‡è®°</td></tr><tr><td align="center">Posting an event</td><td align="center">ç¡®ä¿äº‹ä»¶é€šè¿‡ <code>EventBus</code> è¢«ä»»æ„è®¢é˜…è€…æ¥æ”¶</td></tr></tbody></table><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p><strong>ä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åˆ›å»ºè‡ªå·±çš„ <code>EventBus</code> è€Œä¸æ˜¯ä½¿ç”¨å•ä¾‹</strong></p><p><code>EventBus</code> å¹¶æ²¡æœ‰æ˜ç¡®æŒ‡å‡ºä½ å¦‚ä½•ä½¿ç”¨å®ƒï¼›å¯¹äºé’ˆå¯¹æ¯ä¸ªç»„ä»¶çš„äº‹ä»¶æ€»çº¿å¹¶æ²¡æœ‰ç¦æ­¢ä½¿ç”¨å„è‡ªç‹¬ç«‹çš„å®ä¾‹ï¼Œä¹Ÿæ²¡æœ‰ç¦æ­¢é’ˆå¯¹ä¸åŒä¸Šä¸‹æ–‡ã€ä¸»é¢˜çš„æ—¶é—´ä½¿ç”¨ç‹¬ç«‹çš„å®ä¾‹ï¼›å¦‚æœè¿›è¡Œæ‹†åˆ†ï¼Œä¼šä½¿å¾—åœ¨æµ‹è¯•ä¸­åˆ›å»ºã€åˆ é™¤ <code>EventBus</code> å¯¹è±¡æ›´åŠ å®¹æ˜“ã€</p><p>å½“ç„¶ï¼Œå¦‚æœä½ æƒ³æœ‰ä¸€ä¸ªå¤§è€Œå…¨é€»è¾‘çš„ <code>EventBus</code> å•ä¾‹ï¼Œå¹¶ä¸ä¼šé˜»æ­¢ä½ è¿™æ ·åšï¼Œåªéœ€è®©æ‚¨çš„å®¹å™¨ï¼ˆä¾‹å¦‚ Guiceï¼‰åœ¨å…¨å±€èŒƒå›´å†…å°† <code>EventBus</code> åˆ›å»ºä¸ºä¸€ä¸ªå•ä¾‹ï¼ˆæˆ–è€…å°†å…¶å­˜å‚¨ä¸ºä¸€ä¸ªé™æ€å˜é‡ï¼Œå¦‚æœæƒ³è¿™æ ·åšçš„è¯ï¼‰</p><p>æ€»è€Œè¨€ä¹‹ï¼Œ<code>EventBus</code> ä¸æ˜¯ä¸€ä¸ªå•ä¾‹æ˜¯å› ä¸ºæˆ‘ä»¬ä¸æƒ³åšå‡ºè¿™ç§å†³å®šï¼Œä½ å¯ä»¥æ ¹æ®å–œå¥½å†³å®šå¦‚ä½•ä½¿ç”¨</p><p><strong>æˆ‘å¯ä»¥å‘ <code>EventBus</code> å–æ¶ˆæ³¨å†ŒæŸä¸ªè®¢é˜…è€…å—</strong></p><p>å¯ä»¥ï¼Œä½¿ç”¨ <code>EventBus.unregister</code>ï¼›åªä¸è¿‡æˆ‘ä»¬å‘ç°è¿™ç§éœ€æ±‚å¾ˆå°‘è§ï¼š</p><ul><li>å¤§éƒ¨åˆ†è®¢é˜…è€…éƒ½åœ¨å¯åŠ¨æ—¶è¿›è¡Œæ³¨å†Œæˆ–è€…æ‡’åŠ è½½ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­æŒç»­å­˜åœ¨</li><li>ç‰¹æ®ŠèŒƒå›´ï¼ˆscope-specificï¼‰çš„ <code>EventBus</code> å®ä¾‹å¯ä»¥å¤„ç†ä¸´æ—¶çš„äº‹ä»¶åˆ†å‘ï¼ˆä¾‹å¦‚åœ¨è¯·æ±‚èŒƒå›´çš„å¯¹è±¡ä¹‹é—´åˆ†å‘äº‹ä»¶ï¼‰</li><li>å¯¹äºæµ‹è¯•ï¼Œ<code>EventBus</code> å®ä¾‹å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ›å»ºæˆ–ä¸¢å¼ƒï¼Œä»è€Œæ— éœ€æ˜¾å¼æ³¨é”€</li></ul><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨æ³¨è§£æ¥æ ‡è®°è®¢é˜…æ–¹æ³•ï¼Œè€Œä¸æ˜¯è®¢é˜…è€…å®ç°æ¥å£</strong></p><p>æˆ‘ä»¬è®¤ä¸º <code>@Subscribe</code> æ³¨è§£å¯ä»¥ä¼ è¾¾çœŸå®çš„æ„å›¾ï¼Œå°±åƒå®ç°æ¥å£ä¸€æ ·æ˜ç¡®ï¼ˆæˆ–è€…æ›´æ˜ç¡®ï¼‰ï¼ŒåŒæ—¶è®©æ‚¨å¯ä»¥è‡ªç”±åœ°å°†äº‹ä»¶è®¢é˜…è€…æ–¹æ³•æ”¾ç½®åœ¨ä»»ä½•æ‚¨å¸Œæœ›çš„ä½ç½®ï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›éœ€è¦çš„åç§°</p><p>ä¼ ç»Ÿçš„ <code>JavaEvents</code> ä½¿ç”¨ä¾¦å¬å™¨æ¥å£ï¼Œè¯¥æ¥å£é€šå¸¸åªè¿è¡Œå°‘æ•°æ–¹æ³•â€”â€”é€šå¸¸æ˜¯ä¸€ä¸ªï¼Œè¿™æœ‰è®¸å¤šç¼ºç‚¹ï¼š</p><ul><li>ä»»ä½•ä¸€ä¸ªç±»éƒ½åªèƒ½å®ç°å¯¹ç»™å®šäº‹ä»¶çš„å•ä¸ªå“åº”</li><li>è®¢é˜…è€…æ¥å£æ–¹æ³•å¯èƒ½å‘ç”Ÿå†²çª</li><li>æ–¹æ³•å¿…é¡»ä»¥äº‹ä»¶å‘½åï¼ˆä¾‹å¦‚ <code>handleChangeEvent</code> ï¼‰ï¼Œè€Œä¸æ˜¯ä»¥å…¶ç›®çš„ï¼ˆä¾‹å¦‚ <code>recordChangeInJournal</code> ï¼‰å‘½å</li><li>æ¯ç§äº‹ä»¶éƒ½æœ‰ä»–ä»¬è‡ªå·±çš„æ¥å£ï¼Œæ²¡æœ‰ä¸€ä¸ªé’ˆå¯¹äº‹ä»¶æ—çš„é€šç”¨çˆ¶ç±»æ¥å£</li></ul><p>å¹²å‡€æ¸…æ™°åœ°å®ç°ä¼šå­˜åœ¨å›°éš¾ï¼Œè§£å†³å›°éš¾å¯¼è‡´äº†ä¸€ç§æ¨¡å¼ï¼Œå³ä½¿ç”¨ç®€å•çš„åŒ¿åç±»æ¥å®ç°è®¢é˜…å™¨æ¥å£</p><p>æ¯”è¾ƒå¦‚ä¸‹ä¸¤ä¸ª case</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ChangeRecorder</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setCustomer</span><span class="params">(Customer cust)</span> &#123;</span><br><span class="line">    cust.addChangeListener(<span class="keyword">new</span> <span class="title class_">ChangeListener</span>() &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customerChanged</span><span class="params">(ChangeEvent e)</span> &#123;</span><br><span class="line">        recordChange(e.getChange());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class is typically registered by the container.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventBusChangeRecorder</span> &#123;</span><br><span class="line">  <span class="meta">@Subscribe</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordCustomerChange</span><span class="params">(ChangeEvent e)</span> &#123;</span><br><span class="line">    recordChange(e.getChange());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œæ„å›¾æ›´æ¸…æ™°ï¼šå†—ä½™ä»£ç ï¼ˆnoise codeï¼‰æ›´å°‘ï¼Œäº‹ä»¶è®¢é˜…è€…æœ‰ä¸€ä¸ªæ¸…æ™°è€Œæœ‰æ„ä¹‰çš„åç§°</p><p><strong>å¦‚æœæˆ‘æ³¨å†Œäº†ä¸€ä¸ªæ²¡æœ‰ä»»ä½•è®¢é˜…è€…æ–¹æ³•çš„ä¾¦å¬å™¨ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</strong></p><p>ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ</p><p>EventBus æ€»æ˜¯è®¾è®¡å’Œå®¹å™¨ã€æ¨¡å—ç³»ç»Ÿé›†æˆï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œè®©å®¹å™¨ã€å·¥å‚ã€ç¯å¢ƒå°†æ¯ä¸ªåˆ›å»ºçš„å¯¹è±¡ä¼ é€’ç»™EventBus çš„ <code>register</code> æ–¹æ³•æ˜¯å¾ˆæ–¹ä¾¿çš„</p><p>è¿™æ ·ï¼Œå®¹å™¨ã€å·¥å‚ã€ç¯å¢ƒåˆ›å»ºçš„ä»»ä½•å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡å…¬å¼€è®¢é˜…è€…æ–¹æ³•æŒ‚æ¥åˆ°ç³»ç»Ÿçš„äº‹ä»¶æ¨¡å‹ä¸­</p><p><strong>åœ¨ç¼–è¯‘æ—¶å¯ä»¥æ£€æµ‹åˆ°å“ªäº› Event Bus é—®é¢˜ï¼Ÿ</strong></p><p>Java çš„ç±»å‹ç³»ç»Ÿå¯ä»¥æ˜ç¡®æ£€æµ‹åˆ°çš„ä»»ä½•é—®é¢˜</p><p>ä¾‹å¦‚ä¸ºä¸å­˜åœ¨çš„äº‹ä»¶ç±»å‹å®šä¹‰è®¢é˜…è€…æ–¹æ³•</p><p><strong>å“ªäº› Event Bus é—®é¢˜å¯ä»¥åœ¨æ³¨å†Œæ—¶ç«‹å³æ£€æµ‹åˆ°ï¼Ÿ</strong></p><p>è°ƒç”¨ <code>register</code> åï¼Œå°†ç«‹å³æ£€æŸ¥æ­£åœ¨æ³¨å†Œçš„ä¾¦å¬å™¨çš„è®¢é˜…è€…æ–¹æ³•çš„æ ¼å¼æ˜¯å¦æ­£ç¡®</p><p>ç‰¹åˆ«æ˜¯ï¼Œä»»ä½•ç”¨ <code>@Subscribe</code> æ ‡è®°çš„æ–¹æ³•éƒ½å¿…é¡»åªæ¥å—ä¸€ä¸ªå‚æ•°</p><p>ä»»ä½•è¿åæ­¤è§„åˆ™çš„è¡Œä¸ºéƒ½å°†å¼•å‘ <code>IllegalArgumentException</code>ï¼ˆè¿™ä¸ªæ£€æŸ¥å¯ä»¥è½¬ç§»åˆ°ä½¿ç”¨ APT çš„ç¼–è¯‘æ—¶é—´ï¼Œè¿™æ˜¯æˆ‘ä»¬æ­£åœ¨ç ”ç©¶çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼‰</p><p><strong>å“ªäº› Event Bus é—®é¢˜åªèƒ½åœ¨ç¨åçš„è¿è¡Œæ—¶æ£€æµ‹åˆ°ï¼Ÿ</strong></p><p>å¦‚æœç»„ä»¶ post äº†æ²¡æœ‰æ³¨å†Œä¾¦å¬å™¨çš„äº‹ä»¶ï¼Œåˆ™å¯èƒ½æŒ‡ç¤ºé”™è¯¯ï¼ˆé€šå¸¸æŒ‡ç¤ºæ‚¨é”™è¿‡äº† <code>@Subscribe</code> æ³¨é‡Šï¼Œæˆ–è€…ä¾¦å¬ç»„ä»¶æœªåŠ è½½ï¼‰</p><p>ï¼ˆè¯·æ³¨æ„ï¼Œè¿™å¹¶ä¸ä¸€å®šæ„å‘³ç€æœ‰é—®é¢˜ï¼›åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä¼šæ•…æ„å¿½ç•¥å‘å¸ƒçš„äº‹ä»¶ï¼Œå°¤å…¶æ˜¯å½“äº‹ä»¶æ¥è‡ªæ‚¨æ— æ³•æ§åˆ¶çš„ä»£ç æ—¶ï¼‰</p><p>è¦å¤„ç†æ­¤ç±»äº‹ä»¶ï¼Œè¯·ä¸º <code>DeadEvent</code> ç±»æ³¨å†Œä¸€ä¸ªè®¢é˜…è€…æ–¹æ³•ï¼Œæ¯å½“ <code>EventBus</code> æ¥æ”¶åˆ°æ²¡æœ‰æ³¨å†Œè®¢é˜…è€…çš„äº‹ä»¶æ—¶ï¼Œå®ƒéƒ½ä¼šå°†å…¶è½¬æ¢ä¸º <code>DeadEvent</code> å¹¶æŒ‰æ‚¨çš„æ–¹å¼ä¼ é€’ï¼Œä»è€Œå…è®¸æ‚¨è®°å½•å®ƒæˆ–ä»¥å…¶ä»–æ–¹å¼æ¢å¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ­»ä¿¡äº‹ä»¶ï¼šæ¥æ”¶æ²¡æœ‰è®¢é˜…è€…çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerDeadEvent</span><span class="params">(DeadEvent deadEvent)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;EventListener#listenerDeadEvent -&gt; &quot;</span> + deadEvent.getEvent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æˆ‘å¦‚ä½•æµ‹è¯•æ¶ˆæ¯è®¢é˜…è€…å’Œä»–ä»¬çš„è®¢é˜…æ–¹æ³•ï¼Ÿ</strong></p><p>å› ä¸ºä¾¦å¬å™¨ç±»ä¸Šçš„è®¢é˜…è€…æ–¹æ³•æ˜¯æ™®é€šæ–¹æ³•ï¼Œæ‰€ä»¥æ‚¨å¯ä»¥ç®€å•åœ°ä»æµ‹è¯•ä»£ç ä¸­è°ƒç”¨å®ƒä»¬æ¥æ¨¡æ‹Ÿ <code>EventBus</code></p><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><h2 id="EventBus"><a href="#EventBus" class="headerlink" title="EventBus"></a>EventBus</h2><p><code>EventBus</code> æ‰¿è½½äº†è®¢é˜…ä¿¡æ¯å’Œ post äº‹ä»¶çš„èƒ½åŠ›ï¼Œå®ä¾‹å’Œå®ä¾‹ä¹‹é—´çš„ä¿¡æ¯äº’ç›¸éš”ç¦»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">EventBus(</span><br><span class="line">    String identifier,</span><br><span class="line">    Executor executor,</span><br><span class="line">    Dispatcher dispatcher,</span><br><span class="line">    SubscriberExceptionHandler exceptionHandler) &#123;</span><br><span class="line">  <span class="built_in">this</span>.identifier = checkNotNull(identifier);</span><br><span class="line">  <span class="built_in">this</span>.executor = checkNotNull(executor);</span><br><span class="line">  <span class="built_in">this</span>.dispatcher = checkNotNull(dispatcher);</span><br><span class="line">  <span class="built_in">this</span>.exceptionHandler = checkNotNull(exceptionHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æ„é€ å™¨æ¥çœ‹ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸»è¦çš„åˆå§‹å±æ€§ï¼š</p><ul><li>identifierï¼šè¯¥ <code>EventBus</code> å®ä¾‹çš„ç®€ç§°æ ‡è¯†</li><li>executorï¼šæ‰§è¡Œå™¨ï¼›é»˜è®¤æ˜¯ä¸€ä¸ªç›´æ¥æ‰§è¡Œå™¨</li><li>dispatcherï¼šè°ƒåº¦å™¨ï¼›é»˜è®¤æ˜¯å•çº¿ç¨‹é˜Ÿåˆ—è°ƒåº¦</li><li>exceptionHandlerï¼šå¼‚å¸¸å¤„ç†å™¨</li></ul><p><code>EventBus</code> è¿˜æœ‰ä¸€ä¸ªå­ç±» <code>AsyncEventBus</code></p><p>åŒºåˆ«åœ¨äºå¯ä»¥è®¾ç½® <code>Executor</code>ï¼Œ<code>Dispatcher</code> é»˜è®¤ä¸º <code>LegacyAsyncDispatcher</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AsyncEventBus</span><span class="params">(Executor executor, SubscriberExceptionHandler subscriberExceptionHandler)</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>(<span class="string">&quot;default&quot;</span>, executor, Dispatcher.legacyAsync(), subscriberExceptionHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="register-æ³¨å†Œè®¢é˜…æ–¹æ³•"><a href="#register-æ³¨å†Œè®¢é˜…æ–¹æ³•" class="headerlink" title="register æ³¨å†Œè®¢é˜…æ–¹æ³•"></a>register æ³¨å†Œè®¢é˜…æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">EventBus</span> <span class="variable">eventBus</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventBus</span>();</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> <span class="title class_">EventListener</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ç”¨äºæ³¨å†Œè®¢é˜…æ–¹æ³•ï¼Œå³å¤„ç†äº‹ä»¶çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object listener)</span> &#123;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°æ‰€æœ‰åŒ…è£…çš„ Subscriber</span></span><br><span class="line">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; listenerMethods = findAllSubscribers(listener);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Entry&lt;Class&lt;?&gt;, Collection&lt;Subscriber&gt;&gt; entry : listenerMethods.asMap().entrySet()) &#123;</span><br><span class="line">    Class&lt;?&gt; eventType = entry.getKey();</span><br><span class="line">    Collection&lt;Subscriber&gt; eventMethodsInListener = entry.getValue();</span><br><span class="line"></span><br><span class="line">    CopyOnWriteArraySet&lt;Subscriber&gt; eventSubscribers = subscribers.get(eventType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜åˆ° eventSubscribers</span></span><br><span class="line">    <span class="keyword">if</span> (eventSubscribers == <span class="literal">null</span>) &#123;</span><br><span class="line">      CopyOnWriteArraySet&lt;Subscriber&gt; newSet = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;&gt;();</span><br><span class="line">      <span class="comment">// key æ˜¯ event type</span></span><br><span class="line">      eventSubscribers =</span><br><span class="line">          MoreObjects.firstNonNull(subscribers.putIfAbsent(eventType, newSet), newSet);</span><br><span class="line">    &#125;</span><br><span class="line">    eventSubscribers.addAll(eventMethodsInListener);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº† Guava åŒ…ä¸‹çš„ cache å·¥å…·</p><p>ç›´æ¥çœ‹æ‰«æè®¢é˜…æ–¹æ³•çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ImmutableList&lt;Method&gt; <span class="title function_">getAnnotatedMethodsNotCached</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    Set&lt;? <span class="keyword">extends</span> <span class="title class_">Class</span>&lt;?&gt;&gt; supertypes = TypeToken.of(clazz).getTypes().rawTypes();</span><br><span class="line">    Map&lt;MethodIdentifier, Method&gt; identifiers = Maps.newHashMap();</span><br><span class="line">  <span class="comment">// éå†ç±»å‹</span></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; supertype : supertypes) &#123;</span><br><span class="line">      <span class="comment">// éå†æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">for</span> (Method method : supertype.getDeclaredMethods()) &#123;</span><br><span class="line">        <span class="comment">// æ‰«ææ³¨è§£</span></span><br><span class="line">        <span class="keyword">if</span> (method.isAnnotationPresent(Subscribe.class) &amp;&amp; !method.isSynthetic()) &#123;</span><br><span class="line">          <span class="comment">// TODO(cgdecker): Should check for a generic parameter type and error out</span></span><br><span class="line">          Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">          <span class="comment">// check æ–¹æ³•å‚æ•°æ•°é‡</span></span><br><span class="line">          checkArgument(</span><br><span class="line">              parameterTypes.length == <span class="number">1</span>,</span><br><span class="line">              <span class="string">&quot;Method %s has @Subscribe annotation but has %s parameters. &quot;</span></span><br><span class="line">                  + <span class="string">&quot;Subscriber methods must have exactly 1 parameter.&quot;</span>,</span><br><span class="line">              method,</span><br><span class="line">              parameterTypes.length);</span><br><span class="line"><span class="comment">// check æ–¹æ³•å‚æ•°æ˜¯å¦æ˜¯åŸå§‹ç±»å‹</span></span><br><span class="line">          checkArgument(</span><br><span class="line">              !parameterTypes[<span class="number">0</span>].isPrimitive(),</span><br><span class="line">              <span class="string">&quot;@Subscribe method %s&#x27;s parameter is %s. &quot;</span></span><br><span class="line">                  + <span class="string">&quot;Subscriber methods cannot accept primitives. &quot;</span></span><br><span class="line">                  + <span class="string">&quot;Consider changing the parameter to %s.&quot;</span>,</span><br><span class="line">              method,</span><br><span class="line">              parameterTypes[<span class="number">0</span>].getName(),</span><br><span class="line">              Primitives.wrap(parameterTypes[<span class="number">0</span>]).getSimpleName());</span><br><span class="line"></span><br><span class="line">          <span class="comment">// åŒ…è£…åå°„å‡ºçš„æ–¹æ³•</span></span><br><span class="line">          <span class="type">MethodIdentifier</span> <span class="variable">ident</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodIdentifier</span>(method);</span><br><span class="line">          <span class="keyword">if</span> (!identifiers.containsKey(ident)) &#123;</span><br><span class="line">            <span class="comment">// ä¿å­˜</span></span><br><span class="line">            identifiers.put(ident, method);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ImmutableList.copyOf(identifiers.values());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹ï¼š</p><ul><li>è·å– <code>Object</code> å¯¹è±¡çš„ç±»å‹åˆ—è¡¨</li><li>éå†æ–¹æ³•</li><li>æ‰«æå‡º <code>Subscribe</code> æ–¹æ³•ï¼Œæ ¡éªŒå‚æ•°åˆ—è¡¨</li><li>åŒ…è£…ä¸º <code>MethodIdentifier</code> ä¿å­˜</li></ul><h2 id="post-å‘å¸ƒäº‹ä»¶"><a href="#post-å‘å¸ƒäº‹ä»¶" class="headerlink" title="post å‘å¸ƒäº‹ä»¶"></a>post å‘å¸ƒäº‹ä»¶</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">EventBus</span> <span class="variable">eventBus</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventBus</span>();</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> <span class="title class_">EventListener</span>());</span><br><span class="line">        eventBus.post(<span class="number">1</span>);</span><br><span class="line">        eventBus.post(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘å¸ƒäº‹ä»¶çš„æ“ä½œå…¶å®å°±åŒ…å«äº†å¯¹è®¢é˜…è€…çš„è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">post</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">  <span class="comment">// æ ¹æ® event type æŸ¥è¯¢è®¢é˜…è€…åˆ—è¡¨</span></span><br><span class="line">  Iterator&lt;Subscriber&gt; eventSubscribers = subscribers.getSubscribers(event);</span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰è®¢é˜…æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ dispatch</span></span><br><span class="line">  <span class="keyword">if</span> (eventSubscribers.hasNext()) &#123;</span><br><span class="line">    dispatcher.dispatch(event, eventSubscribers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(event <span class="keyword">instanceof</span> DeadEvent)) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹åº”äº‹ä»¶æ²¡æœ‰è®¢é˜…è€…ï¼Œåˆ™åŒ…è£…ä¸ºæ­»ä¿¡æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">// the event had no subscribers and was not itself a DeadEvent</span></span><br><span class="line">    post(<span class="keyword">new</span> <span class="title class_">DeadEvent</span>(<span class="built_in">this</span>, event));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸åŒçš„è°ƒåº¦å™¨æœ‰ä¸åŒçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">  checkNotNull(event);</span><br><span class="line">  checkNotNull(subscribers);</span><br><span class="line">  Queue&lt;Event&gt; queueForThread = queue.get();</span><br><span class="line">  queueForThread.offer(<span class="keyword">new</span> <span class="title class_">Event</span>(event, subscribers));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dispatching.get()) &#123;</span><br><span class="line">    dispatching.set(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Event nextEvent;</span><br><span class="line">      <span class="keyword">while</span> ((nextEvent = queueForThread.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (nextEvent.subscribers.hasNext()) &#123;</span><br><span class="line">          nextEvent.subscribers.next().dispatchEvent(nextEvent.event);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      dispatching.remove();</span><br><span class="line">      queue.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨ <code>Subscriber</code> çš„ <code>dispatchEvent</code> æ–¹æ³•ï¼Œé€šè¿‡åå°„è¿›è¡Œæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">dispatchEvent</span><span class="params">(<span class="keyword">final</span> Object event)</span> &#123;</span><br><span class="line">  executor.execute(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            invokeSubscriberMethod(event);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            bus.handleSubscriberException(e.getCause(), context(event));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Dispatcher-è°ƒåº¦å™¨"><a href="#Dispatcher-è°ƒåº¦å™¨" class="headerlink" title="Dispatcher è°ƒåº¦å™¨"></a>Dispatcher è°ƒåº¦å™¨</h2><p>è°ƒåº¦å™¨ç”¨æ¥æ”¹å˜äº‹ä»¶å‘å¸ƒåè°ƒç”¨è®¢é˜…æ–¹æ³•çš„é¡ºåº</p><p>æœ‰ä¸‰ç§å®ç°ï¼š</p><ul><li>PerThreadQueuedDispatcherï¼šæ¯ä¸ªçº¿ç¨‹å†…çš„äº‹ä»¶éƒ½æŒ‰ç…§å‘å¸ƒé¡ºåºè°ƒç”¨è®¢é˜…è€…ï¼›å¹¿åº¦ä¼˜å…ˆ</li><li>LegacyAsyncDispatcherï¼šå•ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­å‘å¸ƒçš„äº‹ä»¶è¿›è¡Œæ’é˜Ÿï¼›å¹¿åº¦ä¼˜å…ˆ</li><li>ImmediateDispatcherï¼šäº‹ä»¶å‘å¸ƒåç«‹å³å°†äº‹ä»¶è°ƒåº¦ç»™è®¢é˜…è€…ï¼Œè€Œä¸ä½¿ç”¨ä¸­é—´é˜Ÿåˆ—æ¥æ›´æ”¹è°ƒåº¦é¡ºåºï¼›æ·±åº¦ä¼˜å…ˆ</li></ul><h3 id="PerThreadQueuedDispatcher"><a href="#PerThreadQueuedDispatcher" class="headerlink" title="PerThreadQueuedDispatcher"></a>PerThreadQueuedDispatcher</h3><p>æ¯ä¸ªçº¿ç¨‹å†…çš„äº‹ä»¶éƒ½æŒ‰ç…§å‘å¸ƒé¡ºåºè°ƒç”¨è®¢é˜…è€…ï¼›å¹¿åº¦ä¼˜å…ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">PerThreadQueuedDispatcher</span> <span class="keyword">extends</span> <span class="title class_">Dispatcher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This dispatcher matches the original dispatch behavior of EventBus.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Per-thread queue of events to dispatch. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt; queue =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Queue&lt;Event&gt;&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">protected</span> Queue&lt;Event&gt; <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Queues.newArrayDeque();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Per-thread dispatch state, used to avoid reentrant event dispatching. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; dispatching =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Boolean&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">protected</span> Boolean <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">      checkNotNull(event);</span><br><span class="line">      checkNotNull(subscribers);</span><br><span class="line">      <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ event é˜Ÿåˆ—</span></span><br><span class="line">      Queue&lt;Event&gt; queueForThread = queue.get();</span><br><span class="line">      <span class="comment">// å°†å½“å‰å‘å¸ƒçš„äº‹ä»¶ offer è¿›é˜Ÿåˆ—</span></span><br><span class="line">      queueForThread.offer(<span class="keyword">new</span> <span class="title class_">Event</span>(event, subscribers));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ¤æ–­è°ƒåº¦æ ‡è®°</span></span><br><span class="line">      <span class="keyword">if</span> (!dispatching.get()) &#123;</span><br><span class="line">        <span class="comment">// è°ƒåº¦æ ‡è®°ï¼Œè®¾ç½®ä¸º true</span></span><br><span class="line">        dispatching.set(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Event nextEvent;</span><br><span class="line">          <span class="keyword">while</span> ((nextEvent = queueForThread.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (nextEvent.subscribers.hasNext()) &#123;</span><br><span class="line">              <span class="comment">// è°ƒåº¦è®¢é˜…æ–¹æ³•</span></span><br><span class="line">              nextEvent.subscribers.next().dispatchEvent(nextEvent.event);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// æ¸…ç† ThreadLocal</span></span><br><span class="line">          dispatching.remove();</span><br><span class="line">          queue.remove();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PerThreadQueuedDispatcher</code> éš”ç¦»äº†çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹çš„äº‹ä»¶éƒ½åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸‹ä¿è¯è°ƒåº¦</p><p>åŒæ—¶ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹éš”ç¦»çš„æ ‡è®° <code>dispatching</code> å½“å‰çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨è°ƒåº¦ä¸­</p><p>è¿™æ ·å°±è¾¾åˆ°äº†å¹¿åº¦ä¼˜å…ˆçš„æ•ˆæœï¼Œäº‹ä»¶ A å’Œäº‹ä»¶ B  &#x3D;&gt; [a1,a2,a3,b1,b2,b3]</p><h3 id="LegacyAsyncDispatcher"><a href="#LegacyAsyncDispatcher" class="headerlink" title="LegacyAsyncDispatcher"></a>LegacyAsyncDispatcher</h3><p>å•ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­å‘å¸ƒçš„äº‹ä»¶è¿›è¡Œæ’é˜Ÿï¼›å¹¿åº¦ä¼˜å…ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LegacyAsyncDispatcher</span> <span class="keyword">extends</span> <span class="title class_">Dispatcher</span> &#123;</span><br><span class="line">    <span class="comment">/** Global event queue. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentLinkedQueue&lt;EventWithSubscriber&gt; queue =</span><br><span class="line">        Queues.newConcurrentLinkedQueue();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">      checkNotNull(event);</span><br><span class="line">      <span class="keyword">while</span> (subscribers.hasNext()) &#123;</span><br><span class="line">        queue.add(<span class="keyword">new</span> <span class="title class_">EventWithSubscriber</span>(event, subscribers.next()));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      EventWithSubscriber e;</span><br><span class="line">      <span class="keyword">while</span> ((e = queue.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        e.subscriber.dispatchEvent(e.event);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†ä¸€ä¸ªå…¨å±€äº‹ä»¶é˜Ÿåˆ— <code>ConcurrentLinkedQueue</code> æ¥ä¿è¯é¡ºåº</p><p>ä»¥æ­¤åœ¨å¼‚æ­¥çš„è¿‡ç¨‹ä¸­åŒæ ·è¾¾åˆ°æ¶ˆæ¯è®¢é˜…å¹¿åº¦çš„æ•ˆæœ</p><p>äº‹ä»¶ A å’Œäº‹ä»¶ B  &#x3D;&gt; [a1,a2,a3,b1,b2,b3]</p><h3 id="ImmediateDispatcher"><a href="#ImmediateDispatcher" class="headerlink" title="ImmediateDispatcher"></a>ImmediateDispatcher</h3><p>äº‹ä»¶å‘å¸ƒåç«‹å³å°†äº‹ä»¶è°ƒåº¦ç»™è®¢é˜…è€…ï¼Œè€Œä¸ä½¿ç”¨ä¸­é—´é˜Ÿåˆ—æ¥æ›´æ”¹è°ƒåº¦é¡ºåºï¼›æ·±åº¦ä¼˜å…ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ImmediateDispatcher</span> <span class="keyword">extends</span> <span class="title class_">Dispatcher</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ImmediateDispatcher</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImmediateDispatcher</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">    checkNotNull(event);</span><br><span class="line">    <span class="keyword">while</span> (subscribers.hasNext()) &#123;</span><br><span class="line">      subscribers.next().dispatchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯äº‹ä»¶å‘å¸ƒåæ‹¿åˆ°è®¢é˜…åˆ—è¡¨ç«‹å³è°ƒåº¦</p><p>åŒºåˆ«æ’é˜Ÿçš„æœºåˆ¶ï¼Œæ¶ˆæ¯å’Œæ¶ˆæ¯ä¹‹é—´ä¸ä¿è¯å…ˆåé¡ºåº</p><p>äº‹ä»¶ A å’Œäº‹ä»¶ B ä¹‹é—´æœ‰å¯èƒ½æ˜¯ [a1,a2,a3,b1,b2,b3]ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ [a1,a2,b1,b2,a3,b3]ï¼Œä¹Ÿå¯èƒ½æ˜¯ [a1,b1,b2,b3,a2,a3]</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://github.com/google/guava/wiki/EventBusExplained">EventBusExplained Â· google&#x2F;guava Wiki Â· GitHub</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Guava </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Šç”µå‰ä»–ç³»ç»Ÿæ•™ç¨‹1.0ã€‹å­¦ä¹ ç¬”è®°</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%8D%8E%E5%8C%97%E6%97%A0%E6%B5%AA%E6%BC%AB/%E3%80%8A%E7%94%B5%E5%90%89%E4%BB%96%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B1.0%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%8D%8E%E5%8C%97%E6%97%A0%E6%B5%AA%E6%BC%AB/%E3%80%8A%E7%94%B5%E5%90%89%E4%BB%96%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B1.0%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹°äº†äººç”Ÿç¬¬ä¸€æŠŠç”µå‰ä»–ï¼ˆå‹å·æ˜¯ <strong>Ibenez</strong> çš„ <strong>GRG121SP</strong>ï¼‰</p><p>ä¸‹é¢æ˜¯å…¶å¸…ç…§~</p><img src="/%E4%BA%BA%E7%94%9F/%E5%8D%8E%E5%8C%97%E6%97%A0%E6%B5%AA%E6%BC%AB/%E3%80%8A%E7%94%B5%E5%90%89%E4%BB%96%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B1.0%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%90%89%E4%BB%96%E5%B8%85%E7%85%A7.jpg" class="" title="å‰ä»–å¸…ç…§"><p>å°±ä» B ç«™çš„è§†é¢‘å¼€å§‹å§</p><p><a href="https://www.bilibili.com/video/BV1FT411Z7iu/?spm_id_from=333.337.search-card.all.click&vd_source=d71ed59532fe75ae6e76322af844c014">ã€å®Œæ•´ç‰ˆã€‘å…¨ç½‘æœ€ç®€å•çš„ã€Šç”µå‰ä»–ç³»ç»Ÿæ•™ç¨‹1.0ã€‹é€‚åˆé›¶åŸºç¡€è‡ªå­¦å…¥é—¨_å“”å“©å“”å“©_bilibili</a></p><p>è¿™é‡Œè®°å½•ä¸€äº›åŠ¨ä½œã€çŸ¥è¯†è¦ç‚¹</p><h1 id="W1-EX1-å³æ‰‹ç©ºå¼¦ä¸‹æ‹¨"><a href="#W1-EX1-å³æ‰‹ç©ºå¼¦ä¸‹æ‹¨" class="headerlink" title="W1 EX1 - å³æ‰‹ç©ºå¼¦ä¸‹æ‹¨"></a>W1 EX1 - å³æ‰‹ç©ºå¼¦ä¸‹æ‹¨</h1><p><strong>åŠ¨ä½œè¦ç‚¹</strong></p><ul><li>åå§¿<ul><li>èƒ³è†Šå¤¹ç´å€¾æ–œ</li><li>å¤§è…¿å’Œåœ°é¢å¹³è¡Œ</li><li>ç´å¤´ç•¥å¾®ä¸Šç¿˜</li></ul></li><li>æ‹¨ç‰‡<ul><li>æ­£æ­¥å§¿åŠ¿ï¼Œæ‹‡æŒ‡ã€é£ŸæŒ‡æä½æ‹¨ç‰‡</li><li>ç”¨åŠ›ï¼Œæ‹¨åŠ¨æ—¶æ‹¨ç‰‡ä¸è¦ä¸Šä¸‹æ‘‡æ™ƒ</li></ul></li><li>æŠ¤å¼¦<ul><li>å¤§å°é±¼é™…éƒ½é åœ¨å¼¦ä¸Š</li><li>æ‹¨å¼¦æ—¶æ‰‹ä¸è¦æ‚¬ç©ºï¼Œå¦åˆ™æ²¡æœ‰æŠ¤å¼¦çš„æ•ˆæœ</li></ul></li><li>æ‹¨å¼¦<ul><li>æ‹¨å¼¦ä½ç½®åº”è¯¥ä½äºä¸¤ä¸ªæ‹¾éŸ³å™¨ï¼ˆåŒåŒï¼‰ä¸­é—´</li><li>æ‹¨ç‰‡é¢ä¸ç´å¼¦å¹³è¡Œ</li><li>æ‹¨å¼¦ä½¿ç”¨æ‰‹è…•å‘åŠ›ï¼Œå¤§è‡‚å’Œå°è‡‚ä¸è¦å‘åŠ›ï¼Œå®Œå…¨æ”¾æ¾</li><li>æ‹¨å¼¦æ–¹å‘æ²¿æ‰‹è…•æ–¹å‘ï¼Œç±»ä¼¼é’Ÿæ‘†ä¸Šä¸‹è¿åŠ¨ï¼ˆä¸æ˜¯æ‰­é’¥åŒ™ï¼‰ï¼›å‘ä¸‹æ‹¨è€Œä¸æ˜¯å‘å¤–æ‹¨</li><li>ç»ƒä¹ æ‰‹è…•çš„å‘åŠ›ï¼Œæ‹¨ä¸‹äºŒå¼¦æ—¶ï¼Œæœ€ç»ˆæ‹¨ç‰‡åœåœ¨ä¸€å¼¦ä¸Š</li></ul></li></ul><p><strong>ç»ƒä¹ </strong></p><p>é€Ÿåº¦ 40ï¼Œç¬¬ä¸€æ‹å¼¹å¼¦ï¼Œç¬¬äºŒæ‹åœé¡¿ï¼Œç¬¬ä¸‰æ‹å¼¹å¼¦ï¼Œç¬¬å››æ‹åœé¡¿</p><h1 id="W1-EX2-12-å“éŸ³é«˜æ¨¡å”±"><a href="#W1-EX2-12-å“éŸ³é«˜æ¨¡å”±" class="headerlink" title="W1 EX2 - 12 å“éŸ³é«˜æ¨¡å”±"></a>W1 EX2 - 12 å“éŸ³é«˜æ¨¡å”±</h1><p><strong>çŸ¥è¯†è¦ç‚¹</strong></p><ul><li>é’¢ç´ä¸­ç¬¬ä¸€ä¸ªå…«åº¦ç”¨ <code>C1</code> è¡¨ç¤ºï¼Œé‚£ä¹ˆä¸­éŸ³åŒºçš„å°å­—ä¸€ç»„å°±è¡¨ç¤ºä¸º <code>C4</code></li><li>ä¸€ä¸ªå…«åº¦ä¸­åŒ…å« 12 ä¸ªéŸ³ï¼Œdo\re\sol\la\si ä¸­åŒ…å«å‡é™éŸ³ï¼Œè¢«ç§°ä¸ºå…¨éŸ³ï¼Œmi\fa å’Œ si\do ä¸­æ²¡æœ‰åŠ éŸ³ï¼Œæ‰€ä»¥è¢«æˆä¸ºåŠéŸ³</li><li>å¯¹åº”åœ¨å‰ä»–ä¸­ä¹Ÿä¸€æ ·ï¼Œæ¯ä¸ªå“çº§æ˜¯ä¸€ä¸ªåŠéŸ³<br>ä¾‹å¦‚ï¼šä¸€å¼¦ 12 å“æ˜¯ miï¼Œé‚£ä¹ˆ 13 å“å°±æ˜¯ faï¼Œåè¿‡æ¥é—´éš”ä¸€ä¸ªå“æ˜¯ re</li><li>å‰ä»–ä¸­æ¯æ ¹å¼¦é—´éš”äº”å“ï¼Œæ˜¯ä¸€æ ·çš„éŸ³é«˜ï¼ˆ2ã€3 å¼¦åªé—´éš”å››å“ï¼‰<br>ä¾‹å¦‚ï¼šä¸€å¼¦ 8 å“æ˜¯ doï¼Œé‚£ä¹ˆäºŒå¼¦çš„ 13 å“ä¹Ÿæ˜¯ do</li><li>å‰ä»–ç©ºå¼¦ 1 åˆ° 6 å¼¦åˆ†åˆ«æ˜¯ï¼Œ375263</li></ul><p><strong>åŠ¨ä½œè¦ç‚¹</strong></p><ul><li>æ¯æ¬¡å¼¹å‰éƒ½è¦è°ƒéŸ³</li><li>æŒ‰ä½ 12 å“ï¼Œ12 å“çš„éŸ³å’Œç©ºå¼¦éŸ³ä¸€æ ·ï¼Œä½†æ˜¯ä¼šé«˜å…«åº¦</li><li>æŒ‰å¼¦é è¿‘å“ä¸ï¼ŒæŠŠå¼¦å‹åœ¨å“ä¸ä¸Šï¼Œä¸ç”¨ç‰¹åˆ«ç”¨åŠ›</li><li>æŒ‰åŠ¨ä¸Šé¢å¼¦çš„æ—¶å€™ï¼Œæ‹‡æŒ‡ä½ç½®ä¸å˜ï¼Œæ‰‹è…•éœ€è¦ä¸€ä¸ªè½¬åŠ¨ï¼Œæ›´é«˜åœ°æŒ‰åˆ°ä¸Šæ–¹çš„ç´å¼¦</li><li>æŒ‰å¼¦æŠ¤å¼¦ï¼Œæ‰‹æŒ‡åœ¨æŒ‰åŠ¨ç´å¼¦çš„æ—¶å€™ï¼ŒæŠ¤ä½ä¸Šæ–¹ç´å¼¦ï¼Œä¾‹å¦‚æŒ‰åŠ¨ä¸€å¼¦çš„æ—¶å€™ï¼Œäº’ä½ä¸Šæ–¹çš„äºŒå¼¦ï¼›æ‰‹æŒ‡ä¾§ä¸€ç‚¹æ›´æ–¹ä¾¿æŠ¤å¼¦</li><li>æ‹¨å¼¦æ—¶å”±å‡ºå”±å</li></ul><p><strong>ç»ƒä¹ </strong></p><p>é€Ÿåº¦ 40ï¼ŒèŠ‚å¥å’Œä¸Šé¢ç»ƒä¹ ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯åŠ ä¸Šè¿™æ¬¡å­¦ä¹ å†…å®¹ï¼šæŒ‰å“ + å”±éŸ³</p><p>é¡ºåºæŒ‰ç…§ 1 -&gt; 6 å†å€’è¿‡æ¥ 6 -&gt; 1 å¼¦è¿›è¡Œ</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.bilibili.com/video/BV1FT411Z7iu/?spm_id_from=333.337.search-card.all.click&vd_source=d71ed59532fe75ae6e76322af844c014">ã€å®Œæ•´ç‰ˆã€‘å…¨ç½‘æœ€ç®€å•çš„ã€Šç”µå‰ä»–ç³»ç»Ÿæ•™ç¨‹1.0ã€‹é€‚åˆé›¶åŸºç¡€è‡ªå­¦å…¥é—¨_å“”å“©å“”å“©_bilibili</a></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> ååŒ—æ— æµªæ¼« </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç”µå‰ä»– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP Server-Sent Events ç®€å•ä½¿ç”¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/HTTP%20Server-Sent%20Events%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/HTTP%20Server-Sent%20Events%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="SSE"><a href="#SSE" class="headerlink" title="SSE"></a>SSE</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>Server-Sent Eventsï¼ˆSSEï¼‰æ˜¯ä¸€ç§åŸºäº HTTP çš„æœåŠ¡å™¨æ¨é€æŠ€æœ¯ï¼Œå®ƒå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å®æ—¶å‘é€æ•°æ®</p><p>é€šè¿‡SSEï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚</p><p>SSE å»ºç«‹åœ¨ HTTP åè®®ä¹‹ä¸Šï¼Œä½¿ç”¨äº†é•¿è¿æ¥ï¼ˆæŒä¹…è¿æ¥ï¼‰æ¥å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„å®æ—¶é€šä¿¡</p><p>ä¸ä¼ ç»Ÿçš„è¯·æ±‚-å“åº”æ¨¡å‹ä¸åŒï¼ŒSSE å…è®¸æœåŠ¡å™¨åœ¨äº‹ä»¶å‘ç”Ÿæ—¶ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚è¿™ä½¿å¾—æœåŠ¡å™¨å¯ä»¥å®æ—¶åœ°å‘å®¢æˆ·ç«¯æ¨é€æ›´æ–°çš„ä¿¡æ¯ã€é€šçŸ¥ã€çŠ¶æ€å˜åŒ–ç­‰</p><p>ä¾‹å¦‚ GPT ç­‰ AI çš„é—®ç­”çª—å£ï¼Œå¾€å¾€å°±æ˜¯ç”¨ SSE åè®®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç”¨æˆ·ç­‰å¾…å“åº”çš„æ—¶é—´ï¼›å…¶æ¬¡æ¨¡æ‹Ÿæ‰“å­—æœºç­‰æ•ˆæœä¹Ÿå¯ä»¥å¢å¼ºç”¨æˆ·ä½“éªŒ</p><h2 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h2><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>æ ‡å‡†çš„ HTTP åè®®ä¸­ï¼Œæ¯ä¸ª HTTP å“åº”éƒ½ä¼šåœ¨å‘é€å®Œæ¯•åå…³é—­è¿æ¥ï¼ŒHTTP&#x2F;1.1 åè®®é»˜è®¤é‡‡ç”¨çŸ­è¿æ¥ï¼ˆshort-lived connectionsï¼‰æ–¹å¼</p><p>HTTP å“åº”çš„å¤´éƒ¨ä¸­ä¼šåŒ…å«ä¸€ä¸ª <code>Connection</code> å­—æ®µï¼Œç”¨äºæŒ‡ç¤ºè¿æ¥çš„çŠ¶æ€ï¼Œå½“è¯¥å­—æ®µçš„å€¼ä¸º <code>close</code> æ—¶ï¼Œè¡¨ç¤ºæœåŠ¡å™¨ä¼šåœ¨å‘é€å®Œå“åº”åä¸»åŠ¨å…³é—­è¿æ¥</p><p>ä¹Ÿå¯ä»¥è®¾ç½®ä¸º <code>Keep-Alive</code>ï¼ŒæœåŠ¡å™¨å¯ä»¥è‡ªè¡Œå†³å®šæ˜¯å¦åœ¨æ¯ä¸ªå“åº”åå…³é—­è¿æ¥ï¼Œåœ¨å“åº”ä½“ä¸­åŒæ ·è®¾ç½® <code>Connection</code> ä¸º <code>Keep-Alive</code> å¯ä»¥è®©å®¢æˆ·ç«¯ä¿æŒè¿æ¥</p><p>åŸºäºè¿™ä¸ªæœºåˆ¶å°±å¯ä»¥å®ç°é•¿è½®è¯¢ã€SSE ç­‰æ•ˆæœ</p><h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>WebSocket æ˜¯ä¸€ç§æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ï¼ŒåŒæ ·åŸºäº TCP</p><p>å®ƒæä¾›äº†ä¸€ç§å®æ—¶ã€é«˜æ•ˆçš„åŒå‘é€šä¿¡æœºåˆ¶ï¼Œå…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œè€Œä¸éœ€è¦å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ŒWebSocket åè®®ç›¸å¯¹äºä¼ ç»Ÿçš„ HTTP åè®®æ›´é€‚åˆå®æ—¶é€šä¿¡å’Œå®æ—¶æ›´æ–°çš„åº”ç”¨åœºæ™¯</p><p>WebSocket ä¸æ˜¯ HTTP åè®®ï¼Œä½†æ˜¯éœ€è¦å…ˆä½¿ç”¨ HTTP åè®®è¿›è¡Œåè®®å‡çº§</p><p><strong>å¯¹æ¯”è¡¨æ ¼</strong></p><table><thead><tr><th>åè®®</th><th>é€šä¿¡æ¨¡å¼</th><th>åœºæ™¯</th></tr></thead><tbody><tr><td>HTTP</td><td>å•å‘çŸ­è¿æ¥</td><td>è¯·æ±‚-å“åº”</td></tr><tr><td>HTTP SSE</td><td>å•å‘é•¿è¿æ¥</td><td>æœåŠ¡å™¨æ¨é€</td></tr><tr><td>WebSocket</td><td>åŒå‘é•¿è¿æ¥</td><td>åŒå‘é€šä¿¡</td></tr></tbody></table><h2 id="åè®®ç»†èŠ‚"><a href="#åè®®ç»†èŠ‚" class="headerlink" title="åè®®ç»†èŠ‚"></a>åè®®ç»†èŠ‚</h2><p>è¦è®¢é˜…æœåŠ¡å™¨äº‹ä»¶ï¼Œå®¢æˆ·ç«¯å‘å‡º GET è¯·æ±‚å¸¦æœ‰æŒ‡å®šçš„ headerï¼š</p><ul><li><strong>Accept</strong>ï¼š<code>text/event-stream</code> è¡¨ç¤ºå¯æ¥æ”¶äº‹ä»¶æµç±»å‹</li><li><strong>Cache-Control</strong>ï¼š<code>no-cache</code> ç¦ç”¨ä»»ä½•çš„äº‹ä»¶ç¼“å­˜</li><li><strong>Connection</strong>ï¼š<code>keep-alive</code> è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨æŒä¹…è¿æ¥</li></ul><p>æœåŠ¡å™¨åº”è¯¥ä½¿ç”¨ç›¸åº”çš„å“åº”æ¥ç¡®è®¤è®¢é˜…ï¼š</p><ul><li><strong>Content-Type</strong>ï¼š<code>text/event-stream;charset=UTF-8</code> è¡¨ç¤ºæ ‡å‡†è¦æ±‚çš„äº‹ä»¶çš„åª’ä½“ç±»å‹å’Œç¼–ç </li><li><strong>Transfer-Encoding</strong>ï¼š<code>chunked</code> è¡¨ç¤ºæœåŠ¡å™¨æµå¼ä¼ è¾“åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ï¼Œå› æ­¤å†…å®¹å¤§å°äº‹å…ˆæœªçŸ¥</li><li><strong>Connection</strong>ï¼š<code>keep-alive</code> è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨æŒä¹…è¿æ¥ï¼Œ</li><li><strong>Keep-Alive</strong>ï¼šä¾‹å¦‚ <code>timeout=60</code>ï¼ŒæœåŠ¡ç«¯å‘ŠçŸ¥å®¢æˆ·ç«¯ä¿æŒè¿æ¥çš„æ—¶é•¿</li></ul><hr><p><strong>æ•°æ®å†…å®¹</strong></p><p>äº‹ä»¶ä¹‹é—´ç”±ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš” <code>\n\n</code></p><p>æ¯ä¸ªäº‹ä»¶ç”±ä¸€ä¸ªæˆ–å¤šä¸ª <code>åç§°:å€¼</code> å­—æ®µç»„æˆï¼Œç”±å•ä¸ªæ¢è¡Œç¬¦ <code>\n</code> åˆ†éš”</p><p><code>comment</code> å±æ€§åˆ™åªä¼šæœ‰ <code>:å€¼</code>ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®ç‰¹å¾åˆ¤æ–­</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">id:<span class="keyword">this</span> <span class="keyword">is</span> id</span><br><span class="line">event:<span class="keyword">this</span> <span class="keyword">is</span> event name</span><br><span class="line">:<span class="keyword">this</span> <span class="keyword">is</span> comment</span><br><span class="line"><span class="keyword">data</span>:<span class="keyword">this</span> <span class="keyword">is</span> <span class="keyword">data</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">id:<span class="keyword">this</span> <span class="keyword">is</span> id</span><br><span class="line">event:<span class="keyword">this</span> <span class="keyword">is</span> event name</span><br><span class="line">:<span class="keyword">this</span> <span class="keyword">is</span> comment</span><br><span class="line"><span class="keyword">data</span>:<span class="keyword">this</span> <span class="keyword">is</span> <span class="keyword">data</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><h1 id="ç®€å•å®ç°"><a href="#ç®€å•å®ç°" class="headerlink" title="ç®€å•å®ç°"></a>ç®€å•å®ç°</h1><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><p>ä½¿ç”¨ Spring å®ç°ä¸€ä¸ª SSE æ¥å£ï¼ŒSpring MVC å·²ç»æä¾›äº†å¯¹ SSE çš„æ”¯æŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSEController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SSEService sseService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sse&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">streamEvents</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> sseService.giveMeASentence();</span><br><span class="line">            Stream.of(sentence.split(<span class="string">&quot;&quot;</span>)).forEach(c -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emitter.send(SseEmitter.event().data(String.valueOf(c)));</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(RandomUtil.randomInt(<span class="number">30</span>, <span class="number">100</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    emitter.completeWithError(e);</span><br><span class="line">                    log.error(<span class="string">&quot;SSE error&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            emitter.complete();</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬æ­¥éª¤ï¼š</p><ol><li>ä½¿ç”¨ <code>@RestController</code> æ³¨è§£åˆ›å»ºä¸€ä¸ª Controller</li><li>REST æ–¹æ³•è¿”å›ä¸€ä¸ª <code>SseEmitter</code>ï¼Œå¤„ç† GET è¯·æ±‚å¹¶äº§ç”Ÿæ–‡æœ¬&#x2F;äº‹ä»¶æµ <code>text/event-stream</code></li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>SseEmitter</code>ï¼Œä¿å­˜å®ƒå¹¶ä»æ–¹æ³•ä¸­è¿”å›</li><li>å¼‚æ­¥çº¿ç¨‹æ“ä½œ <code>SseEmitter</code>ï¼Œå®ç°æœåŠ¡ç«¯çš„å¤šæ¬¡å“åº”å’Œå¯¹è¿æ¥çš„å…³é—­</li></ol><p>è¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿæ‰“å­—æœºæ•ˆæœï¼Œæ“ä½œ <code>SseEmitter</code> æ—¶åšäº†ä¸€ä¸ª sleep æ“ä½œï¼Œè·å–æ–‡æ¡ˆåæ‹†åˆ†è°ƒç”¨ <code>SseEmitter</code>ï¼Œå“åº”å®Œæˆåå…³é—­è¿æ¥</p><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p><code>SSEService</code> ä¸»è¦æ˜¯æä¾›ä¸€æ®µæ–‡æ¡ˆï¼Œè¿™ä¸ªä¸é‡è¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSEService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; SENTENCES = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;æˆåŠŸä¸æ˜¯æœ€ç»ˆçš„ï¼Œå¤±è´¥ä¸æ˜¯è‡´å‘½çš„ï¼Œå‹‡æ°”ç»§ç»­å‰è¿›æ‰æ˜¯æœ€é‡è¦çš„ã€‚ â€”â€”â€”â€” ä¸˜å‰å°”&quot;</span>);</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;ç”Ÿæ´»å°±åƒéª‘è‡ªè¡Œè½¦ï¼Œä½ å¿…é¡»ä¿æŒå‰è¿›æ‰èƒ½ä¿æŒå¹³è¡¡ã€‚ â€”â€”â€”â€” çˆ±å› æ–¯å¦&quot;</span>);</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;æˆåŠŸçš„å…³é”®æ˜¯æŠŠæ¡æœºä¼šçš„èƒ½åŠ› â€”â€”â€”â€” çˆ±è¿ªç”Ÿ&quot;</span>);</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;ä¸ç®¡ä½ èµ°äº†å¤šè¿œï¼Œå†³å®šè½¬èº«æ€»æ˜¯ä½ è‡ªå·± â€”â€”â€”â€” é©¬ä¸Â·è·¯å¾·Â·é‡‘&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">giveMeASentence</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SENTENCES.get(RandomUtil.randomInt(SENTENCES.size()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><p>æ¯”å¦‚å‰ç«¯ç­‰ï¼Œå¯ä»¥åˆ¶ä½œå‡ºæ‰“å­—æœºçš„æ•ˆæœ</p><p>è¿™é‡Œç®€å•ä½¿ç”¨ Java çš„ <code>print</code> æ“ä½œæ¥æ¨¡æ‹Ÿå‡ºè¿™ç§æ•ˆæœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSEClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// SSE æ¥å£çš„ URL</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sseUrl</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/sse&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º URL å¯¹è±¡</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(sseUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å¼€ HTTP è¿æ¥</span></span><br><span class="line">        <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º GET</span></span><br><span class="line">        connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">        connection.setRequestProperty(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€è¯·æ±‚</span></span><br><span class="line">        connection.connect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥å“åº”ç </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">responseCode</span> <span class="operator">=</span> connection.getResponseCode();</span><br><span class="line">        <span class="keyword">if</span> (responseCode == HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">            <span class="comment">// ä»è¿æ¥ä¸­è·å–è¾“å…¥æµ</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(connection.getInputStream()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯»å– SSE äº‹ä»¶æ•°æ®</span></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç† SSE äº‹ä»¶æ•°æ®</span></span><br><span class="line">                <span class="keyword">if</span> (line.length() &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">eventData</span> <span class="operator">=</span> line.substring(<span class="number">5</span>).trim();</span><br><span class="line">                System.out.print(eventData);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å…³é—­è¾“å…¥æµ</span></span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Failed to connect to SSE endpoint. Response code: &quot;</span> + responseCode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–­å¼€è¿æ¥</span></span><br><span class="line">        connection.disconnect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><img src="/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/HTTP%20Server-Sent%20Events%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/%E5%8A%A8%E7%94%BB.gif" class="" title="åŠ¨ç”»"><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/444011262?utm_id=0">SSEï¼ˆServer-Send Eventsï¼‰å®æˆ˜ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è§„åˆ™å¼•æ“ç®€å•ä»‹ç»</title>
      <link href="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D.html"/>
      <url>/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><blockquote><p>å¦‚æœä½ ä¸€ç›´åœ¨å¼€å‘ä¸€ç§äº§å“æˆ–ä¸šåŠ¡ï¼Œé‚£ä¹ˆç»å¸¸å‘ç”Ÿçš„åœºæ™¯å°±æ˜¯ä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ï¼›å¼€å‘äººå‘˜åŸºäºä¸€ç»„æ¡ä»¶æ„å»ºè§£å†³æ–¹æ¡ˆï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™äº›é€»è¾‘æ¡ä»¶å¯èƒ½ä¼šå› ä¸šåŠ¡éœ€æ±‚æˆ–å…¶ä»–å¤–éƒ¨å¸‚åœºå› ç´ çš„å˜åŒ–è€Œå‘ç”Ÿæ”¹å˜</p><p>è§„åˆ™å¼•æ“æ˜¯è§£å†³æ­¤ç±»é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•</p><p><a href="https://www.mohitkhare.com/blog/guide-to-rule-engines/">Guide to Rule Engines â€“ Mohit Khare</a></p><p>ç¾å›¢å¤–å–çš„ CRM ä¸šåŠ¡æ­¥å…¥æˆç†ŸæœŸï¼Œè§„åˆ™ç±»éœ€æ±‚å‡ ä¹æ’‘èµ·äº†è¿™ä¸ªä¸šåŠ¡æ‰€æœ‰éœ€æ±‚çš„åŠè¾¹å¤©ï¼›ä¸€æ–¹é¢è§„åˆ™å”¯ä¸€ä¸å˜çš„æ˜¯ â€œå¤šå˜â€ï¼Œå¦ä¸€æ–¹é¢å¼€å‘å›¢é˜Ÿå¯¹ â€œè§„åˆ™å¼€å‘â€ çš„æ„Ÿå—æ˜¯ä¹å‘³ã€ç–²æƒ«å’Œç¼ºä¹æŠ€æœ¯å«é‡</p><p>å¦‚ä½•è§£å†³è§„åˆ™å¼€å‘çš„æ•ˆç‡é—®é¢˜ï¼Œæœ€å¤§åŒ–è§£æ”¾å¼€å‘å›¢é˜Ÿæˆä¸ºç›®å‰çš„ä¸€ä¸ª KPI</p><p><a href="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a></p></blockquote><h2 id="ä»€ä¹ˆæ˜¯è§„åˆ™å¼•æ“"><a href="#ä»€ä¹ˆæ˜¯è§„åˆ™å¼•æ“" class="headerlink" title="ä»€ä¹ˆæ˜¯è§„åˆ™å¼•æ“"></a>ä»€ä¹ˆæ˜¯è§„åˆ™å¼•æ“</h2><p>ä¸šåŠ¡è§„åˆ™å¼•æ“æ˜¯åœ¨æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªä¸šåŠ¡è§„åˆ™çš„ç³»ç»Ÿï¼Œè¿™äº›è§„å®šå¯èƒ½æ¥è‡ªå„ç§ä¸šåŠ¡è§„åˆ™ï¼š</p><ul><li>å‘˜å·¥å¯ä»¥å› ä»»ä½•åŸå› æˆ–æ— åŸå› è¢«è§£é›‡ï¼Œä½†ä¸èƒ½å› éæ³•åŸå› </li><li>æ‰€æœ‰ä¸€æ¬¡æ€§æ¶ˆè´¹è¶…è¿‡ 100 ç¾å…ƒçš„å®¢æˆ·éƒ½å°†è·å¾— 10% çš„æŠ˜æ‰£</li></ul><p>ä¸šåŠ¡è§„åˆ™ç³»ç»Ÿä½¿è¿™äº›å€¾å‘äºè¿è¥å†³ç­–ã€å…¬å¸ç­–ç•¥çš„è§„åˆ™èƒ½å¤Ÿä¸åº”ç”¨ç¨‹åºä»£ç åˆ†å¼€å®šä¹‰ã€æµ‹è¯•ã€æ‰§è¡Œå’Œç»´æŠ¤ï¼›è§„åˆ™é›†ç”¨äºæ£€æŸ¥æ¡ä»¶å¹¶é€‰æ‹©åˆé€‚çš„ä¸šåŠ¡æ‰§è¡Œæ“ä½œ</p><p>è§„åˆ™å¯ä»¥ç®€å•æŠ½è±¡ä¸ºå¦‚ä¸‹ç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">When</span><br><span class="line">   &lt;Condition is <span class="literal">true</span>&gt;</span><br><span class="line">Then</span><br><span class="line">   &lt;Take desired Action&gt;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ä¸€ä¸ªæä¾›æŠ˜æ‰£ä¼˜æƒ çš„è§„åˆ™</p><p><strong>æ¡ä»¶ï¼š</strong>å½“ç”¨æˆ·æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶</p><ul><li>è‡³å°‘ä¸‹å•è¿‡ 10 ä¸ªè®¢å•</li><li>å¹³å‡è®¢å•ä»·æ ¼å¤§äº 150 å…ƒ</li><li>ç”¨æˆ·å¹´é¾„åœ¨ 20 ~ 30</li></ul><p><strong>è¡Œä¸ºï¼š</strong>æä¾› 20% çš„æŠ˜æ‰£</p><p>è§„åˆ™å¼•æ“åœ¨è§£å†³é¢å‘ä¸šåŠ¡çš„é€»è¾‘æ—¶æ¯”è¾ƒæœ‰æ•ˆï¼Œè¿™äº›é€»è¾‘ä½¿ç”¨è®¸å¤šä¸šåŠ¡å±æ€§æ¥äº§ç”ŸæŸç§å†³ç­–</p><p>éš¾é“æˆ‘ä»¬ä¸èƒ½æŠŠè¿™ä¸ªé€»è¾‘åµŒå…¥æˆ‘ä»¬çš„ä»£ç ä¸­å—ï¼Ÿå¯ä»¥è¿™æ ·åšï¼Œä½†è§„åˆ™åŒ–æä¾›äº†ä¿®æ”¹æ¡ä»¶å’Œæ·»åŠ æ›´å¤šé€»è¾‘çš„çµæ´»æ€§ï¼›è¿™äº›æ¡ä»¶ä¹Ÿè®¸æ›´å¤šæ¥ç”±äº§å“æˆ–ä¸šåŠ¡äº§å‡ºï¼Œè¿™ä¼šè®©å®ƒä»¬æ›´åŠ å®¹æ˜“å˜æ›´ï¼Œä¹Ÿè®¸ä¸éœ€è¦ç”±å¼€å‘äººå‘˜è¿›è¡Œä¿®æ”¹</p><h2 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h2><p><a href="https://github.com/hyperjumptech/grule-rule-engine#advantages-of-a-rule-engine">grule-rule-engine: Rule engine implementation in Golang Advantages of a Rule Engine</a></p><ul><li><strong>å£°æ˜å¼ç¼–ç¨‹</strong>ï¼ˆDeclarative Programmingï¼‰ï¼šè§„åˆ™å¯ä»¥å¾ˆå®¹æ˜“åœ°è¡¨è¾¾éš¾é¢˜çš„è§£å†³æ–¹æ¡ˆå¹¶è¿›è¡ŒéªŒè¯ï¼›ä¸ä»£ç ä¸åŒï¼Œè§„åˆ™æ˜¯ç”¨ä¸é‚£ä¹ˆå¤æ‚çš„è¯­è¨€ç¼–å†™çš„ï¼›ä¸šåŠ¡åˆ†æå¸ˆå¯ä»¥å¾ˆå®¹æ˜“åœ°é˜…è¯»å’ŒéªŒè¯ä¸€å¥—è§„åˆ™</li><li><strong>é€»è¾‘å’Œæ•°æ®åˆ†ç¦»</strong>ï¼ˆLogic and Data Separationï¼‰ï¼šæ•°æ®é©»ç•™åœ¨åŸŸå¯¹è±¡ä¸­ï¼ˆDomain Objectsï¼‰ï¼Œä¸šåŠ¡é€»è¾‘é©»ç•™åœ¨è§„åˆ™ä¸­ï¼ˆRulesï¼‰ï¼›æ ¹æ®é¡¹ç›®çš„ç±»å‹ï¼Œè¿™ç§åˆ†ç¦»å¯èƒ½éå¸¸æœ‰åˆ©</li><li><strong>çŸ¥è¯†é›†ä¸­åŒ–</strong>ï¼ˆCentralization of Knowledgeï¼‰ï¼šé€šè¿‡ä½¿ç”¨è§„åˆ™ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œçš„çŸ¥è¯†åº“ï¼ˆa repository of knowledge | a knowledge baseï¼‰ï¼›è¿™æ˜¯å•†ä¸šæ”¿ç­–çš„å”¯ä¸€çœŸç†ï¼›ç†æƒ³æƒ…å†µä¸‹è§„åˆ™æ˜¯å¯è¯»çš„ï¼Œå› æ­¤å®ƒä»¬ä¹Ÿå¯ä»¥ä½œä¸ºæ–‡æ¡£</li><li><strong>æ”¹å˜çš„æ•æ·æ€§</strong>ï¼ˆAgility To Changeï¼‰ï¼šç”±äºä¸šåŠ¡è§„åˆ™å®é™…ä¸Šè¢«è§†ä¸ºæ•°æ®ï¼Œæ ¹æ®ä¸šåŠ¡çš„åŠ¨æ€æ€§è´¨è°ƒæ•´è§„åˆ™å˜å¾—å¾®ä¸è¶³é“ï¼›ä¸éœ€è¦åƒæ­£å¸¸çš„è½¯ä»¶å¼€å‘é‚£æ ·é‡æ–°æ„å»ºä»£ç æˆ–éƒ¨ç½²ï¼Œåªéœ€è¦æ¨å‡ºè§„åˆ™é›†å¹¶å°†å…¶åº”ç”¨äºçŸ¥è¯†åº“å³å¯</li></ul><h2 id="ä½¿ç”¨æ¡ˆä¾‹"><a href="#ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="ä½¿ç”¨æ¡ˆä¾‹"></a>ä½¿ç”¨æ¡ˆä¾‹</h2><p><a href="https://github.com/hyperjumptech/grule-rule-engine#use-cases">grule-rule-engine: Rule engine implementation in Golang use-cases</a></p><p>ä½¿ç”¨è§„åˆ™å¼•æ“å¯ä»¥æ›´å¥½åœ°è§£å†³ä»¥ä¸‹æƒ…å†µï¼š</p><ul><li><strong>ä¸“å®¶ç³»ç»Ÿ</strong>ï¼ˆExpert Systemï¼‰ï¼šå¿…é¡»è¯„ä¼°äº‹å®ä»¥æä¾›æŸç§ç°å®ä¸–ç•Œçš„ç»“è®ºï¼›å¦‚æœä¸ä½¿ç”¨ RETE é£æ ¼çš„è§„åˆ™å¼•æ“ï¼Œå°±ä¼šç¼–å†™ä¸€ç»„ If&#x2F;else è¯­å¥çš„çº§è”é›†ï¼Œè€Œå¦‚ä½•è¯„ä¼°è¿™äº›è¯­å¥çš„ç»„åˆçš„æ’åˆ—å°†å¾ˆå¿«å˜å¾—æ— æ³•ç®¡ç†</li><li><strong>è¯„çº§ç³»ç»Ÿ</strong>ï¼ˆRating Systemï¼‰ï¼šä¾‹å¦‚é“¶è¡Œç³»ç»Ÿå¯èƒ½å¸Œæœ›æ ¹æ®å®¢æˆ·çš„äº¤æ˜“è®°å½•ï¼ˆäº‹å®ï¼‰ä¸ºæ¯ä¸ªå®¢æˆ·åˆ›å»ºä¸€ä¸ª â€œåˆ†æ•°â€ï¼›æˆ‘ä»¬å¯ä»¥æ ¹æ®ä»–ä»¬ä¸é“¶è¡Œäº’åŠ¨çš„é¢‘ç‡ã€è¿›å‡ºèµ„é‡‘çš„å¤šå°‘ã€æ”¯ä»˜è´¦å•çš„é€Ÿåº¦ã€ç´¯è®¡åˆ©æ¯çš„å¤šå°‘ã€ä¸ºè‡ªå·±æˆ–é“¶è¡Œèµšäº†å¤šå°‘ç­‰ç­‰æ¥æŸ¥çœ‹ä»–ä»¬çš„åˆ†æ•°å˜åŒ–ï¼Œéšåé“¶è¡Œå®¢æˆ·åˆ†æéƒ¨é—¨çš„ä¸“å®¶å¯ä»¥æ¥æä¾›äº‹å®å’Œè§„åˆ™çš„è¯´æ˜</li><li><strong>ç”µè„‘æ¸¸æˆ</strong>ï¼šç©å®¶çŠ¶æ€ã€å¥–åŠ±ã€æƒ©ç½šã€ä¼¤å®³ã€åˆ†æ•°å’Œæ¦‚ç‡ç³»ç»Ÿæ˜¯è§„åˆ™åœ¨å¤§å¤šæ•°ç”µè„‘æ¸¸æˆä¸­å‘æŒ¥é‡è¦ä½œç”¨çš„è®¸å¤šä¸åŒä¾‹å­</li><li><strong>åˆ†ç±»ç³»ç»Ÿ</strong>ï¼ˆClassification Systemsï¼‰ï¼šä½¿ç”¨è§„åˆ™å¼•æ“ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ä¿¡ç”¨èµ„æ ¼ã€ç”Ÿç‰©åŒ–å­¦è¯†åˆ«ã€ä¿é™©äº§å“é£é™©è¯„ä¼°ã€æ½œåœ¨å®‰å…¨å¨èƒç­‰è¿›è¡Œåˆ†ç±»</li><li><strong>å»ºè®®ç³»ç»Ÿ</strong>ï¼ˆSuggestion Systemï¼‰ï¼šâ€œè§„åˆ™â€ åªæ˜¯å¦ä¸€ç§æ•°æ®ï¼Œè¿™ä½¿å®ƒå¯ä»¥æˆä¸ºå¦ä¸€ä¸ªç¨‹åºçš„äº§å‡ºï¼›è¿™ä¸ªç¨‹åºå¯ä»¥æ˜¯å¦ä¸€ä¸ªä¸“å®¶ç³»ç»Ÿæˆ–äººå·¥æ™ºèƒ½ï¼Œè§„åˆ™å¯ä»¥ç”±å…¶ä»–ç³»ç»Ÿæ“çºµä»¥ä¾¿å¤„ç†å…³äºè§„åˆ™é›†é’ˆå¯¹ä¸šåŠ¡åŸŸæ–°å»ºæ¨¡å‹æ¥å¤„ç†æ–°çš„äº‹å®</li></ul><p>è¿˜æœ‰è®¸å¤šå…¶ä»–ç”¨ä¾‹å°†å—ç›Šäºè§„åˆ™å¼•æ“çš„ä½¿ç”¨ï¼Œä¸Šè¿°æƒ…å†µåªæ˜¯æ½œåœ¨æƒ…å†µä¸­çš„ä¸€å°éƒ¨åˆ†</p><p>ä¸è¿‡è§„åˆ™å¼•æ“å½“ç„¶ä¸æ˜¯é“¶å¼¹ï¼Œå­˜åœ¨è®¸å¤šæ›¿ä»£æ–¹æ¡ˆæ¥è§£å†³è½¯ä»¶ä¸­çš„ â€œçŸ¥è¯†â€ é—®é¢˜ï¼Œå¹¶ä¸”åº”è¯¥åœ¨æœ€åˆé€‚çš„åœ°æ–¹ä½¿ç”¨è¿™äº›æ›¿ä»£æ–¹æ¡ˆï¼›ä¾‹å¦‚å¦‚æœä¸€ä¸ªç®€å•çš„ if&#x2F;else åˆ†æ”¯å°±è¶³å¤Ÿäº†ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ä½¿ç”¨è§„åˆ™å¼•æ“</p><p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šä¸€äº›è§„åˆ™å¼•æ“å®ç°éå¸¸æ˜‚è´µï¼Œä½†è®¸å¤šä¼ä¸šä»ä¸­è·å¾—äº†å¦‚æ­¤å¤šçš„ä»·å€¼ï¼Œä»¥è‡³äºè¿è¡Œå®ƒä»¬çš„æˆæœ¬å¾ˆå®¹æ˜“è¢«è¿™äº›ä»·å€¼æ‰€æŠµæ¶ˆï¼›å¯¹äºå³ä½¿æ˜¯ä¸­ç­‰å¤æ‚çš„åœºæ™¯ï¼Œå¼ºå¤§çš„è§„åˆ™å¼•æ“å¯¹äºè§£è€¦å›¢é˜Ÿå¹¶è§£å†³ä¸šåŠ¡å¤æ‚æ€§ä¹Ÿæœ‰æ˜¾è‘—çš„ä¼˜åŠ¿</p><div STYLE="page-break-after: always;"></div><h2 id="å¼€æºç”Ÿæ€"><a href="#å¼€æºç”Ÿæ€" class="headerlink" title="å¼€æºç”Ÿæ€"></a>å¼€æºç”Ÿæ€</h2><h3 id="Drools"><a href="#Drools" class="headerlink" title="Drools"></a>Drools</h3><p><a href="https://www.drools.org/learn/documentation.html">Drools - Documentation</a><br>Drools ä½¿ç”¨åŸºäºè§„åˆ™çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå…è®¸å¼€å‘äººå‘˜é€šè¿‡ç¼–å†™è§„åˆ™æ¥æè¿°åº”ç”¨ç¨‹åºä¸­çš„ä¸šåŠ¡é€»è¾‘</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><strong>åŸºäºè§„åˆ™çš„ç¼–ç¨‹æ¨¡å‹</strong>ï¼šDrools ä½¿ç”¨è§„åˆ™å¼•æ“æ¥ç¼–å†™ä¸šåŠ¡è§„åˆ™ï¼Œå…è®¸å¼€å‘äººå‘˜å°†ä¸šåŠ¡é€»è¾‘ä»åº”ç”¨ç¨‹åºä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä½¿å…¶æ›´åŠ çµæ´»å’Œæ˜“äºç»´æŠ¤</li><li><strong>æ”¯æŒå¤šç§è§„åˆ™æ ¼å¼</strong>ï¼šåŒ…æ‹¬ <strong>DRL</strong>ï¼ˆ<em>Drools è§„åˆ™è¯­æ³•</em>  | Drools Rule Languageï¼‰ã€<strong>DSL</strong>ï¼ˆ<em>é¢†åŸŸç‰¹å®šè¯­æ³•</em> | Domain Specific Languageï¼‰ï¼Œæ”¯æŒ OMG^1^ æ ‡å‡†ä¸‹çš„ <strong>DMN</strong>ï¼ˆ<em>å†³ç­–æ¨¡å‹ä¸ç¬¦å·</em> | Decision Model and Notationï¼‰  ï¼Œç”šè‡³æ•°æ®é¢†åŸŸ DMG^2^ æ ‡å‡†çš„ <strong>PMML</strong>ï¼ˆ<em>é¢„æµ‹æ¨¡å‹æ ‡è®°è¯­è¨€</em> | Predictive Model Markup Languageï¼‰</li><li><strong>å¤šè¯­è¨€æ”¯æŒ</strong>ï¼šDrools ä¸ä»…æ”¯æŒ Java è¯­è¨€ï¼Œè¿˜æ”¯æŒå…¶ä»–ç¼–ç¨‹è¯­è¨€å¦‚ Python ç­‰</li><li><strong>å®Œå–„çš„ç”Ÿæ€</strong>ï¼šDrools ä¸‹ç”Ÿæ€ä¸°å¯Œï¼Œæ¶‰åŠå¤šç§å·¥å…·<ul><li><strong>Drools Engine</strong>ï¼šæ ¸å¿ƒ Drools è§„åˆ™å¼•æ“</li><li><strong>Drools and jBPM integration</strong>ï¼šè§„åˆ™å¼•æ“ Drools å’Œå·¥ä½œæµ jBPM æ•´åˆ</li><li><strong>Business Central Workbench^3^</strong>ï¼šå¯è§†åŒ–å·¥ä½œå°</li><li><strong>KIE Execution Server</strong>ï¼šå¯ç”¨äºä½¿ç”¨ RESTã€JMS æˆ– Java æ¥å£è¿œç¨‹æ‰§è¡Œè§„åˆ™çš„ç‹¬ç«‹æ‰§è¡ŒæœåŠ¡å™¨</li></ul></li><li><strong>è§„åˆ™æ’ä»¶</strong>ï¼šDRL è§„åˆ™æ–‡ä»¶æ’ä»¶é«˜äº®</li></ul><hr><p>ç¼ºç‚¹ï¼š</p><blockquote><p><em>å¼€æº Drools ä»å…¥é—¨åˆ°æ”¾å¼ƒ</em><br>                                    â€”â€”ã€Š<a href="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a>ã€‹</p></blockquote><ul><li>ä¸šåŠ¡åˆ†æå¸ˆæ— æ³•ç‹¬ç«‹å®Œæˆè§„åˆ™é…ç½®ï¼šç”±äºè§„åˆ™ä¸»ä½“ DSL æ˜¯ç¼–ç¨‹è¯­è¨€ï¼ˆæ”¯æŒ Java, Groovy, Python ç­‰ï¼‰ï¼Œå› æ­¤ä»ç„¶éœ€è¦å¼€å‘å·¥ç¨‹å¸ˆç»´æŠ¤</li><li>è§„åˆ™è§„æ¨¡å˜å¤§ä»¥åä¹Ÿä¼šå˜å¾—ä¸å¥½ç»´æŠ¤ï¼Œç›¸å¯¹ç¡¬ç¼–ç çš„ä¼˜åŠ¿ä¾¿ä¸å¤å­˜åœ¨</li><li>è§„åˆ™çš„è¯­æ³•ä»…é€‚åˆæ‰å¹³çš„è§„åˆ™ï¼Œå¯¹äºåµŒå¥—æ¡ä»¶è¯­ä¹‰ï¼ˆ<code>then</code> ä¸­åµŒå¥— <code>whenthen</code> å­å¥ï¼‰çš„è§„åˆ™åªèƒ½å°†æ¡ä»¶è¿›è¡Œç¬›å¡å°”ç§¯ç»„åˆä»¥åè¿›è¡Œé…ç½®ï¼Œä¸åˆ©äºç»´æŠ¤</li></ul><p>å¤‡æ³¨</p><blockquote><ol><li><p>OMG æ˜¯Object Management Groupçš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªå›½é™…æ€§çš„æŠ€æœ¯æ ‡å‡†ç»„ç»‡ï¼Œæˆç«‹äº 1989 å¹´ï¼Œæ€»éƒ¨ä½äºç¾å›½é©¬è¨è¯¸å¡å·çš„ Needhamã€‚OMG çš„æˆå‘˜åŒ…æ‹¬è½¯ä»¶å’Œç¡¬ä»¶ä¾›åº”å•†ã€å·¥å…·æä¾›å•†ã€æœåŠ¡æä¾›å•†ã€ä¼ä¸šå’Œæ”¿åºœæœºæ„ç­‰ï¼Œæ—¨åœ¨æ¨åŠ¨å’Œåˆ¶å®šé¢å‘å¯¹è±¡æŠ€æœ¯çš„æ ‡å‡†å’Œè§„èŒƒ<br><a href="https://www.omg.org/spec/DMN">About the Decision Model and Notation Specification Version 1.4 (omg.org)</a></p></li><li><p>Data Mining Groupï¼ˆDMGï¼‰æ˜¯ä¸€ä¸ªéè¥åˆ©æ€§ç»„ç»‡ï¼Œæˆç«‹äº 1994 å¹´ï¼Œæ—¨åœ¨æ¨åŠ¨æ•°æ®æŒ–æ˜å’ŒçŸ¥è¯†å‘ç°æŠ€æœ¯çš„å‘å±•å’Œåº”ç”¨ã€‚DMG çš„æˆå‘˜åŒ…æ‹¬æ•°æ®æŒ–æ˜å’Œæœºå™¨å­¦ä¹ é¢†åŸŸçš„ä¸“å®¶ã€å­¦è€…å’Œå·¥ä¸šç•Œä»£è¡¨ï¼Œè‡´åŠ›äºåˆ¶å®šå’Œæ¨å¹¿æ•°æ®æŒ–æ˜æ ‡å‡†å’Œè§„èŒƒ</p></li><li><p>Business Central Workbench GUI</p></li></ol><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230625034858176.png" class="" title="image-20230625034858176"></blockquote><h3 id="LiteFlow"><a href="#LiteFlow" class="headerlink" title="LiteFlow"></a>LiteFlow</h3><p><a href="https://liteflow.yomahub.com/">LiteFlow (yomahub.com)</a></p><p>å¯ä»¥å°†ç€‘å¸ƒæµå¼çš„ä»£ç ï¼Œè½¬å˜æˆä»¥ç»„ä»¶ä¸ºæ ¸å¿ƒæ¦‚å¿µçš„ä»£ç ç»“æ„ï¼Œè¿™ç§ç»“æ„çš„å¥½å¤„æ˜¯å¯ä»¥ä»»æ„ç¼–æ’ï¼Œç»„ä»¶ä¸ç»„ä»¶ä¹‹é—´æ˜¯è§£è€¦çš„ï¼Œç»„ä»¶å¯ä»¥ç”¨è„šæœ¬æ¥å®šä¹‰ï¼Œç»„ä»¶ä¹‹é—´çš„æµè½¬å…¨é è§„åˆ™æ¥é©±åŠ¨</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><strong>è¯­æ³•ç®€å•</strong>ï¼šç»„ä»¶ç”± Javaï¼ˆç¡¬ç¼–ç ï¼‰æˆ–æ”¯æŒçš„è„šæœ¬è¯­è¨€è¿›è¡Œå¼€å‘ï¼Œè§„åˆ™ DSL è¯­æ³•å®šä¹‰ç®€å•ï¼Œç¬¦åˆ Spring ç­‰ IOC æ¡†æ¶çš„å®¹å™¨æ€æƒ³ï¼Œæ˜“äºç†è§£</li><li><strong>æµç¨‹å›¾å¼ç¼–æ’</strong>ï¼šè§„åˆ™æè¿°ä½¿ç”¨æµç¨‹å›¾æ¨¡å¼ï¼Œè€Œä¸æ˜¯ Drools çš„ <code>when...then</code> æ¨¡å¼ï¼Œè®©ç‰¹å®šæµç¨‹çš„ä»»åŠ¡ç¼–æ’æ›´åŠ æ¸…æ™°ã€çµæ´»</li><li><strong>å¹¶å‘ç¼–æ’</strong>ï¼šè§„åˆ™é€»è¾‘å¯ä»¥å¿«é€Ÿç¼–æ’ç»„ä»¶ä¹‹é—´çš„åŒæ­¥ã€å¼‚æ­¥å…³ç³»ï¼Œå¯ä»¥è‡ªå®šä¹‰æ‰§è¡Œçº¿ç¨‹æ± </li><li><strong>ä¸°å¯Œçš„è„šæœ¬ç»„ä»¶æ”¯æŒ</strong>ï¼šæ”¯æŒå¤šç§è„šæœ¬è¯­è¨€ï¼ˆGroovyï¼ŒJavascriptï¼ŒQLExpressï¼ŒPythonï¼ŒLuaï¼ŒAviatorï¼‰ï¼›é‡‡ç”¨ SPI æœºåˆ¶è¿›è¡Œé€‰æ‹©è„šæœ¬æ¡†æ¶æ¥åŠ¨æ€ç¼–è¯‘è„šæœ¬ï¼›åŒæ—¶æ”¯æŒè§„åˆ™æ–‡ä»¶å†…å¤šè„šæœ¬è¯­è¨€æ··åˆä½¿ç”¨</li><li><strong>å¤šæ•°æ®æºå’Œçƒ­åˆ·æ–°</strong>ï¼šEL è§„åˆ™å’Œè„šæœ¬ç»„ä»¶éƒ½æ”¯æŒå¤šç§æ•°æ®æºï¼ˆé¡¹ç›®å†…æ–‡ä»¶ã€æœ¬åœ°æ–‡ä»¶ã€ZKã€SQLã€Nacosã€Apollo ç­‰æ•°æ®æºï¼‰ï¼ŒåŒæ—¶æ”¯æŒè‡ªå®šä¹‰å®ç°ç›¸å…³è§„åˆ™è§£æç±» <code>ClassXmlFlowELParser</code> ç­‰ï¼›æ”¯æŒå¹³æ»‘çƒ­åˆ·æ–°</li><li><strong>è¡¥å……åŠŸèƒ½ä¸°å¯Œ</strong>ï¼šæœ‰ä¸°å¯Œçš„å°åŠŸèƒ½æ”¯æŒ<ul><li>å£°æ˜å¼ç»„ä»¶</li><li>å‰ç½®ã€åç½®ç»„ä»¶ã€ç»„ä»¶åˆ‡é¢</li><li>ç»„ä»¶é‡è¯•</li><li>å¼‚å¸¸ã€æ­¥éª¤ä¿¡æ¯æ±‡æ€»</li></ul></li><li><strong>è§„åˆ™æ’ä»¶</strong>ï¼šåŒæ ·æ‹¥æœ‰è§„åˆ™é«˜äº®æ’ä»¶æ”¯æŒï¼Œä¹Ÿæ”¯æŒè„šæœ¬è¯­æ³•é«˜äº®</li></ul><p>å®˜æ–¹ä»‹ç»ï¼š<a href="%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E.assets/LiteFlowPPT.pptx" title="LiteFLow ä»‹ç» PPT">LiteFLow ä»‹ç» PPT</a></p><hr><p>ç¼ºç‚¹ï¼š</p><ul><li>ç¼ºä¹å¤§èŒƒå›´ç”Ÿäº§è€ƒéªŒï¼Œç¤¾åŒºè¿­ä»£é€Ÿåº¦å’Œæˆç†Ÿäº§å“ç›¸æ¯”è¾ƒæ…¢</li><li>æµç¨‹å›¾å¼ç¼–æ’ä½¿ç»„ä»¶è§„åˆ™è°ƒæ•´éœ€è¦è€ƒè™‘å‰åå…³ç³»</li><li>ç”Ÿæ€ä¸å®Œå…¨ï¼Œæ²¡æœ‰ç®¡ç†å¹³å°ã€å¯è§†åŒ–ç¼–æ’å·¥å…·</li></ul><h3 id="Ice"><a href="#Ice" class="headerlink" title="Ice"></a>Ice</h3><p><a href="http://waitmoon.com/zh/">å¼€æºæ¡†æ¶å­¦ä¹ ä¸åˆ†äº« | ice (waitmoon.com)</a></p><p>Ice ä½¿ç”¨å…¨æ–°çš„è®¾è®¡æ€æƒ³ï¼Œå¥‘åˆè§£è€¦å’Œå¤ç”¨çš„å±æ€§ï¼Œæ»¡è¶³æœ€å¤§çš„ç¼–æ’è‡ªç”±åº¦</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><strong>ç‹¬ç‰¹çš„è§„åˆ™ç¼–æ’æ€æƒ³</strong>ï¼šå¼•å…¥å…³ç³»èŠ‚ç‚¹çš„ä¸æˆ–éæ§åˆ¶æµç¨‹ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹å¯ä»¥æ›´å¥½çš„å¯¹æµç¨‹è¿›è¡Œæ§åˆ¶ï¼Œé¿å…æµç¨‹å‰åçš„ç»„ä»¶å½±å“ï¼Œé™ä½å¿ƒæ™ºè´Ÿæ‹…</li><li><strong>ç»„ä»¶çš„æ—¶é—´å±æ€§</strong>ï¼šç»„ä»¶å¤©ç„¶å¸¦æœ‰æ—¶é—´å±æ€§ï¼Œå¯ä»¥æ§åˆ¶æ‰§è¡Œç»„ä»¶ç”Ÿæ•ˆçš„æ—¶é—´èŒƒå›´ï¼ˆå¯¹äºæ´»åŠ¨ç±»é…ç½®éå¸¸æœ‰ç”¨ï¼‰</li><li><strong>ç»„ä»¶å‚æ•°</strong>ï¼šç»„ä»¶å‚æ•°ç”± Json æ ¼å¼çš„æ•°æ®è¿›è¡Œé…ç½®ï¼Œå¯¹äºåŒæ ·çš„ç»„ä»¶ä¸åŒçš„å‚æ•°ä¸éœ€è¦ä»ä¸šåŠ¡å…¥å£æˆ–è¿›è¡Œä¸­çš„ Context è¿›è¡Œæ§åˆ¶</li><li><strong>å¯è§†åŒ–åå°é…ç½®</strong>ï¼šæ‹¥æœ‰å¯è§†åŒ–åå°é…ç½®ï¼Œå¯¹è§„åˆ™å’ŒèŠ‚ç‚¹è¿›è¡Œé…ç½®<br><a href="http://eg.waitmoon.com/">iceé…ç½®åå° (waitmoon.com)</a></li></ul><p>å®˜æ–¹ä»‹ç»ï¼š<a href="http://waitmoon.com/ice-logic/zh/">ice ç¼–æ’é€»è¾‘</a></p><hr><p>ç¼ºç‚¹ï¼š</p><ul><li>æ–°é¡¹ç›®ï¼Œçƒ­åº¦ä½ï¼Œæ¡ˆä¾‹å°‘</li><li>æ–‡æ¡£ç®€é™‹</li></ul><h3 id="Aviator"><a href="#Aviator" class="headerlink" title="Aviator"></a>Aviator</h3><p><a href="https://github.com/killme2008/aviatorscript">killme2008&#x2F;aviatorscript: A high performance scripting language hosted on the JVM. (github.com)</a></p><p>ä¸¥æ ¼æ¥è¯´ AviatorScript å¹¶ä¸æ˜¯ä¸€ä¸ªè§„åˆ™å¼•æ“ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯ä»¥ç¼–è¯‘ä¸º Java å­—èŠ‚ç çš„è¡¨è¾¾å¼å¼•æ“</p><p>åœ¨ç¾å›¢çš„æŠ€æœ¯æ–‡ç« ä¸­ä½¿ç”¨è¯¥è„šæœ¬è¯­è¨€ä½œä¸ºè§„åˆ™æ¡†æ¶ä½¿ç”¨ï¼ˆå…·ä½“æ€ä¹ˆå®ç°ä¹Ÿçœ‹ä¸æ‡‚ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ”¯æŒè‡ªå®šä¹‰å‡½æ•°ï¼‰</p><p>AviatorScript çš„ä¼˜åŠ¿</p><ul><li><p><strong>é«˜æ€§èƒ½</strong>ï¼šå°†è¡¨è¾¾å¼ç›´æ¥ç¿»è¯‘æˆå¯¹åº”çš„ Java å­—èŠ‚ç æ‰§è¡Œï¼Œç¼–è¯‘ä¼˜å…ˆæ¨¡å¼åªæ‰«ä¸€éï¼Œä¿è¯äº†æ€§èƒ½è¶…è¶Šç»å¤§éƒ¨åˆ†è§£é‡Šæ€§çš„è¡¨è¾¾å¼å¼•æ“</p></li><li><p><strong>è½»é‡çº§</strong>ï¼šå…¶æ¬¡ï¼Œé™¤äº†ä¾èµ– <code>commons-beanutils</code> è¿™ä¸ªåº“ä¹‹å¤–ï¼ˆç”¨äºåšåå°„ï¼‰ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼Œå› æ­¤æ•´ä½“éå¸¸è½»é‡çº§ï¼Œæ•´ä¸ª jar åŒ…å¤§å°å“ªæ€•å‘å±•åˆ°ç°åœ¨ 5.0 è¿™ä¸ªå¤§ç‰ˆæœ¬ï¼Œä¹Ÿæ‰ 430K</p></li><li><p><strong>å¼€æ”¾èƒ½åŠ›</strong>ï¼šAviator å†…ç½®çš„å‡½æ•°åº“éå¸¸èŠ‚åˆ¶ï¼Œé™¤äº†å¿…é¡»çš„å­—ç¬¦ä¸²å¤„ç†ã€æ•°å­¦å‡½æ•°å’Œé›†åˆå¤„ç†ä¹‹å¤–åªèƒ½è‡ªå®šä¹‰å‡½æ•°å®ç°ï¼Œä¿è¯äº†å®‰å…¨æ€§</p></li><li><p><strong>ç‰¹è‰²</strong>ï¼š</p><ul><li><p>æ”¯æŒè¿ç®—ç¬¦é‡è½½</p></li><li><p>åŸç”Ÿæ”¯æŒå¤§æ•´æ•°å’Œ <code>BigDecimal</code> ç±»å‹åŠè¿ç®—ï¼Œå¹¶ä¸”é€šè¿‡è¿ç®—ç¬¦é‡è½½å’Œä¸€èˆ¬æ•°å­—ç±»å‹ä¿æŒä¸€è‡´çš„è¿ç®—æ–¹å¼</p></li><li><p>åŸç”Ÿæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ç±»å‹åŠåŒ¹é…è¿ç®—ç¬¦ <code>=~</code></p></li><li><p>ç±» <code>clojure</code> çš„ <code>seq</code> åº“åŠ lambda æ”¯æŒï¼Œå¯ä»¥çµæ´»åœ°å¤„ç†å„ç§é›†åˆ</p></li></ul></li></ul><p><strong>ç¾å›¢æ–‡ç« ä¸­ä½¿ç”¨ Aviator å¯¹å‡½æ•°çš„æ‰©å±•</strong></p><blockquote><p>è‡ªå®šä¹‰å‡½æ•°å¯ä»¥æ‰©å…… Aviator åŠŸèƒ½ï¼Œè§„åˆ™å¼•æ“å¯é€šè¿‡è‡ªå®šä¹‰å‡½æ•°æ‰§è¡Œå› å­åŠè§„åˆ™æ¡ä»¶</p><p>å¦‚è°ƒç”¨ç”¨æˆ·ç”»åƒç­‰ç¬¬ä¸‰æ–¹æœåŠ¡</p></blockquote><table><thead><tr><th>åç§°</th><th>ç¤ºä¾‹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>equals</td><td>equals(message.orderType, 0)</td><td>åˆ¤æ–­è®¢å•ç±»å‹æ˜¯å¦ä¸º 0</td></tr><tr><td>filter</td><td>filter(browseList, â€˜sourceâ€™, â€˜dpâ€™)</td><td>è¿‡æ»¤ç‚¹è¯„ä¾§æµè§ˆåˆ—è¡¨æ•°æ®</td></tr><tr><td>poiPortrait</td><td>poiPortrait(message.poiId)</td><td>æ ¹æ® poiId è·å–å•†æˆ·ç”»åƒæ•°æ®ï¼Œå¦‚å•†æˆ·æ˜Ÿçº§å±æ€§</td></tr><tr><td>userPortrait</td><td>userPortrait(message.userId)</td><td>æ ¹æ® userId è·å–ç”¨æˆ·ç”»åƒæ•°æ®ï¼Œå¦‚ç”¨æˆ·å¸¸ä½åœ°åŸå¸‚ã€ç”¨æˆ·æ–°è€å®¢å±æ€§</td></tr><tr><td>userBlackList</td><td>userBlackList(message.userId)</td><td>æ ¹æ® userId åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸ºé»‘åå•ç”¨æˆ·</td></tr></tbody></table><h3 id="Grule"><a href="#Grule" class="headerlink" title="Grule"></a>Grule</h3><p><a href="https://github.com/hyperjumptech/grule-rule-engine">hyperjumptech&#x2F;grule-rule-engine: Rule engine implementation in Golang (github.com)</a></p><p>Grule æ˜¯ Goï¼ˆGolangï¼‰ç¼–ç¨‹è¯­è¨€çš„è§„åˆ™å¼•æ“åº“ï¼Œçµæ„Ÿæ¥è‡ªå¹¿å—å¥½è¯„çš„ JBOSS Droolsï¼Œå¹¶ä»¥æ›´ç®€å•çš„æ–¹å¼å®Œæˆ</p><p>ä¸ Drools ä¸€æ ·ï¼ŒGrule ä¹Ÿæœ‰è‡ªå·±çš„ DSL æˆ–é¢†åŸŸç‰¹å®šè¯­è¨€</p><h2 id="åº”ç”¨æƒ…å†µ"><a href="#åº”ç”¨æƒ…å†µ" class="headerlink" title="åº”ç”¨æƒ…å†µ"></a>åº”ç”¨æƒ…å†µ</h2><ul><li>ç¾å›¢<br><a href="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a><br><a href="https://juejin.cn/post/6844903593326182414">å¤§æ•°æ®ï¼šç¾å›¢é…’æ—…å®æ—¶æ•°æ®è§„åˆ™å¼•æ“åº”ç”¨å®è·µ</a><ul><li>å¤–å–ä¸šåŠ¡ç»©æ•ˆæŒ‡æ ‡</li><li>ç¾å›¢ç‚¹è¯„é…’æ—…å®æ—¶è§¦è¾¾</li></ul></li><li>äº¬ä¸œ<br><a href="https://juejin.cn/post/7216143702123987005">å±¥çº¦æ ¸å¿ƒå¼•æ“ä½ä»£ç åŒ–åŸç†ä¸å®è·µ - æ˜é‡‘</a><ul><li>è®¢å•ç”Ÿäº§å±¥çº¦</li></ul></li><li>è´§æ‹‰æ‹‰<br><a href="https://juejin.cn/post/7195452429154910263">è´§æ‹‰æ‹‰å¤§æ•°æ®åŸºäºè§„åˆ™å¼•æ“æ„å»ºè¿åŠ›èµ„æºä¾›éœ€è°ƒèŠ‚ç³»ç»Ÿ</a><ul><li>å¤§æ•°æ®ï¼Œè¿åŠ›ä¾›éœ€å¹³è¡¡</li></ul></li><li>é›ªçƒ<br><a href="https://juejin.cn/post/7234763686475219003">è§„åˆ™å¼•æ“åœ¨å†…å®¹ç®¡ç†ä¸­çš„æ¢ç´¢ä¸åº”ç”¨</a><ul><li>å†…å®¹é£æ§</li></ul></li><li>é™Œé™Œ<br><a href="https://github.com/momosecurity/aswan">momosecurity&#x2F;aswan: é™Œé™Œé£æ§ç³»ç»Ÿé™æ€è§„åˆ™å¼•æ“ï¼Œé›¶åŸºç¡€ç®€æ˜“ä¾¿æ·çš„é…ç½®å¤šç§å¤æ‚è§„åˆ™ï¼Œå®æ—¶é«˜æ•ˆç®¡æ§ç”¨æˆ·å¼‚å¸¸è¡Œä¸ºã€‚ (github.com)</a><ul><li>ç”¨æˆ·é£æ§</li></ul></li></ul><p>å„ç§å·¥å…·ã€äº‘æœåŠ¡å…¶å®ä¹Ÿç¦»ä¸å¼€å„ç§è§„åˆ™é…ç½®</p><p><strong>Octopus å‘Šè­¦è§„åˆ™</strong></p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230627104922361.png" class="" title="image-20230627104922361"><p><strong>Sentry Alert Rule</strong></p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230627105038925.png" class="" title="image-20230627105038925"><p><strong>é˜¿é‡Œäº‘ç‰©è”ç½‘å¹³å°</strong></p><p><a href="https://help.aliyun.com/document_detail/42733.html?spm=a2c4g.42733.0.i3">é˜¿é‡Œäº‘ç‰©è”ç½‘å¹³å° - è®¾ç½®æ•°æ®æµè½¬è§„åˆ™ (aliyun.com)</a></p><p><strong>CDN</strong></p><p><a href="https://help.aliyun.com/document_detail/424607.html?spm=5176.21213303.J_6704733920.7.1c1453c9rubSy5">é˜¿é‡Œäº‘ CDN - è§„åˆ™å¼•æ“</a></p><h1 id="è§„åˆ™ç¼–æ’æ€æƒ³"><a href="#è§„åˆ™ç¼–æ’æ€æƒ³" class="headerlink" title="è§„åˆ™ç¼–æ’æ€æƒ³"></a>è§„åˆ™ç¼–æ’æ€æƒ³</h1><p>è§„åˆ™å¼•æ“çš„æ ¸å¿ƒä¹‹ä¸€å°±åœ¨äºè§„åˆ™çš„ç¼–æ’æ–¹å¼ï¼Œä¸Šé¢çš„å¼€æºæ¡†æ¶ã€å·¥å…·éƒ½æœ‰å…¶ä¸åŒçš„è§„åˆ™ç¼–æ’æ€æƒ³</p><p>è¿™é‡Œå°±å•ç‹¬èŠä¸€èŠä¸åŒå·¥å…·çš„ä¸åŒè§„åˆ™è¡¨è¾¾</p><h2 id="when-â€¦-then"><a href="#when-â€¦-then" class="headerlink" title="when â€¦ then"></a>when â€¦ then</h2><p><em>ä»£è¡¨ï¼šDroolsã€Grule</em></p><p><code>when ... then</code> æ˜¯æœ€å…¸å‹çš„è§„åˆ™ç¼–æ’æ€æƒ³ï¼Œä¸€ç»„è§„åˆ™ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>LHSï¼ˆLeft Hand Sideï¼‰ï¼šæ¡ä»¶åˆ†æ”¯é€»è¾‘</li><li>RHSï¼ˆRight Hand Sideï¼‰ï¼šæ‰§è¡Œé€»è¾‘</li></ul><blockquote><p>The <code>when</code> part of a DRL rule (also known as the <em>Left Hand Side (LHS)</em> of the rule) contains the conditions that must be met to execute an action.</p><p>The <code>then</code> part of the rule (also known as the <em>Right Hand Side (RHS)</em> of the rule) contains the actions to be performed when the conditional part of the rule has been met.</p></blockquote><p>Drools è§„åˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;SpeedUp&quot;</span></span><br><span class="line">    salience <span class="number">10</span></span><br><span class="line">    when</span><br><span class="line">        $TestCar : TestCarClass( speedUp == <span class="literal">true</span> &amp;&amp; speed &lt; maxSpeed )</span><br><span class="line">        $DistanceRecord : DistanceRecordClass()</span><br><span class="line">    then</span><br><span class="line">        $TestCar.setSpeed($TestCar.Speed + $TestCar.SpeedIncrement);</span><br><span class="line">        update($TestCar);</span><br><span class="line">        $DistanceRecord.setTotalDistance($DistanceRecord.getTotalDistance() + $TestCar.Speed);</span><br><span class="line">        update($DistanceRecord);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>Grule è§„åˆ™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule SpeedUp <span class="string">&quot;When testcar is speeding up we keep increase the speed.&quot;</span> salience <span class="number">10</span>  &#123;</span><br><span class="line">    when</span><br><span class="line">        TestCar.SpeedUp == <span class="literal">true</span> &amp;&amp; TestCar.Speed &lt; TestCar.MaxSpeed</span><br><span class="line">    then</span><br><span class="line">        TestCar.Speed = TestCar.Speed + TestCar.SpeedIncrement;</span><br><span class="line">        DistanceRecord.TotalDistance = DistanceRecord.TotalDistance + TestCar.Speed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>when ... then</code> çš„å½¢å¼é€‚åˆå¤§é‡äº‹å®å¯¹è±¡è¿›å…¥ç„¶åè¿›è¡Œå¤§é‡è§„åˆ™çš„åŒ¹é…ã€æ‰§è¡Œæ“ä½œ</p><p>æ•´ä¸ªè§„åˆ™æ˜¯å¹³é“ºå¼çš„ï¼Œå¯ä»¥ä½¿ç”¨è¡¨æ ¼æ¥è¿›è¡Œå±•ç¤ºï¼ˆä¸‹é¢å°±è¦æåˆ° Drools çš„å†³ç­–è¡¨æœºåˆ¶ï¼‰</p><p>ä¸é€‚åˆå¤„ç†å¸¦æœ‰æµç¨‹æ€§çš„è§„åˆ™</p><h2 id="å†³ç­–è¡¨-æ ‘"><a href="#å†³ç­–è¡¨-æ ‘" class="headerlink" title="å†³ç­–è¡¨ \ æ ‘"></a>å†³ç­–è¡¨ \ æ ‘</h2><p><em>ä»£è¡¨ï¼šDrools</em></p><p>å†³ç­–è¡¨å…¶å®å°±æ˜¯å¦ä¸€ç§å½¢å¼çš„ <code>when ... then</code> è¡¨è¾¾ï¼Œä¹‹é—´å¯ä»¥äº’ç›¸è½¬æ¢ï¼›æ­¤å¤– Drools è¿˜æ”¯æŒéå¸¸å¤šçš„è§„åˆ™å½¢å¼ï¼Œåœ¨è¿™é‡Œåˆ—ä¸¾ä¸€éƒ¨åˆ†<br><a href="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/index.html#drools.AuthoringAssets">Drools Documentation#Authoring rule assets</a></p><p><img src="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/newItemMenu.png" alt="Authoring rule assets"></p><h3 id="ç”µå­è¡¨æ ¼å†³ç­–è¡¨"><a href="#ç”µå­è¡¨æ ¼å†³ç­–è¡¨" class="headerlink" title="ç”µå­è¡¨æ ¼å†³ç­–è¡¨"></a>ç”µå­è¡¨æ ¼å†³ç­–è¡¨</h3><p>Spreadsheet decision tables</p><p>ç”µå­è¡¨æ ¼å†³ç­–è¡¨æ˜¯åŒ…å«ä»¥è¡¨æ ¼æ ¼å¼å®šä¹‰çš„ä¸šåŠ¡è§„åˆ™çš„ XLS æˆ– XLSX ç”µå­è¡¨æ ¼</p><p>å†³ç­–è¡¨ä¸­çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€æ¡è§„åˆ™ï¼Œæ¯ä¸€åˆ—éƒ½æ˜¯ä¸€ä¸ªæ¡ä»¶ã€ä¸€ä¸ªæ“ä½œæˆ–å¦ä¸€ä¸ªè§„åˆ™å±æ€§ï¼›åˆ›å»ºå¹¶ä¸Šä¼ ç”µå­è¡¨æ ¼å†³ç­–è¡¨åï¼Œå®šä¹‰çš„è§„åˆ™å°†ä¸æ‰€æœ‰å…¶ä»–è§„åˆ™èµ„äº§ä¸€æ ·è¢«ç¼–è¯‘ä¸º DRL è§„åˆ™</p><p><img src="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/decision-table-example-02.png"></p><p><img src="https://img-blog.csdnimg.cn/18216cde2ef74a6aa4fbed071c4aad89.png#pic_center"></p><p>ä¸Šé¢çš„å†³ç­–è¡¨ä¾‹å­è½¬æ¢ä¸º DRL æ ¼å¼çš„è§„åˆ™æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rules.excels;</span><br><span class="line"><span class="comment">//generated from Decision Table</span></span><br><span class="line"><span class="keyword">import</span> com.ppl.demo.entity.Account;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line">global List&lt;String&gt; list;</span><br><span class="line"><span class="comment">// rule values at B11, header at B6</span></span><br><span class="line">rule <span class="string">&quot;ExcelTable_11&quot;</span></span><br><span class="line">salience <span class="number">65535</span></span><br><span class="line">agenda-group <span class="string">&quot;rule-group-001&quot;</span></span><br><span class="line">when</span><br><span class="line">$account: Account(sex != <span class="string">&quot;å¥³&quot;</span>)</span><br><span class="line">then</span><br><span class="line">list.add(<span class="string">&quot;æ€§åˆ«ä¸å¯¹&quot;</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">// rule values at B12, header at B6</span></span><br><span class="line">rule <span class="string">&quot;ExcelTable_12&quot;</span></span><br><span class="line">salience <span class="number">65534</span></span><br><span class="line">agenda-group <span class="string">&quot;rule-group-001&quot;</span></span><br><span class="line">when</span><br><span class="line">$account: Account(age &lt; <span class="number">22</span> || age&gt; <span class="number">28</span>)</span><br><span class="line">then</span><br><span class="line">list.add(<span class="string">&quot;å¹´é¾„ä¸åˆé€‚&quot;</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">// rule values at B13, header at B6</span></span><br><span class="line">rule <span class="string">&quot;ExcelTable_13&quot;</span></span><br><span class="line">salience <span class="number">65533</span></span><br><span class="line">agenda-group <span class="string">&quot;rule-group-002&quot;</span></span><br><span class="line">when</span><br><span class="line">$account: Account(balance &lt; <span class="number">1000</span>)</span><br><span class="line">then</span><br><span class="line">list.add(<span class="string">&quot;å·¥èµ„å¤ªä½&quot;</span>);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="å¼•å¯¼å¼å†³ç­–è¡¨"><a href="#å¼•å¯¼å¼å†³ç­–è¡¨" class="headerlink" title="å¼•å¯¼å¼å†³ç­–è¡¨"></a>å¼•å¯¼å¼å†³ç­–è¡¨</h3><p>Guided decision tables</p><p>Drools æ”¯æŒä¸¤ç§ç±»å‹çš„å†³ç­–è¡¨ï¼šæ‰©å±•æ¡ç›®è¡¨ï¼ˆExtended entryï¼‰å’Œæœ‰é™æ¡ç›®è¡¨ï¼ˆLimited entryï¼‰</p><ul><li><p><strong>æ‰©å±•æ¡ç›®è¡¨</strong>ï¼šæ‰©å±•æ¡ç›®å†³ç­–è¡¨æ˜¯åˆ—å®šä¹‰æŒ‡å®š Patternã€Field å’Œ Operator ä½†ä¸æŒ‡å®šå€¼çš„å†³ç­–è¡¨ã€‚å€¼æˆ–çŠ¶æ€æœ¬èº«ä¿å­˜åœ¨å†³ç­–è¡¨çš„ä¸»ä½“ä¸­<br><img src="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/dtable-extended-entry.png" alt="æ‰©å±•æ¡ç›®è¡¨"></p></li><li><p><strong>æœ‰é™æ¡ç›®è¡¨</strong>ï¼šé™¤äº† Patternã€Field å’Œ Operator ä¹‹å¤–ï¼ŒLimited Entry å†³ç­–è¡¨çš„åˆ—å®šä¹‰è¿˜ä¸ºå…¶æŒ‡å®šå€¼<br>å†³ç­–è¡¨çŠ¶æ€ä¿å­˜åœ¨è¡¨çš„ä¸»ä½“ä¸­ï¼Œæ˜¯å¸ƒå°”å€¼ï¼Œå…¶ä¸­ true å…·æœ‰åº”ç”¨æˆ–åŒ¹é…åˆ—çš„æ•ˆæœï¼›false è¡¨ç¤ºè¯¥åˆ—ä¸é€‚ç”¨</p><p><img src="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/dtable-limited-entry.png" alt="æœ‰é™æ¡ç›®è¡¨"></p></li></ul><h3 id="å¼•å¯¼å¼å†³ç­–å›¾"><a href="#å¼•å¯¼å¼å†³ç­–å›¾" class="headerlink" title="å¼•å¯¼å¼å†³ç­–å›¾"></a>å¼•å¯¼å¼å†³ç­–å›¾</h3><p>è™½ç„¶å¯ä»¥ç¼–å†™å•ä¸ªå¼•å¯¼å†³ç­–è¡¨ï¼Œä½†ä¹Ÿå¯ä»¥ç¼–å†™ç›¸å…³è¡¨çš„å›¾ï¼Œå…¶ä¸­ä¸€ä¸ªè¡¨çš„åŠ¨ä½œå¯ä»¥æä¾›å¦ä¸€ä¸ªè¡¨æ¡ä»¶çš„æ½œåœ¨åŒ¹é…ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è¡¨è¢«è®¤ä¸ºæ˜¯ç›¸å…³çš„</p><p><img src="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/dtable-graph-radar.png"></p><h3 id="å¼•å¯¼å¼å†³ç­–æ ‘"><a href="#å¼•å¯¼å¼å†³ç­–æ ‘" class="headerlink" title="å¼•å¯¼å¼å†³ç­–æ ‘"></a>å¼•å¯¼å¼å†³ç­–æ ‘</h3><p>Business Central æ”¯æŒç¼–å†™ç®€å•çš„å†³ç­–æ ‘</p><p><img src="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/GuidedDecisionTreeEditorCollapse1.png"></p><p><a href="http://49.235.87.129:8080/business-central">http://49.235.87.129:8080/business-central</a></p><h2 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h2><p><em>ä»£è¡¨ï¼šLiteFlow</em></p><p>LiteFlow çš„è§„åˆ™è¯­æ³•ç›¸å½“äºæ„é€ å‡ºä¸€ä¸ªæµç¨‹å›¾ï¼Œç»„ä»¶ä½œä¸ºèŠ‚ç‚¹ï¼Œè§„åˆ™æè¿°ç»„ä»¶é—´æ‰§è¡Œå…³ç³»ï¼š</p><ul><li>ä¸²è¡Œ <code>THEN</code></li><li>å¹¶è¡Œ <code>WHEN</code></li><li>é€‰æ‹© <code>SWITCH</code></li><li>æ¡ä»¶ <code>IF</code></li><li>å¾ªç¯<ul><li>for å¾ªç¯ <code>FOR...DO</code></li><li>while å¾ªç¯ <code>WHILE...DO</code></li><li>è¿­ä»£å™¨å¾ªç¯ <code>ITERATOR...DO</code></li><li>è·³å‡º <code>BREAK</code></li></ul></li><li>å¼‚å¸¸æ•è· <code>CATCH</code></li><li>å¼‚æˆ–éè¡¨è¾¾ <code>AND</code>ã€<code>OR</code>ã€<code>NOT</code></li></ul><p><img src="https://liteflow.yomahub.com/img/flow_example/e10.svg" alt="LiteFlow å¤æ‚æµç¨‹ç¼–æ’"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">    THEN(</span><br><span class="line">        A,</span><br><span class="line">        WHEN(</span><br><span class="line">            THEN(B, C),</span><br><span class="line">            THEN(D, E, F),</span><br><span class="line">            THEN(</span><br><span class="line">                SWITCH(G).to(</span><br><span class="line">                    THEN(H, I, WHEN(J, K)).id(&quot;t1&quot;),</span><br><span class="line">                    THEN(L, M).id(&quot;t2&quot;)</span><br><span class="line">                ),</span><br><span class="line">                N</span><br><span class="line">            )</span><br><span class="line">        ),</span><br><span class="line">        Z</span><br><span class="line">    );</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å­å˜é‡ä¼˜åŒ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">    item1 = THEN(B, C);</span><br><span class="line">    item2 = THEN(D, E, F);</span><br><span class="line">    item3_1 = THEN(H, I, WHEN(J, K)).id(&quot;t1&quot;);</span><br><span class="line">    item3_2 = THEN(L, M).id(&quot;t2&quot;);</span><br><span class="line">    item3 = THEN(SWITCH(G).to(item3_1, item3_2), N);</span><br><span class="line">    </span><br><span class="line">    THEN(</span><br><span class="line">        A,</span><br><span class="line">        WHEN(item1, item2, item3),</span><br><span class="line">        Z</span><br><span class="line">    );</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å…³ç³»æ§åˆ¶"><a href="#å…³ç³»æ§åˆ¶" class="headerlink" title="å…³ç³»æ§åˆ¶"></a>å…³ç³»æ§åˆ¶</h2><p><em>ä»£è¡¨ï¼šice</em></p><blockquote><p>æµç¨‹å›¾å¼å’Œæ‰§è¡Œæ ‘å¼å®ç°çš„ä¸»è¦ç¼ºç‚¹åœ¨äºï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œæ”¹åŠ¨ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦ç»å‰é¡¾åï¼Œå¦‚æœè€ƒè™‘ä¸åˆ°ä½ï¼Œå¾ˆå®¹æ˜“å¼„é”™ï¼Œè€Œä¸”è¿™è¿˜åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œç°å®çš„æ´»åŠ¨å†…å®¹è¦æ¯”è¿™å¤æ‚çš„å¤šçš„å¤šï¼Œæ—¶é—´çº¿ä¹Ÿæ˜¯å¾ˆå¤šæ¡</p><p>å¾€å¾€å¾—ä¸å¿å¤±ï¼Œåˆ°å¤´æ¥å‘ç°è¿˜ä¸å¦‚ç¡¬ç¼–ç </p><p><a href="http://waitmoon.com/zh/guide/#%E5%8F%98%E5%8A%A8">é¡¹ç›®ç®€ä»‹ | ice (waitmoon.com)</a></p></blockquote><p>Ice çš„è§„åˆ™ç¼–æ’å¼ºè°ƒç»„ä»¶ç”Ÿæ•ˆæ—¶é—´å’Œè§„åˆ™ä¹‹é—´çš„å…³ç³»</p><p>Ice ä¸­åˆ†ä¸ºä¸¤ç§è§„åˆ™èŠ‚ç‚¹ï¼š</p><ul><li><strong>å…³ç³»èŠ‚ç‚¹</strong>ï¼šå…³ç³»èŠ‚ç‚¹ä¸ºäº†æ§åˆ¶ä¸šåŠ¡æµè½¬<ul><li>ANDï¼š<code>&amp;&amp;</code>ï¼Œåœ¨æ‰§è¡Œåˆ° false çš„åœ°æ–¹ç»ˆæ­¢æ‰§è¡Œ</li><li>ANYï¼š<code>||</code>ï¼Œåœ¨æ‰§è¡Œåˆ° true çš„åœ°æ–¹ç»ˆæ­¢æ‰§è¡Œ</li><li>ALLï¼šæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œï¼Œæ ¹æ®èŠ‚ç‚¹è¿”å›å€¼è¿›è¡Œä¸åŒçš„è¿”å›</li><li>NONEï¼šæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œï¼Œæ— è®ºå­èŠ‚ç‚¹è¿”å›ä»€ä¹ˆéƒ½è¿”å› none</li><li>TRUEï¼šæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œï¼Œæ— è®ºå­èŠ‚ç‚¹è¿”å›ä»€ä¹ˆï¼Œéƒ½è¿”å› true</li></ul></li><li><strong>å¶å­èŠ‚ç‚¹</strong>ï¼šå¶å­èŠ‚ç‚¹ä¸ºçœŸæ­£å¤„ç†çš„èŠ‚ç‚¹<ul><li>Flowï¼šä¸€äº›æ¡ä»¶ä¸è§„åˆ™èŠ‚ç‚¹ï¼Œå¦‚ä¾‹å­ä¸­çš„ ScoreFlow</li><li>Resultï¼šä¸€äº›ç»“æœæ€§è´¨çš„èŠ‚ç‚¹ï¼Œå¦‚ä¾‹å­ä¸­çš„ AmountResultï¼ŒPointResult</li><li>Noneï¼šä¸€äº›ä¸å¹²é¢„æµç¨‹çš„åŠ¨ä½œï¼Œå¦‚è£…é…å·¥ä½œç­‰</li></ul></li></ul><hr><p>æ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªä¾‹å­æ¥ä½“ç°è¿™æ ·ç¼–æ’è§„åˆ™çš„ä¼˜åŠ¿ï¼š</p><p>X å…¬å¸å°†åœ¨å›½åº†æ”¾å‡æœŸé—´ï¼Œå¼€å±•ä¸€ä¸ªä¸ºæœŸä¸ƒå¤©çš„å……å€¼å°æ´»åŠ¨ï¼Œæ´»åŠ¨å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>æ´»åŠ¨æ—¶é—´ï¼ˆ10.1 - 10.7ï¼‰</li><li>æ´»åŠ¨å†…å®¹<ul><li>å……å€¼ 100 å…ƒ é€ 5 å…ƒä½™é¢ ï¼ˆ10.1 - 10.7ï¼‰</li><li>å……å€¼ 50 å…ƒ é€ 10 ç§¯åˆ† ï¼ˆ10.5 - 10.7ï¼‰</li><li>ä¸å åŠ é€ï¼ˆå……å€¼ 100 å…ƒåªèƒ½è·å¾— 5 å…ƒä½™é¢ï¼Œä¸ä¼šå åŠ èµ é€ 10 ç§¯åˆ†ï¼‰</li></ul></li></ul><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/ice%E4%BF%AE%E6%94%B9%E5%89%8D.png" class="" title="iceä¿®æ”¹å‰"><p>éœ€è¦å¯¹è§„åˆ™è¿›è¡Œè°ƒæ•´ï¼š</p><ol><li><p>å……å€¼ 100 å…ƒæ”¹æˆ 80ï¼Œ10 ç§¯åˆ†å˜ 20 ç§¯åˆ†ï¼Œæ—¶é—´æ”¹æˆ 10.8 å·ç»“æŸ</p></li><li><p>å»æ‰ä¸å åŠ é€</p></li><li><p>5 å…ƒä½™é¢ä¸èƒ½é€å¤ªå¤šï¼Œè®¾ç½®ä¸ªåº“å­˜ 100 ä¸ªï¼›åº“å­˜ä¸è¶³å…… 100 å…ƒè¿˜æ˜¯å¾—é€ 10 ç§¯åˆ†</p></li></ol><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/ice%E4%BF%AE%E6%94%B9%E5%90%8E.png" class="" title="iceä¿®æ”¹å"><p>ä¼˜åŠ¿ï¼š</p><ul><li>å¯¹äº 1 çš„æ”¹åŠ¨ï¼Œåªéœ€è¦ä¿®æ”¹èŠ‚ç‚¹é€»è¾‘ï¼ˆ<code>ScoreFlow</code>ã€<code>PointResult</code>ï¼‰</li><li>å¯¹äº 2 çš„æ”¹åŠ¨å°†å…¥å£çš„å…³ç³»èŠ‚ç‚¹ ANY ä¿®æ”¹ä¸º ALL</li><li>å¯¹äº 3 ç”±äºåº“å­˜çš„ä¸è¶³ï¼Œç›¸å½“äºæ²¡æœ‰ç»™ç”¨æˆ·å‘æ”¾ï¼Œåˆ™ <code>AmountResult</code> è¿”å› falseï¼Œæµç¨‹è¿˜ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä¸ç”¨åšä»»ä½•æ›´æ”¹</li><li>å¼•å…¥ ALL èŠ‚ç‚¹åŠ <code>TimeChangeNone</code> æ¥ä¿®æ”¹æ—¶é—´ï¼Œæ–¹ä¾¿æµ‹è¯•</li></ul><blockquote><p><em>æ€è€ƒï¼šè§„åˆ™å¼•æ“åˆ°åº•æ˜¯ä»€ä¹ˆå½¢å¼</em></p><p><em>Drools æˆ–è€…ä¼ ç»Ÿçš„è§„åˆ™å¼•æ“å€¾å‘äºå¤§é‡ä¸šåŠ¡è§„åˆ™ä¸‹çš„åŒ¹é…ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºå†³ç­–ï¼ˆDecisionï¼‰å¼•æ“</em></p><p><em>è€Œ LiteFlow æ›´åƒæ˜¯è®¾è®¡æ¨¡å¼çš„å»¶ä¼¸ï¼Œç»„ä»¶çš„æ‰§è¡Œç¼–æ’ï¼Œä½†æ˜¯ä¹Ÿç§°ä¸º â€œè§„åˆ™å¼•æ“â€</em></p></blockquote><h1 id="ä¸€äº›æ¦‚å¿µ"><a href="#ä¸€äº›æ¦‚å¿µ" class="headerlink" title="ä¸€äº›æ¦‚å¿µ"></a>ä¸€äº›æ¦‚å¿µ</h1><h2 id="DSL"><a href="#DSL" class="headerlink" title="DSL"></a>DSL</h2><p>DSLï¼ˆDomain Specific Languageï¼Œé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºè§£å†³ç‰¹å®šé¢†åŸŸé—®é¢˜çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹å®šé¢†åŸŸçš„ä¸“ç”¨è¯­è¨€ï¼Œé€šå¸¸å…·æœ‰ç®€å•ã€æ˜“ç”¨ã€é«˜æ•ˆç­‰ç‰¹ç‚¹ï¼›DSL çš„è¯­æ³•å’Œè¯­ä¹‰é€šå¸¸ä¸ç‰¹å®šé¢†åŸŸçš„é—®é¢˜å¯†åˆ‡ç›¸å…³ï¼Œå¯ä»¥å¤§å¤§ç®€åŒ–é—®é¢˜çš„è¡¨è¾¾å’Œè§£å†³</p><p>è¿™é‡Œä»¥ Drools ä¸ºä¾‹ï¼ŒDrools å¯ä»¥æ ¹æ®å®šä¹‰çš„ DSL æ–‡ä»¶å’Œ DSLR æ–‡ä»¶ï¼Œå°†å…¶è½¬æ¢ä¸º DRL è¡¨è¾¾</p><p><strong>DSL</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[&lt;scope&gt;][&lt;type definition&gt;]&lt;dsl expression&gt;=&lt;replacement text&gt;</span><br><span class="line">[when] or [condition] å®šä¹‰çš„è¯­æ³•åº”ç”¨äºLHS</span><br><span class="line">[then] or [consequence] å®šä¹‰çš„è¯­æ³•åº”ç”¨äºRHS</span><br><span class="line">[*]  ä»¥ä¸Šä¸¤è€…éƒ½é€‚ç”¨</span><br><span class="line">[keyword] å…³é”®å­—ï¼Œæ¯”å¦‚ no-loop è¿™ä¸€ç±»å±æ€§</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[when] There is <span class="type">a</span> <span class="variable">person</span> <span class="operator">=</span> $p:Person()</span><br><span class="line">[when] - id greater than &#123;id:\d*&#125; = id &gt; &#123;id&#125;</span><br><span class="line">[then] print = System.out.println(<span class="string">&quot;I am fired!&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>DSLR</strong></p><p>è¿™æ ·æ•´ä¸ª DSLR æ–‡ä»¶è®²ä½¿ç”¨è¯­ä¹‰åŒ–çš„è¡¨è¾¾æ¥æè¿°å­˜åœ¨ DSL å®šä¹‰çš„ç‰¹å®šé¢†åŸŸå†…è§„åˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&#x27;test-dsl&#x27;</span></span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">    There is a person</span><br><span class="line">    - id greater than <span class="number">10</span></span><br><span class="line">then</span><br><span class="line">    print</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>è½¬æ¢åçš„ DRL è§„åˆ™</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&#x27;test-dsl&#x27;</span></span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">    $p:Person(id &gt; <span class="number">10</span>)</span><br><span class="line">then</span><br><span class="line">    System.out.println(<span class="string">&quot;I am fired!&quot;</span>)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="DMN"><a href="#DMN" class="headerlink" title="DMN"></a>DMN</h2><p>DMN å…¨ç§° Decision Model and Notationï¼ˆå†³ç­–æ¨¡å‹ä¸ç¬¦å·ï¼‰,æ˜¯ä¸€ç§ç”¨äºè¡¨ç¤ºä¸šåŠ¡å†³ç­–å’Œè§„åˆ™çš„è§„èŒƒï¼Œæ—¨åœ¨å¸®åŠ©å‚ä¸å†³ç­–çš„äººéƒ½èƒ½ç®€å•å¿«é€Ÿç†è§£å†³ç­–è¿‡ç¨‹</p><p>DMN æ˜¯ç”± OMG ç®¡ç†çš„ä¸€ç§è§„èŒƒï¼Œè¯¥ç»„ç»‡ä¸‹æ¯”è¾ƒçŸ¥åçš„è¿˜æœ‰ UML ç­‰</p><p>Drools å¯¹ DMN æœ‰è‰¯å¥½çš„æ”¯æŒï¼Œæ”¯æŒ DMN 1.3ï¼ŒåŠŸèƒ½å®Œå–„</p><p><a href="https://github.com/kiegroup/kogito-examples">kiegroup&#x2F;kogito-examples: Kogito examples - Kogito is a cloud-native business automation technology for building cloud-ready business applications. (github.com)</a></p><p><a href="https://learn-dmn-in-15-minutes.com/learn/introduction">Learn DMN in 15 minutes | Introduction (learn-dmn-in-15-minutes.com)</a></p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230625000439860.png" class="" title="image-20230625000439860"><p>DMN ä¸­æ”¯æŒ FEEL è§„åˆ™è¡¨è¾¾å¼</p><p>è¶³å¤Ÿå‹å¥½çš„è¡¨è¾¾è¯­è¨€ï¼ˆFriendly Enough Expression Language ï¼‰FEEL è¡¨è¾¾å¼å®šä¹‰äº† DMN æ¨¡å‹ä¸­å†³ç­–çš„é€»è¾‘ï¼ŒFEEL æ—¨åœ¨é€šè¿‡ä¸ºå†³ç­–æ¨¡å‹ç»“æ„åˆ†é…è¯­ä¹‰æ¥ä¿ƒè¿›å†³ç­–å»ºæ¨¡å’Œæ‰§è¡Œ</p><p><a href="https://kiegroup.github.io/dmn-feel-handbook/#dmn-feel-handbook">DMN FEEL handbook â€“ Drools DMN FEEL handbook (kiegroup.github.io)</a></p><div STYLE="page-break-after: always;"></div><h2 id="CEP"><a href="#CEP" class="headerlink" title="CEP"></a>CEP</h2><p>CEP æ˜¯å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆComplex event processingï¼‰çš„ç¼©å†™</p><p>äº‹ä»¶æ˜¯æŸä¸ªæ—¶é—´ç‚¹åº”ç”¨ç¨‹åºåŸŸä¸­çŠ¶æ€å‘ç”Ÿé‡å¤§å˜åŒ–çš„è®°å½•ï¼Œæ ¹æ®åŸŸçš„å»ºæ¨¡æ–¹å¼ï¼ŒçŠ¶æ€çš„å˜åŒ–å¯ä»¥ç”±å•ä¸ªäº‹ä»¶ã€å¤šä¸ªåŸå­äº‹ä»¶æˆ–ç›¸å…³äº‹ä»¶çš„å±‚æ¬¡ç»“æ„è¡¨ç¤º</p><p>ä»å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰çš„è§’åº¦æ¥çœ‹ï¼Œäº‹ä»¶æ˜¯å‘ç”Ÿåœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„ä¸€ç§äº‹å®æˆ–å¯¹è±¡ï¼Œè€Œä¸šåŠ¡è§„åˆ™æ˜¯å¦‚ä½•å¯¹æ¥è‡ªè¯¥äº‹å®æˆ–å¯¹è±¡çš„æ•°æ®åšå‡ºååº”çš„å®šä¹‰ï¼šä¾‹å¦‚åœ¨è‚¡ç¥¨ç»çºªäººåº”ç”¨ç¨‹åºä¸­ï¼Œè¯åˆ¸ä»·æ ¼çš„å˜åŒ–ã€æ‰€æœ‰æƒä»å–æ–¹åˆ°ä¹°æ–¹çš„å˜åŒ–æˆ–è´¦æˆ·æŒæœ‰äººä½™é¢çš„å˜åŒ–éƒ½è¢«è§†ä¸ºäº‹ä»¶ï¼Œå› ä¸ºåœ¨ç»™å®šæ—¶é—´åº”ç”¨ç¨‹åºåŸŸçš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–</p><p>Drools ä¸­çš„ Drools engine ä½¿ç”¨å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰æ¥æ£€æµ‹å’Œå¤„ç†äº‹ä»¶é›†åˆä¸­çš„å¤šä¸ªäº‹ä»¶ï¼Œæ­ç¤ºäº‹ä»¶ä¹‹é—´å­˜åœ¨çš„å…³ç³»ï¼Œå¹¶ä»äº‹ä»¶åŠå…¶å…³ç³»ä¸­æ¨æ–­æ–°æ•°æ®</p><p>CEP åœºæ™¯å…·æœ‰ä»¥ä¸‹å…³é”®ç‰¹å¾ï¼š</p><ul><li>åœºæ™¯é€šå¸¸å¤„ç†å¤§é‡äº‹ä»¶ï¼Œä½†åªæœ‰ä¸€å°éƒ¨åˆ†äº‹ä»¶æ˜¯çœŸæ­£å…³å¿ƒçš„</li><li>äº‹ä»¶é€šå¸¸æ˜¯ä¸å¯å˜çš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯çŠ¶æ€æ”¹å˜çš„ä¸€æ¡è®°å½•ï¼ˆæ˜¯ä¸€ä¸ªå†å²çŠ¶æ€ï¼‰</li><li>è§„åˆ™å’ŒæŸ¥è¯¢é’ˆå¯¹äº‹ä»¶è¿è¡Œï¼Œå¹¶ä¸”å¿…é¡»å¯¹æ£€æµ‹åˆ°çš„äº‹ä»¶æ¨¡å¼ä½œå‡ºååº”</li><li>ç›¸å…³äº‹ä»¶é€šå¸¸å…·æœ‰å¾ˆå¼ºçš„æ—¶é—´å…³ç³»</li><li>ç‹¬ç«‹çš„äº‹ä»¶æ˜¯ä¸é‡è¦çš„ï¼›CEP ç³»ç»Ÿä¼˜å…ˆè€ƒè™‘ç›¸å…³äº‹ä»¶çš„æ¨¡å¼åŠå…¶ä¹‹é—´çš„å…³ç³»</li><li>äº‹ä»¶é€šå¸¸éœ€è¦ç»„åˆå’Œèšåˆ</li></ul><p>é‰´äºè¿™äº›å¸¸è§çš„ CEP åœºæ™¯ç‰¹å¾ï¼ŒDrools ä¸­çš„ CEP ç³»ç»Ÿæ”¯æŒä»¥ä¸‹ç‰¹æ€§å’ŒåŠŸèƒ½ï¼Œä»¥ä¼˜åŒ–äº‹ä»¶å¤„ç†ï¼š</p><ul><li>å…·æœ‰é€‚å½“è¯­ä¹‰çš„äº‹ä»¶å¤„ç†</li><li>äº‹ä»¶æ£€æµ‹ã€å…³è”ã€èšåˆå’Œåˆæˆ</li><li>äº‹ä»¶æµï¼ˆEvent streamï¼‰å¤„ç†</li><li>å¯¹äº‹ä»¶ä¹‹é—´çš„æ—¶é—´å…³ç³»å»ºæ¨¡çš„æ—¶é—´çº¦æŸ</li><li>äº‹ä»¶æ»‘åŠ¨çª—å£</li><li>ä¼šè¯èŒƒå›´çš„ç»Ÿä¸€æ—¶é’Ÿ</li><li>ååº”å¼è§„åˆ™</li><li>ç”¨äºäº‹ä»¶è¾“å…¥åˆ° Drools å¼•æ“çš„é€‚é…å™¨</li></ul><hr><p><strong>å£°æ˜äº‹ä»¶</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">declare VoiceCall</span><br><span class="line">  <span class="meta">@role( event )</span></span><br><span class="line">  <span class="meta">@timestamp( callDateTime )</span></span><br><span class="line">  <span class="meta">@duration( callDuration )</span></span><br><span class="line">  <span class="meta">@expires( 1h35m )</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>Drools å¯¹äº CEP æœ‰ç€ä¸°å¯Œçš„æ—¶é—´è§„åˆ™æ”¯æŒ</strong></p><p>åœ¨æµæ¨¡å¼ä¸‹ï¼ŒDrools å¼•æ“å¯¹å·¥ä½œå†…å­˜çš„äº‹ä»¶æ”¯æŒä»¥ä¸‹æ—¶æ€è¿ç®—ç¬¦ï¼š</p><ul><li><code>after</code></li><li><code>before</code></li><li><code>meets</code></li><li><code>during</code></li><li>â€¦</li></ul><p>ä»¥ <code>after</code> ä¸ºä¾‹</p><p><code>$eventA : EventA(this after[3m30s, 4m] $eventB)</code> æˆ–è€… <code>3m30s &lt;= $eventA.startTimestamp - $eventB.endTimeStamp &lt;= 4m</code></p><p>è¡¨ç¤ºï¼šå¦‚æœ <code>$eventA</code> åœ¨ <code>$eventB</code> ç»“æŸå 3 åˆ† 30 ç§’åˆ° 4 åˆ†ä¹‹é—´å¼€å§‹ï¼Œåˆ™ä»¥ä¸‹æ¨¡å¼åŒ¹é…ï¼›å¦‚æœ <code>$eventA</code> åœ¨ <code>$eventB</code> ç»“æŸå 3 åˆ† 30 ç§’ä¹‹å‰å¼€å§‹ï¼Œæˆ–åœ¨ <code>$eventA</code> ç»“æŸå 4 åˆ†é’Ÿä¹‹åå¼€å§‹ï¼Œåˆ™ä¸åŒ¹é…</p><p><strong>æ—¶é—´ \ é•¿åº¦æ»‘åŠ¨çª—å£</strong></p><ul><li>å¤„ç†æœ€å 2 åˆ†é’Ÿçš„åº“å­˜ç‚¹ï¼ˆæ—¶é—´æ»‘åŠ¨çª—å£ï¼‰<br><code>StockPoint() over window:time(2m)</code></li><li>å¤„ç†æœ€å10ä¸ªåº“å­˜ç‚¹ï¼ˆé•¿åº¦æ»‘åŠ¨çª—å£ï¼‰<br>  <code>StockPoint() over window:length(10)</code></li></ul><p>ä¾‹å¦‚ä»¥ä¸‹ä¸¤ä¸ª DRL è§„åˆ™æ ¹æ®å¹³å‡æ¸©åº¦æ¿€æ´»ç«ç¾è­¦æŠ¥ï¼›ç¬¬ä¸€æ¡è§„åˆ™ä½¿ç”¨æ»‘åŠ¨æ—¶é—´çª—å£æ¥è®¡ç®—æœ€å 10 åˆ†é’Ÿçš„å¹³å‡å€¼ï¼Œè€Œç¬¬äºŒæ¡è§„åˆ™ä½¿ç”¨æ»šåŠ¨é•¿åº¦çª—å£æ¥è®¡ç®—æœ€è¿‘ä¸€ç™¾ä¸ªæ¸©åº¦è¯»æ•°çš„å¹³å‡å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Sound the alarm if temperature rises above threshold&quot;</span></span><br><span class="line">when</span><br><span class="line">  <span class="title function_">TemperatureThreshold</span><span class="params">($max : max)</span></span><br><span class="line">  Number(doubleValue &gt; $max) from <span class="title function_">accumulate</span><span class="params">(</span></span><br><span class="line"><span class="params">    SensorReading($temp : temperature)</span> over window:time(10m),</span><br><span class="line">    average($temp))</span><br><span class="line">then</span><br><span class="line">  <span class="comment">// Sound the alarm.</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Sound the alarm if temperature rises above threshold&quot;</span></span><br><span class="line">when</span><br><span class="line">  <span class="title function_">TemperatureThreshold</span><span class="params">($max : max)</span></span><br><span class="line">  Number(doubleValue &gt; $max) from <span class="title function_">accumulate</span><span class="params">(</span></span><br><span class="line"><span class="params">    SensorReading($temp : temperature)</span> over window:length(<span class="number">100</span>),</span><br><span class="line">    average($temp))</span><br><span class="line">then</span><br><span class="line">  <span class="comment">// Sound the alarm.</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><div STYLE="page-break-after: always;"></div><h2 id="è¡Œä¸ºå‹æ¨¡å¼"><a href="#è¡Œä¸ºå‹æ¨¡å¼" class="headerlink" title="è¡Œä¸ºå‹æ¨¡å¼"></a>è¡Œä¸ºå‹æ¨¡å¼</h2><blockquote><p>Behavioral design patterns are concerned with algorithms and the assignment of responsibilities between objects.</p><p>è¡Œä¸ºæ¨¡å¼è´Ÿè´£å¯¹è±¡é—´çš„é«˜æ•ˆæ²Ÿé€šå’ŒèŒè´£å§”æ´¾</p></blockquote><p>å¯¹äºæµç¨‹å›¾å¼è§„åˆ™ï¼Œæˆ‘è®¤ä¸ºæ˜¯è¡Œä¸ºæ¨¡å¼çš„æ‰©å±•ï¼Œå°†åˆ†æ”¯ç»„ä»¶é€‰æ‹©åŒæ ·è¿›è¡Œäº†ç»„ä»¶åŒ–</p><h3 id="ç­–ç•¥"><a href="#ç­–ç•¥" class="headerlink" title="ç­–ç•¥"></a>ç­–ç•¥</h3><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F.drawio.png" class="" title="ç­–ç•¥æ¨¡å¼.drawio"><p>ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä»è€Œä½¿å¾—ç®—æ³•å¯ä»¥ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯è€Œå˜åŒ–</p><p>ç­–ç•¥æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>åœ¨äºå®ƒå¯ä»¥æé«˜ä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å®ƒå¯ä»¥ä½¿å¾—ç®—æ³•ä¸å®¢æˆ·ç«¯åˆ†ç¦»ï¼Œä»è€Œä½¿å¾—å®¢æˆ·ç«¯ä¸éœ€è¦äº†è§£ç®—æ³•çš„å…·ä½“å®ç°ç»†èŠ‚</li><li>ç­–ç•¥å¯¹è±¡å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°åˆ‡æ¢ï¼Œä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®ä¸åŒçš„æƒ…å†µé€‰æ‹©ä¸åŒçš„ç­–ç•¥å¯¹è±¡ï¼Œä»è€Œå®ç°æ›´åŠ çµæ´»çš„ç®—æ³•ç»„åˆå’Œé…ç½®</li><li>å°†ä¸åŒè¡Œä¸ºæŠ½å–åˆ°ä¸€ä¸ªç‹¬ç«‹ç±»å±‚æ¬¡ç»“æ„ä¸­ï¼Œ å¹¶å°†åŸå§‹ç±»ç»„åˆæˆåŒä¸€ä¸ªï¼Œ ä»è€Œå‡å°‘é‡å¤ä»£ç ï¼ˆä¾¿äºæ¨¡æ¿ï¼‰</li><li>ç»„åˆä»£æ›¿ç»§æ‰¿</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ— éœ€å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œä¿®æ”¹å°±èƒ½å¤Ÿå¼•å…¥æ–°çš„ç­–ç•¥</li></ul><h3 id="è´£ä»»é“¾"><a href="#è´£ä»»é“¾" class="headerlink" title="è´£ä»»é“¾"></a>è´£ä»»é“¾</h3><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F.drawio.png" class="" title="è´£ä»»é“¾æ¨¡å¼.drawio"><p>è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patternï¼‰é€šè¿‡å°†è¯·æ±‚å‘é€ç»™ä¸€ç³»åˆ—å¤„ç†å¯¹è±¡ï¼Œä½¿å¾—æ¯ä¸ªå¤„ç†å¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œå®ç°è¯·æ±‚çš„å¤„ç†ä¸å‘é€è€…çš„è§£è€¦</p><p>è´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>å°†å¤æ‚çš„å¤„ç†é€»è¾‘åˆ†è§£ä¸ºå¤šä¸ªç®€å•çš„å¤„ç†å¯¹è±¡ï¼Œä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°æ˜“æ‡‚</li><li>å¯ä»¥æ§åˆ¶è¯·æ±‚å¤„ç†çš„é¡ºåº</li><li>æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ï¼Œå¯å¯¹å‘èµ·æ“ä½œå’Œæ‰§è¡Œæ“ä½œçš„ç±»è¿›è¡Œè§£è€¦</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œå¯ä»¥åœ¨ä¸æ›´æ”¹ç°æœ‰ä»£ç çš„æƒ…å†µä¸‹åœ¨ç¨‹åºä¸­æ–°å¢å¤„ç†è€…</li></ul><h3 id="æµæ°´çº¿"><a href="#æµæ°´çº¿" class="headerlink" title="æµæ°´çº¿"></a>æµæ°´çº¿</h3><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%A8%A1%E5%BC%8F.drawio.png" class="" title="æµæ°´çº¿æ¨¡å¼.drawio"><p>ç®¡é“è®¾è®¡æ¨¡å¼ï¼ˆPipeline Patternï¼‰å°†ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªç‹¬ç«‹çš„é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µéƒ½ç”±ä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨æ¥å®Œæˆï¼Œå¹¶ä¸”å¤„ç†å™¨ä¹‹é—´é€šè¿‡ç®¡é“è¿›è¡Œè¿æ¥ï¼Œä»è€Œå½¢æˆä¸€ä¸ªå¤„ç†æµç¨‹</p><p>æµæ°´çº¿æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>å°†å¤æ‚çš„ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªç‹¬ç«‹çš„é˜¶æ®µ</li><li>æµç¨‹ç¼–æ’ï¼Œå¯ä»¥å¤ç”¨é€»è¾‘èŠ‚ç‚¹</li><li>æé«˜ä»£ç çš„å¯é‡ç”¨æ€§å’Œå¯æµ‹è¯•æ€§ï¼Œå› ä¸ºæ¯ä¸ªå¤„ç†å™¨éƒ½å¯ä»¥å•ç‹¬æµ‹è¯•å’Œè°ƒè¯•</li><li>å¯ä»¥åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ï¼Œæé«˜ä»£ç çš„å¹¶å‘æ€§èƒ½</li></ul><h1 id="æ ¸å¿ƒèƒ½åŠ›"><a href="#æ ¸å¿ƒèƒ½åŠ›" class="headerlink" title="æ ¸å¿ƒèƒ½åŠ›"></a>æ ¸å¿ƒèƒ½åŠ›</h1><p>è¿™é‡Œåˆ—ä¸¾äº†ä¸€äº›è§„åˆ™å¼•æ“çš„æ ¸å¿ƒæœºåˆ¶</p><p>å¯¹äº Drools æ”¯æŒçš„èƒ½åŠ›ä¸»è¦ç»“åˆæ–‡æ¡£è¿›è¡Œç®€å•çš„ä»‹ç»ï¼Œå¯¹äº LiteFlow ç­‰æ”¯æŒçš„èƒ½åŠ›ä¼šç»“åˆæºç </p><h2 id="è§„åˆ™ç¼–æ’"><a href="#è§„åˆ™ç¼–æ’" class="headerlink" title="è§„åˆ™ç¼–æ’"></a>è§„åˆ™ç¼–æ’</h2><p>Drools ä½¿ç”¨äº† RETE ç®—æ³•çš„å˜ä½“ Phreak æ¥åšä¸ºè§„åˆ™ç®—æ³•</p><p>LiteFlow ä½¿ç”¨äº† alibaba å¼€æºçš„ QLExpress ä½œä¸ºè§„åˆ™çš„è§£æå·¥å…·ï¼ˆQLExpress ä¹Ÿæ˜¯ä¸€æ¬¾è¡¨è¾¾å¼å¼•æ“ï¼Œæˆ–è€…è¯´æ˜¯è„šæœ¬è¯­è¨€ï¼‰</p><p><a href="https://github.com/alibaba/QLExpress">alibaba&#x2F;QLExpress: QLExpress is a powerful, lightweight, dynamic language for the Java platform aimed at improving developersâ€™ productivity in different business scenes. (github.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExpressRunner</span> <span class="variable">runner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressRunner</span>();</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">DefaultContext</span>&lt;String, Object&gt;();</span><br><span class="line">context.put(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">context.put(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>);</span><br><span class="line">context.put(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">express</span> <span class="operator">=</span> <span class="string">&quot;a + b * c&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">r</span> <span class="operator">=</span> runner.execute(express, context, <span class="literal">null</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">System.out.println(r);</span><br></pre></td></tr></table></figure><p>å› ä¸º QLExpress è¿˜æ”¯æŒæ‰©å±•æ“ä½œç¬¦ï¼Œæ‰€ä»¥è¢« LiteFlow ç”¨æ¥è§£æå…¶ DSL å®šä¹‰çš„è§„åˆ™</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nodes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.ACmp&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;b&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.BCmp&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;c&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.CCmp&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;d&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.DCmp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nodes</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            a, b, WHEN(c,d)</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">flow:</span></span><br><span class="line">  <span class="attr">nodes:</span></span><br><span class="line">    <span class="attr">node:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">a</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.ACmp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">b</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.BCmp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">c</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.CCmp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">d</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.DCmp</span></span><br><span class="line">  <span class="attr">chain:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chain1</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;THEN(a, b, WHEN(c, d))&quot;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„ EL <code>THEN(a, b, WHEN(c, d))</code> éƒ½æ˜¯äº¤ç”± QLExpress è¿›è¡Œå¤„ç†</p><hr><p>LiteFlowChainELBuilder#setEL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LiteFlowChainELBuilder <span class="title function_">setEL</span><span class="params">(String elStr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (StrUtil.isBlank(elStr)) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">errMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;no content in this chain[&#123;&#125;]&quot;</span>, chain.getChainId());</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowSystemException</span>(errMsg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; errorList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line">                </span><br><span class="line"><span class="comment">// è§£æ el æˆä¸ºä¸€ä¸ª Condition</span></span><br><span class="line"><span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> (Condition) EXPRESS_RUNNER.execute(elStr, context, errorList, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™æ€æˆå‘˜ <code>EXPRESS_RUNNER</code> å³ä¸º QLExpress æä¾›çš„ <code>ExpressRunner</code> å®ä¾‹</p><p>åœ¨é™æ€ä»£ç å—ä¸­åˆå§‹åŒ–æ‰©å±•æ“ä½œç¬¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ELè§£æå¼•æ“</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ExpressRunner</span> <span class="variable">EXPRESS_RUNNER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressRunner</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–QLExpressçš„Runner</span></span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.THEN, <span class="keyword">new</span> <span class="title class_">ThenOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.WHEN, <span class="keyword">new</span> <span class="title class_">WhenOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.SWITCH, <span class="keyword">new</span> <span class="title class_">SwitchOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.PRE, <span class="keyword">new</span> <span class="title class_">PreOperator</span>());</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ‰©å±•æ“ä½œç¬¦çš„å®ç°å°±æ˜¯æ„å»º LiteFlow æœ€ç»ˆçš„èŠ‚ç‚¹æŠ½è±¡ <code>Executable</code> çš„æŠ½è±¡å®ç° <code>Condition</code></p><p><code>BaseOperator</code> ä¸ºäº†å¼ºåŒ– <code>executeInner</code> æ–¹æ³•ï¼Œä¼šæ•è·æŠ›å‡ºçš„ <code>QLException</code> å¼‚å¸¸ï¼Œè¾“å‡ºå‹å¥½çš„é”™è¯¯æç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThenOperator</span> <span class="keyword">extends</span> <span class="title class_">BaseOperator</span>&lt;ThenCondition&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ThenCondition <span class="title function_">build</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">OperatorHelper.checkObjectSizeGtZero(objects);</span><br><span class="line"></span><br><span class="line"><span class="type">ThenCondition</span> <span class="variable">thenCondition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThenCondition</span>();</span><br><span class="line"><span class="keyword">for</span> (Object obj : objects) &#123;</span><br><span class="line">thenCondition.addExecutable(OperatorHelper.convert(obj, Executable.class));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> thenCondition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°±åˆ°äº†è§„åˆ™å¯¹è±¡å°è£…çš„ä¸‰ä¸ªç±»å‹</p><ul><li>Executable<ul><li>Conditionï¼šæ¡ä»¶å¯¹è±¡ï¼Œæ ¸å¿ƒå±æ€§ <code>executableGroup</code>ï¼ŒæŒæœ‰ <code>Executable</code> Map</li><li>Chainï¼šè§„åˆ™é“¾å¯¹è±¡ï¼Œæ ¸å¿ƒå±æ€§ <code>conditionList</code>ï¼ŒæŒæœ‰ <code>Condition</code> é›†åˆ</li><li>Nodeï¼šNode èŠ‚ç‚¹ï¼Œæ ¸å¿ƒå±æ€§ <code>NodeComponent</code>ï¼Œæ‰æ˜¯ç»„ä»¶æ‰§è¡Œçš„æ ¸å¿ƒ</li></ul></li></ul><p>æœ€ç»ˆåœ¨ <code>FlowExecutor</code> æ‰§è¡Œä¸­è·å– <code>Chain</code> ä¸ºå…¥å£ï¼Œè¿›è¡Œæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">chain = FlowBus.getChain(chainId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNull(chain)) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;[&#123;&#125;]:couldn&#x27;t find chain with the id[&#123;&#125;]&quot;</span>, slot.getRequestId(),</span><br><span class="line">chainId);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChainNotFoundException</span>(errorMsg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰§è¡Œchain</span></span><br><span class="line">chain.execute(slotIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¹¶å‘ç¼–æ’"><a href="#å¹¶å‘ç¼–æ’" class="headerlink" title="å¹¶å‘ç¼–æ’"></a>å¹¶å‘ç¼–æ’</h2><p>LiteFlow ä¸­çš„æµç¨‹å›¾å¼è§„åˆ™è¡¨è¾¾å¤©ç„¶æ”¯æŒçµæ´»åœ°å¯¹æ‰§è¡Œä»»åŠ¡è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œä½¿ç”¨å…³é”®è¯ <code>WHEN</code> è¿›è¡Œè¡¨è¾¾</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">    THEN(</span><br><span class="line">        a,</span><br><span class="line">        WHEN(b, c, d),</span><br><span class="line">        e</span><br><span class="line">    );</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¡¨ç¤ºä¸²è¡Œæ‰§è¡ŒèŠ‚ç‚¹ aï¼Œéšåå¹¶è¡Œæ‰§è¡ŒèŠ‚ç‚¹ bã€cã€dï¼Œæœ€åç»§ç»­ä¸²è¡Œæ‰§è¡ŒèŠ‚ç‚¹ e</p><p>åŒæ—¶æ‹¥æœ‰ä¸€äº›æ‹“å±•åŠŸèƒ½ï¼š</p><ul><li>å¿½ç•¥é”™è¯¯ï¼š<code>WHEN(b, c, d).ignoreError(true)</code> å½“ bã€cã€d èŠ‚ç‚¹å‡ºç°å¼‚å¸¸æ—¶è¿›è¡Œå¿½ç•¥</li><li>ä»»æ„æ‰§è¡ŒæˆåŠŸï¼š<code>WHEN(b, THEN(c, d), e).any(true)</code> å½“ bã€å¹¶è¡Œçš„ c å’Œ dã€e ä»»æ„æ‰§è¡ŒæˆåŠŸåˆ™ç»§ç»­å‘ä¸‹æ‰§è¡Œ</li><li>åˆ†ç»„ï¼š<code>THEN(WHEN(a, b),WHEN(c, d))</code> å…³é”®è¯ <code>WHEN</code> å¤©ç„¶å…·æœ‰åˆ†ç»„æ¦‚å¿µ</li></ul><hr><p>å¹¶å‘çš„ç¬¬ä¸€æ­¥ï¼Œæ•´ä¸ªè§„åˆ™è¢«åŒ…è£…ä¸º <code>WhenCondition</code> å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhenCondition</span> <span class="keyword">extends</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªåœ¨whenç±»å‹ä¸‹æœ‰æ•ˆï¼Œä»¥åŒºåˆ†å½“whenè°ƒç”¨é“¾è°ƒç”¨å¤±è´¥æ—¶æ˜¯å¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œ é»˜è®¤falseä¸ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">ignoreError</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªåœ¨whenç±»å‹ä¸‹æœ‰æ•ˆï¼Œä¸ºtrueçš„è¯è¯´æ˜åœ¨å¤šä¸ªå¹¶è¡ŒèŠ‚ç‚¹ä¸‹ï¼Œä»»æ„ä¸€ä¸ªæˆåŠŸï¼Œæ•´ä¸ªwhenå°±æˆåŠŸ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">any</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// when å•ç‹¬çš„çº¿ç¨‹æ± åç§°</span></span><br><span class="line"><span class="keyword">private</span> String threadExecutorClass;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeCondition</span><span class="params">(Integer slotIndex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">executeAsyncCondition(slotIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹è±¡ä¸­åŒ…æ‹¬ <code>WHEN</code> è§„åˆ™ç›¸å…³çš„å±æ€§ï¼Œä»¥åŠå…³é”®çš„ <code>executeCondition</code> å®ç°</p><p>å®ç°ä¸­è°ƒç”¨äº† <code>executeAsyncCondition</code></p><p><code>executeAsyncCondition</code> ä»£ç æ¯”è¾ƒé•¿ï¼Œæ¦‚æ‹¬åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ol><li>æ‹¿åˆ° <code>Condition</code> ä¸‹çš„å¯æ‰§è¡Œå…ƒç´ çš„é›†åˆ <code>executableGroup</code>ï¼Œè¿‡æ»¤æ‰å‰åç½®ç»„ä»¶ï¼ˆ<code>PreCondition</code> å’Œ <code>FinallyCondition</code>ï¼‰ä»¥åŠ <code>Node</code> çš„ <code>isAccess</code> ä¸º false çš„èŠ‚ç‚¹ï¼ˆè¿™é‡Œæ˜¯ä¸ºäº†å¤„ç†ä¸€ä¸ª bug issueï¼š<a href="https://gitee.com/dromara/liteFlow/issues/I4XRBA">å…³äºwhenå’Œthenæ··åˆä½¿ç”¨æ—¶(æœ‰anyå’ŒisAccessçš„æƒ…å†µä¸‹)ï¼Œthençš„èŠ‚ç‚¹å…ˆæ‰§è¡Œçš„é—®é¢˜ Â· Issue #I4XRBA Â· dromara&#x2F;liteFlow - Gitee.com</a>ï¼‰</li><li>ä½¿ç”¨ <code>ScheduledThreadPoolExecutor</code> å®ç° <code>CompletableFuture</code> å¼‚æ­¥å¤„ç†è¶…æ—¶ï¼Œå°† <code>Executable</code> æ•°æ®åŒ…è£…ä¸º <code>ParallelSupplier</code>ï¼Œè°ƒç”¨ <code>CompletableFuture.supplyAsync</code></li><li>æ ¹æ® <code>any</code> å‚æ•°ä½¿ç”¨ <code>CompletableFuture.anyOf</code> æˆ– <code>CompletableFuture.allOf</code>ï¼Œæ‹¿åˆ°å°è£…æµç¨‹åçš„ <code>resultCompletableFuture</code></li><li>æ‰§è¡Œ <code>resultCompletableFuture.get</code> è¿›è¡Œé˜»å¡ï¼Œcatch <code>InterruptedException</code></li><li>æ‹¿åˆ°å·²ç»å®Œæˆçš„ç»“æœï¼Œå¯¹æœªå®Œæˆçš„ä»»åŠ¡è¿›è¡Œè¿‡æ»¤ï¼ˆå¦‚æœ <code>any</code> ä¸º trueï¼Œé‚£ä¹ˆè¿™é‡Œæ‹¿åˆ°çš„æ˜¯ç¬¬ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡ï¼‰</li><li>è¿‡æ»¤å‡ºè¶…æ—¶çš„ä»»åŠ¡ï¼Œè¾“å‡ºè¶…æ—¶æ—¥å¿—</li><li>æ ¹æ®å‚æ•° <code>isIgnoreError</code>ï¼Œå¤„ç† <code>InterruptedException</code>ï¼›éå† <code>CompletableFuture</code> çš„è¿”å›å€¼ï¼Œå¦‚æœå¼‚æ­¥æ‰§è¡Œå¤±è´¥ï¼Œåˆ™æŠ›å‡ºç›¸åº”çš„ä¸šåŠ¡å¼‚å¸¸</li></ol><h2 id="æ‰§è¡Œç»„ä»¶"><a href="#æ‰§è¡Œç»„ä»¶" class="headerlink" title="æ‰§è¡Œç»„ä»¶"></a>æ‰§è¡Œç»„ä»¶</h2><p>Drools ä¸­æ²¡æœ‰ç»„ä»¶çš„æ¦‚å¿µï¼Œä½†æ˜¯æ¯ä¸ªè§„åˆ™è¡¨è¾¾ä¸­ <code>then</code> éƒ¨åˆ†ç›´æ¥è°ƒç”¨ Java ä»£ç æˆ–è€…ç”± MVEL æˆ– Java å®šä¹‰æ‰§è¡Œé€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.User;</span><br><span class="line"><span class="keyword">import</span> com.example.Product;</span><br><span class="line"><span class="keyword">import</span> com.example.ProductRecommendationService;</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Recommendation Rule&quot;</span></span><br><span class="line">when</span><br><span class="line">  <span class="comment">// ç»‘å®šäº‹å®å¯¹è±¡</span></span><br><span class="line">    $user : User( $userId : userId, $history : purchaseHistory, $prefs : preferences )</span><br><span class="line">    $product : Product( $productId : productId, $categories : categories, $price : price )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†…ç½®å‡½æ•°</span></span><br><span class="line">    exists( String( <span class="built_in">this</span> == $categories ) from $prefs ) <span class="comment">// å•†å“æ‰€å±çš„æŸä¸ªç±»åˆ«åœ¨ç”¨æˆ·åå¥½ä¸­å­˜åœ¨</span></span><br><span class="line">    not ( String( <span class="built_in">this</span> == $productId ) from $history ) <span class="comment">// ç”¨æˆ·æœªè´­ä¹°è¿‡è¯¥å•†å“</span></span><br><span class="line">then</span><br><span class="line">    <span class="comment">// æ‰§è¡Œé€»è¾‘</span></span><br><span class="line">    ProductRecommendationService.recommendProduct($userId, $productId);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>LiteFlow ä¸­çš„ç»„ä»¶ç”± Java ä»£ç ç¼–å†™ï¼ˆä¹Ÿå¯ä»¥è„šæœ¬ç»„ä»¶ï¼‰ï¼Œå¯ä»¥ä½œä¸º bean æ¥å…¥ Spring</p><p><code>FlowParse</code> åŠå…¶å®ç°</p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/FlowParser.png" class="" title="FlowParser"><p><code>FlowExecutor</code> çš„ <code>init</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¥æ‰¾å¯¹åº”è§£æå™¨</span></span><br><span class="line">parser = FlowParserProvider.lookup(path);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FlowParserProvider.lookup</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> FlowParser <span class="title function_">lookup</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ç±»å¿…é¡»å®ç°ä»¥ä¸Šå®ç°ç±»ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line"><span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;can&#x27;t support the format &#123;&#125;&quot;</span>, path);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> (isLocalConfig(path)) &#123;</span><br><span class="line"><span class="comment">// éå†æšä¸¾ map æ‰¾åˆ°å¯¹åº” factory</span></span><br><span class="line">Predicate&lt;String&gt; dictKey = LOCAL_PARSER_DICT.keySet()</span><br><span class="line">.stream()</span><br><span class="line">.filter(key -&gt; key.test(path))</span><br><span class="line">.findFirst()</span><br><span class="line">.orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ErrorSupportPathException</span>(errorMsg));</span><br><span class="line"></span><br><span class="line">LOG.info(<span class="string">&quot;flow info loaded from local file,path=&#123;&#125;&quot;</span>, path);</span><br><span class="line"><span class="keyword">return</span> LOCAL_PARSER_DICT.get(dictKey).apply(path);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><code>NodeType</code> èŠ‚ç‚¹ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">NodeTypeEnum</span> &#123;</span><br><span class="line">COMMON(<span class="string">&quot;common&quot;</span>, <span class="string">&quot;æ™®é€š&quot;</span>, <span class="literal">false</span>, NodeComponent.class),</span><br><span class="line">SWITCH(<span class="string">&quot;switch&quot;</span>, <span class="string">&quot;é€‰æ‹©&quot;</span>, <span class="literal">false</span>, NodeSwitchComponent.class),</span><br><span class="line">IF(<span class="string">&quot;if&quot;</span>, <span class="string">&quot;æ¡ä»¶&quot;</span>, <span class="literal">false</span>, NodeIfComponent.class),</span><br><span class="line">FOR(<span class="string">&quot;for&quot;</span>, <span class="string">&quot;å¾ªç¯æ¬¡æ•°&quot;</span>, <span class="literal">false</span>, NodeForComponent.class),</span><br><span class="line">WHILE(<span class="string">&quot;while&quot;</span>, <span class="string">&quot;å¾ªç¯æ¡ä»¶&quot;</span>, <span class="literal">false</span>, NodeWhileComponent.class),</span><br><span class="line">BREAK(<span class="string">&quot;break&quot;</span>, <span class="string">&quot;å¾ªç¯è·³å‡º&quot;</span>, <span class="literal">false</span>, NodeBreakComponent.class),</span><br><span class="line">ITERATOR(<span class="string">&quot;iterator&quot;</span>, <span class="string">&quot;å¾ªç¯è¿­ä»£&quot;</span>, <span class="literal">false</span>, NodeIteratorComponent.class),</span><br><span class="line">SCRIPT(<span class="string">&quot;script&quot;</span>, <span class="string">&quot;è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptCommonComponent.class),</span><br><span class="line">SWITCH_SCRIPT(<span class="string">&quot;switch_script&quot;</span>, <span class="string">&quot;é€‰æ‹©è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptSwitchComponent.class),</span><br><span class="line">IF_SCRIPT(<span class="string">&quot;if_script&quot;</span>, <span class="string">&quot;æ¡ä»¶è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptIfComponent.class),</span><br><span class="line">FOR_SCRIPT(<span class="string">&quot;for_script&quot;</span>, <span class="string">&quot;å¾ªç¯æ¬¡æ•°è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptForComponent.class),</span><br><span class="line">WHILE_SCRIPT(<span class="string">&quot;while_script&quot;</span>, <span class="string">&quot;å¾ªç¯æ¡ä»¶è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptWhileComponent.class),</span><br><span class="line">BREAK_SCRIPT(<span class="string">&quot;break_script&quot;</span>, <span class="string">&quot;å¾ªç¯è·³å‡ºè„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptBreakComponent.class);</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ•´ä½“æµç¨‹ï¼š</p><ol><li>æ–‡ä»¶è§£æï¼ˆXMLã€JSONï¼‰</li><li><code>NodePropBean</code> åŒ…è£…</li><li>buildNodeï¼ŒFlowBus æ·»åŠ èŠ‚ç‚¹å…ƒæ•°æ®<ul><li>å¦‚æœæ˜¯å£°æ˜å¼ç»„ä»¶ï¼ŒSpring ç¯å¢ƒä¸‹å·²ç»æ˜¯ä»£ç†å¯¹è±¡åˆ™ä¸å¤„ç†ï¼Œé Spring ç¯å¢ƒæ‰§è¡Œ <code>LiteFlowProxyUtil.proxy2NodeComponent</code></li><li>é…ç½®ç»„ä»¶ï¼Œnew Instance</li></ul></li><li>è„šæœ¬ç»„ä»¶ï¼ŒåŠ è½½ script è„šæœ¬</li></ol><h2 id="è„šæœ¬ç»„ä»¶"><a href="#è„šæœ¬ç»„ä»¶" class="headerlink" title="è„šæœ¬ç»„ä»¶"></a>è„šæœ¬ç»„ä»¶</h2><p>åœ¨ Drools ä¸­æœ¬èº«çš„è§„åˆ™è¡¨è¾¾å°±æ˜¯ Drools å®šä¹‰çš„ç±» Java è¯­æ³•ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒ DMN çš„ FEEL ç­‰è¯­æ³•ï¼Œç›¸å½“äºè„šæœ¬è¯­è¨€</p><p>åœ¨ LiteFlow ä¸­æ”¯æŒå¤šç§è„šæœ¬è¯­è¨€æ¥å®šä¹‰ç»„ä»¶ï¼š</p><ul><li>Groovy</li><li>Javascript</li><li>QLExpress</li><li>Python</li><li>Lua</li><li>Aviator</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nodes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;s1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;æ™®é€šè„šæœ¬&quot;</span> <span class="attr">type</span>=<span class="string">&quot;script&quot;</span> <span class="attr">language</span>=<span class="string">&quot;groovy&quot;</span>&gt;</span></span><br><span class="line">            &lt;![CDATA[</span><br><span class="line">                def a=3;</span><br><span class="line">                def b=2;</span><br><span class="line">                defaultContext.setData(&quot;s1&quot;,a*b);</span><br><span class="line">            ]]&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nodes</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">        THEN(a);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>NodeComponent</code> å®ç°ç±» <code>loadScript</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScriptCommonComponent</span> <span class="keyword">extends</span> <span class="title class_">NodeComponent</span> <span class="keyword">implements</span> <span class="title class_">ScriptComponent</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="type">ScriptExecuteWrap</span> <span class="variable">wrap</span> <span class="operator">=</span> <span class="built_in">this</span>.buildWrap(<span class="built_in">this</span>);</span><br><span class="line">ScriptExecutorFactory.loadInstance().getScriptExecutor(<span class="built_in">this</span>.getRefNode().getLanguage()).execute(wrap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadScript</span><span class="params">(String script, String language)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;load script for component[&#123;&#125;]&quot;</span>, getDisplayName());</span><br><span class="line">ScriptExecutorFactory.loadInstance().getScriptExecutor(language).load(getNodeId(), script);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ScriptExecutorFactory.loadInstance().getScriptExecutor(language).load(getNodeId(), script)</code> ä¸»è¦è·å–äº† <code>ScriptExecutor</code> çš„å®ç°</p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/ScriptExecutor.png" class="" title="ScriptExecutor"><p>groovy çš„ ScriptEngine ç”± groovy-jsr223 ä¾èµ–æä¾› <code>org.codehaus.groovy.jsr223GroovyScriptEngineImpl</code></p><p>æœ€ç»ˆç¼–è¯‘ä¸º <code>CompiledScript</code> å®ç°ï¼Œå­˜å‚¨è‡³ <code>compiledScriptMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">JSR223ScriptExecutor</span> <span class="keyword">extends</span> <span class="title class_">ScriptExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ScriptEngine scriptEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CompiledScript&gt; compiledScriptMap = <span class="keyword">new</span> <span class="title class_">CopyOnWriteHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p>æ€è€ƒï¼š</p><ul><li>ä¸šåŠ¡ä¸­åº”è¯¥æœ‰å¤šå°‘è„šæœ¬ã€è¡¨è¾¾å¼å¼•æ“çš„åº”ç”¨ï¼Ÿ</li><li>ä»€ä¹ˆåœºæ™¯é€‚åˆ or ä¸é€‚åˆï¼Ÿ</li></ul><p>XXL-Job æ”¯æŒçš„ GLUE æ¨¡å¼</p><p><a href="https://www.xuxueli.com/xxl-job/#3.3%20GLUE%E6%A8%A1%E5%BC%8F(Java)">XXL-JOB 3.3-GLUEæ¨¡å¼(Java)</a></p></blockquote><h2 id="è§„åˆ™çƒ­æ›´æ–°"><a href="#è§„åˆ™çƒ­æ›´æ–°" class="headerlink" title="è§„åˆ™çƒ­æ›´æ–°"></a>è§„åˆ™çƒ­æ›´æ–°</h2><p>è§„åˆ™é…ç½®çš„çƒ­æ›´æ–°æ˜¯è§„åˆ™åŒ–çš„é‡è¦ä¼˜åŠ¿ï¼Œç‰¹åˆ«æ˜¯å¾ˆå¤šæˆç†Ÿçš„è§„åˆ™å¼•æ“éƒ½æä¾›äº† GUI åå°</p><p>Drools æ”¯æŒçš„è§„åˆ™è¯»å–æ–¹å¼ï¼š</p><ul><li><code>KieClasspathContainer</code> é¡¹ç›® resource æ–‡ä»¶</li><li><code>KieBuilder</code> é¡¹ç›®å¤–æ–‡ä»¶</li><li><code>KieScanner</code> ä»“åº“ jar åŒ…ï¼ˆWorkbenchï¼‰</li></ul><p>Drools çš„æ›´æ–°æ–¹å¼ï¼š</p><ul><li>ä½¿ç”¨ <code>KieContainerImpl.updateToKieModule</code></li><li>åˆ›å»ºæ–°çš„ <code>KieContainer</code></li><li>ä½¿ç”¨ <code>InternalKnowledgeBase</code> çš„ APIï¼›ç²’åº¦æ›´ç»†ï¼Œæ³¨æ„è§„åˆ™åˆ‡æ¢éåŸå­æ€§å¸¦æ¥çš„å½±å“</li></ul><p>LiteFlow çš„è§„åˆ™æœ¬è´¨æ˜¯ä¸€ä¸ªæ‰§è¡Œé“¾ï¼ˆ<code>Chain</code> å’Œ <code>Condition</code>ï¼‰ï¼Œåœ¨æ‰§è¡Œæ—¶ä¼š copy å‡ºä¸€ä»½æ–°çš„æ‰§è¡Œé“¾å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹äºè§„åˆ™çš„çƒ­æ›´æ–°åº”è¯¥æ˜¯å¤©ç„¶æ”¯æŒå¹³æ»‘çš„</p><blockquote><p>å³ä½ å¯ä»¥åœ¨ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œè§„åˆ™çš„é‡è½½</p><p>å¹¶ä¸”åœ¨é«˜å¹¶å‘ä¸‹åˆ·æ–°çš„æ—¶å€™ï¼Œæ­£åœ¨æ‰§è¡Œæµç¨‹çš„çº¿ç¨‹æ˜¯å®Œå…¨å¹³æ»‘çš„ï¼Œä¸ä¼šå› ä¸ºåˆ·æ–°çš„è¿‡ç¨‹è€Œå‡ºç°ä¸­æ–­çš„ç°è±¡</p><p>åœ¨åˆ·æ–°æ—¶ï¼Œæ­£åœ¨æ‰§è¡Œçš„æµç¨‹è¿˜æ˜¯èµ°çš„æ—§çš„æµç¨‹ï¼›åˆ·æ–°å¥½ï¼Œåç»­ request ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°çš„æµç¨‹</p></blockquote><p>LiteFlow è§„åˆ™æ›´æ–°çš„æ–¹å¼ï¼š</p><ul><li><p>åœ¨ Spring å®¹å™¨ä¸­æ‹¿åˆ° <code>FlowExecutor</code> å¯¹è±¡è°ƒç”¨ <code>flowExecutor.reloadRule()</code></p></li><li><p>æŒ‡å®šåˆ·æ–°æŸä¸€ä¸ª Chain çš„è§„åˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LiteFlowChainELBuilder.createChain().setChainName(<span class="string">&quot;chain2&quot;</span>).setEL(</span><br><span class="line">  <span class="string">&quot;THEN(a, b, WHEN(c, d))&quot;</span></span><br><span class="line">).build();</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®æ”¾åœ¨ä¸­é—´ä»¶ï¼Œåˆ©ç”¨ä¸­é—´ä»¶çš„é…ç½®ç›‘å¬æœºåˆ¶è¿›è¡Œæ›´æ–°</p><ul><li>ZK</li><li>Etcd</li><li>SQLï¼ˆJava.sqlï¼‰</li><li>Nacos</li><li>Apollo</li></ul></li></ul><p>æ ¸å¿ƒåŸç†å°±æ˜¯å®šä¹‰å„è‡ªæ•°æ®æºçš„ <code>Parse</code>ï¼Œåœ¨è§£ææ–¹æ³•ä¸­æ‰§è¡Œç›‘å¬æ“ä½œã€æŒ‚è½½ç›‘å¬ç›¸å…³çš„å›è°ƒ</p><p>ï¼ˆä¸è¿‡æˆ‘å‘ç°å¯¹äºè¿œç¨‹è§„åˆ™çš„é…ç½®éƒ½æ˜¯å…¨é‡åˆ·æ–°ï¼Œç›¸å½“äºæ¯æ¬¡å˜æ›´é‡æ–°åŠ è½½æ•´ä¸ªè§„åˆ™æ–‡ä»¶ï¼Œä¸åƒæœ¬åœ°è§„åˆ™æ–‡ä»¶ä¸€æ ·å¯ä»¥é…ç½®å¤šä¸ªï¼Ÿï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosXmlELParser</span> <span class="keyword">extends</span> <span class="title class_">ClassXmlFlowELParser</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NacosParserHelper helper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">NacosXmlELParser</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> LiteflowConfigGetter.get();</span><br><span class="line">    <span class="comment">// è·å–é…ç½®åˆå§‹åŒ–å®¢æˆ·ç«¯</span></span><br><span class="line">    ...</span><br><span class="line">    helper = <span class="keyword">new</span> <span class="title class_">NacosParserHelper</span>(nacosParserVO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">parseCustom</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é‡æ–° parse</span></span><br><span class="line">Consumer&lt;String&gt; parseConsumer = t -&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">parse(t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> helper.getContent();</span><br><span class="line">helper.checkContent(content);</span><br><span class="line">        <span class="comment">// ç›‘å¬</span></span><br><span class="line">helper.listener(parseConsumer);</span><br><span class="line"><span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NacosException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬åœ°æ–‡ä»¶ç›‘å¬ä½¿ç”¨äº† Apache  <code>commons.io</code> çš„ <code>FileAlterationMonitor</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">observer.addListener(<span class="keyword">new</span> <span class="title class_">FileAlterationListenerAdaptor</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileChange</span><span class="params">(File file)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;file modify,filePath=&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">        FlowExecutorHolder.loadInstance().reloadRule();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileDelete</span><span class="params">(File file)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;file delete,filePath=&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">        FlowExecutorHolder.loadInstance().reloadRule();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p> <code>reloadRule</code> æ“ä½œçš„æœ¬è´¨æ˜¯é‡æ–°è¿›è¡Œ <code>FlowExecutor</code> çš„ <code>init</code> æ“ä½œï¼Œçœ‹èµ·æ¥ä¹Ÿæ˜¯ç›´æ¥åˆ·æ–°æ‰€æœ‰æ–‡ä»¶è§„åˆ™ï¼Œç²’åº¦è¾ƒç²—</p><h2 id="å†³ç­–æ§åˆ¶"><a href="#å†³ç­–æ§åˆ¶" class="headerlink" title="å†³ç­–æ§åˆ¶"></a>å†³ç­–æ§åˆ¶</h2><p>Drools åœ¨é¢å¯¹å¤§é‡è§„åˆ™æ—¶æ›´å¥½çš„è§„åˆ’å‘½ä¸­çš„è§„åˆ™ï¼ˆè§„åˆ™å†²çªã€ä¼˜å…ˆçº§ã€å¾ªç¯ç­‰ï¼‰ï¼Œæ”¯æŒè§„åˆ™ä¸‹ä¸€äº›å‚æ•°æ§åˆ¶åŒ¹é…è§„åˆ™çš„è¡Œä¸º Execution control in the Drools engine</p><p>åœ¨ Java åº”ç”¨ç¨‹åºä¸­ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>fireAllRules</code> åï¼ŒDrools å¼•æ“ä¼šåœ¨ä¸¤ä¸ªé˜¶æ®µé‡å¤å¾ªç¯ï¼š</p><ul><li><strong>äº‹é¡¹è¯„ä¼°</strong>ï¼ˆAgenda evaluationï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼ŒDrools å¼•æ“é€‰æ‹©æ‰€æœ‰å¯ä»¥æ‰§è¡Œçš„è§„åˆ™ï¼›å¦‚æœä¸å­˜åœ¨å¯æ‰§è¡Œè§„åˆ™ï¼Œåˆ™æ‰§è¡Œå‘¨æœŸç»“æŸï¼›å¦‚æœæ‰¾åˆ°äº†å¯æ‰§è¡Œè§„åˆ™ï¼ŒDrools å¼•æ“ä¼šåœ¨è®®ç¨‹ä¸­æ³¨å†Œæ¿€æ´»ï¼Œç„¶åè¿›å…¥å·¥ä½œå†…å­˜è¡Œä¸ºé˜¶æ®µï¼Œæ‰§è¡Œè§„åˆ™åæœæ“ä½œ</li><li><strong>å·¥ä½œå†…å­˜è¡Œä¸º</strong>ï¼ˆWorking memory actionsï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼ŒDrools å¼•æ“ä¸ºä¹‹å‰åœ¨äº‹é¡¹ä¸­æ³¨å†Œçš„æ‰€æœ‰æ¿€æ´»è§„åˆ™æ‰§è¡Œè§„åˆ™åæœæ“ä½œï¼ˆæ¯ä¸ªè§„åˆ™çš„ <code>then</code> è¡Œä¸ºéƒ¨åˆ†ï¼‰ï¼›åœ¨æ‰€æœ‰ç»“æœæ“ä½œå®Œæˆæˆ–ä¸» Java åº”ç”¨ç¨‹åºè¿›ç¨‹å†æ¬¡è°ƒç”¨ <code>fireAllRules</code> åï¼ŒDrools å¼•æ“è¿”å›åˆ°è®®ç¨‹è¯„ä¼°é˜¶æ®µä»¥é‡æ–°è¯„ä¼°è§„åˆ™</li></ul><p><img src="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/HybridReasoning/Two_Phase.png"></p><p>å½“äº‹é¡¹ï¼ˆagendaï¼‰ä¸Šå­˜åœ¨å¤šä¸ªè§„åˆ™æ—¶ï¼Œæ‰§è¡Œä¸€ä¸ªè§„åˆ™å¯èƒ½ä¼šå¯¼è‡´ä»è®®ç¨‹ä¸­åˆ é™¤å¦ä¸€ä¸ªè§„åˆ™ï¼›ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå¯ä»¥å®šä¹‰ Drools å¼•æ“ä¸­æ‰§è¡Œè§„åˆ™çš„æ–¹å¼å’Œæ—¶é—´</p><p><strong>è§„åˆ™ä¼˜å…ˆçº§ Salience for rules</strong></p><p>æ¯ä¸ªè§„åˆ™éƒ½æœ‰ä¸€ä¸ªç¡®å®šæ‰§è¡Œé¡ºåºçš„æ•´æ•°ä¼˜å…ˆçº§å±æ€§ï¼›å½“åœ¨æ¿€æ´»é˜Ÿåˆ—ä¸­æ’åºæ—¶ï¼Œå…·æœ‰è¾ƒé«˜ä¼˜å…ˆçº§å€¼çš„è§„åˆ™è¢«èµ‹äºˆæ›´é«˜çš„æ‰§è¡Œä¼˜å…ˆçº§</p><p>è§„åˆ™çš„é»˜è®¤ä¼˜å…ˆçº§ä¸º 0ï¼Œä½†ä¼˜å…ˆçº§å¯ä»¥è®¾ç½®ä¸ºè´Ÿæ•°æˆ–æ­£æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;RuleA&quot;</span></span><br><span class="line">salience <span class="number">95</span> &lt;-- <span class="built_in">this</span></span><br><span class="line">when</span><br><span class="line">    $fact : MyFact( field1 == <span class="literal">true</span> )</span><br><span class="line">then</span><br><span class="line">    System.out.println(<span class="string">&quot;Rule2 : &quot;</span> + $fact);</span><br><span class="line">    update($fact);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;RuleB&quot;</span></span><br><span class="line">salience <span class="number">100</span></span><br><span class="line">when</span><br><span class="line">   $fact : MyFact( field1 == <span class="literal">false</span> )</span><br><span class="line">then</span><br><span class="line">   System.out.println(<span class="string">&quot;Rule1 : &quot;</span> + $fact);</span><br><span class="line">   $fact.setField1(<span class="literal">true</span>);</span><br><span class="line">   update($fact);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>RuleB è§„åˆ™åˆ—åœ¨ä¸‹é¢ï¼Œä½†å®ƒçš„ä¼˜å…ˆçº§å€¼é«˜äº RuleA è§„åˆ™ï¼Œå› æ­¤é¦–å…ˆæ‰§è¡Œ</p><p><strong>è§„åˆ™äº‹é¡¹ç»„ Agenda groups for rules</strong></p><p>äº‹é¡¹ç»„æ˜¯ç”±åŒä¸€äº‹é¡¹ç»„è§„åˆ™å±æ€§ç»‘å®šåœ¨ä¸€èµ·çš„ä¸€ç»„è§„åˆ™</p><p>åœ¨ä»»ä½•æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªç»„çš„ç„¦ç‚¹ä½¿è¯¥ç»„è§„åˆ™ä¼˜å…ˆäºå…¶ä»–äº‹é¡¹ç»„ä¸­çš„è§„åˆ™æ‰§è¡Œï¼›å¯ä»¥é€šè¿‡å¯¹è®®ç¨‹ç»„çš„ <code>setFocus</code> è°ƒç”¨æ¥ç¡®å®šç„¦ç‚¹</p><p>è¿˜å¯ä»¥å®šä¹‰å…·æœ‰ <code>auto-focus</code> å±æ€§çš„è§„åˆ™ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ¿€æ´»è§„åˆ™æ—¶ï¼Œå°†ç„¦ç‚¹è‡ªåŠ¨åˆ†é…ç»™è§„åˆ™æ‰€åˆ†é…çš„æ•´ä¸ªè®®ç¨‹ç»„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Increase balance for credits&quot;</span></span><br><span class="line">  agenda-group <span class="string">&quot;calculation&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod()</span><br><span class="line">  acc : Account( $accountNo : accountNo )</span><br><span class="line">  CashFlow( type == CREDIT,</span><br><span class="line">            accountNo == $accountNo,</span><br><span class="line">            date &gt;= ap.start &amp;&amp; &lt;= ap.end,</span><br><span class="line">            $amount : amount )</span><br><span class="line">then</span><br><span class="line">  acc.balance  += $amount;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Print balance for AccountPeriod&quot;</span></span><br><span class="line">  agenda-group <span class="string">&quot;report&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod()</span><br><span class="line">  acc : Account()</span><br><span class="line">then</span><br><span class="line">  System.out.println( acc.accountNo +</span><br><span class="line">                      <span class="string">&quot; : &quot;</span> + acc.balance );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œ<code>report</code> äº‹é¡¹ç»„ä¸­çš„è§„åˆ™å¿…é¡»å§‹ç»ˆé¦–å…ˆæ‰§è¡Œï¼Œ<code>calculation</code> äº‹é¡¹ç»„çš„è§„åˆ™å¿…é¡»æ€»æ˜¯å…¶æ¬¡æ‰§è¡Œï¼›ç„¶åå¯ä»¥æ‰§è¡Œå…¶ä»–è®®ç¨‹ç»„ä¸­çš„ä»»ä½•å‰©ä½™è§„åˆ™</p><p>å› æ­¤ï¼Œåœ¨æ‰§è¡Œå…¶ä»–è§„åˆ™ä¹‹å‰ï¼Œ<code>report</code> å’Œ <code>caclulation</code> ç»„å¿…é¡»æŒ‰è¯¥é¡ºåºæ¥æ”¶è¦æ‰§è¡Œçš„ç„¦ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Agenda</span> <span class="variable">agenda</span> <span class="operator">=</span> ksession.getAgenda();</span><br><span class="line">agenda.getAgendaGroup( <span class="string">&quot;report&quot;</span> ).setFocus();</span><br><span class="line">agenda.getAgendaGroup( <span class="string">&quot;calculation&quot;</span> ).setFocus();</span><br><span class="line">ksession.fireAllRules();</span><br></pre></td></tr></table></figure><p><strong>è§„åˆ™æ¿€æ´»ç»„ Activation groups for rules</strong></p><p>æ¿€æ´»ç»„æ˜¯ç”±ç›¸åŒçš„æ¿€æ´»ç»„è§„åˆ™å±æ€§ç»‘å®šåœ¨ä¸€èµ·çš„ä¸€ç»„è§„åˆ™</p><p>åœ¨è¯¥ç»„ä¸­åªèƒ½æ‰§è¡Œä¸€ä¸ªè§„åˆ™ï¼›åœ¨æ»¡è¶³æ‰§è¡Œè¯¥ç»„ä¸­çš„è§„åˆ™çš„æ¡ä»¶åï¼Œå°†ä»äº‹é¡¹ä¸­åˆ é™¤è¯¥æ¿€æ´»ç»„ä¸­çš„æ‰€æœ‰å…¶ä»–æŒ‚èµ·çš„è§„åˆ™æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Print balance for AccountPeriod1&quot;</span></span><br><span class="line">  activation-group <span class="string">&quot;report&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod1()</span><br><span class="line">  acc : Account()</span><br><span class="line">then</span><br><span class="line">  System.out.println( acc.accountNo +</span><br><span class="line">                      <span class="string">&quot; : &quot;</span> + acc.balance );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Print balance for AccountPeriod2&quot;</span></span><br><span class="line">  activation-group <span class="string">&quot;report&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod2()</span><br><span class="line">  acc : Account()</span><br><span class="line">then</span><br><span class="line">  System.out.println( acc.accountNo +</span><br><span class="line">                      <span class="string">&quot; : &quot;</span> + acc.balance );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>åœ¨ç¤ºä¾‹ä¸­æ‰§è¡Œäº† <code>report</code> æ¿€æ´»ç»„ä¸­çš„å…¶ä¸­ä¸€æ¡è§„åˆ™ï¼Œåˆ™ç¬¬äºŒæ¡è§„åˆ™ä¸ä¼šæ‰§è¡Œ</p><p><strong>æ‰§è¡Œæ¨¡å¼å’Œçº¿ç¨‹å®‰å…¨ Rule execution modes and thread safety in the Drools engine</strong></p><ul><li><strong>è¢«åŠ¨æ¨¡å¼</strong>ï¼ˆPassive modeï¼‰ï¼šå½“ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºæ˜¾å¼è°ƒç”¨ <code>fireAllRules</code> æ—¶ï¼ŒDrools å¼•æ“ä¼šè¯„ä¼°è§„åˆ™</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KieSessionConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> KieServices.Factory.get().newKieSessionConfiguration();</span><br><span class="line">config.setOption( ClockTypeOption.get(<span class="string">&quot;pseudo&quot;</span>) );</span><br><span class="line"><span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kbase.newKieSession( conf, <span class="literal">null</span> );</span><br><span class="line"><span class="type">SessionPseudoClock</span> <span class="variable">clock</span> <span class="operator">=</span> session.getSessionClock();</span><br><span class="line"></span><br><span class="line">session.insert( tick1 );</span><br><span class="line">session.fireAllRules();</span><br><span class="line"></span><br><span class="line">clock.advanceTime(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">session.insert( tick2 );</span><br><span class="line">session.fireAllRules();</span><br><span class="line"></span><br><span class="line">clock.advanceTime(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">session.insert( tick3 );</span><br><span class="line">session.fireAllRules();</span><br><span class="line"></span><br><span class="line">session.dispose();</span><br></pre></td></tr></table></figure><ul><li><strong>æ´»åŠ¨æ¨¡å¼</strong>ï¼ˆActive modeï¼‰ï¼šå¦‚æœç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºè°ƒç”¨ <code>fireUntilHalt</code>ï¼ŒDrools å¼•æ“ä»¥æ´»åŠ¨æ¨¡å¼å¯åŠ¨å¹¶ä¸æ–­è¯„ä¼°è§„åˆ™ï¼Œç›´åˆ°ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºæ˜¾å¼è°ƒç”¨ <code>halt</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KieSessionConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> KieServices.Factory.get().newKieSessionConfiguration();</span><br><span class="line">config.setOption( ClockTypeOption.get(<span class="string">&quot;realtime&quot;</span>) );</span><br><span class="line"><span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kbase.newKieSession( conf, <span class="literal">null</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>( <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      session.fireUntilHalt();</span><br><span class="line">  &#125;</span><br><span class="line">&#125; ).start();</span><br><span class="line"></span><br><span class="line">session.insert( tick1 );</span><br><span class="line"></span><br><span class="line">... Thread.sleep( <span class="number">1000L</span> ); ...</span><br><span class="line"></span><br><span class="line">session.insert( tick2 );</span><br><span class="line"></span><br><span class="line">... Thread.sleep( <span class="number">1000L</span> ); ...</span><br><span class="line"></span><br><span class="line">session.insert( tick3 );</span><br><span class="line"></span><br><span class="line">session.halt();</span><br><span class="line">session.dispose();</span><br></pre></td></tr></table></figure><p><strong>äº‹å®ä¼ æ’­æ¨¡å¼ Fact propagation modes in the Drools engine</strong></p><p>Drools å¼•æ“æ”¯æŒä»¥ä¸‹äº‹å®ä¼ æ’­æ¨¡å¼ï¼Œè¿™äº›æ¨¡å¼å†³å®š Drools å¼•æ“å¦‚ä½•é€šè¿‡å¼•æ“ç½‘ç»œå¤„ç†æ’å…¥çš„äº‹å®ï¼Œä¸ºè§„åˆ™æ‰§è¡Œåšå‡†å¤‡ï¼š</p><ul><li><strong>æƒ°æ€§</strong>ï¼ˆLazyï¼‰ï¼šï¼ˆé»˜è®¤ï¼‰äº‹å®åœ¨è§„åˆ™æ‰§è¡Œæ—¶ä»¥æ‰¹å¤„ç†é›†åˆçš„å½¢å¼ä¼ æ’­ï¼Œè€Œä¸æ˜¯å®æ—¶ä¼ æ’­ï¼Œå› ä¸ºäº‹å®æ˜¯ç”±ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºç‹¬ç«‹è®¾ç½®çš„ï¼›å› æ­¤äº‹å®æœ€ç»ˆé€šè¿‡ Drools å¼•æ“ä¼ æ’­çš„é¡ºåºå¯èƒ½ä¸å•ç‹¬æ’å…¥äº‹å®çš„é¡ºåºä¸åŒï¼ˆæ²¡æœ‰é¡ºåºæ€§ï¼‰</li><li><strong>ç«‹å³</strong>ï¼ˆImmediateï¼‰ï¼šäº‹å®ä¼šæŒ‰ç…§ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºæ’å…¥çš„é¡ºåºç«‹å³ä¼ æ’­</li><li><strong>è¿«åˆ‡</strong>ï¼ˆEagerï¼‰ï¼šäº‹å®æ˜¯å»¶è¿Ÿä¼ æ’­çš„ï¼ˆåœ¨æ‰¹å¤„ç†é›†åˆä¸­ï¼‰ï¼Œä½†åœ¨è§„åˆ™æ‰§è¡Œä¹‹å‰ Drools å¼•æ“å°†è¿™ç§ä¼ æ’­è¡Œä¸ºç”¨äºæ´»åŠ¨å±æ€§ä¸Š <code>no-loop</code> æˆ– <code>lock-on-active</code> çš„è§„åˆ™</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrools å¼•æ“ä¸­çš„ Phreak è§„åˆ™ç®—æ³•ä½¿ç”¨æƒ°æ€§äº‹å®ä¼ æ’­æ¥æ”¹è¿›æ€»ä½“è§„åˆ™è¯„ä¼°ï¼›ä½†æ˜¯åœ¨å°‘æ•°æƒ…å†µä¸‹è¿™ç§æƒ°æ€§ä¼ æ’­è¡Œä¸ºå¯èƒ½ä¼šæ”¹å˜æŸäº›è§„åˆ™æ‰§è¡Œçš„é¢„æœŸç»“æœï¼Œè¿™äº›è§„åˆ™æ‰§è¡Œå¯èƒ½éœ€è¦ Immediate æˆ– Eager ä¼ æ’­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query <span class="title function_">Q</span> <span class="params">(Integer i)</span></span><br><span class="line">    String( <span class="built_in">this</span> == i.toString() )</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Rule&quot;</span></span><br><span class="line">  when</span><br><span class="line">    $i : Integer()</span><br><span class="line">    ?Q( $i; )</span><br><span class="line">  then</span><br><span class="line">    System.out.println( $i );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KieSession</span> <span class="variable">ksession</span> <span class="operator">=</span> ...</span><br><span class="line">ksession.insert(<span class="number">1</span>);</span><br><span class="line">ksession.insert(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">ksession.fireAllRules();</span><br></pre></td></tr></table></figure><p>è¯¥è§„åˆ™ä»ç„¶ä¼šè¢«å‘½ä¸­ï¼Œå› ä¸ºé»˜è®¤çš„ Lazy ä¼ æ’­å¤±å»äº†é¡ºåº</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦æ›´æ”¹ Drools å¼•æ“ä¼ æ’­æ¨¡å¼ä»¥å®ç°é¢„æœŸçš„è§„åˆ™è¯„ä¼°ï¼Œå¯ä»¥å°† <code>@propagation(&lt;type&gt;)</code>æ ‡è®°æ·»åŠ åˆ°è§„åˆ™ä¸­ï¼Œå¹¶å°† <code>&lt;type&gt;</code> è®¾ç½®ä¸º LAZYã€IMMEDIATE æˆ– EAGER</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query <span class="title function_">Q</span> <span class="params">(Integer i)</span></span><br><span class="line">    String( <span class="built_in">this</span> == i.toString() )</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Rule&quot;</span> <span class="meta">@Propagation(IMMEDIATE)</span></span><br><span class="line">  when</span><br><span class="line">    $i : Integer()</span><br><span class="line">    ?Q( $i; )</span><br><span class="line">  then</span><br><span class="line">    System.out.println( $i );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>äº‹é¡¹è¯„ä¼°è¿‡æ»¤å™¨ Agenda evaluation filters</strong></p><p>Drools å¼•æ“æ”¯æŒè¿‡æ»¤å™¨æ¥å£ä¸­çš„ <code>AgentaFilter</code> å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡åœ¨äº‹é¡¹è¯„ä¼°æœŸé—´å…è®¸æˆ–æ‹’ç»å¯¹æŒ‡å®šè§„åˆ™çš„è¯„ä¼°</p><p>å¯ä»¥æŒ‡å®šä¸€ä¸ªè®®ç¨‹è¿‡æ»¤å™¨ä½œä¸º <code>fireAllRules</code> è°ƒç”¨çš„ä¸€éƒ¨åˆ†</p><p>ä»¥ä¸‹ç¤ºä¾‹ä»£ç åªå…è®¸è¯„ä¼°å’Œæ‰§è¡Œä»¥å­—ç¬¦ä¸² â€œTestâ€ ç»“å°¾çš„è§„åˆ™ï¼›æ‰€æœ‰å…¶ä»–è§„åˆ™éƒ½ä¼šä» Drools å¼•æ“äº‹é¡¹ä¸­è¿‡æ»¤æ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ksession.fireAllRules( <span class="keyword">new</span> <span class="title class_">RuleNameEndsWithAgendaFilter</span>( <span class="string">&quot;Test&quot;</span> ) );</span><br></pre></td></tr></table></figure><hr><p>LiteFlow ä¸­å¯¹äºç»„ä»¶çš„æµç¨‹ä¹Ÿæœ‰å…¶æ§åˆ¶æœºåˆ¶</p><p>è™½ç„¶æ•´ä¸ªç»„ä»¶æ˜¯é€šè¿‡ EL è¡¨è¾¾å¼ç¼–æ’èµ·æ¥ï¼Œä½†æ˜¯å¯ä»¥é‡å†™ <code>Component</code> ç›¸å…³çš„æ–¹æ³•è¿›ä¸€æ­¥è¿›è¡Œæµç¨‹æ§åˆ¶</p><p><strong>isAccess</strong><br>æ¨èå®ç° <code>isAccess</code> æ–¹æ³•ï¼Œè¡¨ç¤ºæ˜¯å¦è¿›å…¥è¯¥èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨äºä¸šåŠ¡å‚æ•°çš„é¢„å…ˆåˆ¤æ–­</p><p>è¿™é‡Œå®˜æ–¹æ–‡æ¡£å†™çš„æ¯”è¾ƒç®€å•ï¼›ä¸Šé¢æè¿‡ <code>Executable</code> å…¶ä¸­æœ‰ <code>Node</code> å’Œ <code>Component</code> çš„å®ç°</p><ul><li>å¯¹äº <code>Node</code> è€Œè¨€ï¼Œ<code>isAccess</code> æ§åˆ¶è¯¥ç»„ä»¶æ˜¯å¦æ‰§è¡Œï¼Œä½†æ˜¯ä¸ä¼šå½±å“åç»­ç»„ä»¶çš„æ‰§è¡Œ</li><li>å¯¹äº <code>Condition</code>ï¼Œå› ä¸ºåç»­æµç¨‹éœ€è¦ç”± <code>Condition</code> æ¥è¿›è¡Œæ§åˆ¶ï¼Œä¾‹å¦‚ <code>SwitchCondition</code>ã€<code>IfCondition</code>ï¼Œæ‰€ä»¥å¯¹äº <code>Condition</code> ç›¸å…³çš„ç»„ä»¶ <code>isAccess</code> ä¸º false åˆ™è¯¥è·¯çº¿ä¸ä¼šå‘ä¸‹æ‰§è¡Œäº†</li></ul><p><strong>isEnd</strong><br>å¦‚æœè¦†ç›–åï¼Œè¿”å› trueï¼Œåˆ™è¡¨ç¤ºåœ¨è¿™ä¸ªç»„ä»¶æ‰§è¡Œå®Œä¹‹åç«‹é©¬ç»ˆæ­¢æ•´ä¸ªæµç¨‹</p><p>å¯¹äºè¿™ç§æ–¹å¼ï¼Œç”±äºæ˜¯ç”¨æˆ·ä¸»åŠ¨ç»“æŸçš„æµç¨‹ï¼Œå±äºæ­£å¸¸ç»“æŸï¼Œæ‰€ä»¥æœ€ç»ˆçš„ <code>isSuccess</code> ä¸º true</p><p><strong>beforeProcess &amp; afterProcess</strong></p><p>æµç¨‹çš„å‰ç½®å’Œåç½®å¤„ç†å™¨ï¼Œå…¶ä¸­å‰ç½®å¤„ç†å™¨ï¼Œåœ¨ <code>isAccess</code> ä¹‹åæ‰§è¡Œ</p><p>æ‰€æœ‰ç»„ä»¶é€šç”¨çš„å‰ååˆ‡é¢å¯ä»¥ä½¿ç”¨åˆ‡é¢ç»„ä»¶ <code>ICmpAroundAspect</code>ï¼›Spring ç¯å¢ƒä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ Spring Aspect</p><p><strong>onSuccess &amp; onError</strong></p><p>æµç¨‹çš„æˆåŠŸå¤±è´¥äº‹ä»¶å›è°ƒ</p><h1 id="ç®€å•åº”ç”¨"><a href="#ç®€å•åº”ç”¨" class="headerlink" title="ç®€å•åº”ç”¨"></a>ç®€å•åº”ç”¨</h1><h2 id="ä»·æ ¼è®¡ç®—"><a href="#ä»·æ ¼è®¡ç®—" class="headerlink" title="ä»·æ ¼è®¡ç®—"></a>ä»·æ ¼è®¡ç®—</h2><p>LiteFlow æœ‰ä¸€ä¸ª Demo æ¡ˆä¾‹ï¼Œå¯ä»¥ç®€å•äº†è§£æ˜¯å¦‚ä½•ä½¿ç”¨çš„</p><p><a href="https://liteflow.yomahub.com/pages/0a8188/">LiteFlow DEMO æ¡ˆä¾‹ 2 ä»·æ ¼è®¡ç®—</a></p><h2 id="é€šçŸ¥æ–‡æ¡ˆ"><a href="#é€šçŸ¥æ–‡æ¡ˆ" class="headerlink" title="é€šçŸ¥æ–‡æ¡ˆ"></a>é€šçŸ¥æ–‡æ¡ˆ</h2><p>tutor-student-notify å¯¹äºå‘é€é€»è¾‘çš„å¤„ç†</p><p>äº§å“æ›¾ç»æè¿‡ç†æƒ³ä¸­çš„äº§å“ä½¿ç”¨ï¼ŒGUI é…ç½®ã€æ–‡æ¡ˆç¼–è¾‘ï¼Œä¸éœ€è¦ç ”å‘å‚ä¸ä¿®æ”¹ï¼›ä¸è¿‡ç°å®è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œè¿™é‡Œä½¿ç”¨ LiteFlow å®ç°ä¸€ä¸ª Demo</p><p>ï¼ˆå…·ä½“çš„ä»£ç å°±ä¸ç²˜è´´åœ¨è¿™é‡Œäº†ï¼‰</p><p>è®¾è®¡çš„ç»„ä»¶ï¼š</p><ul><li>initContextCmpï¼šåˆå§‹åŒ–ä¸Šä¸‹æ–‡</li><li>lessonInfoCmpï¼šLesson ä¿¡æ¯è·å–</li><li>userInfoCmpï¼šUser ä¿¡æ¯è·å–</li><li>teacherInfoCmpï¼šTeacher ä¿¡æ¯è·å–</li><li>lowGradeJudgeCmpï¼š<code>IF</code> èŠ‚ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ä½å¹´çº§</li><li>templateKeySelectCmpï¼šé€šç”¨æ¨¡æ¿ key é€‰æ‹©æ¨¡æ¿ï¼Œå°† key å†™å…¥ Contextï¼Œéœ€è¦ç»„ä»¶å‚æ•°<ul><li>ç»„ä»¶å‚æ•°ï¼šæ¨¡æ¿ key</li></ul></li><li>customerHotlineCmpï¼šå®¢æœç”µè¯å‚æ•°<ul><li>ç»„ä»¶å‚æ•°ï¼šå®¢æœç”µè¯é…ç½®</li></ul></li><li>userNameParamCmpï¼šç”¨æˆ·æ˜µç§°å‚æ•°</li><li>lessonNameParamCmpï¼šç­è¯¾åç§°å‚æ•°<ul><li>ç»„ä»¶å‚æ•°ï¼šå ä½ç¬¦ name å’Œæ±‚å€¼è¡¨è¾¾å¼</li></ul></li><li>sendCmpï¼šå‘é€</li></ul><p>è§„åˆ™ EL</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;lessonDeliveredEvent&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            initContextCmp,</span><br><span class="line">            WHEN(</span><br><span class="line">                THEN(lessonInfoCmp,teacherInfoCmp),</span><br><span class="line">                userInfoCmp),</span><br><span class="line">            IF(</span><br><span class="line">                lowGradeJudgeCmp,</span><br><span class="line">                templateKeySelectCmp.data(&#x27;low-grade&#x27;),</span><br><span class="line">                THEN(templateKeySelectCmp.data(&#x27;high-grade&#x27;),customerHotlineCmp.data(&#x27;10086&#x27;))</span><br><span class="line">            ),</span><br><span class="line">            WHEN(userNameParamCmp,lessonNameParamCmp.data(&#x27;&#123;&quot;paramName&quot;:&quot;lessonName&quot;,&quot;qlExpress&quot;:&quot;ã€Š lessonName ã€‹&quot;&#125;&#x27;)),</span><br><span class="line">            sendCmp</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ç°æœ‰ä¸šåŠ¡-é€€è¯¾é€€æ¬¾"><a href="#ç°æœ‰ä¸šåŠ¡-é€€è¯¾é€€æ¬¾" class="headerlink" title="ç°æœ‰ä¸šåŠ¡ - é€€è¯¾é€€æ¬¾"></a>ç°æœ‰ä¸šåŠ¡ - é€€è¯¾é€€æ¬¾</h2><p>tutor-lesson-order æœåŠ¡ä¸­å¯¹äºé€€æ¬¾æµç¨‹çš„å¤„ç†ï¼Œæ„Ÿè§‰å¾ˆæ¥è¿‘æµç¨‹å¼è§„åˆ™çš„æ€æƒ³</p><ul><li>Pipelineã€ç»„ä»¶åŒ–ã€ç»„ä»¶ç¼–æ’</li><li>å¹¶å‘ç¼–æ’</li><li>Context è®¾è®¡å’Œå·¥ä½œå°æ¨¡å¼</li></ul><h3 id="ä¸Šä¸‹æ–‡"><a href="#ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸Šä¸‹æ–‡"></a>ä¸Šä¸‹æ–‡</h3><p><code>RefundContext</code> æ˜¯å…¶é€€æ¬¾ä¸šåŠ¡ä¸Šä¸‹æ–‡çš„åŸºç±»</p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/RefundContext.png" class="" title="RefundContext"><p>ä»¥å®ç‰©å•†å“é€€æ¬¾æµç¨‹ä¸Šä¸‹æ–‡ <code>PhysicalCommodityRootRefundContext</code> ä¸ºä¾‹</p><ul><li>PhysicalCommodityRootRefundContextï¼šå®ç‰©å•†å“</li><li>UnboxedRootRefundContextï¼šéç›’å­<ul><li>OrderItemEO</li><li>LessonDigest</li><li>LessonOrderEO</li><li>partRefund</li><li>refundQuantity</li><li>code</li><li>extraMap</li></ul></li><li>StandardRootRefundContextï¼šåŸºç¡€é€€æ¬¾æ•°æ®<ul><li>baseParam</li><li>refundConfig</li><li>refundTs</li><li>bizRefundInfoMap</li><li>mergedRefundInfo</li></ul></li></ul><p>è®¡ç®—èŠ‚ç‚¹äº§å‡ºçš„æ–°å¯¹è±¡ä¸º <code>NestedContext</code> å®ç°ç±»ï¼Œä¾é  <code>BaseNestedRefundContext</code> è¿›è¡Œè¿æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseNestedRefundContext</span> <span class="keyword">implements</span> <span class="title class_">NestedContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> NestedContext parent;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, NestedContext&gt; children;</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œé“¾"><a href="#æ‰§è¡Œé“¾" class="headerlink" title="æ‰§è¡Œé“¾"></a>æ‰§è¡Œé“¾</h3><p>æ‰§è¡Œé“¾çš„æ ¸å¿ƒç±»æ˜¯ <code>RefundPipeline</code></p><p>ç»„é“¾æ“ä½œç”± <code>RefundPipelineService</code> æä¾› <code>RefundTask</code> å®ç°ç±»çš„ beanï¼Œ<code>RefundPipelines</code> ä½œä¸ºå·¥å…·ç±»ï¼Œæä¾› <code>RefundTaskGroupConfig</code> æ˜ å°„çœŸå®çš„ bean ä»¥åŠæœ€åçš„ç»„è£…</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;RefundTask[]&gt; groupTasks(List&lt;RefundTask&gt; allTasks, RefundTaskGroupConfig groupConfig) &#123;</span><br><span class="line">    <span class="keyword">return</span> groupConfig.keySet().stream().sorted().map(groupId -&gt; &#123;</span><br><span class="line">        Collection&lt;String&gt; taskNames = groupConfig.get(groupId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> allTasks.stream()</span><br><span class="line">                .filter(task -&gt; taskNames.contains(task.getName()))</span><br><span class="line">                .collect(Collectors.toList())</span><br><span class="line">                .toArray(<span class="keyword">new</span> <span class="title class_">RefundTask</span>[]&#123;&#125;);</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¡ç®—èŠ‚ç‚¹-amp-æ‰§è¡ŒèŠ‚ç‚¹"><a href="#è®¡ç®—èŠ‚ç‚¹-amp-æ‰§è¡ŒèŠ‚ç‚¹" class="headerlink" title="è®¡ç®—èŠ‚ç‚¹ &amp; æ‰§è¡ŒèŠ‚ç‚¹"></a>è®¡ç®—èŠ‚ç‚¹ &amp; æ‰§è¡ŒèŠ‚ç‚¹</h3><p>unboxed ç­è¯¾é€€æ¬¾æµç¨‹</p><ul><li><strong>åŠ è½½èŠ‚ç‚¹ &amp; è®¡ç®—èŠ‚ç‚¹</strong> Pipeline<ul><li>ã€0ã€‘base info loader<ul><li>unboxed_base_ctx_loader</li></ul></li><li>ã€1ã€‘biz loader<ul><li>gift_order_loader</li><li>textbook_refund_loader</li><li>dual_coupon_loader</li><li>marketing_activity_refund_loader</li><li></li></ul></li><li>ã€100ã€‘biz calculator<ul><li>gift_order</li><li>dual_coupon</li><li>lesson_textbook</li><li>marketing_activity_refund_calc</li></ul></li><li>ã€101ã€‘<ul><li>lesson_agenda</li></ul></li><li>ã€1000ã€‘merge calculator<ul><li>merge_refund</li></ul></li></ul></li><li><strong>æ‰§è¡ŒèŠ‚ç‚¹</strong> Pipeline<ul><li>ã€0ã€‘<ul><li>refund_lesson_order</li></ul></li><li>ã€1ã€‘</li><li>ã€2ã€‘<ul><li>gift_order_post</li><li>lesson_order_delivery</li><li>record_refund</li><li>dual_coupon_post</li><li>marketing_activity_refund_post</li></ul></li></ul></li></ul><blockquote><p><em>æ€è€ƒï¼šç»„ä»¶åŒ–åå¦‚ä½•ä¿è¯ç¼–æ’çš„æ­£ç¡®æ€§</em></p><p><em>å¦‚ä¸Šï¼Œå¦‚æœæ‰§è¡ŒèŠ‚ç‚¹è¢«é…ç½®åˆ°äº†è®¡ç®—èŠ‚ç‚¹ä¹‹å‰ä¼šå‡ºç°é—®é¢˜ï¼›ä½œä¸ºå·¥ä½œå°æ¨¡å¼ï¼Œæ€»ä¹‹å…·æœ‰å‰åé¡ºåºçš„ç»„ä»¶é¡ºåºé”™è¯¯å°±ä¼šå¯¼è‡´æµç¨‹çš„é”™è¯¯</em></p><p><em>1. ç»„ä»¶é—´è§£è€¦ï¼Œä½†è¿˜æ˜¯éœ€è¦æ³¨æ„ç»„ä»¶ä¹‹é—´çš„æµç¨‹ç¼–æ’</em></p><p><em>2.å¦‚ä½•å¯¹ç»„ä»¶çš„ç¼–æ’è¿›è¡Œæ ¡éªŒ</em></p></blockquote><h3 id="ä»»åŠ¡-x2F-å¹¶å‘ç¼–æ’"><a href="#ä»»åŠ¡-x2F-å¹¶å‘ç¼–æ’" class="headerlink" title="ä»»åŠ¡ &#x2F; å¹¶å‘ç¼–æ’"></a>ä»»åŠ¡ &#x2F; å¹¶å‘ç¼–æ’</h3><p><code>RefundTaskGroupConfig</code> ç”¨æ¥æè¿°ä»»åŠ¡é…ç½® <code>private final Map&lt;Integer, Collection&lt;String&gt;&gt; configValue;</code></p><p>å…¶å±æ€§ <code>configValue</code> çš„ key ç”¨æ¥æè¿°å¹¶å‘åˆ†ç»„å³é¡ºåºï¼Œvalue ä¸º <code>RefundTask</code> bean name çš„é›†åˆ</p><p><code>RefundTaskGroup</code> ç”¨æ¥å°è£…å¹¶å‘ç¼–æ’çš„ä»»åŠ¡</p><p>RefundTaskGroup</p><ul><li>tasksï¼š<code>RefundTask</code> é›†åˆï¼ŒåŒ…å«äº†å½“å‰ group éœ€è¦å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡</li><li>pipelineï¼š<code>RefundPipeline</code> å’Œ <code>RefundTaskGroup</code> äº’ç›¸æŒæœ‰</li></ul><p>ä¸ºä»€ä¹ˆè¿™ä¸ªåœ°æ–¹ group éœ€è¦æŒæœ‰ pipeline èŠ‚ç‚¹ï¼Ÿå› ä¸º task è¢« group æŒæœ‰ï¼Œcontext è¢« pipeline æŒæœ‰ï¼Œè€Œ task çš„è¿è¡Œéœ€è¦ context</p><p>æ•´ä¸ª pipeline æ¨¡å¼ä¸‹å¯¹è±¡ä¹‹é—´çš„å…³ç³»</p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E8%AE%A2%E5%8D%95%E9%80%80%E6%AC%BE%E7%B1%BB%E7%BB%93%E6%9E%84.png" class="" title="è®¢å•é€€æ¬¾ç±»ç»“æ„"><h3 id="LiteFlow-DSL"><a href="#LiteFlow-DSL" class="headerlink" title="LiteFlow DSL"></a>LiteFlow DSL</h3><p>ä¸Šè¿°ä¸šåŠ¡å¯¹èŠ‚ç‚¹çš„ç¼–æ’ç›¸å½“äº LiteFlow ä¸­çš„ <code>WHEN</code> å’Œ <code>THEN</code></p><p>å¦‚æœè¡¨ç¤ºä¸ºæµç¨‹å›¾</p><img src="/%E5%BC%80%E5%8F%91/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/refund%20%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png" class="" title="refund æµç¨‹å›¾.drawio"><p>å¦‚æœä½¿ç”¨ LiteFLow çš„ EL è¡¨ç¤º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">flow</span> <span class="keyword">PUBLIC</span>  <span class="string">&quot;liteflow&quot;</span> <span class="string">&quot;liteflow.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;physical_commodity_calculation_task_group_config&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            unboxed_base_ctx_loader,</span><br><span class="line">            WHEN(</span><br><span class="line">                gift_order_loader,</span><br><span class="line">                textbook_refund_loader,</span><br><span class="line">                dual_coupon_loader,</span><br><span class="line">                marketing_activity_refund_loader,</span><br><span class="line">                lesson_extra_loader</span><br><span class="line">            ),</span><br><span class="line">            WHEN(</span><br><span class="line">                gift_order,</span><br><span class="line">                dual_coupon,</span><br><span class="line">                lesson_textbook,</span><br><span class="line">                marketing_activity_refund_calc</span><br><span class="line">            ),</span><br><span class="line">            lesson_agenda,</span><br><span class="line">            merge_refund</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;standard_refunding_task_group_config&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            refund_lesson_order,</span><br><span class="line">            WHEN(</span><br><span class="line">                gift_order_post,</span><br><span class="line">                lesson_order_delivery,</span><br><span class="line">                record_refund,</span><br><span class="line">                dual_coupon_post,</span><br><span class="line">                marketing_activity_refund_post</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;physical_commodity_refund&quot;</span>&gt;</span></span><br><span class="line">        THEN(physical_commodity_calculation_task_group_config, standard_refunding_task_group_config);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="AI-ç»“åˆæ€è€ƒ"><a href="#AI-ç»“åˆæ€è€ƒ" class="headerlink" title="AI ç»“åˆæ€è€ƒ"></a>AI ç»“åˆæ€è€ƒ</h1><p> è‡ªä»ä»Šå¹´ AI æˆä¸ºçƒ­é¢˜åï¼Œå„ç•Œéƒ½åœ¨è€ƒè™‘å¦‚ä½•ä½¿ç”¨ AI æä¾›æ–°äº§å“ã€æé«˜ç”Ÿäº§åŠ›</p><p>AI æŠ€æœ¯å¯ä»¥å¸®åŠ©ç¨‹åºå‘˜æ›´å¿«åœ°å®Œæˆä¸€äº›ç¹çã€é‡å¤æ€§çš„ä»»åŠ¡ï¼Œå¦‚ä»£ç å®¡æŸ¥ã€æµ‹è¯•ã€è°ƒè¯•ç­‰ï¼›æ­¤å¤–ï¼ŒAI è¿˜å¯ä»¥é€šè¿‡è‡ªåŠ¨åŒ–ä¸€äº›æµç¨‹å’Œå·¥ä½œæµç¨‹æ¥ç®€åŒ–å¼€å‘æµç¨‹ï¼Œä»è€Œæé«˜ç”Ÿäº§æ•ˆç‡</p><p>è€Œè§„åˆ™å¼•æ“çš„è§„åˆ™ç¼–æ’ã€ç”šè‡³æ˜¯è„šæœ¬è¯­æ³•ç›¸æ¯”é€»è¾‘ä»£ç ç”± AI è¾…åŠ©æˆ‘è®¤ä¸ºæ›´é€‚åˆï¼Œç”šè‡³å®ç°ä¸Šå¯èƒ½æ›´ç®€å•ï¼š</p><ul><li>è§„åˆ™ç¼–æ’æœ‰æ—¶ç”±ä¸šåŠ¡ã€äº§å“ã€æ•°æ®è¿›è¡Œç¼–å†™ï¼Œä¸èƒ½ä½¿ç”¨å¤æ‚çš„å¼€å‘è¯­è¨€ï¼›å¯ä»¥ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿° AI è½¬æ¢è§„åˆ™</li><li>è§„åˆ™å¾€å¾€è¢«é™å®šåœ¨ä¸€ä¸ªè¾ƒå°çš„ä¸šåŠ¡èŒƒå›´å†…ï¼ŒAI æ‰€éœ€çš„ä¸Šä¸‹æ–‡è¾ƒå°‘ï¼Œç»“æœæ›´åŠ å‡†ç¡®</li><li>AI æ˜¯å¦å¯ä»¥é¿å…è§„åˆ™å†²çªã€æµç¨‹å®šä¹‰é”™è¯¯çš„äººå·¥é”™è¯¯</li></ul><h2 id="Drools-DRL-amp-CEP"><a href="#Drools-DRL-amp-CEP" class="headerlink" title="Drools DRL &amp; CEP"></a>Drools DRL &amp; CEP</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘å°†ä¼šç»™ä¸€æ®µè‡ªç„¶è¯­è¨€æè¿°ï¼Œå°†å…¶è½¬æ¢ä¸º Drools çš„ DRL è§„åˆ™</p><p>æ¯å½“ BuyOrder äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç­‰å¾…åŒ¹é…çš„ AckOrder äº‹ä»¶ 10s çš„æ—¶é—´ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œåˆ™å‘é€çŸ­ä¿¡ç»™ç”¨æˆ·</p><p><strong>ç­”ï¼š</strong></p><p>ä¸‹é¢æ˜¯å°†è‡ªç„¶è¯­è¨€æè¿°è½¬æ¢ä¸º Drools DRL è§„åˆ™çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Match AckOrder and Send SMS&quot;</span></span><br><span class="line">when</span><br><span class="line">    <span class="comment">// å½“ BuyOrder äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç­‰å¾… 10s åŒ¹é… AckOrder äº‹ä»¶</span></span><br><span class="line">    $buyOrder: BuyOrder()</span><br><span class="line">    not <span class="title function_">AckOrder</span><span class="params">(<span class="built_in">this</span> after[0s, 10s] $buyOrder)</span></span><br><span class="line">then</span><br><span class="line">    <span class="comment">// åŒ¹é…æˆåŠŸï¼Œå‘é€çŸ­ä¿¡ç»™ç”¨æˆ·</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Your order has been acknowledged. Thank you for your purchase!&quot;</span>;</span><br><span class="line">    sendSMS($buyOrder.getPhoneNumber(), message);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªè§„åˆ™ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¼å…¥äº† Java ä¸­çš„ TimeUnit ç±»ï¼Œç”¨äºæŒ‡å®šç­‰å¾… 10 ç§’çš„æ—¶é—´</p><p>ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º â€œMatch AckOrder and Send SMSâ€ çš„è§„åˆ™ï¼Œå…¶ä¸­ï¼š</p><ul><li>å½“ BuyOrder äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä½¿ç”¨ not å…³é”®å­—ç­‰å¾… 10 ç§’æ¥åŒ¹é… AckOrder äº‹ä»¶</li><li>å¦‚æœåœ¨ 10 ç§’å†…æˆåŠŸåŒ¹é…åˆ° AckOrder äº‹ä»¶ï¼Œåˆ™å°†ä¼šæ‰§è¡Œ then è¯­å¥</li><li>åœ¨ then è¯­å¥ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ $buyOrder å¯¹è±¡çš„ getPhoneNumber() æ–¹æ³•è·å–ç”¨æˆ·çš„ç”µè¯å·ç ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€ç»™ç”¨æˆ·</li></ul><h2 id="é˜…è¯»-DRL-è§„åˆ™"><a href="#é˜…è¯»-DRL-è§„åˆ™" class="headerlink" title="é˜…è¯» DRL è§„åˆ™"></a>é˜…è¯» DRL è§„åˆ™</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘å°†ä¼šç»™ä½ ä¸€æ®µ Drools DRL è§„åˆ™ï¼Œè¯·ç”¨ä¸­æ–‡æè¿°è¿™æ®µè§„åˆ™çš„å«ä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Underage&quot;</span></span><br><span class="line">  salience <span class="number">15</span></span><br><span class="line">  agenda-group <span class="string">&quot;applicationGroup&quot;</span></span><br><span class="line">  when</span><br><span class="line">    $application : LoanApplication()</span><br><span class="line">    Applicant( age &lt; <span class="number">21</span> )</span><br><span class="line">  then</span><br><span class="line">    $application.setApproved( <span class="literal">false</span> );</span><br><span class="line">    $application.setExplanation( <span class="string">&quot;Underage&quot;</span> );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>ç­”ï¼š</strong></p><p>è¿™æ®µ Drools DRL è§„åˆ™çš„å«ä¹‰æ˜¯ï¼š</p><p>å½“è§„åˆ™å¼•æ“åŒ¹é…åˆ°ä¸€ä¸ªåä¸º LoanApplication çš„å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä¸­çš„ Applicant å¯¹è±¡çš„ age å±æ€§å°äº 21 å²æ—¶ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªè§„åˆ™</p><p>è¯¥è§„åˆ™çš„ä¼˜å…ˆçº§ä¸º 15ï¼Œå®ƒå±äº agenda-group â€œapplicationGroupâ€ ç»„</p><p>è§¦å‘è§„åˆ™åï¼Œè§„åˆ™å¼•æ“ä¼šå°†  <code>$application</code> å¯¹è±¡çš„ <code>approved</code> å±æ€§è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºä¸æ‰¹å‡†è¯¥è´·æ¬¾ç”³è¯·ï¼›åŒæ—¶ï¼Œå®ƒä¼šå°† <code>$application</code> å¯¹è±¡çš„ <code>explanation</code> å±æ€§è®¾ç½®ä¸º <code>Underage</code>ï¼Œè¡¨ç¤ºä¸æ‰¹å‡†è¯¥è´·æ¬¾ç”³è¯·çš„åŸå› æ˜¯ç”³è¯·äººæœªè¾¾åˆ°æ³•å®šå¹´é¾„</p><h2 id="è‡ªç„¶è¯­è¨€è¾…åŠ©ç”Ÿæˆ-DSL-è§„åˆ™"><a href="#è‡ªç„¶è¯­è¨€è¾…åŠ©ç”Ÿæˆ-DSL-è§„åˆ™" class="headerlink" title="è‡ªç„¶è¯­è¨€è¾…åŠ©ç”Ÿæˆ DSL è§„åˆ™"></a>è‡ªç„¶è¯­è¨€è¾…åŠ©ç”Ÿæˆ DSL è§„åˆ™</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘å°†ä¼šä½¿ç”¨è¯­è¨€æè¿°è§„åˆ™ï¼Œå¸®æˆ‘ç”Ÿæˆ Drools DSL æ–‡ä»¶</p><ul><li>å½“ç”¨æˆ·è´­ä¹°å•†å“ä¸ºä¿ƒé”€å•†å“ï¼Œå¹¶ä¸”ç”¨æˆ·ä¸ºæ™®é€šä¼šå‘˜ï¼Œåˆ™æ‰“å°æ—¥å¿— â€œå½“å‰ç”¨æˆ·ä¸ºæ™®é€šä¼šå‘˜â€ï¼Œè¡Œä¸ºæ˜¯å•†å“ä»·æ ¼æ‰“ 9 æŠ˜</li><li>å½“ç”¨æˆ·è´­ä¹°å•†å“ä¸ºä¿ƒé”€å•†å“ï¼Œå¹¶ä¸”ç”¨æˆ·ä¸ºé»„é‡‘ä¼šå‘˜ï¼Œåˆ™æ‰“å°æ—¥å¿— â€œå½“å‰ç”¨æˆ·ä¸ºæ™®é€šä¼šå‘˜â€ï¼Œè¡Œä¸ºä¸ºå•†å“ä»·æ ¼æ‰“ 8 æŠ˜</li></ul><p><strong>ç­”ï¼š</strong></p><p>æ ¹æ®ä½ çš„è¦æ±‚ï¼Œå°†ä¸Šè¿°åœºæ™¯è½¬æ¢ä¸ºå¸¦æœ‰è¡¨è¾¾å¼è½¬æ¢çš„å½¢å¼ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ Drools DSL æ–‡ä»¶ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[when]</span> There is <span class="selector-tag">a</span> purchase = <span class="variable">$p</span>:<span class="built_in">Purchase</span>()</span><br><span class="line"><span class="selector-attr">[when]</span> - purchase is promotional = <span class="variable">$p</span><span class="selector-class">.promotionalItem</span> == true</span><br><span class="line"><span class="selector-attr">[when]</span> - user is <span class="selector-tag">a</span> standard member = <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> == <span class="string">&quot;Standard&quot;</span></span><br><span class="line"><span class="selector-attr">[then]</span> print = System<span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">&quot;The current user is a&quot;</span> + <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> + <span class="string">&quot; member&quot;</span>)</span><br><span class="line"><span class="selector-attr">[then]</span> The product price is discounted by &#123;discount:\d*&#125;% = <span class="variable">$p</span><span class="selector-class">.productPrice</span> = <span class="variable">$p</span><span class="selector-class">.productPrice</span> * (<span class="number">100</span> - &#123;discount&#125;) / <span class="number">100</span></span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[when]</span> There is <span class="selector-tag">a</span> purchase = <span class="variable">$p</span>:<span class="built_in">Purchase</span>()</span><br><span class="line"><span class="selector-attr">[when]</span> - purchase is promotional = <span class="variable">$p</span><span class="selector-class">.promotionalItem</span> == true</span><br><span class="line"><span class="selector-attr">[when]</span> - user is <span class="selector-tag">a</span> gold member = <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> == <span class="string">&quot;Gold&quot;</span></span><br><span class="line"><span class="selector-attr">[then]</span> print = System<span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">&quot;The current user is a &quot;</span> + <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> + <span class="string">&quot; member&quot;</span>)</span><br><span class="line"><span class="selector-attr">[then]</span> The product price is discounted by &#123;discount:\d*&#125;% = <span class="variable">$p</span><span class="selector-class">.productPrice</span> = <span class="variable">$p</span><span class="selector-class">.productPrice</span> * (<span class="number">100</span> - &#123;discount&#125;) / <span class="number">100</span></span><br></pre></td></tr></table></figure><p>DSLR</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&#x27;discount_standard_user&#x27;</span></span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">    There is a purchase</span><br><span class="line">    - purchase is promotional</span><br><span class="line">  - user is a standard member</span><br><span class="line">then</span><br><span class="line">    print</span><br><span class="line">  The product price is discounted by <span class="number">10</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="é˜…è¯»-LiteFlow-æµç¨‹å›¾å¼-EL"><a href="#é˜…è¯»-LiteFlow-æµç¨‹å›¾å¼-EL" class="headerlink" title="é˜…è¯» LiteFlow æµç¨‹å›¾å¼ EL"></a>é˜…è¯» LiteFlow æµç¨‹å›¾å¼ EL</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘è®¾è®¡å¦‚ä¸‹è¯­æ³•ï¼š</p><ul><li><code>THEN</code> è¡¨ç¤ºä¸²è¡Œï¼›å¦‚ <code>TEHN(A,B,C)</code> è¡¨ç¤ºæ‰§è¡Œ A åæ‰§è¡Œ Bï¼Œæœ€åæ‰§è¡Œ C</li><li><code>WHEN</code> è¡¨ç¤ºå¹¶è¡Œï¼›å¦‚ <code>WHEN(A,B)</code> è¡¨ç¤º A å’Œ B æ˜¯å¹¶è¡Œçš„ï¼› <code>WHEN(A,then(B,C))</code> è¡¨ç¤º A å’Œ Bã€C ä¹‹é—´çš„æ‰§è¡Œæ˜¯å¹¶è¡Œçš„ï¼ŒB å’Œ C çš„æ‰§è¡Œæ˜¯ä¸²è¡Œçš„</li><li><code>SWITCH</code> è¡¨ç¤ºé€‰æ‹©ï¼Œä¼šæ ¹æ®è¿”å›å€¼å¯¹ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ç»„ä»¶è¿›è¡Œé€‰æ‹©ï¼›å¦‚ <code>SWITCH(A).to(B,C,D)</code>ï¼Œä¼šæ‰§è¡Œç»„ä»¶ Aï¼Œæ ¹æ®è¿”å›å€¼å†³å®šåé¢çš„æµç¨‹æ˜¯æ‰§è¡Œ B æˆ–è€… C æˆ–è€… D</li><li><code>IF</code> è¡¨ç¤ºåˆ¤æ–­ï¼Œä¼šæ ¹æ®è¿”å›çš„å¸ƒå°”ç±»å‹é€‰æ‹©ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ç»„ä»¶ï¼›å¦‚ <code>IF(A,B,C)</code>ï¼Œæ‰§è¡Œç»„ä»¶ Aï¼Œå¦‚æœè¿”å›å€¼æ˜¯ true åˆ™æ‰§è¡Œ Bï¼Œå¦‚æœè¿”å›å€¼æ˜¯ false åˆ™æ‰§è¡Œ Cï¼›å¦‚æœæ˜¯ <code>IF(A,B)</code>ï¼Œåˆ™ false æ—¶ä¸ä¼šæ‰§è¡Œ</li></ul><p>ä¸Šè¿°æ‰€æœ‰çš„å…³é”®è¯æ”¯æŒåµŒå¥—</p><p>ç°åœ¨æˆ‘å°†ä¼šç»™ä½ ä¸€æ®µç”±ä¸Šè¿°è¯­æ³•ç»„æˆçš„è¡¨è¾¾å¼ï¼Œå¸®æˆ‘ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‰€è¿›è¡Œçš„æ“ä½œ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">THEN(</span><br><span class="line">     unboxed_base_ctx_loader,</span><br><span class="line">     WHEN(</span><br><span class="line">         gift_order_loader,</span><br><span class="line">         textbook_refund_loader,</span><br><span class="line">         dual_coupon_loader,</span><br><span class="line">         marketing_activity_refund_loader,</span><br><span class="line">         lesson_extra_loader</span><br><span class="line">     ),</span><br><span class="line">     WHEN(</span><br><span class="line">         gift_order,</span><br><span class="line">         dual_coupon,</span><br><span class="line">         lesson_textbook,</span><br><span class="line">         marketing_activity_refund_calc</span><br><span class="line">     ),</span><br><span class="line">     lesson_agenda,</span><br><span class="line">     merge_refund</span><br><span class="line"> );</span><br></pre></td></tr></table></figure><p><strong>ç­”ï¼š</strong></p><p>è¿™ä¸ªè¡¨è¾¾å¼æè¿°äº†ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š</p><ol><li>é¦–å…ˆæ‰§è¡Œ <code>unboxed_base_ctx_loader</code> ç»„ä»¶</li><li>æ¥ç€æ‰§è¡Œä¸¤ä¸ªå¹¶è¡Œçš„ç»„ä»¶åºåˆ—ï¼Œç¬¬ä¸€ä¸ªå¹¶è¡Œåºåˆ—åŒ…æ‹¬ <code>gift_order_loader</code>ã€<code>textbook_refund_loader</code>ã€<code>dual_coupon_loader</code>ã€<code>marketing_activity_refund_loader</code> å’Œ <code>lesson_extra_loader</code> è¿™äº›ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¼šåŒæ—¶æ‰§è¡Œï¼›ç¬¬äºŒä¸ªå¹¶è¡Œåºåˆ—åŒ…æ‹¬ <code>gift_order</code>ã€<code>dual_coupon</code>ã€<code>lesson_textbook</code> å’Œ <code>marketing_activity_refund_calc</code> è¿™äº›ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¹Ÿä¼šåŒæ—¶æ‰§è¡Œ</li><li>æ‰§è¡Œ <code>lesson_agenda</code> ç»„ä»¶</li><li>æœ€åæ‰§è¡Œ <code>merge_refund</code> ç»„ä»¶</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬ä¸€ä¸ªå¹¶è¡Œåºåˆ—ä¸­çš„æ‰€æœ‰ç»„ä»¶éƒ½éœ€è¦åœ¨ç¬¬ä¸€ä¸ªæ­¥éª¤ä¸­æ‰§è¡Œå®Œæ¯•åæ‰èƒ½å¼€å§‹æ‰§è¡Œï¼Œè€Œç¬¬äºŒä¸ªå¹¶è¡Œåºåˆ—ä¸­çš„æ‰€æœ‰ç»„ä»¶éƒ½éœ€è¦åœ¨ç¬¬ä¸€ä¸ªå¹¶è¡Œåºåˆ—ä¸­çš„ç»„ä»¶å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åæ‰èƒ½å¼€å§‹æ‰§è¡Œï¼›å¦å¤–ï¼Œæ‰§è¡Œ <code>marketing_activity_refund_calc</code> ç»„ä»¶çš„å‰ææ˜¯æ‰§è¡Œ <code>dual_coupon</code> å’Œ <code>gift_order</code> ç»„ä»¶ï¼Œè€Œæ‰§è¡Œ <code>merge_refund</code> ç»„ä»¶çš„å‰ææ˜¯æ‰§è¡Œæ‰€æœ‰å…¶ä»–ç»„ä»¶</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><p>åšå®¢</p><ul><li><p><a href="https://martinfowler.com/bliki/RulesEngine.html">RulesEngine (martinfowler.com)</a></p></li><li><p><a href="https://refactoring.guru/design-patterns/catalog">The Catalog of Design Patterns (refactoring.guru)</a></p></li></ul></li><li><p>å®˜æ–¹æ–‡æ¡£</p><ul><li><a href="https://www.drools.org/learn/documentation.html">Drools - Documentation</a></li><li><a href="https://liteflow.yomahub.com/">LiteFlow (yomahub.com)</a></li><li><a href="http://waitmoon.com/zh/">å¼€æºæ¡†æ¶å­¦ä¹ ä¸åˆ†äº« | ice (waitmoon.com)</a></li><li><a href="https://www.yuque.com/boyan-avfmj/aviatorscript/guhmrc">AviatorScript æ–‡æ¡£ | ä»‹ç» (yuque.com)</a></li></ul></li><li><p>æŠ€æœ¯æ–‡ç« </p><ul><li><a href="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a></li><li><a href="https://juejin.cn/post/6844903593326182414">å¤§æ•°æ®ï¼šç¾å›¢é…’æ—…å®æ—¶æ•°æ®è§„åˆ™å¼•æ“åº”ç”¨å®è·µ - æ˜é‡‘ (juejin.cn)</a></li><li><a href="https://juejin.cn/post/7234763686475219003">è§„åˆ™å¼•æ“åœ¨å†…å®¹ç®¡ç†ä¸­çš„æ¢ç´¢ä¸åº”ç”¨ - æ˜é‡‘ (juejin.cn)</a></li><li><a href="https://juejin.cn/post/7195452429154910263">è´§æ‹‰æ‹‰å¤§æ•°æ®åŸºäºè§„åˆ™å¼•æ“æ„å»ºè¿åŠ›èµ„æºä¾›éœ€è°ƒèŠ‚ç³»ç»Ÿ - æ˜é‡‘ (juejin.cn)</a></li><li><a href="https://blog.csdn.net/zhuanzhuantech/article/details/127648871">è½¬è½¬å›¾ä¹¦å¯¹åŸºäºDroolså¼•æ“çš„DMNå®è·µ_dmnå¼•æ“_è½¬è½¬æŠ€æœ¯å›¢é˜Ÿçš„åšå®¢-CSDNåšå®¢</a></li><li><a href="http://www.uml.org.cn/modeler/201912044.asp">DMN å†³ç­–æ¨¡å‹æ ‡è®°ä»‹ç» (uml.org.cn)</a></li><li><a href="https://www.jianshu.com/p/650ecc341417">Droolsï¼šè§„åˆ™åŠ è½½ &amp; åŠ¨æ€æ›´æ–°æ–¹æ¡ˆ</a></li></ul></li><li><p>å¼€æºè½¯ä»¶</p><ul><li><a href="https://github.com/hyperjumptech/grule-rule-engine#use-cases">hyperjumptech&#x2F;grule-rule-engine: Rule engine implementation in Golang (github.com)</a></li><li><a href="https://github.com/momosecurity/aswan">momosecurity&#x2F;aswan: é™Œé™Œé£æ§ç³»ç»Ÿé™æ€è§„åˆ™å¼•æ“ï¼Œé›¶åŸºç¡€ç®€æ˜“ä¾¿æ·çš„é…ç½®å¤šç§å¤æ‚è§„åˆ™ï¼Œå®æ—¶é«˜æ•ˆç®¡æ§ç”¨æˆ·å¼‚å¸¸è¡Œä¸ºã€‚ (github.com)</a></li></ul></li><li><p>å…¶ä»–</p><ul><li><a href="https://www.drools.org/learn/DroolsMangaRuleDrivenDevelpment_EN.pdf">DroolsMangaRuleDrivenDevelpment_EN.pdf</a></li><li><a href="https://learn-dmn-in-15-minutes.com/learn/introduction">Learn DMN in 15 minutes | Introduction (learn-dmn-in-15-minutes.com)</a></li><li><a href="https://sandbox.kie.org/#/">KIE Sandbox :: Home</a></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LiteFlow </tag>
            
            <tag> è§„åˆ™å¼•æ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redisson RateLimiter</title>
      <link href="/%E5%BC%80%E5%8F%91/Redis/Redisson%20RateLimiter.html"/>
      <url>/%E5%BC%80%E5%8F%91/Redis/Redisson%20RateLimiter.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å¯¹äºå•æœºé™æµï¼Œå¯ä»¥ä½¿ç”¨ Guava ç­‰å·¥å…·</p><p>å¦‚æœéœ€è¦å¯¹æ‰€æœ‰æœåŠ¡è¿›è¡Œé™æµï¼Œå°±éœ€è¦ä½¿ç”¨ä¾èµ–åŒä¸€ä¸ªæ•°æ®èµ„æº</p><p>ç®€å•çš„æ–¹æ¡ˆå¯ä»¥ä½¿ç”¨ Redis è®°å½•é™æµç›¸å…³ä¿¡æ¯è¿›è¡Œå®ç°ï¼ŒRedisson çš„ <code>RRateLimiter</code> å°±æ˜¯åŸºäº Redis å®ç°çš„å…¨å±€é™æµå·¥å…·ï¼Œä½¿ç”¨äº†ä»¤ç‰Œæ¡¶çš„æ€æƒ³</p><h1 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h1><p><strong>åˆ›å»ºé™æµå™¨ï¼Œå°è¯•è®¾ç½®é™æµé…ç½®</strong></p><p>ç±»å‹ä¸º <code>RateType.OVERALL</code>ï¼Œä¸ºå…¨å±€é™æµï¼›permits æ•°é‡ä¸º 1s 100 ä¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// Redisson å®¢æˆ·ç«¯è¿æ¥ Redis</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://***&quot;</span>).setPassword(<span class="string">&quot;***&quot;</span>);</span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// åˆ›å»º RRateLimiter</span></span><br><span class="line">        <span class="type">RRateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> redissonClient.getRateLimiter(<span class="string">&quot;test.limiter&quot;</span>);</span><br><span class="line">      <span class="comment">// é…ç½®</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> rateLimiter.trySetRate(RateType.OVERALL, <span class="number">100</span>, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;success:&#123;&#125;&quot;</span>, success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹é™æµé…ç½®</strong></p><p>ä½¿ç”¨ <code>rateLimiter.setRate</code> æ–¹æ³•é‡æ–°é…ç½®é™æµç›¸å…³å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://***&quot;</span>).setPassword(<span class="string">&quot;***&quot;</span>);</span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">      </span><br><span class="line">        <span class="type">RRateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> redissonClient.getRateLimiter(<span class="string">&quot;test.limiter&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é‡æ–°é…ç½®</span></span><br><span class="line">        rateLimiter.setRate(RateType.OVERALL, <span class="number">200</span>, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–ä»¤ç‰Œ</strong></p><p>ä½¿ç”¨ <code>rateLimiter.acquire</code> ç­‰æ–¹æ³•è·å–é™æµè®¸å¯</p><p><code>accquire</code> å’Œ <code>tryAccquire</code> çš„åŒºåˆ«å’Œå¤§éƒ¨åˆ†é™æµã€é”å·¥å…·ä¸€è‡´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://***&quot;</span>).setPassword(<span class="string">&quot;***&quot;</span>);</span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">      </span><br><span class="line">        <span class="type">RRateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> redissonClient.getRateLimiter(<span class="string">&quot;test.limiter&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// acquire</span></span><br><span class="line">        rateLimiter.acquire(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tryAcquire</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> rateLimiter.tryAcquire(<span class="number">2</span>);</span><br><span class="line">        log.info(<span class="string">&quot;success:&#123;&#125;&quot;</span>, success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><h2 id="RRateLimiter"><a href="#RRateLimiter" class="headerlink" title="RRateLimiter"></a>RRateLimiter</h2><p>Redisson ä¸­ï¼Œæ“ä½œä»¤ç‰Œçš„å¯¹è±¡è¢«åŒ…è£…ä¸ºäº† <code>RRateLimiter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RRateLimiter</span> <span class="keyword">extends</span> <span class="title class_">RRateLimiterAsync</span>, RExpirable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">trySetRate</span><span class="params">(RateType mode, <span class="type">long</span> rate, <span class="type">long</span> rateInterval, RateIntervalUnit rateIntervalUnit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setRate</span><span class="params">(RateType mode, <span class="type">long</span> rate, <span class="type">long</span> rateInterval, RateIntervalUnit rateIntervalUnit)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> permits)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">long</span> permits)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> permits, <span class="type">long</span> timeout, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line">    RateLimiterConfig <span class="title function_">getConfig</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="title function_">availablePermits</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ç°ç±» <code>RedissonRateLimiter</code> ç»§æ‰¿äº† <code>RedissonExpirable</code></p><p>æä¾›äº†å¤šä¸ªæ–¹æ³•æ¥æ‹¼è£…ä¸šåŠ¡ä¸­éœ€è¦ç”¨åˆ°çš„ keyï¼Œåœ¨åç»­çš„ acquire ç­‰æ–¹æ³•ä¸­å°†ä½œä¸º Lua è„šæœ¬å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> <span class="keyword">extends</span> <span class="title class_">RedissonExpirable</span> <span class="keyword">implements</span> <span class="title class_">RRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„é€ æ–¹æ³•ï¼Œä¸»è¦æ˜¯ super RedissonExpirable</span></span><br><span class="line">  <span class="comment">// RedissonRateLimiter æœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆæˆå‘˜å±æ€§</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedissonRateLimiter</span><span class="params">(CommandAsyncExecutor commandExecutor, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(commandExecutor, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¼è£…å…¨å±€ permits key</span></span><br><span class="line">    String <span class="title function_">getPermitsName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getRawName(), <span class="string">&quot;permits&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¼è£…å• Redis å®ä¾‹ permits key</span></span><br><span class="line">    String <span class="title function_">getClientPermitsName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getPermitsName(), getServiceManager().getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¼è£…å…¨å±€ value key</span></span><br><span class="line">    String <span class="title function_">getValueName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getRawName(), <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// æ‹¼è£…å• Redis å®ä¾‹ value key</span></span><br><span class="line">    String <span class="title function_">getClientValueName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getValueName(), getServiceManager().getId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªæµç¨‹ä¸­éœ€è¦ç”¨åˆ°ä»¥ä¸‹çš„ keyï¼š</p><ul><li>nameï¼šé™æµé…ç½®</li><li>suffixName(getRawName(), â€œpermitsâ€)ï¼šè®¸å¯æˆæƒè®°å½•</li><li>suffixName(getRawName(), â€œvalueâ€)ï¼šå¯ç”¨è®¸å¯æ•°é‡</li></ul><p><strong>åœ¨ä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»è¿™å‡ ä¸ª key çš„ä½œç”¨</strong></p><h2 id="é™æµé…ç½®"><a href="#é™æµé…ç½®" class="headerlink" title="é™æµé…ç½®"></a>é™æµé…ç½®</h2><p>é…ç½®é™æµå‚æ•°æ—¶ï¼Œä¼šä½¿ç”¨è®¾å®šçš„ key name è®°å½•é™æµçš„é…ç½®ä¿¡æ¯</p><p><code>setRate</code> å’Œ <code>trySetRate</code> çš„åŒºåˆ«åœ¨äºä¸€ä¸ªä½¿ç”¨ <code>setNx</code>ï¼Œä¸€ä¸ªä½¿ç”¨ <code>set</code> è¦†ç›–ï¼Œå¹¶ä¸”ä¼šåˆ é™¤ permits å’Œ value çš„è®°å½•</p><p>æœ¬è´¨ä¸Šå°±æ˜¯åœ¨æ“ä½œ key è®¾ç½®é™æµå±æ€§</p><hr><p>å‡è®¾ <code>RRateLimiter</code> å¯¹è±¡è®¾ç½®çš„ name ä¸º <code>test.limiter</code></p><p>å…¶ä¸­å‚æ•° keysï¼š</p><ol><li>test.limiter</li><li>{test.limiter}:value</li><li>{test.limiter}:value:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li><li>{test.limiter}:permits</li><li>{test.limiter}:permits:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li></ol><p>å…¶ä¸­ 407cd24e-03e1-4745-9684-5aea2ffd4b5f æ˜¯ Redisson ç”Ÿæˆçš„æ ‡è®°ï¼Œä¸ºäº†å®ç° Redisson å®ä¾‹çº§åˆ«çš„é™æµæ§åˆ¶</p><p>å‚æ•° argsï¼š</p><ol><li>rateï¼šäº§å‡ºçš„ä»¤ç‰Œæ•°é‡</li><li>rateIntervalï¼šæ—¶é—´é—´éš”çš„æ¯«ç§’å€¼</li><li>typeï¼šç±»å‹ï¼›0 æ˜¯ OVERALL å…¨å±€ï¼›1 æ˜¯ PER_CLIENT Redisson å®ä¾‹çº§åˆ«</li></ol><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> valueName = KEYS[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">local</span> permitsName = KEYS[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">if</span> ARGV[<span class="number">3</span>] == <span class="string">&#x27;1&#x27;</span> <span class="keyword">then</span></span><br><span class="line">valueName = KEYS[<span class="number">3</span>];</span><br><span class="line">permitsName = KEYS[<span class="number">5</span>];</span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line">redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;rate&#x27;</span>, ARGV[<span class="number">1</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;interval&#x27;</span>, ARGV[<span class="number">2</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;type&#x27;</span>, ARGV[<span class="number">3</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;del&#x27;</span>, valueName, permitsName);</span><br></pre></td></tr></table></figure><p>ä»è„šæœ¬æ¥çœ‹ï¼Œä¸»è¦è¿˜æ˜¯æ“ä½œ Hash keyï¼Œè®¾ç½®å…¶ <code>rate</code>ã€<code>interval</code>ã€<code>type</code> æˆå‘˜ä¸ºå‚æ•°ä¸­çš„ä¸åŒå€¼</p><p>æœ€ååˆ é™¤ valueã€permits çš„ keyï¼ˆå› ä¸ºå˜æ›´äº† rateï¼Œè¿™ä¸¤ä¸ªè®°å½•å°±ä¸å‡†ç¡®äº†ï¼ŒGuava çš„ RateLimiter ä¸­ä¼šå¹³æ»‘å˜æ›´ï¼ŒRedisson çš„å®ç°ä¸­ç²—æš´ä¸€äº›ï¼Œé€‰æ‹©äº†ç›´æ¥åˆ é™¤ï¼‰</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;hsetnx&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;rate&#x27;</span>, ARGV[<span class="number">1</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;hsetnx&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;interval&#x27;</span>, ARGV[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#x27;hsetnx&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;type&#x27;</span>, ARGV[<span class="number">3</span>]);</span><br></pre></td></tr></table></figure><p>åœ¨ <code>trySetRate</code> ä¸­ç›´æ¥ä½¿ç”¨ <code>hsetnx</code>ï¼Œå¹¶ä¸”æ²¡æœ‰åˆ é™¤ key çš„æ“ä½œï¼Œç”¨äºåˆå§‹åŒ–</p><h2 id="ä»¤ç‰Œè·å–"><a href="#ä»¤ç‰Œè·å–" class="headerlink" title="ä»¤ç‰Œè·å–"></a>ä»¤ç‰Œè·å–</h2><p>æ ¸å¿ƒçš„ä»¤ç‰Œè·å–æ–¹æ³•åœ¨ <code>tryAcquireAsync</code> ä¸­</p><p><code>acquire</code> å’Œ <code>tryAcquire</code> åŒºåˆ«åœ¨äº <code>tryAcquire</code> å¤šäº† timeout å‚æ•°å’Œè¿”å›å€¼ï¼Œç”¨äºç¡®å®šæ˜¯å¦ç­‰å¾…æ—¶é—´åœ¨æœŸæœ›å€¼ä»¥å†…ï¼Œ<code>acquire</code> åˆ™ä¼šé˜»å¡ï¼Œç›´åˆ°è·å–ç»“æœ</p><hr><p>å…¶ä¸­å‚æ•° keysï¼š</p><ol><li>test.limiter</li><li>{test.limiter}:value</li><li>{test.limiter}:value:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li><li>{test.limiter}:permits</li><li>{test.limiter}:permits:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li></ol><p>keys çš„å€¼å’Œé™æµé…ç½®éƒ¨åˆ†æ˜¯ä¸€æ ·çš„</p><p>å‚æ•° argsï¼š</p><ol><li>valueï¼šè·å–çš„ä»¤ç‰Œæ•°é‡</li><li>System.currentTimeMillisï¼šå½“å‰æ—¶é—´æˆ³</li><li>getServiceManager().generateIdArray()ï¼šç”Ÿæˆçš„éšæœºå­—èŠ‚æ•°ï¼Œå…¶ä¸­éšæœºç”Ÿæˆå™¨ä½¿ç”¨çš„æ˜¯ <code>ThreadLocalRandom</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">-- è·å–é…ç½®ï¼Œæ ¡éªŒæ˜¯å¦å­˜åœ¨ RateLimiter é…ç½®</span><br><span class="line"><span class="type">local</span> <span class="variable">rate</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;hget&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;rate&#x27;</span>);</span><br><span class="line"><span class="type">local</span> <span class="variable">interval</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;hget&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;interval&#x27;</span>);</span><br><span class="line"><span class="type">local</span> <span class="variable">type</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;hget&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;type&#x27;</span>);</span><br><span class="line"><span class="keyword">assert</span>(rate ~= <span class="literal">false</span> and interval ~= <span class="literal">false</span> and type ~= <span class="literal">false</span>, <span class="string">&#x27;RateLimiter is not initialized&#x27;</span>)</span><br><span class="line"></span><br><span class="line">-- æ ¹æ® type é€‰æ‹©ä¸åŒçš„ value å’Œ permits key</span><br><span class="line"><span class="type">local</span> <span class="variable">valueName</span> <span class="operator">=</span> KEYS[<span class="number">2</span>];<span class="string">&quot;</span></span><br><span class="line"><span class="string">local permitsName = KEYS[4];&quot;</span></span><br><span class="line">type == <span class="string">&#x27;1&#x27;</span> then <span class="string">&quot;</span></span><br><span class="line"><span class="string">  valueName = KEYS[3];</span></span><br><span class="line"><span class="string">permitsName = KEYS[5];</span></span><br><span class="line"><span class="string">end;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- åˆ¤æ–­è·å–çš„ä»¤ç‰Œæ•°é‡æ˜¯ä¸æ˜¯å·²ç»å¤§äºé™æµå™¨çš„é…ç½®</span></span><br><span class="line"><span class="string">assert(tonumber(rate) &gt;= tonumber(ARGV[1]), &#x27;Requested permits amount could not exceed defined rate&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">local currentValue = redis.call(&#x27;get&#x27;, valueName);</span></span><br><span class="line"><span class="string">local res;</span></span><br><span class="line"><span class="string">if currentValue ~= false then</span></span><br><span class="line"><span class="string">  -- æŸ¥è¯¢æ—¶é—´çª—å£ä»¥å¤–çš„è®¸å¯</span></span><br><span class="line"><span class="string">  -- permits çš„ç»“æ„ä¸º score æ˜¯å‘æ”¾æ—¶é—´æˆ³ï¼›value æ˜¯ 8 å­—èŠ‚éšæœºå€¼ + è®¸å¯æ•°é‡</span></span><br><span class="line"><span class="string">local expiredValues = redis.call(&#x27;zrangebyscore&#x27;, permitsName, 0, tonumber(ARGV[2]) - interval);</span></span><br><span class="line"><span class="string">local released = 0;</span></span><br><span class="line"><span class="string">for i, v in ipairs(expiredValues) do</span></span><br><span class="line"><span class="string">      -- äºŒè¿›åˆ¶æ•°æ®ï¼Œè§£åŒ…è§„åˆ™ä¸º Bc0I</span></span><br><span class="line"><span class="string">local random, permits = struct.unpack(&#x27;Bc0I&#x27;, v);&quot;</span></span><br><span class="line">      -- è®°å½•æ—¶é—´çª—å£è®¸å¯æ•°é‡</span><br><span class="line">released = released + permits;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">-- å­˜åœ¨å¯ä»¥é‡Šæ”¾çš„è®¸å¯</span><br><span class="line"><span class="keyword">if</span> released &gt; <span class="number">0</span> then</span><br><span class="line">      -- åˆ é™¤ permits è®°å½•</span><br><span class="line">    redis.call(<span class="string">&#x27;zremrangebyscore&#x27;</span>, permitsName, <span class="number">0</span>, tonumber(ARGV[<span class="number">2</span>]) - interval);</span><br><span class="line">-- é‡æ–°ç»´æŠ¤ä¸‹ value</span><br><span class="line"><span class="keyword">if</span> <span class="title function_">tonumber</span><span class="params">(currentValue)</span> + released &gt; tonumber(rate) <span class="type">then</span></span><br><span class="line"><span class="variable">currentValue</span> <span class="operator">=</span> tonumber(rate) - redis.call(<span class="string">&#x27;zcard&#x27;</span>, permitsName);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">           currentValue = tonumber(currentValue) + released;</span><br><span class="line">        end;</span><br><span class="line">-- æ›´æ–°</span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, valueName, currentValue);</span><br><span class="line">   end;</span><br><span class="line"></span><br><span class="line">-- æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œæ»¡è¶³è¿™æ¬¡è¯·æ±‚</span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">tonumber</span><span class="params">(currentValue)</span> &lt; tonumber(ARGV[<span class="number">1</span>]) then</span><br><span class="line">   <span class="type">local</span> <span class="variable">firstValue</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;zrange&#x27;</span>, permitsName, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&#x27;withscores&#x27;</span>);</span><br><span class="line">-- æ²¡æœ‰ï¼Œè¿”å›ç­‰å¾…æ—¶é—´</span><br><span class="line">        res = <span class="number">3</span> + interval - (tonumber(ARGV[<span class="number">2</span>]) - tonumber(firstValue[<span class="number">2</span>]));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      -- æ— éœ€ç­‰å¾…ï¼›æ›´æ–° permits å’Œ value</span><br><span class="line">        redis.call(<span class="string">&#x27;zadd&#x27;</span>, permitsName, ARGV[<span class="number">2</span>], struct.pack(<span class="string">&#x27;Bc0I&#x27;</span>, string.len(ARGV[<span class="number">3</span>]), ARGV[<span class="number">3</span>], ARGV[<span class="number">1</span>]));</span><br><span class="line">        redis.call(<span class="string">&#x27;decrby&#x27;</span>, valueName, ARGV[<span class="number">1</span>]);</span><br><span class="line">        res = nil;</span><br><span class="line">    end;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  -- value å€¼ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è·å–ä»¤ç‰Œ</span><br><span class="line">    redis.call(<span class="string">&#x27;set&#x27;</span>, valueName, rate);</span><br><span class="line">    redis.call(<span class="string">&#x27;zadd&#x27;</span>, permitsName, ARGV[<span class="number">2</span>], struct.pack(<span class="string">&#x27;Bc0I&#x27;</span>, string.len(ARGV[<span class="number">3</span>]), ARGV[<span class="number">3</span>], ARGV[<span class="number">1</span>]));</span><br><span class="line">    redis.call(<span class="string">&#x27;decrby&#x27;</span>, valueName, ARGV[<span class="number">1</span>]);</span><br><span class="line">    res = nil;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">-- æ ¹æ®é…ç½®æ›´æ–° value å’Œ permits çš„è¿‡æœŸæ—¶é—´</span><br><span class="line"><span class="type">local</span> <span class="variable">ttl</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;pttl&#x27;</span>, KEYS[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">if</span> ttl &gt; <span class="number">0</span> then</span><br><span class="line">redis.call(<span class="string">&#x27;pexpire&#x27;</span>, valueName, ttl);</span><br><span class="line">redis.call(<span class="string">&#x27;pexpire&#x27;</span>, permitsName, ttl);</span><br><span class="line">end;</span><br><span class="line"><span class="keyword">return</span> res;</span><br></pre></td></tr></table></figure><p>ç»“åˆ Lua è„šæœ¬ä¸­çš„æ³¨é‡Šï¼Œæµç¨‹å¯ä»¥ç®€ç•¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><ol><li>æ ¡éªŒ RateLimiter æ˜¯å¦å­˜åœ¨</li><li>æ ¡éªŒè·å–çš„ä»¤ç‰Œæ•°é‡æ˜¯ä¸æ˜¯å·²ç»è¶…è¿‡ RateLimiter çš„ rate é…ç½®ï¼›assert</li><li>è·å– currentValueï¼Œä¸ºç°æœ‰ä»¤ç‰Œæ•°é‡</li><li>currentValue å­˜åœ¨åˆ™æŸ¥è¯¢çª—å£æ—¶é—´å†…å‘æ”¾çš„è®°å½•ï¼Œè¿›è¡Œé‡Šæ”¾</li><li>åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿä»¤ç‰Œæ»¡è¶³è¿™æ¬¡è¯·æ±‚ï¼›æ»¡è¶³ç›´æ¥å‘æ”¾ï¼Œè¿”å› nilï¼›ä¸æ»¡è¶³åˆ™è¿”å›ç­‰å¾…æ—¶é—´<br>ç­‰å¾…æ—¶é—´çš„è®¡ç®—è§„åˆ™ï¼š3 + ä»¤ç‰Œäº§å‡ºé—´éš” - (å½“å‰æ—¶é—´ - æœ€æ—©ä¸€æ¬¡ ä»¤ç‰Œå‘æ”¾æ—¶é—´)</li><li>æ ¹æ®é…ç½®æ›´æ–° value å’Œ permits çš„è¿‡æœŸæ—¶é—´ï¼›ç®€å•ç†è§£ï¼Œé…ç½®ä¸å­˜åœ¨äº†ï¼Œvalue å’Œ permits è®°å½•ä¹Ÿæ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº†</li></ol><p><strong>æµç¨‹å›¾</strong></p><img src="/%E5%BC%80%E5%8F%91/Redis/Redisson%20RateLimiter/Redisson%20RateLimiter%20%E6%B5%81%E7%A8%8B%E5%9B%BE.png" class="" title="Redisson RateLimiter æµç¨‹å›¾"><h2 id="delay-æ—¶é—´å¤„ç†"><a href="#delay-æ—¶é—´å¤„ç†" class="headerlink" title="delay æ—¶é—´å¤„ç†"></a>delay æ—¶é—´å¤„ç†</h2><p>Redis æ“ä½œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ª delay æ—¶é—´ï¼Œå¦‚æœä¸éœ€è¦ç­‰å¾…ï¼Œå³å·²ç»è·å–åˆ°ä»¤ç‰Œåˆ™è¿”å› nil</p><p>æ‰€ä»¥å½“å®¢æˆ·ç«¯æ‹¿åˆ°æœ€åçš„ delay å€¼åï¼Œå°†ä¼šè¿›è¡Œä¸€ç³»åˆ—çš„åˆ¤æ–­å’Œå¤„ç†</p><p>æ ¸å¿ƒä¸»è¦æ˜¯åœ¨ <code>tryAcquireAsync</code> æ–¹æ³•ï¼Œéå¼‚æ­¥æ–¹æ³•å°±æ˜¯ä¸Šæ¸¸æ–¹æ³•ä½¿ç”¨ get è¿›è¡Œé˜»å¡è·å–å®Œæˆç»“æœæ¥å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CompletableFuture&lt;Boolean&gt; <span class="title function_">tryAcquireAsync</span><span class="params">(<span class="type">long</span> permits, <span class="type">long</span> timeoutInMillis)</span> &#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">s</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">      RFuture&lt;Long&gt; future = tryAcquireAsync(RedisCommands.EVAL_LONG, permits);</span><br><span class="line">      <span class="keyword">return</span> future.thenCompose(delay -&gt; &#123;</span><br><span class="line">        <span class="comment">// Redis è¿”å› nilï¼Œè¯´æ˜ç«‹å³ç­¾å‘äº†ä»¤ç‰Œ</span></span><br><span class="line">          <span class="keyword">if</span> (delay == <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">        <span class="comment">// ä¸é™æ—¶</span></span><br><span class="line">          <span class="keyword">if</span> (timeoutInMillis == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›çš„ CompletableFuture</span></span><br><span class="line">              CompletableFuture&lt;Boolean&gt; f = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">              getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// é€’å½’è°ƒç”¨ tryAcquireAsync</span></span><br><span class="line">                  CompletableFuture&lt;Boolean&gt; r = tryAcquireAsync(permits, timeoutInMillis);</span><br><span class="line">                <span class="comment">// è½¬æ¢ CompletableFuture è¿”å›å€¼</span></span><br><span class="line">                  commandExecutor.transfer(r, f);</span><br><span class="line">              &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">              <span class="keyword">return</span> f;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">        <span class="comment">// ä¸Šé¢æ“ä½œçš„è€—æ—¶ï¼ˆå½“å‰æ—¶é—´ - å…¥å£å¼€å§‹æ—¶é—´ï¼‰</span></span><br><span class="line">          <span class="type">long</span> <span class="variable">el</span> <span class="operator">=</span> System.currentTimeMillis() - s;</span><br><span class="line">        <span class="comment">// å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´</span></span><br><span class="line">          <span class="type">long</span> <span class="variable">remains</span> <span class="operator">=</span> timeoutInMillis - el;</span><br><span class="line">        <span class="comment">// å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´å°äº 0ï¼Œè¿”å› false</span></span><br><span class="line">          <span class="keyword">if</span> (remains &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="literal">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          CompletableFuture&lt;Boolean&gt; f = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´æ¯”éœ€è¦ç­‰å¾…çš„æ—¶é—´è¦å°</span></span><br><span class="line">          <span class="keyword">if</span> (remains &lt; delay) &#123;</span><br><span class="line">            <span class="comment">// å®šæ—¶è¿”å› false</span></span><br><span class="line">              getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">                  f.complete(<span class="literal">false</span>);</span><br><span class="line">              &#125;, remains, TimeUnit.MILLISECONDS);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é‡æ–°ä¸€è½®è·å–</span></span><br><span class="line">              <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">              getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">                  <span class="type">long</span> <span class="variable">elapsed</span> <span class="operator">=</span> System.currentTimeMillis() - start;</span><br><span class="line">                <span class="comment">// è¿‡ç¨‹ä¸­è¶…æ—¶äº†</span></span><br><span class="line">                  <span class="keyword">if</span> (remains &lt;= elapsed) &#123;</span><br><span class="line">                      f.complete(<span class="literal">false</span>);</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  CompletableFuture&lt;Boolean&gt; r = tryAcquireAsync(permits, remains - elapsed);</span><br><span class="line">                  commandExecutor.transfer(r, f);</span><br><span class="line">              &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> f;</span><br><span class="line">      &#125;).toCompletableFuture();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨äº† <code>tryAcquireAsync(RedisCommands.EVAL_LONG, permits)</code> çš„é‡è½½æ–¹æ³•ï¼›è¿™ä¸ªæ–¹æ³•å¤„ç† delay ç»“æœï¼›é‡è½½çš„æ–¹æ³•åˆ™æ˜¯å’Œ Redis äº¤äº’ä»¤ç‰Œè·å–çš„é€»è¾‘</p><p>æ‹¿åˆ° Redis è¿”å›æ—¶åˆ†ä¸ºå‡ ç§æƒ…å†µï¼š</p><ul><li>ä¸º null è¯´æ˜ä¸éœ€è¦ç­‰å¾…ï¼Œå·²ç»è·å–äº†ä»¤ç‰Œ</li><li>æ²¡æœ‰æœŸæœ›ç­‰å¾…æ—¶é—´ï¼Œç”Ÿæˆä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œdelay ä¸º Redis è¿”å›çš„ç­‰å¾…æ—¶é—´</li><li>è®¡ç®—å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™ç›´æ¥è¿”å› false</li><li>å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´å°äº delayï¼Œå»¶è¿Ÿåè¿”å› false</li><li>æœ€åå¼€å§‹é€’å½’ä¸€è½®è·å–</li></ul><h1 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h1><h2 id="å¼‚æ­¥ä»»åŠ¡çš„é€’å½’"><a href="#å¼‚æ­¥ä»»åŠ¡çš„é€’å½’" class="headerlink" title="å¼‚æ­¥ä»»åŠ¡çš„é€’å½’"></a>å¼‚æ­¥ä»»åŠ¡çš„é€’å½’</h2><p>Redisson ä¸­çš„å¾ˆå¤šè®¾è®¡éƒ½æ˜¯æ„é€ ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œè¿”å›å€¼åŒ…è£…ä¸º <code>CompletableFuture</code>ï¼ŒåŒæ­¥æ¥å£å°±æ˜¯ç›´æ¥è°ƒç”¨å…¶ get æ–¹æ³•é˜»å¡ç­‰å¾…</p><p>å¯¹äºå¼‚æ­¥æ–¹æ³•å¦‚ä½•é€’å½’å‘¢ï¼Œå› ä¸ºæœ€ç»ˆæ¥å£éœ€è¦è¿”å›ä¸€ä¸ª <code>CompletableFuture</code>ï¼Œä¸èƒ½ <code>CompletableFuture</code> åµŒå¥— <code>CompletableFuture</code>ï¼Œå› ä¸ºä¸Šæ¸¸è°ƒç”¨æ–¹ä¹Ÿä¸çŸ¥é“é€’å½’äº†å‡ å±‚</p><p>Redisson çš„æ–¹æ³•æ˜¯åœ¨å¼‚æ­¥é€’å½’ä¹‹å‰å…ˆå®šä¹‰å‡ºä¸€ä¸ª <code>CompletableFuture</code> ä½œä¸ºè¿”å›å€¼ï¼Œå†æœ€åå¼‚æ­¥æ‰§è¡Œå®Œåä½¿ç”¨ transfer æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (timeoutInMillis == -<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// è¿”å›çš„ CompletableFuture</span></span><br><span class="line">    CompletableFuture&lt;Boolean&gt; f = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">    getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">        CompletableFuture&lt;Boolean&gt; r = tryAcquireAsync(permits, timeoutInMillis);</span><br><span class="line">      <span class="comment">// å¼‚æ­¥ä»»åŠ¡ä¸­è¿›è¡Œ transfer</span></span><br><span class="line">        commandExecutor.transfer(r, f);</span><br><span class="line">    &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>transfer çš„æ“ä½œæœ¬è´¨ä¸Šæ˜¯ä½¿ç”¨ <code>whenComplete</code>ï¼Œå°†æ–°çš„æœ€ç»ˆé€’å½’å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼ï¼ˆå¼‚å¸¸ï¼‰ä¼ é€’ç»™è¿”å›å€¼å¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommandAsyncService</span> <span class="keyword">implements</span> <span class="title class_">CommandAsyncExecutor</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;V&gt; <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(CompletionStage&lt;V&gt; future1, CompletableFuture&lt;V&gt; future2)</span> &#123;</span><br><span class="line">        future1.whenComplete((res, e) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                future2.completeExceptionally(e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            future2.complete(res);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå®ç°å¼‚æ­¥ä»»åŠ¡çš„é€’å½’æ“ä½œ</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://juejin.cn/post/7198826344582676538?searchId=202308071543501DA8932282EC1F20B8C7">è¯¦è§£Redissonåˆ†å¸ƒå¼é™æµçš„å®ç°åŸç† - æ˜é‡‘ (juejin.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Redis è„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§‚å¯Ÿè€…æ¨¡å¼ - Observer</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%20-%20Observer.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%20-%20Observer.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰ç”¨æ¥å¤„ç†æŸä¸ªå€¼å¾—å…³æ³¨çš„çŠ¶æ€çš„å¯¹è±¡çŠ¶æ€å˜æ›´ï¼Œè¿›è€Œæ‰§è¡Œç›¸åº”çš„æ“ä½œ</p><p>å°†è‡ªèº«çš„çŠ¶æ€æ”¹å˜é€šçŸ¥ç»™å…¶ä»–å¯¹è±¡ï¼Œ æˆ‘ä»¬ä¹Ÿå°†å…¶ç§°ä¸º <em>å‘å¸ƒè€…</em> ï¼ˆpublisherï¼‰</p><p>æ‰€æœ‰å¸Œæœ›å…³æ³¨å‘å¸ƒè€…çŠ¶æ€å˜åŒ–çš„å…¶ä»–å¯¹è±¡è¢«ç§°ä¸º <em>è®¢é˜…è€…</em> ï¼ˆsubscribersï¼‰</p><p>æ‰€æœ‰è®¢é˜…è€…éƒ½å¿…é¡»å®ç°åŒæ ·çš„æ¥å£ï¼Œ å‘å¸ƒè€…ä»…é€šè¿‡è¯¥æ¥å£ä¸è®¢é˜…è€…äº¤äº’ï¼Œ æ¥å£ä¸­å¿…é¡»å£°æ˜é€šçŸ¥æ–¹æ³•åŠå…¶å‚æ•°ï¼Œ è¿™æ ·å‘å¸ƒè€…åœ¨å‘å‡ºé€šçŸ¥æ—¶è¿˜èƒ½ä¼ é€’ä¸€äº›ä¸Šä¸‹æ–‡æ•°æ®</p><p><strong>ç›®çš„</strong></p><p>å®ç°ä¸€ç§è®¢é˜…æœºåˆ¶ï¼Œå¯åœ¨å¯¹è±¡äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å¤šä¸ª â€œè§‚å¯Ÿâ€ è¯¥å¯¹è±¡çš„å…¶ä»–å¯¹è±¡ï¼›è®¢é˜…è€…èƒ½åœ¨ä¸ä¸å…·ä½“å‘å¸ƒè€…ç±»è€¦åˆçš„æƒ…å†µä¸‹é€šè¿‡æ¥å£è§‚å¯Ÿå‘å¸ƒè€…çš„çŠ¶æ€</p><p><strong>çœŸå®ä¸–ç•Œç±»æ¯”</strong></p><p>å•†åº—ç¼ºè´§æ—¶ï¼Œç”¨æˆ·å‘å•†åº—ç™»è®°è”ç³»ç”µè¯ï¼Œå½“è¡¥è´§åå•†åº—é€šè¿‡ç”µè¯é€šçŸ¥å¯¹è¯¥å•†å“ï¼ˆäº‹ä»¶ï¼‰æ„Ÿå…´è¶£çš„ç”¨æˆ·ï¼›è€Œä¸æ˜¯ï¼š</p><ul><li>ç”¨æˆ·é¢‘ç¹åˆ°è¾¾å•†åº—æŸ¥è¯¢æ˜¯å¦åˆ°è´§</li><li>å•†å“é€šçŸ¥æ‰€æœ‰ç”¨æˆ·ç¼ºè´§å•†å“åˆ°è´§</li></ul><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œå®ç°ä¸€ä¸ªæ—¥å¿—è£…é¥°ï¼Œå½“æ—¥å¿—ä¿¡æ¯æ‰“å°å¼‚å¸¸æ—¶ï¼Œè¿›è¡Œç›¸åº”æ—¥å¿—ç­‰çº§çš„å¤„ç†ï¼š</p><ul><li>warn çº§åˆ«å‘é€é‚®ä»¶</li><li>error çº§åˆ«ç”µè¯é€šçŸ¥</li></ul><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å¯ä»¥å¯¹æ—¥å¿—å®ç°è¿›è¡ŒåŒ…è£…ï¼Œåœ¨å¯¹åº”çš„æ—¥å¿—çº§åˆ«æ–¹æ³•è¿›è¡Œå¢å¼º</p><p>ä¾‹å¦‚ï¼Œå®ç°ä¸€ä¸ª <code>MyLogger</code> çš„è£…é¥°ç±»ï¼Œå°†å¢å¼ºçš„æ–¹æ³•å†™åœ¨ç›¸å…³è£…é¥°çš„æ–¹æ³•ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogger</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TinyLog</span> <span class="variable">log</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TinyLog</span>(<span class="string">&quot;MyLogger&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">info</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.info(format, arguments, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warn</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.warn(format, arguments, t);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.error(format, arguments, t);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”µè¯é€šçŸ¥ç®¡ç†å‘˜&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¼šå­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>å…³æ³¨æ—¥å¿—çš„é€»è¾‘éœ€è¦ç¡¬ç¼–ç åœ¨æ—¥å¿—æ‰“å°çš„æ ¸å¿ƒé€»è¾‘ä¸­ï¼Œç›‘å¬è¡Œä¸ºå’Œå‘å¸ƒè€…ã€ç”šè‡³å’ŒåŠŸèƒ½çš„ä¸»è¦å®ç°è€¦åˆ</li><li>æ— æ³•åŠ¨æ€å¢åŠ ã€ç§»é™¤è®¢é˜…è€…</li></ul><p>è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼è§£å†³ä»¥ä¸Šé—®é¢˜</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="ç›‘å¬è€…æ¥å£"><a href="#ç›‘å¬è€…æ¥å£" class="headerlink" title="ç›‘å¬è€…æ¥å£"></a>ç›‘å¬è€…æ¥å£</h3><p>æ‰€æœ‰çš„ç›‘å¬è€…å®ç°è¯¥æ¥å£ï¼Œå½“äº‹ä»¶è§¦å‘æ—¶é€šè¿‡è¯¥æ¥å£çš„å®ç°å‘Šè¯‰å‘å¸ƒè€…éœ€è¦æ‰§è¡Œçš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogEventListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Throwable t)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‘å¸ƒè€…"><a href="#å‘å¸ƒè€…" class="headerlink" title="å‘å¸ƒè€…"></a>å‘å¸ƒè€…</h3><p>ç»´æŠ¤äº†ç›‘å¬è€…åˆ—è¡¨ï¼Œæä¾›äº†ä¾›äº‹ä»¶è§¦å‘çš„é€šçŸ¥è¡Œä¸ºä»¥åŠè®¢é˜…ã€ç§»é™¤è®¢é˜…ç­‰æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogEventManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Level, List&lt;LogEventListener&gt;&gt; listeners = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogEventManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Level level : Level.values()) &#123;</span><br><span class="line">            listeners.put(level, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Level level, LogEventListener listener)</span> &#123;</span><br><span class="line">        List&lt;LogEventListener&gt; listenerList = listeners.get(level);</span><br><span class="line">        listenerList.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(Level level, LogEventListener listener)</span> &#123;</span><br><span class="line">        List&lt;LogEventListener&gt; listenerList = listeners.get(level);</span><br><span class="line">        listenerList.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Level level, Throwable t)</span> &#123;</span><br><span class="line">        List&lt;LogEventListener&gt; listenerList = listeners.get(level);</span><br><span class="line">        <span class="keyword">for</span> (LogEventListener listener : listenerList) &#123;</span><br><span class="line">            listener.notify(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ—¥å¿—è£…é¥°æ¥å…¥"><a href="#æ—¥å¿—è£…é¥°æ¥å…¥" class="headerlink" title="æ—¥å¿—è£…é¥°æ¥å…¥"></a>æ—¥å¿—è£…é¥°æ¥å…¥</h3><p>åªéœ€è¦åœ¨å…·ä½“çš„è¡Œä¸ºï¼ˆäº‹ä»¶ï¼‰è°ƒç”¨å‘å¸ƒè€…</p><p>è‡³äºå‘å¸ƒè€…çš„é€»è¾‘ã€å‘å¸ƒè€…ç»´æŠ¤çš„ç›‘å¬è€…ï¼Œä¸éœ€è¦æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…³æ³¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogger</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TinyLog</span> <span class="variable">log</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TinyLog</span>(<span class="string">&quot;MyLogger&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LogEventManager logEventManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyLogger</span><span class="params">(<span class="keyword">final</span> LogEventManager logEventManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.logEventManager = logEventManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">info</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.info(format, arguments, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warn</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.warn(format, arguments, t);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            logEventManager.call(Level.WARN, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.error(format, arguments, t);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            logEventManager.call(Level.ERROR, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç›‘å¬è€…å®ç°"><a href="#ç›‘å¬è€…å®ç°" class="headerlink" title="ç›‘å¬è€…å®ç°"></a>ç›‘å¬è€…å®ç°</h3><p><strong>é‚®ä»¶é€šçŸ¥å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailCallListener</span> <span class="keyword">implements</span> <span class="title class_">LogEventListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ &quot;</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç”µè¯é€šçŸ¥å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneCallListener</span> <span class="keyword">implements</span> <span class="title class_">LogEventListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”µè¯é€šçŸ¥ç®¡ç†å‘˜ &quot;</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å‘å¸ƒè€…ï¼ˆç®¡ç†ï¼‰</span></span><br><span class="line">        <span class="type">LogEventManager</span> <span class="variable">logEventManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogEventManager</span>();</span><br><span class="line">        logEventManager.subscribe(Level.WARN, <span class="keyword">new</span> <span class="title class_">EmailCallListener</span>());</span><br><span class="line">        logEventManager.subscribe(Level.ERROR, <span class="keyword">new</span> <span class="title class_">PhoneCallListener</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ—¥å¿—è£…é¥°ç±»</span></span><br><span class="line">        <span class="type">MyLogger</span> <span class="variable">myLogger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLogger</span>(logEventManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å°æ—¥å¿—</span></span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;an error occurred&quot;</span>);</span><br><span class="line">        myLogger.warn(<span class="string">&quot;get warn&quot;</span>, exception);</span><br><span class="line">        myLogger.error(<span class="string">&quot;get error&quot;</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ä¸ƒæœˆ <span class="number">27</span>, <span class="number">2023</span> <span class="number">12</span>:09:08 ä¸Šåˆ design.behavioral.observer.MyLogger warn</span><br><span class="line">è­¦å‘Š: get warn</span><br><span class="line">ä¸ƒæœˆ <span class="number">27</span>, <span class="number">2023</span> <span class="number">12</span>:09:08 ä¸Šåˆ design.behavioral.observer.MyLogger error</span><br><span class="line">ä¸¥é‡: get error</span><br><span class="line">é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ an error occurred</span><br><span class="line">ç”µè¯é€šçŸ¥ç®¡ç†å‘˜ an error occurred</span><br></pre></td></tr></table></figure><h3 id="å˜æ›´è®¢é˜…"><a href="#å˜æ›´è®¢é˜…" class="headerlink" title="å˜æ›´è®¢é˜…"></a>å˜æ›´è®¢é˜…</h3><p>ä¸šåŠ¡è°ƒæ•´ï¼Œå¯¹äº error æ—¥å¿—ä¹Ÿéœ€è¦è¿›è¡Œé‚®ä»¶é€šçŸ¥ï¼Œé‚£ä¹ˆåªéœ€è¦è°ƒæ•´è®¢é˜…å…³ç³»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">LogEventManager</span> <span class="variable">logEventManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogEventManager</span>();</span><br><span class="line">        logEventManager.subscribe(Level.WARN, <span class="keyword">new</span> <span class="title class_">EmailCallListener</span>());</span><br><span class="line">        logEventManager.subscribe(Level.ERROR, <span class="keyword">new</span> <span class="title class_">PhoneCallListener</span>());</span><br><span class="line">        <span class="comment">// å¯¹ error å¢åŠ å®ç°</span></span><br><span class="line">        logEventManager.subscribe(Level.ERROR, <span class="keyword">new</span> <span class="title class_">EmailCallListener</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">MyLogger</span> <span class="variable">myLogger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLogger</span>(logEventManager);</span><br><span class="line"></span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;an error occurred&quot;</span>);</span><br><span class="line">        myLogger.warn(<span class="string">&quot;get warn&quot;</span>, exception);</span><br><span class="line">        myLogger.error(<span class="string">&quot;get error&quot;</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><p>Apache çš„ commons.ioï¼Œå¯ä»¥æœ‰åŠŸèƒ½æ¥ç›‘å¬æœ¬åœ°æ–‡ä»¶çš„å˜æ›´</p><h3 id="è§‚å¯Ÿè€…-FileAlterationObserver"><a href="#è§‚å¯Ÿè€…-FileAlterationObserver" class="headerlink" title="è§‚å¯Ÿè€… FileAlterationObserver"></a>è§‚å¯Ÿè€… FileAlterationObserver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">FileAlterationObserver</span><span class="params">(<span class="keyword">final</span> FileEntry rootEntry, <span class="keyword">final</span> FileFilter fileFilter,</span></span><br><span class="line"><span class="params">                                 <span class="keyword">final</span> IOCase caseSensitivity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rootEntry == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Root entry is missing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rootEntry.getFile() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Root directory is missing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.rootEntry = rootEntry;</span><br><span class="line">    <span class="built_in">this</span>.fileFilter = fileFilter;</span><br><span class="line">    <span class="keyword">if</span> (caseSensitivity == <span class="literal">null</span> || caseSensitivity.equals(IOCase.SYSTEM)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = NameFileComparator.NAME_SYSTEM_COMPARATOR;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caseSensitivity.equals(IOCase.INSENSITIVE)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = NameFileComparator.NAME_INSENSITIVE_COMPARATOR;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = NameFileComparator.NAME_COMPARATOR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶ã€è¿‡æ»¤å™¨ç­‰å¯¹è±¡</p><h3 id="ç›‘å¬è€…-FileAlterationListener"><a href="#ç›‘å¬è€…-FileAlterationListener" class="headerlink" title="ç›‘å¬è€… FileAlterationListener"></a>ç›‘å¬è€… FileAlterationListener</h3><p><code>FileAlterationListener</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå®ç°æ–‡ä»¶ç›¸å…³äº‹ä»¶çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileAlterationListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File system observer started checking event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer The file system observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Directory created Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory The directory created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryCreate</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Directory changed Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory The directory changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryChange</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Directory deleted Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory The directory deleted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryDelete</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File created Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file The file created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File changed Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file The file changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileChange</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File deleted Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file The file deleted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File system observer finished checking event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer The file system observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨å†Œç›‘å¬è€…"><a href="#æ³¨å†Œç›‘å¬è€…" class="headerlink" title="æ³¨å†Œç›‘å¬è€…"></a>æ³¨å†Œç›‘å¬è€…</h3><p>è°ƒç”¨ <code>FileAlterationObserver</code> çš„ <code>addListener</code> æ–¹æ³•æ·»åŠ ç›‘å¬è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a file system listener.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> listener The file system listener</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(<span class="keyword">final</span> FileAlterationListener listener)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">        listeners.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç›‘å¬è€…è¢«ä¿å­˜åœ¨ <code>private final List&lt;FileAlterationListener&gt; listeners = new CopyOnWriteArrayList&lt;&gt;()</code> å±æ€§ä¸­</p><h3 id="ç›‘æ§å™¨-FileAlterationMonitor"><a href="#ç›‘æ§å™¨-FileAlterationMonitor" class="headerlink" title="ç›‘æ§å™¨ FileAlterationMonitor"></a>ç›‘æ§å™¨ FileAlterationMonitor</h3><p>ç›‘æ§å™¨ <code>FileAlterationMonitor</code> åŒ…è£…äº†ä¸€ç³»åˆ—è§‚å¯Ÿè€…ï¼Œä»¥åŠç›‘æ§é—´éš”æ—¶é—´ç­‰å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FileAlterationMonitor</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> interval, <span class="keyword">final</span> FileAlterationObserver... observers)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(interval);</span><br><span class="line">    <span class="keyword">if</span> (observers != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> FileAlterationObserver observer : observers) &#123;</span><br><span class="line">            addObserver(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç›‘æ§"><a href="#å¯åŠ¨ç›‘æ§" class="headerlink" title="å¯åŠ¨ç›‘æ§"></a>å¯åŠ¨ç›‘æ§</h3><p>è°ƒç”¨ <code>FileAlterationMonitor</code> çš„ <code>start</code> æ–¹æ³•å¼€å¯ç›‘æ§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (running) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Monitor is already running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> FileAlterationObserver observer : observers) &#123;</span><br><span class="line">        observer.initialize();</span><br><span class="line">    &#125;</span><br><span class="line">    running = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (threadFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">        thread = threadFactory.newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileAlterationMonitor</code> æœ¬èº«æ˜¯ä¸€ä¸ª <code>Runnable</code> å®ç°</p><p><code>run</code> æ–¹æ³•çš„å®ç°ï¼Œä½¿ç”¨ while å¾ªç¯åˆ¤æ–­ï¼Œè°ƒç”¨ <code>FileAlterationObserver</code> çš„ <code>checkAndNotify</code> æ¥è§‚å¯Ÿå’Œé€šçŸ¥ç›‘å¬è€…</p><p><code>Thread.sleep(interval)</code> æ¥è¿›è¡Œæ—¶é—´é—´éš”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runs this monitor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> FileAlterationObserver observer : observers) &#123;</span><br><span class="line">            observer.checkAndNotify();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(interval);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ignored) &#123;</span><br><span class="line">            <span class="comment">// ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileAlterationObserver</code> çš„ <code>checkAndNotify</code> å°±æ˜¯å‘å¸ƒè€…çš„æ ¸å¿ƒæ–¹æ³•ï¼Œæ¯”è¾ƒæ–‡ä»¶çš„å˜åŒ–ï¼Œè°ƒç”¨å·²æ³¨å†Œç›‘å¬è€…çš„ç›¸å…³å¤„ç†æ–¹æ³•</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è§‚å¯Ÿè€…æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>æ»¡è¶³äº†å¼€é—­åŸåˆ™ï¼›æ— éœ€ä¿®æ”¹å‘å¸ƒè€…ä»£ç å°±èƒ½å¼•å…¥æ–°çš„è®¢é˜…è€…ç±» ï¼ˆå¦‚æœæ˜¯å‘å¸ƒè€…æ¥å£åˆ™å¯è½»æ¾å¼•å…¥å‘å¸ƒè€…ç±»ï¼‰</li><li>å¯ä»¥åœ¨è¿è¡Œæ—¶å»ºç«‹å¯¹è±¡ä¹‹é—´çš„è”ç³»ï¼ˆåŠ¨æ€è®¢é˜…ã€è§£é™¤è®¢é˜…ï¼‰</li></ul><p>è´£ä»»é“¾ã€ å‘½ä»¤ã€ ä¸­ä»‹è€…å’Œè§‚å¯Ÿè€…ç”¨äºå¤„ç†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„ä¸åŒè¿æ¥æ–¹å¼ï¼š</p><ul><li>è´£ä»»é“¾æŒ‰ç…§é¡ºåºå°†è¯·æ±‚åŠ¨æ€ä¼ é€’ç»™ä¸€ç³»åˆ—çš„æ½œåœ¨æ¥æ”¶è€…ï¼Œ ç›´è‡³å…¶ä¸­ä¸€åæ¥æ”¶è€…å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†</li><li>å‘½ä»¤åœ¨å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´å»ºç«‹å•å‘è¿æ¥</li><li>ä¸­ä»‹è€…æ¸…é™¤äº†å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´çš„ç›´æ¥è¿æ¥ï¼Œ å¼ºåˆ¶å®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ä»‹å¯¹è±¡è¿›è¡Œé—´æ¥æ²Ÿé€š</li><li>è§‚å¯Ÿè€…å…è®¸æ¥æ”¶è€…åŠ¨æ€åœ°è®¢é˜…æˆ–å–æ¶ˆæ¥æ”¶è¯·æ±‚</li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://refactoringguru.cn/design-patterns/observer">è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ (refactoringguru.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LiteFlow - WhenCondition å’Œå¼‚æ­¥è¶…æ—¶æœºåˆ¶</title>
      <link href="/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow%20WhenCondition%20%E5%92%8C%E5%BC%82%E6%AD%A5%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6.html"/>
      <url>/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow%20WhenCondition%20%E5%92%8C%E5%BC%82%E6%AD%A5%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6.html</url>
      
        <content type="html"><![CDATA[<h1 id="WhenCondition"><a href="#WhenCondition" class="headerlink" title="WhenCondition"></a>WhenCondition</h1><p>å¯¹åº” EL è§„åˆ™ä¸­çš„ <code>WHEN</code> å…³é”®å­—ï¼Œä¼šè¢«åŒ…è£…ä¸º <code>WhenCondition</code> ç»„ä»¶<img src="/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow%20WhenCondition%20%E5%92%8C%E5%BC%82%E6%AD%A5%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6/Executable.png" class="" title="Executable"></p><p>ä¸»è¦çš„å¹¶å‘ç¼–æ’é€»è¾‘ä¸»è¦ç”± <code>WhenCondition</code> çš„å®ç°æ–¹æ³•æ‰§è¡Œ</p><h2 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h2><p><code>WHEN</code> å…³é”®å­—æ”¯æŒçš„å±æ€§ï¼š</p><ul><li><code>ignoreError</code>ï¼šè°ƒç”¨é“¾è°ƒç”¨å¤±è´¥æ—¶æ˜¯å¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li><li><code>group</code>ï¼šå¹¶å‘åˆ†ç»„ï¼›è¯¥å±æ€§å·²ç»å¼ƒç”¨ï¼Œå› ä¸ºå¯ä»¥ä½¿ç”¨ä¸åŒçš„ <code>WHEN</code> è¿›è¡Œåˆ†ç»„æ§åˆ¶ï¼Œä¾‹å¦‚ <code>THEN(WHEN(a,b),WHEN(c,d))</code></li><li><code>any</code>ï¼šä»»æ„èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸå°±ç»§ç»­å‘ä¸‹æ‰§è¡Œ</li><li><code>threadExecutorClass</code>ï¼šçº¿ç¨‹æ± åç§°ï¼›å®ä¾‹åŒ–åçš„çº¿ç¨‹æ± ä¼šè¢«æ”¾åœ¨ <code>ExecutorHelper</code> çš„ <code>Map&lt;String, ExecutorService&gt; executorServiceMap</code> å±æ€§</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhenCondition</span> <span class="keyword">extends</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">ignoreError</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> LocalDefaultFlowConstant.DEFAULT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">any</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String threadExecutorClass;</span><br></pre></td></tr></table></figure><h2 id="ä»»åŠ¡ç¼–æ’"><a href="#ä»»åŠ¡ç¼–æ’" class="headerlink" title="ä»»åŠ¡ç¼–æ’"></a>ä»»åŠ¡ç¼–æ’</h2><p><code>WhenCondition</code> å®ç°çš„ <code>Condition</code> æŠ½è±¡æ–¹æ³• <code>executeCondition</code></p><p>æ ¸å¿ƒæ“ä½œå°±æ˜¯å°†ä»»åŠ¡åŒ…è£…ä¸º <code>CompletableFuture</code>ï¼š</p><ol><li>è¿‡æ»¤å‰åç½®ç»„ä»¶</li><li>è¿‡æ»¤ <code>isAccess</code> falseï¼›ä¸€æ˜¯è¿‡æ»¤æ‰ä¸éœ€è¦æ‰§è¡Œçš„ç»„ä»¶ï¼ŒäºŒæ˜¯ä¸æ‰§è¡Œçš„ç»„ä»¶ä¸€å®šæ˜¯æ‰§è¡Œå®Œæˆæœ€å¿«çš„ï¼Œä¼šé€ æˆ <code>any</code> å±æ€§ç»“æœçš„æ··ä¹±</li><li>å¯¹ <code>Condition</code> ä¸‹çš„ <code>Map&lt;String, List&lt;Executable&gt;&gt; executableGroup</code> åŒ…è£…ä¸º <code>CompletableFuture</code>ï¼Œç¼–æ’å¼‚æ­¥ä»»åŠ¡</li><li>åœ¨åŒ…è£…ä¸º <code>CompletableFuture</code> è¿‡ç¨‹ä¸­ä½¿ç”¨äº† <code>CompletableFutureTimeout</code> å·¥å…·ï¼Œå¥—å…¥ <code>CompletableFutureTimeout</code> æ–¹æ³•è¿›è¡Œè¶…æ—¶åˆ¤æ–­ï¼Œå¦‚æœè¶…æ—¶åˆ™ç”¨ <code>WhenFutureObj.timeOut</code> è¿”å›è¶…æ—¶çš„å¯¹è±¡</li><li>æœ€ç»ˆå°†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ”¾è¿›é›†åˆ <code>List&lt;CompletableFuture&lt;WhenFutureObj&gt;&gt;</code></li></ol><p><strong>æ ¹æ® any å±æ€§å¯¹ä»»åŠ¡é›†åˆå†æ¬¡è¿›è¡Œç¼–æ’å°è£…</strong></p><p>å¦‚æœæ˜¯ <code>any</code> å±æ€§ï¼Œåˆ™ä½¿ç”¨ <code>CompletableFuture.anyOf</code> è¿›è¡Œç¼–æ’ï¼Œå¦åˆ™ä½¿ç”¨ <code>CompletableFuture.allOf</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.isAny()) &#123;</span><br><span class="line">    <span class="comment">// æŠŠè¿™äº› CompletableFuture é€šè¿‡ anyOf åˆæˆä¸€ä¸ª CompletableFuture</span></span><br><span class="line">    resultCompletableFuture = CompletableFuture</span><br><span class="line">        .anyOf(completableFutureList.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[] &#123;&#125;));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æŠŠè¿™äº› CompletableFuture é€šè¿‡ allOf åˆæˆä¸€ä¸ª CompletableFuture</span></span><br><span class="line">    resultCompletableFuture = CompletableFuture</span><br><span class="line">        .allOf(completableFutureList.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[] &#123;&#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¿›è¡Œæ‰§è¡Œï¼Œè¿™å¥æ‰§è¡Œå®Œåï¼Œå°±æ„å‘³ç€æ‰€æœ‰çš„ä»»åŠ¡è¦ä¹ˆæ‰§è¡Œå®Œæ¯•ï¼Œè¦ä¹ˆè¶…æ—¶è¿”å›</span></span><br><span class="line">    resultCompletableFuture.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¶…æ—¶å®ç°"><a href="#è¶…æ—¶å®ç°" class="headerlink" title="è¶…æ—¶å®ç°"></a>è¶…æ—¶å®ç°</h2><p>Java 8 çš„ <code>CompletableFuture</code> å¹¶æ²¡æœ‰ timeout æœºåˆ¶ï¼Œè™½ç„¶å¯ä»¥åœ¨ get çš„æ—¶å€™æŒ‡å®š timeoutï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ªåŒæ­¥å µå¡çš„æ“ä½œ</p><p>ä¸€èˆ¬çš„å®ç°æ–¹æ¡ˆæ˜¯å¯åŠ¨ä¸€ä¸ª <code>ScheduledThreadpoolExecutor</code> çº¿ç¨‹åœ¨ timeout</p><ul><li>æ—¶é—´åç›´æ¥è°ƒç”¨ <code>CompletableFuture.completeExceptionally(new TimeoutException())</code></li><li>ç„¶åç”¨ <code>acceptEither()</code> æˆ–è€… <code>applyToEither</code> çœ‹æ˜¯æ‰§è¡Œå®Œæˆè¿˜æ˜¯è¶…æ—¶</li></ul><p>Java  9 å¼•å…¥äº† <code>orTimeout</code> å’Œ <code>completeOnTimeOut</code> ä¸¤ä¸ªæ–¹æ³•æ”¯æŒ å¼‚æ­¥ timeout æœºåˆ¶ï¼Œåº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨ <code>ScheduledThreadpoolExecutor</code> è¿›è¡Œå®ç°çš„</p><p>è¿™é‡Œ LiteFlow å°†ä»»åŠ¡å’Œæ‰§è¡Œå’Œè¶…æ—¶å°è£…æˆäº†ä¸€ä¸ª API å·¥å…· <code>CompletableFutureTimeout</code></p><p>åœ¨ä¸Šé¢ä»»åŠ¡åŒ…è£…è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨äº† <code>CompletableFutureTimeout.completeOnTimeout</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">completeOnTimeout</span><span class="params">(T t, CompletableFuture&lt;T&gt; future, <span class="type">long</span> timeout,</span></span><br><span class="line"><span class="params">        TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> CompletableFuture&lt;T&gt; timeoutFuture = timeoutAfter(timeout, unit);</span><br><span class="line">    <span class="keyword">return</span> future.applyToEither(timeoutFuture, Function.identity()).exceptionally((throwable) -&gt; t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ³›å‹ T ä¸‹çš„ <code>t</code>ï¼Œåœ¨ä»»åŠ¡ç¼–æ’ä¸­æ˜¯ <code>WhenFutureObj</code> å¯¹è±¡</li><li><code>future</code> æ˜¯é€šè¿‡ <code>CompletableFuture.supplyAsync(new ParallelSupplier(executable, currChainName, slotIndex), parallelExecutor)</code> ç¼–æ’çš„ä»»åŠ¡ <code>CompletableFuture</code> å¯¹è±¡ï¼Œè¿”å›ç»“æœä¾ç„¶æ˜¯ <code>WhenFutureObj</code></li><li><code>timeout</code> æ˜¯è¶…æ—¶æ—¶é—´</li><li><code>unit</code> æ˜¯è¶…æ—¶æ—¶é—´å•ä½</li></ul><p><code>timeoutAfter</code> åˆ›å»ºå‡ºè¶…æ—¶å¼‚å¸¸ä»»åŠ¡åï¼Œç”±ä¸šåŠ¡ä»»åŠ¡ <code>future</code> çš„ <code>applyToEither</code> ç¼–æ’ä¸¤ä¸ªä»»åŠ¡</p><p><strong>è¶…æ—¶å¼‚å¸¸ä»»åŠ¡</strong></p><p>è°ƒç”¨ <code>timeoutAfter</code> åŒ…è£…è¶…æ—¶ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">timeoutAfter</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;T&gt;();</span><br><span class="line">    <span class="comment">// timeout æ—¶é—´å æŠ›å‡ºTimeoutException ç±»ä¼¼äºsentinel / watcher</span></span><br><span class="line">    Delayer.delayer.schedule(() -&gt; result.completeExceptionally(<span class="keyword">new</span> <span class="title class_">TimeoutException</span>()),</span><br><span class="line">            timeout, unit);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>delayer</code> æ˜¯ä¸€ä¸ª <code>ScheduledThreadPoolExecutor</code></p><p>åˆ›å»ºå‡ºä¸€ä¸ª <code>CompletableFuture</code>ï¼Œå¦‚æœè¯¥ä»»åŠ¡åœ¨ <code>get</code> æ—¶æœªå®Œæˆï¼Œåˆ™æŠ›å‡º <code>TimeoutException</code> å¼‚å¸¸</p><h2 id="WhenFutureObj"><a href="#WhenFutureObj" class="headerlink" title="WhenFutureObj"></a>WhenFutureObj</h2><p><code>WhenFutureObj</code> æ˜¯ä»»åŠ¡ç»“æœçš„åŒ…è£…å¯¹è±¡</p><p>å¯¹äºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆçš„çŠ¶æ€æœ‰ä¸‰ç§æƒ…å†µï¼š</p><ul><li>æˆåŠŸ</li><li>å¤±è´¥</li><li>è¶…æ—¶</li></ul><p>åœ¨ <code>ParallelSupplier</code> åŒ…è£…è¿‡ç¨‹ä¸­å¯¹åº”äº†æˆåŠŸã€å¤±è´¥ä¸¤ç§è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParallelSupplier</span> <span class="keyword">implements</span> <span class="title class_">Supplier</span>&lt;WhenFutureObj&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(ParallelSupplier.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Executable executableItem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String currChainId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Integer slotIndex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ParallelSupplier</span><span class="params">(Executable executableItem, String currChainId, Integer slotIndex)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.executableItem = executableItem;</span><br><span class="line"><span class="built_in">this</span>.currChainId = currChainId;</span><br><span class="line"><span class="built_in">this</span>.slotIndex = slotIndex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> WhenFutureObj <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">executableItem.setCurrChainId(currChainId);</span><br><span class="line">executableItem.execute(slotIndex);</span><br><span class="line">            <span class="comment">// æˆåŠŸ</span></span><br><span class="line"><span class="keyword">return</span> WhenFutureObj.success(executableItem.getId());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// å¤±è´¥</span></span><br><span class="line"><span class="keyword">return</span> WhenFutureObj.fail(executableItem.getId(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¶…æ—¶ä»»åŠ¡ä¸­å¯¹åº”äº†è¶…æ—¶çš„çŠ¶æ€è¿”å› <code>WhenFutureObj.timeOut(executable.getId())</code></p><p><strong>å¯¹è±¡ build æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhenFutureObj</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> timeout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String executorName;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Exception ex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WhenFutureObj <span class="title function_">success</span><span class="params">(String executorName)</span> &#123;</span><br><span class="line"><span class="type">WhenFutureObj</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WhenFutureObj</span>();</span><br><span class="line">result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">result.setTimeout(<span class="literal">false</span>);</span><br><span class="line">result.setExecutorName(executorName);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WhenFutureObj <span class="title function_">fail</span><span class="params">(String executorName, Exception ex)</span> &#123;</span><br><span class="line"><span class="type">WhenFutureObj</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WhenFutureObj</span>();</span><br><span class="line">result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">result.setTimeout(<span class="literal">false</span>);</span><br><span class="line">result.setExecutorName(executorName);</span><br><span class="line">result.setEx(ex);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WhenFutureObj <span class="title function_">timeOut</span><span class="params">(String executorName)</span> &#123;</span><br><span class="line"><span class="type">WhenFutureObj</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WhenFutureObj</span>();</span><br><span class="line">result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">result.setTimeout(<span class="literal">true</span>);</span><br><span class="line">result.setExecutorName(executorName);</span><br><span class="line">result.setEx(<span class="keyword">new</span> <span class="title class_">WhenTimeoutException</span>(</span><br><span class="line">StrUtil.format(<span class="string">&quot;Timed out when executing the component[&#123;&#125;],when-max-timeout-seconds config is:&#123;&#125;(s)&quot;</span>,</span><br><span class="line">executorName, LiteflowConfigGetter.get().getWhenMaxWaitSeconds())));</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯è®¾ç½® <code>success</code>ã€<code>timeout</code>ã€å¼‚å¸¸ä¿¡æ¯ç­‰å¼‚æ­¥æ‰§è¡Œç»“æœ</p><h2 id="ç»“æœè§£æ"><a href="#ç»“æœè§£æ" class="headerlink" title="ç»“æœè§£æ"></a>ç»“æœè§£æ</h2><p>è¿‡æ»¤å‡ºå·²ç»å®Œæˆçš„ä»»åŠ¡ï¼Œæ”¾åˆ°é›†åˆä¸­</p><p>å¯¹äºæ²¡æœ‰å®Œæˆçš„ä»»åŠ¡å°±æ‰§è¡Œ <code>cancel</code> æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;WhenFutureObj&gt; allCompletableWhenFutureObjList = completableFutureList.stream().filter(f -&gt; &#123;</span><br><span class="line">    <span class="comment">// è¿‡æ»¤å‡ºå·²ç»å®Œæˆçš„ï¼Œæ²¡å®Œæˆçš„å°±ç›´æ¥ç»ˆæ­¢</span></span><br><span class="line">    <span class="keyword">if</span> (f.isDone()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        f.cancel(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).map(f -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">        interrupted[<span class="number">0</span>] = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p>é›†åˆä¸­çš„ä»»åŠ¡ <code>get</code> å‡ºä»»åŠ¡çš„äº§å‡ºï¼Œå³åŒ…è£…çš„ <code>WhenFutureObj</code></p><p>æ ¹æ® <code>WhenFutureObj</code> ç»“æœå±æ€§åˆ¤æ–­åç»­æ“ä½œ</p><ul><li>è¾“å‡ºè¶…æ—¶ä¿¡æ¯</li><li>å¦‚æœé…ç½®ä¸­ <code>isIgnoreError</code> ä¸å¿½ç•¥å¼‚å¸¸<ul><li>æ ¹æ® <code>interrupted[0]</code> é›†åˆä¸­çš„ä¸­æ–­æƒ…å†µæŠ›å‡ºå¼‚å¸¸ <code>throw new WhenExecuteException(StrUtil.format(&quot;requestId [&#123;&#125;] when execute interrupted. errorResume [false].&quot;, slot.getRequestId()))</code></li><li>å¾ªç¯åˆ¤æ–­ <code>CompletableFuture</code> çš„è¿”å›å€¼ï¼Œå¦‚æœå¼‚æ­¥æ‰§è¡Œå¤±è´¥ï¼Œåˆ™æŠ›å‡ºç›¸åº”çš„ä¸šåŠ¡å¼‚å¸¸ï¼›å¦‚æœæ˜¯è¶…æ—¶ï¼Œè¿™é‡Œå°±ä¼šæŠ›å‡ºåœ¨è¶…æ—¶ä»»åŠ¡ç¼–æ’æ—¶æŠ›å‡ºçš„ <code>TimeoutException</code></li></ul></li><li>å¦‚æœå¿½ç•¥å¼‚å¸¸ï¼›åˆ™å¯¹ä¸­æ–­è¾“å‡º warn æ—¥å¿—</li></ul><h1 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h1><h2 id="CompletableFuture-cancel"><a href="#CompletableFuture-cancel" class="headerlink" title="CompletableFuture cancel"></a>CompletableFuture cancel</h2><p>åœ¨ <code>WhenCondition</code> æ‰§è¡Œæµç¨‹ä¸­ï¼Œå¯¹äºåŒ…è£…çš„ <code>anyOf</code> <code>CompletableFuture</code> æ‰§è¡Œå®Œæˆåï¼Œå­˜åœ¨æ²¡æœ‰ç»“æŸçš„ä»»åŠ¡ï¼Œåˆ™ä¼šè°ƒç”¨ <code>CompletableFuture</code> çš„ <code>cancel</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">cancelled</span> <span class="operator">=</span> (result == <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">        internalComplete(<span class="keyword">new</span> <span class="title class_">AltResult</span>(<span class="keyword">new</span> <span class="title class_">CancellationException</span>()));</span><br><span class="line">    postComplete();</span><br><span class="line">    <span class="keyword">return</span> cancelled || isCancelled();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•å‚æ•° <code>mayInterruptIfRunning</code> å®é™…å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ•´ä¸ª <code>CompletableFuture</code> çš„æ‰§è¡Œå¹¶ä¸ä¼šè¢«ä¸­æ–­</p><p>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿè¯´</p><blockquote><p>@param mayInterruptIfRunning this value has no effect in this implementation because interrupts are not used to control processing.</p><p>è¿™ä¸ªå€¼åœ¨è¿™ä¸ªå®ç°ä¸­æ²¡æœ‰ä½œç”¨ï¼Œå› ä¸ºä¸­æ–­ä¸ç”¨äºæ§åˆ¶å¤„ç†</p></blockquote><p>è¯¥æ–¹æ³•å®ç°è‡ª <code>Future</code>ï¼Œå…¶å®šä¹‰çš„ <code>mayInterruptIfRunning</code> å¹¶æ²¡æœ‰ä½¿ç”¨</p><p>StackOverFlow ä¸­ä¹Ÿæœ‰äººæå‡ºäº†è¿™æ ·çš„é—®é¢˜ï¼Œè®¤ä¸ºè¿åäº† <code>Java.util.concurrent.Future</code> ä¸­å¯¹ <code>cancel</code> æ–¹æ³•å®šä¹‰çš„çº¦å®š</p><p>å…¶åŸå› åœ¨è¯„è®ºä¸­æœ‰æ‰€è®¨è®ºï¼š</p><blockquote><ul><li><p>As mentioned in my previous (edited) comment, the <code>CompletableFuture</code> does not hold a reference to either the actual work or the <code>Thread</code> processing it. This is at least implied in the class documentation: â€œ<em>Since (unlike FutureTask) this class has no direct control over the computation that causes it to be completed, cancellation is treated as just another form of exceptional completion</em>â€œ</p><p>ç”±äºä¸ <code>FutureTask</code> ä¸åŒï¼Œ<code>CompletableFuture</code> å¯¹æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ²¡æœ‰ç›´æ¥æ§åˆ¶ï¼Œå› æ­¤å–æ¶ˆè¢«è§†ä¸ºå¦ä¸€ç§å½¢å¼çš„å¼‚å¸¸å®Œæˆ</p></li><li><p><code>CompletableFuture</code> does not hold reference to thread, which I think it is also a problem, It is not consistency with <code>Future</code></p><p><code>CompletableFuture</code> æ²¡æœ‰å¼•ç”¨çº¿ç¨‹ï¼Œæˆ‘è®¤ä¸ºè¿™ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒä¸ <code>Future</code> ä¸ä¸€è‡´</p></li></ul></blockquote><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://stackoverflow.com/questions/55490668/why-does-completablefuture-implement-the-future-interface">java - Why does CompletableFuture implement the Future interface - Stack Overflow</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LiteFlow </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS è§£æå¯¼è‡´çš„ ssh connect to host github.com port 22 Connection refused</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/DNS%20%E8%A7%A3%E6%9E%90%E5%AF%BC%E8%87%B4%E7%9A%84%20ssh%20connect%20to%20host%20github.com%20port%2022%20Connection%20refused.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/DNS%20%E8%A7%A3%E6%9E%90%E5%AF%BC%E8%87%B4%E7%9A%84%20ssh%20connect%20to%20host%20github.com%20port%2022%20Connection%20refused.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¸€æ®µæ—¶é—´æ²¡æœ‰ä½¿ç”¨ github SSH æ“ä½œï¼Œä»Šå¤©çªç„¶å‘ç° Hexo deploy æ— æ³•æ­£å¸¸ push åˆ°ä»“åº“</p><p>æŠ¥é”™ä¿¡æ¯ä¸º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br><span class="line">fatal: Could not <span class="built_in">read</span> from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><p>å¼€å§‹ä»¥ä¸ºæ˜¯ SSH é…ç½®å­˜åœ¨é—®é¢˜ï¼Œä½†æ˜¯æ£€æŸ¥äº†é…ç½®ä»¥åŠä»“åº“æƒ…å†µå¹¶æ²¡æœ‰å‘ç°é—®é¢˜</p><p>æ­¤å¤–å°è¯•äº†ç›´æ¥ä½¿ç”¨ git è¿›è¡Œ pull å’Œ push çš„æ“ä½œï¼Œä¹Ÿæ— æ³•æˆåŠŸ</p><h1 id="DNS-è§£æ"><a href="#DNS-è§£æ" class="headerlink" title="DNS è§£æ"></a>DNS è§£æ</h1><p>æŸ¥çœ‹äº†ä¸€äº›æ–‡ç« ï¼Œæ­¤ç±» access é—®é¢˜å¤§è‡´æœ‰ä»¥ä¸‹åŸå› ï¼š</p><ul><li>SSH é…ç½®é”™è¯¯</li><li>22 ç«¯å£è¢«ç¦æ­¢</li><li>DNS è§£æ</li></ul><p>æ’é™¤äº†ä¸€äº›å¯èƒ½ä¹‹åå°è¯•æ˜¯ DNS å­˜åœ¨é—®é¢˜</p><p>å°è¯•ä¿®æ”¹ IPv4 DNS é…ç½®åä¾ç„¶æ— æ³•è®¿é—®</p><p><strong>ç¬¬ä¸€æ­¥</strong></p><p>ä½¿ç”¨ <code>ssh git@github.com</code> éªŒè¯æ˜¯å¦å¯ä»¥é€šè¿‡ SSH è¿æ¥ github</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br></pre></td></tr></table></figure><p>ç¡®å®æ— æ³•æ­£å¸¸è¿æ¥</p><p><strong>ç¬¬äºŒæ­¥</strong></p><p>ä½¿ç”¨ <code>ssh -v</code> å‘½ä»¤ï¼Œ<code>-v</code> è¡¨ç¤º verboseï¼Œä¼šæ‰“å‡ºå»ºç«‹ SSH è¿æ¥è¿‡ç¨‹çš„è¯¦ç»†æ—¥å¿—</p><p><code> ssh -v git@github.com</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenSSH_for_Windows_8.1p1, LibreSSL 3.0.2</span><br><span class="line">debug1: Connecting to github.com [127.0.0.1] port 22.</span><br><span class="line">debug1: connect to address 127.0.0.1 port 22: Connection refused</span><br><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹ github.com çš„è®¿é—®ä¼šè¯·æ±‚åˆ° 127.0.0.1ï¼Œè®¿é—®æœ¬æœº IP æ˜æ˜¾æ˜¯ä¸æ­£ç¡®çš„</p><p>æ£€æŸ¥äº† hosts é…ç½®ä¹Ÿæ²¡å‘ç°å­˜åœ¨é’ˆå¯¹ github åŸŸåçš„ç›¸å…³é”™è¯¯é…ç½®</p><p><strong>ç¬¬ä¸‰æ­¥</strong></p><p>ä½¿ç”¨ <code>nslookup</code> å‘½ä»¤è·å– github çš„ IP åœ°å€ï¼›ä½¿ç”¨ Google çš„ DNS 8.8.8.8</p><p><code>nslookup github.com 8.8.8.8</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Server:  dns.google</span><br><span class="line">Address:  8.8.8.8</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:    github.com</span><br><span class="line">Address:  20.205.243.166</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ° IP åœ°å€ 20.205.243.166</p><p><strong>ç¬¬å››æ­¥</strong></p><p>é…ç½® hostsï¼›hosts è·¯å¾„ä¸€èˆ¬ä¸º <code>C:\Windows\System32\drivers\etc\hosts</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># github</span></span><br><span class="line">20.205.243.166 github.com</span><br></pre></td></tr></table></figure><p>éšåç»§ç»­è¿›è¡Œ <code>ssh -T git@github.com</code> éªŒè¯åˆ™ access æˆåŠŸï¼ŒIP ä¹ŸæˆåŠŸè®¿é—®äº†é…ç½®çš„ 20.205.243.166</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hi xxx! You<span class="string">&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debug1: Authentication succeeded (publickey).</span><br><span class="line">Authenticated to github.com ([20.205.243.166]:22).</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/578435111">å‘ï¼šssh: connect to host github.com port 22: Connection refused - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://blog.csdn.net/MBuger/article/details/70226712">è§£å†³ssh: connect to host github.com port 22: Connection refused_Seven17000çš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€äº› 50/50 shots é…’å•</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä» Ferrari  åˆ° Hard Startï¼Œè¿™é‡Œæœ‰ 9 æ¬¾æˆ‘ä»¬æœ€çˆ±çš„ 50&#x2F;50 shots é…’å•</p></blockquote><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95/Article-50-50-Shots.jpg" class="" title="img"><p>50&#x2F;50 shots è¯¸å¦‚ Ferrari å’Œ M&amp;M å¤šå¹´æ¥ä¸€è‡´æ˜¯ä¸šå†…å® å„¿ï¼›ä¸è¿‡éšç€è¶Šæ¥è¶Šå—æ¬¢è¿ï¼Œæ´¾å¯¹è€…ä»¬æ‰¾åˆ°äº†å°†é¸¡å°¾é…’ä½œä¸ºé…æ–™çš„æ–¹å¼ï¼Œè¿™ç§å½¢å¼å·²ç»æ‰©å±•ä¸ºä¸€ç§æ˜“äºå¤åˆ¶å¹¶åˆ›ä½œçš„æ¨¡å¼</p><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ï¼šå–ä¸€æ¯è‹¦æä»é…’ï¼ˆamaroï¼‰ï¼Œå°†å…¶ä¸å¦ä¸€ç§åˆ©å£é…’æˆ–æ›´é«˜åº¦çƒˆé…’ç­‰åˆ†</p><p>å„ç§å„æ ·çš„å˜åŒ–ï¼Œæ— è®ºä½ æ˜¯åœ¨å¯»æ‰¾ä¸€ç§ä»¤äººå¤§å¼€çœ¼ç•Œçš„å®¿é†‰æ–¹å¼ï¼šä¾‹å¦‚ Hard Startï¼Œæˆ–è€…æ˜¯ä¸€æ¯å¤æ‚æ€§å ªæ¯”é¸¡å°¾é…’çš„ shotï¼šä¾‹å¦‚ Mezcaletti</p><p>è®©æˆ‘ä»¬å¼€å§‹å§ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬æœ€å–œæ¬¢çš„å…³äº 50&#x2F;50 çš„ä¸€äº› shots</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95/Inline-50-50-Shot.jpg" class="" title="50 50 shot"><h1 id="åŸæ–™"><a href="#åŸæ–™" class="headerlink" title="åŸæ–™"></a>åŸæ–™</h1><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/323/fernet-branca">Fernet Branca</a></strong> è²å¥ˆç‰¹Â·å¸ƒå…°å¡ï¼›è‘—åçš„æ„å¤§åˆ©è‹¦å‘³é…’ï¼Œé¾™èƒ†ã€ç”˜èŠã€è—çº¢èŠ±ç­‰è‰æœ¬ï¼Œåœ¨ Slovenian æ©¡æœ¨æ¡¶é™ˆé…¿</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/190/campari-bitter">Campari</a></strong> é‡‘å·´åˆ©è‹¦é…’</p><p><strong><a href="https://www.diffordsguide.com/encyclopedia/363/bws/mezcal-what-it-is-and-how-its-made">Mezcal</a></strong> æ¢…æ–¯å¡å°”é…’ï¼›é¾™èˆŒå…°é…’çš„ä¸€ç§ï¼Œå¢¨è¥¿å“¥äº§</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/1819/ramazzotti-amaro">Ramazzotti</a></strong> é›·ç›ä½è’‚è‹¦å‘³é…’ï¼›ç”±å¤šç§è‰æœ¬ã€é¦™æ–™åŒ…æ‹¬é¾™èƒ†å’Œæ©™çš®åˆ¶ä½œçš„è‹¦é…’</p><p><strong>Rye Whiskey</strong> é»‘éº¦å¨å£«å¿Œï¼›ç¾å›½å¨å£«å¿Œï¼Œå¿…é¡»ä»è‡³å°‘ 51ï¼… çš„é»‘éº¦è°·ç‰©ä¸­è’¸é¦ï¼Œä½¿ç”¨æ–°æ©¡æœ¨æ¡¶</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/859/cynar">Cynar</a></strong> è¥¿çº³å°”é…’ï¼›æ„å¤§åˆ©å¼€èƒƒé…’ï¼Œèƒå–æ´‹è“Ÿå¶ï¼ˆCynara scolymusï¼‰é¦™å‘³ï¼Œåå­—æ¥æºäºæ´‹è“Ÿå¶å’Œå…¶ä»–æ·»åŠ çš„æ¤ç‰©</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/1818/montenegro-amaro">Montenegro</a></strong> è’™ç‰¹å†…ç½—ï¼›æ„å¤§åˆ©è‹¦é…’ï¼Œç”± 40 ç§æ¤ç‰©ï¼ˆåŒ…æ‹¬ç”˜è‰æ ¹ã€è‚‰è±†è”»ã€ç”œæ©™å’Œè‹¦æ©™ï¼‰è°ƒå‘³</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/2034/nardini-amaro">Nardini</a></strong> çº³å°”è¿ªå°¼ï¼›ä¼ ç»Ÿçš„è‹¦å‘³æ„å¤§åˆ©å¼€èƒƒé…’ï¼Œä¸»è¦ç”¨è‹¦æ©™ã€è–„è·å’Œé¾™èƒ†è°ƒå‘³</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/6733/amaro-meletti">Amaro Meletti</a></strong> æ¢…ä¹æï¼›æ„å¤§åˆ©è‹¦é…’ï¼Œç”¨æ°´æœå’Œé¦™è‰è°ƒå‘³</p><p><strong>Rum</strong> æœ—å§†ï¼›å…­å¤§åŸºé…’ä¹‹ä¸€ï¼ŒåŸæ–™ä¸ºç”˜è”—ç³–èœœ</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/6903/cappelletti">Cappelletti</a></strong> ä¸»è¦ç”¨äºç”¨ç™½è‘¡è„é…’å’Œè‹æ‰“æ°´åˆ¶ä½œ Spritz</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/6483/strega-amaro-liqueur">Strega</a></strong> ä¸€ç§æ„å¤§åˆ©è‹¦é…’</p><p><strong><a href="https://www.diffordsguide.com/beer-wine-spirits/324/brancamenta">Branca Menta</a></strong> å¸ƒå…°å¡ Â· è–„è·ï¼›æ„å¤§åˆ©åˆ©å£é…’ï¼Œå¤å­£ç‰ˆæœ¬çš„ Fernet Brancaï¼Œæ·»åŠ äº†è–„è·</p><h1 id="é˜¿é©¬ç½—-Amaro"><a href="#é˜¿é©¬ç½—-Amaro" class="headerlink" title="é˜¿é©¬ç½— Amaro"></a>é˜¿é©¬ç½— Amaro</h1><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å¾ˆå¤šé…’éƒ½äº§è‡ªæ„å¤§åˆ©ï¼Œå¹¶ä¸”éƒ½æ˜¯â€œAmaroâ€çš„ä¸€ç§ï¼Œç¿»è¯‘ä¸ºäº†â€œè‹¦å‘³é…’â€</p><p>Amaro æ—¢æ˜¯æ„å¤§åˆ©è¯­ä¸­è‹¦çš„æ„æ€ï¼Œä¹Ÿæ˜¯ä¼ ç»Ÿä¸Šæ¥è‡ªæ„å¤§åˆ©çš„è‹¦ä¸­å¸¦ç”œï¼ˆbittersweetï¼‰åˆ©å£é…’çš„åå­—</p><p>Amariï¼ˆAmaro çš„å¤æ•°ï¼‰é€šå¸¸å‘ˆæ·±é»„è¤è‰²ï¼Œä»¥ç™½å…°åœ°ä¸ºåŸºç¡€ï¼Œå¹¶ç”¨é¦™è‰ã€é¦™æ–™å’Œå…¶ä»–æ¤ç‰©è°ƒå‘³</p><p><strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬å¦‚æ­¤å–œçˆ± Amaro</strong></p><p>å¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½å–œæ¬¢è¿™ç§ä»¤äººæŒ¯å¥‹ã€å‘³é“å¼ºçƒˆçš„è‹¦é…’</p><p>ä½†æ˜¯ Amaro å¾ˆå¿«å°±æˆäº† bartender æœ€å¥½çš„æœ‹å‹ï¼›ä¸ºæ¸…æ·¡ç»†è…»çš„é¸¡å°¾é…’å°‘é‡åŠ å…¥å¯ä»¥å¢åŠ å‘³é“çš„å¤æ‚æ€§ï¼Œå¾ˆå®¹æ˜“ç†è§£ä¸ºä»€ä¹ˆåçˆ±æµ“éƒå£å‘³çš„çˆ±å¥½è€…ä¼šå¦‚æ­¤ç€è¿·</p><p><a href="https://www.diffordsguide.com/beer-wine-spirits/category/1202/amari">Amari (diffordsguide.com)</a></p><blockquote><p><strong>é˜¿é©¬ç½—ï¼ˆAmaroï¼‰ å’Œæ¯”ç‰¹é…’ï¼ˆBitterï¼‰ çš„åŒºåˆ«</strong></p><p>é˜¿é©¬ç½—å’Œè‹¦ç²¾çš„ä¸åŒä¹‹å¤„åœ¨äºå®ƒæ›´é€‚åˆçº¯é¥®ï¼Œè€Œä¸æ˜¯ç”¨æ¥è°ƒå‘³</p><p>é˜¿é©¬ç½—è¢«å½’ä¸ºå¯çº¯é¥®çš„è‹¦é…’ï¼Œè€Œä¸åƒ Angostura ç­‰æ¯”ç‰¹é…’ä½œä¸ºé¸¡å°¾é…’çš„ç‚¹ç¼€</p><p>é©¬å…‹Â·å½¼å¾—æ›¼åœ¨ã€Šå½¼å¾—æ›¼çš„è‹¦é…’ä¸é˜¿é©¬ç½—æŒ‡å¯¼æ‰‹å†Œã€‹ä¸­è¿™ä¹ˆå†™é“ï¼šä¸€äº›é˜¿é©¬ç½—éœ€è¦ä½ ç»†ç»†å“é‰´ï¼Œè€Œå¦ä¸€äº›åˆ™çœŸçš„éš¾ä»¥ä¸‹å’½</p><p><a href="https://zhuanlan.zhihu.com/p/36368828">ä»€ä¹ˆæ˜¯é˜¿é©¬ç½—ï¼Ÿæ„å¤§åˆ©è‹¦é…’æ‰‹è®° - çŸ¥ä¹ (zhihu.com)</a></p></blockquote><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://punchdrink.com/articles/best-shots-amaro-whiskey-mezcal/">The 9 Best Bartenderâ€™s Handshake Shots, Beyond the Ferrari | PUNCH (punchdrink.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TransmittableThreadLocal æºç  &amp; ç®€å•ä½¿ç”¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&amp;%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&amp;%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="å¯ç»§æ‰¿-Inheritable"><a href="#å¯ç»§æ‰¿-Inheritable" class="headerlink" title="å¯ç»§æ‰¿ Inheritable"></a>å¯ç»§æ‰¿ Inheritable</h1><p><code>InheritableThreadLocal</code> æ˜¯å®˜æ–¹æä¾›çš„ç±»ï¼ŒåŒºåˆ«äº <code>ThreadLocal</code> çš„åŠŸèƒ½å°±æ˜¯ä½¿å­çº¿ç¨‹åˆ›å»ºæ—¶ä¼šèµ‹å€¼çˆ¶çº¿ç¨‹å½“æ—¶çš„ <code>ThreadLocal</code> å€¼ï¼ˆå¼•ç”¨ï¼‰ï¼Œå®ç°å¼€å¯çº¿ç¨‹åå°†çº¿ç¨‹æœ¬åœ°å˜é‡ä¼ é€’</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡Œå¦‚æœå°† ThreadLocal å®ç°æ¢ä¸º ThreadLocalï¼Œåˆ™å­çº¿ç¨‹å†…è·å–ä¸º null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[Thread-<span class="number">0</span>,<span class="number">5</span>,main] Hello World</span><br></pre></td></tr></table></figure><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p><code>ThreadLocal</code> å¯¹è±¡æœ¬è´¨æ˜¯ <code>Thread</code> å†… <code>threadLocalMap</code> çš„ key</p><p><code>InheritableThreadLocal</code> åŠŸèƒ½çš„å®ç°éœ€è¦ä¸¤æ–¹æ”¯æŒï¼š</p><ul><li><code>InheritableThreadLocal</code> å°†çˆ¶ç±» <code>ThreadLocal</code> å…³äº map çš„å®ç°é‡å†™ä¸ºæ”¯æŒæ–°çš„ mapï¼ˆinheritableThreadLocalsï¼‰</li><li><code>Thread</code> å†…æä¾› <code>InheritableThreadLocal</code> ä½¿ç”¨çš„ mapï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹åˆ›å»ºæœŸé—´å°†çˆ¶çº¿ç¨‹çš„ map å€¼ä¼ é€’ç»™å­çº¿ç¨‹</li></ul><p><strong>InheritableThreadLocal é‡å†™æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Computes the child&#x27;s initial value for this inheritable thread-local</span></span><br><span class="line"><span class="comment">     * variable as a function of the parent&#x27;s value at the time the child</span></span><br><span class="line"><span class="comment">     * thread is created.  This method is called from within the parent</span></span><br><span class="line"><span class="comment">     * thread before the child is started.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method merely returns its input argument, and should be overridden</span></span><br><span class="line"><span class="comment">     * if a different behavior is desired.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parentValue the parent thread&#x27;s value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the child thread&#x27;s initial value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">childValue</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the map associated with a ThreadLocal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the current thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> t.inheritableThreadLocals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create the map associated with a ThreadLocal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the current thread</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstValue value for the initial entry of the table.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.inheritableThreadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Thread init èµ‹å€¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span><br><span class="line"><span class="params">                      <span class="type">long</span> stackSize, AccessControlContext acc,</span></span><br><span class="line"><span class="params">                      <span class="type">boolean</span> inheritThreadLocals)</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="comment">// å¦‚æœå‚æ•°å¼€å…³å¼€å¯ï¼Œçˆ¶çº¿ç¨‹å­˜åœ¨ inheritableThreadLocalsï¼Œåˆ™è¿›è¡Œ createInheritedMap å¹¶èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>)</span><br><span class="line">            <span class="built_in">this</span>.inheritableThreadLocals =</span><br><span class="line">                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">/* Stash the specified stack size in case the VM cares */</span></span><br><span class="line">        <span class="built_in">this</span>.stackSize = stackSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set thread ID */</span></span><br><span class="line">        tid = nextThreadID();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å±€é™"><a href="#å±€é™" class="headerlink" title="å±€é™"></a>å±€é™</h2><p><code>InheritableThreadLocal</code> åœ¨éƒ¨åˆ†åœºæ™¯æœ‰å…¶å±€é™æ€§ï¼š</p><ul><li><p>åªèƒ½åœ¨çº¿ç¨‹åˆ›å»ºåˆå§‹åŒ–æ—¶æœŸèµ‹å€¼ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸€èˆ¬æ˜¯å¤ç”¨çš„ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨çº¿ç¨‹æ± åˆ™æ— æ³•ä¼ é€’</p><p>å½“ç„¶è¿™ç§è¡Œä¸ºç¬¦åˆé¢„æœŸçš„ï¼Œå› ä¸º Inheritable å¼ºè°ƒçš„å°±æ˜¯<strong>ç»§æ‰¿æ€§</strong>ï¼Œçº¿ç¨‹æ± çš„åœºæ™¯å¼ºè°ƒçš„æ˜¯<strong>ä¼ é€’æ€§</strong></p><blockquote><p>ä½†å¯¹äºä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶çš„æƒ…å†µï¼Œçº¿ç¨‹ç”±çº¿ç¨‹æ± åˆ›å»ºå¥½ï¼Œå¹¶ä¸”çº¿ç¨‹æ˜¯æ± åŒ–èµ·æ¥åå¤ä½¿ç”¨çš„ï¼›è¿™æ—¶çˆ¶å­çº¿ç¨‹å…³ç³»çš„<code>ThreadLocal</code>å€¼ä¼ é€’å·²ç»æ²¡æœ‰æ„ä¹‰ï¼Œåº”ç”¨éœ€è¦çš„å®é™…ä¸Šæ˜¯æŠŠ <strong>ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ—¶</strong>çš„<code>ThreadLocal</code>å€¼ä¼ é€’åˆ° <strong>ä»»åŠ¡æ‰§è¡Œæ—¶</strong></p><p><a href="https://github.com/alibaba/transmittable-thread-local#-%E5%8A%9F%E8%83%BD">alibaba&#x2F;transmittable-thread-local: transmittable-thread-local-åŠŸèƒ½</a></p></blockquote></li><li><p>ä¼ é€’çš„æ˜¯å¼•ç”¨è€Œä¸æ˜¯æ‹·è´ï¼Œä½¿ç”¨ä¸­éœ€è¦æ³¨æ„å¼•ç”¨æ•°æ®ä¿®æ”¹çš„å½±å“ï¼›ä¹Ÿæ²¡æœ‰æä¾›æ‹·è´ç›¸å…³çš„èƒ½åŠ›å®ç°</p></li></ul><p><strong>çº¿ç¨‹æ± å¤ç”¨åˆ™æ— æ³•ä¼ é€’</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å•çº¿ç¨‹çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// ä¸ºäº†è®©çº¿ç¨‹æ±  init ä¸€ä¸ªæ–°çº¿ç¨‹</span></span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(<span class="string">&quot;init&quot;</span>));</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤ç”¨çº¿ç¨‹</span></span><br><span class="line">        EXECUTOR.execute(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main] <span class="literal">null</span></span><br></pre></td></tr></table></figure><h1 id="å¯ä¼ é€’-Transmittable"><a href="#å¯ä¼ é€’-Transmittable" class="headerlink" title="å¯ä¼ é€’ Transmittable"></a>å¯ä¼ é€’ Transmittable</h1><p>alibaba å¼€æºçš„ <a href="https://github.com/alibaba/transmittable-thread-local">transmittable-thread-local</a> å¯ä»¥è§£å†³æ»¡è¶³éœ€è¦</p><p><code>ThreadLocal</code>çš„éœ€æ±‚åœºæ™¯å³<code>TransmittableThreadLocal</code>çš„æ½œåœ¨éœ€æ±‚åœºæ™¯ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡éœ€è¦ <em>åœ¨ä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶æƒ…å†µä¸‹ä¼ é€’ <code>ThreadLocal</code> å€¼</em> åˆ™æ˜¯ <code>TransmittableThreadLocal</code> ç›®æ ‡åœºæ™¯</p><p>ä¸‹é¢æ˜¯å‡ ä¸ªå…¸å‹åœºæ™¯ä¾‹å­ï¼š</p><ol><li>åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ æˆ– å…¨é“¾è·¯å‹æµ‹ï¼ˆå³é“¾è·¯æ‰“æ ‡ï¼‰</li><li>æ—¥å¿—æ”¶é›†è®°å½•ç³»ç»Ÿä¸Šä¸‹æ–‡</li><li><code>Session</code> çº§ <code>Cache</code></li><li>åº”ç”¨å®¹å™¨æˆ–ä¸Šå±‚æ¡†æ¶è·¨åº”ç”¨ä»£ç ç»™ä¸‹å±‚<code>SDK</code>ä¼ é€’ä¿¡æ¯</li></ol><p>å®˜æ–¹æ–‡æ¡£å†™çš„éå¸¸è¯¦ç»†ï¼Œæˆ‘å°±ä¸èµ˜è¿°äº†ï¼Œå…·ä½“å¯ä»¥å»æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï½</p><h2 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h2><p>å…³äºä½¿ç”¨å®˜æ–¹æ–‡æ¡£ä¹Ÿæè¿°çš„éå¸¸è¯¦ç»†ï¼Œè¿™é‡Œå°±ç®€å•åˆ—ä¸¾ä¸€ä¸‹ Java ä»£ç </p><p>ä¾èµ–ä¸º 2.12.6 ç‰ˆæœ¬</p><blockquote><p>ä»<code>TTL v2.13+</code>å¼€å§‹ï¼Œå‡çº§åˆ°<code>Java 8</code>ã€‚<br>å¦‚æœéœ€è¦<code>Java 6</code>çš„æ”¯æŒï¼Œä½¿ç”¨ç‰ˆæœ¬<code>2.12.x</code></p><p> <a href="https://search.maven.org/artifact/com.alibaba/transmittable-thread-local"><img src="https://camo.githubusercontent.com/bc33d0e5608d42d034de759fc7e6a2c4a65bbd3b9231c0d3f4f7bb815e5d08c0/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f636f6d2e616c69626162612f7472616e736d69747461626c652d7468726561642d6c6f63616c3f76657273696f6e5072656669783d322e31322e26636f6c6f723d6c6967687467726579266c6f676f3d6170616368652d6d6176656e266c6f676f436f6c6f723d7768697465" alt="Maven Central"></a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;transmittable-thread-local&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.12</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="è£…é¥°-Runnable"><a href="#è£…é¥°-Runnable" class="headerlink" title="è£…é¥° Runnable"></a>è£…é¥° Runnable</h3><p>ä½¿ç”¨ <code>TtlRunnable</code> å’Œ <code>TtlCallable</code> æ¥ä¿®é¥°ä¼ å…¥çº¿ç¨‹æ± çš„ <code>Runnable</code> å’Œ <code>Callable</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ TransmittableThreadLocal</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(<span class="string">&quot;init&quot;</span>));</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è£…é¥° Runnable ä¸º TtlRunnable</span></span><br><span class="line">        <span class="type">TtlRunnable</span> <span class="variable">ttlRunnable</span> <span class="operator">=</span> TtlRunnable.get(() -&gt; System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get()));</span><br><span class="line">        EXECUTOR.execute(ttlRunnable);</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main] Hello World</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„ï¼š</strong>å³ä½¿æäº¤åŒä¸€ä¸ª <code>Runnable</code> ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œæ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œè£…é¥°æ“ä½œï¼Œå¦åˆ™æŠ“å–çš„ä»æ˜¯ä¸Šä¸€æ¬¡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p><h3 id="è£…é¥°çº¿ç¨‹æ± "><a href="#è£…é¥°çº¿ç¨‹æ± " class="headerlink" title="è£…é¥°çº¿ç¨‹æ± "></a>è£…é¥°çº¿ç¨‹æ± </h3><p>çœå»æ¯æ¬¡ <code>Runnable</code> å’Œ <code>Callable</code> ä¼ å…¥çº¿ç¨‹æ± æ—¶çš„ä¿®é¥°ï¼Œè¿™ä¸ªé€»è¾‘å¯ä»¥åœ¨çº¿ç¨‹æ± ä¸­å®Œæˆ</p><p>é€šè¿‡å·¥å…·ç±» <code>TtlExecutors</code> å®Œæˆï¼Œæœ‰ä¸‹é¢çš„æ–¹æ³•ï¼š</p><ul><li><code>getTtlExecutor</code>ï¼šä¿®é¥°æ¥å£ <code>Executor</code></li><li><code>getTtlExecutorService</code>ï¼šä¿®é¥°æ¥å£ <code>ExecutorService</code></li><li><code>getTtlScheduledExecutorService</code>ï¼šä¿®é¥°æ¥å£ <code>ScheduledExecutorService</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è£…é¥°çº¿ç¨‹æ±  ExecutorService</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span> TtlExecutors.getTtlExecutorService(Executors.newSingleThreadExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(<span class="string">&quot;init&quot;</span>));</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä¸éœ€è¦å†è£…é¥° Runnable</span></span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get()));</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main] Hello World</span><br></pre></td></tr></table></figure><h2 id="æºç åŠæ€æƒ³"><a href="#æºç åŠæ€æƒ³" class="headerlink" title="æºç åŠæ€æƒ³"></a>æºç åŠæ€æƒ³</h2><h3 id="TransmittableThreadLocal"><a href="#TransmittableThreadLocal" class="headerlink" title="TransmittableThreadLocal"></a>TransmittableThreadLocal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">TtlCopier</span>&lt;T&gt;</span><br></pre></td></tr></table></figure><p>ç»§æ‰¿äº† <code>InheritableThreadLocal</code>ï¼Œå®ç°äº† <code>TtlCopier</code></p><p>é‡ç‚¹å…³æ³¨ <code>set</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!disableIgnoreNullValueSemantics &amp;&amp; <span class="literal">null</span> == value) &#123;</span><br><span class="line">        <span class="comment">// may set null to remove value</span></span><br><span class="line">        remove();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.set(value);</span><br><span class="line">        addThisToHolder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä½¿ç”¨çˆ¶ç±» <code>InheritableThreadLocal</code> çš„ <code>set</code> æ–¹æ³•ä¹‹åï¼Œè°ƒç”¨äº† <code>addThisToHolder</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addThisToHolder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!holder.get().containsKey(<span class="built_in">this</span>)) &#123;</span><br><span class="line">        holder.get().put((TransmittableThreadLocal&lt;Object&gt;) <span class="built_in">this</span>, <span class="literal">null</span>); <span class="comment">// WeakHashMap supports null value.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°† <code>this</code> å¯¹è±¡ï¼Œå³ <code>TransmittableThreadLocal</code> å¯¹è±¡ä½œä¸º key æ”¾è¿› <code>holder</code> ä¸­ï¼Œè¿™é‡Œçš„ <code>holder</code> æ˜¯ä¸€ä¸ªæ³›å½¢ä¸º Map çš„ <code>InheritableThreadLocal</code>ï¼Œä¸‹é¢ä¼šè¿›è¡Œåˆ†æ</p><p>è¿™é‡Œçš„ Map åªç”¨æ¥ä½œä¸º Setï¼Œ**WeakHashMap supports null value.**ï¼›ç±»ä¼¼çš„æ€æƒ³è¿˜æœ‰ä½¿ç”¨ <code>ConcurrentHashMap</code> å®ç°å¹¶å‘å®‰å…¨çš„ Set</p><h3 id="holder"><a href="#holder" class="headerlink" title="holder"></a>holder</h3><p><code>holder</code> æ˜¯ <code>TransmittableThreadLocal</code> è¿›è¡Œæ‰©å±•çš„å…³é”®ä¸€ç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InheritableThreadLocal&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt; holder =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; initialValue() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; childValue(WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; parentValue) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;(parentValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œé‡å†™äº† <code>InheritableThreadLocal</code> çš„ <code>initialValue</code> å’Œ <code>childValue</code> æ–¹æ³•</p><ul><li>initialValueï¼šç›´æ¥åˆ›å»º Map</li><li>childValueï¼š<code>ThreadLocal.createInheritedMap</code> ä¸­å¤åˆ¶å€¼æ—¶è°ƒç”¨ï¼Œé‡å†™å®ç°ä¸ºåŒ…è£…ä¸€ä¸ªæ–° Map</li></ul><p>åœ¨ä¸Šä¸€æ­¥çš„ <code>addThisToHolder</code> æ“ä½œä¸­ï¼Œä¼šå°† <code>TransmittableThreadLocal</code> çš„ <code>this</code> å¯¹è±¡æ”¾è¿› <code>holder</code> çš„ Map ä¸­</p><h3 id="TtlRunnable"><a href="#TtlRunnable" class="headerlink" title="TtlRunnable"></a>TtlRunnable</h3><p>ä½¿ç”¨ <code>TtlRunnable</code> çš„é™æ€æ–¹æ³• <code>get</code> å¯¹æ™®é€šçš„ <code>Runnable</code> è¿›è¡Œè£…é¥°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> TtlRunnable <span class="title function_">get</span><span class="params">(<span class="meta">@Nullable</span> Runnable runnable, <span class="type">boolean</span> releaseTtlValueReferenceAfterRun, <span class="type">boolean</span> idempotent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == runnable) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡Œé¿å…è¿‡åº¦è£…é¥°ï¼Œåªè£…é¥°ä¸€å±‚</span></span><br><span class="line">    <span class="keyword">if</span> (runnable <span class="keyword">instanceof</span> TtlEnhanced) &#123;</span><br><span class="line">        <span class="comment">// avoid redundant decoration, and ensure idempotency</span></span><br><span class="line">        <span class="keyword">if</span> (idempotent) <span class="keyword">return</span> (TtlRunnable) runnable;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Already TtlRunnable!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åŒ…è£…æˆ TtlRunnable å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TtlRunnable</span>(runnable, releaseTtlValueReferenceAfterRun);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡ <code>TtlRunnable</code> çš„æ„é€ å™¨åŒ…è£…æˆ <code>TtlRunnable</code> å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">TtlRunnable</span><span class="params">(<span class="meta">@NonNull</span> Runnable runnable, <span class="type">boolean</span> releaseTtlValueReferenceAfterRun)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.capturedRef = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;Object&gt;(capture());</span><br><span class="line">    <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">    <span class="built_in">this</span>.releaseTtlValueReferenceAfterRun = releaseTtlValueReferenceAfterRun;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ª <code>ThreadLocal</code> ä¼ é€’çš„å…³é”®éƒ½åœ¨ <code>capturedRef</code> å¯¹è±¡ï¼Œèµ‹å€¼çš„å…³é”®é€»è¾‘åœ¨ <code>Transmitter.capture</code> æ–¹æ³•</p><h3 id="Transmitter"><a href="#Transmitter" class="headerlink" title="Transmitter"></a>Transmitter</h3><p><code>Transmitter</code> æ‰®æ¼”ä¼ é€’è€…çš„è§’è‰²ï¼Œæ˜¯ <code>TransmittableThreadLocal</code> çš„å…¬æœ‰é™æ€å†…éƒ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Transmitter</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Capture all &#123;<span class="doctag">@link</span> TransmittableThreadLocal&#125; and registered &#123;<span class="doctag">@link</span> ThreadLocal&#125; values in the current thread.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the captured &#123;<span class="doctag">@link</span> TransmittableThreadLocal&#125; values</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@since</span> 2.3.0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">capture</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Snapshot</span>(captureTtlValues(), captureThreadLocalValues());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; <span class="title function_">captureTtlValues</span><span class="params">()</span> &#123;</span><br><span class="line">            HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; ttl2Value = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">            <span class="keyword">for</span> (TransmittableThreadLocal&lt;Object&gt; threadLocal : holder.get().keySet()) &#123;</span><br><span class="line">                ttl2Value.put(threadLocal, threadLocal.copyValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ttl2Value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª <code>Snapshot</code> çš„å¯¹è±¡ï¼Œå°† <code>holder</code> ä¸­çš„ keysï¼ˆä¹Ÿå°±æ˜¯å°† <code>WeakHashMap</code> å½“ä½œ Set æ¥ä½¿ç”¨ï¼Œkey ä¸º <code>TransmittableThreadLocal</code> å¯¹è±¡ï¼‰éå†å–å‡ºï¼ŒåŒæ—¶è°ƒç”¨ <code>copyValue</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T <span class="title function_">copyValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> copy(get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">copy</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parentValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºç¡€çš„ <code>TransmittableThreadLocal</code> å®ç°å°±æ˜¯å°† value get å‡ºæ¥ï¼Œä¸æ¶‰åŠ copy ç­‰æ“ä½œ</p><p>å®Œæˆè¿™äº›åï¼Œ<code>TtlRunnable</code> å°±å®ä¾‹åŒ–å®Œæˆï¼Œå¹¶ä¸”ä¿å­˜äº† <code>Snapshot</code> ç»“æ„ï¼Œä¿å­˜å½“å‰æ—¶é—´ç‚¹ã€å½“å‰çº¿ç¨‹ä¸‹çš„ <code>TransmittableThreadLocal</code> å¯¹è±¡åŠå…¶ value</p><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p>æœ€ç»ˆæ”¾å…¥çº¿ç¨‹æ± çš„ <code>Runnable</code> æ˜¯è¢«è£…é¥°çš„ <code>TtlRunnable</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// è·å–å½“æ—¶ä¿å­˜çš„ çˆ¶çº¿ç¨‹ + è£…é¥°é‚£ä¸€åˆ»çš„ Snapshot</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">captured</span> <span class="operator">=</span> capturedRef.get();</span><br><span class="line">  <span class="comment">// captured == null è¯´æ˜è¯¥ Runnable å·²ç»è¢« run äº†</span></span><br><span class="line">  <span class="comment">// capturedRef.compareAndSet(captured, null) ä½¿ç”¨åŸå­ç±»ä¿è¯äº‰æŠ¢æ‰§è¡Œèµ„æ ¼</span></span><br><span class="line">    <span class="keyword">if</span> (captured == <span class="literal">null</span> || releaseTtlValueReferenceAfterRun &amp;&amp; !capturedRef.compareAndSet(captured, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;TTL value reference is released after run!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// replay é‡æ”¾</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">backup</span> <span class="operator">=</span> replay(captured);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æ‰§è¡Œè¢«è£…é¥°çš„çœŸæ­£çš„ Runnable</span></span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// restore æ¢å¤</span></span><br><span class="line">        restore(backup);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="replay"><a href="#replay" class="headerlink" title="replay"></a>replay</h3><p>ä¿å­˜å½“å‰æ—¶é—´çš„å‰¯æœ¬ï¼Œä¾é ä¼ å‚è¿›å…¥çš„å¿«ç…§ <code>captured</code> å°†è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">replay</span><span class="params">(<span class="meta">@NonNull</span> Object captured)</span> &#123;</span><br><span class="line"><span class="comment">// å–å‡ºå¿«ç…§</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Snapshot</span> <span class="variable">capturedSnapshot</span> <span class="operator">=</span> (Snapshot) captured;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Snapshot</span>(replayTtlValues(capturedSnapshot.ttl2Value), replayThreadLocalValues(capturedSnapshot.threadLocal2Value));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; <span class="title function_">replayTtlValues</span><span class="params">(<span class="meta">@NonNull</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; captured)</span> &#123;</span><br><span class="line">            HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; backup = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æ³¨æ„è¿™é‡Œçš„ holderï¼Œæ­¤æ—¶å·²ç»åœ¨å­çº¿ç¨‹å†…äº†</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Iterator&lt;TransmittableThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); iterator.hasNext(); ) &#123;</span><br><span class="line">                TransmittableThreadLocal&lt;Object&gt; threadLocal = iterator.next();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// backup</span></span><br><span class="line">                backup.put(threadLocal, threadLocal.get());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// clear the TTL values that is not in captured</span></span><br><span class="line">                <span class="comment">// avoid the extra TTL values after replay when run task</span></span><br><span class="line">                <span class="keyword">if</span> (!captured.containsKey(threadLocal)) &#123;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    threadLocal.superRemove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// set TTL values to captured</span></span><br><span class="line">            setTtlValuesTo(captured);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// call beforeExecute callback</span></span><br><span class="line">            doExecuteCallback(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> backup;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯ä¸ºäº†æ‹¿åˆ°å‰¯æœ¬ï¼Œ<strong>ä¸ºä»€ä¹ˆéœ€è¦æ‹¿åˆ°å‰¯æœ¬è€Œä¸æ˜¯ç›´æ¥æ ¹æ®å¿«ç…§è®¾ç½®å€¼å¹¶æ¢å¤å‘¢</strong></p><blockquote><p>å½“æˆ‘ä»¬æäº¤çš„ä»»åŠ¡è¢«åˆ’åˆ†çš„çº¿ç¨‹æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ˆä»»åŠ¡çš„æäº¤å’Œå®é™…æ‰§è¡Œä¸­é—´å­˜åœ¨æ—¶é—´å·®ï¼Œå¦‚æœè¿™ä¸ªæ—¶é—´æ®µå‡ºç°äº†ä¸Šä¸‹æ–‡çš„æ›´æ–°ï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–å°†å¯¼è‡´æœ¬æ¬¡æ›´æ–°ä¸¢å¤±ï¼‰ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿è¯åœ¨ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™æ˜¯å½“æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œå®Œæ¯•åéœ€è¦è¿˜åŸ</p></blockquote><ol><li>è·å–å½“å‰çº¿ç¨‹ï¼Œä¸Šçº¿æ–‡å¿«ç…§</li><li>å¦‚æœå½“å‰çº¿ç¨‹æœ‰å¿«ç…§é‡Œé¢ä¸å­˜åœ¨çš„ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆå…ˆæ¸…é™¤æ‰</li><li>å°†åˆ›å»ºTtlRunnableæ—¶ä¿å­˜çš„å¿«ç…§è®¾ç½®åˆ°å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼ˆå®ç° <code>ThreadLocal</code> ä¼ é€’çš„æ ¸å¿ƒï¼‰</li><li><code>doExecuteCallback</code> æ‰§è¡Œé’©å­æ–¹æ³•</li><li>è¿”å›ä¿å­˜çš„å‰¯æœ¬</li></ol><h3 id="restore"><a href="#restore" class="headerlink" title="restore"></a>restore</h3><p>æ ¹æ® replay æ—¶ç”Ÿæˆçš„å‰¯æœ¬å¯¹ä¸Šä¸‹æ–‡ç¯å¢ƒè¿›è¡Œæ¢å¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">restore</span><span class="params">(<span class="meta">@NonNull</span> Object backup)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Snapshot</span> <span class="variable">backupSnapshot</span> <span class="operator">=</span> (Snapshot) backup;</span><br><span class="line">    restoreTtlValues(backupSnapshot.ttl2Value);</span><br><span class="line">    restoreThreadLocalValues(backupSnapshot.threadLocal2Value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">restoreTtlValues</span><span class="params">(<span class="meta">@NonNull</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; backup)</span> &#123;</span><br><span class="line">    <span class="comment">// call afterExecute callback</span></span><br><span class="line">    doExecuteCallback(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> Iterator&lt;TransmittableThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); iterator.hasNext(); ) &#123;</span><br><span class="line">        TransmittableThreadLocal&lt;Object&gt; threadLocal = iterator.next();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clear the TTL values that is not in backup</span></span><br><span class="line">        <span class="comment">// avoid the extra TTL values after restore</span></span><br><span class="line">        <span class="keyword">if</span> (!backup.containsKey(threadLocal)) &#123;</span><br><span class="line">            iterator.remove();</span><br><span class="line">            threadLocal.superRemove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// restore TTL values</span></span><br><span class="line">    setTtlValuesTo(backup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‰¯æœ¬æ¢å¤å½“å‰çº¿ç¨‹çš„ <code>ThreadLocal</code></p><h3 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h3><p>å¯¹çº¿ç¨‹æ± çš„è£…é¥°å®ç°å’Œ <code>Runnable</code> ä¸€è‡´ï¼Œå°†çœŸæ­£çš„çº¿ç¨‹æ± åŒ…è£…åœ¨ Wrapper å¯¹è±¡ä¸­</p><p>æ ¹æ®çº¿ç¨‹æ± å®ç°çš„ä¸åŒï¼Œæœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>getTtlExecutorï¼šè¿”å› <code>Executor</code></li><li>getTtlExecutorServiceï¼šè¿”å› <code>ExecutorService</code></li><li>getTtlScheduledExecutorServiceï¼šè¿”å› <code>ScheduledExecutorService</code></li></ul><p>ä»¥ <code>getTtlExecutor</code> ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title function_">getTtlExecutor</span><span class="params">(<span class="meta">@Nullable</span> Executor executor)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ TtlAgent åŠ è½½ã€æˆ–è€…æ˜¯ TtlEnhancedï¼Œé¿å…é‡å¤è£…é¥°</span></span><br><span class="line">    <span class="keyword">if</span> (TtlAgent.isTtlAgentLoaded() || executor == <span class="literal">null</span> || executor <span class="keyword">instanceof</span> TtlEnhanced) &#123;</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ExecutorTtlWrapper</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExecutorTtlWrapper</span>(executor, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutorTtlWrapper</span> <span class="keyword">implements</span> <span class="title class_">Executor</span>, TtlWrapper&lt;Executor&gt;, TtlEnhanced &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor executor;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> idempotent;</span><br><span class="line"></span><br><span class="line">    ExecutorTtlWrapper(<span class="meta">@NonNull</span> Executor executor, <span class="type">boolean</span> idempotent) &#123;</span><br><span class="line">        <span class="built_in">this</span>.executor = executor;</span><br><span class="line">        <span class="built_in">this</span>.idempotent = idempotent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸®å¿™è°ƒç”¨äº† TtlRunnable.get</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(<span class="meta">@NonNull</span> Runnable command)</span> &#123;</span><br><span class="line">        executor.execute(TtlRunnable.get(command, <span class="literal">false</span>, idempotent));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ¬è´¨ä¸Šå°±æ˜¯åŒ…è£…ä¸º <code>ExecutorTtlWrapper</code> åé‡å†™äº†æäº¤ä»»åŠ¡ç­‰æ–¹æ³•ï¼Œå®ç°å†…ä¸»åŠ¨å»è°ƒç”¨äº†è£…é¥°æ–¹æ³•</p><h2 id="å›¾ç¤º"><a href="#å›¾ç¤º" class="headerlink" title="å›¾ç¤º"></a>å›¾ç¤º</h2><p>ä¸ªäººè®¤ä¸º <code>Transmittable</code> æ ¸å¿ƒçš„æ€æƒ³ï¼š</p><ul><li>ä¸åŒ <code>ThreadLocal</code> ä¹‹é—´çš„å…³ç³»ï¼Œä¿å­˜ã€èµ‹å€¼ã€æ¢å¤ç­‰æ“ä½œçš„æµç¨‹</li><li>å¹¶å‘åœºæ™¯ä¸‹çš„å®ç°ï¼Œä½¿ç”¨åŸå­ç±»ã€å‰¯æœ¬çš„ä¿å­˜å’Œæ¢å¤ç­‰</li></ul><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/%E6%97%B6%E5%BA%8F%E5%9B%BE.png" class="" title="æ—¶åºå›¾"><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/ThrealLocal%20%E6%93%8D%E4%BD%9C.webp" class="" title="ThrealLocal æ“ä½œ"><h2 id="æ‰©å±•-TTL"><a href="#æ‰©å±•-TTL" class="headerlink" title="æ‰©å±• TTL"></a>æ‰©å±• TTL</h2><p>ä¸Šé¢æåˆ° <code>InheritableThreadLocal</code> æ²¡æœ‰æä¾›æ‹·è´ç›¸å…³çš„èƒ½åŠ›ï¼ŒTTL ä¹Ÿè¿›è¡Œäº†æ”¯æŒ</p><p><code>SuppliedTransmittableThreadLocal</code> ç»§æ‰¿äº† <code>TransmittableThreadLocal</code>ï¼Œæä¾›äº†ä¼ å‚ <code>Supplier</code> å’Œ <code>TtlCopier</code> æ¥è¿›è¡Œåˆå§‹å€¼ã€ç»§æ‰¿å€¼æ‹·è´ã€ä¼ é€’å€¼æ‹·è´çš„è®¾ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SuppliedTransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// initialValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Supplier&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; supplier;</span><br><span class="line">    <span class="comment">// childValue InheritableThreadLocal</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TtlCopier&lt;T&gt; copierForChildValue;</span><br><span class="line">    <span class="comment">// copy</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TtlCopier&lt;T&gt; copierForCopy;</span><br><span class="line"></span><br><span class="line">    SuppliedTransmittableThreadLocal(Supplier&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; supplier, TtlCopier&lt;T&gt; copierForChildValue, TtlCopier&lt;T&gt; copierForCopy) &#123;</span><br><span class="line">        <span class="keyword">if</span> (supplier == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;supplier is null&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.supplier = supplier;</span><br><span class="line">        <span class="built_in">this</span>.copierForChildValue = copierForChildValue;</span><br><span class="line">        <span class="built_in">this</span>.copierForCopy = copierForCopy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> supplier.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">childValue</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (copierForChildValue != <span class="literal">null</span>) <span class="keyword">return</span> copierForChildValue.copy(parentValue);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="built_in">super</span>.childValue(parentValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">copy</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (copierForCopy != <span class="literal">null</span>) <span class="keyword">return</span> copierForCopy.copy(parentValue);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="built_in">super</span>.copy(parentValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡é™æ€æ–¹æ³• <code>withInitial</code>ã€<code>withInitialAndCopier</code> è¿›è¡Œåˆ›å»º</p><p><strong>ç®€å•ä½¿ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Student&gt; THREAD_LOCAL = </span><br><span class="line">        TransmittableThreadLocal.withInitialAndCopier(</span><br><span class="line">        () -&gt; <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;é»˜è®¤&quot;</span>, <span class="number">0</span>), </span><br><span class="line">        value -&gt; <span class="keyword">new</span> <span class="title class_">Student</span>(value.name + <span class="string">&quot; Inherit&quot;</span>, value.age),</span><br><span class="line">        value -&gt; <span class="keyword">new</span> <span class="title class_">Student</span>(value.name + <span class="string">&quot; Transmit&quot;</span>, value.age)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è£…é¥°çº¿ç¨‹æ±  ExecutorService</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span></span><br><span class="line">        TtlExecutors.getTtlExecutorService(Executors.newSingleThreadExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è®¾ç½®å‰ï¼š&quot;</span> + THREAD_LOCAL.get());</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è®¾ç½®åï¼š&quot;</span> + THREAD_LOCAL.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–°çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> THREAD_LOCAL.get();</span><br><span class="line">            System.out.println(<span class="string">&quot;æ–°çº¿ç¨‹ï¼š&quot;</span> + student);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°</span></span><br><span class="line">        THREAD_LOCAL.set(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰2&quot;</span>, <span class="number">21</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹ä¿®æ”¹ï¼š&quot;</span> + THREAD_LOCAL.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± </span></span><br><span class="line">        EXECUTOR.execute(() -&gt; &#123;</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> THREAD_LOCAL.get();</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹æ± ï¼š&quot;</span> + student);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä¸»çº¿ç¨‹è®¾ç½®å‰ï¼šThreadLocalTest.Student(name=é»˜è®¤, age=<span class="number">0</span>)</span><br><span class="line">ä¸»çº¿ç¨‹è®¾ç½®åï¼šThreadLocalTest.Student(name=å¼ ä¸‰, age=<span class="number">20</span>)</span><br><span class="line">ä¸»çº¿ç¨‹ä¿®æ”¹ï¼šThreadLocalTest.Student(name=å¼ ä¸‰<span class="number">2</span>, age=<span class="number">21</span>)</span><br><span class="line">æ–°çº¿ç¨‹ï¼šThreadLocalTest.Student(name=å¼ ä¸‰ Inherit, age=<span class="number">20</span>)</span><br><span class="line">çº¿ç¨‹æ± ï¼šThreadLocalTest.Student(name=å¼ ä¸‰<span class="number">2</span> Transmit, age=<span class="number">21</span>)</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://github.com/alibaba/transmittable-thread-local/tree/2.x">alibaba&#x2F;transmittable-thread-local at 2.x (github.com)</a></p><p><a href="https://www.jianshu.com/p/f92721fb0e29">TransmittableThreadLocalæºç åˆ†æ - ç®€ä¹¦ (jianshu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>REST VS gRPC</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/REST%20VS%20gRPC.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/REST%20VS%20gRPC.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´ï¼ŒREST éƒ½æ˜¯ä¸€ç§ä¸”å”¯ä¸€ä¸€ç§æ„å»º API çš„ â€œæ ‡å‡†â€ï¼›å®ƒåœ¨æŸç§ç¨‹åº¦ä¸Šå–ä»£äº† SOAPï¼Œåè€…æ˜¯ä¸€ä¸ª â€œå¤ªå¤š XMLâ€ çš„ä¸‘é™‹çƒ‚æ‘Šå­</p><p>ä½†æ˜¯è¿‘äº›å¹´æ–°çš„é€‰æ‹©å‡ºç°äº†ï¼Œ2015 å¹´ï¼ŒFacebook å‘å…¬ä¼—å‘å¸ƒäº† GraphQLï¼Œ2016 å¹´è°·æ­Œç´§éšå…¶åå‘å¸ƒäº† gRPC</p><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨ä»ç„¶è¢«å¹¿æ³›ä½¿ç”¨çš„åè€…ï¼Œå¹¶å°†å…¶ä¸ REST è¿›è¡Œæ¯”è¾ƒ</p><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>ä¸‹è¡¨å°†æ¦‚è¿°æ‰€è®¨è®ºçš„è¦ç‚¹ï¼Œå¹¶æ˜¾ç¤º REST å’Œ gRPC çš„äº®ç‚¹</p><table><thead><tr><th align="center">Toic</th><th align="center">REST</th><th align="center">gRPC</th></tr></thead><tbody><tr><td align="center"><strong>Standardization</strong></td><td align="center">æ— æ ‡å‡†</td><td align="center">å®šä¹‰å®Œå–„</td></tr><tr><td align="center"><strong>Paradigm</strong></td><td align="center">åŸºäºèµ„æº</td><td align="center">RPC</td></tr><tr><td align="center"><strong>Service modes</strong></td><td align="center">åªæœ‰ unary</td><td align="center">Unary, client streaming, server streaming å’Œ bidirectional streaming</td></tr><tr><td align="center"><strong>Requirements</strong></td><td align="center">å„ç§ HTTP ç‰ˆæœ¬ï¼ŒJSON è§£æ</td><td align="center">HTTP&#x2F;2, ä¾èµ–è¯­è¨€å®ç°</td></tr><tr><td align="center"><strong>API design</strong></td><td align="center">ä»£ç ç¬¬ä¸€</td><td align="center">è®¾è®¡ç¬¬ä¸€</td></tr><tr><td align="center"><strong>Default data format</strong></td><td align="center">JSON</td><td align="center">Protobuf</td></tr><tr><td align="center"><strong>Web browser support</strong></td><td align="center">åŸç”Ÿ</td><td align="center">gRPC web, via workarounds</td></tr><tr><td align="center"><strong>Tools</strong></td><td align="center">æ›´æˆç†Ÿ</td><td align="center">è¯­è¨€æ”¯æŒå„ä¸ç›¸åŒï¼Œæœ‰äº›å…·æœ‰å‡ºè‰²çš„å®ç°</td></tr></tbody></table><h1 id="æ ‡å‡†åŒ–"><a href="#æ ‡å‡†åŒ–" class="headerlink" title="æ ‡å‡†åŒ–"></a>æ ‡å‡†åŒ–</h1><p>REST å…¶ä¸­ä¹‹ä¸€çš„ç¼ºç‚¹å°±æ˜¯ç¼ºä¹æ ‡å‡†åŒ–ï¼Œå› ä¸º REST ä¸å…¶è¯´æ˜¯ API æ ‡å‡†ï¼ˆstandardï¼‰ï¼Œä¸å¦‚è¯´æ˜¯ä¸€ç§èŒƒå¼ï¼ˆparadigmï¼‰ï¼Œè®¸å¤šäººåœ¨è°ˆè®ºå®ƒæ—¶éƒ½æœ‰ä¸åŒçš„å«ä¹‰</p><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‰€è°“çš„ â€œREST APIâ€ æ›´å€¾å‘äºåŸºäº HTTP åè®®å’Œ JSON æ ¼å¼çš„ APIï¼Œä½†æ˜¯ä½¿ç”¨ XML ä»£æ›¿ JSON ä»ç„¶ä¼šä½¿ API ç¬¦åˆ RESTful è§„èŒƒï¼Œå°½ç®¡è¿™ç§æ–¹å¼æ²¡æœ‰è¢«å¹¿æ³›ä½¿ç”¨ï¼›REST è¿™ä¸ªæœ¯è¯­ç”šè‡³ä¸ HTTP æ— å…³ï¼Œåœ¨ä½¿ç”¨ REST API æ—¶ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å¾ˆå¤šæ··ä¹±ï¼Œä¾‹å¦‚ä½¿ç”¨è€…å¯èƒ½ä¼šè‡ªåŠ¨æœŸæœ›æŸäº› REST API ç«¯ç‚¹çš„å¹‚ç­‰æ€§æˆ–ç¼“å­˜æ€§ï¼Œå³ä½¿æ²¡æœ‰æ˜ç¡®å®šä¹‰</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼ŒgRPC å®šä¹‰å®Œå–„ï¼›ä¾‹å¦‚ï¼Œ <a href="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md">gRPC implementation over HTTP&#x2F;2</a>  éå¸¸è¯¦ç»†</p><h1 id="åŸºæœ¬åŒºåˆ«"><a href="#åŸºæœ¬åŒºåˆ«" class="headerlink" title="åŸºæœ¬åŒºåˆ«"></a>åŸºæœ¬åŒºåˆ«</h1><p>REST å’Œ gRPC çš„è§„èŒƒæ˜¯ä¸åŒçš„</p><p>REST ä¸­ä¸€åˆ‡éƒ½ä»¥èµ„æºä¸ºä¸­å¿ƒï¼Œè¿™äº›èµ„æºå¯ä»¥è¢«æ£€ç´¢å’Œæ“ä½œï¼›å¦‚æœæˆ‘ä»¬ä»¥ä¸€æœ¬ä¹¦ä½œä¸ºç¤ºä¾‹èµ„æºï¼ŒREST API é€šå¸¸ä¼šæä¾›ä»¥ä¸‹æ¥å£ï¼š</p><ul><li><code>GET /books</code> è·å–æ‰€æœ‰ä¹¦ç±ï¼Œå¯èƒ½å¸¦æœ‰ç”¨äºç­›é€‰é¡¹å’Œåˆ†é¡µç›¸å…³å‚æ•°</li><li><code>GET /books/&#123;id&#125;</code> è·å–ç‰¹å®šçš„ä¹¦</li><li><code>POST /books</code> åˆ›å»ºä¸€æœ¬ä¹¦</li><li><code>DELETE /books/&#123;id&#125;</code> åˆ é™¤ä¸€æœ¬ä¹¦</li></ul><p>å¤§å¤šæ•°åŸºäº HTTP çš„ REST API éƒ½éµå¾ªè¿™ç§æ¨¡å¼ï¼Œè™½ç„¶æ•ˆæœä¸é”™ï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨éš¾ä»¥ç”¨è¿™æ ·çš„è§„èŒƒè¡¨è¾¾çš„æƒ…å†µ</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘æƒ³åˆ›å»ºå¤šæœ¬ä¹¦ï¼Œè€Œä¸æƒ³ä¸ºæ¯æœ¬ä¹¦é‡å¤è°ƒç”¨ <code>POST/books</code>ï¼ˆå‡ºäºæ€§èƒ½ã€å¹‚ç­‰æ€§æˆ–å…¶ä»–åŸå› ï¼‰ï¼Œè¯¥å¦‚ä½•å¤„ç†ï¼›æˆ‘æ˜¯å¦åº”è¯¥å®šä¹‰ <code>POST/books/batch</code> æ¥å£ï¼Œè¿™ä»ç„¶ç¬¦åˆ RESTful å—ï¼Ÿè™½ç„¶åœ¨æŠ€æœ¯ä¸Šå¾ˆå®¹æ˜“è§£å†³ï¼Œä½†å¼€å‘äººå‘˜ä¹‹é—´ç»å¸¸ä¼šå› ä¸ºå­˜åœ¨äº‰è®®è€Œè¿›è¡Œè®¨è®º</p><p>è€Œ gRPC æ˜¯ä¸€ä¸ªRPCæ¡†æ¶ã€‚å®ƒä»¥æœåŠ¡æ–¹æ³•ä¸ºä¸­å¿ƒï¼›å¦‚æœæˆ‘ä»¬ä»¥å›¾ä¹¦ API ä¸ºä¾‹ï¼Œä½¿ç”¨ gRPCï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»º <code>BookService</code></p><ul><li><code>GetBooks()</code></li><li><code>GetBook()</code></li><li><code>CreateBook()</code></li><li><code>DeleteBook()</code></li></ul><p>å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°å‘½åè¿™äº›æ–¹æ³•ï¼Œå¹¶éœ€è¦æˆ‘ä»¬éœ€è¦çš„ä»»ä½•å‚æ•°ï¼›å¦‚æœæˆ‘ä»¬ç°åœ¨æƒ³æ·»åŠ ä¸€ä¸ªæ–¹æ³•æ¥åˆ›å»ºå¤šæœ¬ä¹¦ï¼Œæ²¡æœ‰ä»€ä¹ˆèƒ½é˜»æ­¢æˆ‘ä»¬æ·»åŠ  <code>CreateBooks()</code> æ–¹æ³•</p><p>gRPC åœ¨è®¾è®¡ API æ—¶æä¾›äº†æ›´å¤šçš„ â€œè‡ªç”±â€ï¼Œå› ä¸ºæœ‰æ›´å°‘çš„ï¼ˆè‡ªæˆ‘å¼ºåŠ çš„ï¼‰é™åˆ¶</p><h2 id="æœåŠ¡æ¨¡å¼"><a href="#æœåŠ¡æ¨¡å¼" class="headerlink" title="æœåŠ¡æ¨¡å¼"></a>æœåŠ¡æ¨¡å¼</h2><p>gRPC æ”¯æŒå››ç§æœåŠ¡æ–¹å¼ï¼š</p><ul><li><strong>Unaryï¼š</strong>å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œæ¥å—ä¸€ä¸ªå“åº”</li><li><strong>Server steamingï¼š</strong>å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œæ¥æ”¶å¤šä¸ªå“åº”</li><li><strong>Client streamingï¼š</strong>å‘é€å¤šä¸ªè¯·æ±‚ï¼Œæ¥æ”¶ä¸€ä¸ªå“åº”</li><li><strong>Bidirectional streamingï¼š</strong>å‘é€å¤šä¸ªè¯·æ±‚ï¼Œæ¥æ”¶å¤šä¸ªå“åº”</li></ul><p>è¿™æ˜¯ gRPC ç›¸æ¯”åªæ”¯æŒ Unary æ–¹å¼çš„ REST éå¸¸å¥½çš„ä¼˜åŠ¿ï¼Œåœ¨ REST API ä¸­æ”¯æŒå…¶ä»–æœåŠ¡æ¨¡å¼éœ€è¦ä½¿ç”¨ä¸åŒçš„åè®®ï¼Œä¾‹å¦‚ server-sent events æˆ– websocketï¼Œè¿™å¹¶ä¸æ˜¯éå¸¸ â€œRESTfulâ€</p><h2 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h2><p>REST API ç»å¸¸åªå·¥ä½œåœ¨å„ç§ HTTP ç‰ˆæœ¬ä¹‹ä¸Šï¼Œåªè¦ç¼–ç¨‹è¯­è¨€æœ‰ HTTP å®¢æˆ·ç«¯å’Œ JSON è§£æå™¨ï¼Œå¤„ç† REST çš„ API æ˜¯è½»è€Œæ˜“ä¸¾çš„</p><p>gRPC æ˜ç¡®éœ€è¦ HTTP&#x2F;2 åè®®çš„æ”¯æŒï¼›è¿‘äº›å¹´è¿™ç§é—®é¢˜è¶Šæ¥è¶Šå°‘ï¼Œå› ä¸ºå¤§å¤šæ•°ä»£ç†å’Œæ¡†æ¶éƒ½å¢åŠ äº†å¯¹ HTTP&#x2F;2 çš„æ”¯æŒï¼›ä¸è¿‡éœ€è¦æ³¨æ„ï¼Œç”±äº gRPC éœ€è¦ç”Ÿæˆä»£ç ï¼ˆç”¨äºåˆ›å»ºå®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å­˜æ ¹ï¼‰ï¼Œå› æ­¤å¹¶ä¸æ˜¯æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½æ”¯æŒ</p><h1 id="API-è®¾è®¡"><a href="#API-è®¾è®¡" class="headerlink" title="API è®¾è®¡"></a>API è®¾è®¡</h1><p>REST API é€šå¸¸æ˜¯å…¶å®ç°çš„ç»“æœï¼Œç§°ä¸º â€œä»£ç ä¼˜å…ˆï¼ˆcode-firstï¼‰â€ï¼›è™½ç„¶å¯ä»¥å…ˆç”¨ OpenAPI è¿›è¡Œè®¾è®¡ï¼Œç„¶åç”ŸæˆæœåŠ¡å™¨å­˜æ ¹ï¼Œä½†è¿™å¹¶ä¸æ˜¯è®¸å¤šå¼€å‘äººå‘˜é‡‡ç”¨çš„æ–¹æ³•ï¼›å¦‚æœæœ‰ä¸€ä¸ª OpenAPI å®šä¹‰ï¼Œé‚£ä¹ˆ OpenAPI å®šä¹‰å¾ˆå¯èƒ½æ˜¯ä» API å®ç°ç”Ÿæˆçš„ï¼›å› æ­¤ API å®šä¹‰ä¸å®ç°ç´§å¯†è€¦åˆï¼Œé”™è¯¯åœ°æ›´æ”¹æ¨¡å‹å¯èƒ½ä¼šå¯¼è‡´æ— æ„ä¸­ç ´å API</p><p>gRPC ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ï¼Œåœ¨å®ç° API ä¹‹å‰å¿…é¡»å®šä¹‰ APIï¼Œç§°ä¸º â€œè®¾è®¡ä¼˜å…ˆï¼ˆdesign-firstï¼‰â€ï¼Œç„¶åæ ¹æ®è¿™ä¸ª API å®šä¹‰ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å­˜æ ¹ï¼Œè¿™éœ€è¦æå‰è¿›è¡Œï¼Œå› ä¸ºä¸èƒ½ç›´æ¥å®ç° API</p><p>è¿™ä¸¤ç§æ–¹æ³•å„æœ‰åˆ©å¼Šã€‚é€šå¸¸çš„ REST API æ–¹æ³•å…è®¸æ›´å¿«çš„è¿­ä»£ï¼Œå› ä¸ºæœåŠ¡å™¨å§‹ç»ˆæ˜¯çœŸå®æ¥å£çš„æ¥æºï¼›è€Œä½¿ç”¨ gRPCï¼Œéœ€è¦åœ¨è°ƒæ•´å®ç°ä¹‹å‰é¦–å…ˆæ›´æ”¹ API çš„å®šä¹‰å¯èƒ½ä¼šæ¯”è¾ƒçƒ¦äººï¼Œä½†æ˜¯å®ƒé€šè¿‡æ˜¾å¼å®šä¹‰ API å¸¦æ¥äº†ä¸€äº›å®‰å…¨ä¼˜ç‚¹</p><h1 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h1><p>REST å’Œ gRPC éƒ½ä¼šä½¿ç”¨ä¸åŒçš„æ ¼å¼æ¥è¿›è¡Œæ•°æ®ä¼ è¾“ï¼›å¤§éƒ¨åˆ† REST API ä½¿ç”¨ JSONï¼ŒgRPC åˆ™ä¼šé»˜è®¤ä½¿ç”¨ <a href="https://protobuf.dev/">Protocol Buffers</a>ï¼ˆProtobufï¼‰ï¼Œè®©æˆ‘ä»¬æ¥æ¯”è¾ƒè¿™ä¸¤è€…</p><p>JSON å¯¹æ•°æ®ç±»å‹çš„æ”¯æŒæœ‰é™ï¼Œä¹Ÿæœ‰ä¸€äº›æ€ªç™–ï¼ˆä¾‹å¦‚å¤§æ•°å­—éœ€è¦è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²ï¼‰ï¼›å®ƒæ˜¯ä¸€ç§æ–‡æœ¬æ ¼å¼ï¼Œä¾¿äºé˜…è¯»ï¼›å­—æ®µåæ˜¯åºåˆ—åŒ–çš„ï¼Œè¿™ä¼šå ç”¨ä¸€äº›ç©ºé—´ï¼Œåœ¨ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­éœ€è¦ä½¿ç”¨åå°„æ¥ååºåˆ—åŒ– JSON æ ¼å¼çš„æ•°æ®ï¼Œä¼šæ¯”è¾ƒæ…¢</p><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒgRPC API çš„æ¶ˆæ¯ç±»å‹é¦–å…ˆè¢«å®šä¹‰ä¸º Protocol Buffersï¼›å¯¹äºå—æ”¯æŒçš„ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼ˆåï¼‰åºåˆ—åŒ–æ¶ˆæ¯çš„ä»£ç ï¼›å¹¶ä¸”ç”±äºå®ƒæ˜¯ä¸€ç§äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¸éœ€è¦åºåˆ—åŒ–å­—æ®µåï¼Œå› æ­¤å®ƒä½¿ç”¨çš„ç©ºé—´æ¯”ç­‰æ•ˆçš„  JSON æ¶ˆæ¯æ›´å°‘ï¼›å½“ç„¶ç¼ºç‚¹æ˜¯ä¸å†å…·å¤‡äººç±»å¯è¯»æ€§ï¼Œéœ€è¦ Protobuf å®šä¹‰æ¥ååºåˆ—åŒ–æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šå¯¹å¼€å‘äººå‘˜é€ æˆä¸€äº›é˜»ç¢</p><p>ä¸‹é¢çš„ JSON ç¤ºä¾‹å°†å ç”¨å¤§çº¦ 66 ä¸ªå­—èŠ‚ï¼ˆå»æ‰ç©ºæ ¼ï¼‰</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persons&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Max&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">23</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mike&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">52</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç­‰æ•ˆçš„åºåˆ—åŒ– protobuf ä¿¡æ¯ä»…ä½¿ç”¨ 19 ä¸ªå­—èŠ‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>x0A070A034D617810170A080A04486<span class="number">16E731034</span></span><br></pre></td></tr></table></figure><h2 id="å¤§å‹æ•°æ®"><a href="#å¤§å‹æ•°æ®" class="headerlink" title="å¤§å‹æ•°æ®"></a>å¤§å‹æ•°æ®</h2><p>Protobuf è®¾è®¡ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–å†…å­˜ä¸­çš„æ•°æ®ï¼Œå› æ­¤ä¸å»ºè®®ä½¿ç”¨ Protobuf &#x2F; gRPC ä¼ è¾“å¤§å‹æ•°æ®ï¼›å¤§å¤šæ•° gRPC å®ç°å¯¹å•ä¸ªæ¶ˆæ¯çš„é»˜è®¤é™åˆ¶ä¸º 4MB</p><p>ä½¿ç”¨ REST API å¤„ç†å¤§æ•°æ®é‡ï¼ˆä¾‹å¦‚æ–‡ä»¶ä¸Šä¼ ï¼‰æ˜¯ç›¸å½“ç›´æ¥çš„ï¼Œæ¥æ”¶åˆ°çš„æ–‡ä»¶å¯ä»¥è¢«è§†ä¸ºæµï¼Œåªéœ€ä½¿ç”¨å¾ˆå°‘çš„å†…å­˜</p><p>è¿™åœ¨ gRPC ä¸­å¹¶éä¸å¯èƒ½ï¼Œä½†éœ€è¦æ›´å¤šçš„æ‰‹åŠ¨æ“ä½œï¼šæ–‡ä»¶å¿…é¡»åœ¨å‘é€æ–¹åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œç„¶åæ¯ä¸ªå—å°†ä½œä¸ºå•ç‹¬çš„æ•°æ®é€šè¿‡å®¢æˆ·ç«¯æµä¼ è¾“æ–¹æ³•å‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ¥æ”¶æ¯ä¸ªå—ï¼Œå¹¶å¯ä»¥ä»ä¸­æ„é€ æ•°æ®æµï¼Œä»è€Œäº§ç”Ÿä¸ REST API ç±»ä¼¼çš„è¡Œä¸ºï¼Œå°½ç®¡éœ€è¦ä»˜å‡ºæ›´å¤šåŠªåŠ›</p><h1 id="æµè§ˆå™¨å…¼å®¹æ€§"><a href="#æµè§ˆå™¨å…¼å®¹æ€§" class="headerlink" title="æµè§ˆå™¨å…¼å®¹æ€§"></a>æµè§ˆå™¨å…¼å®¹æ€§</h1><p>è¿™å°±æ˜¯ REST çœŸæ­£çš„é—ªå…‰ç‚¹ï¼Œå®ƒç”± Web æµè§ˆå™¨å¤©ç„¶æ”¯æŒï¼Œå› æ­¤å¯ä»¥è½»æ¾åœ°ä½¿ç”¨ Web åº”ç”¨ç¨‹åºä¸­çš„ REST API</p><p>gRPC ä¸ç›´æ¥ç”±æµè§ˆå™¨æ”¯æŒï¼Œå› ä¸ºå®ƒéœ€è¦æ˜ç¡®çš„ HTTP&#x2F;2 æ”¯æŒå’Œè®¿é—®æŸäº› HTTP&#x2F;2 åŠŸèƒ½ï¼Œè€Œ web æµè§ˆå™¨ä¸æä¾›è¿™äº›åŠŸèƒ½</p><p>gRPC Web å¯ä»¥ä½œä¸ºä¸€ç§å˜é€šæ–¹å¼ï¼›è¿™æ˜¯ gRPC åè®®çš„ä¸€ä¸ªå¾®å°å˜åŒ–ï¼Œä½¿å…¶å¯ä¾› web æµè§ˆå™¨ä½¿ç”¨</p><p>å¯¹äºæŸäº›ç¼–ç¨‹è¯­è¨€ï¼Œæ¡†æ¶ä¸­å·²ç»åŒ…å«äº† gRPC Web æ”¯æŒï¼›è€Œå¯¹äºä¸æ”¯æŒçš„è¯­è¨€ï¼Œéœ€è¦ä¸€ä¸ªä»£ç†æ¥å°† gRPC è¯·æ±‚è½¬æ¢ä¸º gRPC Web è¯·æ±‚ï¼Œåä¹‹äº¦ç„¶</p><p>ä¸ä¸éœ€è¦ç‰¹æ®Šä¾èµ–çš„ REST API ç›¸æ¯”ï¼ŒgRPC API åœ¨ä» Web ä¸Šä½¿ç”¨æ—¶æ›´éº»çƒ¦</p><h1 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h1><p>gRPC å’Œ REST å·¥å…·åœ¨ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ä¹‹é—´å·®å¼‚å¾ˆå¤§ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒgRPC æ„Ÿè§‰æ›´ â€œåŸç”Ÿï¼ˆnativeï¼‰â€ï¼Œè€Œåœ¨å¦ä¸€äº›æƒ…å†µä¸‹ï¼ŒREST å·¥å…·åˆ™æ›´é«˜çº§</p><p>å¯¹ gRPC è€Œè¨€é€‚å½“è¯­è¨€æ”¯æŒæ›´ä¸ºé‡è¦ï¼Œå› ä¸ºå®ƒéœ€è¦å·¥å…·æ¥ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å­˜æ ¹ï¼ˆstubsï¼‰ï¼›å¯¹äºä¸å—æ”¯æŒçš„ç¼–ç¨‹è¯­è¨€åˆ™å°±ä¸é‚£ä¹ˆå¹¸è¿äº†</p><p>REST API çš„å®¢æˆ·ç«¯æ€»æ˜¯å¯ä»¥æ‰‹åŠ¨åˆ›å»ºçš„ï¼Œè™½ç„¶å¯èƒ½éœ€è¦ä¸€äº›åŠªåŠ›ï¼›å­˜åœ¨ä» Open API å®šä¹‰åˆ›å»º REST å®¢æˆ·ç«¯çš„å·¥å…·ï¼Œä½†ä¸ gRPC ç›¸æ¯”ï¼Œå¯¹å¼€å‘äººå‘˜çš„ç»éªŒè¦æ±‚æ›´å°‘</p><p>ç”±äº REST API å­˜åœ¨çš„æ—¶é—´è¦é•¿å¾—å¤šï¼Œå› æ­¤å­˜åœ¨æ›´å¤šæœ‰åŠ©äºæ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½² REST API çš„å·¥å…·ï¼›å®ƒä»¬çš„åŠŸèƒ½é€šå¸¸æ¯” gRPC å·¥å…·æ›´é«˜çº§</p><p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ„å»º Kreya çš„ä¸»è¦åŸå› ä¹‹ä¸€ï¼Œå®ƒè¯•å›¾æˆä¸ºæœ€å¥½çš„ gRPC GUI å®¢æˆ·ç«¯ï¼ˆåŒæ—¶ä¹Ÿæ”¯æŒ RESTï¼‰</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>REST å’Œ gRPC éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹å’Œç¼ºç‚¹</p><p>ä» Web åº”ç”¨ä¸­å¤„ç† REST API é€šå¸¸æ¥è¯´æ›´ç®€å•ï¼›æ­¤å¤– REST API ä½¿ç”¨æ›´å¹¿æ³›ï¼Œè¿™ä½¿å¾—ä¸€äº›å¼€å‘äººå‘˜ä½¿ç”¨å®ƒæ›´å®¹æ˜“ï¼Œå› ä¸ºä»–ä»¬å¯èƒ½ä¸äº†è§£ gRPC</p><p>åœ¨æˆ‘çœ‹æ¥ï¼ŒgRPC åœ¨æœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„é€šä¿¡ï¼ˆä¾‹å¦‚å¾®æœåŠ¡ä¹‹é—´ï¼‰æ–¹é¢æ— ç–‘å…·æœ‰ä¼˜åŠ¿ï¼Œèƒ½å¤Ÿå…±äº«å‡†ç¡®çš„ API å®šä¹‰å¹¶ç”¨å¤šç§ç¼–ç¨‹è¯­è¨€åˆ›å»º API å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„èƒœåˆ©</p><p>å¯¹äº â€œæˆ‘åº”è¯¥ä½¿ç”¨ REST è¿˜æ˜¯ gRPCâ€ çš„é—®é¢˜æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œæœ‰äº› API å¯èƒ½å…·æœ‰ç‹¬ç‰¹çš„æƒ…å†µï¼ŒgRPC æˆ– REST å…¶ä¸­ä¸€ä¸ªå¯èƒ½æ›´é€‚åˆï¼Œæˆ–è€…ç¨‹åºå‘˜å¯¹å…¶ä¸­ä¸€è€…çš„ä½¿ç”¨æ›´é¡ºæ‰‹ã€æ›´ç†Ÿç»ƒ</p><p>æ‰€æœ‰è¿™äº›éƒ½æ˜¯ç†ç”±ï¼Œæ‰€ä»¥æ¯ä¸ªäººéƒ½åº”è¯¥è‡ªå·±å†³å®šä½¿ç”¨å“ªç§æŠ€æœ¯</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://kreya.app/blog/rest-vs-grpc/">https://kreya.app/blog/rest-vs-grpc/</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ThreadLocal &amp; Memory Leak</title>
      <link href="/%E5%BC%80%E5%8F%91/Java/ThreadLocal%20&amp;%20Memory%20Leak.html"/>
      <url>/%E5%BC%80%E5%8F%91/Java/ThreadLocal%20&amp;%20Memory%20Leak.html</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h1><p>åœ¨é¡¹ç›®ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>ThreadLocal</code> æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯</p><p>å…¶ä¸­ä¸€èˆ¬ä¼šåœ¨è¿‡æ»¤å™¨&#x2F;æ‹¦æˆªå™¨çš„å…¥å£å¤„åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶åœ¨æ‰§è¡Œç»“æŸåå¯¹å…¶è¿›è¡Œæ¸…ç†</p><p>è¿™æ ·ä»è¯·æ±‚è¿›æ¥ä¸€ç›´åˆ°è¿”å›ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡çº¿ç¨‹å˜é‡ <code>ThreadLocal</code> è·å–ç”¨æˆ·ä¿¡æ¯å³å¯ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½ä»æ•°æ®åº“æŸ¥å‡ºæ¥</p><p>å› ä¸º <code>ThreadLocal</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ<strong>æ‰€ä»¥é€šå¸¸å£°æ˜ä¸ºä¸€ä¸ªé™æ€å•ä¾‹å˜é‡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHolder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadLocal&lt;UserInfo&gt; CURRENT_USER = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserInfo <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CURRENT_USER.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(UserInfo userInfo)</span> &#123;</span><br><span class="line">        CURRENT_USER.set(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        CURRENT_USER.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥åœ¨æ‹¦æˆªå™¨ä¸­é€šè¿‡ <code>set()</code> æ–¹æ³•å­˜å‚¨é‰´æƒæˆåŠŸçš„ç”¨æˆ·æ•°æ®ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘ä¸­é€šè¿‡ <code>get()</code> è·å–ç”¨æˆ·æ•°æ®äº†</p><h1 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h1><blockquote><p>This class provides thread-local variables.  These variables differ from their normal counterparts in that each thread that accesses one (via its {@code get} or {@code set} method) has its own,independently initialized copy of the variable</p></blockquote><h2 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><p><strong>æ„é€ æ–¹æ³•</strong></p><p><code>ThreadLocal</code> ä»…å­˜åœ¨ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadLocal</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¾ç½®å€¼"><a href="#è®¾ç½®å€¼" class="headerlink" title="è®¾ç½®å€¼"></a>è®¾ç½®å€¼</h2><p><strong>set()</strong></p><p>ä½¿ç”¨ <code>set()</code> æ–¹æ³•å‘å…¶èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨ <code>Thread.currentThread()</code> è·å–å½“å‰çº¿ç¨‹ï¼›<code>Thread.currentThread()</code> æ˜¯ä¸€ä¸ª native æ–¹æ³•</p><p><strong>ThreadLocalMap</strong></p><p>æ¥ä¸‹æ¥è°ƒç”¨äº† <code>getMap(Thread t)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Get the map associated with a ThreadLocal. Overridden in InheritableThreadLocal.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  t the current thread</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the map</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„æ˜¯çº¿ç¨‹å¯¹è±¡çš„ä¸€ä¸ªçº¿ç¨‹å˜é‡ <code>ThreadLocal.ThreadLocalMap threadLocals = null</code>ï¼Œåˆå§‹çš„é»˜è®¤å€¼æ˜¯ nullï¼Œè¿”å›åå›åˆ° <code>set()</code> </p><p>å½“æ‹¿åˆ°çš„é»˜è®¤å€¼æ˜¯ null æ—¶ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ª map å°†å€¼æ”¾å…¥ map ä¸­ï¼›ä¸ä¸º null æ—¶å°†å€¼ç›´æ¥æ”¾å…¥ map</p><p><code>ThreadLocalMap</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé™¤æ­¤ä¹‹å¤–åœ¨è¿™é‡Œå¯ä»¥å…ˆè§†ä½œ <code>HashMap</code>ï¼Œä¹Ÿæ˜¯åŸºäºæ•£åˆ—å­˜å‚¨çš„ Map</p><p><strong>createMap()</strong></p><p>å½“ç¬¬ä¸€æ¬¡ä½¿ç”¨ <code>ThreadLocalMap</code> æ—¶ï¼Œéœ€è¦è°ƒç”¨ <code>createMap()</code> è¿›è¡Œåˆ›å»º</p><p><code>createMap()</code> å†…è°ƒç”¨äº† <code>ThreadLocalMap</code> çš„æ„é€ æ–¹æ³•ï¼ŒæŠŠè‡ªå·±çº¿ç¨‹å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ äº†è¿›å»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤å»åˆ›å»º <code>Entry</code> æ•°ç»„å¯¹è±¡å’Œé‡ç½®è´Ÿè½½å› å­çš„æ“ä½œï¼Œæœ¬è´¨ä¸Šå°† KV æ ¹æ®çº¿ç¨‹å¯¹è±¡çš„ <code>threadLocalHashCode</code> æ”¾åˆ°äº†ç›¸åº”çš„æ•°ç»„ä½ç½®ä¸Šï¼ŒK å°±æ˜¯çº¿ç¨‹å¯¹è±¡ï¼ŒV æ˜¯ <code>ThreadLocal</code> è¦å­˜å‚¨çš„å€¼</p><p>æ‰€ä»¥éœ€è¦æ³¨æ„ï¼š</p><ul><li><code>ThreadLocalMap</code> ä¸­çš„ K æ˜¯çº¿ç¨‹å¯¹è±¡ï¼ŒV æ˜¯è¦å­˜å‚¨çš„å€¼</li><li>æ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ä½¿ç”¨åŒä¸€ä¸ª <code>ThreadLocalMap</code> å¯¹è±¡ï¼ŒK æ˜¯å„è‡ªçš„çº¿ç¨‹å¯¹è±¡</li></ul><h2 id="å¼±å¼•ç”¨"><a href="#å¼±å¼•ç”¨" class="headerlink" title="å¼±å¼•ç”¨"></a>å¼±å¼•ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">    Object value;</span><br><span class="line"></span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="built_in">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ThreadLocal.ThreadLocalMap</code> å†…å­˜å‚¨çš„æ˜¯ <code>Entry[]</code></p><p><code>Entry</code> çš„ key æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œè€Œ value ä¸ºå¼ºå¼•ç”¨</p><h2 id="å–å€¼"><a href="#å–å€¼" class="headerlink" title="å–å€¼"></a>å–å€¼</h2><p><strong>get()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> T <span class="title function_">setInitialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> initialValue();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–çš„æ–¹æ³•ï¼Œé¦–å…ˆè·å–å½“å‰çº¿ç¨‹æ‹¥æœ‰çš„ <code>ThreadLocalMap</code>ï¼Œç„¶åå°†è‡ªå·±å¯¹è±¡ä½œä¸º K è¿›è¡Œå–å€¼</p><p>å¦‚æœ <code>ThreadLocalMap</code> ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ– <code>setInitialValue()</code>ï¼Œåˆå§‹åŒ–ç»“æŸåè¿”å› null</p><p>æ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿ <code>ThreadLocal</code> åé‡å†™ <code>initialValue()</code> æ¥è®¾ç½®é»˜è®¤çš„è¿”å›å€¼</p><h2 id="åˆ é™¤å€¼"><a href="#åˆ é™¤å€¼" class="headerlink" title="åˆ é™¤å€¼"></a>åˆ é™¤å€¼</h2><p><strong>remove()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">m</span> <span class="operator">=</span> getMap(Thread.currentThread());</span><br><span class="line">    <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">        m.remove(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè·å–çº¿ç¨‹å¯¹è±¡ä¸­ä¿å­˜çš„ <code>ThreadLocalMap</code>ï¼Œå¦‚æœä¸ä¸º null åˆ™è°ƒç”¨ <code>remove()</code></p><p><strong>ThreadLocalMap çš„ remove()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">         e != <span class="literal">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.get() == key) &#123;</span><br><span class="line">            e.clear();</span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯ä»¥çº¿ç¨‹å¯¹è±¡ä½œä¸º K å¯¹ V è¿›è¡Œåˆ é™¤</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ¯”è¾ƒåç›´è§‰çš„æ˜¯ï¼Œæ“ä½œ <code>ThreadLocal</code> å¯¹è±¡ï¼Œä½†æ•°æ®å¹¶ä¸å­˜å‚¨åœ¨ <code>ThrealLocal</code>ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨çº¿ç¨‹å¯¹è±¡çš„ <code>ThreadLocal.ThreadLocalMap</code> ä¸­</p><ul><li><code>ThreadLocal</code> æ›´åƒæ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨æ¥æ“ä½œ <code>ThreadLocal.ThreadLocalMap</code></li><li><code>ThreadLocal.ThreadLocalMap</code> å†…å­˜å‚¨ <code>Entry[]</code>ï¼Œå› ä¸ºä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä½¿ç”¨äº†å¤šä¸ª <code>ThreadLocal</code></li><li><code>ThreadLocal</code> å¯¹è±¡è¢«ä½œä¸º key è¿›è¡Œä½¿ç”¨</li><li><code>ThreadLocal.ThreadLocalMap</code> çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨çš„ç›®çš„æ˜¯ä¸ºäº†ä¾¿äºå¯¹ <code>ThreadLocal</code> å¯¹è±¡æœ¬èº«è¿›è¡Œå›æ”¶</li></ul><h1 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h1><p><code>ThreadLocal</code> æ•´ä¸ªä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºå‡ºå“ªäº›å¯¹è±¡ï¼š</p><ul><li><code>ThreadLocal</code> å¯¹è±¡</li><li><code>ThreadLocal.ThreadLocalMap</code> å¯¹è±¡ï¼Œåœ¨ <code>Thread</code> å¯¹è±¡ä¸­è¢«æŒæœ‰</li><li><code>ThreadLocal.ThreadLocalMap</code> ä¸­çš„ <code>Entry</code> å¯¹è±¡</li><li><code>ThreadLocal.ThreadLocalMap</code> ä¸­çš„ <code>Entry</code> å¯¹è±¡ä¸­çš„ K å’Œ V</li></ul><h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p><code>ThreadLocal</code> å¯¹è±¡ä¸€èˆ¬ä¸å­˜åœ¨æ³„æ¼é—®é¢˜ï¼š</p><ul><li><code>ThreadLocal</code> æ˜¯æ“ä½œ <code>ThreadLocal.ThreadLocalMap</code> çš„ keyï¼Œå®ä¾‹åŒ–æ•°é‡ä¸å¤š</li><li><code>Entry</code> å¼±å¼•ç”¨çš„è®¾è®¡å°±æ˜¯ä¸ºäº†åŠæ—¶å›æ”¶ <code>ThreadLocal</code> å¯¹è±¡</li></ul><h2 id="ThreadLocal-ThreadLocalMap"><a href="#ThreadLocal-ThreadLocalMap" class="headerlink" title="ThreadLocal.ThreadLocalMap"></a>ThreadLocal.ThreadLocalMap</h2><p>åŸºæœ¬ä¹Ÿä¸ä¼šå­˜åœ¨æ³„æ¼é—®é¢˜ï¼Œè¯¥å¯¹è±¡è¢« <code>Thread</code> å¯¹è±¡æŒæœ‰ï¼Œå¹¶ä¸”åªæ˜¯ä¸€ä¸ª Map ç»“æ„çš„å¼•ç”¨</p><h2 id="Entry"><a href="#Entry" class="headerlink" title="Entry"></a>Entry</h2><p><code>Entry</code> æœ¬èº«æ˜¯ä¸€ä¸ªå¼•ç”¨å¯¹è±¡ï¼Œå…¶é€šè¿‡ <code>ThreadLocal.ThreadLocalMap</code> çš„æ“ä½œæ–¹æ³•è¿›è¡Œé‡Šæ”¾ï¼Œä¾‹å¦‚ <code>set</code>ã€<code>remove</code> ä¸­çš„ <code>replaceStaleEntry</code>ã€<code>expungeStaleEntry</code> æ–¹æ³•</p><p><code>Entry</code> å¯¹è±¡çš„ key å³ä¸º <code>ThreadLocal</code> å¯¹è±¡ï¼Œä¸Šé¢å·²ç»æåˆ°äº†å› ä¸ºå¼±å¼•ç”¨çš„è®¾è®¡ä¸€èˆ¬ä¼šè¢«åŠæ—¶å›æ”¶</p><p><code>Entry</code> å¯¹è±¡çš„ value ä¸ºå¼ºå¼•ç”¨ï¼Œå®ƒåªä¼šå› ä¸º <code>Entry</code> å¯¹è±¡çš„å›æ”¶è€Œè¢«å›æ”¶ï¼Œè¿™æ˜¯æœ€æœ‰å¯èƒ½å‘ç”Ÿå†…å­˜æ³„æ¼çš„åœ°æ–¹ï¼Œå¯èƒ½å­˜åœ¨ä½œä¸º key çš„ <code>ThreadLocal</code> å¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œä½†æ˜¯ value æ— æ³•å›æ”¶çš„æƒ…å†µ</p><p>å½“ç„¶åœ¨è®¾è®¡ä¸­ï¼Œ<code>ThreadLocal.ThreadLocalMap</code> çš„ä¸€äº›æ“ä½œä¼šæ£€æŸ¥æ•´ä¸ª Mapï¼ˆ<code>replaceStaleEntry</code>ã€<code>expungeStaleEntry</code>ï¼‰ï¼Œä»è€Œå¯¹ key å·²ç»å›æ”¶çš„ <code>Entry</code> è¿›è¡Œé‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼</p><h2 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸Šè¿°å¯è§ï¼Œ<code>Entry</code> æ—¶æœ€æœ‰å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼çš„åœ°æ–¹</p><ul><li>æ²¡æœ‰æ‰‹åŠ¨è°ƒç”¨ <code>remove</code> æ–¹æ³•ï¼ŒåŒæ—¶ <code>ThreadLocal</code> æ— è®ºæ˜¯å¦å›æ”¶ï¼Œvalue éƒ½å¯èƒ½åœ¨ä¸€å®šæ—¶é—´å†…ã€æˆ–è€…ä¸€ç›´æ— æ³•è¢«å›æ”¶</li><li>é”™è¯¯åœ°åˆ›å»º <code>Thread</code> å¯¹è±¡ï¼Œè€Œæ²¡æœ‰å¯¹æ—§çš„çº¿ç¨‹å¯¹è±¡è¿›è¡Œå›æ”¶</li><li>è¿™é‡Œæœ‰ä¸€ä¸ª Tomcat æœºåˆ¶ç›¸å…³çš„é—®é¢˜ä»è€Œå¯¼è‡´æ³„æ¼ï¼Œæˆ‘å¹¶æ²¡çœ‹æ‡‚â€¦<br><a href="https://stackoverflow.com/questions/17968803/threadlocal-memory-leak">java - ThreadLocal &amp; Memory Leak - Stack Overflow</a></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://juejin.cn/post/7083332935096467463">ä¸ºä»€ä¹ˆThreadLocalæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="https://blog.csdn.net/weixin_39970883/article/details/126010873">Tomcatçº¿ç¨‹å¤ç”¨ä¸Threadlocalå¼•å‘çš„æƒ¨æ¡ˆ_çº¿ç¨‹å¤ç”¨ threadlocal_å°æ²ˆåŒå­¦å‘€çš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://stackoverflow.com/questions/17968803/threadlocal-memory-leak">java - ThreadLocal &amp; Memory Leak - Stack Overflow</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java æ³›å‹</title>
      <link href="/%E5%BC%80%E5%8F%91/Java/Java%20%E6%B3%9B%E5%9E%8B.html"/>
      <url>/%E5%BC%80%E5%8F%91/Java/Java%20%E6%B3%9B%E5%9E%8B.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><h2 id="ä»€ä¹ˆæ˜¯æ³›å‹"><a href="#ä»€ä¹ˆæ˜¯æ³›å‹" class="headerlink" title="ä»€ä¹ˆæ˜¯æ³›å‹"></a>ä»€ä¹ˆæ˜¯æ³›å‹</h2><p>æ³›å‹ï¼Œå³<strong>å‚æ•°åŒ–ç±»å‹</strong></p><p>ä¸€æåˆ°å‚æ•°ï¼Œæœ€ç†Ÿæ‚‰çš„å°±æ˜¯å®šä¹‰æ–¹æ³•æ—¶æœ‰å½¢å‚ï¼Œç„¶åè°ƒç”¨æ­¤æ–¹æ³•æ—¶ä¼ é€’å®å‚ã€‚é‚£ä¹ˆå‚æ•°åŒ–ç±»å‹æ€ä¹ˆç†è§£å‘¢ï¼Ÿé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†ç±»å‹ç”±åŸæ¥çš„å…·ä½“çš„ç±»å‹å‚æ•°åŒ–ï¼Œç±»ä¼¼äºæ–¹æ³•ä¸­çš„å˜é‡å‚æ•°ï¼Œæ­¤æ—¶ç±»å‹ä¹Ÿå®šä¹‰æˆå‚æ•°å½¢å¼ï¼ˆå¯ä»¥ç§°ä¹‹ä¸ºç±»å‹å½¢å‚ï¼‰ï¼Œç„¶ååœ¨è°ƒç”¨æ—¶ä¼ å…¥å…·ä½“çš„ç±»å‹ï¼ˆç±»å‹å®å‚ï¼‰</p><h2 id="ä¸ºä»€ä¹ˆè¦å¼•å…¥æ³›å‹"><a href="#ä¸ºä»€ä¹ˆè¦å¼•å…¥æ³›å‹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å¼•å…¥æ³›å‹"></a>ä¸ºä»€ä¹ˆè¦å¼•å…¥æ³›å‹</h2><p>ä½¿ç”¨æ³›å‹è¿›è¡Œå£°æ˜å¯ä»¥è®©ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µå°±èƒ½å¤Ÿå¸®æˆ‘ä»¬å‘ç°é”™è¯¯ç±»å‹å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">list.add(<span class="string">&quot;string&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹è½¬æ¢å¼‚å¸¸ ClassCastException</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> (Student)list.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h2 id="æ³›å‹æ“¦é™¤"><a href="#æ³›å‹æ“¦é™¤" class="headerlink" title="æ³›å‹æ“¦é™¤"></a>æ³›å‹æ“¦é™¤</h2><p>æ³›å‹æ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±ä¼šè¿›è¡Œæ³›å‹æ“¦é™¤ï¼Œæ³›å‹ä¿¡æ¯ä¸ä¼šè¿›å…¥åˆ°è¿è¡Œæ—¶é˜¶æ®µï¼ˆäº‹å®ä¸Šæœ‰äº›æ³›å‹ä¿¡æ¯ä¼šè¢«ä¿ç•™ï¼Œè§ä¸‹æ–‡çš„ API ä»‹ç»ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringArrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">List&lt;Integer&gt; integerArrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">classStringArrayList</span> <span class="operator">=</span> stringArrayList.getClass();</span><br><span class="line"><span class="type">Class</span> <span class="variable">classIntegerArrayList</span> <span class="operator">=</span> integerArrayList.getClass();</span><br><span class="line"></span><br><span class="line"><span class="comment">// equals = true è¯´æ˜æœ€åçš„ Class ä¿¡æ¯ä¸åŒ…å«æ³›å‹ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">equals</span> <span class="operator">=</span> Objects.equals(classStringArrayList, classIntegerArrayList);</span><br></pre></td></tr></table></figure><h1 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h1><p>æ³›å‹çš„ä½¿ç”¨åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼šæ³›å‹ç±»ã€æ³›å‹æ¥å£ã€æ³›å‹æ–¹æ³•</p><h2 id="æ³›å‹ç±»"><a href="#æ³›å‹ç±»" class="headerlink" title="æ³›å‹ç±»"></a>æ³›å‹ç±»</h2><p>æ³›å‹ç±»å‹ç”¨äºç±»çš„å®šä¹‰ä¸­ï¼Œè¢«ç§°ä¸ºæ³›å‹ç±»ã€‚é€šè¿‡æ³›å‹å¯ä»¥å®Œæˆå¯¹ä¸€ç»„ç±»çš„æ“ä½œå¯¹å¤–å¼€æ”¾ç›¸åŒçš„æ¥å£</p><p>æœ€å…¸å‹çš„å°±æ˜¯å„ç§é›†åˆç±»ï¼Œå¦‚ï¼šListã€Setã€Map</p><p><strong>ç®€å•çš„æ³›å‹ç±»</strong></p><p>æ³›å‹ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsClass</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">//keyè¿™ä¸ªæˆå‘˜å˜é‡çš„ç±»å‹ä¸ºT,Tçš„ç±»å‹ç”±å¤–éƒ¨æŒ‡å®š</span></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GenericsClass</span><span class="params">(T key)</span> &#123; <span class="comment">//æ³›å‹æ„é€ æ–¹æ³•å½¢å‚keyçš„ç±»å‹ä¹Ÿä¸ºTï¼ŒTçš„ç±»å‹ç”±å¤–éƒ¨æŒ‡å®š</span></span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span> &#123; <span class="comment">//æ³›å‹æ–¹æ³•getKeyçš„è¿”å›å€¼ç±»å‹ä¸ºTï¼ŒTçš„ç±»å‹ç”±å¤–éƒ¨æŒ‡å®š</span></span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜è¯¥ç±»æ³›å‹ä¸º String</span></span><br><span class="line"><span class="keyword">final</span> GenericsClass&lt;String&gt; genericsClass = <span class="keyword">new</span> <span class="title class_">GenericsClass</span>&lt;&gt;(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼è¿”å›çš„å°±æ˜¯å£°æ˜çš„ç±»å‹</span></span><br><span class="line"><span class="comment">// key = â€å¼ ä¸‰â€œ</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> genericsClass.getKey();</span><br></pre></td></tr></table></figure><p><strong>ä¸æŒ‡æ˜æ³›å‹åˆ™æ²¡æœ‰é™å®š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">GenericsClass</span> <span class="variable">genericsClass1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsClass</span>&lt;&gt;(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">GenericsClass</span> <span class="variable">genericsClass2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsClass</span>&lt;&gt;(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// key1 æ˜¯ String</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">key1</span> <span class="operator">=</span> genericsClass1.getKey();</span><br><span class="line"><span class="comment">// key2 æ˜¯ Integer</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">key2</span> <span class="operator">=</span> genericsClass2.getKey();</span><br></pre></td></tr></table></figure><p><strong>æ³›å‹ä¸èƒ½ä½¿ç”¨ instanceof æ“ä½œ</strong></p><p>ç¼–è¯‘é”™è¯¯ Expression expected</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span> &#123; </span><br><span class="line">    <span class="comment">// ä¸èƒ½ä½¿ç”¨ instanceof æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (T <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ³›å‹æ¥å£"><a href="#æ³›å‹æ¥å£" class="headerlink" title="æ³›å‹æ¥å£"></a>æ³›å‹æ¥å£</h2><p>æ³›å‹æ¥å£ä¸æ³›å‹ç±»çš„å®šä¹‰åŠä½¿ç”¨åŸºæœ¬ç›¸åŒã€‚æ³›å‹æ¥å£å¸¸è¢«ç”¨åœ¨å„ç§ç±»çš„ç”Ÿäº§å™¨ä¸­</p><p><strong>ç®€å•çš„æ³›å‹æ¥å£</strong></p><p>æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GenericsIntf</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ç±»ï¼Œæœªå£°æ˜æ³›å‹å®å‚ï¼Œä¾èµ–åˆ›å»ºå¯¹è±¡æ—¶å£°æ˜çš„æ³›å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœªä¼ å…¥æ³›å‹å®å‚æ—¶ï¼Œä¸æ³›å‹ç±»çš„å®šä¹‰ç›¸åŒï¼Œåœ¨å£°æ˜ç±»çš„æ—¶å€™ï¼Œéœ€å°†æ³›å‹çš„å£°æ˜ä¹Ÿä¸€èµ·åŠ åˆ°ç±»ä¸­</span></span><br><span class="line"><span class="comment"> * å³ï¼šclass GenericsIntfImpl&lt;T&gt; implements GenericsIntf&lt;T&gt;&#123;</span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸å£°æ˜æ³›å‹ï¼Œå¦‚ï¼šclass GenericsIntfImpl implements GenericsIntf&lt;T&gt;ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼š&quot;Unknown class&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsIntfImpl</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">GenericsIntf</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T t;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GenericsIntfImpl</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.t = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> GenericsIntfImpl&lt;String&gt; impl = <span class="keyword">new</span> <span class="title class_">GenericsIntfImpl</span>&lt;String&gt;(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> impl.get();</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åœ¨å®ç°ç±»ä¸­å‘æ³›å‹æ¥å£å£°æ˜å›ºå®šçš„æ³›å‹å®å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ å…¥æ³›å‹å®å‚æ—¶ï¼š</span></span><br><span class="line"><span class="comment"> * å®šä¹‰ä¸€ä¸ªç”Ÿäº§å™¨å®ç°è¿™ä¸ªæ¥å£,è™½ç„¶æˆ‘ä»¬åªåˆ›å»ºäº†ä¸€ä¸ªæ³›å‹æ¥å£ GenericsIntf&lt;T&gt;</span></span><br><span class="line"><span class="comment"> * ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¸ºTä¼ å…¥æ— æ•°ä¸ªå®å‚ï¼Œå½¢æˆæ— æ•°ç§ç±»å‹çš„ GenericsIntf æ¥å£ã€‚</span></span><br><span class="line"><span class="comment"> * åœ¨å®ç°ç±»å®ç°æ³›å‹æ¥å£æ—¶ï¼Œå¦‚å·²å°†æ³›å‹ç±»å‹ä¼ å…¥å®å‚ç±»å‹ï¼Œåˆ™æ‰€æœ‰ä½¿ç”¨æ³›å‹çš„åœ°æ–¹éƒ½è¦æ›¿æ¢æˆä¼ å…¥çš„å®å‚ç±»å‹</span></span><br><span class="line"><span class="comment"> * å³ï¼šGenericsIntf&lt;T&gt;ï¼Œpublic T get();ä¸­çš„çš„Téƒ½è¦æ›¿æ¢æˆä¼ å…¥çš„ String ç±»å‹ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsIntfImpl2</span> <span class="keyword">implements</span> <span class="title class_">GenericsIntf</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">GenericsIntfImpl2</span> <span class="variable">impl2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsIntfImpl2</span>();</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> impl2.get();</span><br><span class="line">Assert.assertEquals(s, <span class="string">&quot;Hello World&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="æ³›å‹æ–¹æ³•"><a href="#æ³›å‹æ–¹æ³•" class="headerlink" title="æ³›å‹æ–¹æ³•"></a>æ³›å‹æ–¹æ³•</h2><p>æ³›å‹ç±»ï¼Œæ˜¯åœ¨å®ä¾‹åŒ–ç±»çš„æ—¶å€™æŒ‡æ˜æ³›å‹çš„å…·ä½“ç±»å‹</p><p><strong>è€Œæ³›å‹æ–¹æ³•ï¼Œæ˜¯åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™æŒ‡æ˜æ³›å‹çš„å…·ä½“ç±»å‹</strong> </p><h3 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h3><p>æ³›å‹æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsMethod</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³›å‹æ–¹æ³•çš„åŸºæœ¬ä»‹ç»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tClass ä¼ å…¥çš„æ³›å‹å®å‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> T è¿”å›å€¼ä¸ºTç±»å‹</span></span><br><span class="line"><span class="comment">     * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">     * 1ï¼‰public ä¸ è¿”å›å€¼ä¸­é—´&lt;T&gt;éå¸¸é‡è¦ï¼Œå¯ä»¥ç†è§£ä¸ºå£°æ˜æ­¤æ–¹æ³•ä¸ºæ³›å‹æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     * 2ï¼‰åªæœ‰å£°æ˜äº†&lt;T&gt;çš„æ–¹æ³•æ‰æ˜¯æ³›å‹æ–¹æ³•ï¼Œæ³›å‹ç±»ä¸­çš„ä½¿ç”¨äº†æ³›å‹çš„æˆå‘˜æ–¹æ³•å¹¶ä¸æ˜¯æ³›å‹æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     * 3ï¼‰&lt;T&gt;è¡¨æ˜è¯¥æ–¹æ³•å°†ä½¿ç”¨æ³›å‹ç±»å‹Tï¼Œæ­¤æ—¶æ‰å¯ä»¥åœ¨æ–¹æ³•ä¸­ä½¿ç”¨æ³›å‹ç±»å‹Tã€‚</span></span><br><span class="line"><span class="comment">     * 4ï¼‰ä¸æ³›å‹ç±»çš„å®šä¹‰ä¸€æ ·ï¼Œæ­¤å¤„Tå¯ä»¥éšä¾¿å†™ä¸ºä»»æ„æ ‡è¯†ï¼Œå¸¸è§çš„å¦‚Tã€Eã€Kã€Vç­‰å½¢å¼çš„å‚æ•°å¸¸ç”¨äºè¡¨ç¤ºæ³›å‹ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">genericsMethod</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; tClass)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">return</span> tClass.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">GenericsMethod</span> <span class="variable">genericsMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsMethod</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸åŒçš„å…¥å‚æœ‰ä¸åŒçš„è¿”å›å€¼</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> genericsMethod.genericsMethod(Student.class);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> genericsMethod.genericsMethod(Dog.class);</span><br></pre></td></tr></table></figure><p>æ³›å‹æ–¹æ³•çš„ç‰¹å¾å¾ˆå®¹æ˜“æ··æ·†ï¼Œå®šä¹‰ä¸€ä¸ªå¤æ‚äº›çš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsComplex</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GenericsComplex</span><span class="params">(<span class="keyword">final</span> T key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * æ­¤å¤„å¹¶ä¸æ˜¯æ³›å‹æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * åªæ˜¯å› ä¸ºè¿”å›å€¼çš„æ³›å‹æ˜¯ç±»ä¸­å·²ç»å£°æ˜è¿‡çš„æ³›å‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è¿™æ‰æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ³›å‹æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     * é¦–å…ˆåœ¨ public ä¸è¿”å›å€¼ä¹‹é—´çš„ &lt;T&gt; å¿…ä¸å¯å°‘ï¼Œè¿™è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œå¹¶ä¸”å£°æ˜äº†ä¸€ä¸ªæ³›å‹ T</span></span><br><span class="line"><span class="comment">     * è¿™ä¸ª T å¯ä»¥å‡ºç°åœ¨è¿™ä¸ªæ³›å‹æ–¹æ³•çš„ä»»æ„ä½ç½®.</span></span><br><span class="line"><span class="comment">     * æ³›å‹çš„æ•°é‡ä¹Ÿå¯ä»¥ä¸ºä»»æ„å¤šä¸ª </span></span><br><span class="line"><span class="comment">     * å¦‚ï¼špublic &lt;T,K&gt; K showKeyName(Generic&lt;T&gt; container)&#123;...&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getKeyName</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;T&gt; generics)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;container key :&quot;</span> + generics.getKey());</span><br><span class="line">        <span class="comment">//å½“ç„¶è¿™ä¸ªä¾‹å­ä¸¾çš„ä¸å¤ªåˆé€‚ï¼Œåªæ˜¯ä¸ºäº†è¯´æ˜æ³›å‹æ–¹æ³•çš„ç‰¹æ€§</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">T</span> <span class="variable">test</span> <span class="operator">=</span> generics.getKey();</span><br><span class="line">        <span class="keyword">return</span> test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è¿™ä¸æ˜¯ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * åªæ˜¯ä½¿ç”¨äº† Generic&lt;Number&gt; è¿™ä¸ªæ³›å‹ç±»åšå½¢å‚è€Œå·²</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;Number&gt; obj)</span> &#123;</span><br><span class="line">        System.out.println(obj.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç±»ä¸­æ³›å‹æ–¹æ³•"><a href="#ç±»ä¸­æ³›å‹æ–¹æ³•" class="headerlink" title="ç±»ä¸­æ³›å‹æ–¹æ³•"></a>ç±»ä¸­æ³›å‹æ–¹æ³•</h3><p>å®šä¹‰ä¸€ä¸ªæ³›å‹ç±»ï¼Œå…¶ä¸­åŒ…å«<strong>æ™®é€šæ–¹æ³•ä½¿ç”¨æ³›å‹ç±»å£°æ˜çš„æ³›å‹</strong>å’Œ<strong>æ³›å‹æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsMethod2</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show1</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">        System.out.println(t.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ³›å‹ç±»ä¸­å£°æ˜äº†ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œä½¿ç”¨æ³›å‹Eï¼Œè¿™ç§æ³›å‹Eå¯ä»¥ä¸ºä»»æ„ç±»å‹ã€‚å¯ä»¥ç±»å‹ä¸Tç›¸åŒï¼Œä¹Ÿå¯ä»¥ä¸åŒã€‚</span></span><br><span class="line">    <span class="comment">// ç”±äºæ³›å‹æ–¹æ³•åœ¨å£°æ˜çš„æ—¶å€™ä¼šå£°æ˜æ³›å‹&lt;E&gt;ï¼Œå› æ­¤å³ä½¿åœ¨æ³›å‹ç±»ä¸­å¹¶æœªå£°æ˜æ³›å‹ï¼Œç¼–è¯‘å™¨ä¹Ÿèƒ½å¤Ÿæ­£ç¡®è¯†åˆ«æ³›å‹æ–¹æ³•ä¸­è¯†åˆ«çš„æ³›å‹ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; <span class="keyword">void</span> <span class="title function_">show2</span><span class="params">(<span class="keyword">final</span> E t)</span> &#123;</span><br><span class="line">        System.out.println(t.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ³›å‹ç±»ä¸­å£°æ˜äº†ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œä½¿ç”¨æ³›å‹T</span></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™ä¸ªTæ˜¯ä¸€ç§å…¨æ–°çš„ç±»å‹ï¼Œå¯ä»¥ä¸æ³›å‹ç±»ä¸­å£°æ˜çš„Tä¸æ˜¯åŒä¸€ç§ç±»å‹ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">show3</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">        System.out.println(t.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå£°æ˜æ³›å‹ä¸º String</span></span><br><span class="line"><span class="keyword">final</span> GenericsMethod2&lt;String&gt; method2 = <span class="keyword">new</span> <span class="title class_">GenericsMethod2</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// show1() ä¸æ˜¯æ³›å‹æ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯æ³›å‹ç±»çš„æ³›å‹å£°æ˜ï¼Œæ‰€ä»¥åªèƒ½ä¼  String ç±»å‹çš„å‚æ•°</span></span><br><span class="line">method2.show1(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// show2() æ˜¯æ³›å‹æ–¹æ³•ï¼Œæ³›å‹å’Œç±»ä¸­å£°æ˜çš„æ³›å‹æ— å…³</span></span><br><span class="line">method2.show2(<span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;æ—ºè´¢&quot;</span>, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// show3() ä¹Ÿæ˜¯æ³›å‹æ–¹æ³•ï¼Œè™½ç„¶ä¹Ÿä½¿ç”¨ &lt;T&gt; ä½œä¸ºæ³›å‹å‚æ•°ï¼Œä½†å’Œç±»ä¸­çš„ T æ²¡æœ‰å…³ç³»ï¼Œåªå’Œå‚æ•°çš„ç±»å‹you</span></span><br><span class="line">method2.show3(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;æå››&quot;</span>, <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h3 id="å¯å˜å‚æ•°"><a href="#å¯å˜å‚æ•°" class="headerlink" title="å¯å˜å‚æ•°"></a>å¯å˜å‚æ•°</h3><p>æ³›å‹æ–¹æ³•å¯ä»¥ä½¿ç”¨åœ¨å¯å˜å‚æ•°ä¸Š</p><p>å®šä¹‰æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">printMsg</span><span class="params">(<span class="keyword">final</span> T... args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> T t : args) &#123;</span><br><span class="line">        System.out.print(t + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼ ä¸‰ 200 4 æå›› </span></span><br><span class="line"><span class="built_in">this</span>.printMsg(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">200</span>, <span class="number">4L</span>, <span class="string">&quot;æå››&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="é™æ€æ–¹æ³•"><a href="#é™æ€æ–¹æ³•" class="headerlink" title="é™æ€æ–¹æ³•"></a>é™æ€æ–¹æ³•</h3><p>é™æ€æ–¹æ³•æ— æ³•ç›´æ¥ä½¿ç”¨å®šä¹‰åœ¨ç±»ä¸Šçš„æ³›å‹ï¼Œå› ä¸ºæ³›å‹åœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶ä¼ å…¥ï¼Œé™æ€æ–¹æ³•æ— æ³•è·å–ç±»ä¸Šçš„æ³›å‹ä¿¡æ¯</p><p>æ‰€ä»¥<strong>å¦‚æœé™æ€æ–¹æ³•æƒ³ä½¿ç”¨æ³›å‹ï¼Œå°±å¿…é¡»å®šä¹‰æˆæ³›å‹æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticGenericsMethod</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Animal</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒç†ï¼Œè¿™é‡Œçš„ T åªé’ˆå¯¹è¯¥æ–¹æ³•ï¼Œå’Œç±»ä¸Šçš„ T ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Animal</span>&gt; <span class="keyword">void</span> <span class="title function_">staticShow</span><span class="params">(<span class="keyword">final</span> T obj)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;static&quot;</span>);</span><br><span class="line">        System.out.println(obj.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">(<span class="keyword">final</span> T obj)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">        System.out.println(obj.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;æ—ºè´¢&quot;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°è¦æ±‚ä¼ å…¥ Animal çš„å­ç±»</span></span><br><span class="line">StaticGenericsMethod.staticShow(dog);</span><br><span class="line"><span class="comment">// æˆå‘˜æ–¹æ³•ï¼Œå®ä¾‹å¯¹è±¡æ³›å‹è¦æ±‚ä¼ å…¥ Animal çš„å­ç±»</span></span><br><span class="line"><span class="keyword">final</span> StaticGenericsMethod&lt;Dog&gt; method = <span class="keyword">new</span> <span class="title class_">StaticGenericsMethod</span>&lt;&gt;();</span><br><span class="line">method.show(dog);</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„ï¼Œé™æ€æ³›å‹æ–¹æ³•ä¼šå¯¼è‡´ç±»å‹è½¬æ¢å¼‚å¸¸</strong></p><p>æ­£å¸¸çš„ç±»å‹è½¬æ¢ï¼Œéƒ½ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæç¤ºé”™è¯¯</p><p><code>Inconvertible types; cannot cast &#39;java.lang.Integer&#39; to &#39;java.lang.String&#39;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† Integer ç±»å‹è½¬æ¢ä¸º String ç±»å‹ï¼Œæ˜æ˜¾æ˜¯é”™è¯¯çš„</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)integer;</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªé™æ€æ³›å‹æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">convert</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T)obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ–¹æ³•åå†è¿›è¡Œè½¬æ¢ï¼Œåˆ™åªä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡º <code>java.lang.ClassCastException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">convert</span> <span class="operator">=</span> convert(integer);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)convert;</span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯å› ä¸º Java çš„æ³›å‹æ–¹æ³•å±äºä¼ªæ³›å‹ï¼Œ<strong>åœ¨ç¼–è¯‘çš„æ—¶å€™å°†è¿›è¡Œç±»å‹æ“¦é™¤</strong></p><p>æ™®é€šçš„æ³›å‹æ–¹æ³•åœ¨ç±»æ„å»ºæ—¶å·²ç»æ˜ç¡®åˆ¶å®šäº†å¯¹åº”çš„ç±»å‹ï¼Œè€Œåœ¨é™æ€æ³›å‹æ–¹æ³•ä¸­ï¼Œç±»å‹æ˜¯æ— æ³•ç›´æ¥æ¨æµ‹çš„ï¼Œç¼ºå°‘äº†æ˜ç¡®çš„ç±»å‹ï¼Œæœ€ç»ˆé€ æˆç±»å‹è½¬åŒ–å¼‚å¸¸</p><p>ç¼–è¯‘åçš„ convert æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">String</span>&gt; T <span class="title function_">convert</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T)obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h1><h2 id="æ³›å‹é€šé…ç¬¦"><a href="#æ³›å‹é€šé…ç¬¦" class="headerlink" title="æ³›å‹é€šé…ç¬¦"></a>æ³›å‹é€šé…ç¬¦</h2><p>å­ç±»å’Œçˆ¶ç±»çš„æ³›å‹ä¸èƒ½è¢«è®¤ä¸ºæ˜¯çˆ¶ç±»çš„åŒä¸€ç§æ³›å‹</p><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œå‚æ•°è¦æ±‚ GenericsClass å¯¹è±¡ä¸”æ³›å‹ä¸º Number</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;Number&gt; num)</span> &#123;</span><br><span class="line">    System.out.println(num.getKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªæ³›å‹ä¸º Integer ç±»å‹çš„å¯¹è±¡ï¼Œåˆ™æ— æ³•è°ƒç”¨è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> GenericsClass&lt;Integer&gt; genericsClass = <span class="keyword">new</span> <span class="title class_">GenericsClass</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">// Required type: GenericsClass &lt;Number&gt;</span></span><br><span class="line"><span class="comment">// Provided: GenericsClass &lt;Integer&gt;</span></span><br><span class="line"><span class="built_in">this</span>.get(genericsClass);</span><br></pre></td></tr></table></figure><p>è™½ç„¶ <code>Integer</code> æ˜¯ <code>Number</code> çš„å­ç±»ï¼Œä½†æ˜æ˜¾ <code>GenericsClass &lt;Integer&gt; </code> ä¸èƒ½è¢«çœ‹ä½œ <code>GenericsClass&lt;Number&gt;</code></p><p><strong>åŒä¸€ç§æ³›å‹å¯ä»¥å¯¹åº”å¤šä¸ªç‰ˆæœ¬ï¼ˆå› ä¸ºå‚æ•°ç±»å‹æ˜¯ä¸ç¡®å®šçš„ï¼‰ï¼Œä¸åŒç‰ˆæœ¬çš„æ³›å‹ç±»å®ä¾‹æ˜¯ä¸å…¼å®¹çš„</strong></p><p>å¯ä»¥ä½¿ç”¨æ³›å‹é€šé…ç¬¦ <code>?</code> åŠ <code>extends</code> å’Œ <code>super</code> è§£å†³æ­¤ç±»é—®é¢˜</p><p><strong>æ³¨æ„ï¼š<code>?</code> æ˜¯å®å‚ï¼Œå¹¶ä¸æ˜¯å½¢å‚ï¼Œå®ƒä»£è¡¨æ‰€æœ‰ Object ç±»</strong></p><p>ä¿®æ”¹ä¸Šé¢çš„ä»£ç ï¼Œ<code>GenericsClass&lt;? extends Number&gt;</code> è¡¨ç¤ºå¯¹è±¡çš„æ³›å‹å¯ä»¥æ˜¯ç»§æ‰¿ <code>Number</code> çš„ä»»ä½•ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;? extends Number&gt; num)</span> &#123;</span><br><span class="line">    System.out.println(num.getKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>extends</code> å’Œ <code>super</code> åŒºåˆ«ï¼š</p><ul><li>extends è§„å®šäº†ä¸Šç•Œï¼Œå³è§„å®šäº†æ³›å‹å®å‚çš„<strong>æœ€åº•å±‚çˆ¶ç±»</strong></li><li>super è§„å®šäº†ä¸‹ç•Œï¼Œå³è§„å®šäº†æ³›å‹å®å‚<strong>æœ€ä¸Šå±‚çš„å­ç±»ï¼ˆå®ç°ç±»ï¼‰</strong></li></ul><h1 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h1><h2 id="ParameterizedType"><a href="#ParameterizedType" class="headerlink" title="ParameterizedType"></a>ParameterizedType</h2><p>å½“æ³›å‹ä¸ºç±»ä¸Šæ³›å‹æ—¶ï¼Œé€šè¿‡ Class å¯¹è±¡çš„ <code>getGenericSuperclass</code> æ–¹æ³•å°†ä¼šè·å–åˆ° <code>ParameterizedType</code> çš„ <code>Type</code> æ¥å£å¯¹è±¡ï¼Œå³ä¸ºç±»ä¸Šå®šä¹‰çš„æ³›å‹ä¿¡æ¯</p><p>å¯ä»¥ä½¿ç”¨ <code>getActualTypeArguments</code> è·å–çœŸå®çš„æ³›å‹ç±»å‹å‚æ•°</p><p><strong>å®šä¹‰æ³›å‹ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericClass</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(T obj)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showGenericInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getGenericSuperclass();</span><br><span class="line">        System.out.println(genericSuperclass.getClass());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// real type</span></span><br><span class="line">        <span class="type">Type</span> <span class="variable">type</span> <span class="operator">=</span> ((ParameterizedType)genericSuperclass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">        System.out.println(type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> <span class="keyword">extends</span> <span class="title class_">GenericClass</span>&lt;Student&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Run</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Run</span>();</span><br><span class="line">        run.showGenericInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sun</span>.reflect.generics.reflectiveObjects.ParameterizedTypeImpl</span><br><span class="line">java.util.List&lt;generic.Student&gt;</span><br></pre></td></tr></table></figure><p>ä» <code>getGenericSuperclass</code> è·å–åˆ°çš„å¯¹è±¡æ˜¯ <code>ParameterizedTypeImpl</code>ï¼Œå³ <code>ParameterizedType</code> çš„å®ç°ç±»</p><p>ä»ä¸­è¿˜å¯ä»¥è·å–åˆ°çœŸå®çš„æ³›å‹ä¿¡æ¯ <code>Student</code></p><p>å¦‚æœæ˜¯ä¸€ä¸ªåµŒå¥—çš„æ³›å‹ç»“æ„å‘¢</p><p>ä¿®æ”¹ä¸‹ <code>showGenericInfo</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showGenericInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Type</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getGenericSuperclass();</span><br><span class="line">    System.out.println(genericSuperclass.getClass());</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">    <span class="comment">// real type</span></span><br><span class="line">    <span class="keyword">while</span> (genericSuperclass <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">actualTypeArgument</span> <span class="operator">=</span> ((ParameterizedType)genericSuperclass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">        System.out.println(actualTypeArgument);</span><br><span class="line">        genericSuperclass = actualTypeArgument;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> <span class="keyword">extends</span> <span class="title class_">GenericClass</span>&lt;List&lt;Student&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Run</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Run</span>();</span><br><span class="line">        run.showGenericInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sun</span>.reflect.generics.reflectiveObjects.ParameterizedTypeImpl</span><br><span class="line">--------------------------</span><br><span class="line">java.util.List&lt;generic.Student&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">generic</span>.Student</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ³›å‹ <code>List&lt;Student&gt;</code>ï¼Œç¬¬ä¸€æ¬¡è·å–åˆ°çš„ <code>ParameterizedType</code> æ˜¯ <code>List</code> ä¿¡æ¯ï¼Œå®ƒä¾ç„¶æ˜¯ä¸€ä¸ª <code>ParameterizedType</code> å¯¹è±¡ï¼Œè€Œåè¿˜å¯ä»¥è·å–åˆ°ä¸‹é¢å®šä¹‰çš„ <code>Student</code></p><h2 id="getGenericInterfaces"><a href="#getGenericInterfaces" class="headerlink" title="getGenericInterfaces"></a>getGenericInterfaces</h2><p>æ³›å‹æ¥å£åŒç†ï¼Œä¸è¿‡éœ€è¦é€šè¿‡ <code>getGenericInterfaces</code> æ–¹æ³•è¿›è¡Œè·å–</p><p><code>public Type[] getGenericInterfaces()</code> å› ä¸ºæ¥å£æ˜¯ä¸€å¯¹å¤šï¼Œæ‰€ä»¥è¿™é‡Œè·å–åˆ°çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿæ˜¯ <code>ParameterizedType</code></p><p><strong>å®šä¹‰æ³›å‹æ¥å£</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GenericInterface</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">showGenericInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getGenericInterfaces()[<span class="number">0</span>];</span><br><span class="line">        System.out.println(genericSuperclass.getClass());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="comment">// real type</span></span><br><span class="line">        <span class="keyword">while</span> (genericSuperclass <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            <span class="type">Type</span> <span class="variable">actualTypeArgument</span> <span class="operator">=</span> ((ParameterizedType)genericSuperclass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">            System.out.println(actualTypeArgument);</span><br><span class="line">            genericSuperclass = actualTypeArgument;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> <span class="keyword">implements</span> <span class="title class_">GenericInterface</span>&lt;List&lt;Student&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Run</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Run</span>();</span><br><span class="line">        run.showGenericInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sun</span>.reflect.generics.reflectiveObjects.ParameterizedTypeImpl</span><br><span class="line">--------------------------</span><br><span class="line">java.util.List&lt;generic.Student&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">generic</span>.Student</span><br></pre></td></tr></table></figure><h2 id="TypeVariable"><a href="#TypeVariable" class="headerlink" title="TypeVariable"></a>TypeVariable</h2><p>å½“ä½¿ç”¨æ³›å‹æ–¹æ³•æ—¶ï¼Œå…¶å‚æ•°æˆ–è€…è¿”å›å€¼æ‹¿åˆ°çš„æ³›å‹ä¿¡æ¯ä¸º <code>TypeVariable</code></p><p>è¿™æ—¶åªèƒ½æ‹¿åˆ°æ³›å‹å®šä¹‰æ—¶çš„è¾¹ç•Œä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰è¾¹ç•Œä¿¡æ¯åˆ™ä¼šæ“¦é™¤ä¸º <code>Object</code></p><p><strong>å®šä¹‰æ³›å‹æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericMethod</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(T obj)</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getMethods()[<span class="number">0</span>];</span><br><span class="line">        <span class="type">Type</span> <span class="variable">genericParameterType</span> <span class="operator">=</span> method.getGenericParameterTypes()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">TypeVariable</span> <span class="variable">typeVariable</span> <span class="operator">=</span> (TypeVariable)genericParameterType;</span><br><span class="line">        System.out.println(typeVariable.getName());</span><br><span class="line">        System.out.println(Arrays.toString(typeVariable.getBounds()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è°ƒç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericMethod</span> <span class="variable">genericMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericMethod</span>();</span><br><span class="line">        genericMethod.method(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Student&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">T</span><br><span class="line">[<span class="keyword">class</span> <span class="title class_">java</span>.lang.Object]</span><br></pre></td></tr></table></figure><p>å¦‚æœè§„å®šäº†è¾¹ç•Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">String</span>&gt; <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(T obj)</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">T</span><br><span class="line">[<span class="keyword">class</span> <span class="title class_">java</span>.lang.String]</span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><p>å¾ˆå¤š JSON å·¥å…·éƒ½å®šä¹‰äº†ç±»ä¼¼åä¸º <code>TypeReference</code> çš„ç±»ï¼Œå…¶ä½œç”¨å°±æ˜¯é€šè¿‡æ³›å‹ç±»æ¥ä¼ é€’éœ€è¦ååºåˆ—åŒ–çš„æ³›å‹ä¿¡æ¯ï¼Œé¿å…æ³›å‹æ“¦é™¤</p><p>å¦‚ fastjson ä¸­çš„å®šä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypeReference</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">static</span> ConcurrentMap&lt;Type, Type&gt; classTypeCache</span><br><span class="line">            = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;Type, Type&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Type type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new type literal. Derives represented class from type</span></span><br><span class="line"><span class="comment">     * parameter.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Clients create an empty anonymous subclass. Doing so embeds the type</span></span><br><span class="line"><span class="comment">     * parameter in the anonymous class&#x27;s type hierarchy so we can reconstitute it</span></span><br><span class="line"><span class="comment">     * at runtime despite erasure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">TypeReference</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">superClass</span> <span class="operator">=</span> getClass().getGenericSuperclass();</span><br><span class="line"></span><br><span class="line">        <span class="type">Type</span> <span class="variable">type</span> <span class="operator">=</span> ((ParameterizedType) superClass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">Type</span> <span class="variable">cachedType</span> <span class="operator">=</span> classTypeCache.get(type);</span><br><span class="line">        <span class="keyword">if</span> (cachedType == <span class="literal">null</span>) &#123;</span><br><span class="line">            classTypeCache.putIfAbsent(type, type);</span><br><span class="line">            cachedType = classTypeCache.get(type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.type = cachedType;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>TypeReference</code> å¯¹è±¡ä¿å­˜éœ€è¦ååºåˆ—åŒ–çš„æ³›å‹ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;æå››&quot;</span>, <span class="number">21</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSON.toJSONString(Arrays.asList(student1, student2));</span><br><span class="line"></span><br><span class="line">        List&lt;Student&gt; list = JSON.parseObject(jsonStr, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;Student&gt;&gt;() &#123;&#125;);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Student(name=å¼ ä¸‰, age=<span class="number">20</span>), Student(name=æå››, age=<span class="number">21</span>)]</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://blog.csdn.net/s10461/article/details/53941091">java æ³›å‹è¯¦è§£-ç»å¯¹æ˜¯å¯¹æ³›å‹æ–¹æ³•è®²è§£æœ€è¯¦ç»†çš„ï¼Œæ²¡æœ‰ä¹‹ä¸€_VieLeiçš„åšå®¢-CSDNåšå®¢_javaæ³›å‹</a></p><p><a href="https://zhuanlan.zhihu.com/p/262271430">Javaæ³›å‹ | Jackson TypeReferenceè·å–æ³›å‹ç±»å‹ä¿¡æ¯ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çŠ¶æ€æ¨¡å¼ - State</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F%20-%20State.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F%20-%20State.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>çŠ¶æ€æ¨¡å¼åŸºäº<strong>æœ‰é™çŠ¶æ€æœº</strong>ï¼ˆFSM finite state machineï¼‰çš„æ¦‚å¿µï¼Œä¸»è¦æ€æƒ³æ˜¯ç¨‹åºåœ¨ä»»æ„æ—¶åˆ»ä¸€å®šå¤„äº N ç§æœ‰é™æ•°é‡çš„çŠ¶æ€ä¸­ï¼Œå¹¶ä¸”åœ¨ç‰¹å®šçŠ¶æ€ä¸­æ‰§è¡Œç‰¹å®šçŠ¶æ€çš„æ“ä½œå¹¶å¯ä»¥æµè½¬è‡³ä¸‹ä¸€çŠ¶æ€ï¼ˆä¹Ÿå¯ä¸å˜ï¼‰</p><p>è¿™äº›æ•°é‡æœ‰é™ä¸”é¢„å…ˆå®šä¹‰çš„çŠ¶æ€åˆ‡æ¢è§„åˆ™è¢«ç§°ä¸º <em>çŠ¶æ€æµè½¬</em></p><p><strong>ç›®çš„</strong><br>å°†çŠ¶æ€ä»¥åŠçŠ¶æ€è¡Œä¸ºç­‰å±æ€§å’Œä¸šåŠ¡å¯¹è±¡è§£è€¦ï¼Œæ˜¯ä¸€ç§åŸºäºç»„åˆæ¨¡å¼è¿›è¡Œé€»è¾‘å§”æ‰˜çš„è¡Œä¸ºæ¨¡å¼</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong><br>åœ°é“ç”µåŠ¨é—¸é—¨ä¼šæ ¹æ®å½“å‰çŠ¶æ€å’Œç”¨æˆ·è¡Œä¸ºè¿›è¡Œä¸åŒçš„æ“ä½œå¹¶ä¸”æµè½¬ä¸ºä¸‹ä¸€çŠ¶æ€ï¼š</p><ul><li>å…³é—­çŠ¶æ€<ul><li>ç”¨æˆ·åˆ·å¡æˆåŠŸ -&gt; å¼€é—¨ &amp; æµè½¬è‡³å¼€å¯çŠ¶æ€</li><li>ç”¨æˆ·åˆ·å¡å¤±è´¥ -&gt; æç¤ºåˆ·å¡å¤±è´¥</li></ul></li><li>å¼€å¯çŠ¶æ€<ul><li>ç”¨æˆ·åˆ·å¡ -&gt; æç¤ºåˆ·å¡æ— æ•ˆ</li><li>ç­‰å¾… -&gt; æµè½¬è‡³å¼€å¯å…³é—­çŠ¶æ€</li></ul></li></ul><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œéœ€è¦å¯¹å®¡æ‰¹å·¥å•è¿›è¡Œç›¸åº”æ“ä½œ</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä¸€å¼€å§‹å¯¹äºå·¥å•å®¡æ‰¹çš„çŠ¶æ€å®šä¹‰æ¯”è¾ƒç®€å•</p><ol><li>ç”¨æˆ·å¡«å†™å·¥å•ï¼ŒçŠ¶æ€åˆå§‹ä¸º [è‰ç¨¿]</li><li>ç”¨æˆ·æäº¤å·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [å¾…å®¡æ ¸]ï¼Œå‘ç®¡ç†å‘˜å‘é€é‚®ä»¶é€šçŸ¥</li><li>ç®¡ç†å‘˜å®¡æ ¸å·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [é€šè¿‡]ï¼Œå‘ç”¨æˆ·å‘é€é‚®ä»¶é€šçŸ¥</li><li>ç®¡ç†å‘˜é©³å›å·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [é©³å›]ï¼Œå‘ç”¨æˆ·å‘é€é‚®ä»¶é€šçŸ¥</li><li>[é©³å›] çš„å·¥å•ç”¨æˆ·å¯ä»¥å†æ¬¡æäº¤ï¼Œè¿›å…¥ [å¾…å®¡æ ¸]ï¼Œå‘ç®¡ç†å‘˜å‘é€é‚®ä»¶é€šçŸ¥</li><li>ç”¨æˆ·æ‰§è¡Œå·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [å·²æ‰§è¡Œ]</li></ol><p>åç»­éšç€å¯¹äºå·¥å•å®¡æ ¸æµç¨‹çš„è¿­ä»£ï¼Œéœ€è¦å®šä¹‰æ›´å¤šçš„çŠ¶æ€ä»¥åŠè¡Œä¸º</p><p>ä¾‹å¦‚éœ€è¦å°†å·¥å•çŠ¶æ€çš„ [å·²æ‰§è¡Œ] æ‹†åˆ†ä¸º [æ‰§è¡ŒæˆåŠŸ] å’Œ [æ‰§è¡Œå¤±è´¥]ï¼Œæ‰§è¡Œå¤±è´¥ä¼šå‘ç”¨æˆ·å’Œç®¡ç†å‘˜å‘é€æ‰§è¡Œå¤±è´¥çš„ç»“æœé‚®ä»¶é€šçŸ¥ï¼Œå¹¶ä¸”å¤±è´¥çš„å·¥å•å¯ä»¥è¿›è¡Œå†æ¬¡æ‰§è¡Œ</p><p>æ•´ä¸ªçŠ¶æ€çš„æµè½¬è§„åˆ™åœ¨æ ¸å¿ƒä¸šåŠ¡ä»£ç ä¸­å¾€å¾€ä½¿ç”¨ <code>if...else</code> è¯­å¥å®ç°ï¼Œå†åŠ ä¸Šè¿­ä»£è¶Šæ¥è¶Šå¤šçš„çŠ¶æ€ä»¥åŠè¡Œä¸ºï¼Œä¼šå¯¼è‡´åˆ¤æ–­è¯­å¥æ„ˆå‘è‡ƒè‚¿</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>é¦–å…ˆå¯ä»¥å®šä¹‰å‡ºä¸€ä¸ªè¡Œä¸ºç›®å½•ï¼š</p><ul><li>æäº¤</li><li>é€šè¿‡</li><li>é©³å›</li><li>æ‰§è¡Œ</li></ul><p>æ¥ä¸‹æ¥ç»“åˆè¡Œä¸ºå’ŒçŠ¶æ€å°±å¯ä»¥å®šä¹‰å‡ºå¦‚ä¸‹çš„çŠ¶æ€è¡¨</p><table><thead><tr><th align="center">å½“å‰çŠ¶æ€ | æµè½¬çŠ¶æ€</th><th align="center">è‰ç¨¿</th><th align="center">å¾…å®¡æ ¸</th><th align="center">é©³å›</th><th align="center">é€šè¿‡</th><th align="center">å·²æ‰§è¡Œ</th></tr></thead><tbody><tr><td align="center"><strong>è‰ç¨¿</strong></td><td align="center">&#x2F;</td><td align="center">æäº¤</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td></tr><tr><td align="center"><strong>å¾…å®¡æ ¸</strong></td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">é©³å›</td><td align="center">å®¡æ ¸</td><td align="center">&#x2F;</td></tr><tr><td align="center"><strong>é©³å›</strong></td><td align="center">&#x2F;</td><td align="center">æäº¤</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td></tr><tr><td align="center"><strong>é€šè¿‡</strong></td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">æ‰§è¡Œ</td></tr><tr><td align="center"><strong>å·²æ‰§è¡Œ</strong></td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td><td align="center">&#x2F;</td></tr></tbody></table><h3 id="çŠ¶æ€æšä¸¾"><a href="#çŠ¶æ€æšä¸¾" class="headerlink" title="çŠ¶æ€æšä¸¾"></a>çŠ¶æ€æšä¸¾</h3><p>å®šä¹‰å‡ºå·¥å•çš„å„ç§çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">WorkOrderState</span> &#123;</span><br><span class="line"></span><br><span class="line">    DRAFT(<span class="number">0</span>, <span class="string">&quot;è‰ç¨¿&quot;</span>),</span><br><span class="line">    WAIT_REVIEW(<span class="number">0</span>, <span class="string">&quot;å¾…å®¡æ ¸&quot;</span>),</span><br><span class="line">    REVIEWED(<span class="number">0</span>, <span class="string">&quot;é€šè¿‡&quot;</span>),</span><br><span class="line">    REJECTED(<span class="number">0</span>, <span class="string">&quot;é©³å›&quot;</span>),</span><br><span class="line">    DONE(<span class="number">0</span>, <span class="string">&quot;å·²æ‰§è¡Œ&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    WorkOrderState(<span class="keyword">final</span> <span class="type">int</span> code, <span class="keyword">final</span> String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å·¥å•ä¸šåŠ¡å®ä½“"><a href="#å·¥å•ä¸šåŠ¡å®ä½“" class="headerlink" title="å·¥å•ä¸šåŠ¡å®ä½“"></a>å·¥å•ä¸šåŠ¡å®ä½“</h3><p>å·¥å•ä¿¡æ¯çš„ä¸šåŠ¡å®ä½“ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkOrder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String optionContent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WorkOrderState state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æŠ½è±¡çŠ¶æ€å¤„ç†å™¨"><a href="#æŠ½è±¡çŠ¶æ€å¤„ç†å™¨" class="headerlink" title="æŠ½è±¡çŠ¶æ€å¤„ç†å™¨"></a>æŠ½è±¡çŠ¶æ€å¤„ç†å™¨</h3><p>æŠ½è±¡çš„çŠ¶æ€å¤„ç†å™¨ï¼Œé»˜è®¤å®ç°ä¸ºä¸æ”¯æŒç›¸åº”æ“ä½œï¼ŒæŠ›å‡º <code>IllegalStateException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;submit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">pass</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;pass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;reject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">IllegalState</span><span class="params">(WorkOrder workOrder, String option)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String</span><br><span class="line">            .format(<span class="string">&quot;ä¸æ”¯æŒçš„æ“ä½œ ID:[%s] å½“å‰çŠ¶æ€:[%s] æ“ä½œ:[%s]&quot;</span>, workOrder.getId(), workOrder.getState().getDesc(), option));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="çŠ¶æ€å¤„ç†å™¨å®ç°"><a href="#çŠ¶æ€å¤„ç†å™¨å®ç°" class="headerlink" title="çŠ¶æ€å¤„ç†å™¨å®ç°"></a>çŠ¶æ€å¤„ç†å™¨å®ç°</h3><p>å¯¹æŠ½è±¡å¤„ç†å™¨ç›¸åº”çš„æ–¹æ³•è¿›è¡Œå®ç°</p><p><strong>è‰ç¨¿çŠ¶æ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DraftStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.WAIT_REVIEW.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¾…å®¡æ ¸çŠ¶æ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WaitReviewStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">pass</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.REVIEWED.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç”¨æˆ·å‘é€å®¡æ ¸é€šè¿‡é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.REJECTED.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç”¨æˆ·å‘é€å®¡æ ¸é©³å›é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡çŠ¶æ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReviewedStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out</span><br><span class="line">            .println(String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.DONE.getDesc()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–çš„å®ç°ç±»æ¯”å³å¯</p><h3 id="çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜"><a href="#çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜" class="headerlink" title="çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜"></a>çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜</h3><p>ä¸ºä»€ä¹ˆä¼šæœ‰ â€œçŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜â€ çš„è§’è‰²</p><p>äº‹å®ä¸Šå¦‚æœæ˜¯é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œä¼šæœ‰æ‰€åŒºåˆ«ï¼š</p><ul><li>çŠ¶æ€å’ŒçŠ¶æ€çš„è¡Œä¸ºåº”è¯¥æ˜¯ä¸€ä½“çš„ï¼Œåœ¨æœ¬ä¾‹ä¸­æ‹†åˆ†æˆäº†æšä¸¾ç±»å’ŒçŠ¶æ€å¤„ç†å™¨</li><li>çŠ¶æ€æµè½¬åœ¨æŸäº›ç¨‹åºä¸­åº”è¯¥æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯åœ¨ Web å¼€å‘ä¸­æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥éœ€è¦ç®¡ç†å‘˜çš„è§’è‰²æ ¹æ®å½“å‰ä¸šåŠ¡çŠ¶æ€é€‰æ‹©åˆé€‚çš„å¤„ç†å™¨è¿›è¡Œå¤„ç†</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StateHandlerHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;WorkOrderState, AbstreactStateHandler&gt; HANDLERS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        HANDLERS = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        HANDLERS.put(WorkOrderState.DRAFT, <span class="keyword">new</span> <span class="title class_">DraftStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.WAIT_REVIEW, <span class="keyword">new</span> <span class="title class_">WaitReviewStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.REVIEWED, <span class="keyword">new</span> <span class="title class_">ReviewedStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.REJECTED, <span class="keyword">new</span> <span class="title class_">RejectedStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.DONE, <span class="keyword">new</span> <span class="title class_">DoneStateHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).submit(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pass</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).pass(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).reject(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).run(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WorkOrder</span> <span class="variable">workOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WorkOrder</span>();</span><br><span class="line">        workOrder.setId(<span class="number">1</span>);</span><br><span class="line">        workOrder.setState(WorkOrderState.DRAFT);</span><br><span class="line"></span><br><span class="line">        <span class="type">StateHandlerHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StateHandlerHolder</span>();</span><br><span class="line">        holder.submit(workOrder);</span><br><span class="line"></span><br><span class="line">        workOrder.setState(WorkOrderState.WAIT_REVIEW);</span><br><span class="line">        holder.pass(workOrder);</span><br><span class="line"></span><br><span class="line">        holder.submit(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å·¥å•çŠ¶æ€ [è‰ç¨¿] -&gt; [å¾…å®¡æ ¸]</span><br><span class="line">å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥</span><br><span class="line">    </span><br><span class="line">å·¥å•çŠ¶æ€ [å¾…å®¡æ ¸] -&gt; [é€šè¿‡]</span><br><span class="line">å‘ç”¨æˆ·å‘é€å®¡æ ¸é€šè¿‡é‚®ä»¶é€šçŸ¥</span><br><span class="line">    </span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalStateException: ä¸æ”¯æŒçš„æ“ä½œ ID:[<span class="number">1</span>] å½“å‰çŠ¶æ€:[å¾…å®¡æ ¸] æ“ä½œ:[submit]</span><br></pre></td></tr></table></figure><h3 id="æ‰©å±•æ–°çŠ¶æ€"><a href="#æ‰©å±•æ–°çŠ¶æ€" class="headerlink" title="æ‰©å±•æ–°çŠ¶æ€"></a>æ‰©å±•æ–°çŠ¶æ€</h3><p>å°†å·¥å•çŠ¶æ€çš„ [å·²æ‰§è¡Œ] æ‹†åˆ†ä¸º [æ‰§è¡ŒæˆåŠŸ] å’Œ [æ‰§è¡Œå¤±è´¥]ï¼Œæ‰§è¡Œå¤±è´¥ä¼šå‘ç”¨æˆ·å’Œç®¡ç†å‘˜å‘é€æ‰§è¡Œå¤±è´¥çš„ç»“æœé‚®ä»¶é€šçŸ¥ï¼Œå¹¶ä¸”å¤±è´¥çš„å·¥å•å¯ä»¥è¿›è¡Œå†æ¬¡æ‰§è¡Œ</p><p>å¯ä»¥çœ‹å‡ºæ‰©å±•äº†çŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰æ‰©å±•è¡Œä¸ºï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå®ç°ï¼š</p><ol><li>å¢åŠ æ–°çš„çŠ¶æ€æšä¸¾å¯¹è±¡</li><li>ä¿®æ”¹å·²å®¡æ ¸çŠ¶æ€ä¸‹æ‰§è¡Œæ“ä½œçš„å®ç°</li><li>è¿›è¡Œæ–°çŠ¶æ€å¤„ç†å™¨å®ç°</li><li>æ³¨å†Œè‡³çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜ä¸­</li></ol><p><strong>å·²å®¡æ ¸çŠ¶æ€å¤„ç†å™¨å®ç°ä¿®æ”¹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReviewedStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> RandomUtil.randomInt(<span class="number">0</span>, <span class="number">100</span>) &gt; <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.SUCCESS.getDesc()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.FAILED.getDesc()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ–°çš„çŠ¶æ€å¤„ç†å™¨å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SuccessStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FailedStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(<span class="keyword">final</span> WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.WAIT_REVIEW.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WorkOrder</span> <span class="variable">workOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WorkOrder</span>();</span><br><span class="line">        workOrder.setId(<span class="number">1</span>);</span><br><span class="line">        workOrder.setState(WorkOrderState.FAILED);</span><br><span class="line"></span><br><span class="line">        <span class="type">StateHandlerHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StateHandlerHolder</span>();</span><br><span class="line">        holder.submit(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å·¥å•çŠ¶æ€ [æ‰§è¡Œå¤±è´¥] -&gt; [å¾…å®¡æ ¸]</span><br><span class="line">å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>çŠ¶æ€æ¨¡å¼æ˜¯è¡Œä¸ºæ¨¡å¼çš„ä¸€ç§</p><ul><li><p>ä¼˜ç‚¹</p><ul><li>å¯ä»¥åœ¨ç‹¬ç«‹äºå…¶ä»–çŠ¶æ€çš„æƒ…å†µä¸‹æ·»åŠ æ–°çŠ¶æ€æˆ–ä¿®æ”¹å·²æœ‰çŠ¶æ€ï¼Œ å‡å°‘ç»´æŠ¤æˆæœ¬</li><li>æ¸…ç†æ‰æ ¸å¿ƒä»£ç ä¸­å¤§é‡çš„åˆ†æ”¯åˆ¤æ–­</li><li>çŠ¶æ€å¤„ç†çš„å®ç°å¯ä»¥ç»“æ„åŒ–ï¼Œå¯ä»¥å®ç°æ¨¡æ¿æ–¹æ³•ã€å¤ç”¨å…¬å…±ä»£ç </li></ul></li><li><p>ç¼ºç‚¹</p><ul><li>çŠ¶æ€ä¸å¤æ‚çš„ä¸šåŠ¡æ²¡å¿…è¦è¿‡åº¦è®¾è®¡</li><li>éœ€è¦åœ¨ç­–ç•¥ä¸­å®šä¹‰æ‰€æœ‰è¡Œä¸ºï¼ˆè™½ç„¶å¯ä»¥ä½¿ç”¨åŸºç±»è¿›è¡Œé»˜è®¤å®ç°ï¼‰ï¼Œå³å®šä¹‰å‡ºä¸€ä¸ªè§„åˆ™è¡¨</li></ul></li></ul><p><strong>çŠ¶æ€æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼</strong></p><p>çŠ¶æ€æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼éƒ½åŸºäºç»„åˆæ¥è¿›è¡Œå®ç°ï¼Œéƒ½æ˜¯å§”æ´¾ä¸šåŠ¡é€»è¾‘ç»™å…¶ä»–å®ç°ç±»æ¥è¾¾åˆ°è§£è€¦çš„ç›®çš„</p><p>ç­–ç•¥æ¨¡å¼ä½¿å¾—è¿™äº›å®ç°ç±»å¯¹è±¡ç›¸äº’ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œ å®ƒä»¬ä¸çŸ¥é“å…¶ä»–å¯¹è±¡çš„å­˜åœ¨</p><p>ä½†çŠ¶æ€æ¨¡å¼æ²¡æœ‰é™åˆ¶å…·ä½“çŠ¶æ€ä¹‹é—´çš„ä¾èµ–ï¼Œ ä¸”å…è®¸å®ƒä»¬è‡ªè¡Œæ”¹å˜åœ¨ä¸åŒæƒ…æ™¯ä¸‹çš„çŠ¶æ€</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://refactoringguru.cn/design-patterns/state">çŠ¶æ€è®¾è®¡æ¨¡å¼ (refactoringguru.cn)</a><a href="https://www.kancloud.cn/digest/xing-designpattern/143730">https://www.kancloud.cn/digest/xing-designpattern/143730</a>)</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo éƒ¨ç½² Github Pages 404 é—®é¢˜</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Hexo%20%E9%83%A8%E7%BD%B2%20Github%20Pages%20404%20%E9%97%AE%E9%A2%98.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Hexo%20%E9%83%A8%E7%BD%B2%20Github%20Pages%20404%20%E9%97%AE%E9%A2%98.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>çªç„¶å‘ç° Hexo ä¸­çš„æœ‰äº›æ–‡ç« çªç„¶æ‰“ä¸å¼€äº†</p><p>è¡¨ç°æ˜¯ç‚¹å‡»æ— ååº”ï¼Œæ— è®ºæ˜¯ç‚¹å‡» â€œé˜…è¯»åŸæ–‡â€ è¿˜æ˜¯åœ¨å½’æ¡£ç­‰é¡µé¢ä¸­ç‚¹å‡»æ–‡ç« æ ‡é¢˜éƒ½æ— æ³•æ­£å¸¸æ‰“å¼€</p><p>æŸ¥çœ‹æ§åˆ¶å°å‘ç°å¯¹é¡µé¢çš„è¯·æ±‚ 404 äº†</p><h1 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h1><p><strong>Github çš„ Actions æ­£å¸¸</strong></p><p>ä¹Ÿæ²¡å‡ºç°éƒ¨ç½²å¤±è´¥çš„æƒ…å†µ</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Hexo%20%E9%83%A8%E7%BD%B2%20Github%20Pages%20404%20%E9%97%AE%E9%A2%98/image-20230427231601450.png" class="" title="image-20230427231601450"><p>æŸ¥çœ‹ push ä¸Šæ¥çš„æºæ–‡ä»¶ï¼Œå‘ç°å¯èƒ½æ˜¯å› ä¸ºå¤§å°å†™é—®é¢˜</p><p>æ–‡ä»¶è·¯å¾„ä¸º <code>...bridge</code> ï¼Œè€Œè¯·æ±‚çš„è·¯å¾„ä¸º <code>...Bridge</code>ï¼Œå°è¯•å°†è·¯å¾„æ‰‹åŠ¨ä¿®æ”¹ä¸ºå°å†™ï¼Œå‘ç°æ­£å¸¸è·³è½¬</p><h1 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h1><p>æŸ¥è¯¢äº†ä¸€ä¸‹ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šåŸå› ä¸º git é»˜è®¤å¿½ç•¥å¤§å°å†™</p><ol><li>é¦–å…ˆ push äº†å°å†™æ ‡é¢˜çš„æ–‡ç« </li><li>ä¿®æ”¹äº†æ–‡ç« æ ‡é¢˜ä¸ºå¤§å†™ï¼Œæ­¤æ—¶ Hexo è§£æå…¶ä»–é¡µé¢ä¹Ÿæ›´æ¢äº†å¤§å†™</li><li>ä½†æ˜¯å› ä¸º git å¿½ç•¥å¤§å°å†™ï¼Œæ‰€ä»¥æ›´åä¸ºå¤§å†™çš„å†…å®¹å¹¶æ²¡æœ‰ push åˆ°ä»“åº“ï¼Œå¯¼è‡´è§£æ pages æ—¶æ²¡æœ‰æ›´æ–°ç›¸åº”çš„èµ„æºè·¯å¾„ï¼›æ­¤æ—¶ç‚¹å‡» Hexo ç”Ÿæˆçš„å…¶ä»–é¡µé¢åˆ™èµ„æºåç§°å·²ç»æ›´æ–°ä¸ºå¤§å†™ï¼Œå¯¼è‡´ 404</li></ol><h2 id="ä¿®æ”¹-git-config-æ–‡ä»¶"><a href="#ä¿®æ”¹-git-config-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ git config æ–‡ä»¶"></a>ä¿®æ”¹ git config æ–‡ä»¶</h2><p>åœ¨åšå®¢æ ¹ç›®å½•ä¸‹ç¼–è¾‘ <code>./.git/config</code> æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[core]</span><br><span class="line">repositoryformatversion = 0</span><br><span class="line">filemode = <span class="literal">false</span></span><br><span class="line">bare = <span class="literal">false</span></span><br><span class="line">logallrefupdates = <span class="literal">true</span></span><br><span class="line">symlinks = <span class="literal">false</span></span><br><span class="line">ignorecase = <span class="literal">true</span></span><br><span class="line"><span class="comment"># ignorecase = false</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>ignorecase</code> ä¸º false</p><p>è¿›è¡Œæ¨é€å³å¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é‡æ–° push æ•´ä¸ªé¡¹ç›®</p><h2 id="å…¨éƒ¨é‡æ–°-push"><a href="#å…¨éƒ¨é‡æ–°-push" class="headerlink" title="å…¨éƒ¨é‡æ–° push"></a>å…¨éƒ¨é‡æ–° push</h2><p>åœ¨åšå®¢æ ¹ç›®å½• <code>./.deploy_git</code> ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">rm</span> -rf *</span><br><span class="line">git commit -m <span class="string">&#x27;clean all file&#x27;</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Hexo æ’ä»¶è¿›è¡Œ deploy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">hexo clean</span><br><span class="line">hexo d -g</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://1mhz.me/2015/hexo-deploy-case-sensitive/">Hexo éƒ¨ç½²åˆ° Github Pages æ–‡ä»¶å¤¹å¤§å°å†™é—®é¢˜ &#x2F;&#x2F; Yizhao Heâ€™s Notes (1mhz.me)</a></p><p><a href="https://blog.csdn.net/weixin_43219615/article/details/102536642">åˆ©ç”¨hexoåœ¨GitHubæ­å»ºåšå®¢æ”¹å˜tagå› ä¸ºå¤§å°å†™é—®é¢˜è€Œ404çš„è§£å†³æ–¹æ³•_hexoçš„nextç”¨tagå°±404_è½¨è¿¹ â€â€ â€â€çš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LiteFlow - æ‰§è¡Œå™¨åˆå§‹åŒ–</title>
      <link href="/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow%20-%20%E6%89%A7%E8%A1%8C%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96.html"/>
      <url>/%E5%BC%80%E5%8F%91/LiteFlow/LiteFlow%20-%20%E6%89%A7%E8%A1%8C%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96.html</url>
      
        <content type="html"><![CDATA[<h1 id="è‡ªåŠ¨è£…é…"><a href="#è‡ªåŠ¨è£…é…" class="headerlink" title="è‡ªåŠ¨è£…é…"></a>è‡ªåŠ¨è£…é…</h1><p>åŸºäº SpringBoot çš„å®ç°æ–¹å¼è‡ªç„¶ä½¿ç”¨åˆ°äº† starter æœºåˆ¶ï¼Œæ ¸å¿ƒä»£ç åœ¨ <code>liteflow-spring-boot-starter</code> åŒ…ä¸‹</p><p>é¦–å…ˆæ¥çœ‹ <code>spring.factories</code> æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.yomahub.liteflow.springboot.config.LiteflowPropertyAutoConfiguration,\</span></span><br><span class="line"><span class="string">  com.yomahub.liteflow.springboot.config.LiteflowMainAutoConfiguration</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ä¸¤ä¸ªé‡è¦çš„è‡ªåŠ¨è£…é…çš„é…ç½®ç±»ï¼š</p><ul><li><strong>LiteflowPropertyAutoConfiguration</strong>ï¼šé…ç½®å±æ€§çš„è§£æï¼Œå°è£…ä¸º <code>LiteflowConfig</code> å®ä¾‹</li><li><strong>LiteflowMainAutoConfiguration</strong>ï¼šLiteFlow çš„æ ¸å¿ƒåŠŸèƒ½å¯¹è±¡åœ¨è¯¥é…ç½®ç±»ä¸‹å®ä¾‹åŒ–<ul><li><strong>SpringAware</strong>ï¼šSpring ApplicationContext çš„è·å–ä¸å°è£…ï¼Œä¾¿äºåç»­ä¸šåŠ¡ä¸­è·å– bean çš„æ“ä½œ</li><li><strong>ComponentScanner</strong>ï¼šç»„ä»¶æ‰«æå™¨ï¼Œç”¨äºæ‰«æä¸å°è£… <code>NodeComponent</code> èŠ‚ç‚¹çš„å®ç°ç±»</li><li><strong>FlowExecutor</strong>ï¼šè§„åˆ™æ‰§è¡Œå™¨</li><li><strong>LiteflowExecutorInit</strong>ï¼šè®¾ç½®æœåŠ¡å¯åŠ¨æ—¶åˆå§‹åŒ–é…ç½®ç”Ÿæ•ˆï¼Œç”¨äºå¯åŠ¨æ—¶ä¸»åŠ¨è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li><li><strong>MonitorBus</strong>ï¼šç›‘æ§ç±»å…ƒæ•°æ®</li></ul></li></ul><h2 id="LiteflowPropertyAutoConfiguration"><a href="#LiteflowPropertyAutoConfiguration" class="headerlink" title="LiteflowPropertyAutoConfiguration"></a>LiteflowPropertyAutoConfiguration</h2><p>æ€»çš„æ¥è¯´å°±æ˜¯å¯¹é…ç½®å±æ€§çš„åˆå¹¶å’Œå°è£…ï¼Œå®ä¾‹åŒ– <code>LiteflowConfig</code>ï¼Œä¾¿äºåç»­ä¸šåŠ¡çš„ä½¿ç”¨</p><p>åˆå¹¶äº† <code>liteflow</code> é…ç½®å’Œ <code>liteflow.monitor</code> é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;LiteflowProperty.class, LiteflowMonitorProperty.class&#125;)</span></span><br><span class="line"><span class="meta">@PropertySource(</span></span><br><span class="line"><span class="meta">        name = &quot;Liteflow Default Properties&quot;,</span></span><br><span class="line"><span class="meta">        value = &quot;classpath:/META-INF/liteflow-default.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiteflowPropertyAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LiteflowConfig <span class="title function_">liteflowConfig</span><span class="params">(LiteflowProperty property, LiteflowMonitorProperty liteflowMonitorProperty)</span>&#123;</span><br><span class="line">        <span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LiteflowConfig</span>();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        liteflowConfig.setPrintExecutionLog(property.isPrintExecutionLog());</span><br><span class="line">        liteflowConfig.setSubstituteCmpClass(property.getSubstituteCmpClass());</span><br><span class="line">        <span class="keyword">return</span> liteflowConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾èµ–å‰ç½® <code>LiteflowProperty</code> å’Œ <code>LiteflowMonitorProperty</code> beanï¼Œå³æµç¨‹é…ç½®å‚æ•°å’Œç›‘æ§å™¨çš„é…ç½®å‚æ•°ç±»</p><h2 id="LiteflowMainAutoConfiguration"><a href="#LiteflowMainAutoConfiguration" class="headerlink" title="LiteflowMainAutoConfiguration"></a>LiteflowMainAutoConfiguration</h2><p>é…ç½®æ ¸å¿ƒçš„å„ç§å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123;LiteflowPropertyAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(LiteflowConfig.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;liteflow&quot;, name = &quot;enable&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@Import(SpringAware.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiteflowMainAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹åŒ–ComponentScanner</span></span><br><span class="line">    <span class="comment">//å¤šåŠ ä¸€ä¸ªSpringAwareçš„æ„ä¹‰æ˜¯ï¼Œç¡®ä¿åœ¨æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™ï¼ŒSpringAwareè¿™ä¸ªbeanå·²ç»è¢«åˆå§‹åŒ–</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ComponentScanner <span class="title function_">componentScanner</span><span class="params">(LiteflowConfig liteflowConfig, SpringAware springAware)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComponentScanner</span>(liteflowConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹åŒ–FlowExecutor</span></span><br><span class="line">    <span class="comment">//å¤šåŠ ä¸€ä¸ªSpringAwareçš„æ„ä¹‰æ˜¯ï¼Œç¡®ä¿åœ¨æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™ï¼ŒSpringAwareè¿™ä¸ªbeanå·²ç»è¢«åˆå§‹åŒ–</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FlowExecutor <span class="title function_">flowExecutor</span><span class="params">(LiteflowConfig liteflowConfig, SpringAware springAware)</span> &#123;</span><br><span class="line">        <span class="type">FlowExecutor</span> <span class="variable">flowExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlowExecutor</span>();</span><br><span class="line">        flowExecutor.setLiteflowConfig(liteflowConfig);</span><br><span class="line">        <span class="keyword">return</span> flowExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//FlowExecutorçš„åˆå§‹åŒ–å·¥ä½œï¼Œå’Œå®ä¾‹åŒ–åˆ†å¼€æ¥</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;liteflow&quot;, name = &quot;parse-on-start&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> LiteflowExecutorInit <span class="title function_">liteflowExecutorInit</span><span class="params">(FlowExecutor flowExecutor)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LiteflowExecutorInit</span>(flowExecutor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹åŒ–MonitorBus</span></span><br><span class="line">    <span class="comment">//å¤šåŠ ä¸€ä¸ªSpringAwareçš„æ„ä¹‰æ˜¯ï¼Œç¡®ä¿åœ¨æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™ï¼ŒSpringAwareè¿™ä¸ªbeanå·²ç»è¢«åˆå§‹åŒ–</span></span><br><span class="line">    <span class="meta">@Bean(&quot;monitorBus&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;liteflow&quot;, name = &quot;monitor.enable-log&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> MonitorBus <span class="title function_">monitorBus</span><span class="params">(LiteflowConfig liteflowConfig, SpringAware springAware)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MonitorBus</span>(liteflowConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º bean çš„åŠ è½½é¡ºåºï¼šLiteflowPropertyAutoConfiguration -&gt; LiteflowConfig -&gt; ComponentScanner &amp; FlowExecutor &amp; MonitorBus -&gt; LiteflowExecutorInit</p><p>LiteflowExecutorInit å’Œ MonitorBus ä¾èµ–ä¸åŒçš„é…ç½®æ¡ä»¶ï¼Œå…¶ä¸­ <code>liteflow.parse-on-start</code> é»˜è®¤æ˜¯ trueï¼Œ<code>liteflow.monitor.enable-log</code> é»˜è®¤æ˜¯ false</p><h1 id="ComponentScanner"><a href="#ComponentScanner" class="headerlink" title="ComponentScanner"></a>ComponentScanner</h1><p><code>ComponentScanner</code> åœ¨é¡¹ç›®ä¸­ä¹Ÿè¢«ç¼©å†™ä¸º <code>cmp</code>ï¼Œä¸»è¦æ˜¯ä¾èµ– Spring çš„ <code>BeanPostProcessor</code> æ¥å¯¹ <code>NodeComponent</code> çš„å„ç§å®ç°è¿›è¡Œå‘ç°ã€ä¿å­˜ã€æ‰©å±•ç­‰ä¸€ç³»åˆ—æ“ä½œ</p><h2 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><p>é…ç½®ç±»ä¸­ä½¿ç”¨äº†å…¶æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ComponentScanner</span><span class="params">(LiteflowConfig liteflowConfig)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.liteflowConfig = liteflowConfig;</span><br><span class="line">    <span class="keyword">if</span> (liteflowConfig.getPrintBanner()) &#123;</span><br><span class="line">        <span class="comment">// æ‰“å°liteflowçš„LOGO</span></span><br><span class="line">        LOGOPrinter.print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ä¸­ä¸»è¦è¿›è¡Œäº†ä¸¤ä¸ªæ“ä½œï¼š</p><ol><li><p>å¡«å……å±æ€§ liteflowConfig</p></li><li><p>æ‰“å° LOGOï¼ˆå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ˜¯å¯åŠ¨çš„ç¬¬ä¸€ä¸ª beanï¼‰ï¼›LOGOPrinter å°±æ˜¯ä¸€ä¸ªæ‰“å° LOGO çš„é™æ€æ–¹æ³•å·¥å…·ç±»</p></li></ol><h2 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h2><p>æ—¢ç„¶å®ç°äº† <code>BeanPostProcessor</code> æ¥å£ï¼Œé‚£ä¹ˆé‡ç‚¹å°±éœ€è¦å…³æ³¨å…¶å¯¹äº before å’Œ after é’©å­æ–¹æ³•çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComponentScanner</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>before æ–¹æ³•æ˜¯ä¸€ä¸ªç©ºå®ç°ï¼Œé‡ç‚¹å…³æ³¨ after æ–¹æ³•</p><h3 id="å£°æ˜å¼ç»„ä»¶"><a href="#å£°æ˜å¼ç»„ä»¶" class="headerlink" title="å£°æ˜å¼ç»„ä»¶"></a>å£°æ˜å¼ç»„ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯å£°æ˜å¼ç»„ä»¶</span></span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯ï¼Œå°±ç¼“å­˜åˆ°ç±»å±æ€§çš„mapä¸­</span></span><br><span class="line"><span class="keyword">if</span> (LiteFlowProxyUtil.isDeclareCmp(bean.getClass())) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;proxy component[&#123;&#125;] has been found&quot;</span>, beanName);</span><br><span class="line">    List&lt;NodeComponent&gt; nodeComponents = LiteFlowProxyUtil.proxy2NodeComponent(bean, beanName);</span><br><span class="line">    nodeComponents.forEach(</span><br><span class="line">            nodeComponent -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">nodeId</span> <span class="operator">=</span> nodeComponent.getNodeId();</span><br><span class="line">                nodeId = StrUtil.isEmpty(nodeId) ? beanName : nodeId;</span><br><span class="line">                nodeComponentMap.put(nodeId, nodeComponent);</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// åªæœ‰æ³¨è§£æ”¯æŒå•beanå¤šNode,æ‰€ä»¥ä¸€ä¸ªç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (nodeComponents.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> nodeComponents.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä½•åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªå£°æ˜å¼ç»„ä»¶ï¼Œå®ç°æ–¹æ³•æ˜¯ <code>LiteFlowProxyUtil.isDeclareCmp</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­ä¸€ä¸ªbeanæ˜¯å¦æ˜¯å£°æ˜å¼ç»„ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDeclareCmp</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="comment">// æŸ¥çœ‹beané‡Œçš„methodæ˜¯å¦æœ‰æ–¹æ³•æ ‡è®°äº†@LiteflowMethodæ ‡æ³¨</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„beanæœ‰å¯èƒ½æ˜¯cglibåŠ å¼ºè¿‡çš„classï¼Œæ‰€ä»¥è¦å…ˆè¿›è¡Œä¸ªåˆ¤æ–­</span></span><br><span class="line">    Class&lt;?&gt; targetClass = getUserClass(clazz);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰æ–¹æ³•æ ‡è®°äº†@LiteflowMethodæ ‡æ³¨ï¼Œæœ‰åˆ™ä¸ºå£°æ˜å¼ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.stream(targetClass.getMethods())</span><br><span class="line">        .anyMatch(method -&gt; method.getAnnotation(LiteflowMethod.class) != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è·å–çœŸå®çš„ç”¨æˆ·å®šä¹‰ç±»</li><li>åˆ¤æ–­ç±»ä¸­çš„æ–¹æ³•æ˜¯å¦æ ‡è®°äº† <code>@LiteflowMethod</code></li></ol><h3 id="å®ç°ç±»ç»„ä»¶"><a href="#å®ç°ç±»ç»„ä»¶" class="headerlink" title="å®ç°ç±»ç»„ä»¶"></a>å®ç°ç±»ç»„ä»¶</h3><p>å®ç°ç±»ç»„ä»¶æœ‰ä¸¤ç§ï¼š</p><ul><li>ç»§æ‰¿è‡ª <code>NodeComponent</code> çš„é€»è¾‘ç»„ä»¶</li><li>å®ç°è‡ª <code>ICmpAroundAspect</code> çš„åˆ‡é¢ç»„ä»¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»„ä»¶çš„æ‰«æå‘ç°ï¼Œæ‰«åˆ°ä¹‹åç¼“å­˜åˆ°ç±»å±æ€§mapä¸­</span></span><br><span class="line"><span class="keyword">if</span> (NodeComponent.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;component[&#123;&#125;] has been found&quot;</span>, beanName);</span><br><span class="line">    <span class="type">NodeComponent</span> <span class="variable">nodeComponent</span> <span class="operator">=</span> (NodeComponent) bean;</span><br><span class="line">    nodeComponentMap.put(beanName, nodeComponent);</span><br><span class="line">    <span class="keyword">return</span> nodeComponent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»„ä»¶Aopçš„å®ç°ç±»åŠ è½½</span></span><br><span class="line"><span class="keyword">if</span> (ICmpAroundAspect.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;component aspect implement[&#123;&#125;] has been found&quot;</span>, beanName);</span><br><span class="line">    cmpAroundAspect = (ICmpAroundAspect) bean;</span><br><span class="line">    <span class="keyword">return</span> cmpAroundAspect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰«æç»„ä»¶çš„é€»è¾‘éƒ½æ˜¯è¿™ç±»æ–¹å¼ï¼š</p><ol><li>åˆ¤æ–­æ˜¯å¦æ˜¯å…¶å®ç°</li><li>è½¬å‹</li><li>ä¿å­˜åˆ°å¯¹åº”å¼•ç”¨æˆ–å¯¹è±¡</li></ol><p>å¯ä»¥çœ‹åˆ°å¯¹äºé€»è¾‘ç»„ä»¶ï¼Œæ˜¯ä¸€ä¸ª map ç»“æ„ï¼Œå­˜åœ¨å¤šä¸ªç»„ä»¶ï¼›è€Œå¯¹äºåˆ‡é¢ç»„ä»¶ï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ªï¼ˆäº‹å®ä¸Šè¿™æ®µé€»è¾‘æ²¡æœ‰å¯¹å®ç°è¿›è¡Œåˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæœ‰å¤šä¸ªå®ç°çš„ bean ä¼šè¿›è¡Œè¦†ç›–ï¼Œæµ‹è¯•ä¸­ä¹Ÿå‘ç°æ˜¯è¿™æ ·ï¼‰</p><h3 id="è„šæœ¬ç»„ä»¶"><a href="#è„šæœ¬ç»„ä»¶" class="headerlink" title="è„šæœ¬ç»„ä»¶"></a>è„šæœ¬ç»„ä»¶</h3><p>è„šæœ¬ç»„ä»¶ä¹Ÿæœ‰ä¸¤ç§ï¼š</p><ul><li><code>@ScriptBean</code> ä¿®é¥°çš„è„šæœ¬ bean</li><li><code>@ScriptMethod</code> ä¿®é¥°çš„è„šæœ¬æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰«æ@ScriptBeanä¿®é¥°çš„ç±»</span></span><br><span class="line"><span class="type">ScriptBean</span> <span class="variable">scriptBean</span> <span class="operator">=</span> AnnoUtil.getAnnotation(clazz, ScriptBean.class);</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotNull(scriptBean)) &#123;</span><br><span class="line">    <span class="type">ScriptBeanProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptBeanProxy</span>(bean, clazz, scriptBean);</span><br><span class="line">    ScriptBeanManager.addScriptBean(scriptBean.value(), proxy.getProxyScriptBean());</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰«æ@ScriptMethodä¿®é¥°çš„ç±»</span></span><br><span class="line">List&lt;Method&gt; scriptMethods = Arrays.stream(clazz.getMethods()).filter(method -&gt; &#123;</span><br><span class="line">    <span class="type">ScriptMethod</span> <span class="variable">scriptMethod</span> <span class="operator">=</span> AnnoUtil.getAnnotation(method, ScriptMethod.class);</span><br><span class="line">    <span class="keyword">return</span> ObjectUtil.isNotNull(scriptMethod) &amp;&amp; StrUtil.isNotEmpty(scriptMethod.value());</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br><span class="line"><span class="keyword">if</span> (CollUtil.isNotEmpty(scriptMethods)) &#123;</span><br><span class="line">    Map&lt;String, List&lt;Method&gt;&gt; scriptMethodsGroupByValue = CollStreamUtil.groupBy(scriptMethods, method -&gt; &#123;</span><br><span class="line">        <span class="type">ScriptMethod</span> <span class="variable">scriptMethod</span> <span class="operator">=</span> AnnoUtil.getAnnotation(method, ScriptMethod.class);</span><br><span class="line">        <span class="keyword">return</span> scriptMethod.value();</span><br><span class="line">    &#125;, Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;Method&gt;&gt; entry : scriptMethodsGroupByValue.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        List&lt;Method&gt; methods = entry.getValue();</span><br><span class="line">        <span class="type">ScriptMethodProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptMethodProxy</span>(bean, clazz, methods);</span><br><span class="line"></span><br><span class="line">        ScriptBeanManager.addScriptBean(key, proxy.getProxyScriptMethod());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å°†ä¸åŒçš„è„šæœ¬å½¢å¼åŒ…è£…æˆä»£ç†ç±»ï¼Œè½¬æ¢æˆ bean åæ”¾å…¥ <code>ScriptBeanManager</code> è¿›è¡Œç®¡ç†</p><p>è½¬æ¢çš„æ ¸å¿ƒåœ¨ <code>getProxyScriptMethod</code> æ–¹æ³•ï¼Œè¿™ä¸ªä¼šåœ¨è„šæœ¬ç›¸å…³æºç ä¸­è¿›ä¸€æ­¥åˆ†æ</p><h1 id="FlowExecutor"><a href="#FlowExecutor" class="headerlink" title="FlowExecutor"></a>FlowExecutor</h1><p>æµç¨‹è§„åˆ™ä¸»è¦æ‰§è¡Œå™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè§„åˆ™è¡¨æ‰§è¡Œçš„ä¸»è¦å…¥å£</p><p>è¿™é‡Œä¸»è¦å…³æ³¨å…¶æ„é€ æµç¨‹ï¼Œåˆå§‹åŒ–åœ¨åé¢çš„ <code>LiteflowExecutorInit</code> ä¸­è®²è§£</p><h2 id="æ„é€ æ–¹æ³•-1"><a href="#æ„é€ æ–¹æ³•-1" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FlowExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®FlowExecutorçš„Holderï¼Œè™½ç„¶å¤§éƒ¨åˆ†åœ°æ–¹éƒ½å¯ä»¥é€šè¿‡Springä¸Šä¸‹æ–‡è·å–åˆ°ï¼Œä½†æ”¾å…¥Holderï¼Œè¿˜æ˜¯ä¸ºäº†æŸäº›åœ°æ–¹èƒ½æ–¹ä¾¿çš„å–åˆ°</span></span><br><span class="line">    FlowExecutorHolder.setHolder(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–DataBus</span></span><br><span class="line">    DataBus.init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FlowExecutor</span><span class="params">(LiteflowConfig liteflowConfig)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.liteflowConfig = liteflowConfig;</span><br><span class="line">    <span class="comment">// æŠŠliteFlowConfigè®¾åˆ°LiteFlowGetterä¸­å»</span></span><br><span class="line">    LiteflowConfigGetter.setLiteflowConfig(liteflowConfig);</span><br><span class="line">    <span class="comment">// è®¾ç½®FlowExecutorçš„Holderï¼Œè™½ç„¶å¤§éƒ¨åˆ†åœ°æ–¹éƒ½å¯ä»¥é€šè¿‡Springä¸Šä¸‹æ–‡è·å–åˆ°ï¼Œä½†æ”¾å…¥Holderï¼Œè¿˜æ˜¯ä¸ºäº†æŸäº›åœ°æ–¹èƒ½æ–¹ä¾¿çš„å–åˆ°</span></span><br><span class="line">    FlowExecutorHolder.setHolder(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (BooleanUtil.isTrue(liteflowConfig.isParseOnStart())) &#123;</span><br><span class="line">        <span class="built_in">this</span>.init(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–DataBus</span></span><br><span class="line">    DataBus.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº Spring çš„å¯åŠ¨æ–¹å¼ï¼Œä½¿ç”¨äº†æ— å‚æ„é€ ï¼Œéšåå°† liteflowConfig ç”¨ set æ–¹æ³•è¿›è¡Œèµ‹å€¼ï¼Œå¸¦æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•åº”è¯¥æ˜¯ä¸ºäº†é Spring ç¯å¢ƒå‡†å¤‡çš„ï¼Œå› ä¸ºåœ¨ Spring ç¯å¢ƒä¸­ liteflowConfig ä½¿ç”¨äº† properties çš„æœºåˆ¶ï¼Œè€Œ FlowExecutor é€šè¿‡ <code>@Bean</code> è¿›è¡Œå®ä¾‹åŒ–</p><p>å¯ä»¥çœ‹åˆ°æ— å‚æ„é€ ä¸­ä¸»è¦è¿›è¡Œäº† <code>DataBus.init()</code> æ“ä½œ</p><h2 id="DataBus"><a href="#DataBus" class="headerlink" title="DataBus"></a>DataBus</h2><p>æ•°æ® BUSï¼Œä¸»è¦ç”¨æ¥ç®¡ç† Slotï¼Œç”¨ä»¥åˆ†é…å’Œå›æ”¶</p><p>Slot å³æ•´ä¸ªè§„åˆ™æµç¨‹è°ƒç”¨æ—¶çš„ç®¡ç†è€…ï¼Œä¿å­˜äº†æ•´ä¸ªè§„åˆ™è¿›è¡Œä¸­çš„æ•°æ®ã€ç»„ä»¶æ­¥éª¤ç­‰ä¿¡æ¯ï¼Œæ¯ä¸€æ¬¡è°ƒç”¨ä¼šç”Ÿæˆæ–°çš„ Slotï¼Œå¹¶ä¸”äº’ç›¸éš”ç¦»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer, Slot&gt; SLOTS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentLinkedQueue&lt;Integer&gt; QUEUE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ SLOTS æ²¡æœ‰åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (MapUtil.isEmpty(SLOTS)) &#123;</span><br><span class="line">        <span class="comment">// è·å– liteflowConfigï¼Œåœ¨ Spring ç¯å¢ƒä¸­è¿™é‡Œä¼šä½¿ç”¨å·²ç»æ³¨å…¥çš„ SpringAware ä» ApplicationContext ä¸­è·å–</span></span><br><span class="line">        <span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> LiteflowConfigGetter.get();</span><br><span class="line">        <span class="comment">// ä»é…ç½®ä¸­è·å– slot size å‚æ•°</span></span><br><span class="line">        currentIndexMaxValue = liteflowConfig.getSlotSize();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– SLOTS</span></span><br><span class="line">        SLOTS = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– QUEUE</span></span><br><span class="line">        QUEUE = IntStream.range(<span class="number">0</span>, currentIndexMaxValue)</span><br><span class="line">            .boxed()</span><br><span class="line">            .collect(Collectors.toCollection(ConcurrentLinkedQueue::<span class="keyword">new</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ SLOTS ç”¨æ¥ä¿å­˜åˆ†é…çš„åºå·å’Œ Slot å¯¹è±¡ï¼ŒQUEUE åˆ™æ˜¯ç”¨æ¥ä¿å­˜ index</p><p>å³åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿåˆ†é…çš„è¿è¡Œèµ„æ ¼ç”± QUEUE æ§åˆ¶ï¼ŒQUEUE ä¼šæ ¹æ®å¹¶å‘æƒ…å†µè¿›è¡Œæ‰©å®¹ï¼Œå…·ä½“çš„èµ„æ ¼ç”± 0 ~ n çš„ int å€¼æ¥è¡¨ç¤º</p><h1 id="LiteflowExecutorInit"><a href="#LiteflowExecutorInit" class="headerlink" title="LiteflowExecutorInit"></a>LiteflowExecutorInit</h1><p>æ‰§è¡Œå™¨åˆå§‹åŒ–ç±»ï¼Œä¸»è¦ç”¨äºåœ¨å¯åŠ¨æ—¶æ‰§è¡Œæ‰§è¡Œå™¨çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œé¿å…åœ¨è¿è¡Œæ‰§è¡Œå™¨æ—¶ç¬¬ä¸€æ¬¡åˆå§‹åŒ–è€Œè€—è´¹æ—¶é—´</p><p>è¯¥ç±»å®ä¾‹åŒ–çš„æ„ä¹‰å°±æ˜¯æ§åˆ¶ä¸Šé¢å¯¹è±¡ FlowExecutor çš„åˆå§‹åŒ–æ“ä½œï¼Œå¦‚æœä¸åœ¨é…ç½®ä¸­è®¾ç½®å¯åŠ¨åˆå§‹åŒ–ï¼Œåˆ™ FlowExecutor çš„åˆå§‹åŒ–å·¥ä½œä¼šæ”¾åœ¨è°ƒç”¨æ—¶è¿›è¡Œ <code>@ConditionalOnProperty(prefix = &quot;liteflow&quot;, name = &quot;parse-on-start&quot;, havingValue = &quot;true&quot;)</code></p><h2 id="æ„é€ æ–¹æ³•-2"><a href="#æ„é€ æ–¹æ³•-2" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiteflowExecutorInit</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FlowExecutor flowExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LiteflowExecutorInit</span><span class="params">(FlowExecutor flowExecutor)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.flowExecutor = flowExecutor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">flowExecutor.init(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç±»å®ç°äº† Spring é’©å­ InitializingBeanï¼ŒafterPropertiesSet è¿›è¡Œ <code>FlowExecutor</code> çš„åˆå§‹åŒ–æ“ä½œ</p><h2 id="FlowExecutor-çš„-init"><a href="#FlowExecutor-çš„-init" class="headerlink" title="FlowExecutor çš„ init"></a>FlowExecutor çš„ init</h2><p><code>LiteflowExecutorInit</code> çš„å®ä¾‹åŒ–æ˜¯ä¸ºäº† init <code>FlowExecutor</code>ï¼Œè€Œ <code>FlowExecutor</code> çš„åˆå§‹åŒ–ä¸»è¦ç›®çš„æ˜¯ parse è§„åˆ™æ–‡ä»¶</p><h3 id="ID-ç”Ÿæˆå™¨"><a href="#ID-ç”Ÿæˆå™¨" class="headerlink" title="ID ç”Ÿæˆå™¨"></a>ID ç”Ÿæˆå™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿›è¡Œidç”Ÿæˆå™¨çš„åˆå§‹åŒ–</span></span><br><span class="line">IdGeneratorHolder.init();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å•ä¾‹åˆ›å»º</span></span><br><span class="line">    INSTANCE = <span class="keyword">new</span> <span class="title class_">IdGeneratorHolder</span>();</span><br><span class="line">    <span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> LiteflowConfigGetter.get();</span><br><span class="line">    <span class="comment">// è·å–é…ç½®é¡¹ä¸­çš„ç”Ÿæˆå™¨ç±»è·¯å¾„</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestIdGeneratorClass</span> <span class="operator">=</span> liteflowConfig.getRequestIdGeneratorClass();</span><br><span class="line"></span><br><span class="line">    RequestIdGenerator requestIdGenerator;</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(requestIdGeneratorClass)) &#123;</span><br><span class="line">      <span class="comment">// é»˜è®¤ä¸º DefaultRequestIdGenerator</span></span><br><span class="line">      requestIdGenerator = <span class="keyword">new</span> <span class="title class_">DefaultRequestIdGenerator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å®ä¾‹åŒ–è‡ªå®šä¹‰ç”Ÿæˆå™¨</span></span><br><span class="line">      Class&lt;RequestIdGenerator&gt; idGenerateClass = (Class&lt;RequestIdGenerator&gt;) Class</span><br><span class="line">        .forName(requestIdGeneratorClass);</span><br><span class="line">      <span class="comment">// æ³¨å†Œè¿› bean å®¹å™¨</span></span><br><span class="line">      requestIdGenerator = ContextAwareHolder.loadContextAware().registerBean(idGenerateClass);</span><br><span class="line">    &#125;</span><br><span class="line">    INSTANCE.setRequestIdGenerator(requestIdGenerator);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RequestIdGeneratorException</span>(e.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>IdGeneratorHolder</code> ç”¨äºä¿å­˜å®ä¾‹åŒ–åçš„ ID ç”Ÿæˆå™¨ <code>RequestIdGenerator</code>ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹</p><p>åŸºæœ¬æµç¨‹å°±æ˜¯è·å–é…ç½®é¡¹ä¸Šçš„ç”Ÿæˆå™¨ç±»è·¯å¾„ï¼Œç„¶åé€šè¿‡åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¿å­˜åˆ° <code>IdGeneratorHolder</code> è¿™ä¸ªè§’è‰²ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¿›è¡Œé…ç½®åˆ™ä½¿ç”¨é»˜è®¤å®ç° <code>DefaultRequestIdGenerator</code></p><p><strong>é»˜è®¤å®ç° DefaultRequestIdGenerator</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultRequestIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">RequestIdGenerator</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> IdUtil.fastSimpleUUID();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hutool ä¸‹çš„ç®€å• UUID ç”Ÿæˆ</p><h3 id="è§„åˆ™æ–‡ä»¶æºè·¯å¾„"><a href="#è§„åˆ™æ–‡ä»¶æºè·¯å¾„" class="headerlink" title="è§„åˆ™æ–‡ä»¶æºè·¯å¾„"></a>è§„åˆ™æ–‡ä»¶æºè·¯å¾„</h3><p>åœ¨ä¸Šé¢æµç¨‹ä¸­åŠ è½½äº†é€»è¾‘ç»„ä»¶ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£æè§„åˆ™è¡¨</p><p><strong>è§„åˆ™è·¯å¾„ä¸ºç©º</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">ruleSource</span> <span class="operator">=</span> liteflowConfig.getRuleSource();</span><br><span class="line"><span class="keyword">if</span> (StrUtil.isBlank(ruleSource)) &#123;</span><br><span class="line">   <span class="comment">// æŸ¥çœ‹æœ‰æ²¡æœ‰Parserçš„SPIå®ç°</span></span><br><span class="line">   <span class="comment">// æ‰€æœ‰çš„Parserçš„SPIå®ç°éƒ½æ˜¯ä»¥customå½¢å¼æ”¾å…¥çš„ï¼Œä¸”åªæ”¯æŒxmlå½¢å¼</span></span><br><span class="line">   ServiceLoader&lt;ParserClassNameSpi&gt; loader = ServiceLoader.load(ParserClassNameSpi.class);</span><br><span class="line">   Iterator&lt;ParserClassNameSpi&gt; it = loader.iterator();</span><br><span class="line">   <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">      <span class="type">ParserClassNameSpi</span> <span class="variable">parserClassNameSpi</span> <span class="operator">=</span> it.next();</span><br><span class="line">      ruleSource = <span class="string">&quot;el_xml:&quot;</span> + parserClassNameSpi.getSpiClassName();</span><br><span class="line">      liteflowConfig.setRuleSource(ruleSource);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ruleSourceä¸ºç©ºï¼Œè€Œä¸”æ²¡æœ‰spiå½¢å¼çš„æ‰©å±•ï¼Œé‚£ä¹ˆè¯´æ˜çœŸçš„æ²¡æœ‰ruleSource</span></span><br><span class="line">      <span class="comment">// è¿™ç§æƒ…å†µæœ‰å¯èƒ½æ˜¯åŸºäºä»£ç åŠ¨æ€æ„å»ºçš„</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€å—é€»è¾‘æ˜¯åœ¨åˆ¤æ–­å½“é…ç½®æ–‡ä»¶çš„è§„åˆ™æºè·¯å¾„ä¸ºç©ºçš„æƒ…å†µï¼Œæ­¤æ—¶ä¼šä½¿ç”¨ SPI å·¥å…· <code>ServiceLoader</code> å»åŠ è½½è‡ªå®šä¹‰å®ç°çš„è§„åˆ™åŠ è½½å™¨å»æ”¾ç½®æ–°çš„è§„åˆ™è·¯å¾„</p><p><strong>é¡¹ç›®æ–‡ä»¶å’Œæœ¬åœ°æ–‡ä»¶</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæœ‰å‰ç¼€çš„ï¼Œåˆ™ä¸éœ€è¦å†è¿›è¡Œåˆ†å‰²äº†ï¼Œè¯´æ˜æ˜¯ä¸€ä¸ªæ•´ä½“</span></span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰å‰ç¼€ï¼Œè¯´æ˜æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œå¯èƒ½é…ç½®å¤šä¸ªï¼Œæ‰€ä»¥éœ€è¦åˆ†å‰²</span></span><br><span class="line">List&lt;String&gt; sourceRulePathList;</span><br><span class="line"><span class="keyword">if</span> (ReUtil.contains(PREFIX_FORMAT_CONFIG_REGEX, ruleSource)) &#123;</span><br><span class="line">   sourceRulePathList = ListUtil.toList(ruleSource);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="type">String</span> <span class="variable">afterHandleRuleSource</span> <span class="operator">=</span> ruleSource.replace(StrUtil.SPACE, StrUtil.EMPTY);</span><br><span class="line">   sourceRulePathList = ListUtil.toList(afterHandleRuleSource.split(<span class="string">&quot;,|;&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LiteFlow çš„ç‰¹æ€§å¯ä»¥æ”¯æŒä»æœ¬åœ°æ–‡ä»¶åŠ è½½è§„åˆ™ï¼Œæ‰€ä»¥åœ¨æ­¤å¤„åˆ¤æ–­è§„åˆ™æ˜¯æ¥æºäºé¡¹ç›®æ–‡ä»¶è¿˜æ˜¯æœ¬åœ°æ–‡ä»¶</p><p>æ ¹æ®è§„åˆ™å‰ç¼€ <code>String PREFIX_FORMAT_CONFIG_REGEX = &quot;xml:|json:|yml:|el_xml:|el_json:|el_yml:&quot;</code> çš„æ­£åˆ™æ¥åŒ¹é…ï¼›å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶åˆ™æ ¹æ® <code>,|;</code> æ¥è¿›è¡Œåˆ†å‰²</p><p>å°†è§„åˆ™æ–‡ä»¶çš„è·¯å¾„éƒ½æ”¾ç½®åœ¨ <code>sourceRulePathList</code> è¿™ä¸ªé›†åˆä¸­</p><h3 id="è§„åˆ™æ–‡ä»¶è§£æ"><a href="#è§„åˆ™æ–‡ä»¶è§£æ" class="headerlink" title="è§„åˆ™æ–‡ä»¶è§£æ"></a>è§„åˆ™æ–‡ä»¶è§£æ</h3><p>è·å–è§„åˆ™æºåè¦å¯¹è§„åˆ™æ–‡ä»¶è¿›è¡Œè§£æ</p><h4 id="å¤åˆè§„åˆ™é…ç½®"><a href="#å¤åˆè§„åˆ™é…ç½®" class="headerlink" title="å¤åˆè§„åˆ™é…ç½®"></a>å¤åˆè§„åˆ™é…ç½®</h4><p>è¿™é‡Œåº”è¯¥æ˜¯å®ç°ä¸åŒæ ¼å¼è§„åˆ™åŠ è½½çš„ç‰¹æ€§ï¼Œéœ€è¦è¿›è¡Œç›¸å…³é…ç½® <code>supportMultipleType</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FlowParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">Set&lt;String&gt; parserNameSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; rulePathList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String path : sourceRulePathList) &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æŸ¥æ‰¾å¯¹åº”çš„è§£æå™¨</span></span><br><span class="line">      parser = FlowParserProvider.lookup(path);</span><br><span class="line">      parserNameSet.add(parser.getClass().getName());</span><br><span class="line">      <span class="comment">// æ›¿æ¢æ‰å‰ç¼€æ ‡è¯†ï¼ˆå¦‚ï¼šxml:/json:ï¼‰ï¼Œä¿ç•™å‰©ä¸‹çš„å®Œæ•´åœ°å€</span></span><br><span class="line">      path = ReUtil.replaceAll(path, PREFIX_FORMAT_CONFIG_REGEX, <span class="string">&quot;&quot;</span>);</span><br><span class="line">      rulePathList.add(path);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ”¯æŒå¤šç±»å‹çš„é…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«è§£æ</span></span><br><span class="line">      <span class="keyword">if</span> (BooleanUtil.isTrue(liteflowConfig.isSupportMultipleType())) &#123;</span><br><span class="line">         <span class="comment">// è§£ææ–‡ä»¶</span></span><br><span class="line">         parser.parseMain(ListUtil.toList(path));</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (CyclicDependencyException e) &#123;</span><br><span class="line">      LOG.error(e.getMessage());</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;init flow executor cause error for path &#123;&#125;,reason:&#123;&#125;&quot;</span>, path,</span><br><span class="line">            e.getMessage());</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowExecutorNotInitException</span>(errorMsg);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>éå†è§„åˆ™è·¯å¾„ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„è§£æå™¨</li><li>è®°å½•è§£æå™¨ç±»åï¼ˆä¸»è¦æ˜¯ç”¨äºåç»­éå¤šç±»å‹è§£æå™¨åˆ¤æ–­ä½¿ç”¨ï¼‰</li><li>è·¯å¾„æ”¾å…¥è§„åˆ™è·¯å¾„é›†åˆ</li><li>å¦‚æœæ”¯æŒå¤šç±»å‹é…ç½®æ–‡ä»¶è§£æï¼Œåˆ™ç›´æ¥è¿›è¡Œè§£æ <code>parser.parseMain(ListUtil.toList(path))</code></li><li>catch å¼‚å¸¸ï¼Œæ‰“å°æ—¥å¿—</li></ol><h4 id="å•ç±»å‹é…ç½®"><a href="#å•ç±»å‹é…ç½®" class="headerlink" title="å•ç±»å‹é…ç½®"></a>å•ç±»å‹é…ç½®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•ç±»å‹çš„é…ç½®æ–‡ä»¶ï¼Œéœ€è¦ä¸€èµ·è§£æ</span></span><br><span class="line"><span class="keyword">if</span> (BooleanUtil.isFalse(liteflowConfig.isSupportMultipleType())) &#123;</span><br><span class="line">   <span class="comment">// æ£€æŸ¥Parseræ˜¯å¦åªæœ‰ä¸€ä¸ªï¼Œå› ä¸ºå¤šä¸ªä¸åŒçš„parserä¼šé€ æˆå­æµç¨‹çš„æ··ä¹±</span></span><br><span class="line">   <span class="keyword">if</span> (parserNameSet.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> <span class="string">&quot;cannot have multiple different parsers&quot;</span>;</span><br><span class="line">      LOG.error(errorMsg);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MultipleParsersException</span>(errorMsg);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¿›è¡Œå¤šä¸ªé…ç½®æ–‡ä»¶çš„ä¸€èµ·è§£æ</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (parser != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// è§£ææ–‡ä»¶</span></span><br><span class="line">         parser.parseMain(rulePathList);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConfigErrorException</span>(<span class="string">&quot;parse error, please check liteflow config property&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (CyclicDependencyException e) &#123;</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      LOG.error(e.getMessage());</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ChainDuplicateException e) &#123;</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;init flow executor cause error for path &#123;&#125;,reason: &#123;&#125;&quot;</span>, rulePathList,</span><br><span class="line">            e.getMessage());</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowExecutorNotInitException</span>(errorMsg);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å•ç±»å‹çš„æµç¨‹ä¸»è¦é’ˆå¯¹è§£æå™¨æ•°é‡è¿›è¡Œäº†åˆ¤æ–­ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ <code>parser.parseMain(ListUtil.toList(path))</code> è¿›å…¥è§£ææµç¨‹</p><h4 id="è§£æå™¨"><a href="#è§£æå™¨" class="headerlink" title="è§£æå™¨"></a>è§£æå™¨</h4><p>è¿™é‡Œä¸»è¦å…ˆæ¥çœ‹ <code>LocalXmlFlowELParser</code> çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalXmlFlowELParser</span> <span class="keyword">extends</span> <span class="title class_">XmlFlowELParser</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseMain</span><span class="params">(List&lt;String&gt; pathList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      List&lt;String&gt; contentList = PathContentParserHolder.loadContextAware().parseContent(pathList);</span><br><span class="line">      parse(contentList);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PathContentParserHolder.loadContextAware().parseContent(pathList)</code> çš„æ“ä½œç”¨äºè·å–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå³è§„åˆ™çš„ EL è¡¨è¾¾å¼ç­‰ï¼ˆå°±æ˜¯è¯»æ–‡ä»¶ï¼Œä¸è¿‡ä¼šæ ¹æ®ä¸åŒç¯å¢ƒé€‰æ‹©ä¸åŒçš„å®ç°ï¼‰</p><p>æœ€åæ‰§è¡Œ <code>BaseXmlFlowParser</code> æŠ½è±¡ç±»æä¾›çš„ <code>parse</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(List&lt;String&gt; contentList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   <span class="keyword">if</span> (CollectionUtil.isEmpty(contentList)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   List&lt;Document&gt; documentList = ListUtil.toList();</span><br><span class="line">   <span class="keyword">for</span> (String content : contentList) &#123;</span><br><span class="line">      <span class="comment">// è§£æ XML org.dom4j.DocumentHelperï¼Œè½¬æ¢ä¸º Document å¯¹è±¡</span></span><br><span class="line">      <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> DocumentHelper.parseText(content);</span><br><span class="line">      documentList.add(document);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// è§£æ node</span></span><br><span class="line">   ParserHelper.parseNodeDocument(documentList);</span><br><span class="line">   <span class="comment">// è§£æ chain</span></span><br><span class="line">   ParserHelper.parseChainDocument(documentList, CHAIN_NAME_SET, <span class="built_in">this</span>::parseOneChain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ParserHelper"><a href="#ParserHelper" class="headerlink" title="ParserHelper"></a>ParserHelper</h4><p>ä»¥ <code>XML</code> æ ¼å¼çš„è§„åˆ™è¡¨è¾¾ä¸ºä¾‹</p><p><strong>è§£æ node</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xml å½¢å¼çš„ä¸»è¦è§£æè¿‡ç¨‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> documentList documentList</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parseNodeDocument</span><span class="params">(List&lt;Document&gt; documentList)</span> &#123;</span><br><span class="line">   <span class="keyword">for</span> (Document document : documentList) &#123;</span><br><span class="line">      <span class="comment">// è·å– root æ ‡ç­¾</span></span><br><span class="line">      <span class="type">Element</span> <span class="variable">rootElement</span> <span class="operator">=</span> document.getRootElement();</span><br><span class="line">      <span class="comment">// è·å– nodes æ ‡ç­¾</span></span><br><span class="line">      <span class="type">Element</span> <span class="variable">nodesElement</span> <span class="operator">=</span> rootElement.element(NODES);</span><br><span class="line">      <span class="comment">// å½“å­˜åœ¨&lt;nodes&gt;èŠ‚ç‚¹å®šä¹‰æ—¶ï¼Œè§£ænodeèŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (ObjectUtil.isNotNull(nodesElement)) &#123;</span><br><span class="line">         List&lt;Element&gt; nodeList = nodesElement.elements(NODE);</span><br><span class="line">         String id, name, clazz, type, script, file, language;</span><br><span class="line">         <span class="keyword">for</span> (Element e : nodeList) &#123;</span><br><span class="line">            id = e.attributeValue(ID);</span><br><span class="line">            name = e.attributeValue(NAME);</span><br><span class="line">            clazz = e.attributeValue(_CLASS);</span><br><span class="line">            type = e.attributeValue(TYPE);</span><br><span class="line">            script = e.getText();</span><br><span class="line">            file = e.attributeValue(FILE);</span><br><span class="line">            language = e.attributeValue(LANGUAGE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ„å»º node</span></span><br><span class="line">            <span class="type">NodePropBean</span> <span class="variable">nodePropBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NodePropBean</span>().setId(id)</span><br><span class="line">               .setName(name)</span><br><span class="line">               .setClazz(clazz)</span><br><span class="line">               .setScript(script)</span><br><span class="line">               .setType(type)</span><br><span class="line">               .setFile(file)</span><br><span class="line">               .setLanguage(language);</span><br><span class="line"></span><br><span class="line">            ParserHelper.buildNode(nodePropBean);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ä»é…ç½®çš„ <code>XML</code> è§„åˆ™ä¸­è§£ææ ‡ç­¾</li><li>æ‰¾åˆ° <code>nodes</code> çš„æ ‡ç­¾ï¼›name å¸¸é‡å®šä¹‰åœ¨ <code>ChainConstant.NODES</code></li><li>éå† <code>nodes</code> ä¸‹é¢çš„æ¯ä¸€ä¸ª <code>node</code> æ ‡ç­¾ï¼Œæ„å»º <code>NodePropBean</code> node å¯¹è±¡</li><li><code>ParserHelper.buildNode(nodePropBean)</code> å¼€å§‹è§£æèŠ‚ç‚¹ï¼Œè§£æå®Œæˆåä¼šæ”¾ç½®åœ¨ <code>FlowBus</code> ä¸­ï¼ˆè§£æè¿‡ç¨‹ä¸­è¿˜åœ¨åˆ†è¾¨æ˜¯æ™®é€šèŠ‚ç‚¹è¿˜æ˜¯è„šæœ¬èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ”¾åˆ°è„šæœ¬ç›¸å…³æºç ä¸­å†çœ‹ï¼‰</li></ol><p><strong>è§£æ chain</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parseChainDocument</span><span class="params">(List&lt;Document&gt; documentList, Set&lt;String&gt; chainNameSet,</span></span><br><span class="line"><span class="params">      Consumer&lt;Element&gt; parseOneChainConsumer)</span> &#123;</span><br><span class="line">   <span class="comment">// å…ˆåœ¨å…ƒæ•°æ®é‡Œæ”¾ä¸Šchain</span></span><br><span class="line">   <span class="comment">// å…ˆæ”¾æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå¯ä»¥åœ¨parseçš„æ—¶å€™å…ˆæ˜ å°„åˆ°FlowBusçš„chainMapï¼Œç„¶åå†å»è§£æ</span></span><br><span class="line">   <span class="comment">// è¿™æ ·å°±ä¸ç”¨å»åƒä¹‹å‰çš„ç‰ˆæœ¬é‚£æ ·å›å½’è°ƒç”¨</span></span><br><span class="line">   <span class="comment">// åŒæ—¶ä¹Ÿè§£å†³äº†ä¸èƒ½å¾ªç¯ä¾èµ–çš„é—®é¢˜</span></span><br><span class="line">   documentList.forEach(document -&gt; &#123;</span><br><span class="line">      <span class="comment">// è§£æchainèŠ‚ç‚¹</span></span><br><span class="line">      List&lt;Element&gt; chainList = document.getRootElement().elements(CHAIN);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å…ˆåœ¨å…ƒæ•°æ®é‡Œæ”¾ä¸Šchain</span></span><br><span class="line">      chainList.forEach(e -&gt; &#123;</span><br><span class="line">         <span class="comment">// æ ¡éªŒåŠ è½½çš„ chainName æ˜¯å¦æœ‰é‡å¤çš„</span></span><br><span class="line">         <span class="comment">// TODO è¿™é‡Œæ˜¯å¦æœ‰ä¸ªé—®é¢˜ï¼Œå½“æ··åˆæ ¼å¼åŠ è½½çš„æ—¶å€™ï¼Œ2ä¸ªåŒåçš„Chainåœ¨ä¸åŒçš„æ–‡ä»¶é‡Œï¼Œå°±ä¸è¡Œäº†</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">chainName</span> <span class="operator">=</span> Optional.ofNullable(e.attributeValue(ID)).orElse(e.attributeValue(NAME));</span><br><span class="line">         <span class="keyword">if</span> (!chainNameSet.add(chainName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChainDuplicateException</span>(String.format(<span class="string">&quot;[chain name duplicate] chainName=%s&quot;</span>, chainName));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         FlowBus.addChain(chainName);</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="comment">// æ¸…ç©º</span></span><br><span class="line">   chainNameSet.clear();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è§£ææ¯ä¸€ä¸ªchain</span></span><br><span class="line">   <span class="keyword">for</span> (Document document : documentList) &#123;</span><br><span class="line">      <span class="type">Element</span> <span class="variable">rootElement</span> <span class="operator">=</span> document.getRootElement();</span><br><span class="line">      List&lt;Element&gt; chainList = rootElement.elements(CHAIN);</span><br><span class="line">      chainList.forEach(parseOneChainConsumer);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ä» <code>XML</code> è§„åˆ™ä¸­è§£æ <code>chain</code> æ ‡ç­¾</li><li>éå†æ ‡ç­¾å¤„ç† chain æ•°æ®</li><li>è·å– chainNameï¼Œè§„åˆ™ä¸ºå¦‚æœæ²¡æœ‰é…ç½®ç‹¬ç«‹çš„ id å°±ä½¿ç”¨ name</li><li>åŠ å…¥ chainNameSetï¼Œå¦‚æœ name é‡å¤åˆ™æŠ›å‡ºå¼‚å¸¸ï¼ˆè¿™ç§æ–¹å¼æ— æ³•å¤„ç†å¤šæ–‡ä»¶çš„é‡å¤é—®é¢˜ï¼Œæˆ‘ç†è§£å¸¦æ¥çš„å½±å“å°±æ˜¯ä¼šå¯¼è‡´è§£æçš„ chain è¢«è¦†ç›–ï¼‰</li><li>å…ˆå°† name åŠ å…¥å…ƒæ•°æ®ç®¡ç†ç±» <code>FlowBus</code>ï¼›è¿™ä¸ªæµç¨‹æ˜¯é¢„è£…è½½ï¼Œå…¶å…ƒæ•°æ®ç®¡ç†ä¸­çš„ map value æ˜¯å ä½å¯¹è±¡</li><li>éå† chain æ ‡ç­¾ï¼Œè°ƒç”¨ä¼ å…¥çš„ <code>Consumer</code> æ–¹æ³•å¼€å§‹è§£æï¼›<code>Consumer</code> æ–¹æ³•ä¸º <code>Parser</code> å®ç°çš„ <code>parseOneChain</code> æ–¹æ³•</li></ol><h4 id="EL-è§„åˆ™ç»„è£…å™¨"><a href="#EL-è§„åˆ™ç»„è£…å™¨" class="headerlink" title="EL è§„åˆ™ç»„è£…å™¨"></a>EL è§„åˆ™ç»„è£…å™¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parseOneChainEl</span><span class="params">(JsonNode chainNode)</span> &#123;</span><br><span class="line">   <span class="comment">// æ„å»ºchainBuilder</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">chainId</span> <span class="operator">=</span> Optional.ofNullable(chainNode.get(ID)).orElse(chainNode.get(NAME)).textValue();</span><br><span class="line">   <span class="type">String</span> <span class="variable">el</span> <span class="operator">=</span> chainNode.get(VALUE).textValue();</span><br><span class="line">   <span class="type">LiteFlowChainELBuilder</span> <span class="variable">chainELBuilder</span> <span class="operator">=</span> LiteFlowChainELBuilder.createChain().setChainId(chainId);</span><br><span class="line">   chainELBuilder.setEL(el).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>parseOneChainEl</code> åä¸»è¦æ˜¯è·å– el è§„åˆ™ï¼Œåˆ›å»º <code>LiteFlowChainELBuilder</code> å¯¹è±¡ååœ¨ <code>setEL</code> çš„æ­¥éª¤ä¸­ä¼šè¿›è¡Œ EL è§„åˆ™çš„è§£æï¼Œæœ€ç»ˆè¿”å› <code>List&lt;Condition&gt; conditionList</code></p><p>è§„åˆ™çš„è§£æä½¿ç”¨äº†é˜¿é‡Œå¼€æºçš„ QLExpressï¼Œåé¢ä¼šå•ç‹¬ä¸€ç¯‡æ¥è®²è§£</p><p>åŸºæœ¬ä¸Šåˆ°è¿™é‡Œï¼Œç›¸å…³çš„æ‰§è¡Œç»„ä»¶å°±å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†</p><p>åç»­å…·ä½“çš„æ‰§è¡Œå°±æ˜¯è·å– <code>Chain</code> å¯¹è±¡çš„ <code>conditionList</code>ï¼Œéå† list è¿›è¡Œæ‰§è¡Œ</p><h1 id="MonitorBus"><a href="#MonitorBus" class="headerlink" title="MonitorBus"></a>MonitorBus</h1><p>ç›‘æ§ç±»å…ƒæ•°æ®ï¼Œæ‰“å°æ‰§è¡Œå™¨ç±»</p><p>éœ€è¦é…ç½® condition å‚æ•° <code>monitor.enable-log</code></p><h2 id="æ„é€ æ–¹æ³•-3"><a href="#æ„é€ æ–¹æ³•-3" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šæ—¶çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">printLogScheduler</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MonitorBus</span><span class="params">(LiteflowConfig liteflowConfig)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>.liteflowConfig = liteflowConfig;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (BooleanUtil.isTrue(liteflowConfig.getEnableLog())) &#123;</span><br><span class="line">      <span class="built_in">this</span>.printLogScheduler.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">MonitorTimeTask</span>(<span class="built_in">this</span>), liteflowConfig.getDelay(),</span><br><span class="line">            liteflowConfig.getPeriod(), TimeUnit.MILLISECONDS);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘å®šæ—¶çº¿ç¨‹æ± è®¾ç½®ä»»åŠ¡ï¼Œä»»åŠ¡ä¸º <code>new MonitorTimeTask(this)</code>ï¼Œæ˜¯ä¸€ä¸ª <code>TimerTask</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorTimeTask</span> <span class="keyword">extends</span> <span class="title class_">TimerTask</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MonitorBus monitorBus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MonitorTimeTask</span><span class="params">(MonitorBus monitorBus)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.monitorBus = monitorBus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">monitorBus.printStatistics();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>run</code> æ–¹æ³•ä¸ºè°ƒç”¨ <code>MonitorBus.printStatistics</code></p><h2 id="æ‰“å°ç»Ÿè®¡æ•°æ®"><a href="#æ‰“å°ç»Ÿè®¡æ•°æ®" class="headerlink" title="æ‰“å°ç»Ÿè®¡æ•°æ®"></a>æ‰“å°ç»Ÿè®¡æ•°æ®</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, BoundedPriorityBlockingQueue&lt;CompStatistics&gt;&gt; statisticsMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printStatistics</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Map&lt;String, BigDecimal&gt; compAverageTimeSpent = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, BigDecimal&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Entry&lt;String, BoundedPriorityBlockingQueue&lt;CompStatistics&gt;&gt; entry : statisticsMap.entrySet()) &#123;</span><br><span class="line">         <span class="type">long</span> <span class="variable">totalTimeSpent</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">for</span> (CompStatistics statistics : entry.getValue()) &#123;</span><br><span class="line">            totalTimeSpent += statistics.getTimeSpent();</span><br><span class="line">         &#125;</span><br><span class="line">         compAverageTimeSpent.put(entry.getKey(), <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(totalTimeSpent)</span><br><span class="line">            .divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(entry.getValue().size()), <span class="number">2</span>, RoundingMode.HALF_UP));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      List&lt;Entry&lt;String, BigDecimal&gt;&gt; compAverageTimeSpentEntryList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">            compAverageTimeSpent.entrySet());</span><br><span class="line"></span><br><span class="line">      Collections.sort(compAverageTimeSpentEntryList, (o1, o2) -&gt; o2.getValue().compareTo(o1.getValue()));</span><br><span class="line"></span><br><span class="line">      <span class="type">StringBuilder</span> <span class="variable">logStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">      logStr.append(<span class="string">&quot;ä»¥ä¸‹ä¸ºLiteFlowä¸­é—´ä»¶ç»Ÿè®¡ä¿¡æ¯ï¼š\n&quot;</span>);</span><br><span class="line">      logStr.append(<span class="string">&quot;======================================================================================\n&quot;</span>);</span><br><span class="line">      logStr.append(<span class="string">&quot;===================================SLOT INFO==========================================\n&quot;</span>);</span><br><span class="line">      logStr.append(MessageFormat.format(<span class="string">&quot;SLOT TOTAL SIZE : &#123;0&#125;\n&quot;</span>, liteflowConfig.getSlotSize()));</span><br><span class="line">      logStr.append(MessageFormat.format(<span class="string">&quot;SLOT OCCUPY COUNT : &#123;0&#125;\n&quot;</span>, DataBus.OCCUPY_COUNT));</span><br><span class="line">      logStr.append(<span class="string">&quot;===============================TIME AVERAGE SPENT=====================================\n&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (Entry&lt;String, BigDecimal&gt; entry : compAverageTimeSpentEntryList) &#123;</span><br><span class="line">         logStr.append(MessageFormat.format(<span class="string">&quot;COMPONENT[&#123;0&#125;] AVERAGE TIME SPENT : &#123;1&#125;\n&quot;</span>, entry.getKey(),</span><br><span class="line">               entry.getValue()));</span><br><span class="line">      &#125;</span><br><span class="line">      logStr.append(<span class="string">&quot;======================================================================================\n&quot;</span>);</span><br><span class="line">      LOG.info(logStr.toString());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;print statistics cause error&quot;</span>, e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>statisticsMap</code> æ˜¯ç”¨æ¥ä¿å­˜ç»„ä»¶æ‰§è¡Œæ—¶ä¸ŠæŠ¥çš„æ•°æ®ï¼Œåœ¨ <code>printStatistics</code> æ–¹æ³•ä¸­å¯¹æ•°æ®è¿›è¡Œæ•´ç†å’Œæ‰“å°</p><p>ä¸»è¦æ•°æ®ï¼š</p><ul><li>slot æ§½ä½ç°åœ¨çš„å¤§å°ï¼ˆç”¨æ¥è¡¡é‡æœ€å¤§å¹¶å‘åº¦ï¼‰</li><li>slot å½“å‰çš„å ç”¨æ•°é‡ï¼ˆå±•ç¤ºå½“å‰å¹¶å‘åº¦ï¼‰</li><li>å„ä¸ªç»„ä»¶çš„å¹³å‡è€—æ—¶</li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LiteFlow </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Maison Premiereâ€™s Tom Collins</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Maison%20Premiere%E2%80%99s%20Tom%20Collins.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Maison%20Premiere%E2%80%99s%20Tom%20Collins.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://assets-prd.punchdrink.com/wp-content/uploads/2023/03/16224141/Article-Tom-Collins-Underrated-Classic-Cocktail-Recipe-500x688.jpg"></p><h1 id="Maison-Premiere-çš„æ±¤å§†æŸ¯æ—æ–¯"><a href="#Maison-Premiere-çš„æ±¤å§†æŸ¯æ—æ–¯" class="headerlink" title="Maison Premiere çš„æ±¤å§†æŸ¯æ—æ–¯"></a>Maison Premiere çš„æ±¤å§†æŸ¯æ—æ–¯</h1><p><a href="https://punchdrink.com/recipes/maison-premieres-tom-collins/">Maison Premiereâ€™s Tom Collins Cocktail Recipe | PUNCH (punchdrink.com)</a></p><p>å¯¹äºæŸäº›è°ƒé…’å¸ˆæ¥è¯´ï¼Œâ€œè¢«ä½ä¼°â€ å¹¶ä¸ä¸€å®šæ„å‘³ç€é²œä¸ºäººçŸ¥</p><p>Maison Premiere çš„å¨å»‰Â·åŸƒåˆ©å¥¥ç‰¹ï¼ˆWilliam Elliottï¼‰è®¤ä¸ºï¼Œæ±¤å§†æŸ¯æ—æ–¯æ˜¯æ— å¤„ä¸åœ¨çš„ç»å…¸ï¼Œå€¼å¾— â€å¥½å¥½å¯¹å¾…â€œ</p><p>å…³é”®åœ¨äºæ‰¾åˆ°ä¸€ä¸ªè½»åº¦æ¡¶é™ˆçš„è€æ±¤å§†ï¼ˆä»–ä½¿ç”¨çš„æ˜¯ Ransom Old Tomï¼‰ï¼Œå¹¶ä¸”ï¼Œè™½ç„¶å¸¸è§çš„æ˜¯åœ¨ç»ç’ƒæ¯é‡Œè¿›è¡Œè°ƒåˆ¶ï¼Œä¸è¿‡ä¸€ä¸ªåˆé€‚çš„æ±¤å§†æŸ¯æ—æ–¯åº”è¯¥ç»è¿‡ shake å¹¶è¿‡æ»¤</p><p>åœ¨å¸ƒé²å…‹æ—çš„é…’å§é‡Œï¼ŒåŸƒåˆ©å¥¥ç‰¹å¯¹é¸¡å°¾é…’çš„åŸºåº•é‡‡ç”¨äº†ç±»ä¼¼å‰å§†é›·ç‰¹ï¼ˆGimletï¼‰çš„æ–¹å¼ï¼Œéœ€è¦æŸ æª¬æ±å’ŒæŸ æª¬ç”œé…’ï¼ˆlemon cordialï¼‰çš„é²œæ˜ç»„åˆï¼Œå†åŠ ä¸Šå°‘é‡çš„æ©™å‘³è‹¦ç²¾</p><h2 id="åŸæ–™"><a href="#åŸæ–™" class="headerlink" title="åŸæ–™"></a>åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>è€æ±¤å§†é‡‘é…’ï¼ˆæœ€å¥½æ˜¯ Ransomï¼‰- 1.5 ç›å¸ï¼ˆ<a href="https://www.diffordsguide.com/beer-wine-spirits/2344/ransom-old-tom-gin">Ransom Old Tom Gin</a>ï¼‰</li><li>æŸ æª¬ç”œé…’ - 1 ç›å¸ï¼ˆè§æ³¨é‡Šï¼‰</li><li>æµ·å†›åŠ›é‡é‡‘é…’ - 0.5 ç›å¸ï¼ˆæœ€å¥½æ˜¯ Haymanâ€™s Royal Dock <a href="https://www.diffordsguide.com/beer-wine-spirits/3066/haymans-royal-dock-of-deptford-gin">Haymanâ€™s Royal Dock of Deptford Gin</a>ï¼‰</li><li>æŸ æª¬æ± - 0.5 ç›å¸</li><li>æ©™å‘³è‹¦ç²¾ - 3 dashes</li><li>è‹æ‰“æ°´ - åŠ æ»¡</li></ul><p><strong>è£…é¥°</strong>ï¼šå®‰é«˜å¤©å¨œè‹¦ç²¾ã€æŸ æª¬è½®ã€ç³–éœœã€å¸ç®¡</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>å°†å‰äº”ç§åŸæ–™åŠ å…¥æ‘‡å£¶ä¸­ï¼ŒåŠ å†°è¿›è¡Œ shake</li><li>æ»¤å…¥åŠ å†°çš„ 12 ç›å¸æŸ¯æ—æ–¯ç»ç’ƒæ¯ä¸­ï¼Œå°†å®‰é«˜å¤©å¨œè‹¦ç²¾æ»´æµ®åœ¨è¡¨é¢</li><li>ç”¨æŸ æª¬è½®å’Œç³–éœœè£…é¥°ï¼Œæ’å…¥å¸ç®¡</li></ol><h2 id="æ³¨é‡Š"><a href="#æ³¨é‡Š" class="headerlink" title="æ³¨é‡Š"></a>æ³¨é‡Š</h2><h3 id="æŸ æª¬ç”œé…’ï¼ˆLemon-Cordialï¼‰"><a href="#æŸ æª¬ç”œé…’ï¼ˆLemon-Cordialï¼‰" class="headerlink" title="æŸ æª¬ç”œé…’ï¼ˆLemon Cordialï¼‰"></a>æŸ æª¬ç”œé…’ï¼ˆLemon Cordialï¼‰</h3><p>å°† 10 ä¸ªæŸ æª¬çš®ã€32 ç›å¸ç™½ç³–å’Œ 1 ç›å¸ä¼ç‰¹åŠ æ”¾åœ¨å®¹å™¨ä¸­æ··åˆï¼Œç»è¿‡ä¸€å¤œæˆ–æ”¾ç½® 12 å°æ—¶</p><p>åŠ å…¥ 32 ç›å¸æŸ æª¬æ±ï¼Œæ…æ‹Œè‡³ç™½ç³–æº¶è§£</p><p>è¿‡æ»¤ï¼ˆfine-strainï¼‰</p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GoogleCode ConcurrentLinkedHashMap</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/GoogleCode%20ConcurrentLinkedHashMap.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/GoogleCode%20ConcurrentLinkedHashMap.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h1><h2 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h2><p>ConcurrentLinkedHashMap æ„é€ æ–¹æ³•ç§æœ‰ï¼Œåªèƒ½é€šè¿‡å…¶é™æ€å†…éƒ¨ç±» <code>Builder</code> æ¥è¿›è¡Œå®ä¾‹åŒ–</p><blockquote><p>ä¸€ä¸ªå®Œå…¨æ”¯æŒå¹¶å‘æ£€ç´¢çš„å“ˆå¸Œè¡¨ï¼Œå¯è°ƒèŠ‚æ›´æ–°é¢„æœŸå¹¶å‘åº¦ï¼Œä»¥åŠé™åˆ¶å…¶æœ€å¤§å®¹é‡</p><p>è¯¥å®ç°ä¸ <code>ConcurrentHashMap</code> çš„ä¸åŒä¹‹å¤„åœ¨äºç»´æŠ¤äº†ä¸€ä¸ªé¡µé¢æ›¿æ¢ç®—æ³•ï¼ˆpage replacement algorithmï¼‰ï¼Œç”¨äºåœ¨ map è¶…å‡ºå®¹é‡æ—¶åˆ é™¤å…ƒç´ </p><p>è¿™ä¸ª map å®ç°æ²¡æœ‰å…±æœ‰çš„æ„é€ å™¨ï¼Œå®ƒçš„å®ä¾‹æ˜¯é€šè¿‡ <code>Builder</code> åˆ›å»ºçš„</p></blockquote><p><code>Builder</code> æ”¯æŒé“¾å¼èµ‹å€¼ï¼Œä½¿ç”¨å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ConcurrentLinkedHashMap&lt;Integer, String&gt; map =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedHashMap</span>.Builder&lt;Integer, String&gt;()</span><br><span class="line">            .maximumWeightedCapacity(<span class="number">2</span>)</span><br><span class="line">            .weigher(Weighers.singleton())</span><br><span class="line">            .listener((key, value) -&gt; System.out.println(<span class="string">&quot;å…ƒç´ è¢«ä¸¢å¼ƒäº† key=&quot;</span> + key + <span class="string">&quot; value=&quot;</span> + value))</span><br><span class="line">            .concurrencyLevel(<span class="number">32</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>build()</code> æ–¹æ³•è¿›è¡Œ <code>ConcurrentLinkedHashMap </code> çš„å®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConcurrentLinkedHashMap&lt;K, V&gt; <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">  checkState(capacity &gt;= <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedHashMap</span>&lt;K, V&gt;(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å¦‚æœ <code>capacity</code>ï¼Œå³ <code>maximumWeightedCapacity</code> æœªè¿›è¡Œèµ‹å€¼ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå…¶ä»–å‚æ•°å‡æœ‰é»˜è®¤å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Builder</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// é»˜è®¤ä¸º -1ï¼Œç»“åˆä¸Šé¢çš„é€»è¾‘ï¼Œä¸è¿›è¡Œèµ‹å€¼å®ä¾‹åŒ–æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">  capacity = -<span class="number">1</span>;</span><br><span class="line">  weigher = Weighers.entrySingleton();</span><br><span class="line">  initialCapacity = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">  concurrencyLevel = DEFAULT_CONCURRENCY_LEVEL;</span><br><span class="line">  listener = (EvictionListener&lt;K, V&gt;) DiscardingListener.INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="maximumWeightedCapacity"><a href="#maximumWeightedCapacity" class="headerlink" title="maximumWeightedCapacity"></a>maximumWeightedCapacity</h2><p>è¡¨ç¤ºè¯¥ map æœ€å¤§èƒ½å¤Ÿå…è®¸çš„æœ€å¤§é‡é‡ï¼Œå¹¶ä¸”æœ‰å¯èƒ½æš‚æ—¶è¶…è¿‡å®ƒï¼ˆæˆ‘ç†è§£å¯èƒ½é©±é€å…ƒç´ æ˜¯ä¸€ä¸ªæƒ°æ€§è¿‡ç¨‹ï¼‰</p><p>åœ¨å®ä¾‹åŒ– <code>ConcurrentLinkedHashMap</code> æ—¶ï¼Œä½¿ç”¨åŸå­ç±»ä½œä¸ºå®¹é‡çš„è®°å½•å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    capacity = <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(Math.min(builder.capacity, MAXIMUM_CAPACITY));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶‰åŠ <code>capacity</code> çš„æ–¹æ³•ï¼š</p><ul><li>capacityï¼šè·å–å½“å‰ capacity</li><li>setCapacityï¼šè®¾ç½® capacity</li><li>hasOverflowedï¼šåˆ¤æ–­å½“å‰é‡é‡å¤§å°æ˜¯å¦è¶…è¿‡äº† capacity</li></ul><h2 id="initialCapacity"><a href="#initialCapacity" class="headerlink" title="initialCapacity"></a>initialCapacity</h2><p>è¡¨ç¤ºåˆå§‹åŒ–åº•å±‚å­˜æ”¾å…ƒç´ çš„ map å®¹é‡ï¼Œé»˜è®¤ä¸º 16</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    data = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMapV8</span>&lt;K, Node&lt;K, V&gt;&gt;(builder.initialCapacity, <span class="number">0.75f</span>, concurrencyLevel);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConcurrentLinkedHashMap åº•å±‚å®ç°å­˜å‚¨çš„ç»“æ„æ˜¯ <code>ConcurrentHashMapV8</code>ï¼Œçœ‹åˆ°å…¶å‚æ•°å’Œ JUC ä¸‹é¢çš„ <code>ConcurrentHashMap</code> ä¸€æ ·å¤§è‡´å°±å¯ä»¥çŒœåˆ°è¯¥å‚æ•°çš„ä½œç”¨ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åœ¨é¢„ä¼°æ•°æ®é‡æ¥é¿å…é¢‘ç¹ resize æ“ä½œ</p><p>å¯¹äºè¯¥å‚æ•°æ˜¯å¦‚ä½•ç”¨äºå®ä¾‹åŒ– <code>ConcurrentHashMapV8</code> ï¼Œåœ¨åé¢çš„ <code>concurrencyLevel</code> å‚æ•°è¿›è¡Œå±•ç¤º</p><p>è¯¥å‚æ•°åªç”¨äºå®ä¾‹åŒ– <code>ConcurrentHashMapV8</code></p><h2 id="concurrencyLevel"><a href="#concurrencyLevel" class="headerlink" title="concurrencyLevel"></a>concurrencyLevel</h2><p>é¢„ä¼°çš„å¹¶å‘çº¿ç¨‹æ•°</p><p>å’Œ <code>initialCapacity</code> å‚æ•°ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†å®ä¾‹åŒ– <code>ConcurrentHashMapV8</code>ï¼Œå…¶å‚æ•°çš„ä½œç”¨ä¹Ÿå’Œ <code>ConcurrentHashMap</code> ä¸€æ ·ï¼ˆä½œè€…éƒ½æ˜¯ Doug Leaï¼‰</p><p><code>ConcurrentHashMap</code> æé«˜å¹¶å‘æ€§èƒ½çš„æ€æƒ³å°±æ˜¯ cell åŒ–ï¼ŒæŒ‰ç…§åº•å±‚ Entry æ•°ç»„å¤´å…ƒç´ ä½œä¸ºå¹¶å‘ç²’åº¦ï¼Œé‚£ä¹ˆ <code>concurrencyLevel</code> å’Œ <code>initialCapacity</code> è¿™ä¸¤ä¸ªå‚æ•°å¿…ç„¶åŒæ—¶å½±å“åº•å±‚æ•°ç»„çš„å¤§å°åˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMapV8</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">        initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">long</span>)(<span class="number">1.0</span> + initialCapacity / loadFactor);</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> (size &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="type">int</span>)size);</span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="weigher"><a href="#weigher" class="headerlink" title="weigher"></a>weigher</h2><p>é‡é‡å™¨ï¼Œç”¨æ¥è¡¡é‡ä¸€ä¸ªå…ƒç´ å ç”¨äº†å¤šå°‘é‡é‡ï¼Œé»˜è®¤ä¸º <code>SingletonWeigher</code></p><p>å› ä¸º ConcurrentLinkedHashMap çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯åœ¨é™åˆ¶ map å†…å…ƒç´ çš„å ç”¨ï¼Œé‚£ä¹ˆè¡¡é‡ä¸€ä¸ªå…ƒç´ çš„æƒé‡å°±è¢«æŠ½è±¡ä¸ºäº† <code>Weigher</code></p><p>å…¶ä¸­é™¤äº† <code>Weigher</code> è¿˜æä¾›äº† <code>EntryWeigher</code> çš„æŠ½è±¡ï¼Œç”¨äºå¯¹æ•´ä¸ª KV è¿›è¡Œé‡é‡çš„è¡¡é‡</p><p>å¯¹äº <code>Weigher</code> å®ç°ï¼Œä¼šè¢«è½¬æ¢ä¸º <code>EntryWeigher</code> å®ç°ï¼ˆç»Ÿä¸€å…¥å£ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Builder&lt;K, V&gt; <span class="title function_">weigher</span><span class="params">(Weigher&lt;? <span class="built_in">super</span> V&gt; weigher)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.weigher = (weigher == Weighers.singleton())</span><br><span class="line">      ? Weighers.&lt;K, V&gt;entrySingleton()</span><br><span class="line">      : <span class="keyword">new</span> <span class="title class_">BoundedEntryWeigher</span>&lt;K, V&gt;(Weighers.asEntryWeigher(weigher));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>EntryWeigherView</code> å°±æ˜¯ç”¨æ¥å°† <code>Weigher</code> åŒ…è£…ä¸º <code>EntryWeigher</code> çš„å®ç°</p><p>åˆ—ä¸¾ä¸€äº›è‡ªå¸¦çš„å®ç°</p><ul><li>Weigher<ul><li>SingletonWeigherï¼šä¸€ä¸ª value çš„é‡é‡è§†ä¸º 1</li><li>CollectionWeigherï¼švalue ä¸ºé›†åˆç±»å‹ï¼Œé‡é‡ä¸ºé›†åˆçš„ size</li><li>ListWeigherï¼švalue ä¸º list ç±»å‹ï¼Œé‡é‡ä¸º list çš„ size</li><li>MapWeigherï¼švalue ä¸º map ç±»å‹ï¼Œé‡é‡ä¸º map çš„ size</li></ul></li><li>EntryWeigher<ul><li>BoundedEntryWeigherï¼šå†…éƒ¨ä¸º <code>EntryWeigher</code> å®ç°ï¼Œè¦æ±‚é‡é‡å¤§äºç­‰äº 1</li><li>SingletonEntryWeigherï¼šä¸€ä¸ª KV çš„é‡é‡è§†ä¸º 1</li><li>EntryWeigherViewï¼šç”¨äºåŒ…è£… <code>Weigher</code> çš„å®ç°</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// The eviction support</span></span><br><span class="line">    weigher = builder.weigher;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‚æ•°ä¼šåœ¨ put å…ƒç´ ä»¥åŠä¸€ç³»åˆ—è·å– ordered è§†å›¾æ“ä½œä¸­è¢«ä½¿ç”¨</p><h2 id="listener"><a href="#listener" class="headerlink" title="listener"></a>listener</h2><p><code>EvictionListener</code> çš„å®ç°ï¼Œç”¨äºé©±é€å…ƒç´ æ—¶è°ƒç”¨è¯¥å®ç°çš„ <code>onEviction(K key, V value)</code> æ–¹æ³•è¿›è¡Œé€šçŸ¥</p><p>é»˜è®¤å€¼ä¸º <code>DiscardingListener.INSTANCE</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="comment">// The notification queue and listener</span></span><br><span class="line">    listener = builder.listener;</span><br><span class="line">    pendingNotifications = (listener == DiscardingListener.INSTANCE)</span><br><span class="line">        ? (Queue&lt;Node&lt;K, V&gt;&gt;) DISCARDING_QUEUE</span><br><span class="line">        : <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;Node&lt;K, V&gt;&gt;();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœ listener æ˜¯ä¸€ä¸ªé»˜è®¤å€¼ï¼Œåˆ™ <code>pendingNotifications</code> ä¹Ÿä¼šä½¿ç”¨é»˜è®¤é˜Ÿåˆ—ï¼Œå…¶å®ç°å°±æ˜¯ç©ºå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A queue that discards all additions and is always empty. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DiscardingQueue</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;Object&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">poll</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">peek</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> Iterator&lt;Object&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123; <span class="keyword">return</span> emptyList().iterator(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é©±é€å…ƒç´ æ—¶ä¸ä¼šè¿›è¡Œé€šçŸ¥ï¼Œä½¿ç”¨äº†<strong>ç©ºå¯¹è±¡æ¨¡å¼</strong></p><blockquote><p>åœ¨ç©ºå¯¹è±¡æ¨¡å¼ï¼ˆNull Object Patternï¼‰ä¸­ï¼Œä¸€ä¸ªç©ºå¯¹è±¡å–ä»£ NULL å¯¹è±¡å®ä¾‹çš„æ£€æŸ¥</p><p>Null å¯¹è±¡ä¸æ˜¯æ£€æŸ¥ç©ºå€¼ï¼Œè€Œæ˜¯ååº”ä¸€ä¸ªä¸åšä»»ä½•åŠ¨ä½œçš„å…³ç³»ï¼Œè¿™æ ·çš„ Null å¯¹è±¡ä¹Ÿå¯ä»¥åœ¨æ•°æ®ä¸å¯ç”¨çš„æ—¶å€™æä¾›é»˜è®¤çš„è¡Œä¸º</p></blockquote><h1 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h1><p><code>put</code> å’Œ <code>putIfAbsent</code> æœ€ç»ˆéƒ½è°ƒç”¨ <code>put(K key, V value, boolean onlyIfAbsent)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> put(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">putIfAbsent</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> put(key, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">V <span class="title function_">put</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">  <span class="comment">// å…¥å‚æ ¡éªŒ</span></span><br><span class="line">  checkNotNull(key);</span><br><span class="line">  checkNotNull(value);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—æƒé‡</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> <span class="variable">weight</span> <span class="operator">=</span> weigher.weightOf(key, value);</span><br><span class="line"><span class="comment">// åŒ…è£…èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">final</span> WeightedValue&lt;V&gt; weightedValue = <span class="keyword">new</span> <span class="title class_">WeightedValue</span>&lt;V&gt;(value, weight);</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K, V&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K, V&gt;(key, weightedValue);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// put è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; prior = data.putIfAbsent(node.key, node);</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡å†™å…¥ keyï¼Œè§†ä¸ºä¸€æ¬¡ Add</span></span><br><span class="line">    <span class="keyword">if</span> (prior == <span class="literal">null</span>) &#123;</span><br><span class="line">      afterWrite(<span class="keyword">new</span> <span class="title class_">AddTask</span>(node, weight));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å­˜åœ¨ key å¹¶ä¸” onlyIfAbsent = true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onlyIfAbsent) &#123;</span><br><span class="line">      afterRead(prior);</span><br><span class="line">      <span class="keyword">return</span> prior.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// èµ°åˆ°è¯¥ caseï¼Œè¯´æ˜ key å­˜åœ¨å¹¶ä¸” onlyIfAbsent = false</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="keyword">final</span> WeightedValue&lt;V&gt; oldWeightedValue = prior.get();</span><br><span class="line">     <span class="comment">// å¹¶å‘é”™è¯¯ä¸‹è·³å‡ºï¼Œç”± data.putIfAbsent(node.key, node) ç»§ç»­å–å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (!oldWeightedValue.isAlive()) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// æ›´æ–°æƒé‡ï¼Œè§†æƒ…å†µè¿›è¡Œ Update æˆ–è€… read</span></span><br><span class="line">      <span class="keyword">if</span> (prior.compareAndSet(oldWeightedValue, weightedValue)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">weightedDifference</span> <span class="operator">=</span> weight - oldWeightedValue.weight;</span><br><span class="line">        <span class="keyword">if</span> (weightedDifference == <span class="number">0</span>) &#123;</span><br><span class="line">          afterRead(prior);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          afterWrite(<span class="keyword">new</span> <span class="title class_">UpdateTask</span>(prior, weightedDifference));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldWeightedValue.value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¡ç®—æƒé‡"><a href="#è®¡ç®—æƒé‡" class="headerlink" title="è®¡ç®—æƒé‡"></a>è®¡ç®—æƒé‡</h2><p>ç»è¿‡å‚æ•°æ ¡éªŒåï¼Œé¦–å…ˆè¦è¿›è¡Œæƒé‡çš„è®¡ç®—å’ŒåŒ…è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æƒé‡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">weight</span> <span class="operator">=</span> weigher.weightOf(key, value);</span><br><span class="line"><span class="comment">// åŒ…è£…èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">final</span> WeightedValue&lt;V&gt; weightedValue = <span class="keyword">new</span> <span class="title class_">WeightedValue</span>&lt;V&gt;(value, weight);</span><br><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K, V&gt;(key, weightedValue);</span><br></pre></td></tr></table></figure><p>æƒé‡çš„è®¡ç®—å°±æ˜¯è°ƒç”¨äº† <code>EntryWeigher</code> å®ç°çš„ <code>weightOf()</code> æ–¹æ³•</p><p>éšåå°†æƒé‡å€¼å’Œ value åŒ…è£…è¿› <code>WeightedValue</code>ï¼Œå¹¶åŒ…è£…ä¸º <code>Node</code></p><p><code>Node</code> å³ä¸ºé“¾è¡¨çš„èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">AtomicReference</span>&lt;WeightedValue&lt;V&gt;&gt; <span class="keyword">implements</span> <span class="title class_">Linked</span>&lt;Node&lt;K, V&gt;&gt;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªä¿å­˜ KV çš„æ ¸å¿ƒç»“æ„ï¼ˆä¸Šé¢æåˆ°çš„ <code>ConcurrentHashMapV8</code>ï¼‰ä¿å­˜çš„å…¶å®æ˜¯ key å’Œ <code>Node</code> çš„æ•°æ®ï¼š<code>final ConcurrentMap&lt;K, Node&lt;K, V&gt;&gt; data;</code></p><h2 id="æ— å†²çª"><a href="#æ— å†²çª" class="headerlink" title="æ— å†²çª"></a>æ— å†²çª</h2><p>éšåè°ƒç”¨ <code>data</code> çš„ <code>putIfAbsent</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt; prior = data.putIfAbsent(node.key, node);</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¿”å›çš„ prior èŠ‚ç‚¹æƒ…å†µï¼Œåˆ¤æ–­åç»­æµç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€æ¬¡å†™å…¥ keyï¼Œè§†ä¸ºä¸€æ¬¡ Add</span></span><br><span class="line">  <span class="keyword">if</span> (prior == <span class="literal">null</span>) &#123;</span><br><span class="line">    afterWrite(<span class="keyword">new</span> <span class="title class_">AddTask</span>(node, weight));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// å­˜åœ¨ key å¹¶ä¸” onlyIfAbsent = trueï¼Œè§†ä¸ºä¸€æ¬¡ Read</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onlyIfAbsent) &#123;</span><br><span class="line">    afterRead(prior);</span><br><span class="line">    <span class="keyword">return</span> prior.getValue();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ç§æƒ…å†µå‡å¯ä»¥è§†ä¸ºæ— å†²çªæƒ…å†µï¼š</p><ul><li>ä¸å­˜åœ¨ prior</li><li>å­˜åœ¨ prior ä½†æ˜¯ onlyIfAbsent &#x3D; true</li></ul><p>éšåæ‰§è¡Œç›¸åº”çš„ Add æˆ–è€… Read ä»»åŠ¡ï¼ˆåé¢è§£é‡Šä»»åŠ¡çš„æ“ä½œï¼‰</p><h2 id="éœ€è¦æ›´æ–°"><a href="#éœ€è¦æ›´æ–°" class="headerlink" title="éœ€è¦æ›´æ–°"></a>éœ€è¦æ›´æ–°</h2><p>å½“ key å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆä¸Šè¿° put æ–¹æ³•å…¶å®å¹¶æœªå®Œæˆï¼Œåªæ˜¯è¿”å›äº† K å¯¹åº”çš„ value å¯¹è±¡ï¼ˆèŠ‚ç‚¹ï¼‰</p><p>å¯ä»¥çŒœæµ‹ä¸‹é¢æµç¨‹éœ€è¦åšçš„æ“ä½œï¼š</p><ul><li>æ›¿æ¢ key å¯¹åº”çš„ valueï¼›å› ä¸º value å’Œæƒé‡æ˜¯ç»‘å®šå…³ç³»ï¼Œä¹Ÿå³æ›¿æ¢äº†æƒé‡</li><li>è¿›è¡Œ Task æµç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµ°åˆ°è¯¥ caseï¼Œè¯´æ˜ key å­˜åœ¨å¹¶ä¸” onlyIfAbsent = false</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="keyword">final</span> WeightedValue&lt;V&gt; oldWeightedValue = prior.get();</span><br><span class="line">  <span class="comment">// å¹¶å‘é”™è¯¯ä¸‹è·³å‡ºï¼Œç”± data.putIfAbsent(node.key, node) ç»§ç»­å–å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (!oldWeightedValue.isAlive()) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°æƒé‡ï¼Œè§†æƒ…å†µè¿›è¡Œ Update æˆ– Read</span></span><br><span class="line">  <span class="keyword">if</span> (prior.compareAndSet(oldWeightedValue, weightedValue)) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">weightedDifference</span> <span class="operator">=</span> weight - oldWeightedValue.weight;</span><br><span class="line">    <span class="keyword">if</span> (weightedDifference == <span class="number">0</span>) &#123;</span><br><span class="line">      afterRead(prior);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      afterWrite(<span class="keyword">new</span> <span class="title class_">UpdateTask</span>(prior, weightedDifference));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldWeightedValue.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆè·å– prior èŠ‚ç‚¹çš„ <code>WeightedValue</code> ç»“æ„ï¼Œå½“è¯¥ç»“æ„ <code>isAlive()</code> ä¸º false æ—¶ï¼Œè¯´æ˜ç°åœ¨çš„ prior èŠ‚ç‚¹åœ¨å¹¶å‘ç¯å¢ƒä¸‹å·²ç»æˆä¸ºè¿‡å»å¼äº†ï¼Œéœ€è¦è·³å‡ºå¾ªç¯ï¼Œé‡æ–°è¿›è¡Œæœ€å¼€å§‹çš„è·å–æµç¨‹</li><li>å½“æ—§èŠ‚ç‚¹æ²¡é—®é¢˜ï¼Œå°±ä¼šè°ƒç”¨ CAS æ–¹æ³•æ¥æ›¿æ¢æ–°çš„ weight å’Œ valueï¼Œå¦‚æœæ›¿æ¢æˆåŠŸåˆ™ä¼šæ ¹æ®æƒé‡å·®å€¼æ¥è¿›è¡Œ Read æˆ–è€… Update ä»»åŠ¡</li><li>å¦‚æœ CAS å¤±è´¥ï¼Œåˆ™ä¼šç»§ç»­å¯¹èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œé‡å¤æµç¨‹</li></ol><h1 id="åˆ é™¤å…ƒç´ "><a href="#åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h1><h2 id="æŒ‰-K-åˆ é™¤"><a href="#æŒ‰-K-åˆ é™¤" class="headerlink" title="æŒ‰ K åˆ é™¤"></a>æŒ‰ K åˆ é™¤</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K, V&gt; node = data.remove(key);</span><br><span class="line">  <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  makeRetired(node);</span><br><span class="line">  afterWrite(<span class="keyword">new</span> <span class="title class_">RemovalTask</span>(node));</span><br><span class="line">  <span class="keyword">return</span> node.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆä¾èµ– <code>data</code> çš„ <code>remove(key)</code> æ–¹æ³•ï¼Œæ‹¿åˆ°èŠ‚ç‚¹åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœç­‰äº nullï¼Œè¯´æ˜è¯¥ key æ²¡æœ‰å¯¹åº”çš„å€¼ï¼Œå°±ä¸éœ€è¦è€ƒè™‘åç»­æµç¨‹äº†</li><li>å¦‚æœèŠ‚ç‚¹ä¸ç­‰ nullï¼Œéœ€è¦è¿›è¡Œ <code>makeRetired()</code>ï¼Œæœ¬è´¨æ˜¯ä¿®æ”¹èŠ‚ç‚¹ <code>WeightedValue</code> çš„æƒé‡ä¸ºè´Ÿæ•°ï¼ˆåœ¨æ·»åŠ æµç¨‹ä¸­ï¼Œä¾é æƒé‡æ˜¯å¦ä¸ºè´Ÿä½œä¸º value è¢«åˆ é™¤çš„æ ‡å¿—ï¼‰</li><li>éšåè¿›è¡Œ Removal ä»»åŠ¡</li></ol><h2 id="æŒ‰-KV-åˆ é™¤"><a href="#æŒ‰-KV-åˆ é™¤" class="headerlink" title="æŒ‰ KV åˆ é™¤"></a>æŒ‰ KV åˆ é™¤</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K, V&gt; node = data.get(key);</span><br><span class="line">  <span class="keyword">if</span> ((node == <span class="literal">null</span>) || (value == <span class="literal">null</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  WeightedValue&lt;V&gt; weightedValue = node.get();</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (weightedValue.contains(value)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (tryToRetire(node, weightedValue)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (data.remove(key, node)) &#123;</span><br><span class="line">          afterWrite(<span class="keyword">new</span> <span class="title class_">RemovalTask</span>(node));</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        weightedValue = node.get();</span><br><span class="line">        <span class="keyword">if</span> (weightedValue.isAlive()) &#123;</span><br><span class="line">          <span class="comment">// retry as an intermediate update may have replaced the value with</span></span><br><span class="line">          <span class="comment">// an equal instance that has a different reference identity</span></span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ é™¤çš„åŸºç¡€ä¸Šå¤šäº†å¯¹ value çš„æ¯”è¾ƒ</p><p>å½“ key å­˜åœ¨æ—¶ï¼Œè¿™é‡Œç”¨äº†å¤šä¸ªåµŒå¥—åˆ¤æ–­æ¥å®ç°ç›®çš„æˆ–ä¿è¯å¹¶å‘ï¼š</p><ol><li>value æ˜¯å¦èƒ½å¯¹åº”ä¸Šï¼Œå¯¹åº”ä¸ä¸Šç›´æ¥è¿”å›åˆ é™¤å¤±è´¥</li><li>è®© value é€€ä¼‘ï¼Œè°ƒç”¨ <code>tryToRetire(node, weightedValue)</code> æ–¹æ³•ï¼Œå¦‚æœå¤±è´¥å°±é‡æ–°è·å–èŠ‚ç‚¹çš„ valueï¼Œè¿›è¡Œå­˜æ´»åˆ¤æ–­ï¼Œå¦‚æœä¾ç„¶å­˜æ´»åˆ™é‡å¤æ•´ä¸ªæµç¨‹ï¼ˆä» 1 å¼€å§‹ï¼‰</li><li>è°ƒç”¨ <code>data.remove(key, node)</code> æ–¹æ³•ï¼Œå¦‚æœæˆåŠŸåˆ™è¿›è¡Œ Removal ä»»åŠ¡ï¼Œå¤±è´¥åˆ™é‡æ–°æ•´ä¸ªæµç¨‹</li></ol><h2 id="tryToRetire"><a href="#tryToRetire" class="headerlink" title="tryToRetire"></a>tryToRetire</h2><p>åœ¨ä¸Šè¿°åˆ é™¤æµç¨‹ä¸­ï¼Œéƒ½éœ€è¦è°ƒç”¨ <code>tryToRetire</code> æ–¹æ³•</p><p>æœ¬è´¨ä¸Šæ˜¯å°†èŠ‚ç‚¹ç½®ä¸ºå¤±æ•ˆçŠ¶æ€ï¼Œå¤±æ•ˆçŠ¶æ€æ ¹æ®èŠ‚ç‚¹ value ä¸­çš„ <code>WeightedValue</code> çš„ <code>weight</code> æ¥æ ‡ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">tryToRetire</span><span class="params">(Node&lt;K, V&gt; node, WeightedValue&lt;V&gt; expect)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (expect.isAlive()) &#123;</span><br><span class="line">    <span class="keyword">final</span> WeightedValue&lt;V&gt; retired = <span class="keyword">new</span> <span class="title class_">WeightedValue</span>&lt;V&gt;(expect.value, -expect.weight);</span><br><span class="line">    <span class="keyword">return</span> node.compareAndSet(expect, retired);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åç½®è¯»å†™"><a href="#åç½®è¯»å†™" class="headerlink" title="åç½®è¯»å†™"></a>åç½®è¯»å†™</h1><p>åœ¨ä¸Šè¿°æµç¨‹ä¸­ï¼Œå„ç§æ“ä½œéƒ½ç¦»ä¸å¼€è°ƒç”¨ <code>afterRead</code> å’Œ <code>afterWrite</code> æ–¹æ³•</p><p>åç½®è¯»å†™çš„æ“ä½œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨è°ƒæ•´é“¾è¡¨ç»“æ„æ¥å®ç° LRUï¼Œå¯¹å…ƒç´ è¿›è¡Œå†™å…¥ã€é©±é€å’Œæ’åº</p><h2 id="afterWrite"><a href="#afterWrite" class="headerlink" title="afterWrite"></a>afterWrite</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterWrite</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">    <span class="comment">// å†™ç¼“å†²åŒºæ·»åŠ ä»»åŠ¡</span></span><br><span class="line">    writeBuffer.add(task);</span><br><span class="line">    <span class="comment">// è®¾ç½® drain çŠ¶æ€ä¸º REQUIRED</span></span><br><span class="line">    drainStatus.lazySet(REQUIRED);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œç¼“å†²åŒºçš„ä»»åŠ¡</span></span><br><span class="line">    tryToDrainBuffers();</span><br><span class="line">    <span class="comment">// é€šçŸ¥ç›‘å¬å™¨</span></span><br><span class="line">    notifyListener();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ drainStatus æ˜¯ä¸€ä¸ªè¢« <code>AtomicReference</code> åŒ…è£…çš„ <code>DrainStatus</code>ï¼Œä»£è¡¨å½“å‰ç¼“å†²æ“ä½œçš„çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">DrainStatus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is not taking place. */</span></span><br><span class="line">    IDLE &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !delayable;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is required due to a pending write modification. */</span></span><br><span class="line">    REQUIRED &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is in progress. */</span></span><br><span class="line">    PROCESSING &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determines whether the buffers should be drained.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayable if a drain should be delayed until required</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> if a drain should be attempted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ drainStatus è¢«å¹¶å‘å®‰å…¨å¹¶ lazy è®¾ç½®ä¸º <code>REQUIRED</code> åï¼Œ<code>tryToDrainBuffers()</code> æ–¹æ³•æ¥æ‰§è¡Œå¯¹ç¼“å†²åŒºçš„æ“ä½œ</p><p><strong>tryToDrainBuffers</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">tryToDrainBuffers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (evictionLock.tryLock()) &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">            drainStatus.lazySet(PROCESSING);</span><br><span class="line">            drainBuffers();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            drainStatus.compareAndSet(PROCESSING, IDLE);</span><br><span class="line">            evictionLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–é”èµ„æ ¼ï¼ŒevictionLock æ˜¯ä¸€ä¸ª <code>ReentrantLock</code>ï¼š<code>evictionLock = new ReentrantLock();</code></p><p>å†å°† drainStatus çŠ¶æ€è®¾ç½®ä¸º <code>PROCESSING</code>ï¼›æœ€åè°ƒç”¨æ ¸å¿ƒçš„ <code>drainBuffers</code> æ–¹æ³•</p><p>å½“æ‰§è¡Œç»“æŸåå°† drainStatus CAS ä¿®æ”¹ä¸º <code>IDLE</code>ï¼Œè¿›è¡Œè§£é”</p><h2 id="afterRead"><a href="#afterRead" class="headerlink" title="afterRead"></a>afterRead</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterRead</span><span class="params">(Node&lt;K, V&gt; node)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å– buffer çš„ indexï¼Œè¿™é‡Œä¸ºäº†é¿å…å¯¹çƒ­ entries çš„äº‰æŠ¢</span></span><br><span class="line">    <span class="comment">// ä¸ªäººç†è§£ç±»ä¼¼é’ˆå¯¹ç¼“å†²åŒºçš„ cell æœºåˆ¶</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bufferIndex</span> <span class="operator">=</span> readBufferIndex();</span><br><span class="line">    <span class="comment">// æ ¹æ® bufferIndex å°† node è®°å½•åœ¨ readBuffer ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">writeCount</span> <span class="operator">=</span> recordRead(bufferIndex, node);</span><br><span class="line">    <span class="comment">// drain æ“ä½œ</span></span><br><span class="line">    drainOnReadIfNeeded(bufferIndex, writeCount);</span><br><span class="line">    <span class="comment">// é€šçŸ¥ç›‘å¬å™¨</span></span><br><span class="line">    notifyListener();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>recordRead</code> çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">recordRead</span><span class="params">(<span class="type">int</span> bufferIndex, Node&lt;K, V&gt; node)</span> &#123;</span><br><span class="line">    <span class="comment">// The location in the buffer is chosen in a racy fashion as the increment</span></span><br><span class="line">    <span class="comment">// is not atomic with the insertion. This means that concurrent reads can</span></span><br><span class="line">    <span class="comment">// overlap and overwrite one another, resulting in a lossy buffer.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">counter</span> <span class="operator">=</span> readBufferWriteCount[bufferIndex];</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">writeCount</span> <span class="operator">=</span> counter.get();</span><br><span class="line">    counter.lazySet(writeCount + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">int</span>) (writeCount &amp; READ_BUFFER_INDEX_MASK);</span><br><span class="line">    readBuffers[bufferIndex][index].lazySet(node);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> writeCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å– readBufferWriteCount çš„ counter çš„ value å +1 å†™å…¥</p><blockquote><p>è¿™é‡Œæ³¨é‡Šä¸­è¯´æ˜äº†è¿™ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ï¼Œæ„å‘³ç€å¯ä»¥å¹¶å‘è¯»å–ï¼Œå¹¶ä¸”ä¼šå¯¼è‡´ buffer çš„é‡å å’Œè¦†ç›–ï¼Œè¿˜ä¸æ¸…æ¥šä¸ºä»€ä¹ˆè¿™æ ·å¤„ç†</p><p>æ ¹æ®åç»­ä»£ç è¿™é‡Œè®°å½•çš„ count ä¸»è¦æ˜¯ç”¨äºæ§åˆ¶è¯»ç¼“å†²åŒºçš„ drain æ“ä½œï¼Œå¯èƒ½ä¸éœ€è¦é‚£ä¹ˆå‡†ç¡®ï¼ŒçŒœæµ‹è¿™æ ·å¤„ç†çš„åŸå› æ˜¯å› ä¸ºæ²¡å¿…è¦ä¸ºäº†å¹¶å‘å®‰å…¨ç‰ºç‰²æ€§èƒ½</p></blockquote><p>éšåå°† node è®°å½•åœ¨ readBuffers ä¸­</p><p><strong>drainOnReadIfNeeded</strong></p><p>è¯¥æ–¹æ³•å°±æ˜¯ç”¨äº drain è¯»ç¼“å†²åŒº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainOnReadIfNeeded</span><span class="params">(<span class="type">int</span> bufferIndex, <span class="type">long</span> writeCount)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å– pending æ•°é‡ï¼Œå½“å‰çº¿ç¨‹å¯¹åº”ç¼“å†²åŒºåœ¨ä¸Šä¸€æ­¥æ“ä½œçš„å†™æ•°é‡ - è¯»ç¼“å†²åŒºå¤„ç†çš„æ•°é‡ï¼ˆè®¡ç®—å·®å€¼åˆ¤æ–­æ˜¯å¦åˆ°äº†éœ€è¦åˆ·æ–°çš„é˜ˆå€¼ï¼‰</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">pending</span> <span class="operator">=</span> (writeCount - readBufferDrainAtWriteCount[bufferIndex].get());</span><br><span class="line">    <span class="comment">// READ_BUFFER_THRESHOLD = 32</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">delayable</span> <span class="operator">=</span> (pending &lt; READ_BUFFER_THRESHOLD);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">DrainStatus</span> <span class="variable">status</span> <span class="operator">=</span> drainStatus.get();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦ drain</span></span><br><span class="line">    <span class="keyword">if</span> (status.shouldDrainBuffers(delayable)) &#123;</span><br><span class="line">    tryToDrainBuffers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¯» count è®¡ç®— pending æ•°é‡ï¼Œæ ¹æ® pending å€¼æ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ drain æ“ä½œ</p><p>å…¶ä¸­å¯¹äºæ“ä½œçš„åˆ¤æ–­æ¥è‡ªäº <code>DrainStatus</code>ï¼Œå³çŠ¶æ€æšä¸¾å®ç°çš„æŠ½è±¡æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">DrainStatus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is not taking place. */</span></span><br><span class="line">    IDLE &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !delayable;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is required due to a pending write modification. */</span></span><br><span class="line">    REQUIRED &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is in progress. */</span></span><br><span class="line">    PROCESSING &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determines whether the buffers should be drained.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayable if a drain should be delayed until required</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> if a drain should be attempted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>å¯¹äº <code>REQUIRED</code>ï¼Œè¯´æ˜éœ€è¦ç«‹å³åˆ·æ–°ç¼“å†²åŒºï¼ˆè¿™ä¸ªçŠ¶æ€æœ€ç›´æ¥æ˜¯æ¥è‡ªäºå†™æ“ä½œï¼‰</li><li>å¯¹äº <code>PROCESSING</code>ï¼Œè¯´æ˜å½“å‰å…¶ä»–çº¿ç¨‹æ­£åœ¨å¤„ç†ï¼Œæ‰€ä»¥ä¸éœ€è¦è¯¥çº¿ç¨‹å†è¿›è¡Œæ“ä½œäº†</li><li>å¯¹äº <code>IDLE</code>ï¼Œåˆ™æ ¹æ® pending æ•°é‡å¾—åˆ°çš„ delayable æ¥åˆ¤æ–­</li></ul><p>æœ€åä¹Ÿæ˜¯è°ƒç”¨ <code>tryToDrainBuffers</code> æ–¹æ³•æ¥å¯¹ç¼“å†²åŒºè¿›è¡Œ drain æ“ä½œ</p><h2 id="drainWriteBuffer"><a href="#drainWriteBuffer" class="headerlink" title="drainWriteBuffer"></a>drainWriteBuffer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainWriteBuffer</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; WRITE_BUFFER_DRAIN_THRESHOLD; i++) &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> writeBuffer.poll();</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    task.run();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–ä¸€å®šæ•°é‡çš„ taskï¼Œç„¶åæ‰§è¡Œ task çš„ run æ–¹æ³•</p><p>æ¯ä¸€æ¬¡ drain æ“ä½œéƒ½æœ‰ä¸€ä¸ªé˜ˆå€¼ï¼ˆWRITE_BUFFER_DRAIN_THRESHOLD &#x3D; 16ï¼‰ï¼Œåº”è¯¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†æ‘Šå·¥ä½œé‡ï¼Œåœ¨ read ä¸­ä¹Ÿæ˜¯è¿™æ ·ç±»ä¼¼çš„è®¾è®¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/** Adds the node to the page replacement policy. */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">AddTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> weight;</span><br><span class="line"></span><br><span class="line">    AddTask(Node&lt;K, V&gt; node, <span class="type">int</span> weight) &#123;</span><br><span class="line">      <span class="built_in">this</span>.weight = weight;</span><br><span class="line">      <span class="built_in">this</span>.node = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;evictionLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      weightedSize.lazySet(weightedSize.get() + weight);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ignore out-of-order write operations</span></span><br><span class="line">      <span class="keyword">if</span> (node.get().isAlive()) &#123;</span><br><span class="line">        evictionDeque.add(node);</span><br><span class="line">        evict();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Removes a node from the page replacement policy. */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RemovalTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node;</span><br><span class="line"></span><br><span class="line">    RemovalTask(Node&lt;K, V&gt; node) &#123;</span><br><span class="line">      <span class="built_in">this</span>.node = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;evictionLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// add may not have been processed yet</span></span><br><span class="line">      evictionDeque.remove(node);</span><br><span class="line">      makeDead(node);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Updates the weighted size and evicts an entry on overflow. */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UpdateTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> weightDifference;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UpdateTask</span><span class="params">(Node&lt;K, V&gt; node, <span class="type">int</span> weightDifference)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.weightDifference = weightDifference;</span><br><span class="line">      <span class="built_in">this</span>.node = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;evictionLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      weightedSize.lazySet(weightedSize.get() + weightDifference);</span><br><span class="line">      applyRead(node);</span><br><span class="line">      evict();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº task çš„å®ç°ï¼Œæœ‰ 3 ç§ï¼š</p><ul><li><code>AddTask</code><ul><li>è°ƒæ•´ weight</li><li><code>evictionDeque</code> æ·»åŠ èŠ‚ç‚¹ï¼ˆå°¾æ’ï¼‰</li><li>è°ƒç”¨é©±é€æ–¹æ³• <code>evict</code></li></ul></li><li><code>RemovalTask</code><ul><li><code>evictionDeque</code> ç§»é™¤èŠ‚ç‚¹</li><li>è®¾ç½®èŠ‚ç‚¹ deadï¼ˆåŒ…æ‹¬è°ƒæ•´ weightï¼‰</li></ul></li><li><code>UpdateTask</code><ul><li>è°ƒæ•´ weight</li><li>è°ƒæ•´ node åˆ°å°¾éƒ¨</li><li>è°ƒç”¨é©±é€æ–¹æ³• <code>evict</code></li></ul></li></ul><p><strong>ä¸ºä»€ä¹ˆ <code>UpdateTask</code> ä¹Ÿéœ€è¦é©±é€å…ƒç´ ï¼Ÿ</strong>å› ä¸º weight çš„è®¡ç®—æ–¹æ³•æ˜¯ç”±å®ç°ç±»æä¾›çš„ï¼Œå¯èƒ½æ ¹æ®ä¸åŒçš„æƒ…å†µè®¡ç®— weightï¼Œæ›´æ–°æ“ä½œä¹Ÿå¯èƒ½æ›´æ–° weightï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œé©±é€æ“ä½œ</p><p><strong>é©±é€æ–¹æ³• evict</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">evict</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Attempts to evict entries from the map if it exceeds the maximum</span></span><br><span class="line">    <span class="comment">// capacity. If the eviction fails due to a concurrent removal of the</span></span><br><span class="line">    <span class="comment">// victim, that removal may cancel out the addition that triggered this</span></span><br><span class="line">    <span class="comment">// eviction. The victim is eagerly unlinked before the removal task so</span></span><br><span class="line">    <span class="comment">// that if an eviction is still required then a new victim will be chosen</span></span><br><span class="line">    <span class="comment">// for removal.</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡ weight é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">while</span> (hasOverflowed()) &#123;</span><br><span class="line">      <span class="keyword">final</span> Node&lt;K, V&gt; node = evictionDeque.poll();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If weighted values are used, then the pending operations will adjust</span></span><br><span class="line">      <span class="comment">// the size to reflect the correct weight</span></span><br><span class="line">      <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Notify the listener only if the entry was evicted</span></span><br><span class="line">      <span class="keyword">if</span> (data.remove(node.key, node)) &#123;</span><br><span class="line">        <span class="comment">// å¾…é€šçŸ¥é˜Ÿåˆ—</span></span><br><span class="line">        pendingNotifications.add(node);</span><br><span class="line">      &#125;</span><br><span class="line">     <span class="comment">// æ ‡è®°åˆ é™¤</span></span><br><span class="line">      makeDead(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å°±æ˜¯ä¸ºäº†å®ç° LRUï¼Œå¦‚æœè¶…å‡ºäº† weightï¼Œåˆ™ä¼šä» <code>evictionDeque</code> ä¸­ poll å‡ºå…ƒç´ åï¼Œè®°å½•å¾…é€šçŸ¥é˜Ÿåˆ—ï¼Œæ ‡è®°åˆ é™¤</p><p>æ ‡è®°åˆ é™¤åˆ é™¤çš„æ˜¯ Map ç»“æ„ä¸­çš„å…ƒç´ ï¼ˆä¿®æ”¹å…¶ weight æ ‡è®°åˆ é™¤ï¼‰ï¼Œå…¶ä¸­ node ä¹Ÿæ˜¯ Map ä¸­æŒæœ‰çš„å¼•ç”¨</p><h2 id="drainReadBuffers"><a href="#drainReadBuffers" class="headerlink" title="drainReadBuffers"></a>drainReadBuffers</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainReadBuffers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">int</span>) Thread.currentThread().getId();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> start + NUMBER_OF_READ_BUFFERS;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; i++) &#123;</span><br><span class="line">    drainReadBuffer(i &amp; READ_BUFFERS_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainReadBuffer</span><span class="params">(<span class="type">int</span> bufferIndex)</span> &#123;</span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">writeCount</span> <span class="operator">=</span> readBufferWriteCount[bufferIndex].get();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; READ_BUFFER_DRAIN_THRESHOLD; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">int</span>) (readBufferReadCount[bufferIndex] &amp; READ_BUFFER_INDEX_MASK);</span><br><span class="line">      <span class="keyword">final</span> AtomicReference&lt;Node&lt;K, V&gt;&gt; slot = readBuffers[bufferIndex][index];</span><br><span class="line">      <span class="keyword">final</span> Node&lt;K, V&gt; node = slot.get();</span><br><span class="line">      <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      slot.lazySet(<span class="literal">null</span>);</span><br><span class="line">      <span class="comment">// æœ¬è´¨ä¸Šå°±æ˜¯å°† evictionDeque ä¸­å¯¹åº”çš„ node ç§»åŠ¨åˆ°é˜Ÿå°¾ï¼ˆLRUï¼‰</span></span><br><span class="line">      applyRead(node);</span><br><span class="line">      readBufferReadCount[bufferIndex]++;</span><br><span class="line">&#125;</span><br><span class="line">readBufferDrainAtWriteCount[bufferIndex].lazySet(writeCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ“ä½œå¯ä»¥æ¦‚æ‹¬æˆå‡ ä¸ªè¦ç‚¹ï¼š</p><ul><li>æ¯ä¸€æ¬¡ drain æ“ä½œåˆ†é…äº† buffer æ“ä½œçš„é˜ˆå€¼</li><li>è·å– nodeï¼Œé‡Šæ”¾ node</li><li>å°† node ç§»åŠ¨åˆ°é˜Ÿå°¾</li><li>è®°å½• readBufferDrainAtWriteCount</li></ul><h1 id="é©±é€ç›‘å¬å™¨"><a href="#é©±é€ç›‘å¬å™¨" class="headerlink" title="é©±é€ç›‘å¬å™¨"></a>é©±é€ç›‘å¬å™¨</h1><p>æœ€åå°±æ˜¯ <code>notifyListener</code> æ–¹æ³•è°ƒç”¨ <code>EvictionListener</code> çš„å®ç°æ¥è¿›è¡Œå…ƒç´ é©±é€çš„é€šçŸ¥åŠŸèƒ½</p><p>ç›¸å…³çš„æ–¹æ³•åœ¨ <code>afterRead</code>ã€<code>afterWrite</code>ã€<code>setCapacity</code> ä¸­è¢«è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">notifyListener</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;K, V&gt; node;</span><br><span class="line">    <span class="keyword">while</span> ((node = pendingNotifications.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">  listener.onEviction(node.key, node.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå† pendingNotifications ä¸­è¢«é©±é€çš„ nodeï¼Œè°ƒç”¨ listener çš„ <code>onEviction</code> æ–¹æ³•</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://github.com/ben-manes/concurrentlinkedhashmap">ben-manes&#x2F;concurrentlinkedhashmap: A ConcurrentLinkedHashMap for Java (github.com)</a></p><p><a href="https://code.google.com/p/concurrentlinkedhashmap/">https://code.google.com/p/concurrentlinkedhashmap/</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ•°æ®ç»“æ„ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç©ºå¯¹è±¡æ¨¡å¼ - Null Object</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%A9%BA%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F%20-%20Null%20Object.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%A9%BA%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F%20-%20Null%20Object.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç©ºå¯¹è±¡æ¨¡å¼ï¼ˆNull Object Patternï¼‰ï¼Œä½¿ç”¨ç©ºå¯¹è±¡çš„è¡Œä¸ºï¼ˆç©ºå®ç°ã€æ ¡éªŒç­‰ï¼‰æ¥ä»£æ›¿å¯¹ Null å€¼çš„åˆ¤æ–­ï¼›ç©ºå¯¹è±¡å¹¶ä¸æ˜¯åœ¨æ£€æŸ¥ç©ºå€¼ï¼Œè€Œæ˜¯é€šè¿‡å¯¹è±¡çš„è¡Œä¸ºå®ç°ä¸è¿›è¡Œä»»ä½•åŠ¨ä½œæˆ–è€…æ ¡éªŒçš„æ•ˆæœï¼Œä»¥æ­¤å¯¹è°ƒç”¨æ–¹éšè—æ›´å¤šçš„å®ç°ç»†èŠ‚</p><p><strong>ç›®çš„</strong><br>å‘ä¸Šå±‚éšè—æ›´å¤šçš„å®ç°ç»†èŠ‚ï¼ŒåŠ å¼ºç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œå‡å°‘åˆ¤ç©ºåˆ¤æ–­</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong><br>åœ¨ç°å®ä¸–ç•Œä¸­ä¹Ÿå¾ˆéš¾è¡¨è¾¾ â€ç©ºâ€œ è¿™ä¸ªæ¦‚å¿µï¼Œå¾€å¾€ä¼šä½¿ç”¨ â€ç©ºç›’å­â€œã€â€ç©ºé—´â€œ æ¥è¿›è¡Œè¡¨è¾¾ï¼Œç±»æ¯”åœ¨ä»£ç ä¸­å°±æ˜¯ä½¿ç”¨è¡¨ç°ç©ºæ¦‚å¿µçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯åˆ¤ç©º <code>obj == null</code> æ¥å®ç°å¯¹ç©ºçš„åˆ¤æ–­</p><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>æ¨¡æ‹Ÿè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå¯¹ç”¨æˆ·å±•ç¤ºä¸€äº›å•†å“ä¿¡æ¯ï¼Œå…¶ä¸­è¦æ ¹æ®ç”¨æˆ·çš„å±æ€§å¯¹å•†å“è¿›è¡Œè¿‡æ»¤</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å¯¹äºæœ€ç»ˆè¿‡æ»¤åçš„å•†å“ï¼Œå¦‚æœæ— æ³•æ»¡è¶³ä¸€å®šæ•°é‡ï¼Œä¾‹å¦‚å•†å“æ•°é‡ &lt; 3ï¼Œå°±ä¼šä»é€šç”¨å•†å“æ± ä¸­é€‰æ‹©ä¸€å®šæ•°é‡çš„å•†å“è¿›è¡Œè¡¥ä½</p><p>è¿™æ ·çš„éœ€æ±‚åœ¨ä»£ç æµç¨‹ä¸­å¦‚ä½•è®¾è®¡ï¼Œå¦‚æœåœ¨è¿‡æ»¤æµç¨‹ã€VO è½¬æ¢æµç¨‹ç­‰é˜¶æ®µæ¥å®ç°ï¼Œå°±ä¼šè®©é€»è¾‘çœ‹èµ·æ¥ä¸å¤ªé¡ºç•…</p><p>è¿™æ—¶å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ç©ºå¯¹è±¡æ¨¡å¼</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="å…¨éƒ¨å•†å“ä¿¡æ¯"><a href="#å…¨éƒ¨å•†å“ä¿¡æ¯" class="headerlink" title="å…¨éƒ¨å•†å“ä¿¡æ¯"></a>å…¨éƒ¨å•†å“ä¿¡æ¯</h3><p>å…ˆå®šä¹‰å‡ºä¸€ä¸ªå•†å“ä¿¡æ¯é›†åˆï¼Œå½“ç„¶è¿™äº›å•†å“ä¿¡æ¯å¯ä»¥é€šè¿‡æ¥å£ã€æ•°æ®åº“ç³»ç»Ÿç­‰æ¥è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer num;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Pair&lt;Integer, Integer&gt; ageRange;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;GoodsInfo&gt; <span class="title function_">getAllGoodsInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ´—è¡£æœº&quot;</span>, <span class="number">10</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">20</span>, <span class="number">50</span>), BigDecimal.valueOf(<span class="number">2000.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;ç¬”è®°æœ¬ç”µè„‘&quot;</span>, <span class="number">21</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">15</span>, <span class="number">50</span>), BigDecimal.valueOf(<span class="number">4999.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ‰«åœ°æœºå™¨äºº&quot;</span>, <span class="number">5</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">25</span>, <span class="number">55</span>), BigDecimal.valueOf(<span class="number">2500.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;å¨å…·&quot;</span>, <span class="number">30</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">30</span>, <span class="number">60</span>), BigDecimal.valueOf(<span class="number">89.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ–‡å…·&quot;</span>, <span class="number">100</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">8</span>, <span class="number">30</span>), BigDecimal.valueOf(<span class="number">30.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;ç©ºè°ƒ&quot;</span>, <span class="number">6</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">30</span>, <span class="number">60</span>), BigDecimal.valueOf(<span class="number">5100.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;å„¿ç«¥ç©å…·&quot;</span>, <span class="number">40</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">10</span>, <span class="number">50</span>), BigDecimal.valueOf(<span class="number">100.0</span>))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ç±»"><a href="#ç”¨æˆ·ç±»" class="headerlink" title="ç”¨æˆ·ç±»"></a>ç”¨æˆ·ç±»</h3><p>ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåç»­ä¸šåŠ¡å°†ä¼šæ ¹æ® <code>age</code> å’Œ <code>expectPrice</code> å±æ€§å¯¹å±•ç¤ºçš„å•†å“è¿›è¡Œè¿‡æ»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Pair&lt;BigDecimal, BigDecimal&gt; expectPrice;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿‡æ»¤è§„åˆ™æ¥å£åŠå®ç°"><a href="#è¿‡æ»¤è§„åˆ™æ¥å£åŠå®ç°" class="headerlink" title="è¿‡æ»¤è§„åˆ™æ¥å£åŠå®ç°"></a>è¿‡æ»¤è§„åˆ™æ¥å£åŠå®ç°</h3><p>æä¾›è¿‡æ»¤è§„åˆ™æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GoodsFilterHandler</span> &#123;</span><br><span class="line">    List&lt;GoodsInfo&gt; <span class="title function_">filter</span><span class="params">(List&lt;GoodsInfo&gt; goodsInfos, User user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¹æ®å¹´é¾„è¿›è¡Œè¿‡æ»¤å®ç°</strong></p><p>æ ¹æ®å•†å“ä¿¡æ¯ä¸Šçš„å¹´é¾„å’Œç”¨æˆ·çš„å¹´é¾„è¿›è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AgeFilter</span> <span class="keyword">implements</span> <span class="title class_">GoodsFilterHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;GoodsInfo&gt; <span class="title function_">filter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; goodsInfos, <span class="keyword">final</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsInfos.stream().filter(</span><br><span class="line">            goodsInfo -&gt; goodsInfo.getAgeRange().getKey() &lt;= user.getAge() &amp;&amp; goodsInfo.getAgeRange().getValue() &gt;= user</span><br><span class="line">                .getAge()).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¹æ®æœŸæœ›ä»·æ ¼åŒºé—´è¿›è¡Œè¿‡æ»¤å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpectPriceFilter</span> <span class="keyword">implements</span> <span class="title class_">GoodsFilterHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;GoodsInfo&gt; <span class="title function_">filter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; goodsInfos, <span class="keyword">final</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsInfos.stream().filter(</span><br><span class="line">            goodsInfo -&gt; user.getExpectPrice().getKey().compareTo(goodsInfo.getPrice()) &lt;= <span class="number">0</span></span><br><span class="line">                &amp;&amp; user.getExpectPrice().getValue().compareTo(goodsInfo.getPrice()) &gt;= <span class="number">0</span>).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿‡æ»¤æµç¨‹æ¨¡æ¿æ–¹æ³•åŠå®ç°"><a href="#è¿‡æ»¤æµç¨‹æ¨¡æ¿æ–¹æ³•åŠå®ç°" class="headerlink" title="è¿‡æ»¤æµç¨‹æ¨¡æ¿æ–¹æ³•åŠå®ç°"></a>è¿‡æ»¤æµç¨‹æ¨¡æ¿æ–¹æ³•åŠå®ç°</h3><p>è¯¥æŠ½è±¡ç±»ä¸»è¦è¿›è¡Œä¸¤éƒ¨åˆ†æ“ä½œï¼š</p><ul><li>å®ç°ç±»æ³¨å†Œè¿‡æ»¤å™¨å®ç°</li><li><code>filter</code> æ–¹æ³•æ ¹æ®æ³¨å†Œçš„è¿‡æ»¤å™¨å®ç°å¯¹ç»“æœé›†è¿›è¡Œè¿‡æ»¤ï¼Œå…¶ä¸­åœ¨æœ€åé€šè¿‡å·¥å‚æ–¹æ³•å¯¹ç»“æœé›†ç”Ÿæˆä¸åŒçš„ <code>Converter</code> å®ç°ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractGoodsFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;GoodsFilterHandler&gt; <span class="title function_">goodsFilterHandlers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">filter</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        List&lt;GoodsFilterHandler&gt; goodsFilterHandlers = goodsFilterHandlers();</span><br><span class="line">        List&lt;GoodsInfo&gt; curGoods = GoodsInfo.getAllGoodsInfo();</span><br><span class="line">        <span class="keyword">for</span> (GoodsFilterHandler handler : goodsFilterHandlers) &#123;</span><br><span class="line">            curGoods = handler.filter(curGoods, user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç”Ÿæˆä¸åŒçš„ Converter å®ç°ç±»</span></span><br><span class="line">        <span class="keyword">return</span> GoodsInfoConverterFactory.buildConverter(curGoods).buildVO();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Common å®ç°</strong></p><p>æ³¨å†Œäº†è¿‡æ»¤è§„åˆ™çš„ä¸¤ä¸ªå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonGoodsFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractGoodsFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;GoodsFilterHandler&gt; <span class="title function_">goodsFilterHandlers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> <span class="title class_">AgeFilter</span>(), <span class="keyword">new</span> <span class="title class_">ExpectPriceFilter</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è½¬æ¢å™¨å·¥å‚ä¸å®ç°"><a href="#è½¬æ¢å™¨å·¥å‚ä¸å®ç°" class="headerlink" title="è½¬æ¢å™¨å·¥å‚ä¸å®ç°"></a>è½¬æ¢å™¨å·¥å‚ä¸å®ç°</h3><ul><li><code>buildConverter</code> æ–¹æ³•æ ¹æ®ç»“æœé›†ç”Ÿæˆä¸åŒçš„å®ç°ç±»</li><li><code>CommonConverter</code> æ²¡æœ‰è¡Œä¸º</li><li><code>LackConverter</code> å³ç©ºå¯¹è±¡æ¨¡å¼çš„å®ç°ï¼Œä¼šåœ¨è¿”å›çš„ç»“æœé›†ä¸Šè¡¥å……æ¨¡æ‹Ÿå•†å“ï¼ˆå¥½å§ï¼Œæ„Ÿè§‰è¿™ä¸ªä¾‹å­æœ‰ç‚¹ç‰µå¼ºï¼‰</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsInfoConverterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_GOODS_INFO_LACK_SIZE</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">GoodsInfoConverterFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GoodsInfoConverter <span class="title function_">buildConverter</span><span class="params">(List&lt;GoodsInfo&gt; goodsInfos)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isEmpty(goodsInfos) || goodsInfos.size() &lt; DEFAULT_GOODS_INFO_LACK_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LackConverter</span>(goodsInfos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonConverter</span>(goodsInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> List&lt;GoodsInfo&gt; result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">buildVO</span><span class="params">()</span> &#123;</span><br><span class="line">            List&lt;GoodsInfo&gt; res = convert();</span><br><span class="line">            <span class="keyword">return</span> res.stream().map(GoodsInfo::getName).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">GoodsInfoConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.result = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CommonConverter</span> <span class="keyword">extends</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CommonConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LackConverter</span> <span class="keyword">extends</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LackConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ArrayList&lt;GoodsInfo&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(result);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> result.size(); i &lt; DEFAULT_GOODS_INFO_LACK_SIZE; i++) &#123;</span><br><span class="line">                res.add(<span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ¨¡æ‹Ÿå•†å“&quot;</span>, <span class="number">1</span>, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>ä»»æ„æ„é€ ä¸€ä¸ªç”¨æˆ·ï¼Œç»è¿‡è¿‡æ»¤å™¨è¿”å›å…¶å±•ç¤ºçš„ä¼˜å…ˆçº§é«˜çš„å•†å“</p><p>å…¶ä¸­æ ¹æ®è¿‡æ»¤è§„åˆ™ï¼Œç”¨æˆ· 1 æ— æ³•æ»¡è¶³ &gt;&#x3D; 3 çš„æ¡ä»¶ï¼Œæ‰€ä»¥ä½¿ç”¨äº†æ¨¡æ‹Ÿå•†å“è¿›è¡Œè¡¥ä½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user1.setName(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">    user1.setAge(<span class="number">20</span>);</span><br><span class="line">    user1.setExpectPrice(<span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(BigDecimal.valueOf(<span class="number">10</span>), BigDecimal.valueOf(<span class="number">500</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user2.setName(<span class="string">&quot;æå››&quot;</span>);</span><br><span class="line">    user2.setAge(<span class="number">50</span>);</span><br><span class="line">    user2.setExpectPrice(<span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(BigDecimal.valueOf(<span class="number">2000</span>), BigDecimal.valueOf(<span class="number">7000</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="type">CommonGoodsFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonGoodsFilter</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [æ–‡å…·, å„¿ç«¥ç©å…·, æ¨¡æ‹Ÿå•†å“]</span></span><br><span class="line">    List&lt;String&gt; res1 = filter.filter(user1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [æ´—è¡£æœº, ç¬”è®°æœ¬ç”µè„‘, æ‰«åœ°æœºå™¨äºº, ç©ºè°ƒ]</span></span><br><span class="line">    List&lt;String&gt; res2 = filter.filter(user2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è°ƒæ•´è§„åˆ™</strong></p><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆç©ºå¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘ï¼ˆè¿™é‡Œæ˜¯åˆ¤æ–­ size å°äºé˜ˆå€¼ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ç§ç©ºè¡Œä¸ºï¼‰å’Œæ•´ä¸ªè¿‡æ»¤é€»è¾‘æ— å…³ï¼Œä¸šåŠ¡é€»è¾‘ä¸­ä¹Ÿä¸éœ€è¦è¿›è¡Œåˆ¤ç©ºï¼ˆå·¥å‚æ–¹æ³•é™¤å¤–ï¼‰ï¼Œå¯¹äºä¸Šæ¸¸ <code>AbstractGoodsFilter</code> è€Œè¨€ï¼Œå®ƒåªæ˜¯åœ¨æ‰§è¡Œè¿‡æ»¤é€»è¾‘ï¼Œè€Œå…·ä½“ç»“æœé›†å¹¶ä¸å…³å¿ƒï¼Œç»“æœé›†çš„è½¬æ¢ç”±ç©ºå¯¹è±¡å®ç°æ¥å®ç°</p><p>å¦‚æœäº§å“éœ€æ±‚è¿›è¡Œå˜åŠ¨ï¼Œå½“ size å°äº 3 æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™æ•´ä¸ªå¤§çš„ä¸šåŠ¡é€»è¾‘éƒ½ä¸éœ€è¦å˜åŠ¨ï¼Œåªéœ€è¦æ”¹å˜ç©ºå¯¹è±¡çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LackConverter</span> <span class="keyword">extends</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LackConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;æ¨èå•†å“å±æ€§ size &lt; &quot;</span> + DEFAULT_GOODS_INFO_LACK_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><p>ä¸Šé¢çš„ä¾‹å­åœ¨ä½¿ç”¨ç©ºå¯¹è±¡å®ç°æ¥è¿›è¡Œç‰¹æ®Šçš„ä¸šåŠ¡æµç¨‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç©ºå¯¹è±¡æ¨¡å¼æ¥å¯¹é»˜è®¤è¡Œä¸ºè¿›è¡Œç©ºå®ç°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸Šæ¸¸è°ƒç”¨çš„åˆ¤ç©ºä»£ç </p><p>ä¾‹å¦‚ Google çš„ <code>ConcurrentLinkedHashMap</code></p><p>åœ¨å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼ˆä½¿ç”¨ <code>ConcurrentLinkedHashMap.Builder</code> å¯¹è±¡ï¼‰ï¼Œ<code>listener</code> å‚æ•°çš„é»˜è®¤å€¼å°±æ˜¯ä¸€ä¸ªå›ºå®šçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Builder</span><span class="params">()</span> &#123;</span><br><span class="line">      capacity = -<span class="number">1</span>;</span><br><span class="line">      weigher = Weighers.entrySingleton();</span><br><span class="line">      initialCapacity = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">      concurrencyLevel = DEFAULT_CONCURRENCY_LEVEL;</span><br><span class="line">      <span class="comment">// é»˜è®¤å®ç° DiscardingListener.INSTANCE</span></span><br><span class="line">      listener = (EvictionListener&lt;K, V&gt;) DiscardingListener.INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é€šè¿‡ <code>Builder</code> è¿›è¡Œå®ä¾‹åŒ–ä¸­ï¼ŒçœŸæ­£åˆ›å»ºçš„ <code>ConcurrentLinkedHashMap</code> å¯¹è±¡ä¼šæ ¹æ®é»˜è®¤å€¼è®¾ç½®ä¸€ä¸ªé€šçŸ¥é˜Ÿåˆ— <code>pendingNotifications</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// The notification queue and listener</span></span><br><span class="line">    listener = builder.listener;</span><br><span class="line">    pendingNotifications = (listener == DiscardingListener.INSTANCE)</span><br><span class="line">        ? (Queue&lt;Node&lt;K, V&gt;&gt;) DISCARDING_QUEUE</span><br><span class="line">        : <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;Node&lt;K, V&gt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯é»˜è®¤å€¼åˆ™ä¼šä½¿ç”¨ <code>DISCARDING_QUEUE</code></p><p><code>DISCARDING_QUEUE</code> å°±æ˜¯ä¸€ç§ç©ºå®ç°ï¼Œä¼šä¸¢å¼ƒæ‰€æœ‰çš„é€šçŸ¥ï¼ˆå³ä¸é€šçŸ¥ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A queue that discards all entries. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Queue&lt;?&gt; DISCARDING_QUEUE = <span class="keyword">new</span> <span class="title class_">DiscardingQueue</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** A queue that discards all additions and is always empty. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DiscardingQueue</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">poll</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">peek</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Iterator&lt;Object&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123; <span class="keyword">return</span> emptyList().iterator(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç©ºå¯¹è±¡æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>å®ƒå¯ä»¥åŠ å¼ºç³»ç»Ÿçš„ç¨³å›ºæ€§ï¼Œèƒ½æœ‰æœ‰æ•ˆåœ°é˜²æ­¢ç©ºæŒ‡é’ˆæŠ¥é”™å¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ï¼Œä½¿ç³»ç»Ÿæ›´åŠ ç¨³å®š</li><li>å®ƒèƒ½å¤Ÿå®ç°å¯¹ç©ºå¯¹è±¡æƒ…å†µçš„å®šåˆ¶åŒ–çš„æ§åˆ¶ï¼Œèƒ½å¤ŸæŒæ¡å¤„ç†ç©ºå¯¹è±¡çš„ä¸»åŠ¨æƒ</li><li>å®ƒå¹¶ä¸ä¾é  Client æ¥ä¿è¯æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šè¿è¡Œ</li><li>å®ƒé€šè¿‡ <code>isNull</code> å¯¹ <code>==null</code> çš„æ›¿æ¢ï¼Œæ˜¾å¾—æ›´åŠ ä¼˜é›…ï¼Œæ›´åŠ æ˜“æ‡‚</li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://baike.baidu.com/item/%E7%A9%BA%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F/22932789?fr=aladdin">ç©ºå¯¹è±¡æ¨¡å¼_ç™¾åº¦ç™¾ç§‘ (baidu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç”¨ä¿¡é¸½è§£é‡Š HTTPS</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/%E7%94%A8%E4%BF%A1%E9%B8%BD%E8%A7%A3%E9%87%8A%20HTTPS.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/%E7%94%A8%E4%BF%A1%E9%B8%BD%E8%A7%A3%E9%87%8A%20HTTPS.html</url>
      
        <content type="html"><![CDATA[<p>å¯†ç å­¦æ˜¯ä¸€é—¨æ·±å¥¥éš¾æ‡‚çš„å­¦ç§‘ï¼Œå®ƒå……æ»¡äº†æ•°å­¦è¯æ˜ï¼›ä½†é™¤éæ˜¯æ­£åœ¨å¼€å‘å¯†ç ç³»ç»Ÿï¼Œå¦åˆ™ä¸å¿…äº†è§£å¤ªå¤šæ·±å±‚æ¬¡çš„çŸ¥è¯†</p><p>å¦‚æœä½ æ‰“å¼€è¿™ç¯‡æ–‡ç« æ˜¯å¸Œæœ›åˆ›é€ ä¸‹ä¸€ä»£ HTTPS åè®®ï¼Œé‚£ä¹ˆå¾ˆæŠ±æ­‰ï¼Œåªæœ‰â€œé¸½å­â€æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼›å¦‚æœä½ çš„ç›®çš„ä¸åœ¨äºæ­¤ï¼Œé‚£ä¹ˆè¯·æ¬£èµè¿™ç¯‡æ–‡ç« </p><h1 id="çˆ±ä¸½ä¸ã€é²å‹ƒå’Œ-â€¦â€¦-é¸½å­ï¼Ÿ"><a href="#çˆ±ä¸½ä¸ã€é²å‹ƒå’Œ-â€¦â€¦-é¸½å­ï¼Ÿ" class="headerlink" title="çˆ±ä¸½ä¸ã€é²å‹ƒå’Œ â€¦â€¦ é¸½å­ï¼Ÿ"></a>çˆ±ä¸½ä¸ã€é²å‹ƒå’Œ â€¦â€¦ é¸½å­ï¼Ÿ</h1><p>åœ¨äº’è”ç½‘ä¸Šçš„ä»»ä½•æ´»åŠ¨ï¼ˆé˜…è¯»è¿™ç¯‡æ–‡ç« ã€åœ¨ Amazon å¹³å°è´­ä¹°å•†å“ã€ä¸Šä¼ çŒ«å’ªå›¾ç‰‡ï¼‰å½’æ ¹ç»“åº•æ˜¯åŒæœåŠ¡å™¨å‘é€æˆ–è€…æ¥æ”¶æ¶ˆæ¯</p><p>å¯èƒ½å¬èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹è¿™äº›ä¿¡æ¯æ˜¯ç”±<strong>ä¿¡é¸½</strong>ï¼ˆcarrier pigeonsï¼‰ä¼ é€’çš„ï¼Œæˆ‘çŸ¥é“è¿™ä¸ªæ¯”å–»çœ‹èµ·æ¥å¾ˆéšæ„ï¼Œä½†ç›¸ä¿¡æˆ‘ï¼ŒHTTPS çš„å·¥ä½œæ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œå°½ç®¡è¦å¿«å¾—å¤š</p><p>æ­¤å¤–ï¼Œåé¢ä¼šä½¿ç”¨çˆ±ä¸½ä¸ã€é²å‹ƒã€é©¬æ´›é‡Œæ¥ä»£æ›¿æœåŠ¡å™¨ã€ç”¨æˆ·å’Œé»‘å®¢ï¼›å¦‚æœè¿™ä¸æ˜¯ä½ ç¬¬ä¸€æ¬¡å°è¯•ç†è§£å¯†ç æ¦‚å¿µï¼Œä½ ä¼šè®¤å‡ºè¿™äº›åå­—ï¼Œå› ä¸ºå®ƒä»¬åœ¨ç›¸å…³æŠ€æœ¯æ–‡çŒ®ä¸­è¢«å¹¿æ³›ä½¿ç”¨</p><h1 id="ç¬¬ä¸€æ¬¡å¹¼ç¨šçš„äº¤æµ"><a href="#ç¬¬ä¸€æ¬¡å¹¼ç¨šçš„äº¤æµ" class="headerlink" title="ç¬¬ä¸€æ¬¡å¹¼ç¨šçš„äº¤æµ"></a>ç¬¬ä¸€æ¬¡å¹¼ç¨šçš„äº¤æµ</h1><p>å¦‚æœçˆ±ä¸½ä¸æƒ³è¦å‘é€ä¸€æ¡æ¶ˆæ¯ç»™é²å‹ƒï¼Œå¥¹å°†è¿™æ¡æ¶ˆæ¯ç»‘åœ¨ä¿¡é¸½çš„è…¿ä¸Šè®©å®ƒé£å‘é²å‹ƒï¼›é²å‹ƒæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œçœ‹äº†çœ‹è§‰å¾—éå¸¸å¥½</p><p>ä½†æ˜¯å¦‚æœé©¬æ´›é‡Œæ‹¦æˆªäº†çˆ±ä¸½ä¸æ­£åœ¨é£è¡Œçš„ä¿¡é¸½éšåæ›¿æ¢äº†æ¶ˆæ¯å‘¢ï¼Ÿé²å‹ƒæ— æ³•çŸ¥é“æ¶ˆæ¯åœ¨è¿è¾“çš„è¿‡ç¨‹ä¸­è¢«ç¯¡æ”¹äº†</p><p>è¿™å°±æ˜¯ <strong>HTTP</strong> çš„å·¥ä½œåŸç†ï¼Œå¾ˆå¯æ€•å¯¹å§ï¼Œæˆ‘ä¸ä¼šé€šè¿‡ HTTP å‘é€æˆ‘çš„é“¶è¡Œå‡­è¯ï¼Œä½ ä¹Ÿä¸ä¼š</p><h1 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h1><p>å¦‚æœçˆ±ä¸½ä¸å’Œé²å‹ƒå¾ˆç‹¡çŒ¾ï¼Œä»–ä»¬äº’ç›¸å®šä¹‰äº†ä¸€å¥—åŠ å¯†è§„åˆ™æ¥ä¹¦å†™æ¶ˆæ¯ï¼Œä¾‹å¦‚å°†å­—æ¯è¡¨ä¸­çš„æ¯ä¸€ä¸ªå­—æ¯éƒ½ä½ç§» 3 ä½æ¥è¡¨ç¤º</p><p>ä¸¾ä¸ªä¾‹å­ï¼šD -&gt; Aï¼ŒE -&gt; Bï¼ŒF -&gt; Cï¼ŒåŸæœ¬çš„æ¶ˆæ¯ â€œsecret messageâ€ å°†ä¼šè¢«æ›¿æ¢æˆ â€œpbzobq jbppxdbâ€</p><p>ç°åœ¨å¦‚æœé©¬æ´›é‡Œæ‹¦æˆªäº†ä¿¡é¸½ï¼Œå¥¹å°†æ— æ³•å°†ä¿¡æ¯è½¬æ¢ä¸ºæœ‰æ„ä¹‰çš„å†…å®¹ï¼Œä¹Ÿæ— æ³•ç†è§£å®ƒçš„æ„æ€ï¼Œå› ä¸ºå¥¹ä¸çŸ¥é“åŠ å¯†æ–¹å¼ï¼ˆsecret codeï¼‰ï¼›ä½†æ˜¯é²å‹ƒå¯ä»¥è½»æ˜“åœ°å°†æ¶ˆæ¯åå‘è§£ç ï¼Œæ ¹æ® A -&gt; Dï¼ŒB -&gt; Eï¼ŒC -&gt; F çš„è§„åˆ™ï¼Œå°† â€œpbzobq jbppxdbâ€ è§£ç å› â€œsecret messageâ€</p><p>æˆåŠŸäº†ï¼</p><p>è¿™å°±è¢«ç§°ä¸º<strong>å¯¹ç§°åŠ å¯†</strong>ï¼ˆsymmetric key cryptographyï¼‰ï¼Œå› ä¸ºå¦‚æœçŸ¥é“äº†å¦‚ä½•è§£ç ï¼Œå°±çŸ¥é“äº†å¦‚ä½•åŠ å¯†</p><p>ä¸Šé¢æè¿°çš„å¯†ç é€šå¸¸è¢«ç§°ä¸º<strong>å‡¯æ’’å¯†ç </strong>ï¼ˆCaesar cipherï¼‰ï¼›åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ›´ä¸ºå¤æ‚çš„æ–¹å¼ï¼Œä½†ä¸»è¦æ€æƒ³æ˜¯ä¸€æ ·çš„</p><h1 id="æˆ‘ä»¬å¦‚ä½•ç¡®å®šå¯†é’¥ï¼Ÿ"><a href="#æˆ‘ä»¬å¦‚ä½•ç¡®å®šå¯†é’¥ï¼Ÿ" class="headerlink" title="æˆ‘ä»¬å¦‚ä½•ç¡®å®šå¯†é’¥ï¼Ÿ"></a>æˆ‘ä»¬å¦‚ä½•ç¡®å®šå¯†é’¥ï¼Ÿ</h1><p>å¦‚æœé™¤äº†å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹å¤–æ²¡æœ‰äººçŸ¥é“ä½¿ç”¨äº†ä»€ä¹ˆå¯†é’¥ï¼Œå¯¹ç§°åŠ å¯†æ˜¯éå¸¸å®‰å…¨çš„ï¼›åœ¨å‡¯æ’’å¯†ç ä¸­ï¼Œå¯†é’¥æ˜¯æˆ‘ä»¬å°†æ¯ä¸ªå­—æ¯ç§»åŠ¨å¤šå°‘ä¸ªå­—æ¯çš„åç§»é‡ï¼›åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨äº†åç§»é‡ 3ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ 4 æˆ– 12 ç­‰ç­‰</p><p>è¿™ä¸ªä¾‹å­çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœçˆ±ä¸½ä¸å’Œé²å‹ƒåœ¨å¼€å§‹ç”¨é¸½å­å‘é€æ¶ˆæ¯ä¹‹å‰æ²¡æœ‰è§é¢ï¼Œä»–ä»¬å°†æ— æ³•å®‰å…¨åœ°å»ºç«‹å¯†é’¥ï¼›å¦‚æœä»–ä»¬å°†å¯†é’¥éšæ¶ˆæ¯ä¸€èµ·å‘é€ï¼Œé‚£ä¹ˆé©¬æ´›é‡Œå°±ä¼šæ‹¦æˆªå¹¶å‘ç°å¯†é’¥ï¼Œè¿™å°†ä¼šå¯¼è‡´é©¬æ´›é‡Œåœ¨çˆ±ä¸½ä¸å’Œé²å‹ƒåœ¨ç»™æ¶ˆæ¯åŠ å¯†ä¹‹åä¾ç„¶å¯ä»¥éšæ„è·å–ã€ç¯¡æ”¹æ¶ˆæ¯</p><p>è¿™å°±æ˜¯<strong>ä¸­é—´äººæ”»å‡»</strong>ï¼ˆMan in the Middle Attackï¼‰çš„å…¸å‹ç¤ºä¾‹ï¼Œé¿å…è¿™ç§æ”»å‡»çš„å”¯ä¸€æ–¹æ³•æ˜¯ä¸€èµ·æ›´æ”¹åŠ å¯†ç³»ç»Ÿ</p><h1 id="ä¿¡é¸½æºå¸¦çš„ç›’å­"><a href="#ä¿¡é¸½æºå¸¦çš„ç›’å­" class="headerlink" title="ä¿¡é¸½æºå¸¦çš„ç›’å­"></a>ä¿¡é¸½æºå¸¦çš„ç›’å­</h1><p>æ‰€ä»¥çˆ±ä¸½ä¸å’Œé²å‹ƒæƒ³å‡ºäº†ä¸€ä¸ªæ›´å¥½çš„æ–¹æ¡ˆï¼Œå½“é²å‹ƒæƒ³è¦å‘çˆ±ä¸½ä¸å‘é€æ¶ˆæ¯æ—¶ï¼Œå°†éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</p><ul><li>é²å‹ƒç»™çˆ±ä¸½ä¸å‘é€ä¸€åªé¸½å­ï¼Œèº«ä¸Šä¸æºå¸¦ä»»ä½•ä¿¡æ¯</li><li>çˆ±ä¸½ä¸è®©è¿™åªé¸½å­æºå¸¦ä¸€ä¸ªç›’å­ï¼Œç›’å­æœ‰é”è€Œä¸”æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œé’¥åŒ™åœ¨çˆ±ä¸½ä¸è¿™é‡Œï¼Œå°†é¸½å­è¿”è¿˜ç»™é²å‹ƒ</li><li>é²å‹ƒå°†æ¶ˆæ¯æ”¾å…¥ç›’å­ï¼Œé”ä¸Šé”ï¼Œå¹¶å†æ¬¡å°†é¸½å­å‘ç»™çˆ±ä¸½ä¸</li><li>çˆ±ä¸½ä¸è·å–åˆ°ç›’å­ï¼Œä½¿ç”¨è‡ªå·±çš„é’¥åŒ™æ‰“å¼€ç›’å­åé˜…è¯»ç›’å­å†…çš„æ¶ˆæ¯</li></ul><p>è¿™ç§æ–¹å¼é©¬æ´›é‡Œåœ¨æ‹¦æˆªåˆ°ä¿¡é¸½åä¹Ÿæ— æ³•ä¿®æ”¹å†…å®¹ï¼Œå› ä¸ºä»–å¹¶æ²¡æœ‰ç›’å­çš„é’¥åŒ™ï¼›å½“çˆ±ä¸½ä¸å¸Œæœ›ç»™é²å‹ƒå‘é€æ¶ˆæ¯æ—¶ï¼Œéµå¾ªåŒæ ·çš„æµç¨‹</p><p>çˆ±ä¸½ä¸å’Œé²å‹ƒå°±æ˜¯ä½¿ç”¨äº†é€šå¸¸ç§°ä¸º<strong>éå¯¹ç§°åŠ å¯†</strong>ï¼ˆasymmetric key cryptographyï¼‰çš„æŠ€æœ¯ï¼Œä¹‹æ‰€ä»¥ç§°ä¸º<strong>ä¸å¯¹ç§°</strong>ï¼ˆasymmetricï¼‰ï¼Œæ˜¯å› ä¸ºå³ä½¿å¯ä»¥å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼ˆé”ä¸Šç›’å­ï¼‰ï¼Œä¹Ÿæ— æ³•è§£å¯†æ¶ˆæ¯ï¼ˆæ‰“å¼€ç›’å­ï¼‰</p><p>åœ¨æŠ€æœ¯æœ¯è¯­ä¸­ï¼Œç›’å­è¢«ç§°ä¸º<strong>å…¬é’¥</strong>ï¼ˆpublic keyï¼‰ï¼Œç›’å­å¤–é”çš„é’¥åŒ™ç§°ä¸º<strong>ç§é’¥</strong>ï¼ˆprivate keyï¼‰</p><h1 id="å¦‚ä½•ç›¸ä¿¡è¿™ä¸ªç›’å­ï¼Ÿ"><a href="#å¦‚ä½•ç›¸ä¿¡è¿™ä¸ªç›’å­ï¼Ÿ" class="headerlink" title="å¦‚ä½•ç›¸ä¿¡è¿™ä¸ªç›’å­ï¼Ÿ"></a>å¦‚ä½•ç›¸ä¿¡è¿™ä¸ªç›’å­ï¼Ÿ</h1><p>å¦‚æœç†è§£äº†ä¸Šè¿°å†…å®¹ï¼Œä¼šå‘ç°ä¾ç„¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼›å½“é²å‹ƒæ¥æ”¶åˆ°ç›’å­æ—¶ï¼Œå¦‚ä½•ç¡®å®šè¿™ä¸ªç›’å­å‘é€äºçˆ±ä¸½ä¸è€Œä¸æ˜¯é©¬æ´›é‡Œæ‹¦æˆªäº†é¸½å­ï¼Œå°†ç›’å­æ¢æˆäº†å¥¹æŒæœ‰é’¥åŒ™çš„ç›’å­å‘¢ï¼Ÿ</p><p>çˆ±ä¸½ä¸å†³å®šåœ¨ç›’å­ä¸Šç­¾åï¼Œè¿™æ ·å½“é²å‹ƒæ”¶åˆ°ç›’å­æ—¶ï¼Œä»–æ£€æŸ¥ç­¾åå°±å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸æ˜¯çˆ±ä¸½ä¸å‘é€çš„ç›’å­</p><p>å¯èƒ½ä¼šæœ‰äººè¿™æ ·æƒ³ï¼Œé²å‹ƒä¸€å¼€å§‹æ˜¯å¦‚ä½•è¯†åˆ«çˆ±ä¸½ä¸çš„ç­¾åçš„ï¼Ÿçˆ±ä¸½ä¸å’Œé²å‹ƒé¢ä¸´åŒæ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥ä»–ä»¬å†³å®šï¼Œè®©æ³°å¾·æ¥ä»£æ›¿çˆ±ä¸½ä¸æ¥è¿›è¡Œç­¾å</p><p>è°æ˜¯æ³°ç‰¹ï¼Ÿæ³°å¾·æ˜¯ä¸€ä¸ªéå¸¸æœ‰åã€çŸ¥åä¸”å€¼å¾—ä¿¡èµ–çš„äººï¼Œæ³°å¾·ç»™ä»»ä½•ä¸ªäººç­¾åï¼Œæ¯ä¸ªäººéƒ½ç›¸ä¿¡ä»–åªä¼šç»™åˆæ³•çš„äººç­¾å</p><p>æ¥ä¸‹æ¥ï¼Œæ³°å¾·åªæœ‰åœ¨ç¡®å®šè¦æ±‚ç­¾åçš„äººæ˜¯çˆ±ä¸½ä¸çš„æƒ…å†µä¸‹æ‰ä¼šåœ¨çˆ±ä¸½ä¸ç›’å­ä¸Šç­¾åï¼›å› æ­¤é©¬æ´›é‡Œè®©æ³°å¾·åœ¨è‡ªå·±çš„ç›’å­ä¸Šç­¾ä¸Šçˆ±ä¸½ä¸çš„åå­—ï¼Œæ‰€ä»¥ä¼šè¢«é²å‹ƒå‘ç°è¿™æ˜¯ä¸€ä¸ªéª—å±€</p><p>åœ¨æŠ€æœ¯æœ¯è¯­ä¸­ï¼Œæ³°å¾·é€šå¸¸è¢«ç§°ä¸º<strong>è®¤è¯æœºæ„</strong>ï¼ˆCertification Authorityï¼‰ï¼Œæ‚¨é˜…è¯»æœ¬æ–‡æ—¶ä½¿ç”¨çš„æµè§ˆå™¨é™„å¸¦äº†å„ç§è®¤è¯æœºæ„çš„ç­¾å</p><p>æ‰€ä»¥å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿æ¥ç½‘ç»œå¹¶ä¸”ç›¸ä¿¡ç›’å­ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ç›¸ä¿¡æ³°å¾·ï¼Œå¹¶ä¸”æ³°å¾·å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªç›’å­æ˜¯åˆæ³•çš„</p><h1 id="æ²‰é‡çš„ç›’å­"><a href="#æ²‰é‡çš„ç›’å­" class="headerlink" title="æ²‰é‡çš„ç›’å­"></a>æ²‰é‡çš„ç›’å­</h1><p>çˆ±ä¸½ä¸å’Œé²å‹ƒç°åœ¨æœ‰äº†ä¸€ä¸ªå¯é çš„é€šä¿¡ç³»ç»Ÿï¼Œä½†ä»–ä»¬æ„è¯†åˆ°æºå¸¦ç›’å­çš„é¸½å­æ¯”åªæºå¸¦ä¿¡æ¯çš„é¸½å­é£è¡Œçš„è¦æ…¢ï¼Œå› ä¸ºç›’å­æœ‰ä¸€å®šé‡é‡</p><p>æ‰€ä»¥ä»–ä»¬å†³å®šï¼Œå°†ä½¿ç”¨ç›’å­ï¼ˆéå¯¹ç§°åŠ å¯†ï¼‰æ¥åŠ å¯†å¯†é’¥ï¼Œè€Œä½¿ç”¨å¯¹ç§°å¯†ç å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼ˆè¿˜è®°å¾—å‡¯æ’’å¯†ç å—ï¼Ÿï¼‰</p><p>è¿™æ ·å°±å¯ä»¥ä¸¤å…¨å…¶ç¾ï¼š<strong>å…¼é¡¾éå¯¹ç§°å¯†ç çš„å¯é æ€§å’Œå¯¹ç§°å¯†ç çš„æ•ˆç‡</strong></p><p>åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œæ²¡æœ‰é£è¡Œç¼“æ…¢çš„é¸½å­ï¼Œä½†ä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¶ˆæ¯æ¯”ä½¿ç”¨å¯¹ç§°åŠ å¯†æ›´æ…¢ï¼Œå› æ­¤æˆ‘ä»¬åªä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¥äº¤æ¢åŠ å¯†å¯†é’¥</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://baida.dev/articles/https-explained-with-carrier-pigeons">HTTPS explained with carrier pigeons</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è£…é¥°æ¨¡å¼ - Decorator</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F%20-%20Decorator.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F%20-%20Decorator.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>è£…é¥°æ¨¡å¼ï¼ˆDecorator Patternï¼‰ä¹Ÿå«è£…é¥°å™¨æ¨¡å¼ï¼Œå¯ä»¥å®ç°åœ¨ä¸å¿…æ”¹å˜åŸç±»æ–‡ä»¶å’Œä½¿ç”¨ç»§æ‰¿çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°æ‰©å±•ä¸€ä¸ªå¯¹è±¡çš„åŠŸèƒ½ï¼›å®ƒæ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªåŒ…è£…å¯¹è±¡ï¼ˆè£…é¥°å™¨ï¼‰ï¼Œä¹Ÿå°±æ˜¯è£…é¥°æ¥åŒ…è£¹çœŸå®çš„å¯¹è±¡ï¼ˆå§”æ‰˜å¯¹è±¡ï¼‰</p><p><strong>ç›®çš„</strong><br>æ›´çµæ´»åœ°å¯¹å¯¹è±¡æ–¹æ³•è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ä½¿å¤šä¸ªè£…é¥°å™¨å…±åŒä½œç”¨ï¼Œè£…é¥°å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ä»»æ„ç»„åˆ</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong><br>åµŒå…¥å¼è®¾å¤‡ï¼Œæ‘„åƒå¤´é€šè¿‡æ¥å£è¿æ¥è®¡ç®—æœºï¼Œå®‰è£…åˆé€‚çš„é©±åŠ¨å’Œè½¯ä»¶ï¼Œæ•´ä¸ªç¡¬ä»¶ç¯å¢ƒå°±å¯ä»¥å…·å¤‡æ‘„å½±æœºçš„åŠŸèƒ½ï¼›è€Œåœ¨å…·å¤‡æ‘„å½±åŠŸèƒ½çš„åŸºç¡€ä¸Šå†è¿æ¥æ–°çš„è®¾å¤‡é¥æ§åº•ç›˜ï¼Œå°±å˜æˆäº†å¯ä»¥ç§»åŠ¨çš„æ‘„åƒè½¦</p><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œéœ€è¦å¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œå®ç°ä¸€ä¸ªåºåˆ—åŒ–å·¥å…·</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å‡è®¾è¦æ±‚åºåˆ—åŒ–æ–¹å¼æœ‰å¤šç§å®ç°ï¼Œè¿™ä¸ªæ²¡é—®é¢˜ï¼Œç»§æ‰¿æ¥å£è¿›è¡Œå¤šå®ç°</p><p>ç°åœ¨è¦å¯¹åŠŸèƒ½è¿›è¡Œæ‹“å±•ï¼Œå¢åŠ å¯¹äºåºåˆ—åŒ–ç»“æœçš„è¡¥å……æ–¹æ³•ï¼ˆPS.ç›´æ¥æ”¹å˜æ–¹æ³•é€»è¾‘ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡åé¢ä»£ç ç›´æ¥ä½¿ç”¨çš„ JSON å®ç°ï¼Œä¸å¤ªå¥½è®¾ç½®ä¸€ä¸ªä¿®æ”¹æ–¹æ³•ä¸­é—´é€»è¾‘çš„ä¾‹å­ï¼Œæ‰€ä»¥è¿™æ ·çœ‹èµ·æ¥æœ‰ç‚¹åƒä»£ç†æ¨¡å¼ï¼Œåé¢ä¼šæœ‰æˆ‘å¯¹äºè£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼åŒºåˆ«çš„çœ‹æ³•ï¼‰ï¼Œä¾‹å¦‚å¯¹äºç»“æœè¿›è¡Œæ‘˜è¦æˆ–è€…è¾“å‡ºåˆ°æ–‡ä»¶ç­‰æ“ä½œ</p><p>åœ¨è¿™æ ·çš„åŸºç¡€ä¸Šï¼Œæƒ³è¦å¯¹åŸæœ‰å®ç°æ–¹æ³•è¿›è¡Œå¢å¼ºã€æ‰©å±•ï¼Œå°±éœ€è¦åˆ›å»ºæ–°çš„å®ç°ç±»ï¼Œæˆ–è€…å†è¿›è¡Œä¸€å±‚æŠ½è±¡æ¥è¾¾åˆ°ç›®çš„ï¼Œé‚£å¦‚æœæˆ‘éœ€è¦å³è¿›è¡Œæ‘˜è¦åˆè¿›è¡Œæ–‡ä»¶è¾“å‡ºå‘¢ï¼Ÿ</p><p>å¯ä»¥çœ‹å‡ºæ­¤æ—¶å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>æ¯æ¬¡å¯¹äºæ–¹æ³•é€»è¾‘çš„ä¿®æ”¹å¯èƒ½ä¼šå˜åŠ¨åŸæœ‰ä»£ç </li><li>æ‰©å±•å’Œæ‰©å±•ä¹‹é—´çš„ä¹˜ç§¯å…³ç³»ï¼Œéœ€è¦å®šä¹‰æ›´å¤šçš„æŠ½è±¡</li><li>æ— æ³•åŠ¨æ€æ’æ‹”å®ç°</li></ul><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="åºåˆ—åŒ–å™¨æ¥å£"><a href="#åºåˆ—åŒ–å™¨æ¥å£" class="headerlink" title="åºåˆ—åŒ–å™¨æ¥å£"></a>åºåˆ—åŒ–å™¨æ¥å£</h3><p>åªå®šä¹‰ä¸€ä¸ªåºåˆ—åŒ–æ–¹æ³•ï¼Œä¼ å…¥å¯¹è±¡è¾“å‡ºåºåˆ—åŒ–åçš„å­—ç¬¦ä¸²</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">serialize</span><span class="params">(Object obj)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åºåˆ—åŒ–å™¨å®ç°"><a href="#åºåˆ—åŒ–å™¨å®ç°" class="headerlink" title="åºåˆ—åŒ–å™¨å®ç°"></a>åºåˆ—åŒ–å™¨å®ç°</h3><p>æä¾›ä¸¤ç§ä¸åŒçš„å®ç°ï¼Œä¸€ç§è¿›è¡Œ JSON åºåˆ—åŒ–ï¼Œä¸€ç§è°ƒç”¨ <code>toString</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON åºåˆ—åŒ–å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonSerializer</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// toString åºåˆ—åŒ–å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToStringSerializer</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> obj.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åºåˆ—åŒ–å™¨è£…é¥°"><a href="#åºåˆ—åŒ–å™¨è£…é¥°" class="headerlink" title="åºåˆ—åŒ–å™¨è£…é¥°"></a>åºåˆ—åŒ–å™¨è£…é¥°</h3><p>åºåˆ—åŒ–å™¨è£…é¥°å¯ä»¥å†æŠ½å‡ºä¸€ä¸ªæ¥å£ç»§æ‰¿åºåˆ—åŒ–å™¨æ¥å£ï¼Œè¿™é‡Œå› ä¸ºéƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª <code>serialize</code> æ–¹æ³•ï¼Œå°±ä¸å†å®šä¹‰æ–°çš„æ¥å£äº†</p><p>åŒæ—¶å¯¹äºåºåˆ—åŒ–å™¨è£…é¥°åŸºç±»ï¼Œå¯ä»¥å®šä¹‰ä¸ºæŠ½è±¡ç±»ï¼Œå†ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¥ç”±åç»­å®ç°ç±»æ¥å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializerDecorator</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Serializer serializer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SerializerDecorator</span><span class="params">(<span class="keyword">final</span> Serializer serializer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.serializer = serializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> serializer.serialize(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‘˜è¦åºåˆ—åŒ–å™¨è£…é¥°"><a href="#æ‘˜è¦åºåˆ—åŒ–å™¨è£…é¥°" class="headerlink" title="æ‘˜è¦åºåˆ—åŒ–å™¨è£…é¥°"></a>æ‘˜è¦åºåˆ—åŒ–å™¨è£…é¥°</h3><p>é‡å†™ <code>serialize</code> æ–¹æ³•ï¼Œå†è·å–åºåˆ—åŒ–ç»“æœåå†è¿›è¡Œæ‘˜è¦çš„è®¡ç®—å¹¶è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializerDigestDecorator</span> <span class="keyword">extends</span> <span class="title class_">SerializerDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DigestAlgorithm digestAlgorithm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SerializerDigestDecorator</span><span class="params">(<span class="keyword">final</span> Serializer serializer, DigestAlgorithm digestAlgorithm)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serializer);</span><br><span class="line">        <span class="built_in">this</span>.digestAlgorithm = digestAlgorithm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">super</span>.serialize(obj);</span><br><span class="line">        <span class="comment">// è¿”å›çš„æ˜¯åºåˆ—åŒ–åçš„æ‘˜è¦ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> DigestUtil.digester(digestAlgorithm).digestHex(s);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶è¾“å‡ºåºåˆ—åŒ–å™¨è£…é¥°"><a href="#æ–‡ä»¶è¾“å‡ºåºåˆ—åŒ–å™¨è£…é¥°" class="headerlink" title="æ–‡ä»¶è¾“å‡ºåºåˆ—åŒ–å™¨è£…é¥°"></a>æ–‡ä»¶è¾“å‡ºåºåˆ—åŒ–å™¨è£…é¥°</h3><p>é‡å†™ <code>serialize</code> æ–¹æ³•ï¼Œåœ¨è·å–åºåˆ—åŒ–ç»“æœåï¼Œè¾“å‡ºè‡³æ–‡ä»¶å¹¶è¿”å›åºåˆ—åŒ–æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializerFileDecorator</span> <span class="keyword">extends</span> <span class="title class_">SerializerDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FileWriter fileWriter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SerializerFileDecorator</span><span class="params">(<span class="keyword">final</span> Serializer serializer, String filePath)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serializer);</span><br><span class="line">        <span class="built_in">this</span>.fileWriter = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="keyword">new</span> <span class="title class_">File</span>(filePath));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">super</span>.serialize(obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        fileWriter.write(s);</span><br><span class="line">        fileWriter.flush();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>è£…é¥°å™¨å’Œè£…é¥°å™¨ä¹‹é—´å¯ä»¥ä»»æ„ã€ä¸é™æ¬¡æ•°åœ°åµŒå¥—ï¼Œæœ€ç»ˆçš„ç»“æœä¼šç»è¿‡æ¯ä¸ªè£…é¥°å™¨å’Œå§”æ‰˜å¯¹è±¡çš„å¤„ç†</p><p>æš´éœ²ç›¸å…³çš„æ–¹æ³•è¿˜å¯ä»¥å®ç°åŠ¨æ€åœ°æ›´æ–°è£…é¥°å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// obj</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// JSON åºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">jsonSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonSerializer</span>();</span><br><span class="line">        System.out.println(jsonSerializer.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…è£… digest è£…é¥°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">digestDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializerDigestDecorator</span>(jsonSerializer, DigestAlgorithm.SHA1);</span><br><span class="line">        System.out.println(digestDecorator.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…è£… file è£…é¥°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">fileDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializerFileDecorator</span>(digestDecorator, <span class="string">&quot;./serialize.txt&quot;</span>);</span><br><span class="line">        System.out.println(fileDecorator.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to string åºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">toStringSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringSerializer</span>();</span><br><span class="line">        System.out.println(toStringSerializer.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…è£… digest è£…é¥° å’Œ file è£…é¥°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">toStringFileDecorator</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SerializerFileDecorator</span>(<span class="keyword">new</span> <span class="title class_">SerializerDigestDecorator</span>(toStringSerializer, DigestAlgorithm.MD5),</span><br><span class="line">                <span class="string">&quot;./serialize2.txt&quot;</span>);</span><br><span class="line">        System.out.println(toStringFileDecorator.serialize(student));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è£…é¥°-amp-ä»£ç†"><a href="#è£…é¥°-amp-ä»£ç†" class="headerlink" title="è£…é¥° &amp; ä»£ç†"></a>è£…é¥° &amp; ä»£ç†</h1><p>åœ¨è¿™é‡Œéœ€è¦è®¨è®ºä¸€ä¸ªé—®é¢˜ï¼Œè£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼éƒ½æ˜¯å¯¹æ–¹æ³•è¿›è¡Œå¢å¼ºæˆ–è€…æ‰©å±•ï¼Œé‚£ä¹ˆå®ƒä»¬åˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><p>ç½‘ç»œä¸Šä¹Ÿæœ‰å¾ˆå¤šè®¨è®ºï¼Œä¸‹é¢æ˜¯ä¸€äº›è§‚ç‚¹å’Œæˆ‘çš„çœ‹æ³•ï¼š</p><ul><li><p><strong>ç»„åˆã€èšåˆæ˜¯è£…é¥°æ¨¡å¼ï¼Œç»§æ‰¿æ˜¯ä»£ç†æ¨¡å¼</strong><br>çœ‹èµ·æ¥æœ‰ä¸€å®šé“ç†ï¼Œæ„Ÿè§‰è£…é¥°æ¨¡å¼è¦æƒ³å®ç°åµŒå¥—çš„æ•ˆæœæ˜¯éœ€è¦ä½¿ç”¨ç»„åˆæ¥å®ç°ï¼Œä½†ä¹Ÿä¼šå­˜åœ¨ä½¿ç”¨ç»„åˆæ¥å®ç°çš„ä»£ç†æ¨¡å¼ï¼ˆé™æ€ä»£ç†ï¼‰ï¼›æ˜¯ä¸æ˜¯ä»ä¸€å®šè§’åº¦æ¥çœ‹çš„è¯ï¼Œç»„åˆã€èšåˆã€ç»§æ‰¿è¿™ç§ç»“æ„çš„é€‰æ‹©ï¼Œå’Œå®ç°ä»€ä¹ˆè®¾è®¡æ¨¡å¼å¹¶æ— å…³ç³»ï¼Ÿ</p><blockquote><p>The real difference is not ownership (composition versus aggregation), but rather type-information.</p><p><a href="https://stackoverflow.com/questions/18618779/differences-between-proxy-and-decorator-pattern">oop - Differences between Proxy and Decorator Pattern - Stack Overflow</a></p></blockquote></li><li><p><strong>è£…é¥°æ¨¡å¼ç”¨äºæ·»åŠ åŠŸèƒ½ï¼Œä»£ç†æ¨¡å¼ç”¨äºå¢å¼ºåŠŸèƒ½</strong><br>æˆ‘è§‰å¾—ä¸åˆç†ï¼Œè®¾è®¡æ¨¡å¼ä¸åº”è¯¥æ ¹æ® â€œè§„èŒƒâ€ æ¥è¿›è¡Œåˆ†ç±»ï¼Œä¹Ÿä¸ä¼šæ ¹æ®æ¨¡ç³Šçš„æè¿°æ¥å‘½å</p></li><li><p><strong>è£…é¥°æ¨¡å¼åœ¨æ‰§è¡ŒæœŸé—´æ‰ä¼šç”±å®¢æˆ·ç«¯æ§åˆ¶ï¼Œä½¿è£…é¥°å™¨å’Œå§”æ‰˜å¯¹è±¡å»ºç«‹è”ç³»ï¼Œåœ¨æ­¤ä¹‹å‰è£…é¥°å™¨ç±»åªçŸ¥é“å§”æ‰˜å¯¹è±¡çš„æ¥å£ï¼›ä»£ç†æ¨¡å¼åœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»çŸ¥é“ä»£ç†å¯¹è±¡çš„å…·ä½“ä¿¡æ¯ï¼ˆæ— è®ºè¿™ä¸ªå¯¹è±¡æ˜¯é€šè¿‡ä»£ç†ç±»æ–¹æ³•åˆ›å»ºè¿˜æ˜¯é€šè¿‡æ³¨å…¥ï¼‰</strong><br>æˆ‘è®¤ä¸ºè¿™ä¸ªæ˜¯ç›¸è¾ƒè€Œè¨€æœ€æœ‰æ ‡å¿—æ€§çš„åŒºåˆ«äº†ï¼›è£…é¥°çš„è¡Œä¸ºå‘ç”Ÿåœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ— è®ºæ˜¯åˆ›å»ºæ–°çš„è£…é¥°å™¨å¢å¼ºå§”æ‰˜ç±»ï¼Œè¿˜æ˜¯å–æ¶ˆå§”æ‰˜å¯¹è±¡çš„è£…é¥°å™¨ï¼Œéƒ½æ˜¯åŠ¨æ€çš„ï¼›è€Œä»£ç†ç±»ä»ä¸€å¼€å§‹å°±æ˜ç¡®äº†è‡ªå·±çš„å§”æ‰˜ç±»</p><blockquote><p>But a <strong>Proxy</strong> <em>always</em> knows the (more) specific type of the delegatee. In other words, the <strong>Proxy</strong> and its delegatee will have the same base type, but the <strong>Proxy</strong> points to some derived type. A <strong>Decorator</strong> points to its own base type. Thus, the difference is in compile-time information about the type of the delegatee.</p></blockquote></li><li><p><strong>è£…é¥°æ¨¡å¼çš„å§”æ‰˜å¯¹è±¡æ¥è‡ªå¤–éƒ¨ï¼Œä»£ç†æ¨¡å¼çš„å§”æ‰˜å¯¹è±¡å¯ä»¥è‡ªå·²åˆ›å»º</strong><br>å¼•ç”³äºä¸Šä¸€ä¸ªè§‚ç‚¹ï¼Œå¯¹äº â€œå…·ä½“ä¿¡æ¯â€ çš„äº†è§£å°±å†³å®šäº†ä»£ç†å¯¹è±¡å¯ä»¥ç›´æ¥åˆ›å»ºå‡ºå§”æ‰˜å¯¹è±¡</p></li></ul><p>äº‹å®ä¸Šç½‘ç»œä¸Šå¯¹äºè£…é¥°æ¨¡å¼ã€ä»£ç†æ¨¡å¼çš„ç•Œå®šä¹Ÿä¸€ç›´åœ¨è®¨è®ºä¸­ï¼Œæ„Ÿè§‰ä¸ä¸€å®šéœ€è¦å…³æ³¨åˆ°åº•ä»€ä¹ˆæ˜¯è£…é¥°ä»€ä¹ˆæ˜¯ä»£ç†ï¼Œè¿˜æ˜¯èƒ½å¤Ÿä½¿ç”¨åˆç†çš„è®¾è®¡è§£å†³</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä½¿ç”¨è£…é¥°æ¨¡å¼å¯ä»¥æ›´çµæ´»åœ°å¯¹å¯¹è±¡æ–¹æ³•è¿›è¡Œæ‰©å±•</p><ul><li>ä¼˜ç‚¹<ul><li>æ— éœ€åˆ›å»ºæ–°å­ç±»å³å¯æ‰©å±•å¯¹è±¡çš„è¡Œä¸º</li><li>å¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤å¯¹è±¡çš„åŠŸèƒ½</li><li>è£…é¥°å™¨å¯ä»¥ä»»æ„ç»„åˆ</li><li>å¯ä»¥å°†å®ç°äº†è®¸å¤šä¸åŒè¡Œä¸ºçš„ä¸€ä¸ªå¤§ç±»æ‹†åˆ†ä¸ºå¤šä¸ªè¾ƒå°çš„ç±»æ¥æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™</li></ul></li><li>ç¼ºç‚¹<ul><li>è™½ç„¶å¯ä»¥æ”¯æŒè¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤å¯¹è±¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®é™…å®ç°èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼ˆè£…é¥°æ ˆï¼‰</li><li>è£…é¥°æ ˆä¸€å®šæ˜¯æœ‰åºçš„</li><li>åˆå§‹åŒ–ä»£ç å˜å¾—ç¹æ‚</li></ul></li></ul><p><strong>è£…é¥°æ¨¡å¼çš„é€‚ç”¨ç¯å¢ƒ</strong></p><ul><li>åœ¨ä¸å½±å“å…¶ä»–å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä»¥åŠ¨æ€ã€é€æ˜çš„æ–¹å¼ç»™å•ä¸ªå¯¹è±¡æ·»åŠ èŒè´£</li><li>éœ€è¦åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡å¢åŠ åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½ä¹Ÿå¯ä»¥åŠ¨æ€åœ°è¢«æ’¤é”€</li><li>å½“ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æ–¹å¼å¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å……æˆ–è€…é‡‡ç”¨ç»§æ‰¿ä¸åˆ©äºç³»ç»Ÿæ‰©å±•å’Œç»´æŠ¤æ—¶<br>ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æƒ…å†µä¸»è¦æœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡ç‹¬ç«‹çš„æ‰©å±•ï¼Œä¸ºæ”¯æŒæ¯ä¸€ç§ç»„åˆå°†äº§ç”Ÿå¤§é‡çš„å­ç±»ï¼Œä½¿å¾—å­ç±»æ•°ç›®å‘ˆçˆ†ç‚¸æ€§å¢é•¿ï¼›ç¬¬äºŒç±»æ˜¯å› ä¸ºç±»å®šä¹‰ä¸èƒ½ç»§æ‰¿ï¼ˆå¦‚ <code>final</code> ç±»ï¼‰</li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://refactoringguru.cn/design-patterns/decorator">è£…é¥°è®¾è®¡ï¼ˆè£…é¥°è€…æ¨¡å¼ &#x2F; è£…é¥°å™¨æ¨¡å¼ï¼‰ (refactoringguru.cn)</a></p><p><a href="https://stackoverflow.com/questions/18618779/differences-between-proxy-and-decorator-pattern">oop - Differences between Proxy and Decorator Pattern - Stack Overflow</a></p><p><a href="https://www.kancloud.cn/digest/xing-designpattern/143730">è®¾è®¡æ¨¡å¼ï¼ˆä¹ï¼‰è£…é¥°æ¨¡å¼ï¼ˆDecoratorï¼‰ Â· å†™æœ€å¥½çš„è®¾è®¡æ¨¡å¼ä¸“æ  Â· çœ‹äº‘ (kancloud.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å•¤é…’èŠ±ï¼šä½ éœ€è¦çŸ¥é“çš„çŸ¥è¯†</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86.html</url>
      
        <content type="html"><![CDATA[<img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/hops.jpg" class=""><p>è®°å½•æ˜¾ç¤ºç¬¬ä¸€ä¸ªå–åˆ°å•¤é…’çš„äººè·ä»Šæœ‰ 9000 å¹´ä¹‹ä¹…ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œäººä»¬ä½¿ç”¨å•¤é…’èŠ±ä¸ºäº†é˜²è…ï¼Œæˆ–è€…ä¸ºäº†æ·»åŠ é£å‘³å’Œé¦™æ°”çš„å†å²å¹¶ä¸ä¹…è¿œ</p><p>å¦‚ä»Šï¼Œå•¤é…’ä¸­ä¸æ·»åŠ å•¤é…’èŠ±æ˜¯ä¸å¯æ€è®®çš„è¡Œä¸ºï¼›å®ƒä¸ä»…å¯ä»¥ä¿æŠ¤å•¤é…’çš„æ–°é²œï¼Œä¹Ÿå¯ä»¥ä¸°å¯Œå•¤é…’çš„å‘³é“</p><p>æœ¬æ–‡å°†ä»‹ç»ä½ å¯èƒ½ä¸çŸ¥é“çš„å•¤é…’èŠ±çŸ¥è¯†ï¼Œç°åœ¨æ˜¯æ—¶å€™äº†è§£å…³äºå®¶åº­é…¿é€ çš„åŸºæœ¬åŸæ–™ä¹‹ä¸€çš„æ–°ä¸œè¥¿äº†</p><h1 id="è®¤è¯†å•¤é…’èŠ±"><a href="#è®¤è¯†å•¤é…’èŠ±" class="headerlink" title="è®¤è¯†å•¤é…’èŠ±"></a>è®¤è¯†å•¤é…’èŠ±</h1><h2 id="ä»€ä¹ˆæ˜¯å•¤é…’èŠ±"><a href="#ä»€ä¹ˆæ˜¯å•¤é…’èŠ±" class="headerlink" title="ä»€ä¹ˆæ˜¯å•¤é…’èŠ±"></a>ä»€ä¹ˆæ˜¯å•¤é…’èŠ±</h2><p>å•¤é…’èŠ±æ¥è‡ªå•¤é…’èŠ±æ¤ç‰©é›Œæ ªï¼Œä¹Ÿè¢«ç§°ä¸º Humulus Lupulusï¼›å®ƒä»¬çš„å½¢çŠ¶åƒä¸€ä¸ªå€’ç½®çš„ç»¿è‰²æ¾æœï¼Œå•¤é…’èŠ±æ˜¯è¿™ç§ç‰¹æ®Šæ¤ç‰©çš„èŠ±æœµï¼›å¥‡æ€ªçš„äº‹å®æ˜¯ï¼šé…’èŠ±ä¸æ˜¯è‘¡è„è—¤ï¼Œå®ƒæ˜¯ä¸€ä¸ªèŒï¼Œè¿™æ„å‘³ç€æ¤ç‰©ä¸ä¼šç”¨å·é¡»è€Œæ˜¯ç”¨å®ƒçš„å«©ææ¥æ”€çˆ¬</p><p>é…¿é…’å¸ˆä½¿ç”¨åŒ…å«åœ¨è¿™äº›èŠ±ä¸­çš„ç²¾æ²¹å’Œæ ‘è„‚ï¼Œä½ å¿…é¡»å°†å…¶å¶å­å‰¥å¼€ï¼Œæ‰èƒ½å¾—åˆ°é»„è‰²çš„è›‡éº»ç´ è…ºï¼Œåœ¨è¿™å…¶ä¸­ä½ å¯ä»¥æ‰¾åˆ°æ·»åŠ åˆ°å•¤é…’ä¸­çš„ç‰©è´¨</p><p>åœ¨å¸‚åœºä¸­å¯ä»¥çœ‹åˆ°å•¤é…’èŠ±æœ‰å¾ˆå¤šç§åŒ…è£…æ–¹å¼ï¼Œæœ€å¸¸è§çš„æ˜¯çœ‹åˆ°å®ƒçš„é¢—ç²’æˆ–æ˜¯å¹²èŠ±çŠ¶æ€ï¼›ä¸€äº›äººä½¿ç”¨å•¤é…’èŠ±ç²¾æ²¹ï¼Œæ‰€ä»¥æœ€è¿‘æœ‰äººå¼€å‘äº†ä¸€ç§å«åš hop hash æˆ– hop crack çš„è›‡éº»ç²‰ï¼ˆlupulin powderï¼‰æ¥ä¾›ä½¿ç”¨</p><h2 id="ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬"></a>ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬</h2><p>ä¸€å¼€å§‹å•¤é…’é…¿é…’å¸ˆåœ¨é…¿é€ è¿‡ç¨‹ä¸­ä½¿ç”¨å•¤é…’èŠ±æ˜¯ä¸ºäº†å°†å•¤é…’ä¿å­˜æ›´é•¿æ—¶é—´ï¼Œå› ä¸ºåœ¨é‚£ä¸ªæ—¶ä»£ï¼Œä¿å­˜é£Ÿç‰©çš„æ–¹æ³•å¾ˆå°‘ï¼Œå†°ç®±è¿˜æ²¡æœ‰å‘æ˜ï¼Œæ‰€ä»¥äººä»¬å¿…é¡»æ‰¾åˆ°è‡ªç„¶çš„æ–¹æ³•æ¥é˜²æ­¢é£Ÿç‰©å’Œé¥®æ–™å˜è´¨ï¼Œä»–ä»¬å°è¯•äº†äº†ä¸åŒçš„è‰æœ¬æ¤ç‰©å’Œæ²¹ç­‰ç‰©è´¨ï¼Œä½†æ²¡æœ‰æ•ˆæœæ˜¾è‘—çš„æ–¹æ³•</p><p>åœ¨æ³•å›½ä¸€äº›è®°è½½è®°å½•äº†åœ¨ 9 ä¸–çºªå•¤é…’é…¿é€ è¿‡ç¨‹ä¸­å¼€å§‹æœ‰å•¤é…’èŠ±çš„åŠ å…¥ï¼Œå¾·å›½äººä¹Ÿæœ‰åœ¨ 12 ä¸–çºªå¼€å§‹ä½¿ç”¨å®ƒä½œä¸ºé˜²è…å‰‚çš„è®°å½•ï¼Œå¹¶å¼€å§‹åœ¨æ¬§æ´²å’Œè‹±å›½æ¨å¹¿ï¼Œåœ¨é‚£ä¸ªæ—¶ä»£ä¹‹å‰ç”Ÿäº§çš„ä¸ä½¿ç”¨å•¤é…’èŠ±çš„å•¤é…’ï¼Œç°å¦‚ä»Šè¢«äººç§°ä¸º Gruit æˆ– Grut</p><p>å•¤é…’èŠ±ä¹Ÿæœ‰åŠ©äºèµ‹äºˆå•¤é…’ç‹¬ç‰¹çš„é¦™æ°”å’Œé£å‘³ï¼›å®ƒæ˜¯è‹¦çš„ï¼Œæœ‰ä¸€äº›æ–¹æ³•å¯ä»¥æ ¹æ®å•¤é…’èŠ±æ¥è¡¡é‡å•¤é…’çš„è‹¦å‘³ï¼›æ ¹æ®å“ç§å’Œç§æ¤åœ°çš„ä¸åŒï¼Œå•¤é…’èŠ±å…·æœ‰ä¸åŒçš„å‘³é“å’Œé¦™å‘³ï¼Œç„¶åå°†å…¶è½¬ç§»åˆ°å•¤é…’ä¸­</p><p>å•¤é…’èŠ±çš„è‹¦å‘³ä¸éº¦èŠ½çš„ç”œå‘³å½¢æˆå¯¹æ¯”ï¼Œå•¤é…’èŠ±ç§ç±»å’Œè´¨é‡çš„ä¸åŒä¼šæä¾›å‡ºå„ç§å„æ ·çš„ç‰©è´¨</p><h2 id="ä»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬"><a href="#ä»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬" class="headerlink" title="ä»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬"></a>ä»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬</h2><p>å•¤é…’èŠ±ç”Ÿé•¿éœ€è¦ç‰¹æ®Šçš„ç¯å¢ƒï¼Œå®ƒä»¬åœ¨çº¬åº¦ 35 åˆ° 55 åº¦ä¹‹é—´ç”Ÿé•¿æœ€äº‹å®œï¼Œå—åŒ—åŠçƒç»´åº¦èŒƒå›´éƒ½å·®ä¸å¤š</p><p>å®ƒä»¬æ›´å–œæ¬¢å¹³å¦çš„åœ°å½¢ï¼Œæ­¤å¤–è¿˜ä¼šå—åˆ°å¯’å†·å†¬å­£å’Œå¤å­£æ—¥ç…§æ—¶é—´é•¿çš„æ˜¾è‘—å½±å“ï¼Œæ‰€ä»¥æœ€å¥½ç»™å®ƒä»¬æ‰¾ä¸ªé¿é£çš„åœ°æ–¹ï¼›è¿™äº›æƒ…å†µå¹¶ä¸å¸¸è§ï¼Œæ‰€ä»¥åœ¨æŸäº›å›½å®¶æ›´æœ‰å¯èƒ½å‘ç”Ÿ</p><p>å•¤é…’èŠ±æœ€é‡è¦çš„äº§åŒºä½äºå¾·å›½ã€æ·å…‹å…±å’Œå›½ã€ç¾å›½å’Œè‹±å›½ï¼›ç¾å›½å’Œå¾·å›½éƒ½æ˜¯å•¤é…’èŠ±çš„ä¸»è¦ç”Ÿäº§å›½ï¼Œé…¿é…’å¸ˆå€¾å‘äºå°†å®ƒä»¬åˆ†åˆ«ç§°ä¸º â€œæ–°ä¸–ç•Œé…’èŠ±â€ å’Œ â€œæ—§ä¸–ç•Œé…’èŠ±â€</p><p>å•¤é…’èŠ±ä»¬ä¸éœ€è¦ç…§é¡¾ä¹Ÿèƒ½è“¬å‹ƒç”Ÿé•¿ï¼Œå®ƒä»¬æ‰¾åˆ°äº†åœ¨å¤§è‡ªç„¶ä¸­ç”Ÿå­˜çš„æ–¹æ³•ï¼›å½“ç„¶ä¹Ÿæœ‰é‡ç”Ÿå•¤é…’èŠ±åˆ†å¸ƒåœ¨å…¶ä»–åœ°æ–¹ï¼Œæ¯”å¦‚æ¾³å¤§åˆ©äºšï¼Œé‚£é‡Œå¹¶æ²¡æœ‰ä¸“é—¨ç§æ¤å•¤é…’èŠ±çš„å†œåœº</p><h2 id="å¦‚ä½•ç”¨äºå•¤é…’"><a href="#å¦‚ä½•ç”¨äºå•¤é…’" class="headerlink" title="å¦‚ä½•ç”¨äºå•¤é…’"></a>å¦‚ä½•ç”¨äºå•¤é…’</h2><p>åœ¨ä½¿ç”¨å•¤é…’èŠ±æ—¶ï¼Œå¿…é¡»å°†å®ƒä»¬åˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„ç±»åˆ«</p><p>ç”¨äºè·å¾—è‹¦å‘³çš„å•¤é…’èŠ± Î± é…¸å«é‡å¾ˆé«˜ï¼Œè¿™ç§ç‰¹è´¨ä½¿å•¤é…’å‘³é“æ›´åŠ è‹¦æ¶©ï¼Œä½†æ˜¯å®ƒä¼šåœ¨é¦™æ°”å’Œé£å‘³æ–¹é¢ä¸å¤Ÿç²¾è‡´ï¼›è¦è·å¾—å•¤é…’èŠ±ä¸­çš„è‹¦å‘³ç‰©è´¨å¹¶å°†å…¶ä½œç”¨äºå•¤é…’ï¼Œéœ€è¦å°†å•¤é…’èŠ±è¿›è¡Œç…®æ²¸ï¼Œè‹¦å‘³çš„ç¨‹åº¦å¾€å¾€å–å†³äºç…®æ²¸å•¤é…’èŠ±çš„æ—¶é—´ï¼Œæ—¶é—´è¶Šé•¿è‹¦å‘³ç‰©è´¨å°±ä¼šè¶Šå¤š</p><p>å¦ä¸€ç±»æ˜¯é¦™å‘³å•¤é…’èŠ±ï¼Œå®ƒä»¬çš„ Î± é…¸å«é‡è¾ƒä½æ›´ä¾èµ–ç²¾æ²¹ï¼Œè¿™ä¸€ç‰¹è´¨ä½¿å®ƒä»¬çš„å‘³é“æ›´åŠ ç‹¬ç‰¹å’Œç¾å‘³ï¼›ä¸ºäº†èƒå–å‡ºå•¤é…’èŠ±çš„é¦™å‘³å’Œé£å‘³ï¼Œéœ€è¦éå¸¸å°å¿ƒåœ°å¤„ç†ï¼Œå¦‚æœèŠ±å¾ˆé•¿æ—¶é—´è¿›è¡Œç…®æ²¸ï¼Œå°†å¤±å»å®ƒä»¬ç‹¬ç‰¹çš„ç‰¹æ€§</p><p>ä¹Ÿæœ‰ä¸€äº›ç§ç±»çš„å•¤é…’èŠ±å…·æœ‰ç±»ä¼¼çš„ Î± é…¸å’Œç²¾æ²¹ç‰¹æ€§ï¼Œä½¿è¿™ä¸¤ç§ç‰¹æ€§äº’ç›¸å¹³è¡¡</p><p>ä½ ä¸èƒ½å¿˜è®°å•¤é…’èŠ±çš„ä¸»è¦ç”¨é€”ï¼Œå®ƒæ˜¯å•¤é…’çš„é˜²è…å‰‚ï¼Œå®ƒä»¬çš„æŠ—èŒèƒ½åŠ›å¯ä»¥é˜²æ­¢äº§å“åœ¨æ²¡æœ‰ä»»ä½•å†·è—æ‰‹æ®µçš„æƒ…å†µä¸‹è¿‡å¿«å˜è´¨ï¼›æˆ‘ä»¬ç°åœ¨æœ‰æ›´å¥½çš„æ–¹æ³•æ¥ä¿å­˜å•¤é…’ï¼Œä½†è¿™å¹¶ä¸é‡è¦ï¼Œå•¤é…’èŠ±å·²ç»æˆä¸ºé…¿é€ è¿‡ç¨‹ä¸­å¿…ä¸å¯å°‘çš„åŸºç¡€ï¼›å¾ˆéš¾ç›¸ä¿¡å•¤é…’èŠ±å¹¶ä¸æ˜¯è‡ªå•¤é…’é…¿é€ å†å²å¼€å§‹å°±è¢«ä½¿ç”¨</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/Why-are-hops-added-to-beer.jpg" class=""><h2 id="æœ‰è¶£å°çŸ¥è¯†"><a href="#æœ‰è¶£å°çŸ¥è¯†" class="headerlink" title="æœ‰è¶£å°çŸ¥è¯†"></a>æœ‰è¶£å°çŸ¥è¯†</h2><ul><li>å•¤é…’èŠ±æ¤ç‰©é›„æ ªä¸äº§ç”Ÿä¸ºå•¤é…’æä¾›ç‹¬ç‰¹é£å‘³å’Œé¦™æ°”æ‰€éœ€çš„ç²¾æ²¹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå•¤é…’èŠ±å†œåœºåªä½¿ç”¨é›Œæ ª</li><li>å•¤é…’èŠ±å®¶æ—å’Œå¤§éº»åŒå±åŒä¸€ç§‘ï¼šå¤§éº»ç§‘ï¼ˆCannabaceaeï¼‰ï¼›æ­£å› å¦‚æ­¤å¦‚æœå–å¤ªå¤šçš„è¯ï¼Œå•¤é…’ä¼šè®©ä½ æµå£æ°´æ˜¯å¯ä»¥ç†è§£çš„ï¼ˆå•¤é…’èŠ±çš„æ±‰è¯­è¢«ç¿»è¯‘ä¸ºè›‡éº»ï¼Œè¯‘è€…è¿™ä¹ˆç¿»è¯‘çš„åŸå› è‚¯å®šæ˜¯å› ä¸ºåˆ†ç±»å­¦ï¼›å½“ç„¶è¿™é‡Œåº”è¯¥æ˜¯ä½œè€…çš„ç©ç¬‘ï¼Œè¡¨è¾¾çš„æ˜¯å¯¹å•¤é…’çš„å–œçˆ±ï¼Œå•¤é…’èŠ±é‡Œæ˜¯æ²¡æœ‰å››æ°¢å¤§éº»é…šçš„ï¼‰</li><li>ç½—é©¬äººè¿‡å»æŠŠå•¤é…’èŠ±åšæˆæ²™æ‹‰é£Ÿç”¨ï¼Œå°±åƒç°åœ¨äººä»¬åƒèŠ¦ç¬‹çš„æ–¹å¼ä¸€æ ·</li><li>ä½ å¯ä»¥ç»™é¸¡å–‚é£Ÿå•¤é…’èŠ±ï¼Œå•¤é…’èŠ±é€‚åˆå®ƒä»¬çš„æ¶ˆåŒ–ç³»ç»Ÿï¼Œå¯ä»¥é˜²æ­¢ç»†èŒè¿›å…¥è‚ é“ï¼›ä½†æ˜¯å•¤é…’èŠ±å¹¶ä¸é€‚åˆçŒ«å’Œç‹—ï¼Œå¯èƒ½å¯¹å…¶æœ‰æ¯’ï¼Œå¯¼è‡´è¿™äº›å® ç‰©é«˜çƒ§ç”šè‡³æ­»äº¡ï¼›å› æ­¤ï¼Œå¦‚æœä½ å®¶é‡Œæœ‰å® ç‰©ï¼Œè¯·ç¡®ä¿å•¤é…’èŠ±åŸæ–™è¿œç¦»å®ƒä»¬</li><li>å•¤é…’ï¼ˆbeerï¼‰å’Œè‰¾å°”å•¤é…’ï¼ˆaleï¼‰ä¹‹é—´çš„åŒºåˆ«ä¸€ç›´å­˜åœ¨ç€ä¸€åœºæˆ˜äº‰ï¼Œå½“å•¤é…’èŠ±å¼€å§‹æˆä¸ºé…¿é€ è¿‡ç¨‹ä¸­çš„ä¸€ç§åŸºæœ¬åŸæ–™æ—¶ï¼Œé…¿é…’å¸ˆå¼€å§‹å°†åŠ äº†å•¤é…’èŠ±çš„å•¤é…’ç§°ä¸º beerï¼Œè€Œ ale ç§°å‘¼çš„å°±æ˜¯ä¸å«å•¤é…’èŠ±çš„äº§å“ï¼›ä¸€äº›å›½å®¶ç¦æ­¢åœ¨é…¿é€ è¿‡ç¨‹ä¸­ä½¿ç”¨å•¤é…’èŠ±ï¼Œåœ¨äº¨åˆ©å…­ä¸–ï¼ˆHenry VIï¼‰çš„å¹²é¢„ä¸‹ï¼Œä»–å–œæ¬¢å–åŠ äº†å•¤é…’èŠ±çš„å•¤é…’ï¼Œå•¤é…’èŠ±æ‰æˆä¸ºäº†é…¿é€ ä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</li></ul><h1 id="å•¤é…’å’Œå•¤é…’èŠ±çš„åŒ–å­¦"><a href="#å•¤é…’å’Œå•¤é…’èŠ±çš„åŒ–å­¦" class="headerlink" title="å•¤é…’å’Œå•¤é…’èŠ±çš„åŒ–å­¦"></a>å•¤é…’å’Œå•¤é…’èŠ±çš„åŒ–å­¦</h1><h2 id="ä»€ä¹ˆæ˜¯-hop-harvest"><a href="#ä»€ä¹ˆæ˜¯-hop-harvest" class="headerlink" title="ä»€ä¹ˆæ˜¯ hop harvest"></a>ä»€ä¹ˆæ˜¯ hop harvest</h2><p>å•¤é…’èŠ±å¿…é¡»åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ”¶è·ï¼Œä¸€ç³»åˆ—å› ç´ å†³å®šäº†ä»€ä¹ˆæ˜¯é€‚åˆæ”¶è·çš„å­£èŠ‚ï¼Œä¾‹å¦‚çƒæœæˆç†Ÿåº¦å’Œæ°´åˆ†å«é‡ã€å¤©æ°”æ¡ä»¶å’Œå•¤é…’èŠ±ç”Ÿé•¿è¿‡ç¨‹ä¸­çš„è™«å®³å‹åŠ›ç­‰ç­‰ï¼›ä¸€å¹´ä¸­æ”¶è·å•¤é…’èŠ±çš„æœ€ä½³æ—¶é—´æ˜¯ç§‹å­£ï¼Œå³ 8 æœˆä¸‹æ—¬å’Œ 9 æœˆå¤§éƒ¨åˆ†æ—¶é—´</p><p>å·²æœ‰ç§‘å­¦ç ”ç©¶è¡¨æ˜ï¼Œé‡‡æ”¶æ—¥æœŸå¯¹å•¤é…’èŠ±å“è´¨æœ‰ç€é‡è¦å½±å“ï¼Œæ¨è¿Ÿæ”¶è·å¯èƒ½è¢«è¯¯è®¤ä¸ºä¼šè·å¾—æ›´å¥½çš„æ”¶ç›Šï¼Œä½†äº‹å®è¯æ˜å•¤é…’èŠ±å¯èƒ½ä¼šå¤±å»éƒ¨åˆ†ç‰¹æœ‰çš„é¦™æ°”ï¼Œä¹Ÿä¼šç¼©çŸ­å®ƒä»¬çš„å­˜å‚¨å¯¿å‘½ï¼Œæ°§åŒ–å¯èƒ½ä¼šåŠ é€Ÿæœ€ç»ˆå¯¼è‡´å•¤é…’èŠ±çš„æŒ¥å‘æ€§é¦™å‘³æ¶ˆå¤±</p><p>å¦ä¸€æ–¹é¢ï¼Œè¿‡æ—©æ”¶è·ä¼šé™ä½é£å‘³å¹¶ä¼šé™ä½æœªæ¥æ”¶è·å­£èŠ‚çš„äº§é‡ï¼›åœ¨æœ‰å¤§é‡å•¤é…’èŠ±å†œåœºçš„åœ°åŒºï¼Œä»–ä»¬è®¡ç®—å‡ºå½“çƒæœè¾¾åˆ° dry matter çš„ 23% æ—¶æ˜¯é€‚åˆçš„æ”¶è·æ—¶é—´ï¼›æ ¹æ®å•¤é…’èŠ±çš„ç§ç±»å’Œç¯å¢ƒæ¡ä»¶çš„ä¸åŒï¼Œå•¤é…’èŠ±ç§æ¤æˆ·æ¯ 4 åˆ° 7 å¤©å°±ä¼šå¢åŠ  1% çš„ dry matter</p><p>å•¤é…’èŠ±ä¸Šçš„ä¸€äº›æ˜æ˜¾å˜åŒ–å°†æä¾›çº¿ç´¢è¯´æ˜æ˜¯å¦å‡†å¤‡å¥½æ”¶å‰²ï¼Œä¾‹å¦‚èŠ±æœµä»ç»¿è‰²å˜ä¸ºç•¥å¸¦é»„è‰²çš„ç¾Šçš®çº¸è´¨åœ°ã€è›‡éº»ç´ è…ºä¹Ÿä»æµ…é»„è‰²å˜ä¸ºæ·±é»„è‰²æ¥è¿‘æ©™è‰²ï¼›æ”¶è´§æ—¶ï¼Œéœ€è¦ç¡®ä¿çƒæœæ²¡æœ‰å®Œå…¨å˜ä¸ºè¤è‰²</p><h2 id="ä»€ä¹ˆè®©å•¤é…’èŠ±å‘³é“å¦‚æ­¤ä¸åŒ"><a href="#ä»€ä¹ˆè®©å•¤é…’èŠ±å‘³é“å¦‚æ­¤ä¸åŒ" class="headerlink" title="ä»€ä¹ˆè®©å•¤é…’èŠ±å‘³é“å¦‚æ­¤ä¸åŒ"></a>ä»€ä¹ˆè®©å•¤é…’èŠ±å‘³é“å¦‚æ­¤ä¸åŒ</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œå•¤é…’èŠ±çš„ä¸åŒé£å‘³å’Œé¦™æ°”ä¸»è¦å–å†³äºå®ƒä»¬ç”Ÿé•¿çš„åœ°æ–¹ï¼Œä¸åŒçš„å¤©æ°”æ¡ä»¶ã€åœŸå£¤å’Œç§æ¤æ–¹å¼ä¼šä»¥ä¸åŒçš„å½¢å¼æœ€ç»ˆå½±å“å•¤é…’èŠ±çš„ç‰¹æ€§</p><p>æ­¤å¤–ï¼Œæ”¶è·çš„æ—¶é—´ä¹Ÿå¯èƒ½ä¼šå½±å“å•¤é…’èŠ±çš„é£å‘³å’Œé¦™æ°”</p><p>å¦ä¸€ä¸ªå…³äºå‘³é“çš„é‡è¦å› ç´ æ˜¯æ¯ç§å•¤é…’èŠ±ä¸­çš„ Î± é…¸å’Œç²¾æ²¹çš„å«é‡ï¼›å®ƒä»¬ä¸­çš„å¤§å¤šæ•°åœ¨å…¶å«é‡ä¸Šæœ‰æ‰€å·®å¼‚ï¼Œä½†åªæœ‰å°‘æ•°å“ç§çš„å•¤é…’èŠ±å…·æœ‰è¿™äº›ç‰©è´¨çš„å¹³è¡¡ï¼Œè¿™ä½¿å®ƒä»¬å˜å¾—è‹¦æ¶©ï¼Œä½†å……æ»¡ç‹¬ç‰¹çš„å‘³é“</p><p>Î± é…¸æ‰€å çš„æ¯”é‡ï¼Œé€šå¸¸åœ¨ 2% è‡³ 19% ä¹‹é—´ï¼›æ¬§æ´²äººå¯¹å•¤é…’èŠ±æ›´æ„Ÿå…´è¶£ï¼Œå®ƒä»¬çš„å•¤é…’èŠ±å«æœ‰ 5% è‡³ 9% çš„ Î± é…¸ï¼›Dual-compound å•¤é…’èŠ±åœ¨æ¬§æ´²æ›´ä¸ºå¸¸è§ï¼›åŒæ—¶ï¼Œç¾å›½å•¤é…’èŠ±å“ç§çš„ Î± é…¸å«é‡è¾ƒé«˜ï¼Œåœ¨ 8% è‡³ 19% ä¹‹é—´ï¼Œè¿™ä¼šä½¿å¾—è¿™äº›å•¤é…’èŠ±æ›´è‹¦</p><h2 id="å•¤é…’èŠ±çš„å“ç§"><a href="#å•¤é…’èŠ±çš„å“ç§" class="headerlink" title="å•¤é…’èŠ±çš„å“ç§"></a>å•¤é…’èŠ±çš„å“ç§</h2><p>å•¤é…’èŠ±æœ‰å¾ˆå¤šç§ï¼Œä½†å®ƒä»¬éƒ½å¯ä»¥é›†ä¸­åœ¨ä¸‰ç§ç±»å‹ï¼šè´µæ—å•¤é…’èŠ±ï¼ˆNoble Hopsï¼‰ã€ç¾å¼å•¤é…’èŠ±ï¼ˆAmerican Hopsï¼‰å’Œè‹±å¼å•¤é…’èŠ±ï¼ˆEnglish Hopsï¼‰</p><p>è´µæ—å•¤é…’èŠ±æ¥è‡ªå¾·å›½å’Œæ·å…‹å…±å’Œå›½ï¼Œè¢«è®¤ä¸ºæ˜¯æœ€ç»å…¸çš„å•¤é…’èŠ±ç±»å‹ï¼›å…¶ä¸­åŒ…æ‹¬ Saaz å’Œ Tettnanger ç­‰å“ç§ï¼Œè¿™äº›ç±»å‹çš„å•¤é…’èŠ±å«æœ‰è¾ƒå°‘çš„ Î± é…¸ï¼Œå¹¶å«æœ‰é«˜æ°´å¹³çš„è›‡éº»çƒ¯ç²¾æ²¹</p><p>ç¾å¼å•¤é…’èŠ±å¾€å¾€æ›´å¤§èƒ†ï¼Œè€Œä¸”é¦™å‘³æ›´åŠ æ˜æ˜¾ï¼›å®ƒä»¬å«æœ‰å¤§é‡çš„æœˆæ¡‚çƒ¯ç²¾æ²¹ï¼Œè¿™ä½¿å®ƒä»¬æ•£å‘å‡ºæ¾æ ‘å’ŒæŸ‘æ©˜çš„é¦™å‘³ï¼Œå¯ä»¥å°† Cascade å’Œ Centennial å“ç§åˆ†ç±»åœ¨è¿™ä¸€ç±»åˆ«</p><p>æœ€åï¼Œè‹±å¼å•¤é…’èŠ±æ›´åŠ ç²¾è‡´å¾®å¦™ï¼›å®ƒä»¬çš„æœˆæ¡‚çƒ¯å«é‡å¾ˆä½ï¼Œè¿™èµ‹äºˆäº†å®ƒä»¬æ³¥åœŸã€æœ¨è´¨ã€è‰æœ¬ç­‰å‘³é“ï¼›ä¸è´µæ—å•¤é…’èŠ±å’Œç¾å¼å•¤é…’èŠ±ç›¸æ¯”ï¼Œè‹±å¼å•¤é…’èŠ±åªä½¿ç”¨åœ¨ä¸–ç•Œå„åœ°å°‘é‡çš„å•¤é…’å“ç§ï¼Œä½†å®ƒä»¬å¯¹é…¿é€ è‹±å¼å•¤é…’è‡³å…³é‡è¦</p><h2 id="æ·»åŠ çš„æ—¶æœº"><a href="#æ·»åŠ çš„æ—¶æœº" class="headerlink" title="æ·»åŠ çš„æ—¶æœº"></a>æ·»åŠ çš„æ—¶æœº</h2><p>é€šå¸¸é…¿é…’å¸ˆåœ¨ç³–åŒ–ååŠ å…¥å•¤é…’èŠ±ï¼Œè¿™æ˜¯è°·ç‰©ä»éº¦èŠ½å˜æˆéº¦èŠ½æ±åï¼Œéœ€è¦å¼€å§‹è¿›è¡Œç…®æ²¸çš„æ—¶å€™</p><p>å½“å•¤é…’èŠ±å’Œéº¦èŠ½æ±ä¸€èµ·ç…®æ²¸æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªå«åšå¼‚æ„åŒ–ï¼ˆisomerisationï¼‰çš„è¿‡ç¨‹ï¼›è¿™ä¸ªæ“ä½œä¼šå°† Î± é…¸è½¬åŒ–ä¸º å¼‚æ„çš„ Î± é…¸ï¼ˆiso-alpha acidsï¼‰ï¼›è¿™ä¸€è¿‡ç¨‹ä½¿æœ€ç»ˆäº§ç‰©äº§ç”Ÿè‹¦å‘³ï¼Œå•¤é…’èŠ±ç…®æ²¸çš„æ—¶é—´è¶Šä¹…ï¼Œå•¤é…’å°±ä¼šè¶Šè‹¦ï¼Œæ‰€ä»¥ä¸€èˆ¬å»ºè®®å•¤é…’èŠ±çš„ç…®æ²¸æ—¶é—´ä¸è¶…è¿‡ 45 åˆ†é’Ÿ</p><p>å¦‚æœä½ æƒ³æ›´ä¸“æ³¨äºå•¤é…’èŠ±é£å‘³ï¼Œä½ å¿…é¡»å‡å°‘å…¶ç…®æ²¸æ—¶é—´ï¼›ç¨ååŠ å…¥å•¤é…’èŠ±ï¼Œè®©å®ƒä»¬æ²¸è…¾çš„æ—¶é—´åœ¨ 15 åˆ†é’Ÿåˆ° 30 åˆ†é’Ÿä¹‹é—´</p><p>å¦‚æœå•¤é…’èŠ±çš„é¦™æ°”æ›´é‡è¦ï¼Œé‚£ä¹ˆæœ€å¥½åœ¨æœ€ååŠ å…¥ï¼Œç…®æ²¸æ—¶é—´ä¸è¶…è¿‡ 5 åˆ†é’Ÿ</p><p>ä¸€äº›é…¿é…’å¸ˆç”šè‡³åœ¨å‘é…µè¿‡ç¨‹ä¸­å†åŠ å…¥å•¤é…’èŠ±ï¼Œè¿™ç§åšæ³•è¢«ç§°ä¸ºå¹²æŠ•ï¼ˆdry hoppingï¼‰ï¼ŒåŒ…æ‹¬åœ¨éº¦èŠ½æ±å†·å´åå°†å•¤é…’èŠ±æµ¸æ³¡å…¶ä¸­ï¼›è¿™ç§æ–¹æ³•å¯èƒ½éœ€è¦å‡ å¤©ç”šè‡³å‡ å‘¨çš„æ—¶é—´ï¼Œä½†å¹¶ä¸æ˜¯æ¯ä¸ªäººéƒ½è®¤ä¸ºè¿™ç§åšæ³•èµ·åˆ°äº†å®è´¨æ€§ä½œç”¨ï¼ˆä¸ªäººè®¤ä¸ºï¼Œå¹²æŠ•çš„é—®é¢˜åœ¨äºæˆæœ¬å’Œæ”¶ç›Šä¸æˆæ­£æ¯”ï¼Œåªè¦æˆæœ¬å¤§ä¸€å®šä¼šæœ‰æ”¶ç›Šçš„ï¼‰</p><p>å¯¹äºè‹¦å‘³çš„æµ‹é‡ï¼Œæœ‰ IBUï¼ˆInternational Bitterness Unitï¼‰ è¿™ä¸€å›½é™…ç»Ÿä¸€å•ä½ï¼Œé…¿é…’å¸ˆåœ¨ä½¿ç”¨ Î± é…¸æ—¶åº”ç†Ÿæ‚‰è¿™äº›æµ‹é‡æ–¹æ³•</p><p>å•¤é…’å…¬å¸ä¸€èˆ¬éƒ½æœ‰èƒ½å¤Ÿç²¾ç¡®æµ‹é‡è‹¦åº¦å€¼çš„æœºå™¨ï¼Œå¯¹äºå®¶é…¿è€…ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å…¬å¼å¯¹ IBU è¿›è¡Œè®¡ç®—ï¼ˆ<a href="https://homebrewacademy.com/ibu-calculator/">IBU calculator</a>ï¼‰</p><h1 id="å•¤é…’èŠ±å“ç§å…¥é—¨"><a href="#å•¤é…’èŠ±å“ç§å…¥é—¨" class="headerlink" title="å•¤é…’èŠ±å“ç§å…¥é—¨"></a>å•¤é…’èŠ±å“ç§å…¥é—¨</h1><h2 id="è´µæ—é…’èŠ±ï¼ˆNoble-x2F-Continental-Hopsï¼‰"><a href="#è´µæ—é…’èŠ±ï¼ˆNoble-x2F-Continental-Hopsï¼‰" class="headerlink" title="è´µæ—é…’èŠ±ï¼ˆNoble&#x2F;Continental Hopsï¼‰"></a>è´µæ—é…’èŠ±ï¼ˆNoble&#x2F;Continental Hopsï¼‰</h2><p>è¿™ç§å•¤é…’èŠ±å“ç§çš„å•¤é…’å£æ„Ÿç»†è…»ã€è¾›è¾£ï¼Œå…·æœ‰èŠ±é¦™å’Œæ³¥åœŸå‘³ï¼Œèµ·æºäºä¸­æ¬§ï¼Œä¸»è¦äº§åœ°æ˜¯æ·å…‹å…±å’Œå›½å’Œå¾·å›½ï¼Œå®ƒä»¬çš„æ‹‰æ ¼ï¼ˆlagersï¼‰å’Œçš®å°”æ£®ï¼ˆpilsnersï¼‰å•¤é…’å…·æœ‰æ ‡å¿—æ€§çš„é£å‘³ç‰¹å¾ï¼Œè¦å½’åŠŸäºè¿™ç§å•¤é…’èŠ±å“ç§å«æœ‰é«˜æ¯”ä¾‹çš„çš„è›‡éº»çƒ¯ç²¾æ²¹ï¼ˆessential oil humuleneï¼‰</p><p>é…¿é…’å¸ˆå°†å…¶æè¿°ä¸ºè¾›è¾£ã€è¯è‰ã€è‰æœ¬ã€èŠ±é¦™ã€é»‘èƒ¡æ¤’ç­‰å‘³é“ï¼›å››ç§ Î± é…¸å«é‡ä½çš„è´µæ—å“ç§è¢«è®¤ä¸ºæ˜¯ä¼ ç»Ÿå“ç§ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å¾·å›½ - æ–¯æ´¾å°”ç‰¹ï¼ˆGerman Spaltï¼‰</li><li>å¾·å›½ - å“ˆæ‹‰é“ï¼ˆGerman Hallertauï¼‰</li><li>å¾·å›½ - æ³°ç‰¹æ˜‚ï¼ˆGerman Tettnangï¼‰</li><li>å¾·å›½ - èµ«æ–¯å¸ƒé²å…‹ï¼ˆCzech Hersbruckerï¼‰</li><li>æ·å…‹ - è¨å…¹ï¼ˆCzech Saazï¼‰</li></ul><p>é…¿é…’å¸ˆé€šå¸¸ä½¿ç”¨è¿™äº›å…·æœ‰è¾›è¾£ã€å¹³ç¨³çš„è‹¦å‘³å’ŒèŠ±é¦™çš„å•¤é…’èŠ±æ¥åˆ¶ä½œä½ IBU çš„å•¤é…’ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Bohemian Pilsner Urquell</li><li>Samuel Adams Noble Pils</li><li>Trumer Pils</li><li>Czech Saaz characteristics</li></ul><h2 id="è‹±å¼é…’èŠ±ï¼ˆEnglish-Hopsï¼‰"><a href="#è‹±å¼é…’èŠ±ï¼ˆEnglish-Hopsï¼‰" class="headerlink" title="è‹±å¼é…’èŠ±ï¼ˆEnglish Hopsï¼‰"></a>è‹±å¼é…’èŠ±ï¼ˆEnglish Hopsï¼‰</h2><p>è¿™ç§ç±»å‹çš„å•¤é…’èŠ±ç”± 15 ä¸–çºªçš„æ³•å…°å¾·æ–¯ï¼ˆFlandersï¼‰å¼€å§‹è¿›å£ï¼Œå› ä¸ºå…·æœ‰ä¼˜è‰¯çš„é˜²è…ç‰¹è´¨å¯ä»¥å¸®åŠ©å•¤é…’ä¿æŒé•¿ä¹…çš„æ–°é²œ</p><p>è‹±å¼é…’èŠ±ç±»ä¼¼äºæ¬§æ´²çš„å“ç§ï¼Œä½†å…·æœ‰æ›´å¤šçš„æœ¨è´¨ã€è¾›è¾£ã€æ°´æœå‘³å’Œæ³¥åœŸå‘³ï¼Œä»¥åŠè¾ƒä½çš„æœˆæ¡‚çƒ¯å«é‡</p><p>é…¿é…’å¸ˆå°†è¿™äº›å•¤é…’èŠ±æè¿°ä¸ºæ³¥åœŸã€é¦™è‰ã€èŠ±é¦™ã€è‰æœ¬å’Œæ°´æœï¼Œæœ€å¸¸è§çš„ç±»å‹æœ‰ï¼š</p><ul><li>ç¦æ ¼ï¼ˆFuggleï¼‰</li><li>ä¸œè‚¯ç‰¹éƒ¡å¤ä¸ï¼ˆEast Kent Goldingï¼‰</li><li>æœåœ£è€…ï¼ˆPilgrimï¼‰</li><li>åå­—ç‡•é›€ï¼ˆBramling Crossï¼‰</li><li>å¡”å‰ç‰¹ï¼ˆTargetï¼‰</li><li>æŒ‘æˆ˜è€…ï¼ˆChallengerï¼‰</li></ul><p>é…¿é…’å¸ˆå°†é€‰æ‹©è¿™ç§å•¤é…’èŠ±å“ç§æ¥é…¿é€ ä»¥ä¸‹é£æ ¼ï¼š</p><ul><li>Peterâ€™s Best Bitter</li><li>Abbot Ale</li><li>Spitfireâ€™s Amber Kentish Ale</li><li>Timothy Taylor Landlord</li></ul><h2 id="ç¾å¼é…’èŠ±ï¼ˆAmerican-Hopsï¼‰"><a href="#ç¾å¼é…’èŠ±ï¼ˆAmerican-Hopsï¼‰" class="headerlink" title="ç¾å¼é…’èŠ±ï¼ˆAmerican Hopsï¼‰"></a>ç¾å¼é…’èŠ±ï¼ˆAmerican Hopsï¼‰</h2><p>è¿™ç§é…’èŠ±å“ç§ä½“ç§¯å¤§ã€æ›´è‹¦ã€ç‰¹ç‚¹é²œæ˜ï¼Œä½ å¯ä»¥åœ¨å¸‚åœºä¸Šæ‰¾åˆ°è¶…è¿‡ 50 ç§ä¸åŒçš„å“ç§</p><p>å¤§å¤šæ•°ç¾å›½é…¿é…’å¸ˆéƒ½ä½¿ç”¨å®ƒä»¬æ¥é…¿é€ å¸¦æœ‰æ ‘è„‚ã€æ¾è„‚å’ŒæŸ‘æ©˜å‘³çš„æµ…è‰²å•¤é…’</p><p>åŸºæœ¬ä¸Šè¿™äº›éå¸¸èŠ³é¦™çš„æ¤ç‰©æ˜¯å‡ ä¹æ‰€æœ‰ç¾å¼ IPA ï¼ˆAmerican IPAï¼‰çš„æ ‡å¿—ï¼Œèµ‹äºˆå®ƒä»¬æ˜æ˜¾çš„é¦™å‘³å’Œè‹¦å‘³ï¼›é…¿é…’å¸ˆé€šå¸¸å¯¹è¿™ç§å•¤é…’èŠ±å“ç§çš„æè¿°åŒ…æ‹¬çƒ­å¸¦æ°´æœã€æŸ‘æ©˜ã€è‘¡è„æŸšã€è¾›è¾£ã€æ ‘è„‚å’Œæ¾è„‚ï¼Œæœ€å—æ¬¢è¿çš„ç¾å›½å•¤é…’èŠ±åˆ—è¡¨åŒ…æ‹¬è‘—åçš„å››ä¸ª Cï¼š</p><ul><li>å¥‡åŠªå…‹ï¼ˆChinookï¼‰</li><li>å¡æ–¯å¡ç‰¹ï¼ˆCascadeï¼‰</li><li>å“¥ä¼¦å¸ƒï¼ˆColumbusï¼‰</li><li>ä¸–çºªï¼ˆCentennialï¼‰</li></ul><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´åå‘æ°´æœé£å‘³çš„å“ç§ï¼š</p><ul><li>è¥¿æ¥šï¼ˆCitraï¼‰</li><li>è¥¿å§†ç§‘ï¼ˆSimcoeï¼‰</li><li>äºšéº»é»„ï¼ˆAmarilloï¼‰</li></ul><p>è®¸å¤šç¾å›½äººå–œæ¬¢å››ç§ C é…¿é€ çš„å•¤é…’ï¼Œç‰¹åˆ«æ˜¯ï¼š</p><ul><li>Racer 5 IPA</li><li>Sierra Nevada Pale Ale</li><li>Amber IPA</li><li>American West Coast IPA</li><li>Ranger IPA</li></ul><h2 id="æ–°ä¸–ç•Œé…’èŠ±ï¼ˆNew-World-Hopsï¼‰"><a href="#æ–°ä¸–ç•Œé…’èŠ±ï¼ˆNew-World-Hopsï¼‰" class="headerlink" title="æ–°ä¸–ç•Œé…’èŠ±ï¼ˆNew World Hopsï¼‰"></a>æ–°ä¸–ç•Œé…’èŠ±ï¼ˆNew World Hopsï¼‰</h2><p>å°½ç®¡è¿™äº›å•¤é…’èŠ±æ¥è‡ªä¸–ç•Œå„åœ°ï¼Œä½†å®ƒä»¬éƒ½å…·æœ‰ç›¸åŒçš„çƒ­å¸¦æ°´æœå’ŒæŸ‘æ©˜é£å‘³ï¼Œç°åœ¨æœ€æµè¡Œçš„æ˜¯ï¼š</p><ul><li>è¥¿æ¥šï¼ˆCitraï¼‰ï¼šæ¥è‡ªç¾å›½ï¼Œå¸¦æœ‰æŸ‘æ©˜ã€æŸ æª¬ã€è èå’ŒèŠ’æœå‘³é“</li><li>åŸƒå°”å¾·æ‹‰å¤šï¼ˆEl Doradoï¼‰ï¼šæ¥è‡ªç¾å›½ï¼Œå¸¦æœ‰ç”œç“œã€è èç­‰å‘³é“</li><li>äºšéº»é»„ï¼ˆAmarilloï¼‰ï¼šæ¥è‡ªç¾å›½ï¼Œå¸¦æœ‰æŸ‘æ©˜å’Œæ©™å­å‘³é“</li><li>é©¬èµ›å…‹ï¼ˆMosaicï¼‰ï¼šè¿™ç§ç¾å›½å•¤é…’èŠ±å¸¦æœ‰ç™¾é¦™æœã€æµ†æœã€æŸ‘æ©˜ã€èŠ’æœç­‰å‘³é“ï¼Œè¿˜æœ‰ç‹¬ç‰¹çš„ç³–æœæ„Ÿè§‰</li><li>é“¶æ²³ï¼ˆGalaxyï¼‰ï¼šæ¥è‡ªæ¾³å¤§åˆ©äºšï¼Œå¸¦æœ‰æŸ‘æ©˜ã€çƒ­å¸¦æ°´æœç­‰é£å‘³</li><li>è«å›¾ä¼Šå¡ï¼ˆMotuekaï¼‰ï¼šæ¥è‡ªæ–°è¥¿å…°ï¼Œå…·å¤‡çƒ­å¸¦æ°´æœã€æŸ æª¬ç­‰é£å‘³</li></ul><p>ä½¿ç”¨è¿™äº›å•¤é…’èŠ±çš„å•¤é…’å¾ˆæµè¡Œï¼Œä½ åº”è¯¥è¯•è¯•ï¼š</p><ul><li>Hazy IPA</li><li>NEIPA</li><li>Feral Biggie Juice</li></ul><p>å¦‚ä»Šå…¨çƒå¸‚åœºä¸Šå¯ç”¨çš„å•¤é…’èŠ±ç±»å‹å‡ ä¹æ— ç©·æ— å°½ï¼›ä¸€äº›æ•°æ®ä¼°è®¡ï¼Œé…¿é€ äº§ä¸šç§æ¤äº† 120 ç§ä¸åŒçš„å•¤é…’èŠ±ï¼Œç”šè‡³è¿˜æœ‰æ›´å¤šçš„å®éªŒå“ç§æˆ–è®¸å¾ˆå¿«å°±ä¼šè¿›å…¥å¸‚åœº</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/American-hops.jpg" class=""><h1 id="å•¤é…’èŠ±çš„é£å‘³"><a href="#å•¤é…’èŠ±çš„é£å‘³" class="headerlink" title="å•¤é…’èŠ±çš„é£å‘³"></a>å•¤é…’èŠ±çš„é£å‘³</h1><blockquote><p>When I read descriptions with flowery language, I find it not just uselessâ€”but sometimes misleading. </p></blockquote><p>é¦–å…ˆï¼Œå•¤é…’èŠ±çš„å‘³é“å’Œé¦™æ°”æå…¶å¤æ‚ï¼Œå³ä½¿æ˜¯åœ¨ä¸€ä¸ªå“ç§ä¸­ï¼Œä¸åŒå“è´¨çš„è¡¨è¾¾ä¹Ÿå¯èƒ½æ˜¯ä¸‡èŠ±ç­’ï¼Œä¹Ÿå–å†³äºå•¤é…’èŠ±çš„ä½¿ç”¨æ–¹å¼ä»¥åŠä¸å…¶ä»–å“ç§çš„ç»„åˆï¼›åœ¨æ—©äº›å¹´ï¼Œè¯†åˆ«å‡ºè®¸å¤šé¥®é…’è€…ç†Ÿæ‚‰çš„ä¸»åŠ›å“ç§ï¼ˆCascade - å¡æ–¯å¡ç‰¹ã€Chinook - å¥‡åŠªå…‹ï¼‰å°±è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å¦‚ä»Šå·²ç»æ— æ³•æ»¡è¶³ç°çŠ¶ï¼Œé‚£ä¹ˆå•¤é…’å‚è¯¥å¦‚ä½•ä¼ è¾¾å•¤é…’çš„å‘³é“å‘¢ï¼Ÿ</p><p>å…¶æ¬¡ï¼Œå¦‚æœç›´æ¥é™ˆåˆ—å‡ºå‘³é“å’Œé¦™æ°”å¯èƒ½ä¼šè¿‡äºæŠ½è±¡ï¼Œä½†å¦‚æœä½¿ç”¨ â€œæ¤°å­â€ æ¥è¿›è¡Œæè¿°ï¼Œæ˜¯æˆ‘ä»¬éƒ½å¯ä»¥ç†è§£çš„è¡¨è¾¾</p><p>ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼ŒBarth-Hass å…¬å¸çš„ Georg Drexler ä¸ä¸€ä½é¦™æ°´åˆ¶é€ å•†åˆä½œï¼Œæå‡ºäº†ä¸€ä¸ªå•¤é…’èŠ±é£å‘³çš„åˆ†ç±»æ³•ï¼Œæè¿°è¿™é¡¹ç ”ç©¶çš„å­¦æœ¯è®ºæ–‡å°šæœªå…¬å¼€ï¼Œä½† Milk The Funk å‘å¸ƒäº† Drexler çš„åˆ†ç±»æ–¹æ³•</p><p>ä¸‹é¢æ˜¯ä»–æå‡ºçš„å‡ ä¸ªç±»åˆ«ï¼Œä¹Ÿé™„å¸¦äº†æ‹¥æœ‰è¿™ç§é£å‘³ã€è¡¨è¾¾æ¯”è¾ƒæ˜æ˜¾çš„å•¤é…’èŠ±å“ç§ï¼ˆæ‹¬å·å†…ï¼‰</p><ul><li><strong>èŠ±é¦™ï¼ˆ<em>Ella</em>ï¼‰</strong>ï¼šæ¥éª¨æœ¨èŠ±ã€æ´‹ç”˜èŠèŠ±ã€å±±è°·ç™¾åˆã€èŒ‰è‰èŠ±ã€è‹¹æœèŠ±ã€ç«ç‘°ã€å¤©ç«ºè‘µã€åº·ä¹ƒé¦¨ã€ä¸é¦™ã€è–°è¡£è‰</li><li><strong>æŸ‘æ©˜ï¼ˆ<em>Mandarina Bavaria</em>ï¼‰</strong>ï¼šè‘¡è„æŸšã€æ©™å­ã€é’æŸ ã€æŸ æª¬ã€ä½›æ‰‹æŸ‘ã€æŸ æª¬è‰ã€å§œã€æ©˜å­</li><li><strong>ç”œæ°´æœï¼ˆ<em>Mosaic</em>ï¼‰</strong>ï¼šé¦™è•‰ã€è¥¿ç“œã€èœœç“œã€æ¡ƒå­ã€æå­ã€ç™¾é¦™æœã€è”æã€å¹²æœã€æå­ã€è èã€æ¨±æ¡ƒã€çŒ•çŒ´æ¡ƒã€èŠ’æœã€ç•ªçŸ³æ¦´</li><li><strong>ç»¿è‰²æ°´æœï¼ˆ<em>Hallertau Blanc</em>ï¼‰</strong>ï¼šæ¢¨ã€æ˜†æ–¯ã€è‹¹æœã€é¹…è“ã€ç™½è‘¡è„é…’è‘¡è„</li><li><strong>çº¢æµ†æœï¼ˆ<em>Monroe</em>ï¼‰</strong>ï¼šé»‘åŠ ä»‘ã€çº¢åŠ ä»‘ã€è“è“ã€æ ‘è“ã€é»‘è“ã€è‰è“ã€é‡ç”Ÿè‰è“ã€è”“è¶Šè“</li><li><strong>ç„¦ç³–ï¼ˆ<em>Triskel</em>ï¼‰</strong>ï¼šé»„æ²¹ã€å·§å…‹åŠ›ã€é…¸å¥¶ã€èœ‚èœœã€å¥¶æ²¹ã€ç„¦ç³–ã€å¤ªå¦ƒç³–ã€å’–å•¡ï¼Œé¦™è‰ã€å†¬åŠ è±†ï¼ˆTonkaï¼Œé›¶é™µé¦™è±†ï¼Œ<a href="https://www.nosetime.com/xiangshui/116580.html">ç¥–ç›ç‘ é¦¥éƒå…¸è—ç³»åˆ—-æœ«è¯ä¸å†¬åŠ è±†</a>ï¼‰</li><li><strong>æœ¨è´¨ï¼ˆ<em>Relax</em>ï¼‰</strong>ï¼šçƒŸè‰ã€å¹²é‚‘ç™½å…°åœ°ã€æ©¡æœ¨ã€çš®é©ã€åŠåœ†ã€é¦™æ–™ã€æ²¡è¯ã€æ ‘è„‚ã€æ³¥åœŸã€é›ªæ¾ã€æ¾æ ‘</li><li><strong>è–„è·ï¼ˆ<em>Polaris</em>ï¼‰</strong>ï¼šè–„è·ã€æŸ æª¬æ²¹ã€æ¨Ÿè„‘ã€è–„è·é†‡ã€è‘¡è„é…’é…µæ¯</li><li><strong>é¦™è‰ï¼ˆ<em>Columbus</em>ï¼‰</strong>ï¼šçˆ±å¤«èŠã€éƒé‡‘é¦™ã€ç½—å‹’ã€æ¬§èŠ¹ã€é¾™è’¿ã€è³èã€èŒ´é¦™ã€ç™¾é‡Œé¦™ã€è¿·è¿­é¦™ã€é©¬éƒå…°ã€ç»¿èŒ¶ã€çº¢èŒ¶ã€ä¼´ä¾£èŒ¶ã€é¼ å°¾è‰</li><li><strong>è¾›è¾£ï¼ˆ<em>Saazer</em>ï¼‰</strong>ï¼šèƒ¡æ¤’ã€è¾£æ¤’ã€å’–å–±ã€æœæ¾å­ã€èŒ´é¦™ã€è‚‰è±†è”»ã€ç”˜è‰ã€ä¸é¦™ã€ç”Ÿå§œé¢åŒ…ã€èŒ´é¦™ç±½</li><li><strong>é’è‰ï¼ˆ<em>Herkules</em>ï¼‰</strong>ï¼šæ–°é²œåˆ‡å‰²çš„è‰ã€å¹²è‰ã€ç•ªèŒ„å¶ã€é’æ¤’ã€è¨éº»</li><li><strong>æ¤ç‰©ï¼ˆ<em>Summit</em>ï¼‰</strong>ï¼šèŠ¹èœæ±¤ã€èŠ¹èœæ ¹ã€éŸ­èœã€æ´‹è‘±ã€æœé²œè“Ÿã€å¤§è’œã€é‡ç”Ÿå¤§è’œ</li></ul><p><em>PS</em>ï¼šæ¯”è¾ƒå¤šï¼Œé£å‘³æœ¬èº«å°±æ˜¯ä¸€é—¨ç„å­¦ï¼Œå½“ç„¶æœ€æ ‡å¿—çš„çƒ­å¸¦æ°´æœï¼Œç”šè‡³æ˜¯æ ¸æœç­‰è¿˜æ˜¯ä¼šä½“ç°çš„å¾ˆæ˜æ˜¾</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/Hop-Flavor-Wheel-sgn.png" class=""><p>flavor wheel ä¸‹è½½åœ°å€</p><p><a href="https://peertobeer.net/category/beer-downloads/">Downloads Archives - Peer To Beer</a></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://homebrewacademy.com/beer-hops/">Beer Hops: All You Need to Know | Homebrew Academy</a></p><p><a href="https://www.beervanablog.com/beervana/2020/1/5/describing-the-flavor-of-hops">Describing the Flavors of Hops â€” Beervana (beervanablog.com)</a></p><p><a href="https://renegadebrewing.com/hops/">What Are Hops In Beer? (Why Add It?) (renegadebrewing.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç²¾é…¿å•¤é…’ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Guava RateLimiter</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter.html</url>
      
        <content type="html"><![CDATA[<h1 id="é™æµ"><a href="#é™æµ" class="headerlink" title="é™æµ"></a>é™æµ</h1><p>é™æµæ˜¯ä¿æŠ¤é«˜å¹¶å‘ç³»ç»Ÿçš„ä¸‰æŠŠåˆ©å™¨ä¹‹ä¸€ï¼ˆé™æµã€ç¼“å­˜ã€é™çº§ï¼‰ï¼›å…¶ç›®çš„æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®æˆ–è¯·æ±‚è¿›è¡Œé™é€Ÿæˆ–è€…ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„çš„è¯·æ±‚è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡æˆ–è¿›è¡Œæµé‡æ•´å½¢</p><p>é™æµçš„ç±»å‹å¯å¤§è‡´åˆ†ä¸ºï¼š</p><ul><li>é™åˆ¶æ€»å¹¶å‘æ•° - æ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± </li><li>é™åˆ¶ç¬æ—¶å¹¶å‘æ•° - nginx çš„ limitconn æ¨¡å—ã€Java Semaphore é™åˆ¶å¹¶å‘</li><li>é™åˆ¶æ—¶é—´çª—å£å†…çš„å¹³å‡é€Ÿç‡ - Guava çš„ RateLimiter</li><li>å…¶ä»– - æ ¹æ®ç½‘ç»œæµé‡ã€CPU å ç”¨ç‡ã€å†…å­˜å ç”¨ç‡ç­‰ä½œä¸ºæ ‡å‡†æ¥è¿›è¡Œé™æµ</li></ul><h1 id="æ¡¶æ¼-amp-ä»¤ç‰Œæ¡¶"><a href="#æ¡¶æ¼-amp-ä»¤ç‰Œæ¡¶" class="headerlink" title="æ¡¶æ¼ &amp; ä»¤ç‰Œæ¡¶"></a>æ¡¶æ¼ &amp; ä»¤ç‰Œæ¡¶</h1><p>æ¡¶æ¼å’Œä»¤ç‰Œæ¡¶æŒ‡çš„æ˜¯é™æµçš„ä¸¤ç§æ¨¡å‹ï¼Œå…¶ç›®çš„éƒ½æ˜¯é™æµä»¥è¾¾åˆ°é™åˆ¶æ—¶é—´çª—å£å†…çš„å¹³å‡é€Ÿç‡çš„ç›®çš„</p><p>æ¡¶æ¼æ˜¯æ¥æ”¶è¯·æ±‚ï¼Œå¹¶æŒ‰ç…§ä¸€å®šçš„é€Ÿç‡é€šè¿‡è¯·æ±‚</p><p>ä»¤ç‰Œæ¡¶æ˜¯æŒ‰ç…§å›ºå®šçš„é€Ÿç‡ç”Ÿäº§ä»¤ç‰Œï¼Œè¯·æ±‚éœ€è¦è·å–å¯¹åº”çš„ä»¤ç‰Œæ‰èƒ½é€šè¿‡</p><h1 id="RateLimiter"><a href="#RateLimiter" class="headerlink" title="RateLimiter"></a>RateLimiter</h1><p>Guava æ˜¯ Java é¢†åŸŸä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œå®ƒåŒ…å«äº† Google åœ¨ Java é¡¹ç›®ä¸­ä½¿ç”¨ä¸€äº›æ ¸å¿ƒåº“</p><p>å…¶ä¸­å°±æœ‰é™æµç›¸å…³çš„ <code>RateLimiter</code> å·¥å…·ï¼Œåº•å±‚åŸºäºä»¤ç‰Œæ¡¶æ€æƒ³ï¼Œæä¾›äº†å¹³æ»‘çªå‘é™æµï¼ˆSmoothBurstyï¼‰å’Œå¹³æ»‘é¢„çƒ­é™æµï¼ˆSmoothWarmingUpï¼‰å¤šç§å®ç°</p><p>ç±»å›¾å±æ€§å¦‚ä¸‹ï¼š</p><img src="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter/RateLimiter%E7%B1%BB%E5%9B%BE.png" class=""><h2 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h2><p>æœ€ç»ˆçš„å®ç°ç±»éƒ½æ˜¯ <code>SmoothRateLimiter</code> çš„å†…éƒ¨ç±»ï¼Œä½†æ˜¯åˆ›å»ºæ–¹æ³•æ”¾åœ¨äº†æ›´ä¸Šå±‚çš„ <code>RateLimiter</code> ä¸­ï¼ˆå·¥å‚ï¼‰</p><p>è°ƒç”¨ <code>RateLimiter.create()</code> é™æ€æ–¹æ³•è¿›è¡Œåˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NO.1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(<span class="type">double</span> permitsPerSecond)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> create(SleepingStopwatch.createFromSystemTimer(), permitsPerSecond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NO.2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">long</span> warmupPeriod, TimeUnit unit)</span> &#123;</span><br><span class="line">    checkArgument(warmupPeriod &gt;= <span class="number">0</span>, <span class="string">&quot;warmupPeriod must not be negative: %s&quot;</span>, warmupPeriod);</span><br><span class="line">    <span class="keyword">return</span> create(</span><br><span class="line">        SleepingStopwatch.createFromSystemTimer(), permitsPerSecond, warmupPeriod, unit, <span class="number">3.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>SmoothBursty</strong></p><p>å…ˆçœ‹å‚æ•°åˆ—è¡¨ä¸º <code>double permitsPerSecond</code> çš„æ–¹æ³•ï¼Œ<code>SleepingStopwatch.createFromSystemTimer()</code> åˆ›å»ºäº†ä¸€ä¸ª <code>SleepingStopwatch</code> åè°ƒç”¨äº†ä¸‹ä¸€å±‚åˆ›å»ºæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(SleepingStopwatch stopwatch, <span class="type">double</span> permitsPerSecond)</span> &#123;</span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmoothBursty</span>(stopwatch, <span class="number">1.0</span> <span class="comment">/* maxBurstSeconds */</span>);</span><br><span class="line">    rateLimiter.setRate(permitsPerSecond);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SleepingStopwatch</code> çš„ç›®çš„æ˜¯è®°å½•åˆ›å»ºæ—¶é—´å’Œè®¡ç®—ç›¸å¯¹æ—¶é—´ï¼Œæ•´ä¸ª <code>RateLimiter</code> çš„æ—¶é—´éƒ½æ˜¯ç›¸å¯¹åˆ›å»ºæ—¶é—´è€Œè¨€çš„ï¼Œä¹Ÿå°±æ˜¯æ—¶é—´çš„è¿ç®—ä¾èµ– <code>SleepingStopwatch</code> å¯¹è±¡</p><p><code>new SmoothBursty(stopwatch, 1.0)</code> çš„å‚æ•°é™¤äº†æ—¶é—´ç›¸å…³çš„å¯¹è±¡ï¼Œå°±æ˜¯ <code>maxBurstSeconds = 1</code> äº†ï¼Œå¯ä»¥çœ‹å‡ºé»˜è®¤çš„ <code>SmoothBursty</code> å…¶åº”å¯¹çªå‘æµé‡çš„è®¾ç½®æ˜¯å¤šå­˜å‚¨æ—¶é—´ä¸º 1s çš„è®¸å¯</p><p>è€Œåè°ƒç”¨äº† <code>rateLimiter.setRate(permitsPerSecond)</code>ï¼Œè¿™ä¸ªå…ˆæ”¾åœ¨åé¢</p><p><strong>SmoothWarmingUp</strong></p><p>å‚æ•°åˆ—è¡¨ä¸º <code>double permitsPerSecond, long warmupPeriod, TimeUnit unit</code> çš„æ–¹æ³•ï¼Œå…ˆå¯¹å‚æ•°è¿›è¡Œäº†æ ¡éªŒï¼Œéšåä¹Ÿè°ƒç”¨äº†ä¸‹ä¸€å±‚çš„åˆ›å»ºæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(</span></span><br><span class="line"><span class="params">    SleepingStopwatch stopwatch,</span></span><br><span class="line"><span class="params">    <span class="type">double</span> permitsPerSecond,</span></span><br><span class="line"><span class="params">    <span class="type">long</span> warmupPeriod,</span></span><br><span class="line"><span class="params">    TimeUnit unit,</span></span><br><span class="line"><span class="params">    <span class="type">double</span> coldFactor)</span> &#123;</span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmoothWarmingUp</span>(stopwatch, warmupPeriod, unit, coldFactor);</span><br><span class="line">    rateLimiter.setRate(permitsPerSecond);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å’Œ <code>SmoothBursty</code> ç±»ä¼¼ï¼Œå¤šäº† <code>warmupPeriod</code> ç›¸å…³çš„å‚æ•°ï¼Œä¹Ÿæ˜¯ç”¨æ¥å®ç° WarmingUp çš„å…³é”®å‚æ•°</p><p>åé¢ä¹Ÿè°ƒç”¨äº† <code>rateLimiter.setRate(permitsPerSecond)</code></p><h2 id="è®¾ç½®-rate"><a href="#è®¾ç½®-rate" class="headerlink" title="è®¾ç½® rate"></a>è®¾ç½® rate</h2><p>rate çš„è®¾ç½®å…³é”®å‚æ•°æ˜¯ <code>permitsPerSecond</code>ï¼Œè¿™æ˜¯ä½¿ç”¨è€…ä¼ å…¥çš„å‚æ•°ï¼Œä»£è¡¨æ¯ç§’å¸Œæœ›ç”Ÿäº§çš„è®¸å¯æ•°é‡ï¼ˆä¸ä¸€å®šä»£è¡¨ QPSï¼Œå› ä¸ºæ¯æ¬¡è¯·æ±‚è®¸å¯ä¸ä¸€å®šè¯·æ±‚ä¸€ä¸ªï¼‰</p><p>è°ƒç”¨ <code>RateLimiter</code> çš„ <code>setRate</code> æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œåœ¨æ¯æ¬¡åˆ›å»º <code>RateLimiter</code> æ—¶ï¼Œåˆ›å»ºæ–¹æ³•åœ¨å®ä¾‹åŒ–åä¹Ÿä¼šè°ƒç”¨ä¸€æ¬¡è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setRate</span><span class="params">(<span class="type">double</span> permitsPerSecond)</span> &#123;</span><br><span class="line">    checkArgument(</span><br><span class="line">        permitsPerSecond &gt; <span class="number">0.0</span> &amp;&amp; !Double.isNaN(permitsPerSecond), <span class="string">&quot;rate must be positive&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex()) &#123; <span class="comment">// è·å–é”</span></span><br><span class="line">        doSetRate(permitsPerSecond, stopwatch.readMicros());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œéšåè·å–é”è°ƒç”¨ <code>doSetRate</code> æ–¹æ³•ï¼›è¿™é‡Œå¯ä»¥è¿›è¡Œä¸€ä¸ªçŒœæƒ³ï¼Œè®¾ç½® rate å’Œè·å–è®¸å¯ä¿è¯å¹¶å‘çš„é”ä¸€å®šæ˜¯åŒä¸€æŠŠï¼Œçœ‹èµ·æ¥ç»Ÿä¸€å°è£…åˆ°äº† <code>mutex()</code> æ–¹æ³•é‡Œï¼Œè€Œåè°ƒç”¨äº† <code>doSetRate</code></p><p><strong>SmoothRateLimiter çš„ doSetRate</strong></p><p>åœ¨ <code>RateLimiter</code> ä¸­ï¼Œ<code>doSetRate</code> æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œ<code>SmoothRateLimiter </code> è¿›è¡Œäº†å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">long</span> nowMicros)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    resync(nowMicros);</span><br><span class="line">    <span class="type">double</span> <span class="variable">stableIntervalMicros</span> <span class="operator">=</span> SECONDS.toMicros(<span class="number">1L</span>) / permitsPerSecond;</span><br><span class="line">    <span class="built_in">this</span>.stableIntervalMicros = stableIntervalMicros;</span><br><span class="line">    doSetRate(permitsPerSecond, stableIntervalMicros);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè°ƒç”¨ <code>resync</code> æ–¹æ³•é‡æ–°è®¡ç®— <code>this.storedPermits</code> å’Œ <code>this.nextFreeTicketMicros</code> è¿™ä¸¤ä¸ªé‡è¦å±æ€§ï¼›è¿™æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ–¹æ³•ï¼Œåœ¨åç»­æµç¨‹ä¸­ä¼šæœ‰å¤šä¸ªæ“ä½œéƒ½è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå…·ä½“å®ç°åœ¨åé¢è¿›è¡Œåˆ†æ</p><p>æ ¹æ®å‚æ•° <code>permitsPerSecond</code> è®¡ç®—å‡ºä¸€ç§’å†…è®¸å¯ç”Ÿäº§çš„é—´éš”ï¼Œèµ‹å€¼ç»™ <code>this.stableIntervalMicros</code></p><p>ç»§ç»­è°ƒç”¨ <code>doSetRate</code></p><p><strong>SmoothBursty çš„ doSetRate</strong></p><p><code>SmoothRateLimiter</code>  çš„ <code>doSetRate</code> ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œ<code>SmoothBursty </code> è¿›è¡Œäº†å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">double</span> stableIntervalMicros)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">double</span> stableIntervalMicros)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">oldMaxPermits</span> <span class="operator">=</span> <span class="built_in">this</span>.maxPermits;</span><br><span class="line">    maxPermits = maxBurstSeconds * permitsPerSecond;</span><br><span class="line">    <span class="keyword">if</span> (oldMaxPermits == Double.POSITIVE_INFINITY) &#123;</span><br><span class="line">        <span class="comment">// if we don&#x27;t special-case this, we would get storedPermits == NaN, below</span></span><br><span class="line">        storedPermits = maxPermits;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç­‰æ¯”ç¼©æ”¾å·²ç»å­˜å‚¨çš„è®¸å¯æ•°é‡</span></span><br><span class="line">        storedPermits =</span><br><span class="line">            (oldMaxPermits == <span class="number">0.0</span>)</span><br><span class="line">            ? <span class="number">0.0</span> <span class="comment">// initial state</span></span><br><span class="line">            : storedPermits * maxPermits / oldMaxPermits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦è®¡ç®—äº†æ–°çš„ <code>maxPermits</code>ï¼Œå¹¶æ ¹æ®æ—§çš„ <code>maxPermits</code>ï¼Œå³ <code>oldMaxPermits</code> è®¡ç®—äº† <code>storedPermits</code> çš„å€¼</p><p>ç›¸å½“äºè®¾ç½®äº†æ–°çš„ <code>permitsPerSecond</code>ï¼Œéœ€è¦è®¡ç®—æ–°çš„ <code>maxPermits</code>ï¼Œå¹¶ç­‰æ¯”ç¼©æ”¾å·²ç»å­˜å‚¨çš„è®¸å¯æ•°é‡</p><h2 id="è·å–è®¸å¯ï¼ˆpermitsï¼‰"><a href="#è·å–è®¸å¯ï¼ˆpermitsï¼‰" class="headerlink" title="è·å–è®¸å¯ï¼ˆpermitsï¼‰"></a>è·å–è®¸å¯ï¼ˆpermitsï¼‰</h2><p>åˆ›å»º <code>RateLimiter</code> å¯¹è±¡åï¼Œä½¿ç”¨ <code>acquire</code> æˆ–è€… <code>tryAcquire</code> æ–¹æ³•æ¥è·å–è®¸å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> RateLimiter.create(<span class="number">10</span>);</span><br><span class="line"><span class="type">double</span> <span class="variable">sleepTime</span> <span class="operator">=</span> rateLimiter.acquire(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„è¿”å›å€¼æ˜¯ç­‰å¾…çš„æ—¶é—´ï¼Œå¹¶ä¸”åœ¨è¿”å›ä¹‹å‰è¯¥çº¿ç¨‹ä¸€ç›´åœ¨ç­‰å¾…</p><p>ç€é‡çœ‹ä¸‹ <code>acquire</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> permits)</span> &#123; <span class="comment">// å‚æ•° permits ä»£è¡¨ä¸€æ¬¡éœ€è¦è·å–çš„è®¸å¯æ•°é‡</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">microsToWait</span> <span class="operator">=</span> reserve(permits); <span class="comment">// è°ƒç”¨ reserve æ–¹æ³•</span></span><br><span class="line">    stopwatch.sleepMicrosUninterruptibly(microsToWait); <span class="comment">// microsToWait &gt; 0 åˆ™ sleep</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1.0</span> * microsToWait / SECONDS.toMicros(<span class="number">1L</span>); <span class="comment">// æ¢ç®—æˆ s è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯é€šè¿‡ <code>reserve</code> æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªéœ€è¦ç­‰å¾…çš„å¾®ç§’å€¼ <code>microsToWait</code>ï¼Œå¦‚æœå¤§äº 0 åˆ™è¿›è¡Œ sleep æ“ä½œï¼ˆä½¿ç”¨çš„åŒæ ·æ˜¯ Guava åŒ…ä¸‹çš„ <code>Uninterruptibles</code>ï¼Œå…ˆä¸å…³æ³¨ï¼‰</p><p>æœ€ç»ˆå°†ç­‰å¾…çš„å¾®ç§’æ¢ç®—æˆå•ä½ç§’è¿”å›</p><p><strong>reserve</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserve</span><span class="params">(<span class="type">int</span> permits)</span> &#123;</span><br><span class="line">    checkPermits(permits); <span class="comment">// å‚æ•°æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mutex()) &#123; <span class="comment">// ä¸Šé”</span></span><br><span class="line">        <span class="keyword">return</span> reserveAndGetWaitLength(permits, stopwatch.readMicros());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•é‡Œä¸»è¦åšäº†ä¸¤éƒ¨åˆ†æ“ä½œ</p><ol><li>æ ¡éªŒå‚æ•° <code>permits</code> åˆæ³•æ€§ï¼Œå…¶å®å°±æ˜¯æ˜¯å¦å¤§äº 0 <code>checkArgument(permits &gt; 0, &quot;Requested permits (%s) must be positive&quot;, permits);</code></li><li>ä½¿ç”¨ <code>synchronized</code> å…³é”®å­—ä¸Šé”ï¼ˆ<code>mutex</code> æ–¹æ³•è¿”å›çš„æ˜¯ <code>this.mutexDoNotUseDirectly</code> ä¸€ä¸ª <code>Object</code> å¯¹è±¡ï¼‰ï¼Œä¸Šé”åæ‰§è¡Œ <code>reserveAndGetWaitLength</code> æ–¹æ³•</li></ol><p><strong>reserveAndGetWaitLength</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserveAndGetWaitLength</span><span class="params">(<span class="type">int</span> permits, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">momentAvailable</span> <span class="operator">=</span> reserveEarliestAvailable(permits, nowMicros);</span><br><span class="line">    <span class="keyword">return</span> max(momentAvailable - nowMicros, <span class="number">0</span>); <span class="comment">// è®¡ç®—ä¸€ä¸‹æ˜¯ä¸æ˜¯éœ€è¦ wait</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ–¹æ³•å â€œè·å–ç­‰å¾…é•¿åº¦â€ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œä¸»è¦æ˜¯é€šè¿‡ <code>reserveEarliestAvailable</code> è·å–ä¸€ä¸ªæ—¶é—´ï¼ˆè¿™ä¸ªæ—¶é—´åœ¨åé¢çš„æ–¹æ³•ä¸­å¯çŸ¥æ˜¯ä¸‹ä¸€æ¬¡è·å–è®¸å¯çš„æ—¶é—´ï¼‰åï¼Œåœ¨æ¬¡æ–¹æ³•æœ€ç»ˆç¡®è®¤éœ€è¦ç­‰å¾…çš„æ—¶é—´å¹¶è¿”å› <code>max(momentAvailable - nowMicros, 0)</code>ï¼Œå¦‚æœä¸éœ€è¦ç­‰å¾…ï¼ˆ<code>momentAvailable - nowMicros &lt; 0</code>ï¼‰ï¼Œåˆ™è¿”å› 0</p><p><strong>arliestAvailable</strong></p><p><code>RateLimiter</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç”± <code>SmoothRateLimiter</code> è¿›è¡Œäº†å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="type">long</span> <span class="title function_">reserveEarliestAvailable</span><span class="params">(<span class="type">int</span> permits, <span class="type">long</span> nowMicros)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserveEarliestAvailable</span><span class="params">(<span class="type">int</span> requiredPermits, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    resync(nowMicros); <span class="comment">// é‡æ–°è®¡ç®— storedPermits å’Œ nextFreeTicketMicros</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">returnValue</span> <span class="operator">=</span> nextFreeTicketMicros; <span class="comment">// ä¿å­˜ nextFreeTicketMicrosï¼Œå› ä¸ºåé¢å¯èƒ½ä¼šè¢«æ›´æ–°</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">storedPermitsToSpend</span> <span class="operator">=</span> min(requiredPermits, <span class="built_in">this</span>.storedPermits); <span class="comment">// ä»“åº“èƒ½æä¾›çš„è®¸å¯</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">freshPermits</span> <span class="operator">=</span> requiredPermits - storedPermitsToSpend; <span class="comment">// è¿™æ¬¡è¯·æ±‚è¶…å‡ºä»“åº“èƒ½åŠ›çš„è®¸å¯</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">waitMicros</span> <span class="operator">=</span> <span class="comment">// ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        storedPermitsToWaitTime(<span class="built_in">this</span>.storedPermits, storedPermitsToSpend)</span><br><span class="line">        + (<span class="type">long</span>) (freshPermits * stableIntervalMicros);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.nextFreeTicketMicros = LongMath.saturatedAdd(nextFreeTicketMicros, waitMicros); <span class="comment">// æ ¹æ®ç­‰å¾…æ—¶é—´å»¶é•¿ä¸‹ä¸€æ¬¡èƒ½å¤Ÿè·å–è®¸å¯çš„æ—¶é—´</span></span><br><span class="line">    <span class="built_in">this</span>.storedPermits -= storedPermitsToSpend; <span class="comment">// è°ƒæ•´ä»“åº“è®¸å¯æ•°é‡ï¼›å³ freshPermits &gt; 0ï¼ŒstoredPermits ä¸€å®š = 0</span></span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œå°±è°ƒç”¨äº†æ–¹æ³• <code>resync()</code>ï¼Œè¯¥æ–¹æ³•çš„ç›®çš„æ˜¯é‡æ–°è®¡ç®— <code>this.storedPermits</code> å’Œ <code>this.nextFreeTicketMicros</code> è¿™ä¸¤ä¸ªé‡è¦å±æ€§</p><p>æ¥ä¸‹æ¥çš„å‡ è¡Œæ“ä½œå¯ä»¥æ¦‚æ‹¬ä¸ºï¼šå¦‚æœéœ€è¦è·å–çš„è®¸å¯å¤§äºå½“å‰å·²ç»å­˜å‚¨çš„è®¸å¯ï¼Œé‚£ä¹ˆè®¡ç®—å‡ºè¶…å‡ºçš„è®¸å¯æ•°é‡ <code>freshPermits</code>ï¼Œè°ƒç”¨ <code>storedPermitsToWaitTime</code> æ–¹æ³•è¿”å›å€¼åŠ ä¸Š <code>è¶…å‡ºçš„è®¸å¯æ•°é‡ Ã— è®¸å¯ç”Ÿäº§é—´éš”</code> å³å¯ç®—å‡ºéœ€è¦é¢å¤–ç­‰å¾…çš„æ—¶é•¿ï¼›è¿™é‡Œå¯¹äº <code>SmoothBursty</code> æ¥è¯´ï¼Œè¿”å›å›ºå®šæ˜¯ 0ï¼Œä¹Ÿå°±æ˜¯é¢å¤–çš„ç­‰å¾…æ—¶é—´å°±æ˜¯ <code>è¶…å‡ºçš„è®¸å¯æ•°é‡ Ã— è®¸å¯ç”Ÿäº§é—´éš”</code></p><p>æœ€åæ›´æ–°è¿™æ¬¡æ“ä½œå <code>this.nextFreeTicketMicros</code> å’Œ <code>this.storedPermits</code> çš„å€¼ï¼Œè¿”å›ä¸€å¼€å§‹ä¿å­˜çš„ <code>this.nextFreeTicketMicros</code></p><p><strong>è¿™é‡Œéœ€è¦æ€è€ƒä¸€ä¸ªé—®é¢˜</strong>ï¼šä¸ºä»€ä¹ˆè¿”å›çš„æ˜¯ <code>resync</code> åçš„ <code>nextFreeTicketMicros</code>ï¼Ÿå¦‚æœä»¤ç‰Œæ•°é‡ä¸å¤Ÿï¼Œè¿™ä¸ªå€¼ä¸æ˜¯è¢«å‘åæ›´æ–°äº†å—ï¼Ÿè¿™é‡Œå°±ä½“ç°å‡º <code>RateLimiter</code> æ•´ä½“çš„ä¸€ä¸ªæ€æƒ³ï¼Œå³æ¯ä¸€ä¸ªè¯·æ±‚è¿‡æ¥æœ¬è´¨ä¸Šéƒ½èƒ½æ‹¿åˆ°è®¸å¯ï¼Œæ— éæ˜¯ç­‰å¾…å¤šé•¿æ—¶é—´æ‰èƒ½æ‰§è¡Œï¼Œå¯¹äºè¶…å‡ºéƒ¨åˆ†æ¥è¯´ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨ç­‰å¾…ï¼Œå°†è¿™éƒ¨åˆ†æ—¶é—´å…¨éƒ¨äº¤ç»™ä¸‹ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œç­‰å¾…äº†ï¼Œæˆ‘è‡ªå·±æ¦‚æ‹¬èµ·æ¥å°±æ˜¯ <strong>æƒ°æ€§è®¡ç®— + ä»¥å½“å‰çº¿ç¨‹ä¸ºä¸»</strong></p><p><strong>resync</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">resync</span><span class="params">(<span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    <span class="comment">// if nextFreeTicket is in the past, resync to now</span></span><br><span class="line">    <span class="keyword">if</span> (nowMicros &gt; nextFreeTicketMicros) &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">newPermits</span> <span class="operator">=</span> (nowMicros - nextFreeTicketMicros) / coolDownIntervalMicros();</span><br><span class="line">        storedPermits = min(maxPermits, storedPermits + newPermits);</span><br><span class="line">        nextFreeTicketMicros = nowMicros;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„ç›®çš„æ˜¯é‡æ–°è®¡ç®— <code>this.storedPermits</code> å’Œ <code>this.nextFreeTicketMicros</code> è¿™ä¸¤ä¸ªé‡è¦å±æ€§</p><p>å¦‚æœå½“å‰æ—¶é—´è¶…è¿‡äº†ä¹‹å‰è®¡ç®—çš„ä¸‹ä¸€æ¬¡è·å–è®¸å¯çš„æ—¶é—´ï¼Œåˆ™å¼€å§‹æ›´æ–°ï¼š</p><ol><li>å…ˆè®¡ç®—æ–°äº§ç”Ÿçš„è®¸å¯æ•°é‡ï¼ˆ<code>coolDownIntervalMicros()</code> è¿”å›çš„æ˜¯è®¸å¯ç”Ÿäº§çš„å›ºå®šé—´éš”ï¼‰</li><li>æ›´æ–° <code>this.storedPermits</code> ä¸ºåˆé€‚çš„å€¼ï¼ˆ<code>SmoothBursty</code> æœ€å¤šåªèƒ½å¤šå­˜å‚¨ 1s çš„è®¸å¯ï¼‰</li><li>æ›´æ–° <code>this.nextFreeTicketMicros</code> ä¸ºå‚æ•° <code>nowMicros</code></li></ol><h2 id="é¢„çƒ­ï¼ˆWarmingUpï¼‰"><a href="#é¢„çƒ­ï¼ˆWarmingUpï¼‰" class="headerlink" title="é¢„çƒ­ï¼ˆWarmingUpï¼‰"></a>é¢„çƒ­ï¼ˆWarmingUpï¼‰</h2><p>ä¸Šé¢çš„åˆ†æä¸»è¦æ˜¯å¯¹ <code>SmoothBursty</code> è¿›è¡Œäº†åˆ†æï¼Œè¿˜æä¾›äº†ä¸€ç§å®ç°æ˜¯ <code>SmoothWarmingUp</code></p><p><code>SmoothWarmingUp</code> é€‚ç”¨äºèµ„æºéœ€è¦é¢„çƒ­çš„åœºæ™¯ï¼Œç›¸æ¯” <code>SmoothBursty</code> æ˜¯å¯¹çªå‘æµé‡è¿›è¡Œä¿è¯ï¼Œé€šè¿‡ <code>maxBurstSeconds</code> æ¥è®¡ç®—é¢å¤–å­˜å‚¨çš„ä»¤ç‰Œæ•°é‡ï¼Œ<code>SmoothWarmingUp</code> ä½¿ç”¨ <code>warmupPeriod</code> å‚æ•°æ¥è®¾ç½®é¢„çƒ­çš„æ—¶é•¿</p><p>ç”±äºé¢„çƒ­æœºåˆ¶çš„å­˜åœ¨ï¼Œå…¶ç”Ÿäº§è®¸å¯çš„é€Ÿåº¦æ˜¯åº”è¯¥æ˜¯åŠ¨æ€çš„ï¼Œå¦‚ä¸‹å›¾</p><img src="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter/%E8%AE%B8%E5%8F%AF%E9%A2%84%E7%83%AD.drawio.png" class="" title="è®¸å¯é¢„çƒ­.drawio"><p>å…¶è®¸å¯æ•°é‡è¶Šå¤šï¼Œè¯´æ˜è¿˜æ²¡åˆ°ç¨³å®šæ—¶æœŸï¼Œè®¸å¯çš„ç”Ÿäº§é—´éš”å°±è¦è¶Šé•¿ï¼›è®¸å¯å°‘è¯´æ˜å¤„äºç¨³å®šæœŸ</p><p><strong>å…³é”®å±æ€§è®¡ç®—</strong></p><p>æ ¹æ®è¯¥å›¾å¯ä»¥è®¡ç®—å‡ºä¸€äº›æ•°å€¼ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ï¼Œä» <code>thresholdPermits</code> åˆ° 0 çš„æ—¶é—´ï¼Œæ˜¯ä» <code>maxPermits</code> åˆ° <code>thresholdPermits</code> æ—¶é—´çš„ä¸€åŠï¼Œä¹Ÿå°±æ˜¯æ¢¯å½¢çš„é¢ç§¯æ˜¯é•¿æ–¹å½¢é¢ç§¯çš„ 2 å€ï¼Œæ¢¯å½¢çš„é¢ç§¯æ˜¯ <code>warmupPeriod</code></p><p>å› ä¸ºåœ¨åˆ›å»º <code>SmoothWarmingUp</code> é»˜è®¤çš„ coldFactor ä¸º 3 <code>SleepingStopwatch.createFromSystemTimer(), permitsPerSecond, warmupPeriod, unit, 3.0);</code> </p><p>æ¢¯å½¢é¢ç§¯ä¸º <code>warmupPeriod</code>ï¼Œè€Œé•¿æ–¹å½¢é¢ç§¯ä¸º <code>stableInterval Ã— thresholdPermits</code>ï¼Œå³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warmupPeriod = <span class="number">2</span> * stableInterval * thresholdPermits</span><br></pre></td></tr></table></figure><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¾—å‡º <code>thresholdPermits</code> çš„å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thresholdPermits = <span class="number">0.5</span> * warmupPeriod / stableInterval</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ ¹æ®æ¢¯å½¢é¢ç§¯çš„è®¡ç®—å…¬å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warmupPeriod = <span class="number">0.5</span> * (stableInterval + coldInterval) * (maxPermits - thresholdPermits)</span><br></pre></td></tr></table></figure><p>å¾—å‡º <code>maxPermits</code> ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxPermits = thresholdPermits + <span class="number">2.0</span> * warmupPeriod / (stableInterval + coldInterval)</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† <code>thresholdPermits</code> å’Œ <code>maxPermits</code> çš„å€¼</p><p>æœ€åæ˜¯å†·å´æ—¶é—´çš„é—´éš”ï¼Œå¯¹åº”åˆ°å›¾ä¸­ä»£è¡¨çš„æ˜¯æ–œçº¿çš„æ–œç‡ï¼Œå³ç”±ç¨³å®šåˆ°å†·å´ä¸­çš„é€Ÿåº¦ï¼›åœ¨ä»£ç ä¸­ä¸ºï¼š</p><p>è¯¥æ–¹æ³• <code>SmoothBursty</code> çš„å®ç°å§‹ç»ˆè¿”å› 0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">double</span> <span class="title function_">coolDownIntervalMicros</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> warmupPeriodMicros / maxPermits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>doSetRate</strong></p><p>ä¸Šé¢åˆ†æäº† <code>SmoothBursty</code> çš„ <code>doSetRate</code> å®ç°ï¼Œè¿™é‡Œæ¥çœ‹ <code>SmoothWarmingUp</code> çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">double</span> stableIntervalMicros)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">oldMaxPermits</span> <span class="operator">=</span> maxPermits;</span><br><span class="line">    <span class="type">double</span> <span class="variable">coldIntervalMicros</span> <span class="operator">=</span> stableIntervalMicros * coldFactor; <span class="comment">// coldFactor æ˜¯å›ºå®šçš„ 3</span></span><br><span class="line">    thresholdPermits = <span class="number">0.5</span> * warmupPeriodMicros / stableIntervalMicros;</span><br><span class="line">    maxPermits =</span><br><span class="line">        thresholdPermits + <span class="number">2.0</span> * warmupPeriodMicros / (stableIntervalMicros + coldIntervalMicros);</span><br><span class="line">    slope = (coldIntervalMicros - stableIntervalMicros) / (maxPermits - thresholdPermits); <span class="comment">// è®¡ç®—æ–œç‡ï¼Œå¯¹è¾¹ / ä¸´è¾¹</span></span><br><span class="line">    <span class="keyword">if</span> (oldMaxPermits == Double.POSITIVE_INFINITY) &#123;</span><br><span class="line">        <span class="comment">// if we don&#x27;t special-case this, we would get storedPermits == NaN, below</span></span><br><span class="line">        storedPermits = <span class="number">0.0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        storedPermits =</span><br><span class="line">            (oldMaxPermits == <span class="number">0.0</span>)</span><br><span class="line">            ? maxPermits <span class="comment">// initial state is cold</span></span><br><span class="line">            : storedPermits * maxPermits / oldMaxPermits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è®¡ç®—äº†ç›¸å…³çš„å±æ€§å¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡ï¼Œè®¡ç®—æ–¹æ³•éƒ½å’Œä¸Šå›¾ä¸€è‡´</p><p><strong>acquire çš„ storedPermitsToWaitTime</strong></p><p><code>acquire</code> æµç¨‹å’Œ <code>SmoothBursty</code> åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äº <code>storedPermitsToWaitTime</code> æ–¹æ³•çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserveEarliestAvailable</span><span class="params">(<span class="type">int</span> requiredPermits, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    resync(nowMicros);</span><br><span class="line">    <span class="type">long</span> <span class="variable">returnValue</span> <span class="operator">=</span> nextFreeTicketMicros;</span><br><span class="line">    <span class="type">double</span> <span class="variable">storedPermitsToSpend</span> <span class="operator">=</span> min(requiredPermits, <span class="built_in">this</span>.storedPermits);</span><br><span class="line">    <span class="type">double</span> <span class="variable">freshPermits</span> <span class="operator">=</span> requiredPermits - storedPermitsToSpend;</span><br><span class="line">    <span class="type">long</span> <span class="variable">waitMicros</span> <span class="operator">=</span></span><br><span class="line">        storedPermitsToWaitTime(<span class="built_in">this</span>.storedPermits, storedPermitsToSpend) <span class="comment">// åœ¨äºè¿™é‡Œçš„æ–¹æ³•</span></span><br><span class="line">        + (<span class="type">long</span>) (freshPermits * stableIntervalMicros);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.nextFreeTicketMicros = LongMath.saturatedAdd(nextFreeTicketMicros, waitMicros);</span><br><span class="line">    <span class="built_in">this</span>.storedPermits -= storedPermitsToSpend;</span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>waitMicros</code> ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯ä» <code>storedPermits</code> ä¸­è·å–èŠ±è´¹çš„æ—¶é—´ï¼Œä¸€éƒ¨åˆ†æ˜¯ç­‰å¾… <code>freshPermits</code> äº§ç”ŸèŠ±è´¹çš„æ—¶é—´ï¼›<code>SmoothBursty</code> çš„è¯¥æ–¹æ³•å®ç°å›ºå®šè¿”å› 0ï¼Œå³ä¸å­˜åœ¨ä» <code>storedPermits</code> è·å–è®¸å¯çš„èŠ±è´¹ï¼Œè€Œ <code>SmoothWarmingUp</code> å®ç°è¾ƒä¸ºå¤æ‚</p><p>ç”±äºéœ€è¦é¢„çƒ­ï¼Œæ‰€ä»¥ä»å­˜å‚¨çš„è®¸å¯ä¸­ä¸­å–è®¸å¯éœ€è¦èŠ±è´¹ä¸€å®šçš„æ—¶é—´ï¼Œå…¶å®å°±æ˜¯è¦è®¡ç®—ä¸‹å›¾ä¸­ï¼Œé˜´å½±éƒ¨åˆ†çš„é¢ç§¯</p><img src="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter/%E8%AE%B8%E5%8F%AF%E9%A2%84%E7%83%AD%E8%8E%B7%E5%8F%96%E8%AE%B8%E5%8F%AF.drawio.png" class="" title="è®¸å¯é¢„çƒ­è·å–è®¸å¯.drawio"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">storedPermitsToWaitTime</span><span class="params">(<span class="type">double</span> storedPermits, <span class="type">double</span> permitsToTake)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">availablePermitsAboveThreshold</span> <span class="operator">=</span> storedPermits - thresholdPermits;</span><br><span class="line">    <span class="type">long</span> <span class="variable">micros</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// measuring the integral on the right part of the function (the climbing line)</span></span><br><span class="line">    <span class="comment">// å¦‚æœå³è¾¹æ¢¯å½¢éƒ¨åˆ†æœ‰ permitsï¼Œé‚£ä¹ˆå…ˆä»å³è¾¹éƒ¨åˆ†è·å– permitsï¼Œè®¡ç®—æ¢¯å½¢éƒ¨åˆ†çš„é˜´å½±éƒ¨åˆ†çš„é¢ç§¯</span></span><br><span class="line">    <span class="keyword">if</span> (availablePermitsAboveThreshold &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">        <span class="comment">// ä»å³è¾¹éƒ¨åˆ†è·å–çš„ permits æ•°é‡</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">permitsAboveThresholdToTake</span> <span class="operator">=</span> min(availablePermitsAboveThreshold, permitsToTake);</span><br><span class="line">        <span class="comment">// TODO(cpovirk): Figure out a good name for this variable.</span></span><br><span class="line">        <span class="comment">// æ¢¯å½¢é¢ç§¯å…¬å¼ï¼š(ä¸Šåº• + ä¸‹åº•) Ã— é«˜ / 2</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">length</span> <span class="operator">=</span> permitsToTime(availablePermitsAboveThreshold)</span><br><span class="line">            + permitsToTime(availablePermitsAboveThreshold - permitsAboveThresholdToTake);</span><br><span class="line">        micros = (<span class="type">long</span>) (permitsAboveThresholdToTake * length / <span class="number">2.0</span>);</span><br><span class="line">        permitsToTake -= permitsAboveThresholdToTake;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// measuring the integral on the left part of the function (the horizontal line)</span></span><br><span class="line">    <span class="comment">// åŠ ä¸Šé•¿æ–¹å½¢éƒ¨åˆ†çš„é˜´å½±é¢ç§¯</span></span><br><span class="line">    micros += (stableIntervalMicros * permitsToTake);</span><br><span class="line">    <span class="keyword">return</span> micros;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹äºç»™å®šçš„ x å€¼ï¼Œè®¡ç®— y å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">double</span> <span class="title function_">permitsToTime</span><span class="params">(<span class="type">double</span> permits)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> stableIntervalMicros + permits * slope;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°†è¿™éƒ¨åˆ†ç­‰å¾…æ—¶é—´è¿”å›ï¼Œè¾¾åˆ°é¢„çƒ­ç­‰å¾…çš„ç›®çš„</p><h1 id="é‡ç‚¹é—®é¢˜"><a href="#é‡ç‚¹é—®é¢˜" class="headerlink" title="é‡ç‚¹é—®é¢˜"></a>é‡ç‚¹é—®é¢˜</h1><h2 id="è®¸å¯ä»å“ªæ¥"><a href="#è®¸å¯ä»å“ªæ¥" class="headerlink" title="è®¸å¯ä»å“ªæ¥"></a>è®¸å¯ä»å“ªæ¥</h2><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œå¯ä»¥å¾—å‡ºï¼Œæ‰€è°“çš„è®¸å¯æ˜¯æƒ°æ€§çš„è¿ç®—ï¼Œå¹¶ä¸æ˜¯è¡¨é¢ç†è§£çš„å¯èƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹åœ¨ç”Ÿäº§è®¸å¯ï¼Œè€Œæ˜¯å½“è¯·æ±‚è¿›å…¥æ—¶æ‰ä¼šè®¡ç®—è®¸å¯ç›¸å…³çš„æ•°æ®ï¼ˆä¸‹ä¸€æ¬¡è®¸å¯æ—¶é—´ã€å­˜å‚¨çš„è®¸å¯æ•°é‡ã€æ»¡è¶³å½“å‰è¯·æ±‚è®¸å¯éœ€è¦ç­‰å¾…çš„æ—¶é—´ç­‰ï¼‰ï¼Œç„¶åå¯¹è¯¥è¯·æ±‚è¡Œä¸ºè¿›è¡Œå¤„ç†</p><h2 id="å¹¶å‘å®‰å…¨æ˜¯å¦‚ä½•ä¿è¯çš„"><a href="#å¹¶å‘å®‰å…¨æ˜¯å¦‚ä½•ä¿è¯çš„" class="headerlink" title="å¹¶å‘å®‰å…¨æ˜¯å¦‚ä½•ä¿è¯çš„"></a>å¹¶å‘å®‰å…¨æ˜¯å¦‚ä½•ä¿è¯çš„</h2><p>å¹¶å‘ä¸»è¦å‡ºç°åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼Œ<code>setRate</code> è®¾ç½®é€Ÿç‡æ–¹æ³•å’Œ <code>acquire</code> è·å–è®¸å¯æ–¹æ³•å†…ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿäº’æ–¥</p><p>å…³é”®çš„æ–¹æ³•åœ¨ <code>reserve()</code> å†…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserve</span><span class="params">(<span class="type">int</span> permits)</span> &#123;</span><br><span class="line">    checkPermits(permits);</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex()) &#123;</span><br><span class="line">        <span class="keyword">return</span> reserveAndGetWaitLength(permits, stopwatch.readMicros());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆç€é‡å…³æ³¨ <code>mutex()</code> è¿”å›äº†ä»€ä¹ˆå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Can&#x27;t be initialized in the constructor because mocks don&#x27;t call the constructor.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Object mutexDoNotUseDirectly;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">mutex</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">mutex</span> <span class="operator">=</span> mutexDoNotUseDirectly;</span><br><span class="line">    <span class="keyword">if</span> (mutex == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            mutex = mutexDoNotUseDirectly;</span><br><span class="line">            <span class="keyword">if</span> (mutex == <span class="literal">null</span>) &#123;</span><br><span class="line">                mutexDoNotUseDirectly = mutex = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mutex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæœ‰å‡ ä¸ªç–‘é—®ä¸ç­”æ¡ˆï¼š</p><ul><li><code>Object mutex = mutexDoNotUseDirectly</code> ä¸ºä»€ä¹ˆä¸ç›´æ¥æ“ä½œ <code>this.mutexDoNotUseDirectly</code>ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡</li><li><code>mutexDoNotUseDirectly</code> é”å¯¹è±¡çš„åˆ›å»ºæœ‰å¿…è¦ä½¿ç”¨æ‡’æ±‰å¼å—ï¼Ÿ<code>RateLimiter</code> åœ¨å®ä¾‹åŒ–åç›´æ¥æ‰§è¡Œäº† <code>reserve</code> æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‡’åŠ è½½çš„å•ä¾‹æ„ä¹‰æ˜¯ä»€ä¹ˆ</li><li>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ <code>synchronized (this)</code>ï¼ŒåŒ…è£…äº†ä¸€ä¸ªæ–¹æ³• <code>mutex()</code> æ¥è¿”å›é”å¯¹è±¡</li></ul><p><strong>ç¬¬ä¸€ä¸ªé—®é¢˜</strong>ï¼šå‡å°‘ <code>volatile</code> å¯¹å†…å­˜çš„è¯»è¯·æ±‚ï¼›<code>mutexDoNotUseDirectly</code> æ˜¯å¯è§çš„ï¼Œæ¯æ¬¡è¯»å–éƒ½ä¼šè®¿é—®å†…å­˜ï¼Œä½¿ç”¨ä¸´æ—¶å˜é‡å¯¹äºä¸éœ€è¦å¯è§æ€§çš„åœºæ™¯èƒ½å‡å°‘è®¿é—®å†…å­˜çš„æ¬¡æ•°</p><blockquote><p>It avoids an additional volatile read of the field once itâ€™s determined to be non-null.<br>è¯¦è§ issueï¼š<a href="https://github.com/google/guava/issues/3381">https://github.com/google/guava/issues/3381</a></p></blockquote><p><strong>ç¬¬äºŒä¸ªé—®é¢˜</strong>ï¼šæºä»£ç æ³¨é‡Šä¸­ä¹Ÿå·²ç»è§£é‡Šäº†ç›®çš„ï¼š<code>// Can&#39;t be initialized in the constructor because mocks don&#39;t call the constructor.</code></p><p>ä½œè€…æ˜¯è€ƒè™‘åˆ°ä½¿ç”¨ Mockito æ¡†æ¶æ—¶ï¼Œç”¨ mock æ–¹æ³•åˆ›å»º <code>RateLimiter</code> çš„ mock å¯¹è±¡ä¸ä¼šæ‰§è¡Œå…¶æ„é€ å™¨ï¼Œè¯¥é”å¯¹è±¡ä¸ä¼šè¢«å®ä¾‹åŒ–ï¼›å¹¶ä¸”æˆå‘˜å˜é‡ç›´æ¥èµ‹å€¼ä¹Ÿä¼šè¢«è§£é‡Šä¸ºæ„é€ å™¨çš„ä¸€éƒ¨åˆ†</p><blockquote><p>Inline field initialization is syntactic sugar for initializing from the constructor.<br>è¯¦è§ issueï¼š<a href="https://github.com/google/guava/issues/3066">https://github.com/google/guava/issues/3066</a></p></blockquote><p><strong>ç¬¬ä¸‰ä¸ªé—®é¢˜</strong>ï¼šæ›´æ–¹ä¾¿æ§åˆ¶é”ç²’åº¦ï¼Œå¹¶ä¸”é¿å…ä½¿ç”¨ <code>this</code> ä½œä¸ºé”å¯¹è±¡æ˜¯ä¸€ç§è§„èŒƒï¼Œå› ä¸ºæ— æ³•å¾—çŸ¥å¤–éƒ¨æ˜¯å¦ä¹Ÿæ˜¯ç”¨ <code>this</code> ä½œä¸ºé”æ¥ä½¿ç”¨</p><blockquote><p>å¯ä»¥å‚è€ƒè¯¥å›ç­”ï¼š<a href="https://stackoverflow.com/questions/12397427/what-is-different-between-method-synchronized-vs-object-synchronized">https://stackoverflow.com/questions/12397427/what-is-different-between-method-synchronized-vs-object-synchronized</a></p></blockquote><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/60979444">è¶…è¯¦ç»†çš„Guava RateLimiteré™æµåŸç†è§£æ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://blog.csdn.net/egg1996911/article/details/103928573">Guavaé™æµå™¨RateLimiterä¸­mutexDoNotUseDirectly&#x2F;é”çš„ä½¿ç”¨_DengDengLeiçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/shenchaohao12321/article/details/112143092">RateLimiter æºç åˆ†æ(Guava å’Œ Sentinel å®ç°)_ä¸€ç›´ä¸æ‡‚çš„åšå®¢-CSDNåšå®¢_sentinel ratelimiter</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Guava </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¯¹è±¡åˆ›å»ºä¸å±æ€§è®¾ç½®</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>åœ¨ Spring æ¡†æ¶å’Œ MVC ä¸‰å±‚æ¨¡å¼ä¸‹ï¼Œå¯¹äºåˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶å¯¹å±æ€§è¿›è¡Œèµ‹å€¼çš„æ“ä½œä¸éœ€è¦å¤æ‚çš„è®¾è®¡</p><p>ä»£ç ä¸­åˆ›å»ºçš„å¯¹è±¡å¾€å¾€æ˜¯ä¸€ä¸ª â€œè´«è¡€æ¨¡å‹â€ï¼Œåªç”¨æ¥å……å½“æ•°æ®çš„ä¼ é€’è€…</p><p>åº”è¯¥æ ¹æ®ä¸åŒçš„ç±»åŠå…¶åŠŸèƒ½é€‰æ‹©åˆé€‚çš„å¯¹è±¡åˆ›å»ºæ–¹å¼</p><h1 id="æ–¹å¼"><a href="#æ–¹å¼" class="headerlink" title="æ–¹å¼"></a>æ–¹å¼</h1><h2 id="set-æ–¹æ³•"><a href="#set-æ–¹æ³•" class="headerlink" title="set æ–¹æ³•"></a>set æ–¹æ³•</h2><p>æœ€å¸¸è§çš„æ–¹å¼ï¼›åˆ›å»ºå¯¹è±¡åï¼Œä½¿ç”¨ set æ–¹æ³•æ¥å¯¹å±æ€§è¿›è¡Œèµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">student.setName(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">student.setAge(<span class="number">20</span>);</span><br></pre></td></tr></table></figure><h2 id="æœ‰å‚æ„é€ "><a href="#æœ‰å‚æ„é€ " class="headerlink" title="æœ‰å‚æ„é€ "></a>æœ‰å‚æ„é€ </h2><p>å¯¹éœ€è¦èµ‹å€¼çš„å±æ€§è®¾ç½®ä¸ºæœ‰å‚æ„é€ ä¸­çš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šä½¿ç”¨æœ‰å‚æ„é€ å™¨æ¥åˆ›å»ºå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure><h2 id="é“¾å¼èµ‹å€¼"><a href="#é“¾å¼èµ‹å€¼" class="headerlink" title="é“¾å¼èµ‹å€¼"></a>é“¾å¼èµ‹å€¼</h2><p>å°† set æ–¹æ³•æ”¹é€ ï¼Œå°† <code>this</code> å¯¹è±¡è¿”å›è¾¾æˆé“¾å¼èµ‹å€¼çš„æ•ˆæœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">alias</span><span class="params">(String alias)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.alias = alias;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">age</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¯¹è±¡å’Œèµ‹å€¼æ“ä½œæ›´æµç•…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>().name(<span class="string">&quot;å¼ ä¸‰&quot;</span>).age(<span class="number">20</span>).alias(<span class="string">&quot;å¼ ä¸‰ä¸‰&quot;</span>);</span><br></pre></td></tr></table></figure><p><strong>Lombok</strong></p><p>Lombok çš„ <code>@Accessors(chain = true, fluent = true)</code> æ³¨è§£å¯ä»¥ç”Ÿæˆç±»ä¼¼çš„æ¨¡æ¿ä»£ç ï¼›è¯¥æ³¨è§£ä¸»è¦æ˜¯å¯¹ Bean æ–¹æ³•ï¼ˆ<code>@Getter</code> å’Œ <code>@Setter</code>ï¼‰çš„ç”Ÿæˆè¿›è¡Œè¿›ä¸€æ­¥çš„é…ç½®</p><p><code>@Accessors</code> çš„å‚æ•°ï¼š</p><ul><li>fluent - ä¸º true æ—¶ç”Ÿæˆçš„ set æ–¹æ³•åç§°ä¸ä¼šå¸¦ä¸Š <code>set</code> å‰ç¼€ï¼Œå³ä»¥å˜é‡åä½œä¸ºæ–¹æ³•å</li><li>chain - ä¸º true æ—¶ç”Ÿæˆçš„ set æ–¹æ³•ä¼šä»¥å½“å‰å¯¹è±¡ä½œä¸ºè¿”å›å€¼ï¼Œè¾¾åˆ°é“¾å¼èµ‹å€¼çš„æ•ˆæœ</li><li>prefix - è¿‡æ»¤å›ºå®šå‰ç¼€çš„å˜é‡ï¼Œä¸å¯¹æ‰€é…ç½®å‰ç¼€çš„å˜é‡ç”Ÿæˆ set æ–¹æ³•</li></ul><h2 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h2><p>å¯ä»¥ç§°ä¸ºç”Ÿæˆå™¨è®¾è®¡æ¨¡å¼</p><p>åˆ›å»ºå‡ºä¸€ä¸ª <code>Builder</code> ç”Ÿæˆå™¨æ¥å¯¹å¯¹è±¡çš„åˆ›å»ºè¿›è¡Œç®¡ç†</p><p><code>Builder</code> å¯ä»¥å¯¹åˆ›å»ºå¯¹è±¡è¿‡ç¨‹ä¸­çš„æµç¨‹è¿›è¡Œä¼˜åŒ–ï¼Œå‡å°‘é€‰é…å‚æ•°ï¼Œå¯ä»¥åœ¨åˆ›å»ºå‰å°±å¯¹å±æ€§è¿›è¡Œæ ¡éªŒï¼ˆä¼˜ç‚¹å°±æ˜¯ç”Ÿæˆå™¨æ¨¡å¼çš„ä¼˜ç‚¹ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StudentBuilder <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StudentBuilder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StudentBuilder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> StudentBuilder <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> StudentBuilder <span class="title function_">alias</span><span class="params">(String alias)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.alias = alias;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> StudentBuilder <span class="title function_">age</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Student <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="comment">// name å’Œ age å¿…é¡»èµ‹å€¼</span></span><br><span class="line">          <span class="comment">// å¦‚æœ alias è®¾ç½®äº†ï¼Œåˆ™ä»¥è®¾ç½®çš„å€¼ä¸ºå‡†ï¼›å¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä½¿ç”¨ name</span></span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">            student.setName(Assert.notBlank(<span class="built_in">this</span>.name));</span><br><span class="line">            student.setAge(Assert.notNull(<span class="built_in">this</span>.age));</span><br><span class="line">            student.setAlias(Optional.ofNullable(<span class="built_in">this</span>.alias).orElse(<span class="built_in">this</span>.name));</span><br><span class="line">            <span class="keyword">return</span> student;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>builder()</code> æ–¹æ³•åˆ›å»ºç”Ÿæˆå™¨ï¼Œå¯¹ç”Ÿæˆå™¨èµ‹å€¼åè°ƒç”¨ <code>build()</code> æ–¹æ³•åˆ›å»ºå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;å¼ ä¸‰&quot;</span>).age(<span class="number">20</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// build æ–¹æ³•è°ƒç”¨ä¹‹å‰å…¶å®æ˜¯ä¸€ä¸ª Builder å¯¹è±¡</span></span><br><span class="line"><span class="type">StudentBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;å¼ ä¸‰&quot;</span>).age(<span class="number">20</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> builder.build();</span><br></pre></td></tr></table></figure><p><strong>Lombok</strong></p><p>Lombok ä¸­ä½¿ç”¨ <code>@Builder</code> æ³¨è§£å¯ä»¥è‡ªåŠ¨ç”Ÿæˆæ¨¡æ¿ä»£ç </p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><table><thead><tr><th>æ–¹å¼</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>set æ–¹æ³•</td><td>ç®€å•ç›´æ¥</td><td>å†™æ³•ç¹æ‚ï¼›æ— æ³•ä»æ•´ä½“æ§åˆ¶å˜é‡èµ‹å€¼æƒ…å†µ</td></tr><tr><td>æœ‰å‚æ„é€ </td><td>å¯¹å±æ€§èµ‹å€¼è¿›è¡Œæœ‰åŠ›çº¦æŸ</td><td>ä¸çµæ´»ï¼Œå¦‚æœæœ€ç»ˆå¯¹è±¡ç§ç±»å¤šä¼šå‡ºç°å¤šä¸ªä¸åŒå‚æ•°çš„æœ‰å‚æ„é€ å™¨ï¼Œæˆ–è€…å¤§è€Œå…¨å‚æ•°çš„æ„é€ å™¨</td></tr><tr><td>é“¾å¼èµ‹å€¼</td><td>å†™æ³•æµç•…</td><td>ç®€å•çš„ä¼˜åŒ–ï¼Œä½†æ˜¯ä¹Ÿåªè§£å†³äº†å†™æ³•ç¹æ‚çš„é—®é¢˜</td></tr><tr><td>Builder</td><td>åŠŸèƒ½å¼ºå¤§å¯æ‰©å±•</td><td>è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºæ›´å¤šå¯¹è±¡ï¼›å®ç°å¤æ‚</td></tr></tbody></table><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://blog.csdn.net/weixin_45796051/article/details/121946894">https://blog.csdn.net/weixin_45796051/article/details/121946894</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä»£ç è§„èŒƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Crimson Sour</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Crimson%20Sour.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Crimson%20Sour.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://assets-prd.punchdrink.com/wp-content/uploads/2022/09/14141915/Article-lactic-syrup-800x450.jpg" alt="Article-lactic-syrup-800x450.jpg (800Ã—450) (punchdrink.com)"></p><h1 id="æ·±çº¢é…¸é…’-Crimson-Sour"><a href="#æ·±çº¢é…¸é…’-Crimson-Sour" class="headerlink" title="æ·±çº¢é…¸é…’ Crimson Sour"></a>æ·±çº¢é…¸é…’ Crimson Sour</h1><p><a href="https://punchdrink.com/recipes/crimson-sour/">Crimson Sour Vermouth Cocktail Recipe | PUNCH (punchdrink.com)</a></p><blockquote><p>Sour ä½œä¸ºåè¯ç›´æ¥æœ‰â€é…¸å‘³é¸¡å°¾é…’â€œçš„æ„æ€</p><p>a drink made from strong alcohol, lemon, or lime juice, sugar, and ice</p><p>Whisky Sour å¨å£«å¿Œé…¸å‘³é¸¡å°¾é…’</p></blockquote><p>å¨œå¡”è Â· å¤§å«åœ¨å¥¹çš„ä¹¦ <em>Drink Lightly</em> ä¸­å»ºè®®å¤§å®¶åˆ¶ä½œè¿™æ¯é¸¡å°¾é…’æ—¶ä½¿ç”¨å¤§é‡åº”å­£çš„æŸ‘æ©˜ç±»æ°´æœ</p><p>æ–°é²œçš„è¡€æ©™æ˜¯è¿™åœºç§€çš„æ˜æ˜Ÿï¼Œâ€œé™¤äº†çœ‹èµ·æ¥å…‰å½©ç…§äººä¹‹å¤–ï¼Œå®ƒè¿˜æ‹¥æœ‰ç¾ä¸½çš„ç”œå‘³ï¼Œå¹¶ä¸”å…·æœ‰ä¸€ç§ä»¤äººé™¶é†‰çš„ã€å‡ ä¹ç†Ÿé€äº†çš„è¦†ç›†å­å‘³é“â€</p><h2 id="åŸæ–™"><a href="#åŸæ–™" class="headerlink" title="åŸæ–™"></a>åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>æµ“çƒˆçš„ç”œå‘³ç¾æ€ - 1.5 ç›å¸ï¼ˆ<a href="https://www.diffordsguide.com/beer-wine-spirits/7232/lejon-sweet-vermouth">LeJon Sweet Vermouth</a>ï¼‰</li><li>æ–°é²œæŸ æª¬æ± - 0.75 ç›å¸</li><li>æ–°é²œè¡€æ©™æ± - 0.75 ç›å¸</li><li>å¯å¯è±†ç¢é‡‘å·´åˆ© - 0.5 ç›å¸ï¼ˆè§æ³¨é‡Šï¼‰</li><li>é¦™è‰ä¹³é…¸ç³–æµ† - 0.5 ç›å¸ï¼ˆè§æ³¨é‡Šï¼‰</li></ul><p><strong>è£…é¥°ï¼š</strong>è¡€æ©™åŠåœ†åˆ‡ç‰‡ï¼ˆcrescentï¼‰ã€æŸ æª¬è½®</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>å°†æ‰€æœ‰åŸæ–™å’Œå†°å—æ··åˆï¼Œè¿›è¡ŒçŸ­æš‚çš„ shake</li><li>æ»¤å…¥è£…æ»¡ç¢å†°çš„åŒå±‚å²©çŸ³æ¯ï¼ˆDouble Rocks glassï¼‰ï¼›é¡¶éƒ¨è¡¥å……æ›´å¤šçš„ç¢å†°ï¼Œåƒé›ªå †ä¸€æ ·</li><li>ä½¿ç”¨è¡€æ©™åŠåœ†åˆ‡ç‰‡å’ŒæŸ æª¬è½®è¿›è¡Œè£…é¥°ï¼Œæ’ä¸Šå¸ç®¡</li></ol><h2 id="æ³¨é‡Š"><a href="#æ³¨é‡Š" class="headerlink" title="æ³¨é‡Š"></a>æ³¨é‡Š</h2><h3 id="å¯å¯è±†ç¢é‡‘å·´åˆ©ï¼ˆCacao-Nib-Campariï¼‰"><a href="#å¯å¯è±†ç¢é‡‘å·´åˆ©ï¼ˆCacao-Nib-Campariï¼‰" class="headerlink" title="å¯å¯è±†ç¢é‡‘å·´åˆ©ï¼ˆCacao Nib Campariï¼‰"></a>å¯å¯è±†ç¢é‡‘å·´åˆ©ï¼ˆCacao Nib Campariï¼‰</h3><ul><li>å¯å¯è±†ç¢ - 25 å…‹</li><li>é‡‘å·´åˆ© - 750 æ¯«å‡</li></ul><p>å°†å¯å¯è±†ç¢é“ºåœ¨çƒ¤ç›˜ï¼Œçƒ˜çƒ¤ 3 åˆ° 4 åˆ†é’Ÿç›´åˆ°äº§ç”Ÿé¦™å‘³å¹¶å˜ä¸ºæ·±æ£•è‰²</p><p>å†·å´åå€’å…¥ä¸€ä¸ªå¯ä»¥å¯†å°çš„å®¹å™¨ä¸­ä¸é‡‘å·´åˆ©æ··åˆï¼Œç›–ä¸Šç›–å­é™ç½® 24 ä¸ªå°æ—¶ï¼Œä½¿ç”¨æ»¤ç½‘ï¼ˆchinoiseï¼‰è¿‡æ»¤åè£…ç“¶å†·è—</p><h3 id="é¦™è‰ä¹³é…¸ç³–æµ†ï¼ˆVanilla-Lactic-Syrupï¼‰"><a href="#é¦™è‰ä¹³é…¸ç³–æµ†ï¼ˆVanilla-Lactic-Syrupï¼‰" class="headerlink" title="é¦™è‰ä¹³é…¸ç³–æµ†ï¼ˆVanilla Lactic Syrupï¼‰"></a>é¦™è‰ä¹³é…¸ç³–æµ†ï¼ˆVanilla Lactic Syrupï¼‰</h3><ul><li>åŸºç¡€ç³–æµ† - 500 å…‹ï¼ˆç³–æ°´æ¯” 1:1ï¼‰</li><li>Tahitian é¦™è‰æå–ç‰© - 4 å…‹ï¼ˆ<a href="https://www.amazon.com/-/zh/dp/B004QQ7YVM/ref=sr_1_1?__mk_zh_CN=%E4%BA%9A%E9%A9%AC%E9%80%8A%E7%BD%91%E7%AB%99&crid=3JYYCZAUEANB5&keywords=Tahitian+vanilla+extract&qid=1672675608&sprefix=chinoise,aps,776&sr=8-1">Amazon.com: Cookâ€™s Pure South Pacific Vanilla Extract 4 oz</a>ï¼‰</li><li>ä¹³é…¸ç²‰ - 2 å…‹</li><li>çŠ¹å¤ªç›ï¼ˆkosher saltï¼‰ - 1 pinch</li></ul><blockquote><p>Kosher salt</p><p>Kosher salt æŒ‡çš„æ˜¯å®Œå…¨ä¸åŠ ç¢˜ç›ï¼Œå¹¶ä¸”ç›çš„æ™¶ä½“é¢—ç²’ä¼šæ¯”ä¸€èˆ¬çš„ç›è¦å¤§ä¸€äº›</p><p>ä¸€èˆ¬çš„é£Ÿç›ä¸­éƒ½ä¼šåŠ ç¢˜ï¼Œè¿™æ ·ä¼šè®©ç›å¸¦æœ‰ç¢˜çš„å‘³é“ï¼Œä¹Ÿä¼šå½±å“åˆ°èœè‚´æœ€ç»ˆçš„å‘³é“ï¼Œä½¿ç”¨ Kosher salt å°±ä¸ä¼šæœ‰è¿™äº›é—®é¢˜</p><p>å¦å¤–ï¼ŒKosher salt ç”±äºæ™¶ä½“é¢—ç²’æ›´å¤§ï¼Œèƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°ä»è‚‰ç±»ä¸­å¸æ”¶æ°´åˆ†ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å¸®åŠ©è‚‰ç±»è¿›è¡Œç¬¦åˆçŠ¹å¤ªäººæ•™è§„å¤„ç†ï¼ˆé™¤å»è¡€æ¶²ï¼‰ï¼Œè¿™ç§å¤„ç†åçš„é£Ÿç‰©ç§°ä¹‹ä¸º Kosher foodï¼Œè¿™ä¹Ÿæ˜¯ Kosher salt åå­—çš„ç”±æ¥</p></blockquote><blockquote><p>1 pinch</p><p>ç¿»è¯‘ä¸ºä¸€æ’®</p><p>a pinch of salt å¾€å¾€ä¹Ÿè¡¨ç¤º â€œä¸å¯å°½ä¿¡â€</p><p>take â€¦ with a pinch of salt â€œå¯¹ â€¦ ä¸å¯å°½ä¿¡ã€æŒä¿ç•™æ„è§â€</p></blockquote><p>åœ¨ä¸€ä¸ªç¢—ä¸­æ··åˆç³–æµ†ã€é¦™è‰ç²¾ã€ä¹³é…¸ç²‰å’Œç›</p><p>ä½¿ç”¨æ…æ‹Œå™¨æ…æ‹Œï¼Œç›´åˆ°ä¹³é…¸å’Œç›æº¶è§£ï¼›å€’å…¥å¯†å°å®¹å™¨ä¸­å†·è— 4 å‘¨</p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES çš„é™åˆ¶å’Œç–‘éš¾é—®é¢˜</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%E9%99%90%E5%88%B6%E3%80%81%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%E9%99%90%E5%88%B6%E3%80%81%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98.html</url>
      
        <content type="html"><![CDATA[<blockquote><p> <em><strong>Programmers know the benefits of everything and the tradeoffs of nothing.</strong></em></p><p><em>ç¨‹åºå‘˜çŸ¥é“ä»»ä½•äº‹æƒ…çš„æ”¶ç›Šï¼Œå´ä¸å»æƒè¡¡åˆ©å¼Š</em></p><p><a href="https://www.simplethread.com/relational-databases-arent-dinosaurs-theyre-sharks/">Relational Databases Arenâ€™t Dinosaurs, Theyâ€™re Sharks - Simple Thread</a></p></blockquote><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä½¿ç”¨å…³ç³»å‹æ•°æ®çš„æ€æƒ³å»æ“ä½œ ESï¼Œä¼šå‘ç°å¾ˆå¤šåŠŸèƒ½çš„å®ç°å’Œæƒ³è±¡ä¸­æœ‰å‡ºå…¥</p><p>æˆ–è€… ES èƒ½å¤Ÿå®ç°å¾ˆå¤šæ“ä½œï¼Œä½†åŒæ—¶åˆæœ‰å¾ˆå¤šé™åˆ¶ï¼Œåœ¨è§£å†³äº†ä¸€äº›é—®é¢˜åŸºç¡€ä¸Šï¼ˆå¤©ç„¶åˆ†å¸ƒå¼é€‚åˆå¤§æ•°æ®é‡ã€top hit è¿™ç§æ–¹ä¾¿çš„åŠŸèƒ½ã€æ¨¡ç³Šæœç´¢åˆ†è¯å™¨ï¼‰ï¼Œæ˜¯å¦ä¹Ÿå¼•å…¥äº†ä¸€äº›æ–°é—®é¢˜</p><p>è®°å½•ä¸‹ ES éš¾ä»¥å¤„ç†çš„é—®é¢˜ä»¥åŠå½“å‰çš„å¤„ç†æ–¹æ³•ï¼Œæ˜¯å¦å¯ä»¥æœ‰æ›´å¥½çš„å¤„ç†æ–¹å¼ï¼Œæˆ–è€…é€‰å‹ä¸­é¿å…å¤„ç†æ­¤ç±»é—®é¢˜</p><h1 id="æ·±åº¦åˆ†é¡µ"><a href="#æ·±åº¦åˆ†é¡µ" class="headerlink" title="æ·±åº¦åˆ†é¡µ"></a>æ·±åº¦åˆ†é¡µ</h1><p>ES ä½œä¸ºå¤©ç„¶çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ•°æ®åˆ†æ•£è‡³å„ä¸ª shard è¿›è¡Œå­˜å‚¨</p><p>å¸¦æ¥çš„é—®é¢˜å°±æ˜¯éšç€åˆ†é¡µæ·±åº¦çš„å¢åŠ ï¼Œæˆæœ¬çš„å¢åŠ ä¹Ÿä¼šæ›´åŠ æ˜æ˜¾</p><p>ES å‡è®¾ä¸€é¡µæœ‰ 100 æ¡æ•°æ®ï¼Œéœ€è¦æŸ¥è¯¢ç¬¬ 100 é¡µæ•°æ®ï¼ˆå³ from &#x3D; 9900ï¼Œsize &#x3D; 100ï¼‰ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æŸ¥è¯¢ 10000 æ¡æ•°æ®ï¼Œæ±‡æ€»ç»™åè°ƒèŠ‚ç‚¹åï¼Œå†æœ‰åè°ƒèŠ‚ç‚¹æ’åºï¼Œæœ€ç»ˆé€‰å–çœŸå®å‘½ä¸­çš„ 100 æ¡æ•°æ®è¿”å›</p><p>æ‰€ä»¥å¯¹äºæ·±åº¦åˆ†é¡µ ES è¿›è¡Œäº†é™åˆ¶ï¼Œé»˜è®¤çš„é…ç½®æ˜¯ from + size &lt; 10000ï¼Œå¤§äºé™åˆ¶çš„æŸ¥è¯¢æ“ä½œä¼šè¢«æ‹’ç»</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>æ²¡æœ‰å¥½çš„åŠæ³•ï¼Œé™åˆ¶è·³é¡µçš„æ·±åº¦ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢æ›´ç²¾å‡†çš„æ•°æ®å°±å¢åŠ æŸ¥è¯¢æ¡ä»¶æ¥ç¼©å°èŒƒå›´</p><p>ä¸šåŠ¡ç»å¤§å¤šæ•°åœºæ™¯åº”è¯¥ä¹Ÿæ²¡æœ‰æŸ¥çœ‹è¿™ä¹ˆå¤šé¡µæ•°æ®çš„å¿…è¦</p><p>å¯ä»¥ä½¿ç”¨ search afterã€scroll é¿å…æ·±åº¦åˆ†é¡µé™åˆ¶ï¼Œä½†æ˜¯éƒ½æœ‰å„è‡ªåœºæ™¯çš„é™åˆ¶</p><h1 id="ç´¢å¼•åˆ·æ–°é—´éš”"><a href="#ç´¢å¼•åˆ·æ–°é—´éš”" class="headerlink" title="ç´¢å¼•åˆ·æ–°é—´éš”"></a>ç´¢å¼•åˆ·æ–°é—´éš”</h1><p>ç´¢å¼•ä¸‹ä¼šæœ‰ä¸€ä¸ªå‚æ•°å€¼ <code>refresh_interval</code>ï¼Œè¡¨ç¤º ES åˆ·æ–°ç´¢å¼•çš„é—´éš”</p><p>åˆšè¿›è¡Œç´¢å¼•çš„æ–‡æ¡£å¹¶ä¸ä¼šç«‹å³å¯¹æœç´¢å¯è§ï¼Œè€Œæ˜¯æ»¡è¶³ä¸€å®šçš„è¦æ±‚åæ‰ä¼šå°† buffer ä¸­çš„æ•°æ®å»ºç«‹ç´¢å¼•å†™å…¥æ–‡ä»¶åŒºï¼Œå…¶ä¸­ <code>refresh_interval</code> å‚æ•°æŒ‡å®šä¸€å®šçš„æ—¶é—´é—´éš”åå°†æ•°æ®è¿›è¡Œç´¢å¼•</p><p><code>refresh_interval</code>  çš„å•ä½ï¼š</p><ul><li>ms</li><li>s</li><li>m</li></ul><p>å•ä½ç¼ºçœå€¼ä¸º msï¼Œå¦‚æœé…ç½®ä¸º <code>-1</code> åˆ™è¡¨ç¤ºä¸åˆ·æ–°ç´¢å¼•ï¼Œå½“éœ€è¦å¯¼å‡ºå¤§é‡æ•°æ®æ—¶ï¼Œå¯ä»¥å°† <code>refresh_interval</code> è®¾ç½®ä¸º <code>-1</code> åŠ å¿«å¯¼å…¥é€Ÿåº¦ï¼Œå¯¼å…¥å®Œæˆåå†è®¾ç½®åˆ·æ–°é—´éš”æˆ–è€…æ‰‹åŠ¨åˆ·æ–°</p><p><strong>è®¾ç½® refresh_interval</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /<span class="punctuation">&#123;</span>index<span class="punctuation">&#125;</span>/_settings</span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">  <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>å¼ºåˆ¶åˆ·æ–°</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="punctuation">&#123;</span>index<span class="punctuation">&#125;</span>/_doc?refresh</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>æ ¹æ®ä¸šåŠ¡æƒ…å†µåˆç†è®¾ç½®åˆ·æ–°é—´éš”ï¼Œéœ€è¦å…¼é¡¾ ES å‹åŠ›å’Œæ•°æ®å®æ—¶æ€§è¦æ±‚ï¼Œæš‚æ—¶é…ç½®çš„ 500 ms</p><p>ä½†æ˜¯ scroll + update by doc id çš„æ›´æ–°æ–¹å¼æ˜¯å¦ä¼šå› ä¸º scroll çš„å¿«ç…§ç‰¹æ€§å’Œç´¢å¼•åˆ·æ–°æ—¶é—´é—®é¢˜è€Œå¯¼è‡´æ•°æ®é”™è¯¯ï¼Ÿè¿™ç§æƒ…å†µæ€ä¹ˆé¿å…</p><p>ä¸åŠæ—¶åˆ·æ–°ä¹Ÿä¼šå¯¼è‡´ update by query æ“ä½œå†²çª</p><h1 id="æ ¹æ®æ¡ä»¶æ›´æ–°-update-by-query"><a href="#æ ¹æ®æ¡ä»¶æ›´æ–°-update-by-query" class="headerlink" title="æ ¹æ®æ¡ä»¶æ›´æ–° update by query"></a>æ ¹æ®æ¡ä»¶æ›´æ–° update by query</h1><p>update by query æ“ä½œçœ‹èµ·æ¥ç±»ä¼¼ SQL ä¸­çš„ <code>UPDATE FROM ... SET ... WHERE ...</code>ï¼Œä½†ä½¿ç”¨èµ·æ¥ä¹Ÿæœ‰å¾ˆå¤šé™åˆ¶</p><p>æ›´æ–°å†…å®¹ä½¿ç”¨ script æŒ‡å®šï¼Œä¾‹å¦‚ï¼Œå§“åä¸º <code>å¼ ä¸‰</code> çš„æ•°æ® age + 1 </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST my-index/_update_by_query</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ctx._source.age++&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;painless&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å› ä¸º ES çš„é”æœºåˆ¶æ¯”è¾ƒç®€å•ï¼Œå¯¹äºå†²çªåªèƒ½é€‰æ‹©ä¸¤ç§æ“ä½œ</p><blockquote><p><strong><code>conflicts</code></strong></p><p>(Optional, string) What to do if update by query hits version conflicts: <code>abort</code> or <code>proceed</code>. Defaults to <code>abort</code>.</p></blockquote><p>åŒæ—¶éœ€è¦è¿›è¡Œæ‰‹åŠ¨åˆ·æ–°ï¼Œå¦åˆ™å¯èƒ½ä¼šé¢‘ç¹å†²çª</p><blockquote><p><strong><code>refresh</code></strong></p><p>(Optional, Boolean) If <code>true</code>, Elasticsearch refreshes affected shards to make the operation visible to search. Defaults to <code>false</code>.</p></blockquote><p>æ­¤å¤–ï¼ŒES å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯é€šè¿‡ REST è¿›è¡Œäº¤äº’ï¼Œè¿æ¥æ—¶é—´æ˜¯å­˜åœ¨é™åˆ¶çš„ï¼Œé»˜è®¤æ˜¯ 30 s</p><p>å½“è„šæœ¬å…·æœ‰ä¸€å®šçš„å¤„ç†é€»è¾‘ï¼Œå¹¶ä¸”æ•°æ®é‡è¾ƒå¤§ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨é™åˆ¶æ—¶é—´å†…æ²¡æœ‰å¤„ç†å®Œæˆï¼Œå°±ä¼šæŠ›å‡ºè¶…æ—¶å¼‚å¸¸</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>é…ç½®è¿æ¥æ—¶é—´ï¼Œå‡å°‘æ›´æ–°çš„æ–‡æ¡£æ•°é‡ï¼Œæ¯æ¬¡å†™å…¥éƒ½è¿›è¡Œæ›´æ–°</p><h1 id="list-å­—æ®µå¢åˆ å…ƒç´ "><a href="#list-å­—æ®µå¢åˆ å…ƒç´ " class="headerlink" title="list å­—æ®µå¢åˆ å…ƒç´ "></a>list å­—æ®µå¢åˆ å…ƒç´ </h1><p>ES mapping ä¸­å­—æ®µæ˜¯ä¸é™åˆ¶å…ƒç´ æ•°é‡çš„ï¼ˆæ„Ÿè§‰å’Œç´¢å¼•çš„å®ç°æ–¹å¼æœ‰å…³ï¼‰</p><p>ä¾‹å¦‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;my-index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field_1&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;field_2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ•°æ®å¯ä»¥æ˜¯</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;field_1&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;field_2&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨æ›´æ–° list å­—æ®µæ—¶å°±éœ€è¦è€ƒè™‘æ›´æ–°æ–¹å¼ï¼Œå¦‚æœæ˜¯åˆ·æ–°æ–‡æ¡£è¿›è¡Œè¦†ç›–ï¼Œä¼šä¸ä¼šå‡ºç°æ•°æ®é”™è¯¯ï¼Ÿ</p><p>å‡è®¾ä¸€ä¸ªæ“ä½œè¦ç»™å­—æ®µå¢åŠ ä¸€ä¸ªå…ƒç´  1ï¼Œè€Œå¦ä¸€ä¸ªæ“ä½œè¦åˆ é™¤å…ƒç´  2</p><table><thead><tr><th align="center">æ—¶é—´</th><th align="center">çº¿ç¨‹ 1</th><th align="center">çº¿ç¨‹ 2</th></tr></thead><tbody><tr><td align="center">T1</td><td align="center">æŸ¥è¯¢æ–‡æ¡£æ•°æ® docï¼Œå¾—åˆ° field &#x3D; [2,3]</td><td align="center">&#x2F;</td></tr><tr><td align="center">T2</td><td align="center">å¤„ç†å¾—çŸ¥ï¼Œéœ€è¦å†™å…¥çš„æ•°æ® field &#x3D; [1,2,3]</td><td align="center">æŸ¥è¯¢æ–‡æ¡£æ•°æ® docï¼Œå¾—åˆ° field &#x3D; [2,3]</td></tr><tr><td align="center">T3</td><td align="center">å†™å…¥ ESï¼Œfield &#x3D; [1,2,3]</td><td align="center">å¤„ç†å¾—çŸ¥ï¼Œéœ€è¦å†™å…¥çš„æ•°æ® field &#x3D; [3]</td></tr><tr><td align="center">T4</td><td align="center">&#x2F;</td><td align="center">å†™å…¥ ESï¼Œfield &#x3D; [3]</td></tr></tbody></table><p>æœ€ç»ˆå¯¼è‡´æ•°æ®é”™è¯¯ï¼ˆæ²¡æœ‰ DB çš„é”æœºåˆ¶é‚£ä¹ˆæ–¹ä¾¿ï¼‰</p><p><strong>update by query</strong></p><p>å½“ç„¶å¯ä»¥ä½¿ç”¨ update by query æ¥ä½¿ç”¨è„šæœ¬è¿›è¡Œæ“ä½œï¼Œç›¸å½“äºæŠŠä¸€éƒ¨åˆ†è¿ç®—é€»è¾‘æ”¾åœ¨äº† ES æ¥æ‰§è¡Œ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST my-index/_update_by_query</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;if(ctx._source.projectIds == null)&#123;ctx._source.projectIds = [];ctx._source.projectIds.add(params.id);&#125;else&#123;def index = ctx._source.projectIds.indexOf(params.id);if(index == -1)&#123;ctx._source.projectIds.add(params.id);&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;painless&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>ä½¿ç”¨ update by query è„šæœ¬è¿›è¡Œå¢åˆ ï¼Œé…ç½®è¿æ¥æ—¶é—´ï¼Œé™åˆ¶æ›´æ–°çš„æ•°æ®é‡ï¼ˆæ—¶é—´ä½œä¸ºæ¡ä»¶ï¼‰</p><h1 id="æŠ˜å ã€èšåˆä¸æ”¯æŒæ»šåŠ¨æŸ¥è¯¢"><a href="#æŠ˜å ã€èšåˆä¸æ”¯æŒæ»šåŠ¨æŸ¥è¯¢" class="headerlink" title="æŠ˜å ã€èšåˆä¸æ”¯æŒæ»šåŠ¨æŸ¥è¯¢"></a>æŠ˜å ã€èšåˆä¸æ”¯æŒæ»šåŠ¨æŸ¥è¯¢</h1><p>scrollï¼Œsearch after å¯ä»¥ä¸å—æ·±åº¦åˆ†é¡µçš„é™åˆ¶ï¼Œç°åœ¨çš„å®¢æˆ·ç«¯å¯¹äº scroll æ“ä½œåŒ…è£…çš„æ¯”è¾ƒç®€å•ï¼ˆæ²¡æ³•æŒ‡å®šæ•°æ®é›† sizeï¼‰ï¼Œå¹¶ä¸”ä¸€æ¬¡æ€§å–å‡ºæ‰€æœ‰æ•°æ®è¿›å…¥å†…å­˜</p><p>æ‰€ä»¥ä½¿ç”¨ search after æ¥å®ç°å¯¹æ›´å¤§é‡æ•°æ®çš„æŸ¥è¯¢ï¼ˆå¯¼å‡ºï¼‰</p><p>ä½†æŠ˜å ï¼ˆCollapseï¼‰å’Œèšåˆï¼ˆAggregationsï¼‰æ“ä½œæ— æ³•æ”¯æŒ scroll æˆ–è€… search after çš„æŸ¥è¯¢æ–¹å¼</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å¯¹äºæŠ˜å æˆ–è€…èšåˆçš„æ•°æ®ä½¿ç”¨åˆ†é¡µè¿›è¡ŒæŸ¥è¯¢ï¼Œæ— æ³•é¿å…æ·±åº¦åˆ†é¡µçš„é™åˆ¶</p><h1 id="èšåˆæ¡¶æ•°é‡é™åˆ¶"><a href="#èšåˆæ¡¶æ•°é‡é™åˆ¶" class="headerlink" title="èšåˆæ¡¶æ•°é‡é™åˆ¶"></a>èšåˆæ¡¶æ•°é‡é™åˆ¶</h1><p>ES çš„èšåˆä»åŠŸèƒ½ä¸Šå¯ä»¥åˆ†ä¸º 3 ç±»ï¼š</p><ul><li>æ¡¶èšåˆï¼ˆBucketï¼‰ï¼šå¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ï¼ˆåˆ†æ¡¶ï¼‰ï¼›ç±»ä¼¼ <code>GROUP BY</code><ul><li>Date histogram æ—¥æœŸç›´æ–¹å›¾</li><li>Range èŒƒå›´</li><li>Terms å­—æ®µå€¼</li><li>â€¦</li></ul></li><li>æŒ‡æ ‡èšåˆï¼ˆMetricï¼‰ï¼šå¯¹æ¡¶å†…æ•°æ®è¿›è¡ŒæŒ‡æ ‡çš„è®¡ç®—ï¼›ç±»ä¼¼èšåˆå‡½æ•°<ul><li>Avg å¹³å‡æ•°</li><li>Max æœ€å¤§å€¼</li><li>Sum æ±‚å’Œ</li><li>â€¦</li></ul></li><li>ç®¡é“èšåˆï¼ˆPipelineï¼‰ï¼šä»¥å…¶ä»–èšåˆä½œä¸ºå…ƒæ•°æ®çš„èšåˆï¼›ç›¸å½“äºåœ¨å…¶ä»–èšåˆçš„åŸºç¡€ä¸Šå†æ¬¡è¿›è¡Œæ“ä½œ<ul><li>Bucket selector æ¡¶é€‰æ‹©å™¨</li><li>Bucket sort æ¡¶æ’åº</li><li>Max bucket æœ€å¤§çš„æ¡¶</li><li>â€¦</li></ul></li></ul><p>æ¡¶èšåˆä¸­æœ€å¸¸è§çš„åœºæ™¯å°±æ˜¯æ ¹æ®å­—æ®µå€¼è¿›è¡Œåˆ†æ¡¶ï¼ˆç›¸å½“äº <code>GROUP BY</code> å¤šä¸ªå­—æ®µï¼‰</p><p>ä½†æ˜¯ ES ä¸­å¯¹äºæ¡¶çš„æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œå½“ä¸€æ¬¡è¯·æ±‚è¶…è¿‡æ¡¶æ•°é‡é™åˆ¶ï¼ˆé»˜è®¤ä¸º <code>123</code>ï¼‰ï¼Œåˆ™æŸ¥è¯¢ä¼šè¿”å›é”™è¯¯  <code>trying to create too many buckets. must be less than or equal to: [100000] but was [100001]</code></p><p>è¿™æ˜¯ 6.x ä»¥åç‰ˆæœ¬çš„ç‰¹æ€§ï¼Œ ç›®çš„æ˜¯é™åˆ¶å¤§æ‰¹é‡èšåˆæ“ä½œï¼Œ è§„é¿æ€§èƒ½é£é™©</p><p>å½“ç„¶å¯ä»¥è¿›è¡Œé…ç½®ï¼Œä½†ä¹Ÿå°±æ„å‘³ç€å¯èƒ½æ‰¿æ‹…æ›´å¤šçš„æ€§èƒ½é£é™©</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;search.max_buckets&quot;</span><span class="punctuation">:</span> <span class="number">20000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>æ¡¶èšåˆçš„ size</strong></p><p>åŒæ—¶ï¼Œæ¡¶èšåˆéœ€è¦æŒ‡å®š <code>size</code> å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ ES å¹¶ä¸ä¼šç›´æ¥è®¡ç®—å‡ºæ‰€æœ‰çš„æ¡¶</p><p>å‡è®¾ <code>size</code> è®¾ç½®ä¸º <code>1000</code>ï¼Œæ­¤æ—¶æ•°æ®ä¸­æ ¹æ®æŸä¸ªç»´åº¦åˆ†æ¡¶æœ‰ <code>1500</code> ä¸ªï¼Œé‚£ä¹ˆ ES åªä¼šé€‰æ‹© top 1000 ä¸ªæ¡¶è¿›è¡Œè¿”å›</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å¯¹äºæ¡¶èšåˆçš„ <code>size</code>ï¼Œç»™å®šä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œåœ¨çŸ­æœŸå†…åº”è¯¥ä¸ä¼šå‡ºç°è¿™ä¹ˆæ¡¶ï¼Œå¦‚æœè¶…å‡ºé™åˆ¶åˆ™ç”±æŸ¥è¯¢é€»è¾‘æ‰‹åŠ¨è¿›è¡Œæ¡¶çš„åˆ’åˆ†ï¼ŒåŒæ—¶ä¸šåŠ¡æ˜¯ä¸æ˜¯ä¸šåŠ¡è¦æ€è€ƒï¼Œéœ€ä¸éœ€è¦å…³æ³¨ä¸€ä¸ªç»´åº¦æ•°æ®ä¸‹æ‰€æœ‰å€¼çš„ç»“æœï¼ˆæ¯”å¦‚åªå…³æ³¨ top çš„æ•°æ®ï¼‰</p><p>å¯¹äºæ¡¶æ•°é‡æ˜¾ç¤ºï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼Œå®šæ—¶èšåˆä¸­é—´ç»“æœï¼ˆç‰ºç‰²å®æ—¶æ€§ï¼Œå¯¹æŸ¥è¯¢æœ‰åˆ©ï¼‰ï¼Œèšåˆè¿‡ç¨‹ä¸­å¯ä»¥æ‰‹åŠ¨æ‹†åˆ†èšåˆç»´åº¦æ¥å‡å°‘æ¡¶çš„æ•°é‡</p><h1 id="èšåˆåæ’åºå’Œåˆ†é¡µ"><a href="#èšåˆåæ’åºå’Œåˆ†é¡µ" class="headerlink" title="èšåˆåæ’åºå’Œåˆ†é¡µ"></a>èšåˆåæ’åºå’Œåˆ†é¡µ</h1><p>èšåˆåæ˜¯æ— æ³•æŒ‰ç…§æ–‡æ¡£å†…å­—æ®µé¡ºåºæ¥è¿›è¡Œæ’åºçš„ï¼ˆè¿™ç‚¹åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­åº”è¯¥ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œä½†æ˜¯ ES çš„æŠ˜å æ“ä½œå¯ä»¥æŒ‰ç…§æ–‡æ¡£é¡ºåºè¿›è¡Œ</p><p>èšåˆåçš„æ’åºè‚¯å®šåªèƒ½é€šè¿‡èšåˆç»´åº¦æ¥è¿›è¡Œæ’åºï¼ˆæ¡¶èšåˆçš„ key æˆ–è€…æŒ‡æ•°èšåˆçš„ç»“æœï¼‰ï¼Œæ’åºå’Œåˆ†é¡µçš„å®ç°ä½¿ç”¨ç®¡é“èšåˆä¸­çš„ <code>Bucket sort</code> å®ç°</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;sales_per_month&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;date_histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;calendar_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;month&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total_sales&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;sum&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sales_bucket_sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;bucket_sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span> <span class="attr">&quot;total_sales&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span> </span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">3</span>                                </span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ“ä½œï¼š</p><ul><li>å¯¹æ—¥æœŸæŒ‰æœˆè¿›è¡Œæ¡¶èšåˆ</li><li>å¯¹ <code>price</code> å­—æ®µè¿›è¡Œ <code>sum</code> çš„æŒ‡æ•°èšåˆ</li><li>å¯¹æ¡¶èšåˆè¿›è¡Œæ’åºå’Œåˆ†é¡µï¼ŒæŒ‰ç…§æŒ‡æ•°èšåˆ <code>total_sales</code> ç»“æœå€’åºï¼Œå– 3 æ¡æ•°æ®</li></ul><p>è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯åµŒå¥—çš„æ¡¶èšåˆï¼Œ<code>bucket_sort</code> æ˜¯æ— æ³•å¯¹ä¸Šå±‚æ¡¶ï¼Œæˆ–è€…å¯¹å…¨å±€çš„æ¡¶è¿›è¡Œåˆ†é¡µæ“ä½œ</p><blockquote><p>ES æ–‡æ¡£åŸæ–‡ <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/search-aggregations-pipeline-bucket-sort-aggregation.html">Bucket sort aggregation | Elasticsearch Guide [8.5] | Elastic</a></p><p>The <code>bucket_sort</code> aggregation, like all pipeline aggregations, is executed after all other non-pipeline aggregations. This means the sorting only applies to whatever buckets are already returned from the parent aggregation. For example, if the parent aggregation is <code>terms</code> and its <code>size</code> is set to <code>10</code>, the <code>bucket_sort</code> will only sort over those 10 returned term buckets.</p></blockquote><p>åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå‡è®¾å¯¹ Aã€B å­—æ®µè¿›è¡Œèšåˆæ“ä½œï¼Œç„¶ååœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œåˆ†é¡µåæœ‰ 5 æ¡æ•°æ®</p><p>A - 1ã€A - 2ã€B - 1ã€B - 2ã€B - 3</p><p>é‚£ä¹ˆä½¿ç”¨ <code>bucket_sort</code> åˆ†é¡µåï¼Œå‡è®¾ <code>from = 0ï¼Œsize = 1</code></p><p>ç†æƒ³æƒ…å†µä¸‹æ˜¯åªè¿”å› A - 1 è¿™ä¸€æ¡</p><p>ä½†å› ä¸ºåªå¯¹ <code>parent</code> æ¡¶æœ‰æ•ˆï¼Œå®é™…çš„è¿”å›ä¼šæ˜¯</p><p>A - 1 å’Œ B - 1ï¼Œå› ä¸º <code>size</code> åªé™åˆ¶äº† B å­—æ®µåˆ†æ¡¶çš„æ¡¶æ•°é‡</p><blockquote><p>æ‘˜è‡ªç½‘ç»œ <a href="https://blog.csdn.net/weixin_29715563/article/details/112106227">https://blog.csdn.net/weixin_29715563/article/details/112106227</a></p><p>å¼ è¶…å¤§ä½¬æŒ‡å‡ºï¼šåˆ†æç³»ç»Ÿé‡Œè·‘å…¨é‡çš„ group by æˆ‘è§‰å¾—æ˜¯åˆç†çš„éœ€æ±‚ï¼Œ clickhouse å¾ˆæ“…é•¿åšè¿™ç§äº‹ï¼Œes å¦‚æœä¸åœ¨è¿™æ–¹é¢åŠ å¼ºï¼Œåˆ†æåœºæ™¯å¾ˆå¤šä¼šè¢« clickhouse æ›¿æ‰</p><p>è…¾è®¯å¤§ä½¬æŒ‡å‡ºï¼šèšåˆè¿™å—æ¯”è¾ƒçœ‹åœºæ™¯ã€‚å› ä¸ºæˆ‘è¿™è¾¹æœ‰ä¸€äº›ä¸šåŠ¡æ˜¯åšèšåˆï¼Œä¹Ÿå°±æ˜¯ olap åœºæ™¯ï¼Œå¤šç»´åˆ†æï¼ŒES å¹¶ä¸æ˜¯ç‰¹åˆ«æ“…é•¿ï¼Œå¦‚æœæœ‰ä¸°å¯Œçš„å¤šç»´åˆ†æåœºæ™¯ï¼Œè¿˜æœ‰æ¯”è¾ƒé«˜çš„æ€§èƒ½è¦æ±‚ã€‚æˆ‘å»ºè®®å¯ä»¥è°ƒç ”ä¸‹ clickhouseã€‚æˆ‘ä»¬è¿™è¾¹æµ‹è¯„è¿‡å¼€æºå’Œå†…éƒ¨çš„å¤§éƒ¨åˆ†åœºæ™¯ clickhouse å‡ åäº¿çš„çº§åˆ«ï¼ŒåŸºæœ¬ä¹Ÿåœ¨ç§’çº§è¿”å›ç”šè‡³æ¯«ç§’çº§</p></blockquote><p><strong>Kibana æ˜¯æ€æ ·å®ç°çš„</strong></p><p>åœ¨ Kibana ä¸Šé…ç½®å›¾è¡¨ï¼Œçœ‹èµ·æ¥èƒ½ç›´æ¥å®ç°å¾ˆç±»ä¼¼çš„åŠŸèƒ½</p><img src="/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%E9%99%90%E5%88%B6%E3%80%81%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98/Kibana%E7%9A%84%E8%81%9A%E5%90%88%E5%9B%BE%E8%A1%A8.jpg" class=""><p>å¹¶ä¸”è¿˜æ”¯æŒè·³é¡µï¼Œä¸è¿‡çœ‹äº†å…¶è¯·æ±‚ï¼Œåœ¨åˆ·æ–°æ—¶ç›´æ¥è¿›è¡Œäº†ä¸€æ¬¡å¤§è¯·æ±‚ï¼Œè¿”å›äº†æ‰€æœ‰æ•°æ®ï¼Œæœ€ååº”è¯¥æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„åˆ†é¡µæ“ä½œ</p><p>æ‰€ä»¥çœ‹èµ·æ¥ ES çš„èšåˆæœ¬èº«å°±æ— æ³•æ”¯æŒåµŒå¥—åˆ†é¡µçš„æ“ä½œ</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>ä½¿ç”¨é»˜è®¤å€¼ï¼Œå®šæ—¶èšåˆä¸­é—´ç»“æœï¼ˆç‰ºç‰²å®æ—¶æ€§ï¼Œå¯¹æŸ¥è¯¢æœ‰åˆ©ï¼‰ï¼Œå°±å¯ä»¥æ ¹æ®ä¸­é—´ç»“æœè¿›è¡Œåˆ†é¡µäº†ï¼Œä¸šåŠ¡ä¹Ÿéœ€è¦è€ƒè™‘æ˜¯å¦æœ‰å¿…è¦è·³é¡µï¼Œèšåˆåçš„ç»“æœæ˜¯åŠ¨æ€çš„ã€éç›´è§‚çš„ï¼Œè·³é¡µæŸ¥è¯¢è¿˜æœ‰æ„ä¹‰å—</p><p>åŒæ—¶å¯¹äºåµŒå¥—èšåˆã€æŠ˜å çš„åœºæ™¯ï¼Œæ‹¼æ¥ä¸€ä¸ªç”¨äºèšåˆçš„ key ä½œä¸ºèšåˆå­—æ®µï¼ˆç›¸å½“äºä¸šåŠ¡æ•°æ®æ‰‹åŠ¨æ‹¼æ¥ä¸€ä¸ª keyï¼Œä½¿ä¸€å±‚èšåˆå®ç°åµŒå¥—èšåˆçš„æ•ˆæœï¼Œåªèƒ½é’ˆå¯¹å›ºå®šéœ€æ±‚ï¼Œä¸§å¤±äº†çµæ´»æ€§ï¼‰</p><h1 id="æ¡¶èšåˆå‡†ç¡®æ€§"><a href="#æ¡¶èšåˆå‡†ç¡®æ€§" class="headerlink" title="æ¡¶èšåˆå‡†ç¡®æ€§"></a>æ¡¶èšåˆå‡†ç¡®æ€§</h1><p>ES çš„æ¡¶èšåˆä¼šç”±å„ä¸ªåˆ†ç‰‡èšåˆå‡ºç»“æœåå†äº¤ç”±åè°ƒèŠ‚ç‚¹æ±‡æ€»æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯æ­¤æ—¶æ±‡æ€»æ•°æ®æ˜¯æ²¡æœ‰å…¨å±€è§†é‡çš„ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¡¶çš„ä¸å‡†ç¡®</p><p>è¿™ä¸ªå‚æ•°ç”±æ¡¶èšåˆçš„ <code>shard_size</code> è¿›è¡Œæ§åˆ¶ï¼Œé»˜è®¤å–å€¼ä¸º <code>size Ã— 1.5 + 10</code></p><p>ä¹Ÿå°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹åªä¼šèšåˆ <code>shard_size</code> å¤§å°çš„ç»“æœè¿”å›ç»™åè°ƒèŠ‚ç‚¹ï¼Œå†æœ‰åè°ƒèŠ‚ç‚¹åˆå¹¶ç»“æœï¼Œè¿”å›å‡º <code>size</code> æ‰€éœ€æ•°é‡çš„æ¡¶ï¼ˆå¯ä»¥çœ‹å‡º <code>shard size</code> ä¸å¯èƒ½å°äº <code>size</code>ï¼‰</p><p>ä¹Ÿå°±æ˜¯æœ€ç»ˆç»“æœçš„æ¡¶å¹¶ä¸æ˜¯ç»å¯¹å‡†ç¡®çš„ï¼Œéœ€è¦åˆç†è®¾ç½® <code>shard_size</code> å¹³è¡¡å‡†ç¡®æ€§å’Œæ€§èƒ½</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å› ä¸ºèšåˆæ¡¶æ•°é‡é™åˆ¶ï¼Œ<code>size</code> è®¾ç½®äº†ä¸€ä¸ªçŸ­æœŸæ¥çœ‹è¶³å¤Ÿå¤§çš„å€¼ï¼Œæ‰€ä»¥ <code>shard_size</code> åŒæ ·å¾ˆå¤§</p><p>åº”è¯¥æš‚æ—¶ä¸ä¼šå­˜åœ¨æ¡¶ä¸å‡†ç¡®é—®é¢˜</p><h1 id="åŸºæ•°èšåˆå‡†ç¡®æ€§"><a href="#åŸºæ•°èšåˆå‡†ç¡®æ€§" class="headerlink" title="åŸºæ•°èšåˆå‡†ç¡®æ€§"></a>åŸºæ•°èšåˆå‡†ç¡®æ€§</h1><p>å› ä¸ºåˆ†é¡µå±•ç¤ºçš„è¦æ±‚ï¼Œå¯¹äºèšåˆæˆ–è€…æŠ˜å åï¼Œéœ€è¦ç»Ÿè®¡æ¡¶çš„æ•°é‡</p><p>åµŒå¥—æ“ä½œæ— æ³•è¿›è¡ŒåŸºæ•°èšåˆï¼Œæ‰€ä»¥æ­¤å¤„ä¹Ÿä½¿ç”¨äº†ä¸šåŠ¡æ‰‹åŠ¨æ‹¼æ¥çš„èšåˆ keyï¼Œè¿›è¡Œ <code>cardinality</code> æ“ä½œ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=<span class="number">0</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸºæ•°èšåˆè™½ç„¶å¯ä»¥ç»Ÿè®¡å‡ºåŸºæ•°ï¼Œä½†åº•å±‚ä½¿ç”¨ HyperLogLog è¿›è¡Œå®ç°ï¼Œä¹Ÿå°±æ˜¯å¸¦æœ‰ä¸€å®šçš„è¯¯å·®</p><p><img src="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/images/cardinality_error.png" alt="cardinality_error.png (1000Ã—400) (elastic.co)"></p><p>è¯¯å·®æ˜¯æ¯”è¾ƒå°çš„ï¼Œå³ä½¿é˜ˆå€¼ä½è‡³ 100ï¼Œå³ä½¿åœ¨ç™¾ä¸‡ + åŸºæ•°æ—¶ï¼Œè¯¯å·®ä»ç„¶å¾ˆä½ï¼ˆå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸º1 - 6%ï¼‰</p><p>å…è®¸è¯¯å·®å­˜åœ¨ä¼šå¯¼è‡´æœ€ç»ˆæ€»é¡µæ•°ä¸å‡†ç¡®ï¼Œæˆ–è€…æ¯æ¬¡æŸ¥è¯¢éƒ½æœ‰æ‰€åŒºåˆ«</p><p>ä¸è¿‡ <code>cardinality</code> æ”¯æŒç²¾åº¦å‚æ•° <code>precision_threshold</code>ï¼Œå¦‚æœåŸºæ•°æ•°é‡åœ¨æŒ‡å®šç²¾åº¦ä»¥å†…ï¼Œé‚£ä¹ˆå°±ä¸å­˜åœ¨è¯¯å·®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=<span class="number">0</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;precision_threshold&quot;</span><span class="punctuation">:</span> <span class="number">100</span> </span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å› ä¸ºæœ¬èº« ES å°±æœ‰æ·±åº¦åˆ†é¡µçš„é™åˆ¶ï¼ˆé»˜è®¤ 10000ï¼‰ï¼Œæ‰€ä»¥å¯¹äºåŸºæ•°èšåˆä¹ŸæŒ‡å®šäº† <code>precision_threshold = 10000</code></p><p>è¿™æ ·å¯¹äºåŸºæ•° 10000 ä»¥å†…çš„æ•°æ®ä¼šè¿”å›ç²¾ç¡®å€¼ï¼Œè¶…è¿‡ 10000 å°±ä¸éœ€è¦å…³æ³¨ç²¾ç¡®çš„å€¼ï¼Œåªå‘å‰ç«¯è¿”å› 10000 é™åˆ¶è·³é¡µæ·±åº¦</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lua åŸºæœ¬è¯­æ³•</title>
      <link href="/%E5%BC%80%E5%8F%91/Redis/Lua%20%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95.html"/>
      <url>/%E5%BC%80%E5%8F%91/Redis/Lua%20%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95.html</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h1><h2 id="å˜é‡å®šä¹‰"><a href="#å˜é‡å®šä¹‰" class="headerlink" title="å˜é‡å®šä¹‰"></a>å˜é‡å®šä¹‰</h2><p><strong>åŸºæœ¬çš„æ“ä½œ</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="number">2</span></span><br><span class="line">str = <span class="string">&quot;hello world&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a + b)</span><br><span class="line"><span class="built_in">print</span>(str)</span><br></pre></td></tr></table></figure><p><strong>å¤šé‡èµ‹å€¼è¯­å¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a,b = <span class="number">1</span>,<span class="number">2</span>;</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><p><strong>å€¼ä¸º nil</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--å€¼ä¸ºnil</span></span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment">--å€¼ä¸ºnil</span></span><br></pre></td></tr></table></figure><p><strong>åå…­è¿›åˆ¶ä¸ç§‘å­¦è®¡æ•°æ³•</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0x11</span></span><br><span class="line">b = <span class="number">2e10</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><h2 id="æ•°å­—è¿ç®—ç¬¦"><a href="#æ•°å­—è¿ç®—ç¬¦" class="headerlink" title="æ•°å­—è¿ç®—ç¬¦"></a>æ•°å­—è¿ç®—ç¬¦</h2><p><strong>Lua æ”¯æŒåŠ å‡ä¹˜é™¤ã€å¹‚ç­‰å¤šç§è¿ç®—</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(a+b)</span><br><span class="line"><span class="built_in">print</span>(a-b)</span><br><span class="line"><span class="built_in">print</span>(a/b)</span><br><span class="line"><span class="built_in">print</span>(a*b)</span><br><span class="line"><span class="built_in">print</span>(b^a)</span><br><span class="line"><span class="built_in">print</span>(a^b)</span><br><span class="line"><span class="built_in">print</span>(a==b)</span><br><span class="line"><span class="built_in">print</span>(a~=b) <span class="comment">--luaçš„ä¸ç­‰äºç¬¦å·ä¸º&quot;~=&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a&gt;=b)</span><br><span class="line"><span class="built_in">print</span>(a&lt;=b)</span><br></pre></td></tr></table></figure><h2 id="é€»è¾‘è¿ç®—ç¬¦ä¸-trueã€false"><a href="#é€»è¾‘è¿ç®—ç¬¦ä¸-trueã€false" class="headerlink" title="é€»è¾‘è¿ç®—ç¬¦ä¸ trueã€false"></a>é€»è¾‘è¿ç®—ç¬¦ä¸ trueã€false</h2><p><strong>æ³¨æ„ï¼š0 ä¸º trueï¼Œnil ä¸º false</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="literal">nil</span></span><br><span class="line">b = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"><span class="built_in">print</span>(a <span class="keyword">and</span> b)</span><br><span class="line"><span class="built_in">print</span>(a <span class="keyword">or</span> b)</span><br><span class="line"><span class="built_in">print</span>(<span class="keyword">not</span> b)</span><br></pre></td></tr></table></figure><p><strong>ä¸‰å…ƒè¡¨è¾¾å¼</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a &lt;=<span class="number">0</span> <span class="keyword">and</span> <span class="string">&quot;å°äºç­‰äº 0&quot;</span> <span class="keyword">or</span> <span class="string">&quot;å¤§äº 0&quot;</span>) <span class="comment">--è¾“å‡º&quot;å°äºç­‰äº 0&quot;</span></span><br></pre></td></tr></table></figure><h2 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h2><p><strong>å•å¼•å·åŒå¼•å·å‡å¯</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;hello world a&#x27;</span></span><br><span class="line">b = <span class="string">&quot;hello world b&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><p><strong>è½¬ä¹‰å­—ç¬¦</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;hello world\næ¢è¡Œ&#x27;</span> <span class="comment">--\næ¢è¡Œ</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure><p><strong>ä¸­æ‹¬å·ä¿ç•™åŸå§‹å€¼ï¼ˆå¿½ç•¥è½¬ä¹‰ï¼‰</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">[[&#x27;hello world\næ¢è¡Œ&#x27;]]</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure><p><strong>å­—ç¬¦ä¸²ä½¿ç”¨ â€œ..â€ è¿›è¡Œè¿æ¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;hello &#x27;</span></span><br><span class="line">b = <span class="string">&#x27;world&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a..b)</span><br></pre></td></tr></table></figure><p><strong>tostring(param) ä¸ tonumber(param)</strong><br>å¦‚æœtonumber()è½¬æ¢å¤±è´¥åˆ™å€¼ä¸ºnil</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">tostring</span>(<span class="number">1000</span>)</span><br><span class="line">b = <span class="string">&#x27;world&#x27;</span></span><br><span class="line">c = <span class="built_in">tonumber</span>(<span class="string">&quot;500&quot;</span>)</span><br><span class="line">d = <span class="built_in">tonumber</span>(<span class="string">&quot;str&quot;</span>) <span class="comment">--å€¼ä¸ºnil</span></span><br><span class="line"><span class="built_in">print</span>(a..b)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="built_in">print</span>(d)</span><br></pre></td></tr></table></figure><p><strong>å˜é‡å‰åŠ  â€˜#â€™ è·å–å­—ç¬¦ä¸²é•¿åº¦</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;hello world&quot;</span></span><br><span class="line"><span class="built_in">print</span>(#a)</span><br></pre></td></tr></table></figure><h2 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h2><p><strong>å‡½æ•°çš„åŸºæœ¬å½¢å¼</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a,b)</span></span></span><br><span class="line"><span class="built_in">print</span>(a + b)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p><strong>æ²¡æœ‰ä¼ å‚çš„å‚æ•°å€¼ä¸º nil</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a,b,c)</span></span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p><strong>å¯ä»¥ return å¤šä¸ªå€¼ï¼Œå¤šä¸ªå€¼å¯ä»¥é…åˆå¤šé‡èµ‹å€¼è¯­å¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a,b,c)</span></span></span><br><span class="line"><span class="keyword">return</span> a,b,c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(f(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> aa,bb,cc = f(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(aa)</span><br><span class="line"><span class="built_in">print</span>(bb)</span><br><span class="line"><span class="built_in">print</span>(cc)</span><br></pre></td></tr></table></figure><h2 id="table-ç»“æ„"><a href="#table-ç»“æ„" class="headerlink" title="table ç»“æ„"></a>table ç»“æ„</h2><p><strong>table ç±»ä¼¼æ•°ç»„ï¼Œä½†æ˜¯å¯ä»¥å­˜æ•°å­—ã€å­—ç¬¦ä¸²ã€å…¶ä»– tableã€å‡½æ•°åœ¨ä¸€ä¸ª table ä¸­</strong><br><strong>table ä¸‹æ ‡ä» 1 å¼€å§‹</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p><strong>ä¸‹æ ‡è¶Šç•Œçš„å…ƒç´ ä¸º nil</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">10</span>])</span><br></pre></td></tr></table></figure><p><strong>æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line">tab[<span class="number">10</span>] = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">10</span>])</span><br></pre></td></tr></table></figure><p><strong>æœ€åæ’å…¥å…ƒç´ </strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(tab,<span class="string">&quot;no.n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">5</span>])</span><br></pre></td></tr></table></figure><p><strong>æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(tab,<span class="number">3</span>,<span class="string">&quot;no.3&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">3</span>])</span><br></pre></td></tr></table></figure><p><strong>åˆ é™¤å…ƒç´ </strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(tab,<span class="number">2</span>,<span class="string">&quot;no.2&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> del = <span class="built_in">table</span>.<span class="built_in">remove</span>(tab,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(del)</span><br></pre></td></tr></table></figure><p><strong>å­—ç¬¦ä¸²ä½œä¸ºä¸‹æ ‡ key</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;</span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">b = <span class="string">&#x27;world&#x27;</span>,</span><br><span class="line">c = <span class="number">100</span>,</span><br><span class="line">d = &#123;&#125;,</span><br><span class="line">e = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tab.a)</span><br><span class="line"><span class="built_in">print</span>(tab.b)</span><br><span class="line"><span class="built_in">print</span>(tab.c)</span><br><span class="line"><span class="built_in">print</span>(tab.d)</span><br><span class="line"><span class="built_in">print</span>(tab.e)</span><br></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šç¬¦å·ä¸‹æ ‡</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;</span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tab[<span class="string">&quot;...&quot;</span>] = <span class="string">&quot;....&quot;</span></span><br><span class="line">tab[<span class="string">&quot;abc&quot;</span>] = <span class="string">&quot;abc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tab[<span class="string">&quot;...&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="string">&quot;abc&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(tab.abc)</span><br></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²ä½œä¸ºä¸‹æ ‡å¯ä»¥ä½¿ç”¨ <code>tab.abc</code>ï¼Œç‰¹æ®Šç¬¦å·åªèƒ½é€šè¿‡ <code>tab[&quot;...&quot;]</code> å½¢å¼æŒ‡å®šä¸‹æ ‡</p><h2 id="åˆ†æ”¯åˆ¤æ–­"><a href="#åˆ†æ”¯åˆ¤æ–­" class="headerlink" title="åˆ†æ”¯åˆ¤æ–­"></a>åˆ†æ”¯åˆ¤æ–­</h2><p><strong>ä»¥ if å’Œ end ä¸ºä»£ç å—ï¼Œæ”¯æŒ elseif</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">5</span></span><br><span class="line"><span class="keyword">if</span> a==<span class="number">10</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a==10&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> a == <span class="number">9</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a==9&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> a&gt;<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a&gt;5&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> a&lt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a&lt;=5&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>0 ä¸º trueï¼Œnil ä¸º false</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0</span></span><br><span class="line">b = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;0 is true&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;0 is false&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;nil is true&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;nil is false&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="å¾ªç¯"><a href="#å¾ªç¯" class="headerlink" title="å¾ªç¯"></a>å¾ªç¯</h2><p><strong>èµ·å§‹å€¼ä¸º 0ï¼Œåˆ° 10 ç»“æŸ</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">0</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>èµ·å§‹å€¼ä¸º 10ï¼Œæ­¥é•¿ä¸º -1ï¼Œåˆ° 0 ç»“æŸ</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">0</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>å¾ªç¯ä¸­ i çš„å€¼ä¸èƒ½æ›´æ”¹ï¼ˆå¾ªç¯æ‰€ç”¨çš„å€¼å…¶å®æ˜¯å˜é‡ i çš„å€¼æ‹·è´ï¼‰</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">0</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line">i = <span class="number">5</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>break è¯­å¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">0</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">6</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>while è¯­å¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="number">10</span></span><br><span class="line"><span class="keyword">while</span> num &gt; <span class="number">5</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(num)</span><br><span class="line">num = num - <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><p><strong>string.char() æ”¯æŒåè¿›åˆ¶ã€åå…­è¿›åˆ¶ç­‰</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">104</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">0x6C</span>,<span class="number">0x6f</span>) <span class="comment">--&quot;hello&quot;</span></span><br><span class="line"><span class="built_in">print</span>(s)</span><br></pre></td></tr></table></figure><p><strong>string.byte() å–å‡ºç¬¬ n ä½å­—æ¯çš„åè¿›åˆ¶</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">104</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">0x6C</span>,<span class="number">0x6f</span>)</span><br><span class="line">n = <span class="built_in">string</span>.<span class="built_in">byte</span>(s,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(n)</span><br></pre></td></tr></table></figure><p><strong>0x00 åœ¨ lua å­—ç¬¦ä¸²ä¸­ä¸ä¼šå½±å“å­—ç¬¦ä¸²çš„ç»“æŸï¼Œå–å€¼ä¸º 0</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">104</span>,<span class="number">101</span>,<span class="number">0x00</span>,<span class="number">108</span>,<span class="number">0x6C</span>,<span class="number">0x6f</span>)</span><br><span class="line">n = <span class="built_in">string</span>.<span class="built_in">byte</span>(s,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(n) <span class="comment">--&quot;0&quot;</span></span><br><span class="line"><span class="built_in">print</span>(#s) <span class="comment">--&quot;6&quot;</span></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ‰‹å†Œ"><a href="#å‚è€ƒæ‰‹å†Œ" class="headerlink" title="å‚è€ƒæ‰‹å†Œ"></a>å‚è€ƒæ‰‹å†Œ</h1><p><a href="https://www.runoob.com/manual/lua53doc/contents.html#contents">Lua 5.3 å‚è€ƒæ‰‹å†Œ - ç›®å½• (runoob.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis è„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - AÃ±ejo Highball</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20A%C3%B1ejo%20Highball.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20A%C3%B1ejo%20Highball.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://assets-prd.punchdrink.com/wp-content/uploads/2022/11/17163411/Article-Anejo-Highball-500x687.jpg" alt="Article-Anejo-Highball-500x687.jpg (500Ã—687) (punchdrink.com)"></p><h1 id="æœ‰å¹´ä»£çš„å—¨æ£’-Anejo-Highball"><a href="#æœ‰å¹´ä»£çš„å—¨æ£’-Anejo-Highball" class="headerlink" title="æœ‰å¹´ä»£çš„å—¨æ£’ AÃ±ejo Highball"></a>æœ‰å¹´ä»£çš„å—¨æ£’ AÃ±ejo Highball</h1><p><a href="https://punchdrink.com/recipes/flatliner/"><a href="https://punchdrink.com/recipes/anejo-highball/">AÃ±ejo Highball Cocktail Recipe | PUNCH (punchdrink.com)</a></a></p><blockquote><p>aÃ±ejo (plural aÃ±ejos) - A tequila or rum which has been aged.</p><p>é™ˆå¹´çš„é¾™èˆŒå…°æˆ–è€…æœ—å§†</p></blockquote><p>åœ¨ 90 å¹´ä»£é£é¡ä¸€æ—¶çš„è‹¹æœå’Œè”æå‘³ â€œtinisâ€ ä¸­ï¼Œå‡ºç°äº†ä¸€ç±»æ›´ä¸ºæŸ”å’Œçš„é¸¡å°¾é…’ï¼Œå¯¹ä¸–ç•Œå„åœ°çš„è°ƒé…’æ–¹æ³•äº§ç”Ÿäº†æ·±è¿œçš„å½±å“</p><p>AÃ±ejo Highball å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œå®ƒä»¥æœ—å§†é…’ã€åº“æ‹‰ç´¢é…’ã€é’æŸ æ±å’Œå§œæ±å•¤é…’çš„ç®€å•ç»„åˆï¼Œå´å‘ˆç°å‡ºç²¾å½©ä¸€è¯¾</p><h2 id="åŸæ–™"><a href="#åŸæ–™" class="headerlink" title="åŸæ–™"></a>åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>é™ˆå¹´æœ—å§† - 1.5 ç›å¸</li><li>åº“æ‹‰ç´¢é…’ - 0.5 ç›å¸ï¼ˆ<a href="https://www.diffordsguide.com/beer-wine-spirits/734/pierre-ferrand-dry-curacao">Pierre Ferrand Dry Curacao</a>ï¼‰</li><li>é’æŸ æ± - 0.25 ç›å¸</li><li>å®‰é«˜å¤©å¨œè‹¦ç²¾ - 2 dashesï¼ˆ<a href="https://www.diffordsguide.com/beer-wine-spirits/3505/angostura-orange-bitters">Angostura Orange Bitters</a>ï¼‰<em>æ²¡æœ‰æŒ‡æ˜ Angostura å“ªç§è‹¦ç²¾ï¼Œæ„Ÿè§‰æ©™å‘³å¯èƒ½æ€§æ›´å¤§</em></li><li>å§œæ±å•¤é…’ - 2 ç›å¸</li></ul><p><strong>è£…é¥°ï¼š</strong>é’æŸ è½®ï¼Œæ©™å­åˆ‡ç‰‡</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>åœ¨ç››æ»¡å†°å—çš„æµ·æ³¢æ¯ï¼ˆHighball glassï¼‰ä¸­ï¼ŒåŠ å…¥æœ—å§†é…’ã€åº“æ‹‰ç´¢é…’ã€è±å§†æ±å’Œå®‰é«˜å¤©å¨œè‹¦ç²¾</li><li>é¡¶éƒ¨å€’å…¥å§œæ±å•¤é…’</li><li>ä½¿ç”¨é’æŸ è½®å’Œæ©™å­ç‰‡è¿›è¡Œè£…é¥°</li></ol>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Flatliner</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Flatliner.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Flatliner.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://assets-prd.punchdrink.com/wp-content/uploads/2022/12/20113103/Article-Espresso-Martini-Telluride-Flatliner-Recipe-800x450.jpg"></p><h1 id="å¿ƒè„åœè·³å™¨-Flatliner"><a href="#å¿ƒè„åœè·³å™¨-Flatliner" class="headerlink" title="å¿ƒè„åœè·³å™¨ Flatliner"></a>å¿ƒè„åœè·³å™¨ Flatliner</h1><p><a href="https://punchdrink.com/recipes/flatliner/">Flatliner Espresso Martini Cocktail Recipe Riff | PUNCH (punchdrink.com)</a></p><p>ä¸èˆ¬æŸ”æ»‘ï¼Œæ³¡æ²«å››æº¢ï¼Œç§‘ç½—æ‹‰å¤šå·ï¼ˆColoradoï¼‰ç‰¹è±ç‘å¾·ï¼ˆTellurideï¼‰çš„éæ­£å¼é…’å•ï¼Œå’Œæ„å¼æµ“ç¼©é©¬å¤©å°¼ï¼ˆEspresso Martiniï¼‰å’Œæ³¥çŸ³æµï¼ˆMudslideï¼‰ç›¸ä¼¼ï¼Œä½†å¯¹äºæ»‘é›ªå°é•‡å±…æ°‘è€Œè¨€ï¼Œå®ƒæ˜¯å½“åœ°çš„ç»å…¸</p><p>å°½ç®¡è°ƒé…’å¸ˆå²è’‚å¤« Â· ç¦æ–¯ç‰¹ï¼ˆSteve Fosterï¼‰èµ·åˆæ˜¯åœ¨ The Peaks Resort &amp; Spa ä¾›åº”è¿™ä¸€é¸¡å°¾é…’ï¼Œä½†é…æ–¹å·²ç»ä¼ éäº†æ•´ä¸ªåŸå¸‚</p><p>å¦‚ä»Šä½ ä¼šåœ¨ New Sheridan Chop House çœ‹åˆ°ç¦æ–¯ç‰¹æ­£åœ¨ shaking Flatliner</p><h2 id="åŸæ–™"><a href="#åŸæ–™" class="headerlink" title="åŸæ–™"></a>åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>ä¼ç‰¹åŠ  - 1 ç›å¸</li><li>ç”˜éœ²å’–å•¡åˆ©å£é…’ - 1 ç›å¸ï¼ˆ<a href="https://www.diffordsguide.com/beer-wine-spirits/248/kahlua-coffee-liqueur">KahlÃºa coffee liqueur</a>ï¼‰</li><li>ç™¾åˆ©ç”œé…’ - 1 ç›å¸ï¼ˆ<a href="https://www.diffordsguide.com/beer-wine-spirits/526/baileys-irish-cream-liqueur">Baileys Irish cream liqueur</a>ï¼‰</li><li>æ„å¼æµ“ç¼©å’–å•¡ - 1 ä»½ or å†·æ³¡å’–å•¡ - 1 ç›å¸</li></ul><p><strong>è£…é¥°ï¼š</strong> å’–å•¡è±† - 3 ç²’</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>å°†æ‰€æœ‰åŸæ–™åŠ å…¥è£…æ»¡å†°å—çš„æ‘‡å£¶ï¼Œå¼€å§‹ shake</li><li>æ»¤å…¥è¶å½¢æ¯ï¼ˆCoupe glassï¼‰ï¼Œç„¶åç”¨å’–å•¡è±†ä½œä¸ºè£…é¥°</li></ol>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç²¾é…¿å•¤é…’å…¥é—¨</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E7%B2%BE%E9%85%BF%E5%95%A4%E9%85%92.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E7%B2%BE%E9%85%BF%E5%95%A4%E9%85%92.html</url>
      
        <content type="html"><![CDATA[<h1 id="ç²¾é…¿"><a href="#ç²¾é…¿" class="headerlink" title="ç²¾é…¿"></a>ç²¾é…¿</h1><blockquote><p>åœ¨å…¬å¸çš„æŠ€æœ¯åˆ†äº«å‘¨ä¼šä¸Šè¿›è¡Œåˆ†äº«çš„æ–‡æ¡£</p><p>åªæ˜¯è¿›äº†ç®€å•çš„ä»‹ç»ï¼Œå¹¶ä¸”å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ç®€ç•¥åœ°æè¿°äº†ä¸€ä¸‹</p><p>å¯¹äºä¸äº†è§£ç²¾é…¿çš„æœ‹å‹å¯ä»¥å€Ÿæ­¤äº†è§£ä¸€ä¸‹ Craft Beer</p></blockquote><h2 id="ä»€ä¹ˆæ˜¯-Craft-Beer"><a href="#ä»€ä¹ˆæ˜¯-Craft-Beer" class="headerlink" title="ä»€ä¹ˆæ˜¯ Craft Beer"></a>ä»€ä¹ˆæ˜¯ Craft Beer</h2><p><strong>ç¾å›½çš„ç²¾é…¿è¿åŠ¨</strong></p><p>20 ä¸–çºªå¼€å§‹ï¼Œç¾å›½å…ˆåç»å†ä¸€æˆ˜ã€ç¦é…’ä»¤ã€äºŒæˆ˜ï¼Œå¯¼è‡´å•¤é…’è¿…é€Ÿé€€å‡ºå¸‚åœº</p><p>20 ä¸–çºª 70 å¹´ä»£ï¼Œå…³äºå®¶é…¿å•¤é…’çš„ä¹¦ç±ä»è‹±å›½æµå‡ºï¼Œä¹¦ä¸­å‘¼åä½¿ç”¨ç³–æµ†ä¹‹ç±»å¥‡ç‰¹çš„åŸæ–™ï¼›å¼—é›·å¾·.åŸƒå…‹å“ˆå¾·ï¼ˆFred Eckhardtï¼‰å‡ºç‰ˆäº†ä¸€æœ¬é¢˜ä¸ºã€Šæ‹‰æ ¼å•¤é…’è®ºã€‹çš„ä¹¦ï¼Œè™½æ˜¯è–„è–„ä¸€å†Œï¼Œä½†æŠ€æœ¯ä¸Šæè¿°éå¸¸è¯¦ç»†ã€‚å¯ä»¥æ¯«ä¸å¤¸å¼ çš„è¯´ï¼Œå®¶é…¿æ–¹å¼ä¸ºç²¾é…¿å•¤é…’è¿åŠ¨æä¾›äº†æ€æƒ³ã€æ¿€æƒ…å’Œäººç‰©ï¼Œæ˜¯é‡è¦çš„æºæ³‰</p><p>1976 å¹´ï¼Œç¾å›½å¼€å§‹å‡ºç°æœ€æ—©çš„ç²¾é…¿é…’å‚ï¼Œç”Ÿäº§ç“¶ä¸­å‘é…µçš„æ³¢ç‰¹ã€ä¸–æ¶›å’Œæ·¡è‰²è‰¾å°”ä¾›åº”ç»™æ—©å·²ä¹ æƒ¯æ·¡å‘³æ‹‰æ ¼çš„é…’å§</p><p>1978 å¹´ 10 æœˆ 14 å·ï¼Œæ€»ç»Ÿ Jimmy Carter ç­¾ç½²äº† 1337 å·è®®æ¡ˆã€‚è¿™ä»½è®®æ¡ˆå°†å®¶åº­é…¿é€ å°é‡è‡ªäº§è‡ªç”¨çš„å•¤é…’æˆ–çº¢é…’åˆæ³•åŒ–ã€‚ä»æ­¤ï¼Œç¾å›½è§è¯äº†é…¿é…’æ–‡åŒ–çš„å¤å…´å’Œå°å‹é…’å‚çš„è“¬å‹ƒå‘å±•ã€‚åˆ° 1986 å¹´ 3 æœˆï¼Œ5 å®¶è‡ªé…¿é…’å§åœ¨ç¾å›½è¥ä¸š</p><p>ç¾å›½é…’å‚çš„æ€»æ•°ä» 1978 å¹´çš„ 42 å®¶å˜æˆ 2012 å¹´çš„ 2750 å®¶ï¼Œç”šè‡³è¶…è¿‡äº†ç¾å›½æ®–æ°‘åœ°æ—¶ä»£çš„å¤§çº¦æ•°å­—ï¼›å¢é•¿çš„å…¶ä¸­ç»å¤§å¤šæ•°éƒ½æ˜¯å°å‹ç‹¬ç«‹é…’å‚</p><p><strong>ç²¾é…¿çš„ç±»å®˜æ–¹å®šä¹‰</strong></p><p>ç²¾é…¿å¹¶ä¸æ˜¯å•¤é…’çš„æ¦‚å¿µï¼Œè€Œæ˜¯å•¤é…’å‚çš„æ¦‚å¿µ</p><p>ç¾å›½å•¤é…’é…¿é€ å•†åä¼šï¼ˆBrewers Associationï¼‰å‡ºå°çš„æ ‡å‡†ï¼Œå¯¹ç²¾é…¿é…’å‚çš„å®šä¹‰ä¸ºï¼š<strong>å°å‹</strong>ã€<strong>ç‹¬ç«‹</strong>ã€<strong>ä¼ ç»Ÿ</strong></p><ul><li>å°å‹ï¼šå¹´äº§é‡åœ¨ 600 ä¸‡åŠ 600 ä¸‡æ¡¶ä»¥ä¸‹</li><li>ç‹¬ç«‹ï¼šå…¶äº§æƒä¸èƒ½ä¸ºå…¶å®ƒéç²¾é…¿é…’å‚çš„é…’ç±»ä¼ä¸šè´­ä¹°ï¼Œç®¡ç†æˆ–æ§è‚¡è¶…è¿‡ 25%</li><li>ä¼ ç»Ÿï¼šè¦ä½¿ç”¨ä¼ ç»Ÿæˆ–åˆ›æ–°çš„åŸææ–™ï¼Œéµå¾ªä¼ ç»Ÿæˆ–åˆ›æ–°çš„é…¿é€ æ–¹æ³•æ¥å®ç°å…¶é…¿é€ å‡ºå•¤é…’çš„å£å‘³</li></ul><blockquote><p>é¹…å²›ï¼š<a href="https://item.jd.com/100008724119.html">äº¬ä¸œé“¾æ¥</a></p><p>æ‹³å‡»çŒ«ï¼š<a href="http://www.boxingcatbrewery.com/cn/">Boxing Cat Brewery</a></p></blockquote><p><strong>å’Œå·¥ä¸šå•¤é…’çš„åŒºåˆ«</strong></p><ul><li>æ›´é«˜çš„åŸæ–™æˆæœ¬</li><li>æ›´ä¸°å¯Œçš„å•¤é…’é£æ ¼</li><li>æ›´å¤šåˆ›æ„</li><li>å•¤é…’ Pub é—¨åº—ï¼Œæä¾›ç®€é¤</li><li>æ›´è‰ºæœ¯çš„ç¾å­¦è®¾è®¡</li><li>æ›´è´µ</li></ul><p><strong>å·¥å‚åº—</strong></p><p>Craft Beer çš„é…’å‚è§„æ¨¡è¾ƒå°ï¼Œä¸ºäº†çªå‡ºç²¾é…¿çš„ç†å¿µå¾€å¾€ä¼šå°†ç”Ÿäº§å·¥å‚å¯¹å¤–å¼€æ”¾ï¼Œå¯ä»¥é¢„çº¦å‚è§‚</p><p>å·¥å‚åº—æ‘’å¼ƒäº†åˆ†çº§æ‰¹å‘å•†ã€åˆ†çº§ä»£ç†ç­‰ä¸­é—´ç¹å†—ç¯èŠ‚å¯ä»¥é™ä½æˆæœ¬</p><p><a href="https://vitaminseabrewing.com/">VSB (vitaminseabrewing.com)</a></p><p><a href="https://treehousebrew.com/">Tree House Brewing Company</a></p><h2 id="å•¤é…’é£æ ¼"><a href="#å•¤é…’é£æ ¼" class="headerlink" title="å•¤é…’é£æ ¼"></a>å•¤é…’é£æ ¼</h2><p><strong>BJCP</strong></p><p>å•¤é…’å“é…’å¸ˆèµ„æ ¼è®¤è¯åä¼š(BJCPï¼ŒBeer Judge Certification Program) äº 1985 å¹´åˆ›å»ºäºç¾å›½</p><p>å®—æ—¨æ˜¯æ¨å¹¿ä¸ä¼ æ’­å•¤é…’ç›¸å…³çš„å„ç±»çŸ¥è¯†ä¸æ–‡åŒ–ï¼Œæå‡å¤§ä¼—å¯¹å•¤é…’çš„è®¤çŸ¥ã€å“é…’å’Œè¯„ä¼°æ°´å¹³ï¼›åˆ›é€ ä¸€ä¸ªå•¤é…’è¡Œä¸šè§„èŒƒçš„è¯„ä»·ç¨‹åºï¼Œå¼•å¯¼å•¤é…’çˆ±å¥½è€…å¦‚ä½•æ­£ç¡®è¯„ä»·åŠé¥®ç”¨å•¤é…’ï¼Œä¾¿äºå¯¹è¿™äº›é…’ç±»è¿›è¡Œæ’åå’Œè¯„æ¯”</p><p>BJCP å®šæœŸæ¨å‡ºå•¤é…’åˆ†ç±»æŒ‡å—å¯¹å•¤é…’åŠ ä»¥ç§‘å­¦åˆ†ç±»ï¼Œè¯¥æŒ‡å—ä¹Ÿå·²æˆä¸ºä¸–ç•Œå•¤é…’å¸‚åœºçš„é£å‘æ ‡ï¼Œæœ‰åŠ©äºå•¤å‹å“é‰´ã€è‡ªé…¿æ¯”èµ›ç­¹åŠã€é…¿å‹å‚èµ›ã€ç”šè‡³æ–°å•¤é…’é£æ ¼çš„åˆ›æ–°</p><p><a href="D:\Relax\Beer\BJCPä¸–ç•Œå•¤é…’åˆ†ç±»æŒ‡å—ä¸­æ–‡2015ç‰ˆ.pdf">BJCPä¸–ç•Œå•¤é…’åˆ†ç±»æŒ‡å—ä¸­æ–‡2015ç‰ˆ</a></p><p><a href="https://www.bjcp.org/">Beer Judge Certification Program â€“ Promoting beer literacy, recognizing beer tasting and evaluation skills. (bjcp.org)</a></p><p><strong>é”™è¯¯çš„åˆ†ç±»æ–¹å¼</strong></p><p>å•¤é…’ç»å¸¸ä¼šè¢«æŒ‰ç…§é¢œè‰²è¿›è¡Œåˆ†ç±»ï¼Œæ¯”å¦‚é»‘å•¤ã€é»„å•¤ã€ç™½å•¤</p><p>ä½†æ˜¯è¿™ç§åˆ†ç±»æ–¹å¼æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºé£æ ¼å’Œé¢œè‰²æ— å…³ï¼›ä¸€ç§é£æ ¼å¾€å¾€æœ‰ä¸€å®šçš„è‰²åº¦èŒƒå›´ï¼Œä½†å¹¶ä¸å†³å¯¹ï¼Œå¹¶ä¸”è‰²åº¦èŒƒå›´å¯èƒ½ä¹Ÿå¾ˆå¤§ï¼Œæ‰€ä»¥ä¸å¯èƒ½é€šè¿‡é¢œè‰²å»åŒºåˆ†å•¤é…’çš„é£æ ¼</p><p>å•¤é…’çš„è‰²åº¦æ›´å¤šæ¥æºäºé…¿é€ æ—¶æ‰€ç”¨çš„æ·±è‰²éº¦èŠ½æ¯”é‡ï¼Œæƒ³é…¿é€ é»‘è‰²çš„ IPAã€æ›´æµ…çš„ä¸–æ¶›ä¹Ÿæœªå°ä¸å¯</p><p><strong>å·¥ä¸šå•¤é…’ä¹Ÿæœ‰é£æ ¼</strong></p><p>å¸¸è¯´çš„å·¥ä¸šå•¤é…’å…¶å®æ˜¯å±äºæ‹‰æ ¼ï¼ˆLagerï¼‰è¿™ä¸ªå¤§åˆ†ç±»ä¸‹</p><blockquote><p>æ‹‰æ ¼æœ¬èº«ä¹Ÿæ˜¯å•¤é…’åˆ†ç±»ä¸­çš„ä¸€ç§åˆ›æ–°ï¼Œæœ¬èº«æ‹‰æ ¼ä¹Ÿæ˜¯è¾ƒéš¾é…¿é€ çš„å•¤é…’ï¼Œå› ä¸ºå®ƒçš„éš¾ç‚¹åœ¨äºä½æ¸©ã€‚æœ€æ—©åªæœ‰åœ¨å¾·å›½åŒ—éƒ¨ä¸€äº›åå†·åœ°åŒºå°†å•¤é…’æ”¾åœ¨å†°å†·çš„å±±æ´é‡Œçª–è—æ‰å½¢æˆäº†è¿™ç§é£æ ¼ï¼ˆLager åœ¨å¾·è¯­é‡Œæ˜¯çª–è—çš„æ„æ€ï¼‰</p></blockquote><p>é‚£ä¹ˆæ‹‰æ ¼å•¤é…’é£é¡ä¸–ç•Œçš„åŸå› ï¼š</p><ul><li>å£å‘³æ¸…æ·¡ï¼Œæ›´æ¸…çˆ½</li><li>ä»·æ ¼ä¾¿å®œ</li><li>åº¦æ•°è¾ƒä½ï¼Œç¤¾äº¤å±æ€§</li><li>å‘é…µéš¾åº¦å°äºè‰¾å°”å•¤é…’</li><li>æ›´å®¹æ˜“å·¥ä¸šç”Ÿäº§</li><li>é£æ ¼ç¨³å®š</li><li>ä¸»æµå›½å®¶çš„æ¨åŠ¨ï¼Œå…ˆå…¥ä¸ºä¸»</li></ul><p><strong>è‰¾å°”å’Œæ‹‰æ ¼</strong></p><p>è‰¾å°”ï¼ˆAleï¼‰å’Œæ‹‰æ ¼ï¼ˆLagerï¼‰æœ€åˆæŒ‡çš„æ˜¯ä¸åŒçš„é…µæ¯ç±»å‹ï¼Œè€Œé…µæ¯ç±»å‹èƒ½å¸¦æ¥ä¸åŒçš„é£å‘³</p><p><strong>è‰¾å°”</strong>é…µæ¯éœ€è¦æ›´é«˜çš„æ¸©åº¦ï¼ˆ15â„ƒ~25â„ƒï¼‰ï¼Œå‘é…µè¿‡ç¨‹ä¸­äº§ç”Ÿæ›´å¤šçš„ä»£è°¢ç‰©è´¨ï¼Œå…¶ä¸­åŒ…æ‹¬ç»™å•¤é…’æä¾›å¤æ‚é¦™æ°”çš„é…¯ç±»ã€é…šç±»ã€é†›ç±»ç­‰é£å‘³çš„ç‰©è´¨ï¼Œä¹ŸåŒ…æ‹¬ä¸å¥½çš„ç‰©è´¨å¦‚åŒä¹™é…°ç­‰ï¼›å‘é…µæ—¶ä¼šäº§ç”Ÿæ›´å¤šçš„çƒ­é‡</p><p><strong>æ‹‰æ ¼</strong>é…µæ¯éœ€è¦æ¸©åº¦æ›´ä½ï¼ˆ4â„ƒ~12â„ƒï¼‰ï¼Œå‘é…µæ›´åŠ å½»åº•ï¼Œä»£è°¢äº§ç‰©è¾ƒå°‘ï¼Œå‘³é“æ›´åŠ æ¸…å†½ï¼Œå¹²å‡€ï¼Œçˆ½å£</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252037761.jpg" alt="img"></p><p><strong>ç¾å¼é£æ ¼</strong></p><p>ç²¾é…¿è¿åŠ¨å‘èµ·äºç¾å›½ï¼Œæ‰€ä»¥å¦‚ä»Šçš„å•¤é…’é£æ ¼ä¸­ç»å¸¸èƒ½çœ‹åˆ°ä»¥ American å¼€å¤´çš„é£æ ¼åç§°</p><p>ç¾å¼é£æ ¼å’Œä¼ ç»Ÿé£æ ¼ï¼ˆPale Ale å’Œ American Pale Aleã€Lager å’Œ American Lagerï¼‰æœ€å¤§çš„åŒºåˆ«åœ¨äºä½¿ç”¨<strong>ç¾å¼é…’èŠ±</strong>æ›¿ä»£<strong>ä¼ ç»Ÿé…’èŠ±</strong>ï¼ŒåŸºäºæ­¤å•¤é…’é£æ ¼ä¹Ÿç»å¸¸è¢«åˆ†ç±»ä¸ºæ¬§å¼å’Œç¾å¼ä¸¤å¤§ç±»ï¼ˆå¹¶ä¸ä¸¥è°¨ï¼‰</p><p>ç¾å¼é…’èŠ±ä¹Ÿè¢«ç§°ä¸ºæ–°ä¸–ç•Œé…’èŠ±ï¼Œä¼ ç»Ÿçš„æ¬§æ´²é…’èŠ±æ›´å€¾å‘äºæä¾›è‹¦åº¦ã€è¾›è¾£å’Œè‰æœ¬é£å‘³ï¼Œç¾å¼é…’èŠ±æ›´å€¾å‘äºæä¾›é¦™å‘³ã€æŸ‘æ©˜ç±»ã€ç“œæœã€çƒ­å¸¦æ°´æœç­‰å‘³é“</p><blockquote><p>å¡æ–¯å¡ç‰¹ 1972 å¹´å•†å“åŒ–</p><p>è¥¿æ¥š 2008 å¹´å•†å“åŒ–</p><p>é‡‘ç‰Œ 1790 å¹´å•†å“åŒ–</p></blockquote><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/image-20220315235328107.png" alt="image-20220315235328107" style="zoom: 67%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252038370.png" alt="image-20220315235403042" style="zoom:67%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252038169.png" alt="image-20220315235344666" style="zoom: 67%;" /><p><strong>ä¸¾ä¸€äº›æœ‰ç‰¹ç‚¹çš„é£æ ¼</strong></p><p>ï¼ˆä¸‹é¢çš„é£æ ¼åç§°å¹¶ä¸ä¸¥è°¨ï¼Œæ›´å¤šçš„æ˜¯å•†ä¸šåŒ–é£æ ¼çš„å«æ³•ï¼‰</p><ul><li><strong>å°åº¦æ·¡è‰²è‰¾å°”ï¼ˆIPAï¼‰</strong>ï¼šæ›´å¤šçš„å•¤é…’èŠ±å¸¦æ¥æ›´é«˜çš„è‹¦åº¦ä»¥åŠæ›´å¤šçš„é£å‘³ <a href="https://item.jd.com/100011983501.html">åŒ—å¹³æœºå™¨ç™¾èŠ±æ·±å¤„IPA</a></li><li><strong>å¤æ–¯ï¼ˆGoseï¼‰</strong>ï¼šä¹³é…¸ã€ç›æ°´ã€é¦™æ–™ <a href="https://item.jd.com/10030440794661.html">ç‰›å•¤å ‚å¸éƒ½æµ·ç›</a></li><li><strong>å…°æ¯”å…‹ï¼ˆLambicsï¼‰</strong>ï¼šé‡èŒå‘é…µï¼Œæ›´é…¸ï¼Œå˜ä½“æ˜¯æ°´æœå…°æ¯”å…‹å’Œæ³•æŸ” <a href="https://item.jd.com/7907410.html">æ—å¾·æ›¼</a></li><li><strong>ç‰›å¥¶ä¸–æ¶›ï¼ˆMilk Stoutï¼‰</strong>ï¼šåŠ äº†ä¹³ç³–çš„ä¸–æ¶›ï¼Œå¾€å¾€è¿½æ±‚æ›´é«˜çš„ç³Šç²¾æ¯”é‡ <a href="https://item.jd.com/100012559742.html">æ‰“å—æµ·ç‹¸èŠ±ç”Ÿç‰›å¥¶ä¸–æ¶›</a></li><li><strong>å°éº¦å•¤é…’ï¼ˆWheatï¼‰</strong>ï¼šå°éº¦ä½œä¸ºé‡è¦åŸæ–™ï¼Œæœ‰ä¸€å®šé…¸åº¦<ul><li><strong>å¾·å¼å°éº¦</strong>ï¼šåŸæ–™å•ä¸€ï¼ˆ1516 å¹´ã€Šå¾·å›½çº¯å‡€å•¤é…’æ³•ã€‹ï¼‰ <a href="https://item.jd.com/100018726016.html">æµ·åº•æå¾·å¼å°éº¦</a></li><li><strong>æ¯”åˆ©æ—¶å°éº¦</strong>ï¼šé¦™æ–™çš„åŠ å…¥ï¼Œç”œæ©™çš®ã€èŠ«è½ç±½ <a href="https://item.jd.com/100020388832.html">1664ç™½å•¤</a></li></ul></li><li><strong>è¥¿æ‰“ï¼ˆCiderï¼‰</strong>ï¼šè‹¹æœé…’ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ°´æœï¼‰ï¼Œæ›´å¤šçš„æ®‹ç³– <a href="https://item.jd.com/53259108790.html">è¯±æƒ‘ï¼ˆTEMPTï¼‰7å·</a></li><li><strong>ä¿®é“é™¢ï¼ˆTrappist &amp; Abbeyï¼‰</strong>ï¼šæ¯”åˆ©æ—¶å•¤é…’ï¼Œç”±ä¿®é“é™¢ï¼ˆTrappistï¼‰æˆ–ä¿®é“é™¢æˆæƒï¼ˆAbbeyï¼‰é…¿é€ ï¼Œæ”¶å…¥ç”¨äºæ…ˆå–„æˆ–ç¤¾åŒºæœåŠ¡ï¼Œå…¨çƒå…±æœ‰11å®¶ä¿®é“é™¢é…’å‚ï¼›ä¼ ç»Ÿã€é«˜é…’ç²¾åº¦ã€åšé‡ã€ç„¦ç³–ï¼Œè¾…æ–™å¤§å¤šæ•°åŠ å…¥äº†æ¯”åˆ©æ—¶æ£•ç³– <a href="https://item.jd.com/3306054.html">ç½—æ–¯ç¦ï¼ˆRochefortï¼‰10å·</a></li></ul><p><strong>æ›´å¤šåˆ›æ„</strong></p><p>ç²¾é…¿è¿åŠ¨é™¤äº†å¤åˆ»å†å²ä¸Šçš„ä¼ ç»Ÿå•¤é…’é£æ ¼ï¼ˆIPA - 18 ä¸–çºªã€å¤æ–¯ - 16 ä¸–çºªï¼‰ï¼Œä¹Ÿå¸¦æ¥äº†æ›´å¤šé£æ ¼åˆ›æ„çš„æ¢ç´¢</p><ul><li><strong>é¦™æ§ŸIPAï¼ˆBrut IPAï¼‰</strong>ï¼š2017 å¹´é¦–åˆ›ï¼Œä½¿ç”¨è‘¡è„ç³–æ·€ç²‰é…¶ï¼Œæ›´ä½çš„è‹¦å‘³ï¼Œæ›´ä½çš„æ®‹ç³–æ„å‘³ç€æ›´å¹²çš„å£æ„Ÿ</li><li><strong>é…’èŠ±å¹²æŠ•ï¼ˆDry Hopï¼‰</strong>ï¼šä¸€ç§é…’èŠ±æ·»åŠ æ–¹å¼ï¼Œé€‚ç”¨äºå„ç§çªå‡ºé…’èŠ±é£å‘³ç±»çš„é£æ ¼ï¼Œå•¤é…’èŠ±ä¸å‚ä¸ç…®æ²¸å’Œæ—‹æ²‰é˜¶æ®µï¼Œè€Œåœ¨å†·å´ã€å‘é…µè¿‡ç¨‹ä¸­åŠ å…¥å•¤é…’èŠ±ï¼Œç›®çš„æ˜¯é™ä½è‹¦åº¦å¢åŠ é¦™å‘³</li><li><strong>ç‡•éº¦ä¸–æ¶›ï¼ˆOatmeal Stoutï¼‰</strong>ï¼šæ·»åŠ ç‡•éº¦ï¼Œè¿½æ±‚æ›´é‡çš„é…’ä½“</li><li><strong>é…’èŠ±æ‹‰æ ¼ï¼ˆHoppy Lagerï¼‰</strong>ï¼šæ–°æ—¶ä»£é£æ ¼ï¼Œåœ¨ä¼ ç»Ÿæ‹‰æ ¼é£æ ¼ä¸‹åŠ å…¥å¤§é‡æ–°ä¸–ç•Œé…’èŠ±ï¼Œæ‹‰æ ¼çš„å£æ„Ÿå’Œæ›´å¤šçš„é…’èŠ±é¦™å‘³å’Œè‹¦åº¦</li><li><strong>æ°´æœå•¤é…’ï¼ˆFruit Beerï¼‰</strong>ï¼šé…¿é€ è¿‡ç¨‹ä¸­åŠ å…¥æ°´æœç”šè‡³æœæ³¥ï¼ˆæˆ‘è§‰å¾—å¾ˆéš¾å–ï¼‰</li></ul><h2 id="å¿«ç‚¹å¼€å–"><a href="#å¿«ç‚¹å¼€å–" class="headerlink" title="å¿«ç‚¹å¼€å–"></a>å¿«ç‚¹å¼€å–</h2><p><strong>å•¤é…’çš„å±æ€§</strong></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252038639.png" alt="img"></p><p>å•¤é…’çš„é…’æ ‡ä¸Šæ ‡æ³¨äº†è¿™ç“¶å•¤é…’çš„åŸºæœ¬ä¿¡æ¯</p><ul><li>é…’å‚ï¼ˆBrandï¼‰ï¼šBrew Dog</li><li>åç§°ï¼ˆNameï¼‰ï¼šLayer Cake</li><li>é£æ ¼ï¼ˆStyleï¼‰ï¼šMarshmallow &amp; Chocolate Stout æ£‰èŠ±ç³– &amp; å·§å…‹åŠ›ä¸–æ¶›ï¼ˆé…’å‚è‡ªå·±å®šä¹‰çš„é£æ ¼ï¼‰</li><li>é…’ç²¾åº¦ï¼ˆABVï¼‰ï¼š7%</li><li>å®¹é‡ï¼ˆvolumeï¼‰ï¼š440 ml</li></ul><p>é™¤æ­¤ä¹‹å¤–å•¤é…’çš„ä¿¡æ¯</p><ul><li><p>è‹¦åº¦ï¼ˆIBUï¼‰ï¼šä¸åŒçš„é£æ ¼è‹¦åº¦å·®å¼‚ä¼šå¾ˆå¤§ï¼ŒIPAï¼ˆ40 ~ 100ï¼‰ã€è‹±å¼è‹¦å•¤ï¼ˆ30 ~ 70ï¼‰ã€æ·å…‹æ‹‰æ ¼ï¼ˆ20 ~ 40ï¼‰ã€è¥¿æ‰“é…’ï¼ˆ5 ~ 20ï¼‰</p></li><li><p>å•¤é…’è‰²åº¦ï¼ˆEBCï¼‰ï¼šå•¤é…’è‰²åº¦ï¼Œç™½ -&gt; é»„ -&gt; æ£• -&gt; é»‘</p></li><li><p>ç»ˆäº†æ¯”é‡ï¼ˆFGï¼‰ï¼šæ•°å€¼è¶Šå¤§æ„å‘³ç€è¶Šé«˜çš„æ®‹ç³–ï¼Œä¹Ÿå¯èƒ½æœ‰æ›´åšé‡çš„é…’ä½“</p></li><li><p>äºŒæ¬¡å‘é…µæ–¹å¼ï¼šç“¶ä¸­äºŒå‘ï¼Œè¿˜æ˜¯åªæœ‰ä¸€å‘åæ‰“å…¥äºŒæ°§åŒ–ç¢³è£…ç“¶</p></li><li><p>ç½è£…æ€èŒæ–¹å¼ï¼šå›½äº§å•¤é…’ï¼Œç”Ÿå•¤ã€çº¯ç”Ÿ</p></li><li><p>å…¶ä»–æ“ä½œï¼šåŸæµ†ã€ä¸€ç•ªæ¦¨</p></li></ul><p><strong>ä¸€äº›åè¯</strong></p><ul><li>å¹² &amp; ç”œï¼šå¹²æŒ‡çš„æ˜¯æ›´å°‘çš„æ®‹ç³–ï¼Œç”œåˆ™ç›¸åï¼ˆå¹²çº¢ã€åŠå¹²ã€ç”œçº¢ï¼‰</li><li>è½» &amp; é‡ï¼šé…’ä½“ä¸­ç³Šç²¾ã€è›‹ç™½è´¨çš„å«é‡ï¼Œæ›´é‡çš„é…’ä½“æ„å‘³ç€æ›´åšçš„å£æ„Ÿ</li><li>æ³¡æ²«ï¼šä¸€æ–¹é¢æ¥è‡ªäºŒæ°§åŒ–ç¢³çš„å«é‡ï¼Œä¸€èˆ¬è€Œè¨€è¶Šæ¸…çˆ½çš„é£æ ¼è¶Šè¿½æ±‚æ›´å¤šçš„äºŒæ°§åŒ–ç¢³ï¼›å¦ä¸€æ–¹é¢æ›´é‡çš„é…’ä½“æ›´èƒ½äº§ç”Ÿæ›´ç»µå¯†çš„æ³¡æ²«</li></ul><p><strong>é€‚é¥®æ¸©åº¦</strong></p><p>ä¸€å®šè¦å†°é•‡</p><p>è‰¾å°”ç±»å¯ä»¥æ¯”æ‹‰æ ¼ç±»æ¸©åº¦ç¨é«˜ï¼Œæœ‰åŠ©äºé£å‘³çš„æ•£å‘ï¼Œä½†è‚¯å®šè¦è¿œè¿œä½äºå®¤æ¸©ï¼ˆæ²¡æœ‰æš–æ°”çš„å†¬å¤©é™¤å¤–ï¼‰</p><p><strong>é…é¤</strong></p><p>å•¤é…’æœ¬èº«å°±æ˜¯å¤§ä¼—çš„é…’ç§ï¼Œå–å•¤é…’çš„æ—¶å€™æ­é…é«˜çƒ­é‡çš„ç®€é¤æ„Ÿè§‰å°±æ›´çˆ½äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå•¤é…’å§å¾€å¾€éƒ½æä¾›ç®€é¤ï¼›ä¹Ÿå¯ä»¥æ­é…ç”œå“</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039603.png"></p><p><a href="https://www.brewdog.com/uk/bar_pages/bar/locator">Bar Locator (brewdog.com)</a></p><h1 id="é…¿é€ "><a href="#é…¿é€ " class="headerlink" title="é…¿é€ "></a>é…¿é€ </h1><h2 id="è®¾å¤‡"><a href="#è®¾å¤‡" class="headerlink" title="è®¾å¤‡"></a>è®¾å¤‡</h2><p>é…¿é€ å•¤é…’çš„æœ¬è´¨å°±æ˜¯ç²‰ç¢éº¦èŠ½ã€ç³–åŒ–éº¦èŠ½ã€ç…®æ²¸éº¦æ±ã€å†·å´éº¦æ±ã€å‘é…µéº¦æ±</p><p><strong>ç²‰ç¢éº¦èŠ½</strong>éœ€è¦ç”¨åˆ°<strong>ç²‰ç¢æœº</strong>ï¼Œä¸€èˆ¬ä½¿ç”¨å¯¹ç¢¾ç»“æ„ï¼Œå› ä¸ºæœ€å¥½çš„ç²‰ç¢ç¨‹åº¦æ˜¯æŒ¤å‡ºéº¦èƒšä½†ä¿ç•™éº¸çš®ï¼Œå› ä¸ºéº¸çš®åœ¨åç»­æµç¨‹ä¸­å¯ä»¥å¯¹éº¦æ±è¿›è¡Œè¿‡æ»¤ï¼Œå‡å°‘è›‹ç™½è´¨ç­‰ç‰©è´¨ï¼Œä½¿é…’ä½“æ›´æ¸…æ¾ˆã€æ›´ç¨³å®š</p><p><strong>ç³–åŒ–éº¦èŠ½</strong>éœ€è¦<strong>ä¿æ¸©æ¡¶</strong>ï¼Œå› ä¸ºéœ€è¦ä¸€å®šçš„æ¸©åº¦ï¼ˆ65â„ƒ å·¦å³ï¼‰è®©éº¦èŠ½å†…çš„é…¶è¿›è¡Œå·¥ä½œï¼Œåˆ†è§£æ·€ç²‰ä¸ºéº¦èŠ½ç³–ã€ç³Šç²¾ä»¥åŠå…¶ä»–äº§ç‰©ï¼Œéº¦èŠ½ç³–å°±æ˜¯é…’ç²¾çš„æ¥æº</p><p><strong>ç…®æ²¸éº¦æ±</strong>éœ€è¦<strong>ç…®æ²¸æ¡¶</strong>ï¼Œä¿æŒé«˜æ¸©ç…®æ²¸ï¼Œè®©å¼‚å‘³ç‰©è´¨è’¸å‘ï¼ˆäºŒç”²åŸºç¡«é†šï¼‰ï¼Œä»¥åŠæŠ•æ”¾é…’èŠ±ã€è¾…æ–™é€šè¿‡ç…®æ²¸æ¥èƒå–é£å‘³ï¼Œè¿˜æœ‰æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯æ€èŒ</p><p><strong>å†·å´éº¦æ±</strong>éœ€è¦ç”¨åˆ°<strong>å†·å´ç›˜ç®¡</strong>ï¼Œæ›´é«˜çº§çš„è®¾å¤‡å¯ä»¥ä½¿ç”¨<strong>æ¢çƒ­å™¨</strong>ä»¥åŠ<strong>å†·æ°´æœº</strong>ï¼Œç›®çš„æ˜¯è®©éº¦æ±å°½å¯èƒ½å¿«é€Ÿåœ°å†·å´åˆ°é€‚å®œæŠ•æ”¾é…µæ¯çš„æ¸©åº¦ï¼Œå‡å°‘æ°§åŒ–</p><p><strong>å‘é…µéº¦æ±</strong>éœ€è¦ç”¨åˆ°<strong>å‘é…µæ¡¶</strong>ï¼Œå¯†é—­ã€èƒ½å¤Ÿå®‰è£…<strong>å•å‘é˜€</strong>ï¼ˆå‘é…µè¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿå¤§é‡çš„çƒ­å’ŒäºŒæ°§åŒ–ç¢³éœ€è¦æ’å‡ºï¼‰</p><h2 id="åŸæ–™"><a href="#åŸæ–™" class="headerlink" title="åŸæ–™"></a>åŸæ–™</h2><p><strong>åŸºæœ¬åŸæ–™</strong></p><p>å•¤é…’çš„å››å¤§åŸæ–™ï¼š</p><ul><li>éº¦èŠ½ï¼šå¤§éº¦éº¦èŠ½ï¼ŒæŸäº›é£æ ¼å¯èƒ½ä¼šä½¿ç”¨å°éº¦éº¦èŠ½</li><li>å•¤é…’èŠ±ï¼šè›‡éº»ç§‘æ¤ç‰©ï¼Œæœ€æ—©æ˜¯ç”¨æ¥ä¿é²œï¼Œç°åœ¨ç”¨æ¥èµ‹äºˆå•¤é…’é¦™å‘³å’Œè‹¦å‘³</li><li>é…µæ¯ï¼šå„ç§é…µæ¯ï¼Œä½†æ€»ä½“åˆ†ä¸ºè‰¾å°”å’Œæ‹‰æ ¼ä¸¤ç±»ï¼Œé…µæ¯ç”Ÿäº§å‚å®¶ä¼šæœ‰é’ˆå¯¹æ­¤ç±»é…µæ¯çš„è¯¦ç»†å‚æ•°<br><a href="http://wxtest.seastad.com/fermentation-solutions/you-create-beer/you-create-beer.html?id=1">é…¿å•¤é…’çš„ä½  â€¢ Fermentis (seastad.com)</a></li><li>æ°´ï¼šè¿™ä¸ªå°±ä¸è§£é‡Šäº†</li></ul><p><strong>å„ç§è¾…æ–™</strong></p><p>é™¤äº†æœ€åŸºæœ¬çš„åŸæ–™ï¼Œå•¤é…’ä¸­å¾€å¾€è¿˜åŠ å…¥ä¸åŒçš„è¾…æ–™ï¼Œæœ‰çš„å¯èƒ½æ˜¯å› ä¸ºé£æ ¼éœ€è¦ï¼Œä¹Ÿæœ‰çš„å¯èƒ½æ˜¯é…¿é€ è€…çš„åˆ›æ„</p><p>æ¯”å¦‚ï¼š</p><ul><li>æ¯”åˆ©æ—¶å°éº¦éœ€è¦åŠ å…¥ç”œæ©™çš®å’ŒèŠ«è½ç±½</li><li>æ¯”åˆ©æ—¶ä¿®é“é™¢å•¤é…’éœ€è¦åŠ å…¥æ£•ç³–</li><li>ç‰›å¥¶ä¸–æ¶›éœ€è¦åŠ å…¥ä¹³ç³–</li><li>ç‡•éº¦ä¸–æ¶›éœ€è¦åŠ å…¥ç‡•éº¦</li><li>çƒŸç†å•¤é…’éœ€è¦åŠ å…¥çƒŸç†æœ¨</li><li>èœ‚èœœé…’éœ€è¦åŠ å…¥èœ‚èœœ</li><li>ä»¥åŠå„ç§åˆ›æ„åŠ å…¥èŠ±æ¤’ï¼ˆ<a href="https://item.jd.com/10028156058690.html">å•¤ä¼‘é…¿é€ èŠ±æ¤’ç”Ÿå§œé£å‘³</a>ï¼‰ã€èŠ±èŒ¶ï¼ˆ<a href="https://item.jd.com/69394013613.html">é«˜å¤§å¸ˆ</a>ï¼‰ã€æœæ±ã€é¦™è‰ç­‰ç­‰</li></ul><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039419.png" alt="image-20220316014349585"></p><p><strong>éº¦èŠ½çš„ç§ç±»</strong></p><p>é…¿é€ ç”¨çš„éº¦èŠ½é€šå¸¸ç§°ä¸ºåŸºç¡€éº¦èŠ½å’Œç‰¹ç§éº¦èŠ½ï¼ŒåŸºç¡€éº¦èŠ½æ˜¯éº¦æ±ä¸­éº¦èŠ½ç³–çš„ä¸»ä½“å’ŒåŸºæœ¬ç‰¹å¾ï¼Œè€Œç‰¹ç§éº¦èŠ½ä¸»è¦å¸¦æ¥æ›´å¤šçš„é£å‘³å’Œè‰²åº¦</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039668.png" alt="image-20220316014132216"></p><p>æ¯”å¦‚å¾ˆå¤šåç§°ä¸­å¸¦æœ‰ â€œå·§å…‹åŠ›â€ çš„å•¤é…’ï¼Œå¯èƒ½å¹¶ä¸æ˜¯æ·»åŠ äº†å·§å…‹åŠ›ï¼Œè€Œæ˜¯ç‰¹ç§éº¦èŠ½å¸¦æ¥çš„å·§å…‹åŠ›é£å‘³</p><p><strong>å•¤é…’èŠ±çš„ç§ç±»</strong></p><p>å•¤é…’èŠ±çš„é¦™å‘³æ¥è‡ªäºæ¤ç‰©ä¸­æ‰€åŒ…å«çš„ Î±â€”é…¸ã€Î²â€”é…¸å’Œé¦™ç²¾æ²¹ï¼ŒÎ±â€”é…¸å’ŒÎ²â€”é…¸ç»è¿‡é«˜æ¸©åä¼šæˆä¸ºå•¤é…’ä¸­çš„è‹¦å‘³ç‰©è´¨ï¼Œä½†ç»è¿‡é«˜æ¸©å¼‚æ„åæ‰èƒ½æ›´å¤šæº¶äºæ°´ï¼Œå¸¦æ¥å•¤é…’èŠ±çš„é¦™å‘³ï¼Œæ‰€ä»¥å•¤é…’èŠ±å¾€å¾€æ˜¯è‹¦å‘³å’Œé¦™å‘³å¹¶å­˜</p><p>å¹²æŠ•çš„æ–¹å¼å¯ä»¥é¿å…å•¤é…’èŠ±çš„è‹¦å‘³è¿›å…¥å•¤é…’ï¼Œä½†ä¹Ÿå‡å°‘äº†é¦™å‘³ï¼Œæ‰€ä»¥å¹²æŠ•å¾€å¾€éœ€è¦æ›´å¤§é‡çš„å•¤é…’èŠ±</p><p>å•¤é…’èŠ±æœ‰ä¸åŒçš„å“ç§ï¼Œåœ¨ç…®æ²¸è¿‡ç¨‹ä¸­ä¸åŒçš„æ—¶é—´æŠ•å…¥ç…®æ²¸æ¡¶ï¼Œæ¥è¾¾åˆ°å¢åŠ è‹¦å‘³å’Œé¦™å‘³çš„ç›®çš„</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039251.png" alt="image-20220316015005883"></p><p><strong>å•ä¸€é…’èŠ±</strong></p><p>æœ‰çš„é…’æ¬¾ä¼šæ ‡æ³¨è‡ªå·±æ˜¯<strong>å•ä¸€é…’èŠ±ï¼ˆSingle-Hoppedï¼‰</strong>ï¼Œæ„æ€æ˜¯æ‰€ä½¿ç”¨çš„åŸæ–™é‡ŒåªåŒ…å«ä¸€ç§å“ç§çš„å•¤é…’èŠ±</p><p>ä¸€èˆ¬æ‰€ä½¿ç”¨çš„é…’èŠ±æ˜¯æœ€æ–°åŸ¹è‚²å‡ºçš„ã€é£å‘³æ›´ç‹¬ç‰¹çš„æ–°å“ç§ï¼Œèƒ½å¤Ÿæ›´å¥½çš„æ„ŸçŸ¥åˆ°è¿™ç§é…’èŠ±çš„é£å‘³</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039769.png" alt="image-20220316015127042"></p><h2 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h2><ul><li><p>ç¬¬ä¸€æ¬¡å‘é…µï¼ˆ2 å‘¨ï¼‰</p><ul><li><p>ç²‰ç¢éº¦èŠ½</p></li><li><p>ç³–åŒ–</p></li><li><p>æ´—ç³Ÿ</p></li><li><p>ç…®æ²¸</p></li><li><p>æ·»åŠ è¾…æ–™ã€é…’èŠ±</p></li><li><p>å†·å´</p></li><li><p>æµ‹ç³–ï¼ˆåˆå§‹æ¯”é‡ï¼‰</p></li><li><p>è£…å‘é…µæ¡¶</p></li><li><p>æŠ•æ”¾é…µæ¯</p></li><li><p>æ¶²å°</p></li></ul></li><li><p>ç¬¬äºŒæ¬¡å‘é…µï¼ˆè‡³å°‘ 2 å‘¨ï¼‰</p><ul><li><p>æµ‹ç³–ï¼ˆç»ˆäº†æ¯”é‡ï¼‰</p></li><li><p>é…ç½®äºŒå‘ç”¨ç³–</p></li><li><p>è£…ç“¶</p></li><li><p>å†·è—</p></li></ul></li></ul><p>ä»ç…®æ²¸åçš„æ•´ä¸ªæµç¨‹éƒ½éœ€è¦å¯¹å™¨æè¿›è¡Œæ¶ˆæ¯’ï¼Œç‰¹åˆ«æ˜¯å‘é…µæ¡¶ä»¥åŠç®¡é“ï¼Œå¦‚æœè¿™æ¡¶é…’è¢«æ‚èŒæ±¡æŸ“ï¼Œå°±è¯¥æ‰”äº†</p><p><a href="https://www.youtube.com/watch?v=Wxo9PHc3jNw">How to Make Beer, the Animation. - YouTube</a></p><h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><p><strong>è¯„åˆ†ç½‘ç«™</strong></p><p><a href="https://untappd.com/">Untappd â€“ Drink Socially â€“ Free iOS and Android App</a></p><p><a href="https://www.jiuhuar.com/">ç²¾é…¿å•¤é…’å’Œå•¤é…’ä¸–ç•Œ-é…’èŠ±å„¿ (jiuhuar.com)</a></p><p><strong>é…æ–¹æ¨¡æ‹Ÿ</strong></p><p><a href="https://web.brewfather.app/tabs/tools">Brewfather</a></p><h2 id="è¿˜æœ‰"><a href="#è¿˜æœ‰" class="headerlink" title="è¿˜æœ‰"></a>è¿˜æœ‰</h2><p><strong>æ˜¯å¦å®‰å…¨</strong></p><p>æ–°é—»ç»å¸¸æŠ¥é“å–å‡é…’ç”²é†‡ä¸­æ¯’çš„æ¡ˆä¾‹</p><p>å®¶é…¿å•¤é…’ä»å·¥è‰ºåˆ°è®¾å¤‡è‚¯å®šæ— æ³•å’Œé…’å‚ç›¸æ¯”ï¼Œç¡®å®ç›¸å¯¹åº”çš„å¼‚å‘³ç‰©è´¨å’Œä¸å¥½çš„äº§ç‰©ï¼ˆç”²é†‡ç­‰ï¼‰ä¼šæ›´å¤š</p><p>ä½†å•¤é…’å±äºé…¿é€ é…’ï¼Œé…¿é€ é…’æ‰€äº§ç”Ÿçš„é…’ç²¾åº¦å°±æ˜¯æ¯”è¾ƒä½çš„ï¼Œæ‰€ä»¥å…¶ä»–ä»£è°¢äº§ç‰©ä¼šæ›´å°‘ï¼Œç”²é†‡ä¸­æ¯’å¾€å¾€æ¥è‡ªäºè’¸é¦é…’ç±»ï¼Œæœ¬èº«çš„ç”²é†‡æµ“åº¦ä¼šåœ¨è’¸é¦åå˜å¾—å¾ˆé«˜ä»è€Œè¶…è¿‡é˜ˆå€¼ï¼›å…¶æ¬¡ç”²é†›çš„ä¸»è¦æ¥æºæ˜¯æœèƒ¶ï¼Œå¯¹äºå•¤é…’æ¥è¯´åŸæ–™é‡Œæœèƒ¶çš„æ¥æºéå¸¸å°‘</p><p>æ‰€ä½¿ç”¨çš„é…µæ¯å¾€å¾€ä¹Ÿæ˜¯ç”Ÿç‰©å…¬å¸ç ”åˆ¶çš„äº§å“ï¼Œæ‰€å¸¦æ¥çš„è´Ÿé¢ä»£è°¢äº§ç‰©ä¼šæ›´å°‘</p><p>é£Ÿå“æ£€æµ‹ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œå•¤é…’ç›¸å…³ç‰©è´¨æ£€æµ‹çš„ä»·æ ¼åœ¨ 200 å…ƒå·¦å³</p><p><strong>å¤§å¸ˆæ¯</strong></p><blockquote><p> 2012 å¹´ï¼Œä¸­å›½ç¬¬ä¸€æ‰¹å®¶é…¿çˆ±å¥½è€…å’Œå•¤é…’å‘çƒ§å‹å¼€å§‹æˆç«‹ç¤¾å›¢ã€åä¼šï¼Œç»„ç»‡å„ç§äº¤æµæ´»åŠ¨ã€‚2012 å¹´ 8 æœˆï¼Œç¬¬ä¸€æœ¬ä¸­æ–‡å•¤é…’å®¶é…¿ä¹¦ã€Šå–è‡ªå·±é…¿çš„å•¤é…’ã€‹ä½œè€…é«˜å²©ï¼Œåœ¨å—äº¬åˆ›åŠäº†å¤§å¸ˆæ¯å…¨å›½å®¶é…¿å•¤é…’å¤§å¥–èµ›ï¼ˆä»¥ä¸‹ç®€ç§°å¤§å¸ˆæ¯ï¼‰ï¼Œè¯„é€‰å‡ºä¼˜ç§€çš„å®¶é…¿ä½œå“å’Œé…¿é€ è€…ï¼Œä»¥é¢‚æ‰¬é…¿é€ çš„è‰ºæœ¯å’Œç§‘å­¦</p><p>å¤§å¸ˆæ¯å¸çº³äº†è¯¸å¤šå›½å†…æ·±è€•äºè¡Œä¸šçš„å…ˆè¡Œè€…ï¼Œå½¢æˆå¤§å¸ˆæ¯å…¨å›½å®¶é…¿å•¤é…’å¤§å¥–èµ›ç»„å§”ä¼šï¼Œåˆ¶å®šå¹¶éµå¾ªç»„å§”ä¼šç« ç¨‹ï¼Œç§‰æ‰¿â€œå…¬å¹³ã€åˆç†ã€ç§‘å­¦â€çš„ä»·å€¼è§‚ï¼Œä¸æ–­æå‡å¤§å¸ˆæ¯çš„å½±å“åŠ›å’Œå…¬ä¿¡åŠ›ã€‚</p></blockquote><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039610.jpg" style="zoom: 50%;" /><p><a href="https://mp.weixin.qq.com/s/A2HxAoD_XUNVORqIWppcQA">2022 å¡”ç½—æ–¯Â·å¤§å¸ˆæ¯ å®¶é…¿èµ›ï¼Œèµ›åˆ¶è¯´æ˜&amp;åˆ†ç»„è§„åˆ™</a></p><p><a href="https://mp.weixin.qq.com/s/vQdHVW-YuGWcpzzNXmcabA">2022 å¡”ç½—æ–¯Â·å¤§å¸ˆæ¯ å¹¿å·ç«™æŠ¥åå¼€å§‹</a></p><p><strong>æˆ‘é…¿çš„å•¤é…’</strong></p><p>æ›¾ç»å‚è¿‡ 2020 å¹´å¤§å¸ˆæ¯ï¼Œè¯„åˆ†</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039065.jpg" style="zoom:33%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039471.jpg" style="zoom:33%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039794.jpg"></p><h1 id="è‰ºæœ¯å’Œæ–‡åŒ–"><a href="#è‰ºæœ¯å’Œæ–‡åŒ–" class="headerlink" title="è‰ºæœ¯å’Œæ–‡åŒ–"></a>è‰ºæœ¯å’Œæ–‡åŒ–</h1><h2 id="é…’å‚-amp-é…’æ ‡"><a href="#é…’å‚-amp-é…’æ ‡" class="headerlink" title="é…’å‚ &amp; é…’æ ‡"></a>é…’å‚ &amp; é…’æ ‡</h2><p><strong>æ‰“å—æµ·ç‹¸ï¼ˆBelching Beaverï¼‰</strong></p><p><a href="https://belchingbeaver.com/">Belching Beaver Brewery</a></p><p><strong>åŒ—é…¿ï¼ˆNorth Brewingï¼‰</strong></p><p><a href="https://shop.northbrewing.com/">North Brewing Co Online Shop</a></p><p><strong>å²¬è§’ï¼ˆBallast Pointï¼‰</strong></p><p><a href="https://ballastpoint.com/">Homepage - Ballast Point Brewing</a></p><p><strong>ä¼Ÿå¤§ç†å¿µï¼ˆGreat Notionï¼‰</strong></p><p><a href="https://greatnotion.com/">Great Notion | Home</a></p><p><strong>ç¾å¥‡ä¹ï¼ˆMikkellerï¼‰</strong></p><p><a href="https://mikkeller.com/">Mikkeller</a></p><p><strong>è”åˆè‰ºæœ¯ï¼ˆCollective Artsï¼‰</strong></p><p><a href="https://collectiveartsbrewing.com/de/">Home - Collective Arts Germany (collectiveartsbrewing.com)</a></p><h2 id="è¡ç”Ÿæ´»åŠ¨"><a href="#è¡ç”Ÿæ´»åŠ¨" class="headerlink" title="è¡ç”Ÿæ´»åŠ¨"></a>è¡ç”Ÿæ´»åŠ¨</h2><p><strong>åˆé…¿</strong></p><p>åˆé…¿å°±æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ªä¸åŒçš„ç²¾é…¿å‚ç‰Œåœ¨ä¸€èµ·åˆä½œé…¿é€ ä¸€æ¬¾é…’ï¼Œå°±æœ‰ç‚¹å„¿åƒé‚»å±…ä¹‹é—´çš„ä¸²é—¨ä¸€æ ·ï¼Œä»Šå¤©æˆ‘å»ä½ é‚£å„¿ï¼Œæ˜å¤©ä½ æ¥æˆ‘è¿™å„¿ï¼Œå¤§å®¶åä¸€åï¼ŒèŠä¸€èŠï¼Œåƒä¸ªé¥­</p><p>é™¤äº†è”ç»œæ„Ÿæƒ…ï¼Œåˆé…¿è¿˜æœ‰ä¸€ä¸ªé‡è¦æ„ä¹‰å°±æ˜¯èƒ½å¤Ÿå°†å½¼æ­¤çš„äº§å“ç‰¹ç‚¹èåˆåœ¨ä¸€èµ·ï¼Œåˆ›é€ å‡ºæ›´å…·ç‰¹è‰²çš„äº§å“ï¼›åˆé…¿çš„è¿‡ç¨‹å…¶å®ä¹Ÿæ˜¯ä¸ªæŠ€æœ¯äº¤æµä¸åˆ†äº«çš„è¿‡ç¨‹ï¼Œå–å½¼ä¹‹é•¿ï¼Œè¡¥å·±ä¹‹çŸ­</p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039709.png" alt="image-20220320171652123" style="zoom: 50%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039981.png" alt="image-20220320171714327" style="zoom:50%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039874.png" alt="image-20220320171722436" style="zoom: 50%;" /><p><strong>é…’å¤´æ¥ç®¡</strong></p><p>å•¤é…’å§å¼•å…¥ä¸€æ‰¹æŸé…’å‚çš„å•¤é…’è€Œä¸¾åŠçš„å¸¦æœ‰å¹¿å‘Šæ€§è´¨ã€ä¸»é¢˜æ€§è´¨ã€ä¿ƒé”€æ€§è´¨çš„è¥é”€æ´»åŠ¨</p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039483.png" alt="image-20220320171908796" style="zoom:50%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039798.png" alt="image-20220320171914991" style="zoom:50%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039116.png" alt="image-20220320171926205" style="zoom:50%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040917.png" alt="image-20220320173347954" style="zoom:50%;" /><p><strong>å±•è§ˆä¼š &amp; å•¤é…’èŠ‚</strong></p><p><a href="https://www.jiuhuar.com/news/6225b9248ba5b044278b4569.html">ã€ŒDesignç²¾é…¿ã€è‰ºæœ¯å±•å’Œæ˜¥å­£å•¤é…’ç•…é¥®å¤§ä¼šæ¥å•¦ï¼ (jiuhuar.com)</a></p><p><a href="https://mp.weixin.qq.com/s/8zT6i8Alnaw2D7Tg7nwPYg">2021äº¬Aå…«ä¹˜å…«å‚èŠ‚æŒ‡å—ï¼Œè¿™ä¸ªå‘¨æœ«ç­‰ä½ æ¥ç©ï¼ (qq.com)</a></p><p><a href="https://mp.weixin.qq.com/s/36PlJmIOa5tvlmFWGIVARQ">å•¤é…’èŠ‚æ¥äº†ï¼ | ç¬¬äºŒå±Šã€è·³å•¤æ‹æ¡£ã€å¹¿å·ç²¾é…¿å•¤é…’èŠ‚ï¼Œä¸‹å‘¨è§ï¼ (qq.com)</a></p><p><strong>å•¤é…’è·‘</strong></p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040418.png" alt="image-20220320172308492" style="zoom:50%;" /><p><a href="https://mp.weixin.qq.com/s/DCBIJeQYdWRUF_XcpCydlQ">æˆ‘ä»¬èµåŠ©äº†ä¸€åœºå¿«ä¹çš„ã€2020å¦é—¨å•¤é…’è·‘âˆ£RUN FOR BEERã€‘ (qq.com)</a></p><p><strong>èŠ‚æ—¥æ´»åŠ¨</strong></p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040128.png" alt="image-20220320173409737" style="zoom: 67%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040081.png" alt="image-20220320173420348" style="zoom:50%;" /><p><a href="https://mp.weixin.qq.com/s/woOyTmWUATl7-0p-K6EDkw">ç…é¥¼èŠ‚åé—ç—‡ï½œäº¬æ´¥å¤§æˆ˜å…¨å›é¡¾ (qq.com)</a></p><p><strong>è·¨ç•Œ</strong></p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040229.png" alt="image-20220320173649555" style="zoom:50%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040814.png" alt="image-20220320173657609" style="zoom:50%;" /><p><a href="https://mp.weixin.qq.com/s/qW5M9Eduzz0jn2H-o9bZHw">æ–‡æœ«æœ‰ç¦åˆ©ï½œé“é…¿ X FIRSTé’å¹´ç”µå½±å±• (qq.com)</a></p><h2 id="ã€Šéƒ½åœ¨é…’é‡Œã€‹"><a href="#ã€Šéƒ½åœ¨é…’é‡Œã€‹" class="headerlink" title="ã€Šéƒ½åœ¨é…’é‡Œã€‹"></a>ã€Šéƒ½åœ¨é…’é‡Œã€‹</h2><p>æœ€åæ¨èä¸€éƒ¨æœºæ ¸çš„çºªå½•ç‰‡</p><p><a href="https://www.bilibili.com/video/BV1R5411s7ZY?spm_id_from=333.999.0.0">ã€Œ4Ké‡åˆ¶ç‰ˆã€ååœ¨ä¸€èµ·ï¼Œä¸ºç”Ÿæ´»å¹²æ¯ï¼šç²¾é…¿å•¤é…’çºªå½•ç‰‡ã€Šéƒ½åœ¨é…’é‡Œã€‹ç¬¬ä¸‰é›†ã€Šç¾å¼å‘¨æœ«ã€‹_å“”å“©å“”å“©_bilibili</a></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252042908.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç²¾é…¿å•¤é…’ </tag>
            
            <tag> åƒå–ç©ä¹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¡¥æ¥æ¨¡å¼ - Bridge</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F%20-%20Bridge.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F%20-%20Bridge.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æ¡¥æ¥ï¼ˆbridgeï¼‰æ¨¡å¼é¦–å…ˆçš„åœºæ™¯æ˜¯å†…éƒ¨å®ç°é€»è¾‘åˆ†ä¸ºå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—åˆå¯èƒ½å¯¹åº”å¤šç§å®ç°</p><p>åœ¨æ¡¥æ¥å†…éƒ¨ï¼Œè¿™äº›ä¸åŒç±»å‹çš„æ¨¡å—æŒ‰ç…§ç»„åˆæˆ–èšåˆçš„æ–¹å¼ç»„ç»‡åœ¨ä¸€èµ·ï¼Œå°†é€»è¾‘æ¨¡å—æŠ½è±¡éƒ¨åˆ†ä¸å®ç°éƒ¨åˆ†ç›¸åˆ†ç¦»</p><p><strong>ç›®çš„</strong><br>é™ä½å†…éƒ¨å¤šç§ç±»å‹é€»è¾‘æ¨¡å—çš„è€¦åˆï¼Œæ‰©å±•å˜æˆä»¥å„æ¨¡å—ä¸ºå•ä½ï¼Œæ›´ä¸ºçµæ´»</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong><br><a href="https://vans.com.cn/customs.html">Vansè‡ªç”±å®šåˆ¶é‹_Vans(èŒƒæ–¯)ä¸­å›½å®˜æ–¹ç½‘ç«™</a></p><p>çƒé‹å®šåˆ¶ï¼Œä»é€‰æ‹©æ¬¾å¼å¼€å§‹ï¼Œå¯¹ä¸åŒçš„éƒ¨ä½ï¼ˆé‹å¤´ã€é‹è…°ã€ä¾§è¾¹æ¡çº¹ã€é‹å¸¦ç­‰ï¼‰é€‰æ‹©ä¸åŒçš„è®¾è®¡ï¼ˆé¢œè‰²ã€å›¾æ¡ˆã€æè´¨ç­‰ï¼‰ï¼Œæœ€ç»ˆäº§å‡ºæœ€ç»ˆäº§å“ï¼ˆæ¡¥æ¥æ¨¡å¼çš„æœ€ç»ˆæˆå“å¯ä»¥è®¤ä¸ºæ˜¯ç»„åˆäº†å¤šä¸ªæ¨¡å—é€»è¾‘çš„æ‰§è¡Œå™¨ï¼‰</p><p>é’ˆå¯¹ä¸åŒéƒ¨ä½é€‰æ‹©ä¸åŒçš„è®¾è®¡ï¼Œè€Œä¸æ˜¯å¹³é“ºå‡ºç¬›å¡å°”ç§¯å¼çš„é…ç½®è¡¨ï¼Œå°±æ˜¯æ¡¥æ¥æ¨¡å¼å¸Œæœ›å®ç°çš„è§£è€¦çš„ç›®çš„</p><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œæ¯”å¦‚æœåŠ¡å†…å¸Œæœ›å®ç°ä¸€ä¸ªæ¶ˆæ¯é€šçŸ¥åŠŸèƒ½</p><p>æ¶ˆæ¯åˆ†ä¸ºå¤šç§è®°å½•æ–¹å¼ï¼šç¼“å­˜ã€æ•°æ®åº“</p><p>é€šçŸ¥çš„æ–¹å¼ä¹Ÿåˆ†ä¸ºå¤šç§æ–¹å¼ï¼šé‚®ä»¶ã€å¾®ä¿¡</p><p>æœåŠ¡å†…å®šä¹‰ä»€ä¹ˆçº§åˆ«çš„æ¶ˆæ¯é€šè¿‡ä»€ä¹ˆæ–¹å¼è¿›è¡Œé€šçŸ¥</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å¦‚æœå°†æ‰€éœ€è¦çš„å‘é€æ–¹å¼è¿›è¡Œå®ç°ï¼Œéœ€è¦å®ç° 4 ç§æ‰§è¡Œå™¨ï¼ˆ2 Ã— 2ï¼‰ï¼Œå“ªæ€•æ˜¯æœåŠ¡ä¸­å¯ä»¥è¿›è¡Œé€‰æ‹©ï¼Œä¹Ÿéœ€è¦å…¨éƒ¨è¿›è¡Œå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEmailNotifier</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å­˜æ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€ç”µå­é‚®ä»¶&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheWeChatNotifier</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å­˜æ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€å¾®ä¿¡&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å¦‚æœåç»­æœ‰è°ƒæ•´ï¼Œå¢åŠ äº†æ–°çš„è®°å½•æ–¹å¼æˆ–è€…é€šçŸ¥æ–¹å¼ï¼Œé‚£ä¹ˆéœ€è¦éœ€è¦åˆ›å»ºçš„ç±»å°±æ›´å¤šäº†ï¼Œå¹¶ä¸”å¯èƒ½è¿˜å­˜åœ¨ç›¸åŒçš„é€»è¾‘è¢«å®ç°äº†å¤šä»½ä¸ä¾¿äºç»´æŠ¤</p><p>é—®é¢˜å‡ºç°çš„åŸå› æ˜¯å› ä¸ºå°†è®°å½•æ–¹å¼å’Œé€šçŸ¥æ–¹å¼è¿™ä¸¤ç§äº’ä¸å…³è”çš„æ¨¡å—<strong>åœ¨å®ç°ä¸­è€¦åˆåœ¨ä¸€èµ·</strong></p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="é€šçŸ¥æ–¹å¼"><a href="#é€šçŸ¥æ–¹å¼" class="headerlink" title="é€šçŸ¥æ–¹å¼"></a>é€šçŸ¥æ–¹å¼</h3><p><strong>å®šä¹‰æ¥å£</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String msg)</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿›è¡Œå®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”µå­é‚®ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailSender</span> <span class="keyword">implements</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€ç”µå­é‚®ä»¶:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾®ä¿¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeChatSender</span> <span class="keyword">implements</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€å¾®ä¿¡:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®°å½•æ–¹å¼"><a href="#è®°å½•æ–¹å¼" class="headerlink" title="è®°å½•æ–¹å¼"></a>è®°å½•æ–¹å¼</h3><p><strong>å®šä¹‰æ¥å£</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Recorder</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(String msg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿›è¡Œå®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼“å­˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRecorder</span> <span class="keyword">implements</span> <span class="title class_">Recorder</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®°å½•åˆ°ç¼“å­˜:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DbRecorder</span> <span class="keyword">implements</span> <span class="title class_">Recorder</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®°å½•åˆ°æ•°æ®åº“:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»„ç»‡è€…"><a href="#ç»„ç»‡è€…" class="headerlink" title="ç»„ç»‡è€…"></a>ç»„ç»‡è€…</h3><p><strong>æŠ½è±¡ç»„ç»‡è€…</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractNotifier</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Recorder recorder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sender sender;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractNotifier</span><span class="params">(<span class="keyword">final</span> Recorder recorder, <span class="keyword">final</span> Sender sender)</span> &#123;</span><br><span class="line">        Assert.notNull(recorder);</span><br><span class="line">        Assert.notNull(sender);</span><br><span class="line">        <span class="built_in">this</span>.recorder = recorder;</span><br><span class="line">        <span class="built_in">this</span>.sender = sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        recorder.record(msg);</span><br><span class="line">        sender.send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»§æ‰¿æ„é€ æ¨¡å—çš„å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomNotifier</span> <span class="keyword">extends</span> <span class="title class_">AbstractNotifier</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomNotifier</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">DbRecorder</span>(), <span class="keyword">new</span> <span class="title class_">EmailSender</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸šåŠ¡æ‰©å±•"><a href="#ä¸šåŠ¡æ‰©å±•" class="headerlink" title="ä¸šåŠ¡æ‰©å±•"></a>ä¸šåŠ¡æ‰©å±•</h3><p>éœ€è¦å¢åŠ æ–°çš„å‘é€æ–¹å¼ï¼Œæ¯”å¦‚çŸ­ä¿¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortMessageSender</span> <span class="keyword">implements</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€çŸ­ä¿¡:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦è¿›è¡Œæ–°çš„ notifier çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlusNotifier</span> <span class="keyword">extends</span> <span class="title class_">AbstractNotifier</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PlusNotifier</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">CacheRecorder</span>(), <span class="keyword">new</span> <span class="title class_">ShortMessageSender</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><p>JDBC é©±åŠ¨ä¸ºæ‰€æœ‰çš„å…³ç³»å‹æ•°æ®åº“æä¾›ä¸€ä¸ªé€šç”¨çš„æ ‡å‡†ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ¡¥æ¥æ¨¡å¼çš„å…¸å‹åº”ç”¨</p><h3 id="è¿›è¡Œè¿æ¥"><a href="#è¿›è¡Œè¿æ¥" class="headerlink" title="è¿›è¡Œè¿æ¥"></a>è¿›è¡Œè¿æ¥</h3><p>å…ˆå›é¡¾ä¸€ä¸‹ JDBC çš„ä½¿ç”¨ï¼Œä½¿ç”¨ JDBC è¿æ¥ MySQL æ•°æ®åº“ä¸»è¦åˆ†ä¸ºè¿™æ ·å‡ æ­¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åŠ è½½ MySQL é©±åŠ¨æ³¨å…¥åˆ° DriverManager</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.æä¾› JDBC è¿æ¥çš„ URLã€ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test_db?&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.åˆ›å»ºæ•°æ®åº“çš„è¿æ¥</span></span><br><span class="line"><span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url, username, password);</span><br><span class="line"></span><br><span class="line"><span class="comment">//4.åˆ›å»º statement å®ä¾‹</span></span><br><span class="line"><span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line"></span><br><span class="line"><span class="comment">//5.æ‰§è¡Œ SQL è¯­å¥</span></span><br><span class="line"><span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;select * from test&quot;</span>;</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line"></span><br><span class="line"><span class="comment">//6.å…³é—­è¿æ¥å¯¹è±¡</span></span><br><span class="line">connection.close();</span><br></pre></td></tr></table></figure><h3 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h3><p><code>Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;);</code> è·å–äº† Driver å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Driver</span> <span class="keyword">extends</span> <span class="title class_">NonRegisteringDriver</span> <span class="keyword">implements</span> <span class="title class_">java</span>.sql.Driver &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Driver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ³¨å†Œé©±åŠ¨</span></span><br><span class="line">            DriverManager.registerDriver(<span class="keyword">new</span> <span class="title class_">Driver</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Can&#x27;t register driver!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨ <code>DriverManager</code> é™æ€æ–¹æ³• <code>registerDriver()</code> æ–¹æ³•æ¥å°† MySQL é©±åŠ¨æ³¨å†Œåˆ° <code>DriverManager</code></p><h3 id="DriverManager"><a href="#DriverManager" class="headerlink" title="DriverManager"></a>DriverManager</h3><p><code>registerDriver()</code> æ–¹æ³•å…·ä½“å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">registerDriver</span><span class="params">(java.sql.Driver driver)</span></span><br><span class="line">    <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"><span class="comment">// ç›´æ¥è°ƒç”¨ä¸‹é¢çš„åŒåé™æ€æ–¹æ³•</span></span><br><span class="line">    registerDriver(driver, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">registerDriver</span><span class="params">(java.sql.Driver driver,DriverAction da)</span><span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">// registeredDrivers æ˜¯ä¸€ä¸ª list,ç”¨ DriverInfo å®ä¾‹å°è£… Driver</span></span><br><span class="line">    <span class="keyword">if</span>(driver != <span class="literal">null</span>) &#123;</span><br><span class="line">        registeredDrivers.addIfAbsent(<span class="keyword">new</span> <span class="title class_">DriverInfo</span>(driver, da));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is for compatibility with the original DriverManager</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;registerDriver: &quot;</span> + driver);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>registeredDrivers</code> é™æ€å˜é‡æ˜¯ä¸€ä¸ª list</p><p>æ³›å‹ <code>DriverInfo</code> æ˜¯é©±åŠ¨ä¿¡æ¯çš„åŒ…è£…ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverManager</span> &#123;</span><br><span class="line">    <span class="comment">// List of registered JDBC drivers</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DriverInfo"><a href="#DriverInfo" class="headerlink" title="DriverInfo"></a>DriverInfo</h3><p><code>DriverInfo</code> ç±»ä¸­å°è£…äº† <code>java.sql.Driver</code> æ¥å£ï¼Œç±»ä¼¼ Driver ä¿¡æ¯ç®¡ç†è€…çš„è§’è‰²</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DriverInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Driver driver;</span><br><span class="line">    DriverAction da;</span><br><span class="line">    DriverInfo(Driver driver, DriverAction action) &#123;</span><br><span class="line">        <span class="built_in">this</span>.driver = driver;</span><br><span class="line">        da = action;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h3><p>æ¥ä¸‹æ¥è¿›è¡Œè¿æ¥çš„è·å–ï¼Œ<code>Connection connection = DriverManager.getConnection(url, username, password);</code></p><p><code>Connection</code> æ¥å£æ˜¯å’Œç‰¹å®šæ•°æ®åº“çš„è¿æ¥ä¼šè¯ï¼Œ<strong>ä¸åŒçš„æ•°æ®åº“çš„è¿æ¥ä¼šè¯éƒ½ä¸ç›¸åŒ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Connection</span>  <span class="keyword">extends</span> <span class="title class_">Wrapper</span>, AutoCloseable &#123;</span><br><span class="line"></span><br><span class="line">    Statement <span class="title function_">createStatement</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>DriverManager</code> ä¸­çš„ <code>getConnection</code> æ–¹æ³•ï¼Œä» <code>registeredDrivers</code> è¿›è¡Œé€‰æ‹©å¯¹åº”æ•°æ®åº“é©±åŠ¨ä¸‹çš„è¿æ¥å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(String url,String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    java.util.<span class="type">Properties</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Properties();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">        info.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (password != <span class="literal">null</span>) &#123;</span><br><span class="line">        info.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ä¸‹é¢çš„é™æ€æ–¹æ³• getConnection</span></span><br><span class="line"><span class="comment">//  Worker method called by the public getConnection() methods.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(</span></span><br><span class="line"><span class="params">    String url, java.util.Properties info, Class&lt;?&gt; caller)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * When callerCl is null, we should check the application&#x27;s</span></span><br><span class="line"><span class="comment">         * (which is invoking this class indirectly)</span></span><br><span class="line"><span class="comment">         * classloader, so that the JDBC driver class outside rt.jar</span></span><br><span class="line"><span class="comment">         * can be loaded from here.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">callerCL</span> <span class="operator">=</span> caller != <span class="literal">null</span> ? caller.getClassLoader() : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(DriverManager.class) &#123;</span><br><span class="line">        <span class="comment">// synchronize loading of the correct classloader.</span></span><br><span class="line">        <span class="keyword">if</span> (callerCL == <span class="literal">null</span>) &#123;</span><br><span class="line">            callerCL = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(url == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;The url cannot be null&quot;</span>, <span class="string">&quot;08001&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    println(<span class="string">&quot;DriverManager.getConnection(\&quot;&quot;</span> + url + <span class="string">&quot;\&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Walk through the loaded registeredDrivers attempting to make a connection.</span></span><br><span class="line">    <span class="comment">// Remember the first exception that gets raised so we can reraise it.</span></span><br><span class="line">    <span class="type">SQLException</span> <span class="variable">reason</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(DriverInfo aDriver : registeredDrivers) &#123;</span><br><span class="line">        <span class="comment">// If the caller does not have permission to load the driver then</span></span><br><span class="line">        <span class="comment">// skip it.</span></span><br><span class="line">        <span class="keyword">if</span>(isDriverAllowed(aDriver.driver, callerCL)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                println(<span class="string">&quot;    trying &quot;</span> + aDriver.driver.getClass().getName());</span><br><span class="line">                <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> aDriver.driver.connect(url, info);</span><br><span class="line">                <span class="keyword">if</span> (con != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Success!</span></span><br><span class="line">                    println(<span class="string">&quot;getConnection returning &quot;</span> + aDriver.driver.getClass().getName());</span><br><span class="line">                    <span class="keyword">return</span> (con);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (reason == <span class="literal">null</span>) &#123;</span><br><span class="line">                    reason = ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;    skipping: &quot;</span> + aDriver.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we got here nobody could connect.</span></span><br><span class="line">    <span class="keyword">if</span> (reason != <span class="literal">null</span>)    &#123;</span><br><span class="line">        println(<span class="string">&quot;getConnection failed: &quot;</span> + reason);</span><br><span class="line">        <span class="keyword">throw</span> reason;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    println(<span class="string">&quot;getConnection: no suitable driver found for &quot;</span>+ url);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;No suitable driver found for &quot;</span>+ url, <span class="string">&quot;08001&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Connection-å®ç°"><a href="#Connection-å®ç°" class="headerlink" title="Connection å®ç°"></a>Connection å®ç°</h3><p>åœ¨ <code>Connection</code> æ¥å£çš„å…·ä½“å®ç°éƒ¨åˆ†ï¼ŒMySQL çš„è¿æ¥æ˜¯é€šè¿‡ä¸¤å±‚å®ç°å®ŒæˆæŠ½è±¡éƒ¨åˆ†çš„å®ç°</p><p>ä¸åŒçš„æ•°æ®åº“ä¼šè¿›è¡Œä¸åŒçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionImpl</span> <span class="keyword">implements</span> <span class="title class_">JdbcConnection</span>, SessionEventListener, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4009476458425101761L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">SQLPermission</span> <span class="variable">SET_NETWORK_TIMEOUT_PERM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLPermission</span>(<span class="string">&quot;setNetworkTimeout&quot;</span>);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JdbcConnection</span> <span class="keyword">extends</span> <span class="title class_">Connection</span>, MysqlConnection, TransactionEventHandler &#123;</span><br><span class="line">    JdbcPropertySet <span class="title function_">getPropertySet</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">changeUser</span><span class="params">(String var1, String var2)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><code>DriverManager</code> ä½œä¸ºç»„ç»‡è€…ï¼Œç»„ç»‡äº† <code>Driver</code>ï¼ˆç”±ç®¡ç†è€… <code>DriverInfo</code> è¿›è¡Œç®¡ç†ï¼‰å’Œ <code>Connection</code> ä¸¤ç±»æ¨¡å—</p><p>æ ¹æ®ä½¿ç”¨çš„æ•°æ®åº“ä¸åŒçµæ´»åœ°è¿›è¡Œè¿æ¥çš„é€‰æ‹©</p><p>å¯¹åº”çš„ç±»å›¾ï¼š</p><img src="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F%20-%20Bridge/jdbc%E7%B1%BB%E5%9B%BE.drawio.png" class="" title="jdbcç±»å›¾.drawio"><h1 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å½“å­˜åœ¨ä¸€æ®µé€»è¾‘ä¸­åˆ†ä¸ºå¤šç±»æ¨¡å—æ—¶ï¼Œå¯ä»¥è€ƒè™‘å°†å„æ¨¡å—åˆ†åˆ«å®ç°å†è¿›è¡Œç»„ç»‡é™ä½è€¦åˆ</p><ul><li><p>ä¼˜ç‚¹</p><ul><li>å¯ä»¥å°†åºå¤§çš„ç±»æ‹†åˆ†æˆæ›´æœ‰å±‚æ¬¡çš„ç»“æ„ï¼Œå±‚æ¬¡ä¹‹é—´ä¸å­˜åœ¨è€¦åˆ</li><li>ä¾¿äºæ¨¡å—å®ç°çš„æ‰©å±•ï¼ˆå¼€é—­ï¼‰</li><li>åˆ‡æ¢ä¸åŒçš„å®ç°æ›´åŠ æ–¹ä¾¿</li><li>æ¯ä¸ªæ¨¡å—åˆå¯ä»¥å®šä¹‰å‡ºæŠ½è±¡éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†ï¼ˆå•ä¸€èŒè´£ï¼‰</li></ul></li><li><p>ç¼ºç‚¹</p><ul><li>åœ¨å·²å­˜åœ¨çš„åŠŸèƒ½ä¸Šè¿›è¡Œæ”¹é€ å·¥ç¨‹é‡è¾ƒå¤§ï¼ˆä¸åŒäºé€‚é…å™¨æ¨¡å¼ï¼‰</li><li>é«˜å†…èšçš„ç±»è¿›è¡Œæ¡¥æ¥è®¾è®¡ä¼šä½¿ä»£ç æ›´åŠ å¤æ‚</li></ul></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://refactoringguru.cn/design-patterns/bridge">æ¡¥æ¥è®¾è®¡æ¨¡å¼ (refactoringguru.cn)</a></p><p><a href="https://blog.csdn.net/MY9526/article/details/108738263">æ¡¥æ¥æ¨¡å¼çš„å®é™…ä½¿ç”¨_æœ€åä¸€ä¸ªNPEçš„åšå®¢-CSDNåšå®¢_æ¡¥æ¥æ¨¡å¼å®æˆ˜</a></p><p><a href="https://www.cnblogs.com/EthanWong/p/16079803.html">è®¾è®¡æ¨¡å¼å­¦ä¹ ç¬”è®°ï¼ˆä¹ï¼‰æ¡¥æ¥æ¨¡å¼åŠå…¶åº”ç”¨ - å½’æ–¯å› - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¸ƒéš† &amp; å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%B8%83%E9%9A%86%20&amp;%20%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%B8%83%E9%9A%86%20&amp;%20%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p><strong>ç‰¹å¾ or å…¨éƒ¨</strong></p><p>åœ¨å®é™…éœ€æ±‚ä¸­ï¼Œå¾€å¾€å­˜åœ¨ç±»ä¼¼éœ€æ±‚ï¼š</p><ul><li>é»‘ç™½åå•ï¼›ä¾‹å¦‚æ‰‹æœºå·ã€ç½‘ç«™ç­‰ï¼Œéœ€è¦è¿‡æ»¤æ‰åœ¨é»‘åå•ä¸­çš„æ•°æ®ï¼Œæˆ–è€…æ”¾è¡Œåœ¨ç™½åå•ä¸­çš„æ•°æ®</li><li>æ¨èå»é‡ï¼›é¦–é¡µæ–°é—»ã€è§†é¢‘ç­‰èµ„æºå·²ç»ç»™ç”¨æˆ·æ¨èè¿‡çš„ä¸è¿›è¡Œé‡å¤æ¨é€</li><li>ç¼“å­˜ç©¿é€ï¼›ä¿è¯ç¼“å­˜å±‚èƒ½æ­£å¸¸å·¥ä½œï¼Œä¸è¢«ç‰¹æ®Šè¯·æ±‚å¤§é‡é€ æˆç¼“å­˜ç©¿é€</li></ul><p>æœ€å®¹æ˜“æƒ³åˆ°çš„ï¼Œå°±æ˜¯é€šè¿‡ä¸€ä¸ªé›†åˆä¾‹å¦‚ Mapã€List ç­‰ç»“æ„å°†æ•°æ®å­˜å‚¨èµ·æ¥ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­</p><p>è¿™æ ·ç›¸å½“äºæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½è¿›è¡Œäº†ä¸€éå­˜å‚¨ï¼Œå¦‚æœéœ€è¦çš„åªæ˜¯è¿‡æ»¤åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦å°†æ•°æ®å…¨éƒ¨å­˜å‚¨ä¸‹æ¥ï¼Œåªéœ€è¦å­˜å‚¨æ•°æ®çš„ç‰¹å¾å€¼ï¼Œå°±å¯ä»¥èŠ‚çœå¤§é‡çš„ç©ºé—´</p><p>æ‰€ä»¥å‡ºç°äº†å¸ƒéš†è¿‡æ»¤å™¨ç­‰æ¦‚ç‡å‹ç»“æ„ï¼ˆprobabilistic data structureï¼‰ï¼Œå¯ä»¥åœ¨ä½¿ç”¨å¾ˆå°‘ç©ºé—´çš„æƒ…å†µä¸‹å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤æ“ä½œï¼Œå½“ç„¶é€šè¿‡ç‰¹å¾å€¼è¿›è¡Œå­˜å‚¨å¯èƒ½ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>è¯¯åˆ¤ç‡</li><li>æ‰©ç¼©å®¹ä¾ç„¶éœ€è¦æ•°æ®å…¨é›†ï¼ˆæ•°æ®é‡ä¸åŒ¹é…ä¼šå¯¼è‡´ç©ºé—´æµªè´¹æˆ–è¯¯åˆ¤ç‡ä¸Šå‡ï¼‰</li><li>åˆ é™¤æ“ä½œéš¾ä»¥å®ç°</li></ul><p>éœ€è¦åœ¨æŠ€æœ¯å’Œä¸šåŠ¡ä¸¤æ–¹é¢è¿›è¡Œå–èˆ</p><h1 id="å¸ƒéš†"><a href="#å¸ƒéš†" class="headerlink" title="å¸ƒéš†"></a>å¸ƒéš†</h1><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆbloom filterï¼‰ç”±ä¸€ä¸²å¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡ç»„æˆï¼ˆä½å›¾ bitmapï¼‰ï¼Œå¯ä»¥å°†å…¶çœ‹æˆä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„</p><p>å½“ä¸€ä¸ªå…ƒç´ è¿›å…¥æ—¶ï¼Œä¸æ˜¯å­˜å‚¨è¯¥å…ƒç´ æœ¬èº«ï¼Œè€Œæ˜¯é€šè¿‡å¤šä¸ªå“ˆå¸Œç®—æ³•ï¼Œè®¡ç®—å‡ºè¯¥å…ƒç´ çš„å¤šä¸ªä¸‹æ ‡ï¼Œéšååœ¨ä½å›¾ä¸­å°†å¯¹åº”çš„ä¸‹æ ‡æ‰“ä¸Šæ ‡è®°ï¼ˆbit ä½ç½®ä¸º 1ï¼‰ï¼Œå½“éœ€è¦åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸä¸ªå…ƒç´ æ—¶ï¼Œä¹Ÿæ˜¯è¿›è¡Œå“ˆå¸Œåï¼Œåˆ¤æ–­å…¶éœ€è¦çš„ä¸‹æ ‡æ˜¯å¦å…¨ä¸º 1</p><p>å¯ä»¥çœ‹å‡ºï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¸¦æœ‰ä¸€å®šçš„è¯¯åˆ¤ç‡ï¼Œå¦‚æœå¾ˆå¤šå…ƒç´ çš„ä¸‹æ ‡æ­£å¥½å¤åˆäº†æŸä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œé‚£ä¹ˆè¯¥å…ƒç´ å°±ä¼šè¢«è¯¯åˆ¤å­˜åœ¨ï¼š</p><ul><li>è¯´å­˜åœ¨ä½†ä¸ä¸€å®šå­˜åœ¨</li><li>è¯´ä¸å­˜åœ¨ä¸€å®šä¸å­˜åœ¨</li></ul><p>å›¾ç¤ºæ¨¡æ‹Ÿæµç¨‹ï¼š<a href="https://www.jasondavies.com/bloomfilter/">https://www.jasondavies.com/bloomfilter/</a></p><p><strong>å‚æ•°é€‰æ‹©</strong></p><p>ä¹Ÿå¯ä»¥çœ‹å‡ºå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ç‡å’Œä»¥ä¸‹å‚æ•°ç›¸å…³ï¼š</p><ul><li>è¿‡æ»¤å™¨ä¸­ä½å›¾çš„ä½æ•°</li><li>å“ˆå¸Œç®—æ³•çš„æ•°é‡å’Œè´¨é‡</li></ul><p><a href="https://hur.st/bloomfilter/?n=400000000&p=0.01&m=&k=">Bloom filter calculator (hur.st)</a> å¯ä»¥è¿›è¡Œå¸ƒéš†è¿‡æ»¤å™¨å‚æ•°çš„é¢„ä¼°</p><table><thead><tr><th align="center">å‚æ•°å€¼</th><th align="center">å«ä¹‰</th><th align="center">å…¬å¼</th></tr></thead><tbody><tr><td align="center">n</td><td align="center">è¿‡æ»¤å™¨ä¸­çš„å…ƒç´ æ•°é‡</td><td align="center"><code>n = ceil(m / (-k / log(1 - exp(log(p) / k))))</code></td></tr><tr><td align="center">p</td><td align="center">è¯¯åˆ¤ç‡</td><td align="center"><code>p = pow(1 - exp(-k / (m / n)), k)</code></td></tr><tr><td align="center">m</td><td align="center">è¿‡æ»¤å™¨ä½¿ç”¨çš„ç©ºé—´å¤§å°</td><td align="center"><code>m = ceil((n * log(p)) / log(1 / pow(2, log(2))));</code></td></tr><tr><td align="center">k</td><td align="center">å“ˆå¸Œç®—æ³•æ•°é‡</td><td align="center"><code>k = round((m / n) * log(2));</code></td></tr></tbody></table><p><strong>æ— æ³•åˆ é™¤</strong></p><p>å¸ƒéš†è¿‡æ»¤å™¨æ˜¯æ— æ³•åˆ é™¤å…ƒç´ çš„ï¼Œå› ä¸ºä¸€æ—¦å­˜å‚¨ç‰¹å¾åï¼Œåˆ é™¤ä¼šå¯¼è‡´è¿å¸¦å…¶ä»–å…ƒç´ çš„æ ‡è®°ä¸€èµ·åˆ é™¤</p><p>ä¸ºäº†èƒ½è®©å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤æ“ä½œï¼Œè¡ç”Ÿå‡ºäº†å˜ä½“ç»“æ„ï¼Œè®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆcounting bloom filterï¼‰</p><p><strong>å®é™…åº”ç”¨</strong></p><p><a href="https://toutiao.io/posts/mtrvsx/preview">Now ç›´æ’­å‘ç°é¡µçŸ­è§†é¢‘ç€‘å¸ƒæµä¼˜åŒ– - å¼€å‘è€…å¤´æ¡ (toutiao.io)</a></p><h1 id="è®¡æ•°å¸ƒéš†"><a href="#è®¡æ•°å¸ƒéš†" class="headerlink" title="è®¡æ•°å¸ƒéš†"></a>è®¡æ•°å¸ƒéš†</h1><p>ä½¿ç”¨ä¸€ä¸ª counter æ•°ç»„æ¥æ›¿ä»£ä¹‹å‰çš„ä½å›¾ï¼Œåœ¨è¿›è¡Œæ ‡è®°æ—¶å¯ä»¥è®°å½•ä¸€å…±æ ‡è®°äº†å¤šå°‘æ¬¡ï¼Œæ˜¾è€Œæ˜“è§ç©ºé—´å ç”¨ä¼šæ‰©å¤§ä¸å°‘</p><p>åœ¨è¿›è¡Œåˆ¤æ–­æ—¶ <code>counter &gt; 0</code> å³è¡¨ç¤ºäº†ä¹‹å‰çš„ <code>index == 1</code> æ“ä½œ</p><p>è®¡æ•°å™¨ä¹Ÿæ— æ³•é¿å…è¯¯åˆ ï¼Œåªæ˜¯èƒ½å¤§å¹…åº¦é™ä½è¯¯åˆ æ¦‚ç‡</p><h1 id="å¸ƒè°·é¸Ÿ"><a href="#å¸ƒè°·é¸Ÿ" class="headerlink" title="å¸ƒè°·é¸Ÿ"></a>å¸ƒè°·é¸Ÿ</h1><p>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„å‡çº§ï¼Œæœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>æ”¯æŒåŠ¨æ€çš„æ–°å¢å’Œåˆ é™¤å…ƒç´ </li><li>æä¾›äº†æ¯”ä¼ ç»Ÿå¸ƒéš†è¿‡æ»¤å™¨æ›´é«˜çš„æŸ¥æ‰¾æ€§èƒ½ï¼Œå³ä½¿åœ¨æ¥è¿‘æ»¡ç©ºé—´çš„æƒ…å†µä¸‹ï¼ˆè®¿é—®å†…å­˜æ¬¡æ•°ä½ï¼‰</li><li>è¦æ±‚ä¸€å®šè¯¯åˆ¤ç‡ä¸‹ï¼Œç©ºé—´å ç”¨ä¸€èˆ¬æ›´å°</li></ul><p><strong>å¸ƒè°·é¸Ÿ hash</strong></p><blockquote><p>å½“å‘ç°é¸Ÿè›‹å ç”¨äº†è‡ªå·±çš„ä½ç½®æ—¶ï¼Œå°±æŠŠå®ƒæ¨èµ°</p></blockquote><p>å‡è®¾æœ‰ä¸¤ä¸ª hash è¡¨ï¼Œè®°ä¸º T1 å’Œ T2</p><p>åŒæ—¶æœ‰ä¸¤å¥— hash ç®—æ³•ï¼Œè®°ä¸º H1 å’Œ H2</p><p>æ·»åŠ å…ƒç´ æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ ¹æ® H1 è®¡ç®—å…¶åœ¨ T1 çš„ä½ç½®ä¸‹æ ‡</li><li>å¦‚æœè¯¥ä½ç½®æ²¡æœ‰æ ‡è®°åˆ™è¿›è¡Œæ ‡è®°ï¼Œå¦‚æœæ ‡è®°äº†åˆ™ç»§ç»­</li><li>æ ¹æ® H2 è®¡ç®—å…¶åœ¨ T2 çš„ä½ç½®ä¸‹æ ‡</li><li>å¦‚æœè¯¥ä½ç½®æ²¡æœ‰æ ‡è®°åˆ™è¿›è¡Œæ ‡è®°ï¼Œå¦‚æœæ ‡è®°äº†åˆ™è¯´æ˜æ‰€æœ‰ä½ç½®éƒ½å·²ç»è¢«å ç”¨ï¼Œéšæœºè¸¢å‡º T1 æˆ–è€… T2 ä¸Šè¯¥ä¸‹æ ‡çš„å…ƒç´ ï¼Œå°†è‡ªå·±æ”¾å…¥ä¸‹æ ‡</li><li>è¢«è¸¢å‡ºçš„å…ƒç´ é‡å¤ä¸Šè¿°æµç¨‹æŸ¥æ‰¾è‡ªå·±çš„ä½ç½®</li><li>ç»è¿‡ <code>MaxLoop </code> é˜ˆå€¼åè¿˜å­˜åœ¨å…ƒç´ æ²¡æœ‰åˆé€‚çš„ä½ç½®ï¼Œåˆ™å…ƒç´ æ·»åŠ å¤±è´¥ï¼Œè¯´æ˜éœ€è¦è¿›è¡Œæ‰©å®¹äº†</li></ol><p>å›¾ç¤ºæ¨¡æ‹Ÿæµç¨‹ï¼š<a href="http://www.lkozma.net/cuckoo_hashing_visualization/">http://www.lkozma.net/cuckoo_hashing_visualization/</a></p><p><strong>è¿‡æ»¤å™¨çš„ hash</strong></p><p>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨çš„ hash æ˜¯å¯¹å¸ƒè°·é¸Ÿ hash çš„æ”¹è¿›</p><p>å¸ƒè°·é¸Ÿ hash ä¸­ï¼Œå“ˆå¸Œè¡¨å­˜å‚¨çš„æ˜¯å…ƒç´ çš„åŸå§‹å€¼ xï¼Œä¸‹æ ‡ p1 p2 çš„è®¡ç®—å…¬å¼ä¸º</p><ul><li><code>p1 = hash1(x) % L</code></li><li><code>p2 = hash2(x) % L</code></li></ul><p>è€Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨å¯¹äºä¸‹æ ‡çš„è®¡ç®—ä¸ºï¼š</p><ul><li><code>h1(x) = hash(x)</code></li><li><code>h2(x) = h1(x) âŠ• hash(x&#39;s fingerprint)</code></li></ul><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®— h2ï¼ˆä½ç½® 2ï¼‰æ—¶ï¼Œå¯¹ x çš„ fingerprint è¿›è¡Œäº†ä¸€ä¸ª hash è®¡ç®—ï¼Œå…¬å¼ä¸­çš„å¼‚æˆ–æ“ä½œè·å¾—äº†ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼šä½ç½® h2 å¯ä»¥é€šè¿‡ä½ç½® h1 å’Œ h1 ä¸­å­˜å‚¨çš„ fingerprint è®¡ç®—å‡ºæ¥ï¼Œå³å½“å…ƒç´ è¢«è¸¢å‡ºæ—¶ï¼Œæ ¹æ®å½“å‰ä½ç½®å’Œå…ƒç´ çš„æŒ‡çº¹ï¼Œå°±å¯ä»¥å¾—åˆ°å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®</p><p><strong>å¼‚æˆ–ä¸å¯¹å¶</strong></p><p>ç”± h2 çš„è®¡ç®—å…¬å¼ <code>h2(x) = h1(x) âŠ• hash(x&#39;s fingerprint)</code>ï¼Œä¸¤ä¸ªä½ç½®å…·æœ‰å¯¹å¶æ€§</p><p>åªè¦ä¿è¯ <code>hash(x&#39;s fingerprint) !=0</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç¡®ä¿ <code>h2 != h1</code>ï¼Œä¹Ÿå°±å¯ä»¥ç¡®ä¿ï¼Œä¸ä¼šå‡ºç°è‡ªå·±è¸¢è‡ªå·±çš„æ­»å¾ªç¯é—®é¢˜</p><p>ä¸ºä»€ä¹ˆéœ€è¦å¯¹æŒ‡çº¹è¿›è¡Œå“ˆå¸Œè¿ç®—å‘¢ï¼Ÿå› ä¸ºå¦‚æœæŒ‡çº¹çš„é•¿åº¦æ˜¯ 8 bitï¼Œé‚£ä¹ˆå¼‚æˆ–æ“ä½œåªä¼šæ”¹å˜å½“å‰ä½ç½®  h1(x)  çš„ä½ 8 ä½ï¼Œé«˜ä½ä¸ä¼šæ”¹å˜ï¼Œå°±ç®—ä½ 8 ä½å®Œå…¨ä¸ä¸€æ ·ï¼Œæœ€åè®¡ç®—å‡ºæ¥çš„ä½ç½®æœ€è¿œä¹Ÿåªæœ‰ 256 ä½ï¼Œä¸ºäº†æ•£åˆ—æ›´å……åˆ†ï¼Œæ‰€ä»¥å¯¹æŒ‡çº¹å…ˆè¿›è¡Œä¸€æ¬¡å“ˆå¸Œæ“ä½œ</p><p><strong>æŒ‡çº¹</strong></p><p>æŒ‡çº¹å…¶å®å°±æ˜¯å…ƒæ•°æ®çš„ç‰¹å¾å€¼ï¼Œè¿›è¡Œå“ˆå¸Œåå–çš„å›ºå®š n ä¸ª bit ä½</p><p><strong>ç©ºé—´åˆ©ç”¨ç‡</strong></p><p>ç”±äºæŒ‡çº¹æ˜¯å¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œè¿ç®—åå›ºå®šçš„ bit ä½ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå‡ºç°è¯¯åˆ¤çš„æƒ…å†µ</p><p>åœ¨å®Œç¾çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘ç”Ÿå“ˆå¸Œå†²çªä¹‹å‰ï¼Œå®ƒçš„ç©ºé—´åˆ©ç”¨ç‡æœ€é«˜åªæœ‰ 50%</p><p>å¦‚æœå¯¹æ•°ç»„è¿›è¡Œå±•å¼€ï¼Œå½“ä¸€ä¸ªä½ç½®å¯ä»¥å­˜æ”¾å¤šä¸ªæ•°æ®æ—¶ï¼Œç©ºé—´åˆ©ç”¨ç‡ä¼šæå‡ï¼›å¦‚æœä¸€ä¸ªä¸‹æ ‡å¯ä»¥æ”¾ 2ã€4ã€8 ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œç©ºé—´åˆ©ç”¨ç‡å°±ä¼šé£™å‡åˆ° 84%ã€95%ã€98%</p><p><strong>åˆ é™¤çš„é™åˆ¶</strong></p><p>å¦‚æœéœ€è¦å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ”¯æŒåˆ é™¤ï¼Œå®ƒå¿…é¡»çŸ¥é“ä¸€ä¸ªæ•°æ®æ’å…¥è¿‡å¤šå°‘æ¬¡ï¼ˆå¦åˆ™ä¹Ÿä¼šè¯¯åˆ ï¼‰</p><p>å¹¶ä¸”ä¸èƒ½è®©åŒä¸€ä¸ªæ•°æ®æ’å…¥ <code>kb+1</code> æ¬¡ï¼›ä¸ªäººè®¤ä¸ºå¦‚æœæ’å…¥è¶…è¿‡äº† <code>kb+1</code> æ¬¡ï¼Œå°±ä¼šå¯¼è‡´æ’å…¥ä¸€å®šå¤±è´¥</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¸ƒè°·é¸Ÿçš„ä¼˜ç¼ºç‚¹ï¼š</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>è®¿é—®å†…å­˜æ¬¡æ•°ä½</li><li>Hash å‡½æ•°è®¡ç®—ç®€å•</li><li>æ”¯æŒåˆ é™¤æ“ä½œ</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å†…å­˜ç©ºé—´ä¸è”ç³»ï¼ŒCPU æ¶ˆè€—å¤§</li><li>å®¹æ˜“å‡ºç°è£…å¡«å¾ªç¯é—®é¢˜ï¼Œç©ºé—´å ç”¨è¶Šå¤šç¢°æ’è¶Šå¤šï¼Œæ’å…¥æ•ˆç‡è¶Šä½</li><li>æŸ¥è¯¢è¯¯åˆ¤ç‡</li><li>åˆ é™¤æ“ä½œé™åˆ¶å¤šï¼Œä¼šå½±å“æ’å…¥æ€§èƒ½å’Œè¯¯åˆ é™¤</li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf">https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf</a></p><p><a href="https://zhuanlan.zhihu.com/p/348865590">å¸ƒéš†ï¼Œç‰›é€¼ï¼å¸ƒè°·é¸Ÿï¼Œç‰›é€¼ï¼ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://juejin.cn/post/6844903861749055502">å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ—¶äº†ï¼Œæœªæ¥å±äºå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼Ÿ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="https://zhuanlan.zhihu.com/p/462815302">å¸ƒéš†è¿‡æ»¤å™¨ä¸å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ•°æ®ç»“æ„ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®¡é“æ¨¡å¼ - Pipeline</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AE%A1%E9%81%93%E6%A8%A1%E5%BC%8F%20-%20Pipeline.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AE%A1%E9%81%93%E6%A8%A1%E5%BC%8F%20-%20Pipeline.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç®¡é“æ¨¡å¼ï¼ˆPipeline Patternï¼‰æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Command Patternï¼‰çš„å˜ä½“ï¼›åŒºåˆ«åœ¨äºè´£ä»»é“¾æ˜¯å°†å¤„ç†å™¨æŒ‰ç…§é“¾æ¡ç»„ç»‡èµ·æ¥ï¼Œå¾…å¤„ç†çš„ä¸Šä¸‹æ–‡æŒ‰ç…§é“¾æ¡æ‰¾åˆ°èƒ½å¤Ÿå¤„ç†è‡ªå·±çš„å¤„ç†å™¨ï¼Œä¸€èˆ¬åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªå¤„ç†å™¨ï¼›è€Œç®¡é“æ¨¡å¼æ˜¯é“¾æ¡ä¸­çš„æ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½éœ€è¦å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œå¤„ç†</p><p><strong>ç›®çš„</strong><br>é™ä½ä¸šåŠ¡é€»è¾‘æµç¨‹çš„è€¦åˆæ€§ï¼Œå°†æ•´ä¸ªè¿‡ç¨‹ä¸­æ‰€æœ‰çš„å¤„ç†å™¨éš”ç¦»å¼€ï¼Œæ›´æ–¹ä¾¿æ‰©å±•æµç¨‹ä¸Šæ–°çš„ä¸šåŠ¡é€»è¾‘</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong><br>å·¥å‚çš„ç”Ÿäº§æµæ°´çº¿ï¼Œè½¦æ¶ -&gt; å‘é€æœº -&gt; å¤–å£³ -&gt; å†…é¥° -&gt; æ€»è£… -&gt; è´¨æ£€ï¼Œæ•´è¾†è½¦åœ¨ä¼ é€å¸¦åˆä¸€ä¸ªç¯èŠ‚è¿è¾“è‡³å¦ä¸€ä¸ªç¯èŠ‚ï¼Œæ¯ä¸ªå¤„ç†ç¯èŠ‚éƒ½å¯¹æ±½è½¦å¤„ç†è‡ªå·±çš„éƒ¨åˆ†ï¼Œæœ€ç»ˆäº§å‡ºæˆå“</p><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œæ¯”å¦‚è®¢å•æœåŠ¡å†…æŸ¥è¯¢æ¥å£æŠŠæœ€ç»ˆè®¢å•å®ä½“ç»„è£…ä¸ºä¸€ä¸ª VO</p><p>é™¤äº†åŸæœ‰çš„å®ä½“å±æ€§ï¼Œæ¯”å¦‚å†…éƒ¨æ•°æ®éœ€è¦å¯¹ä¼˜æƒ é‡‘é¢è¿›è¡Œè®¡ç®—ï¼Œå¤–éƒ¨æ•°æ®éœ€è¦è¡¥å……ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ç­‰</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å¦‚æœå°†æ‰€æœ‰æ­¥éª¤æŠ½ä¸ºæ–¹æ³•ï¼Œåˆ™ä»£ç ä¸€èˆ¬ä¼šå®ç°ä¸ºè¿™æ ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">buildVO</span><span class="params">(OrderBo bo)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">OrderInfoVo</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="built_in">this</span>.wrapVo(bo);</span><br><span class="line">    <span class="built_in">this</span>.calMitigateSum(vo);</span><br><span class="line">    <span class="built_in">this</span>.buildUserInfo(vo);</span><br><span class="line">    <span class="built_in">this</span>.buildCommodityInfo(vo);</span><br><span class="line">    <span class="keyword">return</span> vo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢å¦‚æœå¯¹ VO çš„å­—æ®µæœ‰äº†æ–°çš„è¦æ±‚ï¼Œæ¯”å¦‚å¢åŠ ç‰©æµä¿¡æ¯ï¼›æˆ–è€…å¯¹ç”Ÿæˆ VO çš„æµç¨‹æœ‰äº†æ–°çš„è¦æ±‚ï¼Œæ¯”å¦‚æ ¹æ®æŸ¥è¯¢æ¡ä»¶è¿›è¡Œç¼“å­˜ï¼Œå°±ä¼šæœ‰ä»¥ä¸‹åå¤„ï¼š</p><ul><li>åœ¨ <code>buildVO</code> ä¸­å®ç°ç¼“å­˜é€»è¾‘ï¼Œè¿åäº†æ–¹æ³•çš„å•ä¸€èŒè´£ï¼Œç»´æŠ¤åœ¨å¤–é¢å¯èƒ½åˆéœ€è¦ç»´æŠ¤ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£</li><li>å°†æ¥æ¯åŠ å…¥ä¸€ä¸ªæ–°çš„å¤„ç†æ­¥éª¤æˆ–è€…åˆ é™¤æŸä¸ªæ­¥éª¤ï¼Œéƒ½è¦ä¿®æ”¹ <code>buildVO</code> æ–¹æ³•</li></ul><p>è¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ç®¡é“æ¨¡å¼è§£å†³ä»¥ä¸Šç¼ºç‚¹</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="ä¸Šä¸‹æ–‡"><a href="#ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸Šä¸‹æ–‡"></a>ä¸Šä¸‹æ–‡</h3><p>ä¸Šä¸‹æ–‡ç»´æŠ¤ç€æ•´ä¸ªä¸šåŠ¡é“¾æ¡ä¸­é—´çš„ç»“æœå’Œæœ€ç»ˆçš„ç»“æœæ•°æ®</p><p><strong>ç®¡é“ä¸Šä¸‹æ–‡çˆ¶ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ é€’åˆ°ç®¡é“çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PipelineContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¼€å§‹æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime startTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†ç»“æŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime endTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ•°æ®åç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…·ä½“çš„ä¸šåŠ¡æ•°æ®ä¸Šä¸‹æ–‡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸šåŠ¡ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderVOContext</span> <span class="keyword">extends</span> <span class="title class_">PipelineContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¢å•ä¸šåŠ¡æ¨¡å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> OrderBO bo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¢å• VO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> OrderVO vo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨¡å‹åˆ›å»ºå‡ºé”™æ—¶çš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String errorMsg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶ä»–å‚æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;build OrderVO&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†å™¨"><a href="#å¤„ç†å™¨" class="headerlink" title="å¤„ç†å™¨"></a>å¤„ç†å™¨</h3><p><strong>å¤„ç†å™¨çˆ¶ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“ä¸­çš„ä¸Šä¸‹æ–‡å¤„ç†å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContextHandler</span>&lt;T <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context å¤„ç†æ—¶çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å› true åˆ™è¡¨ç¤ºç”±ä¸‹ä¸€ä¸ª ContextHandler ç»§ç»­å¤„ç†ï¼Œè¿”å› false åˆ™è¡¨ç¤ºå¤„ç†ç»“æŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(T context)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¡ç®—ä¼˜æƒ é‡‘é¢</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalMitigateSumHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--è®¡ç®—ä¼˜æƒ é‡‘é¢--&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¡ç®—æµç¨‹</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">mitigateSum</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        context.getVo().setMitigateSum(mitigateSum);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ„é€ ç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">buildUserInfoHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--æ„é€ ç”¨æˆ·ä¿¡æ¯--&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.getUserById(context.getBo().getUserId());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">            context.setErrorMsg(<span class="string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºï¼Œid=&quot;</span> + context.getBo().getUserId());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        context.getVo().setUserName(user.getName());</span><br><span class="line">        context.getVo().setUserAge(user.getAge());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ„é€ å•†å“ä¿¡æ¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">buildGoodsInfoHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--æ„é€ å•†å“ä¿¡æ¯--&quot;</span>);</span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> goodsClient.getGoodsBySku(context.getBo().getGoodsSku());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(goods)) &#123;</span><br><span class="line">            context.setErrorMsg(<span class="string">&quot;æŸ¥è¯¢å•†å“ä¿¡æ¯ä¸ºç©ºï¼Œid=&quot;</span> + context.getBo().getGoodsSku());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        context.getVo().setGoodsSku(goods.getSku());</span><br><span class="line">        context.getVo().setGoodsName(goods.getName());</span><br><span class="line">context.getVo().setGoodsPrice(goods.getPrice());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»„ç»‡å¤„ç†å™¨"><a href="#ç»„ç»‡å¤„ç†å™¨" class="headerlink" title="ç»„ç»‡å¤„ç†å™¨"></a>ç»„ç»‡å¤„ç†å™¨</h3><p>ç°åœ¨ä¸šåŠ¡ Context å’Œ Handler éƒ½å®šä¹‰å¥½äº†ï¼Œé‚£ä¹ˆä½¿ç”¨ä»€ä¹ˆæ–¹å¼å°† Handler ç»„ç»‡èµ·æ¥å‘¢ï¼Ÿæœ‰å¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>Handler å¯¹è±¡æŒæœ‰ä¸‹ä¸€ä¸ª Handler çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä½¿ç”¨ <code>nextHandler</code> å±æ€§æ¥ä¿å­˜ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›ç¼ºç‚¹æ˜¯æ— æ³•ç›´è§‚äº†è§£æ•´ä¸ªä¸šåŠ¡é“¾æ¡éƒ½æœ‰å“ªäº›å¤„ç†å™¨ï¼Œå¹¶ä¸”å¢åˆ å¤„ç†å™¨éœ€è¦ä¿®æ”¹å…¶ä»–å¤„ç†å™¨çš„å±æ€§</li><li>è‡ªå®šä¹‰æ³¨è§£å°†é¡ºåºä¿¡æ¯å’Œ Handler çš„å®ç°ç»‘å®šï¼›è¿™æ ·ä¹Ÿæ— æ³•ç›´è§‚äº†è§£åˆ°ä¸€æ®µä¸šåŠ¡éƒ½æœ‰å¤šå°‘ä¸ªå¤„ç†å™¨</li><li>ç»´æŠ¤ä¸€ä¸ªè·¯ç”±è¡¨ï¼ŒåŸºäº Spring çš„è‡ªåŠ¨æ³¨å…¥æ¥å®ç°å’Œç®¡ç†è·¯ç”±è¡¨ï¼Œä½¿ç”¨ä¸€ä¸ªæ‰§è¡Œå™¨è§’è‰²åªæœ‰å¤„ç†å™¨é›†åˆä½œä¸ºå…¥å£</li></ul><p><strong>æ„é€ è·¯ç”±è¡¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“è·¯ç”±çš„é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PipelineRouteConfig</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•°æ®ç±»å‹-&gt;ç®¡é“ä¸­å¤„ç†å™¨ç±»å‹åˆ—è¡¨ çš„è·¯ç”±</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span></span><br><span class="line">    Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;,</span><br><span class="line">        List&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt;&gt;&gt; PIPELINE_ROUTE_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * åœ¨è¿™é‡Œé…ç½®å„ç§ä¸Šä¸‹æ–‡ç±»å‹å¯¹åº”çš„å¤„ç†ç®¡é“ï¼šé”®ä¸ºä¸Šä¸‹æ–‡ç±»å‹ï¼Œå€¼ä¸ºå¤„ç†å™¨ç±»å‹çš„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PIPELINE_ROUTE_MAP.put(OrderVOContext.class,</span><br><span class="line">                               Arrays.asList(</span><br><span class="line">                                       CalMitigateSumHandler.class,</span><br><span class="line">                                       buildUserInfoHandler.class,</span><br><span class="line">                                       buildGoodsInfoHandler.class</span><br><span class="line">                               ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†æ¥å…¶ä»– Context çš„ç®¡é“é…ç½®</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨ Spring å¯åŠ¨æ—¶ï¼Œæ ¹æ®è·¯ç”±è¡¨ç”Ÿæˆå¯¹åº”çš„ç®¡é“æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;pipelineRouteMap&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;, List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt;&gt; getHandlerPipelineMap() &#123;</span><br><span class="line">        <span class="keyword">return</span> PIPELINE_ROUTE_MAP.entrySet()</span><br><span class="line">                                 .stream()</span><br><span class="line">                                 .collect(Collectors.toMap(Map.Entry::getKey, <span class="built_in">this</span>::toPipeline));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®ç»™å®šçš„ç®¡é“ä¸­ ContextHandler çš„ç±»å‹çš„åˆ—è¡¨ï¼Œæ„å»ºç®¡é“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt; toPipeline(</span><br><span class="line">            Map.Entry&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;, List&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt;&gt;&gt; entry) &#123;</span><br><span class="line">        <span class="keyword">return</span> entry.getValue()</span><br><span class="line">                    .stream()</span><br><span class="line">                    .map(appContext::getBean)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext appContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        appContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç®¡é“æ‰§è¡Œå™¨</strong></p><p>ç®¡é“æ‰§è¡Œå™¨æ ¹æ®ä¼ å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®çš„ç±»å‹ï¼Œæ‰¾åˆ°å…¶å¯¹åº”çš„ç®¡é“ï¼Œç„¶åå°†ä¸Šä¸‹æ–‡æ•°æ®æ”¾å…¥ç®¡é“ä¸­å»è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“æ‰§è¡Œå™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PipelineExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼•ç”¨ PipelineRouteConfig ä¸­çš„ pipelineRouteMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;,</span><br><span class="line">                List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="built_in">super</span> PipelineContext&gt;&gt;&gt; pipelineRouteMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒæ­¥å¤„ç†è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     * å¦‚æœå¤„ç†æ—¶ä¸Šä¸‹æ–‡æ•°æ®æµé€šåˆ°æœ€åä¸€ä¸ªå¤„ç†å™¨ä¸”æœ€åä¸€ä¸ªå¤„ç†å™¨è¿”å› trueï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¤„ç†è¿‡ç¨‹ä¸­ç®¡é“æ˜¯å¦ç•…é€šï¼Œç•…é€šè¿”å› trueï¼Œä¸ç•…é€šè¿”å› false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">acceptSync</span><span class="params">(PipelineContext context)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(context, <span class="string">&quot;ä¸Šä¸‹æ–‡æ•°æ®ä¸èƒ½ä¸º null&quot;</span>);</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°æ•°æ®ç±»å‹</span></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt; dataType = context.getClass();</span><br><span class="line">        <span class="comment">// è·å–æ•°æ®å¤„ç†ç®¡é“</span></span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="built_in">super</span> PipelineContext&gt;&gt; pipeline = pipelineRouteMap.get(dataType);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(pipeline)) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;&#123;&#125; çš„ç®¡é“ä¸ºç©º&quot;</span>, dataType.getSimpleName());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç®¡é“æ˜¯å¦ç•…é€š</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lastSuccess</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ContextHandler&lt;? <span class="built_in">super</span> PipelineContext&gt; handler : pipeline) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å½“å‰å¤„ç†å™¨å¤„ç†æ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­å‘ä¸‹å¤„ç†</span></span><br><span class="line">                lastSuccess = handler.handle(context);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                lastSuccess = <span class="literal">false</span>;</span><br><span class="line">                logger.error(<span class="string">&quot;[&#123;&#125;] å¤„ç†å¼‚å¸¸ï¼Œhandler=&#123;&#125;&quot;</span>, context.getName(), handler.getClass().getSimpleName(), ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸å†å‘ä¸‹å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (!lastSuccess) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lastSuccess;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨ç®¡é“"><a href="#ä½¿ç”¨ç®¡é“" class="headerlink" title="ä½¿ç”¨ç®¡é“"></a>ä½¿ç”¨ç®¡é“</h3><p>åŸæ¥çš„ <code>buildVO</code> å¯ä»¥å¼•å…¥ç®¡é“æ¥è¿›è¡Œå®ç°äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">buildVO</span><span class="params">(OrderBo bo)</span> &#123;</span><br><span class="line">    <span class="type">OrderVOContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="built_in">this</span>.createContext(bo);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> pipelineExecutor.acceptSync(data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµç¨‹æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="keyword">return</span> CommonResponse.success(data.getInstanceId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.error(<span class="string">&quot;build vo å¤±è´¥ï¼š&#123;&#125;&quot;</span>, data.getErrorMsg());</span><br><span class="line">    <span class="keyword">return</span> CommonResponse.failed(data.getErrorMsg());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ å¤„ç†å™¨"><a href="#å¢åŠ å¤„ç†å™¨" class="headerlink" title="å¢åŠ å¤„ç†å™¨"></a>å¢åŠ å¤„ç†å™¨</h3><p>å¦‚æœéœ€è¦åœ¨æµç¨‹ä¸­å¢åŠ æ–°ä¸šåŠ¡</p><p><strong>åˆ›å»ºæ–°çš„å¤„ç†å™¨å®ç°ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">newTaskHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--æ‰§è¡Œæ–°ä¸šåŠ¡--&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹æ‰‹åŠ¨ç»´æŠ¤çš„é™æ€è·¯ç”±è¡¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    PIPELINE_ROUTE_MAP.put(OrderVOContext.class,</span><br><span class="line">                           Arrays.asList(</span><br><span class="line">                               CalMitigateSumHandler.class,</span><br><span class="line">                               buildUserInfoHandler.class,</span><br><span class="line">                               newTaskHandler.class, <span class="comment">// æµç¨‹ä¸­å¢åŠ äº†æ–°é€»è¾‘</span></span><br><span class="line">                               buildGoodsInfoHandler.class</span><br><span class="line">                           ));</span><br></pre></td></tr></table></figure><h3 id="å¼‚æ­¥å¤„ç†"><a href="#å¼‚æ­¥å¤„ç†" class="headerlink" title="å¼‚æ­¥å¤„ç†"></a>å¼‚æ­¥å¤„ç†</h3><p>å¯¹äºæ­¥éª¤ç¹å¤šçš„ä»»åŠ¡ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬æ›´éœ€è¦çš„æ˜¯å¼‚æ­¥å¤„ç†ï¼Œæ¯”å¦‚æŸäº›è€—æ—¶é•¿çš„å®šæ—¶ä»»åŠ¡ï¼Œç®¡é“å¤„ç†å¼‚æ­¥åŒ–éå¸¸çš„ç®€å•</p><p>åœ¨ PipelineExecutor ä¸­å¼•å…¥å¼‚æ­¥çš„å¤„ç†æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolTaskExecutor pipelineThreadPool; <span class="comment">// å¤„ç†å¼‚æ­¥çš„çº¿ç¨‹æ± </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼‚æ­¥å¤„ç†è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context  ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callback å¤„ç†å®Œæˆçš„å›è°ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acceptAsync</span><span class="params">(PipelineContext context, BiConsumer&lt;PipelineContext, Boolean&gt; callback)</span> &#123;</span><br><span class="line">    pipelineThreadPool.execute(() -&gt; &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> acceptSync(context);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback.accept(context, success);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>é€šè¿‡ç®¡é“æ¨¡å¼ï¼Œå¯ä»¥å¤§å¹…é™ä½äº†ç³»ç»Ÿçš„è€¦åˆåº¦å’Œæå‡äº†å†…èšç¨‹åº¦ä¸æ‰©å±•æ€§ï¼š</p><ul><li><p>ä¼˜ç‚¹</p><ul><li><code>buildVO</code> æ‰€åœ¨çš„ç±»åªè´Ÿè´£å¤„ç†å¼•å¯¼ BO è¿›å…¥ç®¡é“çš„ä¸šåŠ¡æµç¨‹ï¼Œè€Œä¸å…³æ³¨å…·ä½“ä¸šåŠ¡é€»</li><li><code>PipelineExecutor </code> æŠ½è±¡å®šä¹‰ï¼Œä¸å…³å¿ƒä¸šåŠ¡ç»†èŠ‚</li><li>æ¯ä¸ª <code>ContextHandler </code> åªè´Ÿè´£è‡ªå·±çš„ä¸šåŠ¡ï¼Œä¸éœ€è¦çŸ¥é“é“¾è·¯ç»“æ„ï¼Œä¸å…¶ä»–å¤„ç†å™¨è§£è€¦</li><li>å¯¹äºå¤„ç†å™¨æ–°å¢ã€åˆ é™¤ã€è°ƒæ•´é¡ºåºç­‰æ“ä½œï¼Œåªéœ€è¦ä¿®æ”¹è·¯ç”±è¡¨ï¼Œå’Œä¸šåŠ¡é€»è¾‘è„±ç¦»</li></ul></li><li><p>ç¼ºç‚¹</p><ul><li>å¤§çš„ Context å¯¹è±¡ï¼Œè®©ä¸šåŠ¡æ•°æ®ç²’åº¦å¾ˆç²—ï¼ˆä¸Šå¸å¯¹è±¡ï¼‰</li><li>å’Œç­–ç•¥ä¸€æ ·ï¼Œå¯èƒ½é€ æˆå®ç°ç±»è†¨èƒ€</li><li>é”™è¯¯ä¿¡æ¯éœ€è¦ä¿å­˜åœ¨ Context å¯¹è±¡ä¸­ï¼Œèµ°å®Œæ‰€æœ‰å¤„ç†å™¨æ‰ä¼šå°†é”™è¯¯è¿”å›</li></ul></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/370363597">è®¾è®¡æ¨¡å¼æœ€ä½³å¥—è·¯2 â€”â€” åŸºäº Spring å®ç°ç®¡é“æ¨¡å¼çš„æœ€ä½³å®è·µ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://refactoringguru.cn/design-patterns/chain-of-responsibility">è´£ä»»é“¾è®¾è®¡æ¨¡å¼ï¼ˆèŒè´£é“¾æ¨¡å¼ï¼‰ (refactoringguru.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQ æœ€ä½³å®è·µ</title>
      <link href="/%E5%BC%80%E5%8F%91/MQ/RocketMQ%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"/>
      <url>/%E5%BC%80%E5%8F%91/MQ/RocketMQ%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html</url>
      
        <content type="html"><![CDATA[<h1 id="Topic-ä¸-Tag"><a href="#Topic-ä¸-Tag" class="headerlink" title="Topic ä¸ Tag"></a>Topic ä¸ Tag</h1><p>åœ¨ RocketMQ ä¸­ï¼ŒTopic å’Œ Tag éƒ½æ˜¯ä¸šåŠ¡ä¸Šç”¨æ¥å½’ç±»çš„æ ‡è¯†ï¼Œé€šè¿‡åˆç†çš„ä½¿ç”¨ Topic å’Œ Tag å¯ä»¥è®©ä¸šåŠ¡ç»“æ„æ¸…æ™°ï¼Œæ›´å¯ä»¥æé«˜æ•ˆç‡</p><p><strong>Topic</strong> æ˜¯æ¶ˆæ¯ä¸»é¢˜ï¼Œé€šè¿‡ Topic å¯¹ä¸åŒçš„ä¸šåŠ¡æ¶ˆæ¯è¿›è¡Œåˆ†ç±»<br><strong>Tag</strong>  æ˜¯æ¶ˆæ¯æ ‡ç­¾ï¼Œç”¨æ¥è¿›ä¸€æ­¥åŒºåˆ†æŸä¸ª Topic ä¸‹çš„æ¶ˆæ¯åˆ†ç±»ï¼Œæ˜¯æ¶ˆæ¯ç”Ÿäº§æ—¶å³ç”±æ¶ˆæ¯ç”Ÿäº§è€…è®¾ç½®çš„å±æ€§  </p><p>Topic å’Œ Tag çš„é€‰æ‹©ï¼Œå»ºè®®ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢åˆ¤æ–­ï¼š</p><ul><li><strong>æ¶ˆæ¯ç±»å‹æ˜¯å¦ä¸€è‡´ï¼š</strong>æ™®é€šæ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ï¼›ä¸åŒæ¶ˆæ¯ä½¿ç”¨ä¸åŒçš„ Topicï¼Œæ— æ³•é€šè¿‡ Tag è¿›è¡ŒåŒºåˆ†</li><li><strong>ä¸šåŠ¡æ˜¯å¦ç›¸å…³è”ï¼š</strong>æ²¡æœ‰å…³è”çš„ä¸šåŠ¡åº”è¯¥ä½¿ç”¨ä¸åŒçš„ Topic</li><li><strong>æ¶ˆæ¯ä¼˜å…ˆçº§æ˜¯å¦ä¸€è‡´ï¼š</strong>åŒä¸€ä¸ª Topic å†…åº”è¯¥æ˜¯åŒæ ·ä¼˜å…ˆçº§çš„æ¶ˆæ¯</li><li><strong>é‡çº§æ˜¯å¦ç›¸å½“ï¼š</strong>ä¸šåŠ¡é‡å°ä½†å®æ—¶æ€§é«˜çš„æ¶ˆæ¯å’Œä¸šåŠ¡é‡å¤§çš„æ¶ˆæ¯æ”¾åœ¨ä¸€ä¸ª Topic å†…ï¼Œå¯èƒ½ä¼šå¯¼è‡´é¥¥é¥¿</li></ul><p>ä»¥ç”µå•†ç³»ç»Ÿä¸ºä¾‹ï¼Œè®¢å•æ¶ˆæ¯å’Œæ”¯ä»˜æ¶ˆæ¯å±äºä¸åŒçš„ä¸šåŠ¡ï¼Œè®¾ç½® TOPIC_ORDER å’Œ TOPIC_PAY<br>å…¶ä¸­è®¢å•æ¶ˆæ¯æ ¹æ®å•†å“ç§ç±»å†åˆ’åˆ†ä¸ºä¸åŒçš„ tagï¼Œä¾‹å¦‚ç”µå™¨ç±»ã€æœè£…ç±»ã€å›¾ä¹¦ç±»ç­‰<br>æ”¯ä»˜æ¶ˆæ¯æ ¹æ®ä¸åŒçš„æ”¯ä»˜æ¸ é“åˆ’åˆ†ï¼Œä¾‹å¦‚é“¶è¡Œå¡ã€æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ç­‰</p><h1 id="æ¶ˆè´¹å¹‚ç­‰"><a href="#æ¶ˆè´¹å¹‚ç­‰" class="headerlink" title="æ¶ˆè´¹å¹‚ç­‰"></a>æ¶ˆè´¹å¹‚ç­‰</h1><p>ä¸ºäº†é˜²æ­¢æ¶ˆæ¯é‡å¤æ¶ˆè´¹å¯¼è‡´ä¸šåŠ¡å¤„ç†å¼‚å¸¸ï¼ŒRocketMQ æ¶ˆè´¹è€…åœ¨æ¥æ”¶æ¶ˆæ¯åï¼Œæœ‰å¿…è¦æ ¹æ®ä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Key å¯¹æ¶ˆæ¯è¿›è¡Œå¹‚ç­‰å¤„ç†</p><p>ä¸ªäººè®¤ä¸ºéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Keyï¼Œæ— è®ºæ˜¯åœ¨ Consumer å±‚åšå»é‡å®ç°ä¸šåŠ¡å¹‚ç­‰ï¼ˆå»é‡è¡¨ï¼‰ï¼Œè¿˜æ˜¯ä¸šåŠ¡é€»è¾‘ä¸Šåšå¹‚ç­‰ï¼ˆçŠ¶æ€æœºã€ç‰ˆæœ¬æ ¡éªŒï¼‰ï¼Œéƒ½åº”è¯¥æ˜¯ä½¿ç”¨ä¸šåŠ¡æ„ä¹‰ä¸Šçš„å”¯ä¸€æ ‡è¯†ï¼Œè€Œä¸æ˜¯ä¾èµ– Message ID</p><p><strong>æ¶ˆæ¯é‡å¤çš„åœºæ™¯</strong></p><ul><li><strong>Producer ç«¯ï¼š</strong>å‘é€æ¶ˆæ¯æ—¶ï¼ŒBrocker å·²ç»æ”¶åˆ°æ¶ˆæ¯å¹¶æŒä¹…åŒ–ï¼Œä½† ACK ç”±äºç½‘ç»œåŸå› æœªæˆåŠŸè¿”å›ç»™ç”Ÿäº§è€…ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œç”Ÿäº§è€…ä¼šå†ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼›æˆ–è€…ä¸Šæ¸¸ä¸šåŠ¡è®¤ä¸ºå¤±è´¥é‡æ–°è¿›è¡Œäº†è°ƒç”¨ï¼Œå°±å¯èƒ½ä¼šå‘é€é‡å¤çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”æ˜¯ä¸åŒçš„ Message ID</li><li><strong>Brocker ç«¯ï¼š</strong>æŠ•é€’æ¶ˆæ¯ç»™æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…çš„ offset å› ä¸ºç½‘ç»œç­‰åŸå› æäº¤å¤±è´¥ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯è‡³å°‘ä¸€æ¬¡ï¼ŒBrocker ä¼šå†æ¬¡æŠ•é€’æ¶ˆæ¯</li><li><strong>Consumer ç«¯ï¼š</strong>æœåŠ¡æ‰©ç¼©å®¹å¯¼è‡´çš„ rebalance æ“ä½œï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯æ¶ˆè´¹è€…çš„ offset æ²¡æœ‰åŠæ—¶æäº¤</li></ul><p>å› ä¸ºä¸åŒçš„ Message ID å¯¹åº”çš„æ¶ˆæ¯å†…å®¹å¯èƒ½ç›¸åŒï¼Œæœ‰å¯èƒ½å‡ºç°å†²çªï¼ˆé‡å¤ï¼‰çš„æƒ…å†µï¼Œæ‰€ä»¥çœŸæ­£å®‰å…¨çš„å¹‚ç­‰å¤„ç†ï¼Œä¸å»ºè®®ä»¥ Message ID ä½œä¸ºå¤„ç†ä¾æ®</p><p>æœ€å¥½çš„æ–¹å¼æ˜¯ä»¥ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ä½œä¸ºå¹‚ç­‰å¤„ç†çš„å…³é”®ä¾æ®ï¼Œè€Œä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å¯ä»¥é€šè¿‡æ¶ˆæ¯ Key è®¾ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">consumer.subscribe(<span class="string">&quot;ons_test&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="keyword">new</span> <span class="title class_">MessageListener</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> message.getKey()</span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸šåŠ¡å”¯ä¸€æ ‡è¯†çš„ Key åšå¹‚ç­‰å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="è®¢é˜…å…³ç³»"><a href="#è®¢é˜…å…³ç³»" class="headerlink" title="è®¢é˜…å…³ç³»"></a>è®¢é˜…å…³ç³»</h1><p>è®¢é˜…å…³ç³»éœ€è¦ä¿æŒä¸€è‡´ï¼Œä¸€è‡´çš„å®šä¹‰æ˜¯ï¼š<strong>åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸‹æ‰€æœ‰ Consumer å®ä¾‹æ‰€è®¢é˜…çš„ Topicã€Tagã€Tag çš„é¡ºåºå¿…é¡»å®Œå…¨ä¸€è‡´</strong></p><p>å¦‚æœè®¢é˜…å…³ç³»ä¸ä¸€è‡´ï¼Œæ¶ˆæ¯æ¶ˆè´¹çš„é€»è¾‘å°±ä¼šæ··ä¹±ï¼Œç”šè‡³å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</p><p><strong>ä¸ºä»€ä¹ˆä¼šä¸¢å¤±ï¼Ÿ</strong></p><p>å½“ä¸€ä¸ª Consumer æ¶ˆè´¹ä¸€ä¸ª Queue æ—¶ï¼Œä¼šåœ¨ ConsumerQueue ä¸­ä¿å­˜è¯¥æ¶ˆè´¹è€…å’Œæ¶ˆæ¯çš„ç›¸å…³ä¿¡æ¯</p><p>ConsumerQueue ä¸­ä¿å­˜äº†å¦‚ä¸‹ä¿¡æ¯ï¼š</p><ul><li>å‰ 8 ä¸ªå­—èŠ‚è®°å½•æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„åç§»é‡</li><li>ä¸­é—´ 4 ä¸ªå­—èŠ‚è®°å½•æ¶ˆæ¯å¤§å°</li><li>æœ€å 8 ä¸ªå­—èŠ‚è®°å½•æ¶ˆæ¯ä¸­ tag çš„ hashcode</li></ul><p>å‡å¦‚ä¸€ä¸ª Consumer è®¢é˜…äº† Topic1 ä¸­çš„ Tag1ï¼Œé‚£è¿™ä¸ª Consumer æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œé¦–å…ˆä» Name Server è·å–è®¢é˜…å…³ç³»ï¼Œå¾—åˆ°å½“å‰ Consumer è®¢é˜…çš„æ‰€æœ‰ tag çš„ hashcode é›†åˆ codeSetï¼›æ¯æ¬¡ä» ConsumerQueue è·å–ä¸€æ¡è®°å½•ï¼Œå°±è¦åˆ¤æ–­æœ€å 8 ä¸ªå­—èŠ‚ tag hashcode æ˜¯å¦åœ¨ codeSet ä¸­ï¼Œæ¯”å¦‚ Tag2 ä¸åœ¨ codeSet ä¸­ï¼Œå°±ä¼šè¢«è¿‡æ»¤æ‰</p><p>æ‰€ä»¥ä¸æ­£ç¡®çš„è®¢é˜…å…³ç³»ä¼šå¯¼è‡´è¯¥ ConsumerQueue ä¸­çš„æ¶ˆæ¯è¢«é”™è¯¯ä¸¢å¼ƒäº†</p><h1 id="æ¶ˆæ¯å †ç§¯"><a href="#æ¶ˆæ¯å †ç§¯" class="headerlink" title="æ¶ˆæ¯å †ç§¯"></a>æ¶ˆæ¯å †ç§¯</h1><p>å½“å®¢æˆ·ç«¯æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸ŠæœåŠ¡ç«¯æ¶ˆæ¯å‘é€çš„é€Ÿåº¦ï¼Œä¾¿ä¼šå‡ºç°æ¶ˆæ¯å †ç§¯</p><p>æ¶ˆæ¯å †ç§¯çš„ä¸»è¦å½±å“ï¼š</p><ul><li>æ¶ˆè´¹å»¶è¿Ÿ</li><li>ç”Ÿäº§è€…æ— æ³•æˆåŠŸå‘é€æ¶ˆæ¯ï¼ˆæ— æ³•ç”Ÿäº§ï¼‰</li></ul><p>ä»¥ä¸‹åœºæ™¯éœ€è¦ç€é‡å…³æ³¨æ¶ˆæ¯å †ç§¯å’Œå»¶è¿Ÿé—®é¢˜ï¼š</p><ul><li>ä¸šåŠ¡ç³»ç»Ÿä¸Šä¸‹æ¸¸èƒ½åŠ›ä¸åŒ¹é…é€ æˆçš„æŒç»­å †ç§¯ï¼Œä¸”æ— æ³•è‡ªè¡Œæ¢å¤</li><li>ä¸šåŠ¡ç³»ç»Ÿå¯¹æ¶ˆæ¯çš„æ¶ˆè´¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼Œå³ä½¿æ˜¯çŸ­æš‚çš„å †ç§¯é€ æˆçš„æ¶ˆæ¯å»¶è¿Ÿä¹Ÿæ— æ³•æ¥å—</li></ul><p>å®¢æˆ·ç«¯ Push æ¨¡å¼åˆ°æ¶ˆè´¹æ¶ˆæ¯æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š</p><ul><li><strong>è·å–æ¶ˆæ¯ï¼š</strong>é€šè¿‡é•¿è½®è¯¢æ‰¹é‡æ‹‰å–çš„æ–¹å¼ä» Brocker æ‹‰å–æ¶ˆæ¯ï¼Œè¿™ä¸€é˜¶æ®µååé‡è¾ƒé«˜ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆ</li><li><strong>æ¶ˆè´¹ &amp; æäº¤ï¼š</strong>ä¾èµ–ä¸šåŠ¡çš„å¤„ç†è€—æ—¶å’Œæ¶ˆè´¹é€»è¾‘çš„å¹¶å‘åº¦</li></ul><p>æ‰€ä»¥é€šè¿‡æ¶ˆæ¯æ¶ˆè´¹çš„ä¸¤å¤§æ­¥éª¤æ¥çœ‹ï¼Œæ¶ˆæ¯å †ç§¯çš„ä¸»è¦é—®é¢˜å‡ºç°åœ¨ç¬¬äºŒé˜¶æ®µï¼Œå³<strong>æ¶ˆè´¹è€—æ—¶</strong>å’Œ<strong>æ¶ˆè´¹å¹¶å‘åº¦</strong>    </p><p><strong>æ¶ˆè´¹è€—æ—¶</strong></p><p>å½±å“æ¶ˆè´¹è€—æ—¶çš„æ¶ˆè´¹é€»è¾‘ä¸»è¦åˆ†ä¸º CPU å†…å­˜è®¡ç®—å’Œå¤–éƒ¨ IO æ“ä½œï¼›ç”±äºå¤§éƒ¨åˆ†æœåŠ¡å™¨åœºæ™¯éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œä¸šåŠ¡ä»£ç åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæ¶‰åŠå¤æ‚çš„è¿ç®—ï¼Œå†…éƒ¨è€—æ—¶ç›¸æ¯” IO è€—æ—¶æ¥è¯´å¯ä»¥å¿½ç•¥ä¸è®°</p><p>IO æ“ä½œé€šå¸¸åŒ…å«ä»¥ä¸‹é€»è¾‘ï¼š</p><ul><li>è¯»å†™å¤–éƒ¨æ•°æ®åº“ï¼Œä¾‹å¦‚ MySQL</li><li>è¯»å†™å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿï¼Œä¾‹å¦‚ Redis</li><li>ä¸‹æ¸¸ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚ Dubbo è°ƒç”¨æˆ–è€…ä¸‹æ¸¸ HTTP æ¥å£è°ƒç”¨</li></ul><p><strong>æ¶ˆè´¹å¹¶å‘åº¦</strong></p><p>ä¸åŒçš„æ¶ˆæ¯ç±»å‹å¯¹åº”ä¸åŒçš„å¹¶å‘åº¦é…ç½®ç­–ç•¥</p><table><thead><tr><th>æ¶ˆæ¯ç±»å‹</th><th>å¹¶å‘åº¦</th></tr></thead><tbody><tr><td>æ™®é€šæ¶ˆæ¯</td><td>å•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡</td></tr><tr><td>å®šæ—¶å’Œå»¶æ—¶æ¶ˆæ¯</td><td>å•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡</td></tr><tr><td>äº‹åŠ¡æ¶ˆæ¯</td><td>å•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡</td></tr><tr><td>é¡ºåºæ¶ˆæ¯</td><td>Minï¼ˆå•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡ï¼Œåˆ†åŒºæ•°ï¼‰</td></tr></tbody></table><p>æ­¤å¤–å•èŠ‚ç‚¹çš„å¹¶å‘åº¦éœ€è¦è°¨æ…è®¾ç½®ï¼Œä¸èƒ½ç›²ç›®ç›´æ¥è°ƒå¤§çº¿ç¨‹æ•°ï¼Œè®¾ç½®è¿‡å¤§çš„çº¿ç¨‹æ•°åè€Œä¼šå¸¦æ¥å¤§é‡çš„çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€</p><p>ç†æƒ³ç¯å¢ƒä¸‹å•èŠ‚ç‚¹çš„æœ€ä¼˜çº¿ç¨‹æ•°è®¡ç®—æ¨¡å‹å¦‚ä¸‹ï¼š</p><ul><li>å•æœº CPU æ ¸æ•°ä¸º C</li><li>çº¿ç¨‹åˆ‡æ¢è€—æ—¶å¿½ç•¥ä¸è®¡ï¼ŒIO æ“ä½œä¸æ¶ˆè€— CPU</li><li>çº¿ç¨‹æœ‰è¶³å¤Ÿæ¶ˆæ¯ç­‰å¾…å¤„ç†ï¼Œä¸”å†…å­˜å……è¶³</li><li>é€»è¾‘ä¸­ CPU è®¡ç®—è€—æ—¶ä¸º T1ï¼Œå¤–éƒ¨ IO æ“ä½œä¸º T2</li></ul><p>åˆ™å•ä¸ªçº¿ç¨‹èƒ½è¾¾åˆ°çš„ TPS ä¸º <code>1 / (T1 + T2)</code>ï¼Œå¦‚æœCPUä½¿ç”¨ç‡è¾¾åˆ°ç†æƒ³çŠ¶æ€ 100%ï¼Œé‚£ä¹ˆå•æœºè¾¾åˆ°æœ€å¤§èƒ½åŠ›æ—¶éœ€è¦è®¾ç½® <code>C Ã— (T1 + T2) / T1</code> ä¸ªçº¿ç¨‹</p><h1 id="è¯»å†™é˜Ÿåˆ—"><a href="#è¯»å†™é˜Ÿåˆ—" class="headerlink" title="è¯»å†™é˜Ÿåˆ—"></a>è¯»å†™é˜Ÿåˆ—</h1><p>æ–°å»º Topic éœ€è¦é…ç½®ç›¸å…³çš„å±æ€§ <code>writeQueueNums</code> å’Œ <code>readQueueNums</code>ï¼Œåˆ†åˆ«ä»£è¡¨å†™é˜Ÿåˆ—çš„æ•°é‡å’Œè¯»é˜Ÿåˆ—çš„æ•°é‡</p><p>å…¶ä¸­ <code>writeQueueNums</code> å’Œ <code>readQueueNums</code> çš„å‚æ•°å¯ä»¥è‡ªç”±é…ç½®ï¼Œ<strong>ä¸ºä»€ä¹ˆå¯ä»¥è‡ªç”±é…ç½®å‘¢è€Œä¸æ˜¯å¿…é¡»ç›¸ç­‰å‘¢ï¼Ÿ</strong></p><blockquote><p><strong>å¤‡æ³¨</strong>ï¼šè¯»å†™é˜Ÿåˆ—å’Œè¯»å†™åˆ†ç¦»ä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µ</p><p>è¯»å†™åˆ†ç¦»æŒ‡çš„æ˜¯ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å…³äºè¯»å†™è¯·æ±‚åˆ†é…çš„é—®é¢˜</p><p>è¯»å†™é˜Ÿåˆ—åœ¨åšè·¯ç”±ä¿¡æ¯æ—¶ä½¿ç”¨ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶ï¼Œä½¿ç”¨å†™é˜Ÿåˆ—ä¸ªæ•°è¿”å›è·¯ç”±ä¿¡æ¯ï¼Œè€Œæ¶ˆæ¯æ¶ˆè´¹æ—¶æŒ‰ç…§è¯»é˜Ÿåˆ—ä¸ªæ•°è¿”å›è·¯ç”±ä¿¡æ¯ï¼Œåœ¨ç‰©ç†æ–‡ä»¶å±‚é¢ï¼Œåªæœ‰å†™é˜Ÿåˆ—æ‰ä¼šåˆ›å»ºæ–‡ä»¶</p></blockquote><p><strong>è¯»å†™é˜Ÿåˆ—æ•°é‡ä¸åŒ¹é…æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ</strong></p><ul><li>å†™å¤šè¯»å°‘ï¼šå¤šå‡ºæ¥çš„å†™é˜Ÿåˆ—æ— æ³•è¢«æ¶ˆè´¹</li><li>è¯»å¤šå†™å°‘ï¼šConsumer å¯¹åº”çš„å¤šå‡ºæ¥çš„è¯»é˜Ÿåˆ—æ²¡æœ‰æ¶ˆæ¯ï¼Œä¹Ÿå°±ä¸ä¼šä»è¯¥è¯»é˜Ÿåˆ—æ¶ˆè´¹ä»»ä½•æ¶ˆæ¯</li></ul><p><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡</strong></p><p>è®¾ç½®è¯»å†™é˜Ÿåˆ—æ•°çš„ç›®çš„åœ¨äºæ–¹ä¾¿é˜Ÿåˆ—çš„ç¼©å®¹å’Œæ‰©å®¹</p><p>ä¸€ä¸ª Topic åœ¨æ¯ä¸ª Brocker ä¸Šåˆ›å»ºäº† 128 ä¸ªé˜Ÿåˆ—ï¼Œç°åœ¨éœ€è¦å°†é˜Ÿåˆ—ç¼©å®¹åˆ° 64 ä¸ªï¼Œæ€ä¹ˆåšæ‰èƒ½ 100% ä¸ä¼šä¸¢å¤±æ¶ˆæ¯ï¼Œå¹¶ä¸”æ— éœ€é‡å¯åº”ç”¨ç¨‹åº</p><p>è§£å†³åŠæ³•ï¼š</p><ol><li>å…ˆå°†å†™é˜Ÿåˆ—ç¼©å®¹ï¼ˆ128 è°ƒæ•´ä¸º 64ï¼‰ï¼›åç»­æ•°æ®è¯·æ±‚ä¼šè¿›å…¥ 0 è‡³ 63 çš„å†™é˜Ÿåˆ—ä¸­ï¼Œç”±ä¹‹å‰çš„ Consumer è¿›è¡Œæ¶ˆè´¹</li><li>ç­‰å¾… 64 è‡³ 127 é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¢«æ¶ˆè´¹å®Œæˆ</li><li>ç¼©å®¹è¯»é˜Ÿåˆ—ï¼ˆ128 è°ƒæ•´ä¸º 64ï¼‰ï¼›æ­¤æ—¶ Consumer é‡æ–°åˆ†é…ï¼Œå¯¹åº” 64 ä¸ªå†™é˜Ÿåˆ—</li></ol><p><strong>åŒæ—¶ç¼©å®¹å†™é˜Ÿåˆ—å’Œè¯»é˜Ÿåˆ—å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†æ¶ˆæ¯æœªè¢«æ¶ˆè´¹</strong></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://help.aliyun.com/document_detail/69109.html">æœ€ä½³å®è·µ (aliyun.com)</a></p><p><a href="https://www.cnblogs.com/liaowenhui/p/15717353.html">RocketMQè®¢é˜…å…³ç³»ä¸ä¸€è‡´ - JustJavaIt - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/qian_348840260/article/details/108975241">rocketmqä¸­çš„è¯»å†™é˜Ÿåˆ—_å…«è’å…­åˆå”¯æˆ‘ç‹¬å°Š-CSDNåšå®¢_rocketmqè¯»å†™é˜Ÿåˆ—</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> MQ </category>
          
          <category> RocketMQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES cardinality å’Œ HyperLogLog</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20cardinality%20%E5%92%8C%20HyperLogLog.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20cardinality%20%E5%92%8C%20HyperLogLog.html</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºæ•°èšåˆ"><a href="#åŸºæ•°èšåˆ" class="headerlink" title="åŸºæ•°èšåˆ"></a>åŸºæ•°èšåˆ</h1><p>åŸºæ•°èšåˆå±äºèšåˆä¸­çš„åº¦é‡èšåˆï¼Œè®¡ç®—ä¸åŒå€¼çš„<strong>è¿‘ä¼¼è®¡æ•°</strong></p><p>éœ€è¦æ³¨æ„ï¼Œèšåˆå‡ºçš„ç»“æœæ˜¯ä¸€ä¸ªè¿‘ä¼¼å€¼ï¼ŒåŸå› æ˜¯åº•å±‚ç»“æ„ä½¿ç”¨çš„ HyperLogLogï¼Œå…·æœ‰ä¸€å®šè¯¯å·®</p><h2 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h2><p>å‡å®š index å­˜å‚¨çš„å”®å–æ•°æ®ï¼Œå¸Œæœ›æŸ¥è¯¢æœ‰å¤šå°‘ç§ä¸åŒçš„å•†å“ç±»å‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=<span class="number">0</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¹‹å‰çš„å­¦ç”Ÿ index ä¸ºä¾‹ï¼ŒæŸ¥è¯¢æœ‰å‡ ä¸ªç­çº§ä¸‹æœ‰å¥³å­¦ç”Ÿ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;female&quot;</span> <span class="comment">// ç»“æœé›†æŸ¥è¯¢æ€§åˆ«ä¸ºå¥³æ€§</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="comment">// ä¸å…³æ³¨ hits ç»“æœé›†</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;class_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœï¼Œé€‰å– <code>hits</code> å’Œ <code>aggregations</code> éƒ¨åˆ†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;class_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å› ä¸º <code>size</code> ä¸º 0ï¼Œæ‰€ä»¥ <code>hits</code> ä¸­æ²¡æœ‰è¿”å›çš„æ–‡æ¡£</p><p><code>aggregations</code> ä¸‹è‡ªå®šä¹‰ç»“æœé›†åç§° <code>class_count</code> è¿”å›çš„å€¼ä¸º 2ï¼Œè¯´æ˜ç­çº§ä¸‹æœ‰å¥³å­¦ç”Ÿçš„ç­çº§æ•°é‡ä¸º 2</p><h2 id="è¿‘ä¼¼å€¼ä¸ç²¾ç¡®é˜ˆå€¼å‚æ•°"><a href="#è¿‘ä¼¼å€¼ä¸ç²¾ç¡®é˜ˆå€¼å‚æ•°" class="headerlink" title="è¿‘ä¼¼å€¼ä¸ç²¾ç¡®é˜ˆå€¼å‚æ•°"></a>è¿‘ä¼¼å€¼ä¸ç²¾ç¡®é˜ˆå€¼å‚æ•°</h2><p>ç”±äºè¿”å›ç»“æœæ˜¯ä¸€ä¸ªè¿‘ä¼¼å€¼ï¼Œæ‰€ä»¥ <code>cardinality</code> æ”¯æŒ <code>precision_threshold</code> å‚æ•°ï¼Œç”¨æ¥è®¾ç½®ç²¾ç¡®é˜ˆå€¼</p><p>é˜ˆå€¼å‚æ•°çš„æœ¬è´¨æ˜¯ä½¿ç”¨ç©ºé—´æ¢å–å‡†ç¡®æ€§ï¼Œé»˜è®¤æ˜¯ 3000ï¼Œæœ€å¤§æ”¯æŒ 40000ï¼Œè¶…è¿‡ 40000 çš„è®¾ç½®ä¸ºæŒ‰ç…§ 40000 æ¥å¤„ç†</p><p>ä½äºé˜ˆå€¼çš„è®¡æ•°æ›´ç¬¦åˆå‡†ç¡®å€¼ï¼Œé«˜äºé˜ˆå€¼çš„è®¡æ•°åˆ™ä¼šæ›´åŠ æ¨¡ç³Š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;female&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;class_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;precision_threshold&quot;</span><span class="punctuation">:</span> <span class="number">200000</span> <span class="comment">// ç²¾åº¦é˜ˆå€¼ï¼Œäº‹å®ä¸Šå†…éƒ¨å°†è¯¥å‚æ•°è§†ä¸º 40000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è®¡ç®—ç²¾ç¡®çš„è®¡æ•°éœ€è¦å°†å€¼åŠ è½½è‡³å“ˆå¸Œé›†åˆå¹¶è¿”å›å¤§å°ï¼Œå½“åŸºæ•°ç‰¹åˆ«å¤§æ—¶ï¼Œéœ€è¦å ç”¨éå¸¸å¤šèµ„æº</p><p>æ‰€ä»¥ ES é€‰æ‹© HyperLogLog ç®—æ³•æ¥å®ç° <code>cardinality</code>ï¼Œè¿™ç§æ–¹å¼åŸºäºå€¼çš„å“ˆå¸Œè®¡æ•°ï¼Œæœ‰ä¸€äº›ç‰¹æ€§ï¼š</p><ul><li>å¯é…ç½®çš„ç²¾åº¦ï¼Œå¯ä»¥é€‰æ‹©ç”¨å†…å­˜æ¢å–ç²¾åº¦</li><li>ä½åŸºæ•°é›†åˆä¸­æ˜¯ç²¾å‡†çš„</li><li>å›ºå®šçš„å†…å­˜ä½¿ç”¨ç‡ï¼Œæ— è®ºå”¯ä¸€å€¼æœ‰å¤šå°‘ï¼Œåªå–å†³äºè®¾ç½®çš„ç²¾åº¦</li></ul><p>HyperLogLog + + ç®—æ³•ä¾èµ–äºæ•£åˆ—å€¼çš„å‰å¯¼é›¶ï¼Œæ•°æ®é›†ä¸­æ•£åˆ—çš„ç²¾ç¡®åˆ†å¸ƒä¼šå½±å“åŸºæ•°çš„å‡†ç¡®æ€§</p><p>ES å®˜æ–¹æ–‡æ¡£æä¾›çš„æ•°æ®æ˜¾ç¤ºï¼Œå…·ä½“çš„å‡†ç¡®æ€§å–å†³äºæ•°æ®é›†æƒ…å†µï¼Œä½†å¤§éƒ¨åˆ†åœºæ™¯çš„å‡†ç¡®æ€§éƒ½è¿˜æ˜¯è‰¯å¥½çš„ï¼Œ<strong>å³ä½¿é˜ˆå€¼è®¾ç½®ä¸º 100ï¼Œåœ¨ç™¾ä¸‡ã€åƒä¸‡åŸºæ•°ä¸‹ï¼Œè¯¯å·®èŒƒå›´ä¹Ÿæ§åˆ¶åœ¨äº† 1% ~ 6%ï¼›å½“é˜ˆå€¼è®¾ç½®ä¸º 10000ï¼Œè¯¯å·®åŸºæœ¬åœ¨ 1% å·¦å³</strong></p><h2 id="è„šæœ¬-runtime-field"><a href="#è„šæœ¬-runtime-field" class="headerlink" title="è„šæœ¬ runtime field"></a>è„šæœ¬ runtime field</h2><p><code>cardinality</code> åƒå…¶ä»–èšåˆæ“ä½œä¸€æ ·ï¼Œæ˜¯å¯ä»¥ä½¿ç”¨è„šæœ¬æ‹¼æ¥å­—æ®µçš„</p><p>å¦‚æœå¸Œæœ›å¯¹ä¸¤ä¸ªå­—æ®µçš„ç»„åˆè¿›è¡Œæ“ä½œï¼Œåˆ›å»ºä¸€ä¸ª runtime field ç»„åˆä»–ä»¬ç„¶åè¿›è¡ŒåŸºæ•°èšåˆ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;runtime_mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender_and_age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="string">&quot;emit(doc[&#x27;gender&#x27;].value + &#x27;&amp;&#x27; + doc[&#x27;age&#x27;].value)&quot;</span> <span class="comment">// æ‹¼æ¥ gender å’Œ age å­—æ®µ</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type_promoted_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gender_and_age&quot;</span> <span class="comment">// æ ¹æ® runtime field è¿›è¡ŒåŸºæ•°æ“ä½œ</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœæ˜¯ 6ï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªæ–‡æ¡£çš„ runtime field <code>gender_and_age</code> å€¼éƒ½ä¸º <code>male&amp;20</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type_promoted_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h1><p>HyperLogLog æ˜¯ä¸€ç§åŸºæ•°è®¡æ•°çš„ç®—æ³•ï¼Œæ—¨åœ¨ä½¿ç”¨è¾ƒå°‘å†…å­˜çš„æƒ…å†µä¸‹å¾—åˆ°åŸºæ•°æ•°é‡çš„è¿‘ä¼¼ç²¾ç¡®å€¼</p><h2 id="åŸºæ•°è®¡æ•°æ–¹å¼"><a href="#åŸºæ•°è®¡æ•°æ–¹å¼" class="headerlink" title="åŸºæ•°è®¡æ•°æ–¹å¼"></a>åŸºæ•°è®¡æ•°æ–¹å¼</h2><p>åŸºæ•°è®¡æ•°ï¼ˆcardinality countingï¼‰é€šå¸¸ç”¨æ¥ç»Ÿè®¡ä¸€ä¸ªé›†åˆä¸­ä¸é‡å¤çš„å…ƒç´ ä¸ªæ•°ï¼Œä¾‹å¦‚ç»Ÿè®¡æŸä¸ªç½‘ç«™çš„ UVï¼Œæˆ–è€…ç”¨æˆ·æœç´¢ç½‘ç«™çš„å…³é”®è¯æ•°é‡ç­‰</p><p>å¦‚ä½•è®¡ç®—è®¡æ•°å¸¸è§çš„æœ‰å¤šç§æ–¹å¼</p><ul><li>B æ ‘<ul><li>åˆ©ç”¨æ ‘å­˜å‚¨å…·ä½“å…ƒç´ </li><li>ä¼˜ç‚¹ï¼šæ’å…¥å’ŒæŸ¥æ‰¾æ•ˆç‡é«˜ï¼Œç»Ÿè®¡æ•°æ®æ—¶å¯ä»¥å¿«é€Ÿåšåˆ°è®°å½•ä¸å»é‡ï¼Œè®¡ç®—åŸºæ•°æ—¶åªéœ€è¦ç»Ÿè®¡å¶å­èŠ‚ç‚¹ä¸ªæ•°å³å¯</li><li>ç¼ºç‚¹ï¼šæ²¡æœ‰èŠ‚çœå†…å­˜ï¼Œéœ€è¦å­˜å‚¨æ•°æ®å…¨é›†</li></ul></li><li>bitmap<ul><li>ä½¿ç”¨ bit ä½è¿›è¡Œæ ‡è®°ï¼Œå³æŠ›å¼ƒå…·ä½“å…ƒç´ å†…å®¹åªå­˜å‚¨ç‰¹å¾å€¼</li><li>ä¼˜ç‚¹ï¼šèŠ‚çº¦å†…å­˜ï¼Œç»“æœå¯ä»¥è¿›è¡Œæ–¹ä¾¿çš„ä½è¿ç®—æ“ä½œï¼ˆåˆå¹¶ - ä¸ï¼Œå·®é›† - æˆ–ï¼‰</li><li>ç¼ºç‚¹ï¼šç©ºé—´å ç”¨ä»ç„¶è¾ƒå¤§</li></ul></li><li>æ¦‚ç‡ç®—æ³•<ul><li>ç›®å‰ç”¨äºåŸºæ•°è®¡æ•°çš„æ¦‚ç‡ç®—æ³•æœ‰ï¼šLCã€LLCã€HLL ç­‰</li><li>ä¼˜ç‚¹ï¼šLLã€HLL ç­‰èƒ½å¤Ÿåœ¨ç©ºé—´æ›´å°çš„æƒ…å†µä¸‹è¿›è¡ŒåŸºæ•°è®¡ç®—</li><li>ç¼ºç‚¹ï¼šæœ‰ä¸€å®šè¯¯å·®</li></ul></li></ul><h2 id="HLL"><a href="#HLL" class="headerlink" title="HLL"></a>HLL</h2><p>HLL ä¸­å®é™…å­˜å‚¨çš„æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º m çš„å¤§æ•°ç»„ Sï¼Œå°†å¾…ç»Ÿè®¡çš„æ•°æ®é›†åˆåˆ’åˆ†æˆ m ç»„ï¼Œæ¯ç»„æ ¹æ®ç®—æ³•è®°å½•ä¸€ä¸ªç»Ÿè®¡å€¼å­˜å…¥æ•°ç»„ä¸­</p><p>æ•°ç»„çš„å¤§å° m ç”±ç®—æ³•å®ç°æ–¹è‡ªå·±ç¡®å®šï¼ŒRedis ä¸­è¿™ä¸ªæ•°ç»„çš„å¤§å°æ˜¯ 16834ï¼Œm è¶Šå¤§è¯¯å·®è¶Šå°ï¼Œä½†éœ€è¦çš„å†…å­˜ç©ºé—´ä¹Ÿè¶Šå¤§</p><p>HLL çš„æ•°å­¦åŸç†çœ‹ä¸æ‡‚ï¼Œå¤§è‡´å°±æ˜¯ n é‡ä¼¯åŠªåˆ©åŸç†</p><p>é€šè¿‡å¤šæ¬¡æŠ›ç¡¬å¸ï¼Œç›´åˆ°æŠ›åˆ°æ­£é¢ä¸ºæ­¢ï¼Œè¿™æ˜¯ä¸€æ¬¡ä¼¯åŠªåˆ©è¿‡ç¨‹ï¼›å½“ä¸€ç›´æŠ›ç¡¬å¸ï¼Œç›´åˆ°å¤šæ¬¡å‡ºç°æ­£é¢ï¼Œå°†å‡ºç°æ­£é¢çš„æŠ•æ·æ¬¡æ•°å€¼è®°ä¸º k1ã€k2ã€k3â€¦knï¼Œæœ€å¤§å€¼è®°ä¸º kmaxï¼Œé‚£ä¹ˆå¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š</p><ul><li>n æ¬¡ä¼¯åŠªåˆ©è¿‡ç¨‹çš„æŠ•æ·æ¬¡æ•°éƒ½ä¸å¤§äº kmax</li><li>n æ¬¡ä¼¯åŠªåˆ©è¿‡ç¨‹ï¼Œè‡³å°‘æœ‰ä¸€æ¬¡æŠ•æ·æ¬¡æ•°ç­‰äº kmax</li></ul><p>æœ€åç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„æ¨è®ºï¼Œæœ€ç»ˆçš„ç»“æœå°±æ˜¯ï¼š<strong>è¿›è¡Œäº† n æ¬¡è¿›è¡ŒæŠ›ç¡¬å¸å®éªŒï¼Œæ¯æ¬¡åˆ†åˆ«è®°å½•ä¸‹ç¬¬ä¸€æ¬¡æŠ›åˆ°æ­£é¢çš„æŠ›æ·æ¬¡æ•° kï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ n æ¬¡å®éªŒä¸­æœ€å¤§çš„æŠ›æ·æ¬¡æ•° kmax æ¥é¢„ä¼°å®éªŒç»„æ•°é‡ n</strong>ï¼›è¿™å°±æ˜¯ HLL ç®—æ³•çš„æ•°å­¦ç†è®ºåŸºç¡€</p><p>æ­¤å¤– HLL ä¸ºäº†æé«˜å‡†ç¡®æ€§ä¹Ÿåšäº†å…¶ä»–ä¼˜åŒ–</p><p><strong>åˆ†æ¡¶å¹³å‡</strong></p><p>HLL çš„åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨é›†åˆä¸­æ•°å­—çš„æ¯”ç‰¹ä¸²ç¬¬ä¸€ä¸ª1å‡ºç°ä½ç½®çš„æœ€å¤§å€¼æ¥é¢„ä¼°æ•´ä½“åŸºæ•°ï¼Œä½†æ˜¯è¿™ç§é¢„ä¼°æ–¹æ³•å­˜åœ¨è¾ƒå¤§è¯¯å·®ï¼Œä¸ºäº†æ”¹å–„è¯¯å·®æƒ…å†µï¼ŒHLL ä¸­å¼•å…¥åˆ†æ¡¶å¹³å‡çš„æ¦‚å¿µ</p><p>ä¸ºäº†é¿å…ä¸€ç»„å®éªŒä¸­çš„è¿æ°”å½±å“ï¼Œå°†ç»Ÿè®¡æ•°æ®åˆ’åˆ†å¤šä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶å„è‡ªç»Ÿè®¡è‡ªå·±çš„ kmax è®¡ç®—åŸºæ•°é¢„ä¼°å€¼ï¼Œæœ€ç»ˆå¯¹å„ä¸ªæ¡¶çš„åŸºæ•°é¢„ä¼°å€¼è¿›è¡Œåˆå¹¶ï¼Œä½¿ç”¨è°ƒå’Œå¹³å‡æ•°çš„æ–¹å¼è¿›ä¸€æ­¥é™ä½è¯¯å·®</p><p><strong>åå·®ä¿®æ­£</strong></p><p>è™½ç„¶è°ƒå’Œå¹³å‡æ•°èƒ½å¤Ÿé€‚å½“ä¿®æ­£ç®—æ³•è¯¯å·®ï¼Œä½†ä½œè€…ç»™å‡ºä¸€ç§åˆ†é˜¶æ®µä¿®æ­£ç®—æ³•</p><p>å½“ HLL ç®—æ³•å¼€å§‹ç»Ÿè®¡æ•°æ®æ—¶ï¼Œç»Ÿè®¡æ•°ç»„ä¸­å¤§éƒ¨åˆ†ä½ç½®éƒ½æ˜¯ç©ºæ•°æ®ï¼Œå¹¶ä¸”éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½å¡«æ»¡æ•°ç»„ï¼Œè¿™ç§é˜¶æ®µå¼•å…¥ä¸€ç§å°èŒƒå›´ä¿®æ­£æ–¹æ³•ï¼›å½“ HLL ç®—æ³•ä¸­ç»Ÿè®¡æ•°ç»„å·²æ»¡çš„æ—¶å€™ï¼Œéœ€è¦ç»Ÿè®¡çš„æ•°æ®åŸºæ•°å¾ˆå¤§ï¼Œè¿™æ—¶å€™ hash ç©ºé—´ä¼šå‡ºç°å¾ˆå¤šç¢°æ’æƒ…å†µï¼Œè¿™ç§é˜¶æ®µå¼•å…¥ä¸€ç§å¤§èŒƒå›´ä¿®æ­£æ–¹æ³•</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/search-aggregations-metrics-cardinality-aggregation.html#search-aggregations-metrics-cardinality-aggregation">Cardinality aggregation | Elasticsearch Guide 8.5 </a></p><p><a href="https://juejin.cn/post/7067816471128342564">ç¥å¥‡çš„HyperLogLogç®—æ³•ã€è½¬è½½ #æ¶‰åŠåˆ°æ•°å­¦åŸç†ã€‘ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="http://content.research.neustar.biz/blog/hll.html">Sketch of the Day: HyperLogLog â€” Cornerstone of a Big Data Infrastructure â€“ AK Tech Blog (neustar.biz)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
            <tag> ES ç¢ç‰‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES æŠ˜å æ“ä½œ</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20%E6%8A%98%E5%8F%A0%E5%92%8C%E8%81%9A%E5%90%88.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20%E6%8A%98%E5%8F%A0%E5%92%8C%E8%81%9A%E5%90%88.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><h2 id="æŠ˜å å’Œèšåˆ"><a href="#æŠ˜å å’Œèšåˆ" class="headerlink" title="æŠ˜å å’Œèšåˆ"></a>æŠ˜å å’Œèšåˆ</h2><p>æ—¥å¸¸ä¼šæœ‰å¾ˆå¤šåœºæ™¯å¸Œæœ›å°†å¹³é¢æ•°æ®æŒ‰ç…§ä¸€å®šçš„æ¡ä»¶ç»„åˆèµ·æ¥ï¼Œå¹¶æŒ‰ç…§ä¸€å®šè§„åˆ™è¿›è¡Œè®¡ç®—</p><p>èšåˆå°†æ‚¨çš„æ•°æ®æ±‡æ€»ä¸ºæŒ‡æ ‡ã€ç»Ÿè®¡æˆ–å…¶ä»–åˆ†æ</p><p>å¯ä»¥å¸®åŠ©ä½ å›ç­”ç±»ä¼¼å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>æˆ‘çš„ç½‘é¡µå¹³å‡åŠ è½½æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ ¹æ®äº¤æ˜“é‡è°æ˜¯æˆ‘æœ€æœ‰ä»·å€¼çš„å®¢æˆ·ï¼Ÿ</li><li>åœ¨æˆ‘çš„ç½‘ç«™ä¸Šå¤§æ–‡ä»¶çš„è¡¡é‡æ ‡å‡†æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ¯ä¸ªäº§å“ç±»åˆ«æœ‰å¤šå°‘ç§äº§å“ï¼Ÿ</li></ul><p>åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œèšåˆä»¥ <code>GROUP BY</code> å…³é”®å­—å’Œèšåˆå‡½æ•°çš„æ–¹å¼è¿›è¡Œå®ç°</p><p>ä¾‹å¦‚ç»Ÿè®¡æ¯ä¸ªç­çº§ä¸‹ç”·ç”Ÿçš„äººæ•°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> `classId`,<span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> <span class="string">&#x27;number&#x27;</span> <span class="keyword">FROM</span> `student` <span class="keyword">WHERE</span> `gender` <span class="operator">=</span> &quot;male&quot; <span class="keyword">GROUP</span> <span class="keyword">BY</span> `classId`;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ç­çº§å³ <code>classId</code> å­—æ®µè¿›è¡Œèšåˆï¼Œä½¿ç”¨ <code>COUNT()</code> èšåˆå‡½æ•°æ¥ç»Ÿè®¡æ•°é‡</p><h2 id="æ¨¡æ‹Ÿ"><a href="#æ¨¡æ‹Ÿ" class="headerlink" title="æ¨¡æ‹Ÿ"></a>æ¨¡æ‹Ÿ</h2><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯æ¥ä½¿ç”¨ ES å®ç°éœ€æ±‚ï¼Œè®¾ç½®è¿™æ ·ä¸€ä¸ªç´¢å¼•</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT /student-index/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿæ•°æ®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /student-index/_doc</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å¼ ä¸‰&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">70</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;æå››&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">19</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">72.5</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;ç‹äº”&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">80</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">21</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">75</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å°çº¢&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">19</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;female&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">50</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å°å…°&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;female&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">51</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;è›‹è›‹&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">90</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="æŠ˜å "><a href="#æŠ˜å " class="headerlink" title="æŠ˜å "></a>æŠ˜å </h1><p>åœ¨ ES é™¤äº†èšåˆ <code>aggregations</code> å¤–ï¼Œæœ‰ä¸€ç§ç±»ä¼¼èšåˆçš„æ“ä½œ <code>collapse</code> æŠ˜å </p><blockquote><p>ä½ å¯ä»¥ä½¿ç”¨ collapse å‚æ•°æ¥åŸºäºå­—æ®µå€¼æŸ¥è¯¢ç»“æœï¼›æ¯ä¸ªæŠ˜å ä»…é€‰æ‹©æ’åºé å‰çš„æ–‡æ¡£æ¥å®ŒæˆæŠ˜å </p></blockquote><p>è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºæŠ˜å å’Œèšåˆè¿˜æ˜¯æœ‰ä½¿ç”¨ä¸Šçš„åŒºåˆ«çš„ï¼Œèšåˆæ›´å…³æ³¨çš„æ˜¯èšåˆåçš„ç»“æœï¼Œè€ŒæŠ˜å æ˜¯åœ¨åŸç»“æœé›†åŸºç¡€ä¸Šå°†å­—æ®µå»é‡ï¼Œå¹¶ä¸”å¯ä»¥åƒåˆ†é¡µä¸€æ ·å¯¹æŠ˜å ç»“æœè¿›è¡Œåˆ†é¡µ</p><p>ä¾‹å¦‚è¿™æ ·ä¸€ç»„æ•°æ®</p><table><thead><tr><th align="center">name</th><th align="center">class</th><th align="center">time</th></tr></thead><tbody><tr><td align="center">å¼ ä¸‰</td><td align="center">1</td><td align="center">1</td></tr><tr><td align="center">æå››</td><td align="center">2</td><td align="center">2</td></tr><tr><td align="center">ç‹äº”</td><td align="center">1</td><td align="center">3</td></tr></tbody></table><p>æ ¹æ® <code>time</code> å€’åºï¼ŒæŒ‰ç…§ <code>class</code> è¿›è¡ŒæŠ˜å ï¼Œ<code>size</code> ä¸º 1ï¼Œè¿”å›çš„ç»“æœåº”è¯¥æ˜¯ <code>class = 1</code> çš„æ•°æ®ï¼Œå› ä¸ºå‘½ä¸­äº† <code>name = &quot;ç‹äº”&quot;</code> çš„æ–‡æ¡£</p><p>å½“ <code>from</code> ä¸º 1 æ—¶ï¼Œè¿”å› <code>class = 2</code>ï¼Œæ­¤æ—¶æ‰€æœ‰æŠ˜å åçš„æ•°æ®éƒ½å·²ç»æŸ¥è¯¢å®Œæˆ</p><p>æŠ˜å æ›´åƒæ˜¯å¯¹äºæŸ¥è¯¢çš„ä¸€ç§ç‰¹æ®Šæ“ä½œï¼Œå…¶å‚æ•°ä½¿ç”¨ä¹Ÿå’Œ <code>query</code> åœ¨åŒä¸€å±‚çº§ï¼Œè¿”å›ä½“ä¸­ä¹Ÿæ˜¯åœ¨ <code>hits</code> ä¸­è¿”å›æ–‡æ¡£</p><h2 id="æŠ˜å æŸ¥è¯¢"><a href="#æŠ˜å æŸ¥è¯¢" class="headerlink" title="æŠ˜å æŸ¥è¯¢"></a>æŠ˜å æŸ¥è¯¢</h2><p>å¯¹äºæ¨¡æ‹Ÿçš„æ•°æ®ï¼Œå¯¹ <code>class</code> å­—æ®µæŠ˜å ï¼Œç­çº§çš„é¡ºåºæŒ‰ç…§ç”·ç”Ÿçš„å¹´é¾„æ’åºï¼Œå–ç¬¬äºŒå</p><p>å³å…¨æ ¡å¹´é¾„ç¬¬äºŒå¤§çš„ç”·æ€§å­¦ç”Ÿæ‰€åœ¨çš„ç­çº§</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /student-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="comment">// ä¸æŸ¥è¯¢ç¬¬ä¸€æ¡</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›çš„ç»“æœï¼Œåªå– hits éƒ¨åˆ†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student-index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k-mmzoQBCTaFCHoW7hai&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">75</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">2</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">21</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>_source</code> ç»“æœé€‰å–äº†æŠ˜å æ‰€å‘½ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡æ¡£ï¼ˆæŠ˜å çš„ä¾æ®ï¼‰ï¼›<code>fields</code> åˆ™æ˜¯æŠ˜å çš„å­—æ®µï¼Œè¯´æ˜å¹´é¾„ç¬¬äºŒå¤§çš„ç”·ç”Ÿæ‰€åœ¨çš„ç­çº§æ˜¯ 2 ç­</p><h2 id="æ‰©å±•ç»“æœ"><a href="#æ‰©å±•ç»“æœ" class="headerlink" title="æ‰©å±•ç»“æœ"></a>æ‰©å±•ç»“æœ</h2><p>ä¸Šé¢æŠ˜å çš„ç®€å•æ“ä½œå¯ä»¥çœ‹åˆ°ï¼Œè¿”å›çš„ hits ä¸­åŒ…å«äº†ä¸€ä¸ªæŠ˜å ä¾æ®çš„æ–‡æ¡£ï¼ˆæ’åºæ¡ä»¶çš„ç¬¬ä¸€ä¸ªæ–‡æ¡£ï¼‰</p><p>å¦‚æœéœ€è¦è¿”å›æŠ˜å å­—æ®µä¸‹çš„æ‰€æœ‰æ–‡æ¡£ï¼ˆæˆ‘è®¤ä¸ºæ›´åƒæ˜¯åˆ†ç»„æ“ä½œï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>inner_hit</code> å‚æ•°å®ç°</p><p>å–å…¨æ ¡å¹´é¾„ç¬¬äºŒå¤§çš„ç”·æ€§å­¦ç”Ÿæ‰€åœ¨çš„ç­çº§ä¸‹é¢çš„æ‰€æœ‰å­¦ç”Ÿï¼Œä¸”æŒ‰ç…§èº«é«˜æ­£åºæ’åˆ—</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">POST /student-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student_in_class&quot;</span><span class="punctuation">,</span> <span class="comment">// è‡ªå®šçš„ç»“æœé›†åå­—</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span> <span class="comment">// inner_hits å†…æ–‡æ¡£æ•°é‡</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// è¿™ä¸ªæ’åºå‚æ•°æ˜¯ inner hitï¼Œå†…éƒ¨æ–‡æ¡£çš„æ’åº</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// è¿™ä¸ªæ’åºå‚æ•°æ˜¯æŸ¥è¯¢æ¡ä»¶çš„æ’åº</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœå‰åŠéƒ¨åˆ†å’ŒæŠ˜å æŸ¥è¯¢ä¸€æ ·ï¼Œåªå– <code>inner_hit</code> å­—æ®µä¸‹çš„ç»“æœé›†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;student_in_class&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student-index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kemmzoQBCTaFCHoWyxaJ&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æå››&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">72.5</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="number">72.5</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student-index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k-mmzoQBCTaFCHoW7hai&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">75</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="number">75</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>inner_hits</code> ä¸‹æ˜¯ <code>student_in_class</code> è‡ªå®šçš„ç»“æœé›†åç§°ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸€æ¬¡ <code>inner_hits</code> å¯ä»¥è®¾ç½®å¤šä¸ªä¸åŒè§„åˆ™çš„ç»“æœé›†è¯·æ±‚ï¼ˆ<code>inner_hits</code> å‚æ•°æ˜¯ä¸ªæ•°ç»„ï¼‰</p><p>è¿”å›çš„ç»“æœä¸­åŒ…å«äº† 2 ç­ä¸‹çš„ä¸¤åå­¦ç”Ÿï¼Œå¹¶ä¸”æ ¹æ® <code>height</code> å­—æ®µè¿›è¡Œäº†æ’åº</p><h2 id="search-after"><a href="#search-after" class="headerlink" title="search after"></a>search after</h2><p>æŠ˜å æ“ä½œåŒæ ·æ”¯æŒ search after æ“ä½œ</p><p>å› ä¸ºæœ¬è´¨ä¸Š ES ä¹Ÿæ˜¯æ’åºåæ ¹æ®æ–‡æ¡£é¡ºåºå¯¹æŠ˜å å­—æ®µè¿›è¡Œæ“ä½œï¼Œå½“ search after å­—æ®µç•¥è¿‡è¯¥å€¼åï¼Œç»§ç»­å¯¹æœªæŠ˜å å­—æ®µå€¼è¿›è¡ŒæŠ˜å æ“ä½œ</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œ<strong>åªæœ‰å½“æŠ˜å å­—æ®µå’Œæ’åºå­—æ®µæ˜¯åŒä¸€å­—æ®µæ—¶æ‰èƒ½ä½¿ç”¨è¯¥æ–¹å¼ï¼ŒåŒæ—¶ä¸å…è®¸äºŒçº§æ’åº</strong></p><p>è¯­æ³•å’ŒåŸºæœ¬æŸ¥è¯¢ä¸€è‡´</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET /search&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user.id&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;user.id&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;search_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;dd5ce1ad&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="äºŒçº§æŠ˜å "><a href="#äºŒçº§æŠ˜å " class="headerlink" title="äºŒçº§æŠ˜å "></a>äºŒçº§æŠ˜å </h2><p>å¯¹æŸä¸€ä¸ªå­—æ®µæŠ˜å åï¼Œ<code>inner_hits</code> å†…è¿˜å¯ä»¥å¯¹å…¶ä»–å­—æ®µå†è¿›è¡Œä¸€æ¬¡æŠ˜å </p><p>ä½†äºŒæ¬¡æŠ˜å æ— æ³•ä½¿ç”¨ <code>inner_hits</code> å‚æ•°ï¼Œå³æŠ˜å åªèƒ½æ”¯æŒåˆ°äºŒçº§</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student_in_class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;height&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ ¹æ® <code>class</code> æŠ˜å åçš„å†…éƒ¨æ–‡æ¡£ï¼Œå†æ ¹æ® <code>height</code> è¿›è¡ŒæŠ˜å æ“ä½œ</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
            <tag> ES ç¢ç‰‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES çš„ from size å’Œ scroll å’Œ search after</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%20from%20size%20%E5%92%8C%20scroll%20%E5%92%8C%20search%20after.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%20from%20size%20%E5%92%8C%20scroll%20%E5%92%8C%20search%20after.html</url>
      
        <content type="html"><![CDATA[<h1 id="from-size"><a href="#from-size" class="headerlink" title="from size"></a>from size</h1><p>from size æ˜¯æœ€å¸¸è§çš„åˆ†é¡µæ–¹å¼ï¼Œç±»æ¯” MySQL çš„ offset limit</p><p>ç”±äº ES æ˜¯å¤©ç„¶åˆ†å¸ƒå¼çš„ï¼Œæ•°æ®åˆ†æ•£åœ¨å„ä¸ª shards ä¸Šï¼Œæ‰€ä»¥éœ€è¦æŸ¥è¯¢ <code>from + size</code> çš„æ¡æ•°æ—¶ï¼Œcoordinate node å°±å‘è¯¥ index çš„å…¶ä½™çš„  shards å‘é€åŒæ ·çš„è¯·æ±‚ï¼Œç­‰æ±‡æ€»åˆ° <code>(shards Ã— (from + size))</code> æ¡æ•°æ—¶åœ¨ coordinate node å†è¿›è¡Œä¸€æ¬¡æ’åºï¼Œæœ€ç»ˆæŠ½å–å‡ºçœŸæ­£ from åçš„ size æ¡ç»“æœ</p><p>æ˜¾è€Œæ˜“è§ï¼Œå½“ shards è¾ƒå¤šã€åˆ†é¡µæ·±åº¦å¾ˆå¤§æ—¶ï¼Œè¿™ç§æ–¹å¼å­˜åœ¨å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ ES é»˜è®¤æ·±åº¦ä¸º <code>from + size &lt;= 10000</code> çš„åŸå› </p><h2 id="Routing-æœºåˆ¶"><a href="#Routing-æœºåˆ¶" class="headerlink" title="Routing æœºåˆ¶"></a>Routing æœºåˆ¶</h2><p>å†™å…¥æ–‡æ¡£æ—¶æŒ‡å®šå­˜å‚¨çš„åˆ†ç‰‡</p><p>å®˜æ–¹æä¾›çš„å…¬å¼å¦‚ä¸‹ï¼š<code>shard_num = hash(_routing) % num_primary_shards</code></p><ul><li><code>_routing</code> ä»£è¡¨æä¾›è·¯ç”±çš„å­—æ®µã€‚é»˜è®¤æƒ…å†µä¸‹ä¸ºæ–‡æ¡£çš„ ID</li><li><code>num_primary_shards</code> ä»£è¡¨çš„ä¸º primary shard çš„ä¸ªæ•°ï¼Œè¿™ä¸ªåœ¨æ¯ä¸ªç´¢å¼•ç±»å‹åˆ›å»ºä¹‹å‰å°±è¢«è®¾ç½®äº†ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®ä¹Ÿå¯ä»¥è®© ES é»˜è®¤è®¾ç½®ã€‚å› ä¸º ES ç‰ˆæœ¬ä¸åŒï¼Œè®¾ç½®çš„é»˜è®¤å€¼ä¹Ÿä¸åŒã€‚è¯¥å€¼åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºç´¢å¼•ç±»å‹è¢«è®¾ç½®å®Œæˆä¹‹åæ— æ³•æ— æ³•ä¿®æ”¹ï¼ˆä¿®æ”¹è·¯ç”±æœºåˆ¶å°±ä»£è¡¨éœ€è¦è¿ç§»æ•°æ®ï¼‰</li><li><code>shard_num</code> ä»£è¡¨æ•°æ®è½åœ¨çš„ shard ç¼–å·</li></ul><p>åŸºæœ¬æµç¨‹æ˜¯ ES æ ¹æ®è·¯ç”±å­—æ®µè®¡ç®—å…¶å“ˆå¸Œå€¼ï¼Œå†ä¸ä¸»åˆ†ç‰‡æ•°é‡å–ä½™ï¼Œè®¡ç®—å¾—å‡ºæ•°æ®è½åœ¨çš„åˆ†ç‰‡ç¼–å·</p><p>æ­¤å¤–å¦‚æœåªæ ¹æ® <code>_routing</code> ä¼šå‡ºç°æ•°æ®å€¾æ–œï¼Œå¯ä»¥é‡‡å–æŠ˜ä¸­æ–¹æ¡ˆï¼Œä½¿ç”¨ <code>routing_partition_size</code> å‚æ•°ï¼Œæ¥ä½¿åŒä¸€ç±» <code>_routing</code> è·¯ç”±åˆ°ä¸»åˆ†ç‰‡çš„ä¸€ä¸ªå­é›†ä¸­</p><p><code>shard_num = (hash(_routing) + hash(_id) % routing_partition_size) % num_primary_shards</code></p><h2 id="restful"><a href="#restful" class="headerlink" title="restful"></a>restful</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// searchRequest</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hero-index&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// åˆ†é¡µæ¡ä»¶</span></span><br><span class="line">    searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// term name = &quot;&quot;</span></span><br><span class="line">    <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// bool ç±»å‹ä¸º must not</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery().mustNot(termQueryBuilder);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶ç»„è£…è¿› searchSourceBuilder</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> <span class="title class_">TimeValue</span>(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="search-after"><a href="#search-after" class="headerlink" title="search after"></a>search after</h1><p>ES 5 å¼•å…¥çš„æ–°æœºåˆ¶</p><p>ç®€å•æ¦‚æ‹¬ search after å¦‚ä½•ä½¿ç”¨ï¼š</p><ul><li>å¿…é¡»å…ˆæŒ‡å®šæ’åºè§„åˆ™ï¼ˆéœ€è¦è·å–æ’åºåæ ‡ï¼‰</li><li>æ¯”å¦‚ä»ç¬¬ä¸€é¡µå¼€å§‹ï¼ˆä»ä¸­é—´å¼€å§‹ä¹Ÿæ— æ³•çŸ¥é“ä¸­é—´çš„å…·ä½“ä½ç½®ï¼‰</li><li>ä»ç¬¬ä¸€é¡µå¼€å§‹ä»¥åæ¯æ¬¡éƒ½å¸¦ä¸Š<code>search_after=lastEmittedDocFieldValue</code><br><code>lastEmittedDocFieldValue</code> å°±æ˜¯ä¸‹ä¸€é¡µå¼€å§‹çš„ keyset åæ ‡ï¼ˆä¹Ÿå°±æ˜¯è¿™ä¸ªå‚æ•°æŠŠæ·±åº¦åˆ†é¡µå˜æˆäº†å¸¸æ•°çº§åˆ†é¡µï¼‰</li></ul><p><strong>å’Œ from size ç›¸æ¯”ï¼Œæ— è®ºå»åˆ°ç¬¬å‡ é¡µï¼Œcoordinate node å‘å…¶å®ƒ node å‘é€çš„è¯·æ±‚å§‹ç»ˆå°±æ˜¯è¯·æ±‚ size ä¸ª docsï¼›å³æ— è®ºåˆ†é¡µæ·±åº¦æ˜¯å¤šå°‘ï¼Œéƒ½æ˜¯å¸¸é‡çº§çš„å¼€é”€</strong></p><p>å…¶å®ç°åŸç†å’Œå…³ç³»å‹æ•°æ®åº“å¸¸ä½¿ç”¨çš„ keyset åˆ†é¡µæ€æƒ³ä¸€è‡´ï¼Œä¸šåŠ¡å¦¥åï¼ˆåªèƒ½æŒ‰é¡ºåºåˆ†é¡µè€Œä¸èƒ½è·³è½¬é¡µæ•°ï¼‰æ¥å®ç°æ€§èƒ½çš„æå‡</p><p>ä½†éœ€è¦æ³¨æ„ï¼Œçœ‹ä¼¼ search after æ˜¯ä¸€ä¸ª O(1) çº§åˆ«çš„æ“ä½œï¼Œä½†éšç€åˆ†é¡µæ·±åº¦çš„å¢åŠ ï¼Œå…¶å†…éƒ¨é€»è¾‘æ‰«æçš„ doc æ•°é‡ä¹Ÿåœ¨ä¸æ–­å¢åŠ ï¼Œä¾ç„¶ä¼šå½±å“æŸ¥è¯¢æ€§èƒ½ï¼Œåªæ˜¯ç›¸æ¯” from size æ–¹å¼æœ‰ä¸€å®šæå‡ï¼ˆMySQL å•è¡¨æŸ¥è¯¢çš„åˆ†é¡µä¹Ÿæ˜¯å¦‚æ­¤ï¼‰</p><p>æ­¤å¤–ï¼Œå¦‚æœå­—æ®µåŒºåˆ†åº¦ä¸é«˜ï¼Œåˆ™ä¼šå¿½ç•¥æŸäº›æ•°æ®ï¼›ä¾‹å¦‚æ ¹æ® age ä½œä¸ºæ’åºæ¡ä»¶ï¼Œæ­¤æ—¶å¦‚æœæ¯é¡µæ•°æ®å– 1000 æ¡ï¼Œè€ŒæŸä¸ª age æ•°æ® count &gt; 1000ï¼Œåˆ™ä¼šå¿½ç•¥åç»­æ•°æ®ï¼›<strong>è§£å†³æ–¹æ³•æ˜¯æ’åºå­—æ®µå”¯ä¸€ï¼Œæˆ–è€…ç»„åˆåçš„å¤šä¸ªæ’åºæ¡ä»¶å”¯ä¸€</strong></p><h2 id="restful-1"><a href="#restful-1" class="headerlink" title="restful"></a>restful</h2><p>ç¬¬ä¸€æ¬¡æŸ¥è¯¢å’Œæ™®é€šæŸ¥è¯¢ä¸€è‡´</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>éšåçš„æŸ¥è¯¢å¢åŠ  <code>search_after</code> æŸ¥è¯¢æ¡ä»¶ï¼Œå€¼ä¸ºæœ€åä¸€æ¡æ•°æ®æ’åºå­—æ®µçš„å€¼</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;search_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="number">35</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;i-mnlIQBCTaFCHoWJhbM&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Java-1"><a href="#Java-1" class="headerlink" title="Java"></a>Java</h2><p>åŒ from size ä¸€è‡´</p><p>ç¬¬äºŒæ¬¡æŸ¥è¯¢åŠä¹‹åéœ€è¦ <code>searchSourceBuilder.searchAfter(new Object[1]);</code> æ¥è®¾ç½® <code>search_after</code> å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchAfter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// searchRequest</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hero-index&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// åˆ†é¡µæ¡ä»¶</span></span><br><span class="line">    searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// term name = &quot;&quot;</span></span><br><span class="line">    <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// bool ç±»å‹ä¸º must not</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery().mustNot(termQueryBuilder);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶ç»„è£…è¿› searchSourceBuilder</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> <span class="title class_">TimeValue</span>(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸Šæ‰¹æ•°æ®æœ€åä¸€æ¡çš„æ’åºå­—æ®µå€¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">lastHitOrderFieldValue</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// set è¿› searchAfter å±æ€§ä¸­</span></span><br><span class="line">    searchSourceBuilder.searchAfter(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;lastHitOrderFieldValue&#125;);</span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="scroll"><a href="#scroll" class="headerlink" title="scroll"></a>scroll</h1><p>å¦‚æœä¸€å¼€å§‹å°±æ˜ç¡®åœ°æŸ¥è¯¢å…¨é‡çš„æ•°æ®ï¼Œæ— è®ºä½¿ç”¨ from size è¿˜æ˜¯ search after éƒ½ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œè¦ä¹ˆä¾ç„¶å­˜åœ¨æ·±åº¦åˆ†é¡µçš„é—®é¢˜ï¼Œè¦ä¹ˆéœ€è¦å¤šæ¬¡è¯·æ±‚ï¼Œæ‰€ä»¥å¼•å…¥äº† scroll æ–¹å¼</p><p>scroll å°±æ˜¯æŠŠä¸€æ¬¡çš„æŸ¥è¯¢ç»“æœç¼“å­˜ä¸€å®šçš„æ—¶é—´ï¼Œå¦‚ <code>scroll = 1m</code> åˆ™æŠŠæŸ¥è¯¢ç»“æœåœ¨ä¸‹ä¸€æ¬¡è¯·æ±‚ä¸Šæ¥æ—¶æš‚å­˜ 1 åˆ†é’Ÿ</p><p>response æ¯”ä¼ ç»Ÿçš„è¿”å›å¤šäº†ä¸€ä¸ª <code>scroll_id</code>ï¼Œä¸‹æ¬¡å¸¦ä¸Šè¿™ä¸ª <code>scroll_id</code> å³å¯æ‰¾å›è¿™ä¸ªç¼“å­˜çš„ç»“æœ</p><p>æœ¬è´¨ä¸Šæ˜¯è®©å„ä¸ª shard å°†ç»“æœç¼“å­˜ï¼Œæ­¤å¤–ä¹Ÿæœ‰å¾ˆå¤šä¼˜åŒ–ï¼ˆå• shard å‡å°‘è¯·æ±‚æ•°é‡ã€å‰ªæç­‰ï¼‰æ¥æé«˜æ€§èƒ½</p><h2 id="restful-2"><a href="#restful-2" class="headerlink" title="restful"></a>restful</h2><p>ç¬¬ä¸€æ¬¡è¯·æ±‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search?scroll=<span class="number">1</span>m</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>éšå</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_search/scroll</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;scroll&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;scroll_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFlN0TlRCWW5pUktHLWxvMEdDN3Zya2cAAAAAAAAA_hZkVXh5THJ1SFR1dVVPQlJJX3JDZWRR&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Java-2"><a href="#Java-2" class="headerlink" title="Java"></a>Java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scrollSearch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// searchRequest</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hero-index&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// åˆ†é¡µæ¡ä»¶</span></span><br><span class="line">    searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// term name = &quot;&quot;</span></span><br><span class="line">    <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// bool ç±»å‹ä¸º must not</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery().mustNot(termQueryBuilder);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶ç»„è£…è¿› searchSourceBuilder</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> <span class="title class_">TimeValue</span>(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ scroll</span></span><br><span class="line">    <span class="type">Scroll</span> <span class="variable">scroll</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scroll</span>(TimeValue.timeValueMinutes(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    searchRequest.scroll(scroll);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšååº”è¯¥å¾ªç¯æŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scrollAfterSearch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰ scroll</span></span><br><span class="line">    <span class="type">Scroll</span> <span class="variable">scroll</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scroll</span>(TimeValue.timeValueMinutes(<span class="number">1</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">scrollId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">SearchScrollRequest</span> <span class="variable">searchScrollRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchScrollRequest</span>(scrollId);</span><br><span class="line">    searchScrollRequest.scroll(scroll);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    searchScrollRequest.scroll(scroll);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.scroll(searchScrollRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹</p><h1 id="æ‹“å±•"><a href="#æ‹“å±•" class="headerlink" title="æ‹“å±•"></a>æ‹“å±•</h1><p>æ–‡ç«  <strong>ã€Šä¸šç•Œéš¾é¢˜ - â€è·¨åº“åˆ†é¡µâ€ çš„å››ç§æ–¹æ¡ˆã€‹</strong></p><h2 id="éœ€æ±‚äº§ç”Ÿ"><a href="#éœ€æ±‚äº§ç”Ÿ" class="headerlink" title="éœ€æ±‚äº§ç”Ÿ"></a>éœ€æ±‚äº§ç”Ÿ</h2><p><strong>åˆ†é¡µéœ€æ±‚</strong></p><p>å¯¹äºæ•°æ®çš„æŸ¥è¯¢ï¼Œå¾ˆå¤šä¸šåŠ¡éƒ½æœ‰åˆ†é¡µæ‹‰å–æ•°æ®çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šåˆ†é¡µæ‹‰å–èŠå¤©è®°å½•ã€å•†å“ä¿¡æ¯ã€å›¾ç‰‡æ•°æ®ç­‰</p><p>é™¤äº†å¯¹æ•°æ®é›†æ‹†åˆ†ï¼Œå¾€å¾€è¿˜éœ€è¦ä¸šåŠ¡å­—æ®µè¿›è¡Œæ’åº</p><p>æ¯”å¦‚å–ç¬¬ 3 é¡µçš„è®¢å•æ•°æ®ï¼Œæ¯é¡µ 100 æ¡ï¼Œæ ¹æ®åˆ›å»ºæ—¶é—´å€’åºï¼›å¯ä»¥æ ¹æ®åˆ›å»ºæ—¶é—´å»ºç«‹ç´¢å¼•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">200</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure><p><strong>åˆ†åº“åˆ†è¡¨</strong></p><p>éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œä¸ºäº†åº”å¯¹æ•°æ®é‡å¤§ã€è¯·æ±‚é‡å¤§ç­‰é—®é¢˜ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†æ¨ªå‘æ‰©å±•</p><p>å¼•å…¥åˆ†åº“åˆ†è¡¨åï¼Œæ•°æ®æ ¹æ® patition key è·¯ç”±è§„åˆ™å†™å…¥ä¸åŒçš„åº“è¡¨ä¸­</p><p>åŒæ—¶ä¸ºäº†è®©è¯»å†™å‹åŠ›å°½å¯èƒ½å‡åŒ€åˆ†å¸ƒåœ¨å„ä¸ªåº“ä¸­ï¼Œå¾€å¾€ä¼šè®¾ç½®åˆé€‚çš„ patition key</p><p>å½“åˆ†åº“åˆ†è¡¨åéœ€è¦è¿›è¡Œç¤ºä¾‹çš„åˆ†é¡µéœ€æ±‚æ—¶ï¼Œå°±æ— æ³•é€šè¿‡ç®€å•çš„è¯·æ±‚ä¸€ä¸ªåº“å®ç°ç›®çš„äº†ï¼ˆå‡è®¾åˆ†è¡¨é”®ä¸æ˜¯ä½¿ç”¨çš„åˆ›å»ºæ—¶é—´ï¼Œäº‹å®ä¸Šä½¿ç”¨åˆ›å»ºæ—¶é—´èŒƒå›´ä½œä¸ºåˆ†è¡¨é”®ä¹Ÿæ²¡ä»»ä½•æ„ä¹‰ï¼‰</p><p>æ’åºçš„ä¾æ®æ˜¯æ—¶é—´ï¼Œåˆ†è¡¨çš„ä¾æ®æ˜¯å…¶ä»–å­—æ®µï¼Œå› æ­¤æ•°æ®åº“ä¸§å¤±äº†åˆ›å»ºæ—¶é—´æ’åºçš„å…¨å±€è§†é‡</p><p>æœ¬æ–‡å°±åœ¨è®¨è®ºå¦‚ä½•æ»¡è¶³ è·¨è¶Šå¤šä¸ªæ°´å¹³æ‹†åˆ†æ•°æ®åº“çš„åˆ†é¡µæŸ¥è¯¢é—®é¢˜</p><h2 id="å…¨å±€è§†é‡"><a href="#å…¨å±€è§†é‡" class="headerlink" title="å…¨å±€è§†é‡"></a>å…¨å±€è§†é‡</h2><p>å½“æ•°æ®åˆ†å¸ƒåœ¨ä¸¤ä¸ªåº“ä¸­ï¼Œæ— è®ºå“ªä¸ªåˆ†åº“çš„ç¬¬ä¸‰é¡µï¼Œéƒ½ä¸ä¸€å®šä¼šæ˜¯å…¨å±€æ’åºçš„ç¬¬ä¸‰é¡µæ•°æ®</p><p>æƒ…å†µå¦‚ä¸‹ï¼š</p><ul><li>ä¸€èˆ¬æƒ…å†µï¼šä¸¤ä¸ªåº“å„å ç¬¬ä¸‰é¡µæ•°æ®çš„ä¸€éƒ¨åˆ†</li><li>æç«¯æƒ…å†µï¼šä¸¤ä¸ªåº“å„å ä¸€åŠ</li><li>æç«¯æƒ…å†µï¼šç¬¬ä¸‰é¡µæ•°æ®å®Œå…¨æ¥è‡ªäºä¸€ä¸ªåº“</li></ul><p>ç”±äºæŸ¥è¯¢å‰å¹¶ä¸æ¸…æ¥šæ•°æ®åˆ°åº•æ˜¯å¦‚ä½•åˆ†å¸ƒåœ¨å„ä¸ªåˆ†åº“ä¸Šçš„ï¼Œæ‰€ä»¥æ¯ä¸ªåº“éƒ½è¿”å› 3 é¡µæ•°æ®ï¼Œæ‰€å¾—åˆ°çš„ 6 é¡µæ•°æ®å†è¿›è¡Œæ’åºï¼Œæ­¤æ—¶è·å¾—äº†æ ¹æ®åˆ›å»ºæ—¶é—´æ’åºçš„å…¨å±€è§†é‡ï¼Œå†ä» 6 é¡µæ•°æ®ä¸­æŠ½å–éœ€è¦çš„ç¬¬ 3 é¡µæ•°æ®</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>ä¸šåŠ¡æ— æŸï¼Œç²¾å‡†è¿”å›</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li><p>æ¯æ¬¡éœ€è¦å‘å„åˆ†åº“æŸ¥è¯¢çš„æ•°æ®é‡å’Œ shard æ•°é‡å€æ•°çº§ç›¸å…³ï¼Œå’Œé¡µç ï¼ˆæ·±åº¦ï¼‰æŒ‡æ•°çº§ç›¸å…³</p></li><li><p>éœ€è¦äºŒæ¬¡æ’åº</p></li><li><p>éœ€è¦æ›´å¤š IO èµ„æº</p></li></ul><h2 id="ç¦æ­¢è·³é¡µ"><a href="#ç¦æ­¢è·³é¡µ" class="headerlink" title="ç¦æ­¢è·³é¡µ"></a>ç¦æ­¢è·³é¡µ</h2><p>ç”±ä¸šåŠ¡è¿›è¡Œå¦¥åï¼Œä¸å…è®¸è¿›è¡Œé¡µæ•°çš„éšæ„è·³è½¬ï¼Œåªå…è®¸ä¾æ¬¡è¿›è¡Œ ä¸‹ä¸€é¡µ æ“ä½œï¼Œå°±èƒ½å‡å°‘æ·±åº¦åˆ†é¡µå¸¦æ¥çš„æ€§èƒ½å½±å“</p><p>è¢«ç§°ä¸º keyset åˆ†é¡µã€search after ç­‰</p><p>é¦–å…ˆè¿™ç§æ–¹å¼éœ€è¦å…ˆè¿›è¡Œæ’åºï¼Œæ¯”å¦‚ä½¿ç”¨åˆ›å»ºæ—¶é—´ä½œä¸ºæ’åºå­—æ®µï¼Œç¬¬ä¸€é¡µæ—¶å„åˆ†åº“æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">0</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>å½“ç‚¹å‡»ä¸‹ä¸€é¡µæ—¶ï¼Œæ ¹æ®ç¬¬ä¸€é¡µæ•°æ®çš„æœ€åä¸€æ¡ï¼Œå³ç¬¬ä¸€é¡µä¸­æœ€å°åˆ›å»ºæ—¶é—´çš„æ•°æ®ï¼ˆå‡è®¾æ˜¯ 1669820860000ï¼‰ï¼Œå„åˆ†åº“æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">WHERE</span> `createdTime` <span class="operator">&gt;</span> <span class="number">1669820860000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">0</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œé™¤ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ï¼Œåé¢æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦å¸¦ä¸Šæ’åºæ¡ä»¶ä¸‹ï¼Œä¸Šä¸€æ¬¡æŸ¥è¯¢æœ€åæ•°æ®çš„æ’åºå€¼ï¼Œè¿™ä¹Ÿæ˜¯æ— æ³•è¿›è¡Œè·³é¡µçš„åŸå› ï¼Œå› ä¸ºä¸é€šè¿‡æŸ¥è¯¢æ— æ³•çŸ¥é“æ‰€éœ€é¡µæ•°æ®çš„ search after æ¡ä»¶æ˜¯å¤šå°‘</p><p>ç¦æ­¢è·³é¡µåæ¯ä¸ªåˆ†åº“ä¸€æ¬¡éƒ½åªæŸ¥è¯¢ä¸€é¡µæ•°æ®ï¼ŒæŸ¥è¯¢æ•°æ®é‡åªå’Œåˆ†åº“æ•°é‡å€æ•°çº§ç›¸å…³</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ€§èƒ½ç›¸å¯¹è¾ƒå¥½ï¼Œä¸å—å…¨å±€è§†é‡ä¸­æ·±åº¦åˆ†é¡µæŒ‡æ•°çº§å½±å“</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>ä¸šåŠ¡è¿›è¡Œä¸èƒ½è·³é¡µçš„å¦¥å</li><li>æ’åºå­—æ®µéœ€è¦å…·æœ‰åŒºåˆ†åº¦</li></ul><h2 id="å…è®¸ç²¾åº¦æŸå¤±"><a href="#å…è®¸ç²¾åº¦æŸå¤±" class="headerlink" title="å…è®¸ç²¾åº¦æŸå¤±"></a>å…è®¸ç²¾åº¦æŸå¤±</h2><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œpatition key è§„åˆ™éƒ½å°½å¯èƒ½ä½¿æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨å„åˆ†åº“ä¸­</p><p>æ‰€ä»¥å¯ä»¥ç†æƒ³è®¤ä¸ºï¼Œæ¯ä¸ªåˆ†åº“éƒ½å®Œæ•´åŒ…å«äº†æ•°æ®çš„ä¸€éƒ¨åˆ†</p><p>å‡è®¾éœ€è¦å–ç¬¬ 100 é¡µæ•°æ®ï¼Œæœ‰ 2 ä¸ªåˆ†åº“ï¼Œå¯ä»¥å„å–æ¯ä¸ªåˆ†åº“çš„åŠé¡µæ•°æ®å†å¾—åˆ°æ•°æ®çš„å¹¶é›†</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">9450</span>,<span class="number">50</span>;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼æœ€ç»ˆç»“æœåªèƒ½æ˜¯è¿‘ä¼¼ç»“æœï¼Œå¹¶ä¸ç²¾å‡†</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ€§èƒ½ç›¸å¯¹è¾ƒå¥½ï¼Œä¸å—å…¨å±€è§†é‡ä¸­æ·±åº¦åˆ†é¡µæŒ‡æ•°çº§å½±å“</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>ä¸šåŠ¡è¿›è¡Œç²¾åº¦æŸå¤±çš„å¦¥å</li></ul><h2 id="äºŒæ¬¡æŸ¥è¯¢"><a href="#äºŒæ¬¡æŸ¥è¯¢" class="headerlink" title="äºŒæ¬¡æŸ¥è¯¢"></a>äºŒæ¬¡æŸ¥è¯¢</h2><p>è¿™ç§æ–¹å¼æ—¢èƒ½åšåˆ°ç²¾å‡†æ•°æ®ï¼Œä¹Ÿèƒ½å‡å°‘æŸ¥è¯¢é‡</p><p>åŸºæœ¬çš„æ€æƒ³æ˜¯é€šè¿‡å¤šæ¬¡æŸ¥è¯¢æ¥è·å¾—å…¨å±€è§†é‡ï¼Œå†æ ¹æ®å…¨å±€è§†é‡åœ¨ç»“æœé›†ä¸­æŠ½å–éœ€è¦çš„æ•°æ®</p><p>å‡è®¾ä¸€é¡µæŸ¥è¯¢ 5 æ¡æ•°æ®ï¼ŒæŸ¥è¯¢ç¬¬ 201 é¡µï¼Œæœ‰ä¸‰ä¸ªåˆ†åº“ï¼›å•è¡¨æŸ¥è¯¢å¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">1000</span>,<span class="number">5</span>;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸€æ­¥ï¼š</strong></p><p>æ”¹å†™æŸ¥è¯¢ï¼Œå„åˆ†åº“æŒ‰ç†æƒ³æƒ…å†µä¸‹æ•°æ®åˆ†å¸ƒè¿›è¡ŒæŸ¥è¯¢ï¼Œå³</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">333</span>,<span class="number">5</span>;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœ</p><table><thead><tr><th align="center">A</th><th align="center">B</th><th align="center">C</th></tr></thead><tbody><tr><td align="center">523</td><td align="center">423</td><td align="center">500</td></tr><tr><td align="center">423</td><td align="center">421</td><td align="center">400</td></tr><tr><td align="center">323</td><td align="center">400</td><td align="center">300</td></tr><tr><td align="center">223</td><td align="center">320</td><td align="center">200</td></tr><tr><td align="center">123</td><td align="center">320</td><td align="center">100</td></tr></tbody></table><p><strong>ç¬¬äºŒæ­¥ï¼š</strong></p><p>ç»“æœé›†æ’åºåï¼Œæ‰¾åˆ°æ’åºå­—æ®µç¬¬ä¸€ä½çš„å€¼ï¼Œ<code>createdTime DESC</code>ï¼Œå³åˆ›å»ºæ—¶é—´çš„æœ€å¤§å€¼</p><p>å¯ä»¥å¾—åˆ°æ˜¯åˆ†åº“ A è¿”å›çš„ 523</p><p><strong>ç¬¬ä¸‰æ­¥ï¼š</strong></p><p>æ‰©å¤§æŸ¥è¯¢èŒƒå›´ï¼ŒæŸ¥è¯¢æ¡ä»¶ä½¿ç”¨ <code>between</code> è¯­å¥ï¼Œæœ€å¤§å€¼ä¸ºå…¨å±€æœ€å¤§å€¼ï¼ˆ523ï¼‰ï¼Œæœ€å°å€¼ä¸ºè¯¥åˆ†åº“è¿”å›ç»“æœé›†çš„æœ€å¤§å€¼ï¼ˆB-423ï¼ŒC-500ï¼‰</p><p>å› ä¸ºæœ€å¤§å€¼åœ¨åˆ†åº“ A ç»“æœé›†ä¸­ï¼Œæ‰€ä»¥ A æ˜¯ä¸éœ€è¦äºŒæ¬¡è¯·æ±‚çš„ï¼ˆ523 å’Œ 123 æ•°æ®ä¸­å¿…ç„¶è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„ç»“æœé›†ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `order_B` <span class="keyword">WHERE</span> `createdTime` <span class="keyword">BETWEEN</span> <span class="number">523</span> <span class="keyword">AND</span> <span class="number">423</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `order_C` <span class="keyword">WHERE</span> `createdTime` <span class="keyword">BETWEEN</span> <span class="number">523</span> <span class="keyword">AND</span> <span class="number">500</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><p>Bã€C å¯èƒ½ä¼šè¿”å›æ›´å¤šçš„æ•°æ®ï¼Œç»“æœé›†æ›´æ–°ä¸º</p><table><thead><tr><th align="center">A</th><th align="center">B</th><th align="center">C</th></tr></thead><tbody><tr><td align="center"></td><td align="center"></td><td align="center">520</td></tr><tr><td align="center"></td><td align="center">499</td><td align="center">510</td></tr><tr><td align="center">523</td><td align="center">423</td><td align="center">500</td></tr><tr><td align="center">423</td><td align="center">421</td><td align="center">400</td></tr><tr><td align="center">323</td><td align="center">400</td><td align="center">300</td></tr><tr><td align="center">223</td><td align="center">320</td><td align="center">200</td></tr><tr><td align="center">123</td><td align="center">320</td><td align="center">100</td></tr></tbody></table><p><strong>ç¬¬å››æ­¥ï¼š</strong></p><p>æ¨æ–­å…¨å±€è§†é‡</p><p>åœ¨åˆ†åº“ A ä¸­ï¼Œ523 æ˜¯ç¬¬ 333 æ¡æ•°æ®</p><p>åœ¨åˆ†åº“ B ä¸­ï¼ŒåŠ ä¸Šæ–°è¿”å›çš„ 1 æ¡æ•°æ®ï¼Œ523 æ˜¯ç¬¬ 333 - 1 - 1 &#x3D; 331 æ¡æ•°æ®</p><p>åœ¨åˆ†åº“ C ä¸­ï¼ŒåŠ ä¸Šæ–°è¿”å›çš„ 2 æ¡æ•°æ®ï¼Œ523 æ˜¯ç¬¬ 333 - 2 -1 &#x3D; 330 æ¡æ•°æ®</p><p>æ­¤æ—¶å¾—åˆ°æ•´ä¸ªç»“æœé›†ä¸­çš„æœ€å¤§å€¼ 523 åœ¨å…¨å±€çš„ offset åº”è¯¥æ˜¯ 333 + 331 + 330 &#x3D; 994</p><p><strong>ç¬¬äº”æ­¥ï¼š</strong></p><p>å·²ç»æœ‰äº† 523 è¿™ä¸ªæ•°æ®çš„å…¨å±€è§†é‡ï¼Œoffset 994</p><p>åˆæœ‰äº†ç»“æœé›† 18 æ¡æ•°æ®</p><p>é‚£ä¹ˆæ’åºåå°±å¯ä»¥åœ¨ç»“æœé›†ä¸­æ‰¾åˆ° offset 1000 limit 5 çš„æ•°æ®é›†äº†</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ—¢èƒ½ç²¾å‡†è·å–ç»“æœï¼Œåˆèƒ½é¿å…æ·±åº¦åˆ†é¡µ</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li><p>é€»è¾‘å¤æ‚</p></li><li><p>éœ€è¦å¤šæ¬¡æŸ¥è¯¢</p></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><table><thead><tr><th align="center">æ–¹å¼</th><th align="center">ä¼˜ç‚¹</th><th align="center">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="center">å…¨å±€è§†é‡</td><td align="center">ç²¾ç¡®</td><td align="center">æ€§èƒ½é—®é¢˜</td></tr><tr><td align="center">ç¦æ­¢è·³é¡µ</td><td align="center">é¿å…æ·±åº¦åˆ†é¡µ</td><td align="center">ä¸šåŠ¡å¦¥å</td></tr><tr><td align="center">å…è®¸ç²¾åº¦æŸå¤±</td><td align="center">é¿å…æ·±åº¦åˆ†é¡µ</td><td align="center">ä¸šåŠ¡å¦¥å</td></tr><tr><td align="center">äºŒæ¬¡æŸ¥è¯¢</td><td align="center">ç²¾ç¡® + é¿å…æ·±åº¦åˆ†é¡µ</td><td align="center">å¤šæ¬¡æŸ¥è¯¢</td></tr></tbody></table><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.jianshu.com/p/91d03b16af77">Elasticsearch 5.x æºç åˆ†æï¼ˆ3ï¼‰from size, scroll å’Œ search after - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://developer.aliyun.com/article/713865">ä¸šç•Œéš¾é¢˜-â€œè·¨åº“åˆ†é¡µâ€çš„å››ç§æ–¹æ¡ˆ-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº (aliyun.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
            <tag> ES ç¢ç‰‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¢å‘å¯¹è±¡å…­å¤§åŸåˆ™</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99.html</url>
      
        <content type="html"><![CDATA[<h1 id="å…­å¤§åŸåˆ™"><a href="#å…­å¤§åŸåˆ™" class="headerlink" title="å…­å¤§åŸåˆ™"></a>å…­å¤§åŸåˆ™</h1><table><thead><tr><th>è®¾è®¡åŸåˆ™</th><th>æ¦‚è¿°</th><th>ç›®çš„</th></tr></thead><tbody><tr><td>å¼€é—­åŸåˆ™</td><td>å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­</td><td>æ˜“äºç»´æŠ¤</td></tr><tr><td>å•ä¸€èŒè´£</td><td>ä¸€ä¸ªç±»åªå¹²ä¸€ä»¶äº‹ï¼Œå®ç°ç±»è¦å•ä¸€</td><td>æå‡å¯è¯»æ€§</td></tr><tr><td>é‡Œæ°æ›¿æ¢</td><td>ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•</td><td>å¥å£®æ€§ã€é˜²æ­¢é”™è¯¯ç»§æ‰¿</td></tr><tr><td>è¿ªç±³ç‰¹æ³•åˆ™</td><td>æœ€å°‘çŸ¥é“ï¼Œå¯¹è±¡ä¹‹é—´å°‘å»ºç«‹è”ç³»</td><td>ä½è€¦åˆ</td></tr><tr><td>æ¥å£éš”ç¦»</td><td>ä¸€ä¸ªæ¥å£åªå¹²ä¸€ä»¶äº‹ï¼Œæ¥å£è¦ç²¾ç®€å•ä¸€</td><td>é«˜å†…èš</td></tr><tr><td>ä¾èµ–å€’ç½®</td><td>é«˜å±‚ä¸åº”è¯¥ä¾èµ–ä½å±‚ï¼Œè¦é¢å‘æ¥å£ç¼–ç¨‹</td><td>åˆ©äºç»“æ„å‡çº§</td></tr></tbody></table><h2 id="å¼€é—­åŸåˆ™"><a href="#å¼€é—­åŸåˆ™" class="headerlink" title="å¼€é—­åŸåˆ™"></a>å¼€é—­åŸåˆ™</h2><blockquote><p><em>Software entities like classes,modules and functions should be open for extension but closed for modifications.</em></p><p><em>ä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚ç±»ï¼Œæ¨¡å—å’Œå‡½æ•°åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­</em></p></blockquote><p>éšç€ä¸šåŠ¡å‘å±•éœ€è¦å¢åŠ æ–°çš„æ–¹æ³•ï¼Œæœ‰å‡ ç§æ–¹å¼ï¼š</p><ul><li><strong>åœ¨æ¥å£ä¸Šæ·»åŠ æ–°æ–¹æ³•</strong><ul><li>å¯¼è‡´æ¯ä¸€ä¸ªå®ç°ç±»éƒ½éœ€è¦è¿›è¡Œå®ç°ï¼Œæ”¹åŠ¨é‡å¤§</li><li>ä¸ä¸€å®šæ‰€æœ‰çš„å®ç°ç±»éƒ½éœ€è¦è¯¥æ–¹æ³•</li></ul></li><li><strong>ä¿®æ”¹å®ç°ç±»æ—§æ–¹æ³•</strong><ul><li>æ›¿ä»£åŸæœ‰æ—§æ–¹æ³•åŠŸèƒ½ï¼Œå¦‚æœåŒæ—¶éœ€è¦ä½¿ç”¨æ—§æ–¹æ³•åˆ™æ— æ³•é‡‡ç”¨æ­¤æ–¹å¼ ï¼ˆ<code>getPrice()</code> è·å–çš„æ˜¯åŸä»·æ ¼è¿˜æ˜¯æ‰“æŠ˜åä»·æ ¼ï¼Ÿå¦‚æœéœ€è¦åŒæ—¶è·å–åŸä»·å’Œæ‰“æŠ˜åä»·æ ¼å¦‚ä½•å¤„ç†ï¼‰</li></ul></li><li><strong>é¢å‘æ‰©å±•ï¼Œä½¿ç”¨æ–°æ¥å£æˆ–è€…æ–°ç±»ç»§æ‰¿çˆ¶ç±»</strong><ul><li>æ–°æ¥å£æ–¹æ³•æ¥å£ï¼Œéœ€è¦çš„ç±»è¿›è¡Œå®ç°</li><li>æ–°ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œåœ¨çˆ¶ç±»åŸºç¡€ä¸Šå¢åŠ æ–¹æ³•</li></ul></li></ul><p><strong>æ˜æ˜¾é¢å‘æ‰©å±•æ›´å®¹æ˜“ç»´æŠ¤ï¼Œè¿™å°±æ˜¯å¼€é—­åŸåˆ™çš„ç›®çš„</strong></p><h2 id="å•ä¸€èŒè´£"><a href="#å•ä¸€èŒè´£" class="headerlink" title="å•ä¸€èŒè´£"></a>å•ä¸€èŒè´£</h2><blockquote><p><em>There should never be more than one reason for a class to change. â€”â€” Robert C. Martin</em></p><p><em>ä¸€ä¸ªç±»åº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› ï¼Œå¦åˆ™ç±»åº”è¯¥è¢«æ‹†åˆ†</em></p></blockquote><p>æ§åˆ¶ä¸šåŠ¡å®ç°çš„ç²’åº¦é—®é¢˜ï¼›ä¸€ä¸ªç±»å¯ä»¥å…·å¤‡ä»»æ„æ•°é‡çš„æ–¹æ³•ï¼Œä½†éƒ½å±äºåŒä¸€ä¸ªåŠŸèƒ½ç°‡ä¸­</p><p><strong>ä¸¥æ ¼æ§åˆ¶ç±»ä¸­æ–¹æ³•çš„ç²’åº¦ï¼Œå¿…è¦æ—¶è¿›è¡Œåˆ†æä¸æ‹†åˆ†</strong></p><h2 id="é‡Œæ°æ›¿æ¢"><a href="#é‡Œæ°æ›¿æ¢" class="headerlink" title="é‡Œæ°æ›¿æ¢"></a>é‡Œæ°æ›¿æ¢</h2><blockquote><p><em>Inheritance should ensure that any property proved about supertype objects also holds for subtype objects. â€”â€” Liskov</em></p><p><em>ç»§æ‰¿å¿…é¡»ç¡®ä¿çˆ¶ç±»æ‰€æ‹¥æœ‰çš„æ€§è´¨åœ¨å­ç±»ä¸­ä»ç„¶æˆç«‹</em></p></blockquote><p>åœ¨é‡Œæ°æ›¿æ¢åŸåˆ™çš„æŒ‡å¯¼æ–¹é’ˆä¸‹ï¼Œå¯å¾—å‡ºï¼šä»…ä»…ä¾æ®ä¸¤ä¸ªç±»ä¹‹é—´æœ‰æ²¡æœ‰ â€œis aâ€ çš„å…³ç³»ï¼Œæ¥åˆ¤æ–­ä¸¤ä¸ªç±»èƒ½ä¸èƒ½å‘ç”Ÿç»§æ‰¿å…³ç³»æ˜¯ä¸å¤Ÿçš„</p><p>åº”è¯¥éµå®ˆä¸€ä¸ªå¤§åŸåˆ™ï¼š<strong>ä»»ä½•ä½¿ç”¨çˆ¶ç±»çš„åœ°æ–¹ï¼Œéƒ½èƒ½è¢«é€æ˜çš„æ›¿æ¢æˆå­ç±»ï¼Œä¸”æ›¿æ¢æˆå­ç±»åï¼Œç¨‹åºè¡Œä¸ºä¸ä¼šå‘ç”Ÿé—®é¢˜</strong></p><p>ä¸åº”è¯¥æ»¥ç”¨ç»§æ‰¿å…³ç³»ï¼Œé¸µé¸Ÿæ˜¯å¦æ˜¯é¸Ÿçš„å­ç±»ï¼ˆä¸ä¼šé£ï¼‰ï¼Œé²¸é±¼æ˜¯å¦æ˜¯é±¼çš„å­ç±»ï¼ˆæ²¡æœ‰è…®ï¼‰ï¼Œç»§æ‰¿å…·æœ‰ä¾µå…¥æ€§ï¼Œå½“éœ€è¦ä½¿ç”¨ç»§æ‰¿å…³ç³»æ—¶éœ€è¦è¾¨æ˜æ˜¯å¦æ˜¯çœŸæ­£çš„ç»§æ‰¿ï¼Œ<strong>çˆ¶ç±»çš„æ¯ä¸ªæ–¹æ³•éƒ½å¿…é¡»é€‚ç”¨äºå­ç±»</strong></p><ol><li>å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†æ˜¯ä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•</li><li>å­ç±»å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•</li><li>å­ç±»é‡è½½çˆ¶ç±»æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å½¢å‚è¦æ¯”çˆ¶ç±»æ–¹æ³•æ›´ä¸ºå®½æ¾</li><li>å­ç±»å®ç°çˆ¶ç±»æŠ½è±¡æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„è¿”å›å€¼è¦æ¯”çˆ¶ç±»æ–¹æ³•æ›´ä¸ºä¸¥æ ¼</li></ol><h2 id="è¿ªç±³ç‰¹æ³•åˆ™"><a href="#è¿ªç±³ç‰¹æ³•åˆ™" class="headerlink" title="è¿ªç±³ç‰¹æ³•åˆ™"></a>è¿ªç±³ç‰¹æ³•åˆ™</h2><blockquote><p><em>talk only to your immediate friends. â€”â€” Ian Holland</em></p><p><em>åªå’Œç›´æ¥çš„æœ‹å‹äº¤æµ</em></p></blockquote><p>è¿ªç±³ç‰¹æ³•åˆ™ä¹Ÿç§°ä¸ºæœ€å°‘çŸ¥é“åŸåˆ™ï¼Œæœ€å°‘çŸ¥é“åŒ…å«ä¸¤ä¸ªç›®çš„ï¼š</p><ul><li><strong>åªå’Œç›´æ¥çš„æœ‹å‹äº¤äº’</strong><ul><li>ä¾‹å¦‚ MVC æ¶æ„ï¼Œè§†å›¾å±‚å’Œä¸šåŠ¡å±‚äº¤äº’ï¼Œä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚äº¤äº’ï¼Œè§†å›¾å±‚ä¸åº”è¯¥å’ŒæŒä¹…å±‚äº§ç”Ÿè”ç³»</li></ul></li><li><strong>è¾ƒå°‘å¯¹æœ‹å‹çš„äº†è§£</strong><ul><li>ç±»é—¨é¢æ¨¡å¼ï¼ˆé—¨é¢æŒ‡æš´éœ²é‡è¦å·¥ä½œçš„ç®€å•å…¥å£ï¼Œè€Œè¿ªç±³ç‰¹æ³•åˆ™åœ¨äºåªæš´éœ²è¯¥æš´éœ²çš„å…¥å£ï¼Œè¿˜æ˜¯æœ‰æ‰€åŒºåˆ«ï¼‰æ€æƒ³ï¼Œå¯¹å¤–åªæš´éœ²èƒ½å¤Ÿæ»¡è¶³å¤–éƒ¨éœ€è¦çš„å†…å®¹</li></ul></li></ul><p><strong>ç›®çš„åœ¨äºé™ä½ç±»ä¹‹é—´çš„è€¦åˆå…³ç³»</strong></p><h2 id="æ¥å£éš”ç¦»"><a href="#æ¥å£éš”ç¦»" class="headerlink" title="æ¥å£éš”ç¦»"></a>æ¥å£éš”ç¦»</h2><blockquote><p><em>Interface Segregation Principle, ISP</em></p><p><em>ä½è€¦åˆã€é«˜å†…èšä¸­çš„é«˜å†…èš</em></p></blockquote><p>æ¥å£éš”ç¦»åŸåˆ™ä¸­æ‰€è¯´çš„æ¥å£å¹¶ä¸æ˜¯ç‹­æ„çš„æŒ‡ Java ä¸­çš„ Interfaceï¼Œè€Œæ˜¯ä¸€åˆ‡çš„æä¾›æ–¹æ³•å®šä¹‰çš„å¯¹è±¡ï¼Œä¾‹å¦‚ Java ä¸­çš„æ¥å£ã€æŠ½è±¡ç±»ã€å®ä½“ç±»</p><p>æ¥å£éš”ç¦»çš„åŸåˆ™ï¼š</p><ul><li>å®¢æˆ·ç«¯ä¸ä¾èµ–ä¸éœ€è¦çš„æ¥å£</li><li>ç±»é—´ä¾èµ–å…³ç³»å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Š</li><li>æ¥å£åº”è¯¥ç»†åŒ–ï¼Œä¸åº”è¯¥å…·å¤‡è‡ƒè‚¿çš„æ–¹æ³•</li></ul><p>ä¾‹å¦‚å‘é€æ–¹å¼çš„å®ç°ç±» <code>Send</code>ï¼Œæ­¤æ—¶å…·å¤‡ä¸¤ç§å‘é€æ–¹å¼ï¼šé‚®ä»¶å’ŒçŸ­ä¿¡ï¼Œå¦‚æœå°†æ–¹æ³•éƒ½æ”¾åœ¨ <code>Send</code> ç±»ä¸­ï¼Œåˆ™åº”è¯¥åˆ†åˆ«å®šä¹‰ <code>sendEmail()</code> å’Œ <code>sendNotice()</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸åˆ©äºåé¢çš„æ‹“å±•ï¼›å¥½çš„è§£å†³æ–¹æ³•åº”è¯¥æ˜¯å®šä¹‰æ¥å£ï¼Œç„¶ååˆ†åˆ«åˆ›å»º <code>EmailSend</code> å’Œ <code>NoticeSend</code> ä¸¤ä¸ªå®ç°ç±»ï¼Œè¿™å°±æ˜¯æ¥å£éš”ç¦»çš„ç›®çš„</p><p>æ¥å£éš”ç¦»å’Œå•ä¸€åŸåˆ™çœ‹ä¼¼å†²çªï¼Œç›®æ ‡æ˜¯è¾¾åˆ°äºŒè€…çš„å¹³è¡¡</p><p><strong>é¿å…æ¥å£æ±¡æŸ“</strong></p><h2 id="ä¾èµ–å€’ç½®"><a href="#ä¾èµ–å€’ç½®" class="headerlink" title="ä¾èµ–å€’ç½®"></a>ä¾èµ–å€’ç½®</h2><blockquote><p><em>Dependence Inversion Principle,DIP</em></p><p><em>ä¸ä¾èµ–äºå…·ä½“å®ç°ï¼Œè€Œä¾èµ–äºæŠ½è±¡</em></p></blockquote><p>ä¸æ­£ç¡®çš„ä¾èµ–å…³ç³»æ˜¯ä¸Šå±‚è°ƒç”¨ä¸‹å±‚ï¼Œä¸Šå±‚ä¾èµ–ä¸‹å±‚</p><p>é¢å‘å¯¹è±¡å…¶å®å°±æ˜¯ä¾èµ–å€’ç½®çš„ä¸€ç§ä½“ç°ï¼Œä¾èµ–å€’ç½®è®©ä¸‹å±‚ä¾èµ–ä¸Šå±‚ï¼Œæ¯”å¦‚æ¥å£ï¼Œæ¥å£æ–¹æ³•çš„æ‰©å±•ä¼šå½±å“æ‰€æœ‰å®ç°ç±»ï¼Œä½†æŠ½è±¡å±‚çš„å˜åŠ¨è¿œè¿œå°‘äºå®ç°å±‚ï¼Œæ‰€ä»¥ä¾èµ–å€’ç½®å¯ä»¥å¾ˆå¥½åœ°é¿å…é¢‘ç¹çš„ä¿®æ”¹</p><p><strong>é¢å‘æ¥å£ç¼–ç¨‹</strong></p><h1 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h1><h2 id="å¦‚ä½•æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™"><a href="#å¦‚ä½•æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™" class="headerlink" title="å¦‚ä½•æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™"></a>å¦‚ä½•æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™</h2><p>é‡Œæ°æ›¿æ¢çš„åŸåˆ™æŒ‡ï¼šéœ€è¦ä½¿ç”¨çˆ¶ç±»çš„åœ°æ–¹å¯ä»¥æ›¿æ¢ä¸ºå­ç±»ä½¿ç”¨ï¼Œå› ä¸ºçˆ¶ç±»çš„æ–¹æ³•åœ¨å­ç±»ä¸Šåº”è¯¥ä¿æŒä¸€è‡´</p><p>åœ¨å®é™…ä¸­é‡åˆ°ç›´æ¥ç»§æ‰¿ä¸èƒ½æ»¡è¶³é‡Œæ°æ›¿æ¢çš„åœºæ™¯ï¼Œå°±<strong>è¯´æ˜æŠ½è±¡ä¸è¶³ï¼Œéœ€è¦å‘ä¸ŠæŠ½è±¡</strong></p><p>å¦‚æœä¸€ä¸ª <code>Add</code> ç±»çš„ <code>compute(int n)</code> æ“ä½œä¸ºåŠ æ³•ï¼Œå‡æ³•ä¹Ÿæƒ³è¦è¿›è¡Œå®ç°ï¼Œåˆ™ç»§æ‰¿ <code>Add</code> ç±»åé‡å†™äº† <code>compute(int n)</code> æ–¹æ³•ï¼Œæ­¤æ—¶åˆ™è¿åäº†é‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œæ•´ä¸ªæ–¹æ³•çš„å®ç°è¢«é‡å†™äº†</p><p>å‘ä¸ŠæŠ½è±¡å‡º <code>Compute</code> æ¥å£ï¼Œå³å¯ä»¥å®ç°é‡Œæ°æ›¿æ¢åŸåˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Compute</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(<span class="type">int</span> n)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Add</span> <span class="keyword">implements</span> <span class="title class_">Compute</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> n)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åŠ æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Subtract</span> <span class="keyword">implements</span> <span class="title class_">Compute</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> n)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‡æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://refactoringguru.cn/design-patterns">å¸¸ç”¨è®¾è®¡æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ (refactoringguru.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä»£ç è§„èŒƒ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
