<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>LangGraph - Plan-and-Execute Agent</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20Plan-and-Execute%20Agent.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20Plan-and-Execute%20Agent.html</url>
      
        <content type="html"><![CDATA[<p>åŸºäº LangGraphï¼Œå¯ä»¥è½»æ¾å®ç°ä¸åŒè®¾è®¡æ¨¡å¼çš„ Agentã€RAG ç­‰åº”ç”¨</p><p>è¿™é‡Œä»¥ <strong>Plan-and-Execute</strong>ä¸ºä¾‹ï¼Œç»§ç»­æ·±å…¥ä½“éªŒä¸€ä¸‹å…¶åŠŸèƒ½</p><p></br></p><h1 id="ä»€ä¹ˆæ˜¯-plan-and-execute">ä»€ä¹ˆæ˜¯ Plan and Execute</h1><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20Plan-and-Execute%20Agent/plan-and-execute.png" class="" title="plan-and-execute"><p>è®¡åˆ’æ‰§è¡Œ Agent å’Œæ ¸å¿ƒæ€æƒ³æ˜¯</p><ul><li>é¦–å…ˆè¿›è¡Œå¤šè®¡åˆ’çš„æ‹†åˆ†</li><li>ä¸€æ¬¡ä¸€ä¸ªé¡¹ç›®åœ°å®Œæˆè¿™ä¸ªè®¡åˆ’</li><li>å®Œæˆç‰¹å®šä»»åŠ¡åï¼Œå¯ä»¥é‡æ–°æŸ¥çœ‹è®¡åˆ’å¹¶æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹</li></ul><p>å’Œ ReAct Agent ç›¸æ¯”ä¼˜åŠ¿åœ¨äº</p><ul><li>æ˜ç¡®çš„é•¿æœŸè§„åˆ’ï¼ˆä½†å³ä½¿æ˜¯çœŸæ­£å¼ºå¤§çš„ LLM ä¹Ÿå¯èƒ½éš¾ä»¥åº”å¯¹ï¼‰</li><li>èƒ½å¤Ÿåœ¨æ‰§è¡Œæ­¥éª¤ä¸­ä½¿ç”¨è¾ƒå° / è¾ƒå¼±çš„æ¨¡å‹ï¼Œåœ¨è®¡åˆ’æ­¥éª¤ä¸­ä»…ä½¿ç”¨è¾ƒå¤§ /è¾ƒå¥½çš„æ¨¡å‹</li></ul><p></br></p><h1 id="coding">Coding</h1><h2 id="å®šä¹‰å·¥å…·">å®šä¹‰å·¥å…·</h2><p>ç¯å¢ƒå‚æ•°çš„é…ç½®å°±ä¸èµ˜è¿°äº†ï¼Œè¿™é‡Œä¾ç„¶ä½¿ç”¨ç»´åŸºç™¾ç§‘ä½œä¸ºå·¥å…·</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wikipedia = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())</span><br><span class="line">tools = [wikipedia]</span><br></pre></td></tr></table></figure><p></br></p><h2 id="å®šä¹‰æ‰§è¡Œä»£ç†">å®šä¹‰æ‰§è¡Œä»£ç†</h2><p>åˆ›å»ºè¦ç”¨äºæ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œä»£ç†</p><p>è¿™é‡Œé’ˆå¯¹ä¸åŒçš„è§’è‰²ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªä»£ç†ï¼Œå…¶å®å¯ä»¥åˆ†åˆ«ä½¿ç”¨ä¸åŒæ‰§è¡Œä»£ç†åœ¨å®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">llm = Azure.chat_model_4o</span><br><span class="line">agent_executor = create_react_agent(llm, tools, messages_modifier=prompt)</span><br></pre></td></tr></table></figure><p>å¦å¤–æ³¨æ„è¿™é‡Œçš„ <code>create_react_agent</code> æ¥è‡ª<code>langgraph.prebuilt</code> ï¼Œä½¿ç”¨äº†ä¸€ä¸ªé¢„æ„å»ºçš„ Agent</p><p><em>æ‰€ä»¥æˆ‘ç†è§£ï¼Œè¿™é‡Œæ˜¯å¤–é¢ä¸€ä¸ª Agent å¥—é‡Œé¢ä¸€ä¸ª Agentï¼Œå°†é¢„æ„å»ºçš„è¿™ä¸ªAgent ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹å†…çš„é€»è¾‘ï¼Œåœ¨åé¢æ­¥éª¤å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„ name ä¸ºagent</em></p><p></br></p><h2 id="å®šä¹‰çŠ¶æ€">å®šä¹‰çŠ¶æ€</h2><p>ä»å®šä¹‰è¯¥ä»£ç†çš„çŠ¶æ€ï¼ˆæµç¨‹è½¨è¿¹ trackï¼‰å¼€å§‹</p><ul><li>é¦–å…ˆï¼Œè·Ÿè¸ªå½“å‰è®¡åˆ’çš„è½¨è¿¹ï¼Œå°†å…¶è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²åˆ—è¡¨</li><li>æ¥ä¸‹æ¥ï¼Œåº”è¯¥è·Ÿè¸ªä»¥å‰æ‰§è¡Œçš„æ­¥éª¤ï¼Œè®©æˆ‘ä»¬å°†å…¶è¡¨ç¤ºä¸ºå…ƒç»„åˆ—è¡¨ï¼ˆè¿™äº›å…ƒç»„å°†åŒ…å«æ­¥éª¤ï¼Œç„¶ååŒ…å«ç»“æœï¼‰</li><li>æœ€åï¼Œéœ€è¦æœ‰ä¸€äº›çŠ¶æ€æ¥è¡¨ç¤ºæœ€ç»ˆå“åº”å’ŒåŸå§‹è¾“å…¥</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated, <span class="type">List</span>, <span class="type">Tuple</span>, TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PlanExecute</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="built_in">input</span>: <span class="built_in">str</span></span><br><span class="line">    plan: <span class="type">List</span>[<span class="built_in">str</span>] <span class="comment"># è®¡åˆ’è½¨è¿¹</span></span><br><span class="line">    past_steps: Annotated[<span class="type">List</span>[<span class="type">Tuple</span>], operator.add] <span class="comment"># å·²ç»å®Œæˆçš„æ­¥éª¤</span></span><br><span class="line">    response: <span class="built_in">str</span> <span class="comment"># å“åº”ç»“æœ</span></span><br></pre></td></tr></table></figure><p></br></p><h2 id="è®¡åˆ’æ­¥éª¤">è®¡åˆ’æ­¥éª¤</h2><p>åˆ›å»ºä¸€ä¸ªè®¡åˆ’æ­¥éª¤ï¼Œå®ƒè°ƒç”¨ LLM æ¥è·å–ç»“æ„åŒ–è¿”å›</p><p><code>Plan</code> ç»“æ„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Plan</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Plan to follow in future&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    steps: <span class="type">List</span>[<span class="built_in">str</span>] = Field(</span><br><span class="line">        description=<span class="string">&quot;different steps to follow, should be in sorted order&quot;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>ç»„è£…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">planner_prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (</span><br><span class="line">            <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span></span><br><span class="line"><span class="string">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span></span><br><span class="line"><span class="string">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.&quot;&quot;&quot;</span>,</span><br><span class="line">        ),</span><br><span class="line">        (<span class="string">&quot;placeholder&quot;</span>, <span class="string">&quot;&#123;messages&#125;&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">planner = planner_prompt | llm.with_structured_output(Plan)</span><br></pre></td></tr></table></figure><p>è°ƒç”¨éªŒè¯ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(planner.invoke(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">            (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;è‹¹æœçš„è‚¡ç¥¨åœ¨æœªæ¥äº”å¹´å†…è¿˜ä¼šç»§ç»­ä¸Šæ¶¨å—?&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plan(steps=[&#x27;æ”¶é›†è‹¹æœå…¬å¸è¿‡å»äº”å¹´çš„è´¢åŠ¡æ•°æ®å’Œè‚¡ä»·èµ°åŠ¿ã€‚&#x27;, &#x27;åˆ†æè‹¹æœå…¬å¸çš„è´¢åŠ¡å¥åº·çŠ¶å†µï¼ŒåŒ…æ‹¬æ”¶å…¥ã€åˆ©æ¶¦ã€ç°é‡‘æµç­‰å…³é”®æŒ‡æ ‡ã€‚&#x27;, &#x27;ç ”ç©¶è‹¹æœå…¬å¸åœ¨æœªæ¥äº”å¹´çš„å‘å±•è®¡åˆ’å’Œæˆ˜ç•¥ï¼ŒåŒ…æ‹¬æ–°äº§å“å‘å¸ƒã€å¸‚åœºæ‰©å±•ç­‰ã€‚&#x27;, &#x27;è¯„ä¼°å…¨çƒç»æµç¯å¢ƒå’Œç§‘æŠ€è¡Œä¸šçš„æ•´ä½“è¶‹åŠ¿å¯¹è‹¹æœå…¬å¸çš„å½±å“ã€‚&#x27;, &#x27;ç»¼åˆä»¥ä¸Šä¿¡æ¯ï¼Œé¢„æµ‹è‹¹æœå…¬å¸æœªæ¥äº”å¹´çš„è‚¡ä»·èµ°åŠ¿ã€‚&#x27;])</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ­¥éª¤æ‹†åˆ†çš„ç»“æœ</p><ol type="1"><li>æ”¶é›†è‹¹æœå…¬å¸è¿‡å»äº”å¹´çš„è´¢åŠ¡æ•°æ®å’Œè‚¡ä»·èµ°åŠ¿</li><li>åˆ†æè‹¹æœå…¬å¸çš„è´¢åŠ¡å¥åº·çŠ¶å†µï¼ŒåŒ…æ‹¬æ”¶å…¥ã€åˆ©æ¶¦ã€ç°é‡‘æµç­‰å…³é”®æŒ‡æ ‡</li><li>ç ”ç©¶è‹¹æœå…¬å¸åœ¨æœªæ¥äº”å¹´çš„å‘å±•è®¡åˆ’å’Œæˆ˜ç•¥ï¼ŒåŒ…æ‹¬æ–°äº§å“å‘å¸ƒã€å¸‚åœºæ‰©å±•ç­‰</li><li>è¯„ä¼°å…¨çƒç»æµç¯å¢ƒå’Œç§‘æŠ€è¡Œä¸šçš„æ•´ä½“è¶‹åŠ¿å¯¹è‹¹æœå…¬å¸çš„å½±å“</li><li>ç»¼åˆä»¥ä¸Šä¿¡æ¯ï¼Œé¢„æµ‹è‹¹æœå…¬å¸æœªæ¥äº”å¹´çš„è‚¡ä»·èµ°åŠ¿</li></ol><p></br></p><h2 id="é‡æ–°è®¡åˆ’">é‡æ–°è®¡åˆ’</h2><p>ç»§ç»­åˆ›å»ºä¸€ä¸ªæ­¥éª¤ï¼Œæ ¹æ®ä¸Šä¸€æ­¥çš„ç»“æœé‡æ–°æ‰§è¡Œè®¡åˆ’</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Response</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Response to user.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    response: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Act</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Action to perform.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    action: <span class="type">Union</span>[Response, Plan] = Field(</span><br><span class="line">        description=<span class="string">&quot;Action to perform. If you want to respond to user, use Response. &quot;</span></span><br><span class="line">        <span class="string">&quot;If you need to further use tools to get the answer, use Plan.&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">replanner_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span></span><br><span class="line"><span class="string">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span></span><br><span class="line"><span class="string">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your objective was this:</span></span><br><span class="line"><span class="string">&#123;input&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your original plan was this:</span></span><br><span class="line"><span class="string">&#123;plan&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You have currently done the follow steps:</span></span><br><span class="line"><span class="string">&#123;past_steps&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Update your plan accordingly. If no more steps are needed and you can return to the user, then respond with that. Otherwise, fill out the plan. Only add steps to the plan that still NEED to be done. Do not return previously done steps as part of the plan.&quot;&quot;&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">replanner = replanner_prompt | ChatOpenAI(</span><br><span class="line">    model=<span class="string">&quot;gpt-4o&quot;</span>, temperature=<span class="number">0</span></span><br><span class="line">).with_structured_output(Act)</span><br></pre></td></tr></table></figure><p></br></p><h2 id="åˆ›å»ºæµç¨‹å›¾">åˆ›å»ºæµç¨‹å›¾</h2><p>æœ€åå°†è¿™äº›èŠ‚ç‚¹ç»„è£…èµ·æ¥ã€å®šä¹‰æ¡ä»¶è¾¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">execute_step</span>(<span class="params">state: PlanExecute</span>):</span><br><span class="line">    plan = state[<span class="string">&quot;plan&quot;</span>]</span><br><span class="line">    plan_str = <span class="string">&quot;\n&quot;</span>.join(<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;step&#125;</span>&quot;</span> <span class="keyword">for</span> i, step <span class="keyword">in</span> <span class="built_in">enumerate</span>(plan))</span><br><span class="line">    task = plan[<span class="number">0</span>]</span><br><span class="line">    task_formatted = <span class="string">f&quot;&quot;&quot;For the following plan:</span></span><br><span class="line"><span class="string"><span class="subst">&#123;plan_str&#125;</span>\n\nYou are tasked with executing step <span class="subst">&#123;<span class="number">1</span>&#125;</span>, <span class="subst">&#123;task&#125;</span>.&quot;&quot;&quot;</span></span><br><span class="line">    agent_response = <span class="keyword">await</span> agent_executor.ainvoke(</span><br><span class="line">        &#123;<span class="string">&quot;messages&quot;</span>: [(<span class="string">&quot;user&quot;</span>, task_formatted)]&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;past_steps&quot;</span>: [(task, agent_response[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">plan_step</span>(<span class="params">state: PlanExecute</span>):</span><br><span class="line">    plan = <span class="keyword">await</span> planner.ainvoke(&#123;<span class="string">&quot;messages&quot;</span>: [(<span class="string">&quot;user&quot;</span>, state[<span class="string">&quot;input&quot;</span>])]&#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;plan&quot;</span>: plan.steps&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">replan_step</span>(<span class="params">state: PlanExecute</span>):</span><br><span class="line">    output = <span class="keyword">await</span> replanner.ainvoke(state)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(output.action, Response):</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;response&quot;</span>: output.action.response&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;plan&quot;</span>: output.action.steps&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_end</span>(<span class="params">state: PlanExecute</span>) -&gt; <span class="type">Literal</span>[<span class="string">&quot;agent&quot;</span>, <span class="string">&quot;__end__&quot;</span>]:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;response&quot;</span> <span class="keyword">in</span> state <span class="keyword">and</span> state[<span class="string">&quot;response&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;__end__&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;agent&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph</span><br><span class="line"></span><br><span class="line">workflow = StateGraph(PlanExecute)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the plan node</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;planner&quot;</span>, plan_step)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the execution step</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;agent&quot;</span>, execute_step)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add a replan node</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;replan&quot;</span>, replan_step)</span><br><span class="line"></span><br><span class="line">workflow.set_entry_point(<span class="string">&quot;planner&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># From plan we go to agent</span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;planner&quot;</span>, <span class="string">&quot;agent&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># From agent, we replan</span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;agent&quot;</span>, <span class="string">&quot;replan&quot;</span>)</span><br><span class="line"></span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;replan&quot;</span>,</span><br><span class="line">    <span class="comment"># Next, we pass in the function that will determine which node is called next.</span></span><br><span class="line">    should_end,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finally, we compile it!</span></span><br><span class="line"><span class="comment"># This compiles it into a LangChain Runnable,</span></span><br><span class="line"><span class="comment"># meaning you can use it as you would any other runnable</span></span><br><span class="line">app = workflow.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„æµç¨‹å›¾</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20Plan-and-Execute%20Agent/graph.png" class="" title="graph"><p></br></p><h1 id="ä½¿ç”¨">ä½¿ç”¨</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    config = &#123;<span class="string">&quot;recursion_limit&quot;</span>: <span class="number">20</span>&#125;</span><br><span class="line">    inputs = &#123;</span><br><span class="line">        <span class="string">&quot;input&quot;</span>: <span class="string">&quot;è‹¹æœçš„è‚¡ç¥¨åœ¨æœªæ¥äº”å¹´å†…è¿˜ä¼šç»§ç»­ä¸Šæ¶¨å—?&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> event <span class="keyword">in</span> app.astream(inputs, config=config):</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> event.items():</span><br><span class="line">            <span class="keyword">if</span> k != <span class="string">&quot;__end__&quot;</span>:</span><br><span class="line">                <span class="built_in">print</span>(v)</span><br><span class="line"></span><br><span class="line">asyncio.run(run())</span><br></pre></td></tr></table></figure><p></br></p><h1 id="æ”¹è¿›">æ”¹è¿›</h1><p>ä¸Šé¢å·²ç»æˆåŠŸæ„å»ºå‡ºä¸€ä¸ª Plan-and-Execute Agent</p><p>å®ç°ä¸Šå­˜åœ¨ä¸€ä¸ªå·²çŸ¥é—®é¢˜ï¼Œæ¯ä¸ªä»»åŠ¡ä»ç„¶æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œè¿™æ„å‘³ç€å³ä½¿æŸäº›ä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼ˆå³å®ƒä»¬ä¸ä¾èµ–äºå½¼æ­¤çš„ç»“æœï¼Œå¯ä»¥åŒæ—¶å¼€å§‹ï¼‰ï¼Œä½†ç”±äºè®¾è®¡çš„åŸå› ï¼Œå®ƒä»¬ä»ç„¶è¢«ä¸²è¡Œåœ°æ·»åŠ åˆ°æ€»æ‰§è¡Œæ—¶é—´ä¸­</p><p>å¯ä»¥æ€è€ƒä½¿ç”¨ DAGï¼ˆDirected Acyclic Graphæœ‰å‘æ— ç¯å›¾ï¼‰ï¼Œè€Œä¸æ˜¯å¸¸è§„çš„åˆ—è¡¨æ¥è¡¨ç¤ºä»»åŠ¡çš„ä¸²å¹¶è¡Œå…³ç³»</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangGraph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
            <tag> LangGraph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangGraph - å¿«é€Ÿå¼€å§‹</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»">ä»‹ç»</h1><p>LangGraph æ˜¯ LangChainç¤¾åŒºä¸‹çš„æ–°æ¡†æ¶ï¼Œä¸»è¦ç”¨äºæ„å»º<strong>åŸºäºçŠ¶æ€çš„</strong>ã€<strong>å¤šè¡ŒåŠ¨è€…</strong>çš„LLM åº”ç”¨ï¼Œåº”ç”¨äº Agent å’Œå¤åˆ Agent å·¥ä½œæµ</p><p>æä¾›äº†å¯¹åº”ç”¨ç¨‹åºçš„æµå’ŒçŠ¶æ€çš„ç»†ç²’åº¦æ§åˆ¶</p><aside>ğŸ’¡ å¼€å§‹äº†è§£ Agent å°±åœ¨æ€è€ƒå¦‚ä½•è®¾è®¡å‡ºä¸€ä¸ªé¡¶å±‚çš„æŠ½è±¡ï¼Œèƒ½å¤Ÿè®©ä¸åŒå½¢å¼çš„Agent æ‹¥æœ‰ç»“æ„åŒ–çš„æ„å»ºå½¢å¼ï¼Œå› ä¸ºä¸åŒçš„ Agent åœ¨æµç¨‹ä¸Šå·®å¼‚æŒºå¤§ç°åœ¨çœ‹èµ·æ¥ï¼ŒLangGraph çš„ç›®çš„å°±æ˜¯è¦åšåˆ°è¿™ç§æŠ½è±¡</aside><p></br></p><p>å…¶æ ¸å¿ƒåŠŸèƒ½</p><ul><li>å¾ªç¯å’Œåˆ†æ”¯ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­å®ç°å¾ªç¯å’Œæ¡ä»¶</li><li>æŒç»­ï¼šæ¯ä¸ªæ­¥éª¤åè‡ªåŠ¨ä¿å­˜çŠ¶æ€ï¼Œéšæ—¶æš‚åœã€æ¢å¤æµç¨‹å›¾æ‰§è¡Œ</li><li>äººå·¥å¾ªç¯ï¼šä¸­æ–­æµç¨‹å›¾æ‰§è¡Œä»¥æ‰¹å‡†æˆ–ç¼–è¾‘ä»£ç†è®¡åˆ’çš„ä¸‹ä¸€ä¸ªæ“ä½œ</li><li>æµå¼ä¼ è¾“æ”¯æŒï¼šæµå¼ä¼ è¾“æ¯ä¸ªèŠ‚ç‚¹äº§ç”Ÿçš„è¾“å‡ºï¼ˆåŒ…æ‹¬ä»¤ç‰Œæµï¼‰</li><li>å’Œ LangChain é›†æˆï¼šå’Œ LangChain åŠ LangSmith æ— ç¼é›†æˆ</li></ul><p></br></p><p>å®ç°ä¸€ä¸ªæµç¨‹å›¾çš„æ­¥éª¤</p><ol type="1"><li>åˆå§‹åŒ– LLM å’Œå·¥å…·</li><li>åˆå§‹åŒ–æµç¨‹å›¾ä¸­çš„çŠ¶æ€ï¼ˆstateï¼‰</li><li>å®šä¹‰æµç¨‹å›¾çš„èŠ‚ç‚¹ï¼ˆnodeï¼‰</li><li>å®šä¹‰æµç¨‹å›¾çš„é¡¶ç‚¹ï¼ˆentry pointï¼‰å’Œè¾¹ï¼ˆgraphï¼‰</li><li>æ„å»ºï¼ˆcompileï¼‰æµç¨‹å›¾</li><li>æ‰§è¡Œ</li></ol><h1 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</h1><p>è¿™é‡Œä½¿ç”¨å®˜æ–¹æ–‡æ¡£ä¸­çš„ <strong>Tutorials -Introduction</strong>Â å†…å®¹ï¼Œæ¥ç®€å•ä»‹ç» LangGraphçš„ä½¿ç”¨ï¼Œä¸ªåˆ«åœ°æ–¹ä¼šè¿›è¡Œä¿®æ”¹</p><p>è¿™é‡Œåªè®°å½•ä»£ç éƒ¨åˆ†ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­çš„ç»†èŠ‚è§£é‡Šã€éªŒè¯ã€LangSmithä¸Šçš„æ—¥å¿—è§‚å¯Ÿç­‰å†…å®¹å› ä¸ºå¤ªå¤šï¼Œå¯ä»¥ç›´æ¥å‚è€ƒå®˜æ–¹æ–‡æ¡£</p><p>åœ¨å¿«é€Ÿå¼€å§‹ä¸­å°†ä¼šåŸºäº LangGraph æ„å»ºä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œå®ƒèƒ½å¤Ÿï¼š</p><ul><li>é€šè¿‡æœç´¢ç½‘ç»œå›ç­”å¸¸è§é—®é¢˜</li><li>åœ¨é€šè¯ä¸­ä¿æŒé€šè¯çŠ¶æ€</li><li>å°†å¤æ‚çš„æŸ¥è¯¢å‘é€ç»™äººç±»è¿›è¡Œå®¡æŸ¥</li><li>ä½¿ç”¨è‡ªå®šä¹‰çŠ¶æ€æ§åˆ¶å…¶è¡Œä¸º</li><li>å›æ”¾å¹¶æ¢ç´¢å…¶ä»–å¯¹è¯è·¯å¾„</li></ul><p>å°†ä»ä¸€ä¸ªåŸºæœ¬çš„èŠå¤©æœºå™¨äººå¼€å§‹ï¼Œé€æ­¥æ·»åŠ æ›´å¤æ‚çš„åŠŸèƒ½ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¼•å…¥å…³é”®çš„LangGraph æ¦‚å¿µ</p><p></br></p><h2 id="é…ç½®">é…ç½®</h2><p>å®‰è£…ç›¸åº”çš„åŒ…ï¼ˆLangChain å°±ä¸åœ¨è¿™é‡Œåˆ—ä¸¾äº†ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -U langgraph langsmith</span><br></pre></td></tr></table></figure><p>è®¾ç½®å¯¹åº”çš„ API keyï¼›è¿™é‡Œæˆ‘æ²¡æœ‰ä½¿ç”¨å®˜æ–¹æ•™ç¨‹é‡Œçš„<code>langchain_anthropic</code> ï¼Œç›´æ¥ä½¿ç”¨çš„ LangChain ä¸­çš„<code>AzureChatOpenAI</code></p><p>æ‰€ä»¥è¿™é‡Œè®¤ä¸ºåªéœ€è¦é…ç½® LangSmith ç›¸å…³çš„ key å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os.environ[<span class="string">&quot;ANTHROPIC_API_KEY&quot;</span>] = <span class="string">&quot;&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;LANGCHAIN_TRACING_V2&quot;</span>] = <span class="string">&quot;true&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;LANGCHAIN_PROJECT&quot;</span>] = <span class="string">&quot;LangGraph Tutorial&quot;</span></span><br></pre></td></tr></table></figure><p></br></p><h2 id="part.1-æ„å»ºä¸€ä¸ªåŸºç¡€çš„èŠå¤©æœºå™¨äºº">Part.1æ„å»ºä¸€ä¸ªåŸºç¡€çš„èŠå¤©æœºå™¨äºº</h2><h3 id="çŠ¶æ€æœº">çŠ¶æ€æœº</h3><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>StateGraph</code> ï¼Œä¸€ä¸ª <code>StateGraph</code>å¯¹è±¡ä¼šå°†èŠå¤©æœºå™¨äººçš„ç»“æ„å®šä¹‰ä¸ºçŠ¶æ€æœº</p><p>æˆ‘ä»¬å°†æ·»åŠ èŠ‚ç‚¹æ¥è¡¨ç¤º LLMå¯ä»¥è°ƒç”¨çš„å‡½æ•°ï¼Œå¹¶æ·»åŠ è¾¹æ¥æŒ‡å®šæœºå™¨äººåº”è¯¥å¦‚ä½•åœ¨è¿™äº›å‡½æ•°ä¹‹é—´è½¬æ¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph</span><br><span class="line"><span class="keyword">from</span> langgraph.graph.message <span class="keyword">import</span> add_messages</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="comment"># Messages have the type &quot;list&quot;. The `add_messages` function</span></span><br><span class="line">    <span class="comment"># in the annotation defines how this state key should be updated</span></span><br><span class="line">    <span class="comment"># (in this case, it appends messages to the list, rather than overwriting them)</span></span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>, add_messages]</span><br><span class="line"></span><br><span class="line">graph_builder = StateGraph(State)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª <code>TypedDict</code> ï¼Œå®ƒåªæœ‰ä¸€ä¸ª key<code>messages</code> ï¼Œ<code>messages</code> ä½¿ç”¨<code>add_messages</code> å‡½æ•°è¿›è¡Œæ³¨é‡Šï¼Œè¯¥å‡½æ•°å‘Šè¯‰ LangGraphå°†æ–°æ¶ˆæ¯æ·»åŠ åˆ°ç°æœ‰åˆ—è¡¨ä¸­ï¼Œè€Œä¸æ˜¯è¿›è¡Œè¦†ç›–</p><p>ç°åœ¨æˆ‘ä»¬çš„æµç¨‹å›¾çŸ¥é“ä¸¤ä»¶äº‹ï¼š</p><ol type="1"><li>æˆ‘ä»¬å®šä¹‰çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å°†æ¥æ”¶å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›æ›´æ–°è¯¥çŠ¶æ€çš„å€¼</li><li>æ¶ˆæ¯å°†é™„åŠ åˆ°å½“å‰åˆ—è¡¨ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥è¦†ç›–ã€‚è¿™æ˜¯é€šè¿‡æ³¨é‡Šè¯­æ³•ä¸­é¢„å…ˆæ„å»ºçš„<code>add_messages</code> å‡½æ•°è¿›è¡Œè®¾ç½®çš„</li></ol><h3 id="èŠå¤©æœºå™¨äººèŠ‚ç‚¹">èŠå¤©æœºå™¨äººèŠ‚ç‚¹</h3><p>èŠ‚ç‚¹ä»£è¡¨å·¥ä½œå•å…ƒï¼Œå®ƒä»¬é€šå¸¸æ˜¯å¸¸è§„çš„ python å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_anthropic <span class="keyword">import</span> ChatAnthropic</span><br><span class="line"><span class="keyword">import</span> Azure</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯æˆ‘çš„å®ç°</span></span><br><span class="line"><span class="comment"># åªè¦æä¾›å‡ºä¸€ä¸ª LLM å³å¯</span></span><br><span class="line">llm = Azure.chat_model_4o</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chatbot</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [llm.invoke(state[<span class="string">&quot;messages&quot;</span>])]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The first argument is the unique node name</span></span><br><span class="line"><span class="comment"># The second argument is the function or object that will be called whenever</span></span><br><span class="line"><span class="comment"># the node is used.</span></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;chatbot&quot;</span>, chatbot)</span><br></pre></td></tr></table></figure><p><code>chatbot</code> èŠ‚ç‚¹åŠŸèƒ½å¦‚ä½•å°†å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥å¹¶è¿”å›æ›´æ–°çš„<code>messages</code>ï¼Œè¿™æ˜¯æ‰€æœ‰ LangGraph èŠ‚ç‚¹å‡½æ•°çš„åŸºæœ¬æ¨¡å¼</p><p>æˆ‘ä»¬çš„ <code>State</code> ä¸­çš„ <code>add_messages</code> å‡½æ•°å°†æŠŠ LLMçš„å“åº”æ¶ˆæ¯é™„åŠ åˆ°è¯¥çŠ¶æ€ä¸­å·²ç»å­˜åœ¨çš„ä»»ä½•æ¶ˆæ¯ä¸Š</p><h3 id="æ·»åŠ é¡¶ç‚¹">æ·»åŠ é¡¶ç‚¹</h3><p>æ¥ä¸‹æ¥ï¼Œæ·»åŠ ä¸€ä¸ªå…¥å£ç‚¹<code>entry</code>ï¼Œè¿™å‘Šè¯‰æˆ‘ä»¬çš„æµç¨‹å›¾æ¯æ¬¡è¿è¡Œæ—¶ä»å“ªé‡Œå¼€å§‹å·¥ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph_builder.set_entry_point(<span class="string">&quot;chatbot&quot;</span>)</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„æ·»åŠ ä¸€ä¸ªç»ˆç‚¹ <code>finish</code>ï¼Œè¿™æŒ‡ç¤ºæµç¨‹å›¾ <strong>any timethis node is run, you can exit.</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph_builder.set_finish_point(<span class="string">&quot;chatbot&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="æ„å»º">æ„å»º</h3><p>æœ€åèƒ½å¤Ÿè¿è¡Œæˆ‘ä»¬çš„å›¾ï¼Œåœ¨å›¾å½¢ç”Ÿæˆå™¨ä¸Šè°ƒç”¨ <code>compile</code></p><p>è¿™å°†åˆ›å»ºä¸€ä¸ª <code>CompiledGraph</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œ<code>invoke</code> è°ƒç”¨äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph = graph_builder.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„æµç¨‹å›¾ç»“æ„åº”è¯¥ä¸º</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/1.png" class="" title="Untitled"><h3 id="run">Run</h3><p>æœ€åä½¿ç”¨ <code>invoke</code> æˆ– <code>stream</code> æ–¹æ³•è¿›è¡Œæ‰§è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    user_input = <span class="built_in">input</span>(<span class="string">&quot;User: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> user_input.lower() <span class="keyword">in</span> [<span class="string">&quot;quit&quot;</span>, <span class="string">&quot;exit&quot;</span>, <span class="string">&quot;q&quot;</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Goodbye!&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> event <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;messages&quot;</span>: (<span class="string">&quot;user&quot;</span>, user_input)&#125;):</span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> event.values():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Assistant:&quot;</span>, value[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br></pre></td></tr></table></figure><p></br></p><h2 id="part.2-ä½¿ç”¨å·¥å…·å¢å¼º">Part.2 ä½¿ç”¨å·¥å…·å¢å¼º</h2><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç»´åŸºç™¾ç§‘çš„æŸ¥è¯¢å·¥å…·</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.tools <span class="keyword">import</span> WikipediaQueryRun</span><br><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> WikipediaAPIWrapper</span><br><span class="line"></span><br><span class="line">wikipedia = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())</span><br><span class="line">tools = [wikipedia]</span><br></pre></td></tr></table></figure><h3 id="llm-ç»‘å®šå·¥å…·">LLM ç»‘å®šå·¥å…·</h3><p>æˆ‘ä»¬éœ€è¦å°†å·¥å…·å…ˆå’Œ LLM ç»‘å®šï¼Œå³å°†å·¥å…·è°ƒç”¨ä»¥ JSON schema çš„æ–¹å¼è¯·æ±‚LLM</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model = Azure.chat_model_4o</span><br><span class="line">llm = model.bind_tools(tools)</span><br></pre></td></tr></table></figure><h3 id="å®šä¹‰-tool-èŠ‚ç‚¹">å®šä¹‰ Tool èŠ‚ç‚¹</h3><p>è¿™é‡Œå°†è‡ªå·±å®ç°ä¸€ä¸ªå¯¹å·¥å…·æ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œå…¶å®è¿™ä¸ªæ“ä½œ LangGraphæ˜¯æœ‰é¢„å…ˆæ„å»ºå¥½çš„å®ç°çš„ï¼Œä½†æ˜¯è¿™é‡Œæ–‡æ¡£ä¸ºäº†è®©å…¶æ·±å…¥äº†è§£åŸç†ï¼Œå…ˆæ‰‹åŠ¨å®ç°ï¼Œåé¢ä¼šè¿›è¡Œæ›¿æ¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> ToolMessage</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasicToolNode</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A node that runs the tools requested in the last AIMessage.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, tools: <span class="built_in">list</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.tools_by_name = &#123;tool.name: tool <span class="keyword">for</span> tool <span class="keyword">in</span> tools&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, inputs: <span class="built_in">dict</span></span>):</span><br><span class="line">        <span class="keyword">if</span> messages := inputs.get(<span class="string">&quot;messages&quot;</span>, []):</span><br><span class="line">            message = messages[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;No message found in input&quot;</span>)</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> tool_call <span class="keyword">in</span> message.tool_calls:</span><br><span class="line">            tool_result = self.tools_by_name[tool_call[<span class="string">&quot;name&quot;</span>]].invoke(</span><br><span class="line">                tool_call[<span class="string">&quot;args&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">            outputs.append(</span><br><span class="line">                ToolMessage(</span><br><span class="line">                    content=json.dumps(tool_result),</span><br><span class="line">                    name=tool_call[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">                    tool_call_id=tool_call[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: outputs&#125;</span><br><span class="line"></span><br><span class="line">tool_node = BasicToolNode(tools=[tool])</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;tools&quot;</span>, tool_node)</span><br></pre></td></tr></table></figure><p>å®ç°çš„åŸºæœ¬é€»è¾‘æ˜¯ï¼Œä»å…¥å‚ä¸­è·å–æ¶ˆæ¯ï¼Œè·å–æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œå–å‡º<code>tool_calls</code> çš„å†…å®¹åè¿›è¡Œè°ƒç”¨</p><h3 id="å®šä¹‰æ¡ä»¶è¾¹">å®šä¹‰æ¡ä»¶è¾¹</h3><p>å½“å®šä¹‰äº†èŠ‚ç‚¹åï¼Œæ¥ä¸‹æ¥éœ€è¦å®šä¹‰ <code>conditional_edges</code></p><p>è¾¹å°†æ§åˆ¶æµä»ä¸€ä¸ªèŠ‚ç‚¹è·¯ç”±åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™äº›å‡½æ•°æ¥æ”¶å½“å‰å›¾å½¢çŠ¶æ€ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‡ç¤ºä¸‹ä¸€ä¸ªè°ƒç”¨å“ªä¸ªèŠ‚ç‚¹</p><p>ä¸‹é¢ä¼šå®šä¹‰ä¸€ä¸ªè·¯ç”±å™¨å‡½æ•°ï¼Œç”¨äºæ£€æŸ¥èŠå¤©æœºå™¨äººçš„è¾“å‡ºä¸­çš„<code>tool_calls</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">route_tools</span>(<span class="params"></span></span><br><span class="line"><span class="params">    state: State,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Literal</span>[<span class="string">&quot;tools&quot;</span>, <span class="string">&quot;__end__&quot;</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Use in the conditional_edge to route to the ToolNode if the last message</span></span><br><span class="line"><span class="string">    has tool calls. Otherwise, route to the end.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(state, <span class="built_in">list</span>):</span><br><span class="line">        ai_message = state[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">elif</span> messages := state.get(<span class="string">&quot;messages&quot;</span>, []):</span><br><span class="line">        ai_message = messages[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;No messages found in input state to tool_edge: <span class="subst">&#123;state&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(ai_message, <span class="string">&quot;tool_calls&quot;</span>) <span class="keyword">and</span> <span class="built_in">len</span>(ai_message.tool_calls) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;tools&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;__end__&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The `tools_condition` function returns &quot;tools&quot; if the chatbot asks to use a tool, and &quot;__end__&quot; if</span></span><br><span class="line"><span class="comment"># it is fine directly responding. This conditional routing defines the main agent loop.</span></span><br><span class="line">graph_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;chatbot&quot;</span>,</span><br><span class="line">    route_tools,</span><br><span class="line">    <span class="comment"># The following dictionary lets you tell the graph to interpret the condition&#x27;s outputs as a specific node</span></span><br><span class="line">    <span class="comment"># It defaults to the identity function, but if you</span></span><br><span class="line">    <span class="comment"># want to use a node named something else apart from &quot;tools&quot;,</span></span><br><span class="line">    <span class="comment"># You can update the value of the dictionary to something else</span></span><br><span class="line">    <span class="comment"># e.g., &quot;tools&quot;: &quot;my_tools&quot;</span></span><br><span class="line">    &#123;<span class="string">&quot;tools&quot;</span>: <span class="string">&quot;tools&quot;</span>, <span class="string">&quot;__end__&quot;</span>: <span class="string">&quot;__end__&quot;</span>&#125;,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># Any time a tool is called, we return to the chatbot to decide the next step</span></span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;tools&quot;</span>, <span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">graph_builder.set_entry_point(<span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è¿›è¡Œä»»ä½•å·¥å…·è°ƒç”¨ï¼Œæˆ‘ä»¬çš„å‡½æ•°å°†è¿”å› <code>__end__</code>å­—ç¬¦ä¸²ï¼Œå½“æµç¨‹å›¾éœ€è¦åˆ‡æ¢åˆ° <code>__end__</code>æ—¶ï¼Œå®ƒæ²¡æœ‰å…¶ä»–ä»»åŠ¡è¦å®Œæˆï¼Œæ‰€ä»¥åœæ­¢æ‰§è¡Œ</p><p>å› ä¸ºæ¡ä»¶å¯ä»¥è¿”å› <code>__end__</code>ï¼Œæ‰€ä»¥è¿™æ¬¡ä¸éœ€è¦æ˜¾å¼è®¾ç½®<code>finish_point</code></p><p>æœ€ç»ˆçš„æµç¨‹å›¾åº”è¯¥ä¸º</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/2.png" class="" title="Untitled"><p></br></p><h2 id="part.3-æ·»åŠ è®°å¿†">Part.3 æ·»åŠ è®°å¿†</h2><p>ä¸Šé¢å®ç°çš„æµç¨‹å›¾å…¶è°ƒç”¨éƒ½æ˜¯æ— çŠ¶æ€çš„</p><p>LangGraph é€šè¿‡æŒä¹…çš„æ£€æŸ¥ç‚¹ï¼ˆpersistentcheckpointingï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦æä¾›ä¸€ä¸ª <code>checkpointer</code>å¹¶ä¸”åœ¨è°ƒç”¨æ—¶æä¾› <code>thread_id</code></p><p>checkpointingæ¯”è®°å¿†æ›´åŠ å¼ºå¤§ï¼Œå®ƒå¯ä»¥å®ç°éšæ—¶ä¿å­˜å’Œæ¢å¤å¤æ‚çš„çŠ¶æ€ï¼Œç”¨äºé”™è¯¯æ¢å¤ã€äººå·¥å¾ªç¯å·¥ä½œæµã€æ—¶é—´æ—…è¡Œäº¤äº’ç­‰</p><h3 id="åˆ›å»º-sqlitesaver-æ£€æŸ¥ç‚¹">åˆ›å»º SqliteSaver æ£€æŸ¥ç‚¹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.checkpoint.sqlite <span class="keyword">import</span> SqliteSaver</span><br><span class="line"></span><br><span class="line">memory = SqliteSaver.from_conn_string(<span class="string">&quot;:memory:&quot;</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿå¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å®ç°</p><h3 id="æä¾›-checkpointer-ç¼–è¯‘">æä¾› checkpointer ç¼–è¯‘</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„è¿™é‡Œçš„ checkpointer å…¥å‚</span></span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>(checkpointer=memory)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æµç¨‹å›¾åº”è¯¥ä¸º</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/3.png" class="" title="Untitled"><h3 id="run-1">Run</h3><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œè°ƒç”¨æ—¶éœ€è¦ä¼ å‚ <code>thread_id</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The only difference is we change the `thread_id` here to &quot;2&quot; instead of &quot;1&quot;</span></span><br><span class="line">events = graph.stream(</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [(<span class="string">&quot;user&quot;</span>, user_input)]&#125;,</span><br><span class="line">    <span class="comment"># here</span></span><br><span class="line">    &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;2&quot;</span>&#125;&#125;,</span><br><span class="line">    stream_mode=<span class="string">&quot;values&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure><h3 id="get-state">get state</h3><p>å¯ä»¥é€šè¿‡ <code>config</code> éšæ—¶æ£€æŸ¥ç»™å®šé…ç½®çš„æµç¨‹å›¾çŠ¶æ€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">snapshot = graph.get_state(config)</span><br><span class="line">snapshot</span><br><span class="line">snapshot.<span class="built_in">next</span>  <span class="comment"># (since the graph ended this turn, `next` is empty. If you fetch a state from within a graph invocation, next tells which node will execute next)</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å¿«ç…§åŒ…å«å½“å‰çŠ¶æ€å€¼ã€ç›¸åº”çš„é…ç½®ä»¥åŠè¦å¤„ç†çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</p><p>åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæµç¨‹å›¾å·²ç»è¾¾åˆ° <code>__end__</code> çŠ¶æ€ï¼Œæ‰€ä»¥<code>next</code> ä¸ºç©º</p><p></br></p><h2 id="part.4-å¾ªç¯ä¸­äººç±»ä»‹å…¥">Part.4 å¾ªç¯ä¸­äººç±»ä»‹å…¥</h2><p>ä»£ç†å¹¶ä¸å®Œå…¨å¯é ï¼Œæ‰€ä»¥åœ¨æŸäº›èŠ‚ç‚¹éœ€è¦äººå·¥ä»‹å…¥</p><p>LangGraph æä¾›äº†å¤šç§æ–¹å¼æ”¯æŒäººå·¥å¾ªç¯å·¥ä½œæµ<code>human-in-the-loop</code>ï¼Œåœ¨æœ¬èŠ‚ä¸­å°†ä½¿ç”¨ LangGraph çš„<code>interrupt_before</code> åŠŸèƒ½æ¥å§‹ç»ˆä¸­æ–­å·¥å…·èŠ‚ç‚¹</p><h3 id="å‰ä¸­æ–­æ„å»º">å‰ä¸­æ–­æ„å»º</h3><p>ç¼–è¯‘æµç¨‹å›¾ï¼ŒæŒ‡å®šåœ¨æ“ä½œèŠ‚ç‚¹ä¹‹å‰ä¸­æ–­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph = graph_builder.<span class="built_in">compile</span>(</span><br><span class="line">    checkpointer=memory,</span><br><span class="line">    <span class="comment"># This is new!</span></span><br><span class="line">    interrupt_before=[<span class="string">&quot;tools&quot;</span>],</span><br><span class="line">    <span class="comment"># Note: can also interrupt __after__ actions, if desired.</span></span><br><span class="line">    <span class="comment"># interrupt_after=[&quot;tools&quot;]</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user_input = <span class="string">&quot;I&#x27;m learning LangGraph. Could you do some research on it for me?&quot;</span></span><br><span class="line">config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;&#125;</span><br><span class="line"><span class="comment"># The config is the **second positional argument** to stream() or invoke()!</span></span><br><span class="line">events = graph.stream(</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [(<span class="string">&quot;user&quot;</span>, user_input)]&#125;, config, stream_mode=<span class="string">&quot;values&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">in</span> event:</span><br><span class="line">        event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure><p>è·å–ä¸‹çŠ¶æ€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">snapshot = graph.get_state(config)</span><br><span class="line">snapshot.<span class="built_in">next</span></span><br><span class="line"><span class="comment"># (&#x27;action&#x27;,)</span></span><br></pre></td></tr></table></figure><p>ä¸åŒäºä¹‹å‰ï¼Œè¿™æ¬¡ä¸‹ä¸€ä¸ªçŠ¶æ€ä¸º<code>action</code>ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‹¦æˆªåœ¨äº†å·¥å…·æ‰§è¡Œä¹‹å‰</p><h3 id="ç»§ç»­">ç»§ç»­</h3><p>æ¥ä¸‹æ¥ç»§ç»­æµç¨‹</p><p>ä¼ å…¥ Noneåªä¼šè®©æµç¨‹ç»§ç»­ä»åœæ­¢çš„ä½ç½®è¿›è¡Œï¼Œä¸ä¼šå‘çŠ¶æ€æ·»åŠ ä»»ä½•æ–°å†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># `None` will append nothing new to the current state, letting it resume as if it had never been interrupted</span></span><br><span class="line">events = graph.stream(<span class="literal">None</span>, config, stream_mode=<span class="string">&quot;values&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">in</span> event:</span><br><span class="line">        event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå®ç°äº†ä½¿ç”¨äº†ä¸€ä¸ªä¸­æ–­å°†äººå·¥åœ¨ç¯æ‰§è¡Œæ·»åŠ åˆ°èŠå¤©æœºå™¨äººä¸­</p><p>å…è®¸åœ¨éœ€è¦æ—¶è¿›è¡Œäººå·¥ç›‘ç£å’Œå¹²é¢„ï¼Œæ·»åŠ äº†ä¸€ä¸ªæ£€æŸ¥æŒ‡é’ˆï¼Œæµç¨‹å›¾å¯ä»¥æ— é™æœŸåœ°æš‚åœï¼Œå¹¶åœ¨ä»»ä½•æ—¶å€™æ¢å¤ï¼Œå°±åƒä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿä¸€æ ·</p><p></br></p><h2 id="part.5-æ‰‹åŠ¨æ›´æ–°çŠ¶æ€">Part.5 æ‰‹åŠ¨æ›´æ–°çŠ¶æ€</h2><p>ä¸Šé¢äººç±»ä¸­æ–­æ—¶ï¼Œé€‰æ‹©ç»§ç»­æ‰§è¡Œï¼›ä¸‹é¢éœ€è¦æ¥å®ç°å¦‚æœå¸Œæœ›å¯¹è¿‡ç¨‹è¿›è¡Œä¿®æ”¹ã€ä¸è¿›è¡Œå·¥å…·æ‰§è¡Œè¯¥å¦‚ä½•å®ç°</p><p>é€šè¿‡æ‰‹åŠ¨æ›´æ–°çŠ¶æ€ï¼Œå¯ä»¥å®ç°çº æ­£ Agent çš„é”™è¯¯ã€æ¢ç´¢æ›¿ä»£è·¯å¾„ã€å¼•å¯¼ Agentå®ç°ç‰¹å®šç›®æ ‡ç­‰</p><h3 id="ç›´æ¥æä¾›æ­£ç¡®çš„å›åº”">ç›´æ¥æä¾›æ­£ç¡®çš„å›åº”</h3><p>å’Œä¸Šä¸€ä¸ªæµç¨‹ä¸€è‡´ï¼Œå½“æˆ‘ä»¬é€šè¿‡æ£€æŸ¥ç‚¹æš‚åœåˆ°è°ƒç”¨å·¥å…·ä¹‹å‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">snapshot = graph.get_state(config)</span><br><span class="line">existing_message = snapshot.values[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line">existing_message.pretty_print()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">================================== Ai Message ==================================</span><br><span class="line"></span><br><span class="line">[&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;toolu_01DTyDpJ1kKdNps5yxv3AGJd&#x27;</span>, <span class="string">&#x27;input&#x27;</span>: &#123;<span class="string">&#x27;query&#x27;</span>: <span class="string">&#x27;LangGraph&#x27;</span>&#125;, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;tavily_search_results_json&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;tool_use&#x27;</span>&#125;]</span><br><span class="line">Tool Calls:</span><br><span class="line">  tavily_search_results_json (toolu_01DTyDpJ1kKdNps5yxv3AGJd)</span><br><span class="line"> Call ID: toolu_01DTyDpJ1kKdNps5yxv3AGJd</span><br><span class="line">  Args:</span><br><span class="line">    query: LangGraph</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¾ç¤ºçš„æ¶ˆæ¯åœ¨å·¥å…·è°ƒç”¨ä¹‹å‰ï¼ˆTool Callsï¼‰</p><p>æ¥ä¸‹æ¥æä¾›æŒ‡å®šå›ç­”</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> AIMessage</span><br><span class="line"></span><br><span class="line">answer = (</span><br><span class="line">    <span class="string">&quot;LangGraph is an apple.&quot;</span></span><br><span class="line">)</span><br><span class="line">new_messages = [</span><br><span class="line">    <span class="comment"># The LLM API expects some ToolMessage to match its tool call. We&#x27;ll satisfy that here.</span></span><br><span class="line">    ToolMessage(content=answer, tool_call_id=existing_message.tool_calls[<span class="number">0</span>][<span class="string">&quot;id&quot;</span>]),</span><br><span class="line">    <span class="comment"># And then directly &quot;put words in the LLM&#x27;s mouth&quot; by populating its response.</span></span><br><span class="line">    AIMessage(content=answer),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">new_messages[-<span class="number">1</span>].pretty_print()</span><br><span class="line">graph.update_state(</span><br><span class="line">    <span class="comment"># Which state to update</span></span><br><span class="line">    config,</span><br><span class="line">    <span class="comment"># The updated values to provide. The messages in our `State` are &quot;append-only&quot;, meaning this will be appended</span></span><br><span class="line">    <span class="comment"># to the existing state. We will review how to update existing messages in the next section!</span></span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: new_messages&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n\nLast 2 messages;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(graph.get_state(config).values[<span class="string">&quot;messages&quot;</span>][-<span class="number">2</span>:])</span><br></pre></td></tr></table></figure><p>è¿™æ—¶æˆ‘ä»¬å†æ‹¿åˆ°<code>messages</code>ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆç»“æœå°±æ˜¯æˆ‘ä»¬å®šä¹‰å¥½çš„å†…å®¹</p><h3 id="ä¸ºä»€ä¹ˆæ˜¯-append">ä¸ºä»€ä¹ˆæ˜¯ append</h3><p>ä¸Šé¢çš„æµç¨‹ä¼šè¡ç”Ÿå‡ºä¸€ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ çš„æ–°æ¶ˆæ¯ä¸ºä»€ä¹ˆä¼šè¢«è¿½åŠ åˆ°å·²ç»å­˜åœ¨çŠ¶æ€ä¸­çš„æ¶ˆæ¯å</p><p>å› ä¸ºä¸€å¼€å§‹å°±æ˜¯è¿™æ ·å®šä¹‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>, add_messages]</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å®ç°é«˜é€Ÿæµç¨‹å›¾å§‹ç»ˆå°†å€¼ appendåˆ°ç°æœ‰åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ç›´æ¥è¦†ç›–åˆ—è¡¨</p><p>è¿™é‡Œåº”ç”¨äº†ç›¸åŒçš„é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ é€’ç»™ <code>update_state</code>çš„æ¶ˆæ¯æ˜¯ä»¥ç›¸åŒçš„æ–¹å¼é™„åŠ çš„</p><h3 id="ä»¥å“ªä¸ªèŠ‚ç‚¹çš„åä¹‰">ä»¥å“ªä¸ªèŠ‚ç‚¹çš„åä¹‰</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>update_state</code> ä½¿ç”¨ä¸Šæ¬¡æ‰§è¡Œçš„èŠ‚ç‚¹</p><p>ä¹Ÿå¯ä»¥é€šè¿‡ä¼ å‚æ–¹å¼å‘Šè¯‰æµç¨‹å›¾æ›´æ–°æ¥è‡ªå“ªä¸ªèŠ‚ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph.update_state(</span><br><span class="line">    config,</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [AIMessage(content=<span class="string">&quot;I&#x27;m an AI expert!&quot;</span>)]&#125;,</span><br><span class="line">    <span class="comment"># Which node for this function to act as. It will automatically continue</span></span><br><span class="line">    <span class="comment"># processing as if this node just ran.</span></span><br><span class="line">    as_node=<span class="string">&quot;chatbot&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/4.png" class="" title="Untitled"><p>å†æ¥çœ‹ä¸€æ¬¡æµç¨‹å›¾ï¼Œå¦‚æœæˆ‘ä»¬ä»¥ <code>chatbot</code>çš„åä¹‰æ›´æ–°äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ ¹æ®æµç¨‹å›¾ï¼Œæ•´ä¸ªæµç¨‹å°±ä¼šç›´æ¥ç»“æŸ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">snapshot = graph.get_state(config)</span><br><span class="line"><span class="built_in">print</span>(snapshot.values[<span class="string">&quot;messages&quot;</span>][-<span class="number">3</span>:])</span><br><span class="line"><span class="built_in">print</span>(snapshot.<span class="built_in">next</span>) <span class="comment"># ()</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹çŠ¶æ€å¯ä»¥å‘ç°ï¼Œå†å²æ¶ˆæ¯ä¸­ä¸ä¼šæœ‰å·¥å…·è°ƒç”¨çš„è®°å½•</p><h3 id="è¦†ç›–ç°æœ‰æ¶ˆæ¯">è¦†ç›–ç°æœ‰æ¶ˆæ¯</h3><p>å¯ä»¥é€šè¿‡ message ä¸Šçš„ id æ¥è¦†ç›–å·²æœ‰æ¶ˆæ¯</p><p>åœ¨å·¥å…·æ‰§è¡Œå‰çš„è§‚å¯Ÿç‚¹è¿›è¡Œæš‚åœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> AIMessage</span><br><span class="line"></span><br><span class="line">snapshot = graph.get_state(config)</span><br><span class="line">existing_message = snapshot.values[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Original&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Message ID&quot;</span>, existing_message.<span class="built_in">id</span>)</span><br><span class="line"><span class="built_in">print</span>(existing_message.tool_calls[<span class="number">0</span>])</span><br><span class="line">new_tool_call = existing_message.tool_calls[<span class="number">0</span>].copy()</span><br><span class="line">new_tool_call[<span class="string">&quot;args&quot;</span>][<span class="string">&quot;query&quot;</span>] = <span class="string">&quot;Where is China?&quot;</span></span><br><span class="line">new_message = AIMessage(</span><br><span class="line">    content=existing_message.content,</span><br><span class="line">    tool_calls=[new_tool_call],</span><br><span class="line">    <span class="comment"># Important! The ID is how LangGraph knows to REPLACE the message in the state rather than APPEND this messages</span></span><br><span class="line">    <span class="built_in">id</span>=existing_message.<span class="built_in">id</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Updated&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(new_message.tool_calls[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Message ID&quot;</span>, new_message.<span class="built_in">id</span>)</span><br><span class="line">graph.update_state(config, &#123;<span class="string">&quot;messages&quot;</span>: [new_message]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n\nTool calls&quot;</span>)</span><br><span class="line">graph.get_state(config).values[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].tool_calls</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ„é€ äº†ä¸€ä¸ªæ–°çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯ï¼Œé€šè¿‡ <code>update_state</code>è¿›è¡Œè¦†ç›–</p><p>æ³¨æ„å¦‚æœéœ€è¦è¦†ç›– tool calls æ¶ˆæ¯ï¼Œéœ€è¦ä¿è¯ id ä¸€è‡´ï¼Œå³ä¸Šè¿°ä»£ç ä¸­çš„<code>existing_message.id</code></p><p>æ¥ä¸‹æ¥ç»§ç»­æµç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">events = graph.stream(<span class="literal">None</span>, config, stream_mode=<span class="string">&quot;values&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">in</span> event:</span><br><span class="line">        event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œä¼šå‘ç°å½“æ‰§è¡Œäº†è¦†ç›–çš„å·¥å…·è°ƒç”¨åï¼Œåˆåˆ°äº†æ–°çš„å·¥å…·è°ƒç”¨ï¼ˆå› ä¸º LLMæ ¹æ®ä¸Šä¸‹æ–‡å‘ç°æ²¡æœ‰æŸ¥è¯¢éœ€è¦æŸ¥è¯¢çš„é—®é¢˜ï¼‰</p><p>ä½†æ˜¯æˆ‘ä»¬è¦†ç›–çš„æ¶ˆæ¯å·²ç»è¢«æˆåŠŸåŠ å…¥æµç¨‹ä¸­äº†</p><p></br></p><h2 id="part.6-è‡ªå®šä¹‰çŠ¶æ€">Part.6 è‡ªå®šä¹‰çŠ¶æ€</h2><p>ä¸Šè¿°ç¤ºä¾‹ä¸­éƒ½æ˜¯ä½¿ç”¨ä¸€ä¸ªç®€å•çš„çŠ¶æ€æ¥æ“ä½œæ¶ˆæ¯åˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡çŠ¶æ€ä¸­çš„æ›´å¤šå­—æ®µæ¥æ‹“å±•å…¶åŠŸèƒ½</p><p>ä¸Šé¢çš„ä¾‹å­ä¸­æ¯æ¬¡å·¥å…·è°ƒç”¨æ—¶ï¼Œæµç¨‹éƒ½ä¼šæš‚åœç­‰å¾…äººå·¥ï¼Œä¸‹é¢å°†å®ç°ä¾é  LLMæ¥é€‰æ‹©æ˜¯å¦éœ€è¦è¿›è¡Œäººå·¥å¤„ç†</p><p>ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ª <code>human</code>èŠ‚ç‚¹ï¼Œåœ¨è¯¥èŠ‚ç‚¹ä¹‹å‰å›¾å½¢å°†å§‹ç»ˆåœæ­¢ï¼Œåªæœ‰å½“ LLM è°ƒç”¨ <code>human</code>å·¥å…·æ—¶ï¼Œæˆ‘ä»¬æ‰ä¼šæ‰§è¡Œæ­¤èŠ‚</p><p>ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å°†åœ¨æµç¨‹å›¾çŠ¶æ€ä¸­åŒ…å«ä¸€ä¸ª <code>ask_human</code>æ ‡è¯†ï¼Œå¦‚æœ LLM è°ƒç”¨æ­¤å·¥å…·ï¼Œæˆ‘ä»¬å°†åˆ‡æ¢è¯¥æ ‡è¯†</p><h3 id="å®šä¹‰ä¸€ä¸ªå¸¦å±æ€§çš„çŠ¶æ€">å®šä¹‰ä¸€ä¸ªå¸¦å±æ€§çš„çŠ¶æ€</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_anthropic <span class="keyword">import</span> ChatAnthropic</span><br><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langgraph.checkpoint.sqlite <span class="keyword">import</span> SqliteSaver</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph</span><br><span class="line"><span class="keyword">from</span> langgraph.graph.message <span class="keyword">import</span> add_messages</span><br><span class="line"><span class="keyword">from</span> langgraph.prebuilt <span class="keyword">import</span> ToolNode, tools_condition</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>, add_messages]</span><br><span class="line">    <span class="comment"># This flag is new</span></span><br><span class="line">    ask_human: <span class="built_in">bool</span></span><br></pre></td></tr></table></figure><h3 id="å®šä¹‰è¯·æ±‚ååŠ©å·¥å…·">å®šä¹‰è¯·æ±‚ååŠ©å·¥å…·</h3><p>æ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸ª schemaï¼ˆtoolï¼‰æ¥è®©æ¨¡å‹å†³å®šæ˜¯å¦è¯·æ±‚å¸®åŠ©</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.pydantic_v1 <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RequestAssistance</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Escalate the conversation to an expert. Use this if you are unable to assist directly or if the user requires support beyond your permissions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    To use this function, relay the user&#x27;s &#x27;request&#x27; so the expert can provide the right guidance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    request: <span class="built_in">str</span></span><br></pre></td></tr></table></figure><h3 id="chatbot-èŠ‚ç‚¹">chatbot èŠ‚ç‚¹</h3><p>æ¥ä¸‹æ¥å®šä¹‰èŠå¤©æœºå™¨äººèŠ‚ç‚¹ã€‚å¦‚æœæˆ‘ä»¬çœ‹åˆ°èŠå¤©æœºå™¨äººè°ƒç”¨äº†<code>RequestAssistance</code>ï¼Œå°±åˆ‡æ¢ <code>ask_human</code> æ ‡è¯†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wikipedia = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())</span><br><span class="line">tools = [wikipedia]</span><br><span class="line"></span><br><span class="line">llm = Azure.chat_model_4o</span><br><span class="line">llm_with_tools = llm.bind_tools(tools + [RequestAssistance])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chatbot</span>(<span class="params">state: State</span>):</span><br><span class="line">    response = llm_with_tools.invoke(state[<span class="string">&quot;messages&quot;</span>])</span><br><span class="line">    ask_human = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        response.tool_calls</span><br><span class="line">        <span class="keyword">and</span> response.tool_calls[<span class="number">0</span>][<span class="string">&quot;name&quot;</span>] == RequestAssistance.__name__</span><br><span class="line">    ):</span><br><span class="line">        ask_human = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response], <span class="string">&quot;ask_human&quot;</span>: ask_human&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæµç¨‹å›¾å›¾ç”Ÿæˆå™¨ï¼Œå¹¶å°†èŠå¤©æœºå™¨äººå’Œå·¥å…·èŠ‚ç‚¹æ·»åŠ åˆ°å›¾ä¸­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph_builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;chatbot&quot;</span>, chatbot)</span><br><span class="line"><span class="comment"># çœ‹èµ·æ¥è¿™é‡Œæ²¡å¿…è¦å°† RequestAssistance ä¹ŸåŠ å…¥ï¼Œå› ä¸º RequestAssistance åªæ˜¯ä¸€ä¸ªæ ‡è®°</span></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;tools&quot;</span>, ToolNode(tools=[tool]))</span><br></pre></td></tr></table></figure><h3 id="human-èŠ‚ç‚¹">human èŠ‚ç‚¹</h3><p>æ¥ä¸‹æ¥åˆ›å»º <code>human</code>èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹å‡½æ•°åœ¨æˆ‘ä»¬çš„å›¾ä¸­ä¸»è¦æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå®ƒå°†è§¦å‘ä¸­æ–­</p><p>å¦‚æœäººå·¥åœ¨ä¸­æ–­æœŸé—´æ²¡æœ‰æ‰‹åŠ¨æ›´æ–°çŠ¶æ€ï¼Œå®ƒä¼šæ’å…¥ä¸€æ¡å·¥å…·æ¶ˆæ¯ï¼Œä»¥ä¾¿ LLMçŸ¥é“ç”¨æˆ·è¢«è¯·æ±‚ä½†æ²¡æœ‰å“åº”</p><p>è¯¥èŠ‚ç‚¹è¿˜å–æ¶ˆè®¾ç½® <code>ask_human</code>æ ‡å¿—ï¼Œä»¥ä¾¿æµç¨‹å›¾çŸ¥é“é™¤éå‘å‡ºè¿›ä¸€æ­¥çš„è¯·æ±‚ï¼Œå¦åˆ™ä¸è¦é‡æ–°è®¿é—®è¯¥èŠ‚ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> AIMessage, ToolMessage</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_response</span>(<span class="params">response: <span class="built_in">str</span>, ai_message: AIMessage</span>):</span><br><span class="line">    <span class="keyword">return</span> ToolMessage(</span><br><span class="line">        content=response,</span><br><span class="line">        tool_call_id=ai_message.tool_calls[<span class="number">0</span>][<span class="string">&quot;id&quot;</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">human_node</span>(<span class="params">state: State</span>):</span><br><span class="line">    new_messages = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>], ToolMessage):</span><br><span class="line">        <span class="comment"># Typically, the user will have updated the state during the interrupt.</span></span><br><span class="line">        <span class="comment"># If they choose not to, we will include a placeholder ToolMessage to</span></span><br><span class="line">        <span class="comment"># let the LLM continue.</span></span><br><span class="line">        new_messages.append(</span><br><span class="line">            create_response(<span class="string">&quot;No response from human.&quot;</span>, state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="comment"># Append the new messages</span></span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: new_messages,</span><br><span class="line">        <span class="comment"># Unset the flag</span></span><br><span class="line">        <span class="string">&quot;ask_human&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;human&quot;</span>, human_node)</span><br></pre></td></tr></table></figure><h3 id="æ¡ä»¶è¾¹">æ¡ä»¶è¾¹</h3><p>æ¥ä¸‹æ¥å®šä¹‰æ¡ä»¶è¾¹ï¼Œå¦‚æœè®¾ç½®äº†æ ‡å¿—ï¼Œ<code>select_next_node</code>å°†è·¯ç”±åˆ°äººå·¥èŠ‚ç‚¹</p><p>å¦åˆ™è®©é¢„æ„å»ºçš„ <code>tools_condition</code> å‡½æ•°é€‰æ‹©ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</p><p><code>tools_condition</code>å‡½æ•°åªæ˜¯æ£€æŸ¥èŠå¤©æœºå™¨äººæ˜¯å¦åœ¨å…¶å“åº”æ¶ˆæ¯ä¸­ä½¿ç”¨äº†ä»»ä½•<code>tool_calls</code>è¿›è¡Œäº†å“åº”ï¼Œå¦‚æœæ˜¯å°†è·¯ç”±åˆ°åŠ¨ä½œèŠ‚ç‚¹ï¼Œå¦åˆ™å°†ç»“æŸæµç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_next_node</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;ask_human&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;human&quot;</span></span><br><span class="line">    <span class="comment"># Otherwise, we can route as before</span></span><br><span class="line">    <span class="keyword">return</span> tools_condition(state)</span><br><span class="line"></span><br><span class="line">graph_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;chatbot&quot;</span>,</span><br><span class="line">    select_next_node,</span><br><span class="line">    &#123;<span class="string">&quot;human&quot;</span>: <span class="string">&quot;human&quot;</span>, <span class="string">&quot;tools&quot;</span>: <span class="string">&quot;tools&quot;</span>, <span class="string">&quot;__end__&quot;</span>: <span class="string">&quot;__end__&quot;</span>&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘">ç¼–è¯‘</h3><p>æœ€åæ·»åŠ ç®€å•çš„æœ‰å‘è¾¹å¹¶ç¼–è¯‘å›¾ï¼Œè¿™äº›è¾¹æŒ‡ç¤ºæ¯å½“ aå®Œæˆæ‰§è¡Œæ—¶ï¼Œå›¾æ€»æ˜¯ä»èŠ‚ç‚¹ a-&gt;b æµå‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The rest is the same</span></span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;tools&quot;</span>, <span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;human&quot;</span>, <span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">graph_builder.set_entry_point(<span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">memory = SqliteSaver.from_conn_string(<span class="string">&quot;:memory:&quot;</span>)</span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>(</span><br><span class="line">    checkpointer=memory,</span><br><span class="line">    <span class="comment"># We interrupt before &#x27;human&#x27; here instead.</span></span><br><span class="line">    interrupt_before=[<span class="string">&quot;human&quot;</span>],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangGraph/LangGraph%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/5.png" class="" title="Untitled"><p>æµç¨‹å›¾å¦‚ä¸Šï¼Œå…·ä½“çš„æ‰§è¡Œæ­¥éª¤å°±å‚è€ƒå®˜æ–¹æ–‡æ¡£å³å¯</p><p></br></p><h2 id="part.7-æ—¶é—´æ—…è¡Œ">Part.7 æ—¶é—´æ—…è¡Œ</h2><p>æ—¶é—´æ—…è¡Œï¼ˆTime Travelï¼‰å¯ä»¥å®ç°</p><ul><li>ä»ä»¥å‰çš„å“åº”å¼€å§‹ï¼Œåˆ†æ”¯æ¢ç´¢å•ç‹¬çš„ç»“æœ</li><li>ç”¨æˆ·èƒ½å¤Ÿ â€œå€’å¸¦â€åŠ©ç†çš„å·¥ä½œæ¥çº æ­£ä¸€äº›é”™è¯¯æˆ–å°è¯•ä¸åŒçš„ç­–ç•¥ï¼ˆåœ¨è‡ªä¸»è½¯ä»¶å·¥ç¨‹å¸ˆç­‰åº”ç”¨ç¨‹åºä¸­å¾ˆå¸¸è§ï¼‰</li><li>ä»¥åŠæ›´å¤šåŠŸèƒ½</li></ul><p>é€šè¿‡ä½¿ç”¨æµç¨‹å›¾çš„ <code>get_state_history</code> æ–¹æ³•è·å–æ£€æŸ¥ç‚¹æ¥â€œå€’å¸¦â€ ï¼ˆrewindï¼‰æµç¨‹å›¾</p><h3 id="è®¾ç½®è®°å¿†æ£€æŸ¥ç‚¹">è®¾ç½®è®°å¿†æ£€æŸ¥ç‚¹</h3><p>åŸºäºä¸Šé¢çš„æµç¨‹ä¸ç”¨å˜æ›´ä»»ä½•ä»£ç </p><p>å¯ä»¥ç¡®è®¤ï¼Œæˆ‘ä»¬çš„ <code>checkpointer</code> åŸºäº<code>memory</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph = graph_builder.<span class="built_in">compile</span>(</span><br><span class="line">    checkpointer=memory,</span><br><span class="line">    interrupt_before=[<span class="string">&quot;tools&quot;</span>]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="æ¨¡æ‹Ÿæµç¨‹">æ¨¡æ‹Ÿæµç¨‹</h3><p>è®©æµç¨‹å›¾èµ°å‡ æ­¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ç¬¬ä¸€æ­¥</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;&#125;</span><br><span class="line">events = graph.stream(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">            (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;Where is China?&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    config,</span><br><span class="line">    stream_mode=<span class="string">&quot;values&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">in</span> event:</span><br><span class="line">        event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ç¬¬äºŒæ­¥</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">events = graph.stream(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">            (<span class="string">&quot;Where is its capital?&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    config,</span><br><span class="line">    stream_mode=<span class="string">&quot;values&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">in</span> event:</span><br><span class="line">        event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ”¾ä¸€ä¸‹ç»“æœå§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">================================ Human Message =================================</span><br><span class="line"></span><br><span class="line">Where <span class="keyword">is</span> China?</span><br><span class="line">================================== Ai Message ==================================</span><br><span class="line"></span><br><span class="line">China <span class="keyword">is</span> a country located <span class="keyword">in</span> East Asia. It <span class="keyword">is</span> the world<span class="string">&#x27;s most populous country, with a population of over 1.4 billion people. China is bordered by 14 countries: Afghanistan, Bhutan, India, Kazakhstan, Kyrgyzstan, Laos, Mongolia, Myanmar, Nepal, North Korea, Pakistan, Russia, Tajikistan, and Vietnam. To the east, it has a coastline along the East China Sea, Korea Bay, Yellow Sea, and South China Sea. The capital city of China is Beijing.</span></span><br><span class="line"><span class="string">================================ Human Message =================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Where is its capital?</span></span><br><span class="line"><span class="string">================================== Ai Message ==================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The capital of China is Beijing. Beijing is located in the northern part of the country. It is situated in the northern tip of the North China Plain, near the western coast of the Bohai Sea. The city is bordered by Hebei Province to the north, west, south, and a small section to the east, and by Tianjin Municipality to the southeast. Beijing is one of the most populous cities in the world and serves as the political, cultural, and educational center of China.</span></span><br></pre></td></tr></table></figure><h3 id="å›çœ‹å†å²">å›çœ‹å†å²</h3><p>ä¸Šé¢è®©æµç¨‹å›¾è¿›è¡Œäº†å‡ æ¬¡è°ƒç”¨</p><p>ä¸‹é¢å¯ä»¥é€šè¿‡ <code>get_state_history</code> è·å–æ‰€æœ‰å†å²ï¼Œå¹¶ä¸”ä¿å­˜<code>to_replay</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">to_replay = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> state <span class="keyword">in</span> graph.get_state_history(config):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Num Messages: &quot;</span>, <span class="built_in">len</span>(state.values[<span class="string">&quot;messages&quot;</span>]), <span class="string">&quot;Next: &quot;</span>, state.<span class="built_in">next</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">80</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(state.values[<span class="string">&quot;messages&quot;</span>]) == <span class="number">2</span>:</span><br><span class="line">        <span class="comment"># We are somewhat arbitrarily selecting a specific state based on the number of chat messages in the state.</span></span><br><span class="line">        to_replay = state</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ç‚¹æ˜¯ä¸ºæµç¨‹å›¾æ¯ä¸ªæ­¥éª¤ä¿å­˜çš„ï¼Œä¼šè·¨è¶Šå¤šæ¬¡è°ƒç”¨</p><p>å› æ­¤å¯ä»¥åœ¨æ•´ä¸ªçº¿ç¨‹çš„å†å²è®°å½•ä¸­è¿›è¡Œå€’å¸¦ã€‚æˆ‘ä»¬é€‰æ‹©äº†<code>to_replay</code> ä½œä¸ºæ¢å¤çŠ¶æ€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(to_replay.<span class="built_in">next</span>)</span><br><span class="line"><span class="built_in">print</span>(to_replay.config)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">()</span><br><span class="line">&#123;<span class="string">&#x27;configurable&#x27;</span>: &#123;<span class="string">&#x27;thread_id&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;thread_ts&#x27;</span>: <span class="string">&#x27;1ef3228b-2fee-631a-8001-1697d5779962&#x27;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ç»“æŸï¼Œé€šè¿‡ <code>to_replay.next</code> å¯ä»¥çœ‹å‡º</p><h3 id="åŸºäºæ£€æŸ¥ç‚¹é…ç½®è°ƒç”¨">åŸºäºæ£€æŸ¥ç‚¹é…ç½®è°ƒç”¨</h3><p>æ£€æŸ¥ç‚¹çš„é…ç½® <code>to_replay.config</code> åŒ…å«ä¸€ä¸ª<code>thread_ts</code> æ—¶é—´æˆ³</p><p>æä¾›è¿™ä¸ª <code>thread_ts</code> å€¼å‘Šè¯‰ LangGraphçš„æ£€æŸ¥æŒ‡é’ˆä»é‚£ä¸ªæ—¶åˆ»å¼€å§‹åŠ è½½çŠ¶æ€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The `thread_ts` in the `to_replay.config` corresponds to a state we&#x27;ve persisted to our checkpointer.</span></span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> graph.stream(&#123;</span><br><span class="line">    <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">        (<span class="string">&quot;Where is its economic center?&quot;</span>)</span><br><span class="line">    ]</span><br><span class="line">&#125;, to_replay.config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">in</span> event:</span><br><span class="line">        event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">================================ Human Message =================================</span><br><span class="line"></span><br><span class="line">Where <span class="keyword">is</span> its economic center?</span><br><span class="line">================================== Ai Message ==================================</span><br><span class="line"></span><br><span class="line">China<span class="string">&#x27;s economic center is often considered to be Shanghai. Shanghai is the largest city in China by population and one of the largest urban areas in the world. It is a global financial hub and a major center for commerce, trade, and industry. The city hosts the Shanghai Stock Exchange, which is one of the largest stock exchanges in the world by market capitalization.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Shanghai&#x27;</span>s strategic location on the Yangtze River Delta <span class="keyword">and</span> its extensive port facilities make it a key player <span class="keyword">in</span> both domestic <span class="keyword">and</span> international trade. The city <span class="keyword">is</span> also known <span class="keyword">for</span> its modern skyline, including landmarks such <span class="keyword">as</span> the Shanghai Tower <span class="keyword">and</span> the Oriental Pearl TV Tower.</span><br></pre></td></tr></table></figure><p></br></p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹å°±å®Œæˆäº†ä»‹ç»æ•™ç¨‹ï¼Œå¹¶åœ¨ LangGraphä¸­æ„å»ºäº†ä¸€ä¸ªèŠå¤©æœºå™¨äºº</p><p>å®ƒæ”¯æŒ</p><ul><li>å·¥å…·è°ƒç”¨</li><li>å†…å­˜è®°å¿†</li><li>äººå·¥äº¤äº’</li><li>æ—¶é—´æ—…è¡Œ</li></ul><p>æ›´å¤šå†…å®¹å°†åœ¨åç»­çš„æ–‡æ¡£ä¸­å±•å¼€</p><p></br></p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://langchain-ai.github.io/langgraph/tutorials/">Tutorials -LangGraph (langchain-ai.github.io)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangGraph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
            <tag> LangGraph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.7 - Agent</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.7%20-%20Agent.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.7%20-%20Agent.html</url>
      
        <content type="html"><![CDATA[<h1 id="æ³¨æ„">æ³¨æ„</h1><p>LangChain ç”Ÿæ€ä¸‹æœ‰äº†æ–°çš„æ¡†æ¶ LangGraph</p><p><ahref="https://github.com/langchain-ai/langgraph">langchain-ai/langgraph:Build resilient language agents as graphs. (github.com)</a></p><p>Agent çš„é‡å¿ƒä¹Ÿè¿ç§»åˆ° LangGraphï¼Œæ‰€ä»¥ Agent ç›¸å…³çš„å†…å®¹ä¼šæ”¾åœ¨ LangGraphå†…</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>langchain4j-spring å­¦ä¹ </title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain4j/langchain4j-spring%20%E5%AD%A6%E4%B9%A0.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain4j/langchain4j-spring%20%E5%AD%A6%E4%B9%A0.html</url>
      
        <content type="html"><![CDATA[<h1 id="langchain4j-spring-å­¦ä¹ ">langchain4j-spring å­¦ä¹ </h1><h1 id="ä»‹ç»">ä»‹ç»</h1><p>langchain4j-spring æ˜¯ LangChain4j ä¸‹æ”¯æŒ Spring Starteræœºåˆ¶çš„ä»“åº“</p><p>æˆªæ­¢åˆ°å½“å‰ç‰ˆæœ¬ <code>0.31.0</code> æ¥çœ‹ï¼Œä»“åº“ä¸‹çš„ moduleä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»</p><ul><li>æµè¡Œçš„é›†æˆçš„ Starterï¼ˆpopular integrationsï¼‰<ul><li>langchain4j-open-ai-spring-boot-starterï¼šOpenAI LLM</li><li>langchain4j-azure-open-ai-spring-boot-starterï¼šAzure OpenAI LLM</li><li>langchain4j-anthropic-spring-boot-starterï¼šAnthropicLLMï¼ˆClaudeï¼‰</li><li>langchain4j-ollama-spring-boot-starterï¼šOllama LLM</li></ul></li><li>AiServiceã€RAGã€Tools ç­‰å·¥å…·çš„ Starter<ul><li>langchain4j-spring-boot-starterï¼šæ ¸å¿ƒèƒ½åŠ›</li><li>langchain4j-easy-rag-spring-boot-starter</li></ul></li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒLangChain4j æ”¯æŒ Java 8ï¼Œä½†æ˜¯è¿™ä¸ª Spring Starteré¡¹ç›®åªæ”¯æŒ Java 17ï¼ˆæœ¬è´¨åŸå› è¿˜æ˜¯æ–°çš„ Spring Boot ç‰ˆæœ¬å¯¹ Javaç‰ˆæœ¬çš„è¦æ±‚ï¼Œå¦‚ä»Šæ–°çš„ Spring ç›¸å…³ä»“åº“å¾ˆå°‘æ”¯æŒ Java 8 äº†ï¼‰</p><p>ä¸‹é¢ä¼šç®€å•äº†è§£ä¸€äº›æ ¸å¿ƒåŠŸèƒ½çš„ç”¨æ³•ï¼Œä»¥åŠå®ç°æ–¹å¼</p><h1 id="llm">LLM</h1><p>è¿™é‡Œä»¥ Azure OpenAI ä¸ºä¾‹</p><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><p>åœ¨ <code>application</code> æ–‡ä»¶ä¸­è¿›è¡Œç›¸å…³é…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">langchain4j:</span></span><br><span class="line">  <span class="attr">azure-open-ai:</span></span><br><span class="line">    <span class="attr">chat-model:</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">&#x27;AZURE_OPENAI_KEY&#x27;</span></span><br><span class="line">      <span class="attr">endpoint:</span> <span class="string">&#x27;AZURE_OPENAI_ENDPOINT&#x27;</span></span><br><span class="line">      <span class="attr">deployment-name:</span> <span class="string">&#x27;deploymentName&#x27;</span></span><br><span class="line">      <span class="attr">max-tokens:</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure><p>ä¾èµ–è‡ªåŠ¨æ³¨å…¥ï¼ŒLLM å·²ç»ä½œä¸º Bean å®ä¾‹åŒ–è¿›å®¹å™¨äº†</p><p>æ¥å£ä¸º <code>dev.langchain4j.model.chat.ChatLanguageModel</code></p><p>å®ç°ç±»ä¸º<code>dev.langchain4j.model.azure.AzureOpenAiChatModel</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLlmService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatLanguageModel chatLanguageModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">post</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">message</span> <span class="operator">=</span> UserMessage.from(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">        Response&lt;AiMessage&gt; generate = chatLanguageModel.generate(message);</span><br><span class="line">        log.info(<span class="string">&quot;response content:&#123;&#125;&quot;</span>, generate.content());</span><br><span class="line">        <span class="comment">// response content:Hello! How can I assist you today?</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æºç ">æºç </h2><h3 id="è‡ªåŠ¨è£…é…">è‡ªåŠ¨è£…é…</h3><p>META æ–‡ä»¶ä¸­æŒ‡æ˜äº†è‡ªåŠ¨è£…é…ç±»ä¸º<code>dev.langchain4j.azure.openai.spring.AutoConfig</code></p><p><code>AutoConfig</code> ä¸»è¦è´Ÿè´£å¦‚ä¸‹ç›¸å…³ Bean çš„è£…é…å·¥ä½œ</p><ul><li>AzureOpenAiChatModel</li><li>AzureOpenAiStreamingChatModel</li><li>AzureOpenAiEmbeddingModel</li><li>AzureOpenAiImageModel</li><li>AzureOpenAiTokenizer</li></ul><p>ä»¥ <code>AzureOpenAiChatModel</code> å’Œ<code>AzureOpenAiTokenizer</code> ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(Properties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(Properties.PREFIX + &quot;.chat-model.api-key&quot;)</span></span><br><span class="line">    AzureOpenAiChatModel <span class="title function_">openAiChatModelByAPIKey</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> openAiChatModel(properties);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    AzureOpenAiTokenizer <span class="title function_">openAiTokenizer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AzureOpenAiTokenizer</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“å‘ç°å­˜åœ¨é…ç½® <code>.chat-model.api-key</code>æ—¶ï¼Œå°†ä¼šå®ä¾‹åŒ– <code>AzureOpenAiChatModel</code></p><p>åé¢çš„ <code>openAiChatModel</code>æ–¹æ³•ä¼šæ ¹æ®é…ç½®æ–‡ä»¶å†…å®¹åˆ›å»ºå‡ºç›¸å…³å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">AzureOpenAiImageModel <span class="title function_">openAiImageModel</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">      <span class="type">ImageModelProperties</span> <span class="variable">imageModelProperties</span> <span class="operator">=</span> properties.getImageModel();</span><br><span class="line">      AzureOpenAiImageModel.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> AzureOpenAiImageModel.builder()</span><br><span class="line">              .endpoint(imageModelProperties.getEndpoint())</span><br><span class="line">              .apiKey(imageModelProperties.getApiKey())</span><br><span class="line">              .deploymentName(imageModelProperties.getDeploymentName())</span><br><span class="line">              .size(imageModelProperties.getSize())</span><br><span class="line">              .quality(imageModelProperties.getQuality())</span><br><span class="line">              .style(imageModelProperties.getStyle())</span><br><span class="line">              .user(imageModelProperties.getUser())</span><br><span class="line">              .responseFormat(imageModelProperties.getResponseFormat())</span><br><span class="line">              .timeout(imageModelProperties.getTimeout() == <span class="literal">null</span> ? <span class="literal">null</span> : Duration.ofSeconds(imageModelProperties.getTimeout()))</span><br><span class="line">              .maxRetries(imageModelProperties.getMaxRetries())</span><br><span class="line">              .proxyOptions(ProxyOptions.fromConfiguration(Configuration.getGlobalConfiguration()))</span><br><span class="line">              .logRequestsAndResponses(imageModelProperties.getLogRequestsAndResponses() != <span class="literal">null</span> &amp;&amp; imageModelProperties.getLogRequestsAndResponses());</span><br><span class="line">      <span class="keyword">if</span> (imageModelProperties.getNonAzureApiKey() != <span class="literal">null</span>) &#123;</span><br><span class="line">          builder.nonAzureApiKey(imageModelProperties.getNonAzureApiKey());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å°±æ˜¯åœ¨è·å–é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§è¿›è¡Œå®ä¾‹åŒ–</p><p><strong>è¿™é‡Œå¤šè¯´ä¸€å¥ï¼</strong></p><p>ä¸€å¼€å§‹æˆ‘çš„é¡¹ç›®å¯åŠ¨ä¸èµ·æ¥ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼Œæ˜æ˜¾æ˜¯è£…é…ç±»çš„å…¨é™å®šåè·¯å¾„é”™äº†ï¼Œå‰é¢å¤šäº†ä¸€ä¸ª<code>spring.</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unable to read meta-data <span class="keyword">for</span> <span class="keyword">class</span> <span class="title class_">spring</span>.dev.langchain4j.azure.openai.spring.AutoConfig</span><br></pre></td></tr></table></figure><p>æˆ‘çœ‹äº†ä¸€ä¸‹ä»£ç ï¼Œå‘ç°é¡¹ç›®ä¸­å†™çš„ç¡®å®æ˜¯<code>dev.langchain4j.azure.openai.spring.AutoConfig spring</code>ï¼Œæ‰€ä»¥æˆ‘çš„æ€€ç–‘é‡å¿ƒå°±æ”¾åœ¨äº† Spring å’Œ Mavençš„ç¼–è¯‘æ’ä»¶ä¸Šäº†ï¼Œä»¥ä¸ºæ˜¯æ¢äº†æ–°ç‰ˆæœ¬çš„ Spring Boot æœ‰ä»€ä¹ˆæ–°æœºåˆ¶å¯¼è‡´çš„â€œæ°´åœŸä¸æœâ€</p><p>ç»“æœæ€ä¹ˆè¯•éƒ½ä¸è¡Œï¼Œå®åœ¨æ²¡åŠæ³•äº†çœ‹äº†ä¸€ä¸‹æäº¤æ—¶é—´ï¼Œå‘ç°ç«Ÿç„¶æ˜¯ 5.24æ‰è¿›è¡Œçš„ fixï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä»“åº“çš„ <code>0.32.0-SNAPSHOT</code>æ˜¯ä¿®å¤è¿‡çš„ï¼Œè€Œä¹‹å‰çš„ <code>0.31.0</code> è¿™ä¸ª RELEASEç‰ˆæœ¬ï¼Œå°±æ˜¯é”™çš„â€¦</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain4j/langchain4j-spring%20%E5%AD%A6%E4%B9%A0/fix-commit.png" class="" title="Untitled"><p>æ²¡åŠæ³•ï¼Œæœ¬åœ°æ‰“äº†ä¸€ä¸ª <code>0.32.0-SNAPSHOT</code> åŒ…ç»§ç»­æµ‹è¯•</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§é”™è¯¯å‘¢ï¼Œå› ä¸ºè¿™ä¸ªè´¡çŒ®è€…è¿˜å†™äº†äº† Azure Search çš„Starterï¼Œåœ¨é‚£ä¸ª module ä¸‹ï¼Œ<code>AutoConfig</code> æ˜¯åœ¨<code>dev.langchain4j.azure.openai.spring</code>è¿™ä¸ªè·¯å¾„ï¼Œæ‰€ä»¥æˆ‘çŒœæµ‹æ˜¯ä½œè€…ææ··äº†</p><h3 id="é…ç½®">é…ç½®</h3><p>è¿™é‡Œç®€å•çœ‹ä¸‹éƒ½æœ‰å“ªäº›é…ç½®å‚æ•°</p><p>å…·ä½“çš„å±æ€§éƒ½åœ¨<code>dev.langchain4j.azure.openai.spring.Properties</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = Properties.PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Properties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;langchain4j.azure-open-ai&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NestedConfigurationProperty</span></span><br><span class="line">    ChatModelProperties chatModel; <span class="comment">// èŠå¤©æ¨¡å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@NestedConfigurationProperty</span></span><br><span class="line">    ChatModelProperties streamingChatModel; <span class="comment">// æµå¼</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@NestedConfigurationProperty</span></span><br><span class="line">    EmbeddingModelProperties embeddingModel; <span class="comment">// åµŒå…¥</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@NestedConfigurationProperty</span></span><br><span class="line">    ImageModelProperties imageModel; <span class="comment">// å›¾ç‰‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥èŠå¤©æ¨¡å‹ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatModelProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    String endpoint;</span><br><span class="line">    String apiKey;</span><br><span class="line">    String nonAzureApiKey;</span><br><span class="line">    String organizationId;</span><br><span class="line">    String deploymentName;</span><br><span class="line">    Double temperature;</span><br><span class="line">    Double topP;</span><br><span class="line">    Integer maxTokens;</span><br><span class="line">    Double presencePenalty;</span><br><span class="line">    Double frequencyPenalty;</span><br><span class="line">    String responseFormat;</span><br><span class="line">    Integer seed;</span><br><span class="line">    List&lt;String&gt; stop;</span><br><span class="line">    Integer timeout;</span><br><span class="line">    Integer maxRetries;</span><br><span class="line">    Boolean logRequestsAndResponses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯æ”¯æŒçš„æ‰€æœ‰å‚æ•°äº†ï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨ç¤ºä¾‹ä¸­çš„å±æ€§çš†åœ¨è¿™é‡Œ</p><ul><li>apiKey</li><li>endpoint</li><li>deploymentName</li><li>maxTokens</li></ul><h1 id="aiservice">AiService</h1><h2 id="ä½¿ç”¨-1">ä½¿ç”¨</h2><p>å®šä¹‰æ¥å£ï¼Œæ ‡æ³¨ <code>@AiService</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AiService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyAiService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SystemMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">            Tell me five names about the topic given by users.</span></span><br><span class="line"><span class="meta">            Separate with commas.</span></span><br><span class="line"><span class="meta">            &quot;&quot;&quot;)</span></span><br><span class="line">    String <span class="title function_">answer</span><span class="params">(String userMessage)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å…¥åä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAiService myAiService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">post</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">resp</span> <span class="operator">=</span> myAiService.answer(<span class="string">&quot;å›½å®¶é¦–éƒ½&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;response content:&#123;&#125;&quot;</span>, resp);</span><br><span class="line">        <span class="comment">// response content:åŒ—äº¬ï¼Œåç››é¡¿ï¼Œä¼¦æ•¦ï¼Œå·´é»ï¼Œä¸œäº¬</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æºç -1">æºç </h2><p><code>AiService</code> Bean çš„åˆ›å»ºæ˜¯é€šè¿‡<code>BeanFactoryPostProcessor</code> å®ç°çš„</p><p>dev.langchain4j.service.spring.AiServicesAutoConfig</p><h3 id="ç»„ä»¶è·å–">ç»„ä»¶è·å–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AiServicesAutoConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    BeanFactoryPostProcessor <span class="title function_">aiServicesRegisteringBeanFactoryPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> beanFactory -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// all components available in the application context</span></span><br><span class="line">            String[] chatLanguageModels = beanFactory.getBeanNamesForType(ChatLanguageModel.class);</span><br><span class="line">            String[] streamingChatLanguageModels = beanFactory.getBeanNamesForType(StreamingChatLanguageModel.class);</span><br><span class="line">            String[] chatMemories = beanFactory.getBeanNamesForType(ChatMemory.class);</span><br><span class="line">            String[] chatMemoryProviders = beanFactory.getBeanNamesForType(ChatMemoryProvider.class);</span><br><span class="line">            String[] contentRetrievers = beanFactory.getBeanNamesForType(ContentRetriever.class);</span><br><span class="line">            String[] retrievalAugmentors = beanFactory.getBeanNamesForType(RetrievalAugmentor.class);</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure><p><code>AiService</code> ä¾èµ–çš„å¤§éƒ¨åˆ†ç»„ä»¶ï¼Œéƒ½æ˜¯åœ¨ Beanå®¹å™¨å†…è¿›è¡Œè·å–ï¼Œä¾‹å¦‚ LLMã€è®°å¿†ç­‰é‡è¦ç»„ä»¶</p><h3 id="æ‰«æ-aiservice">æ‰«æ <span class="citation"data-cites="AiService">@AiService</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; findAiServices(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    String[] applicationBean = beanFactory.getBeanNamesForAnnotation(SpringBootApplication.class);</span><br><span class="line">    <span class="type">BeanDefinition</span> <span class="variable">applicationBeanDefinition</span> <span class="operator">=</span> beanFactory.getBeanDefinition(applicationBean[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">String</span> <span class="variable">basePackage</span> <span class="operator">=</span> applicationBeanDefinition.getResolvableType().resolve().getPackage().getName();</span><br><span class="line">    <span class="type">Reflections</span> <span class="variable">reflections</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reflections</span>(basePackage);</span><br><span class="line">    <span class="keyword">return</span> reflections.getTypesAnnotatedWith(AiService.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸ºäº†æ‹¿åˆ° Application çš„ basePackageï¼Œç„¶åé€šè¿‡<code>Reflections</code> æ‰«ææ‰€æœ‰å¸¦æœ‰ <code>@AiService</code>æ³¨è§£çš„ç±»</p><h3 id="åˆ›å»º-bean">åˆ›å»º Bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">GenericBeanDefinition</span> <span class="variable">aiServiceBeanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericBeanDefinition</span>();</span><br><span class="line">        aiServiceBeanDefinition.setBeanClass(AiServiceFactory.class);</span><br><span class="line">        aiServiceBeanDefinition.getConstructorArgumentValues().addGenericArgumentValue(aiServiceClass);</span><br><span class="line">        <span class="type">MutablePropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> aiServiceBeanDefinition.getPropertyValues();</span><br><span class="line"></span><br><span class="line">        <span class="type">AiService</span> <span class="variable">aiServiceAnnotation</span> <span class="operator">=</span> aiServiceClass.getAnnotation(AiService.class);</span><br><span class="line"></span><br><span class="line">        addBeanReference(</span><br><span class="line">                ChatLanguageModel.class,</span><br><span class="line">                aiServiceAnnotation,</span><br><span class="line">                aiServiceAnnotation.chatModel(),</span><br><span class="line">                chatLanguageModels,</span><br><span class="line">                <span class="string">&quot;chatModel&quot;</span>,</span><br><span class="line">                <span class="string">&quot;chatLanguageModel&quot;</span>,</span><br><span class="line">                propertyValues</span><br><span class="line">        );</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ° Class åï¼Œé€šè¿‡ <code>BeanDefinition</code> çš„æ–¹å¼è®¾ç½® Bean</p><p>åç»­çš„ <code>addBeanReference</code> æ–¹æ³•å°†ç»„ä»¶æ·»åŠ åˆ°<code>AiService</code> çš„å®šä¹‰ä¸­</p><p>è¿™é‡Œè¿˜éœ€è¦æ³¨æ„ï¼Œé€šè¿‡åŒ…è£… <code>AiServiceFactory</code>çš„æ–¹å¼è¿›è¡Œåˆ›å»ºçš„å®ç°ï¼Œè¿™æ ·å¯ä»¥å°† Spring åŒ…ä¸­çš„æ–¹å¼æ¥å…¥ CoreåŒ…çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè®©åˆ›å»ºæµç¨‹æ›´åŠ ç»Ÿä¸€</p><h1 id="tools">Tools</h1><p>å¯¹äºå·¥å…·è§£æç›¸å…³çš„æ–¹æ³•ï¼Œæ˜¯ <code>AiServices</code> æä¾›çš„</p><p>Spring çš„å°è£…è¿™é‡Œä¸»è¦æ˜¯æä¾›åˆ°å¯¹ Bean æ‰«æ <code>@Tool</code>è¿™ä¸€æ­¥</p><p>éšååœ¨ <code>AiServiceFactory</code> çš„ <code>getObject</code>å®ç°ä¸Šè§£æå·¥å…·çš„ç›¸å…³å±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isNullOrEmpty(tools)) &#123;</span><br><span class="line">    builder = builder.tools(tools);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="rag">RAG</h1><p>æä¾›äº†å¯¹ RAG ç›¸å…³ç»„ä»¶ Embedding Store è‡ªåŠ¨è£…é…çš„èƒ½åŠ›</p><p>å®ç°ä¸Šæ¯”è¾ƒç®€å•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(RagProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagAutoConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    EmbeddingStore&lt;TextSegment&gt; <span class="title function_">embeddingStore</span><span class="params">()</span> &#123; <span class="comment">// TODO bean name, type</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryEmbeddingStore</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean(&#123;</span></span><br><span class="line"><span class="meta">            EmbeddingModel.class,</span></span><br><span class="line"><span class="meta">            EmbeddingStore.class</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    ContentRetriever <span class="title function_">contentRetriever</span><span class="params">(EmbeddingModel embeddingModel,</span></span><br><span class="line"><span class="params">                                      EmbeddingStore&lt;TextSegment&gt; embeddingStore,</span></span><br><span class="line"><span class="params">                                      RagProperties ragProperties)</span> &#123;  <span class="comment">// TODO bean name, type</span></span><br><span class="line"></span><br><span class="line">        EmbeddingStoreContentRetriever.<span class="type">EmbeddingStoreContentRetrieverBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> EmbeddingStoreContentRetriever.builder()</span><br><span class="line">                .embeddingStore(embeddingStore)</span><br><span class="line">                .embeddingModel(embeddingModel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ragProperties != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">RetrievalProperties</span> <span class="variable">retrievalProperties</span> <span class="operator">=</span> ragProperties.getRetrieval();</span><br><span class="line">            <span class="keyword">if</span> (retrievalProperties != <span class="literal">null</span>) &#123;</span><br><span class="line">                builder</span><br><span class="line">                        .maxResults(retrievalProperties.maxResults)</span><br><span class="line">                        .minScore(retrievalProperties.minScore);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>ContentRetriever</code> ä¾èµ– <code>EmbeddingStore</code>å’Œ <code>EmbeddingModel</code>ï¼Œè€Œå¯¹äºå­˜å‚¨ï¼Œä¹Ÿæä¾›äº†ä¸€ä¸ªé»˜è®¤çš„<code>InMemoryEmbeddingStore</code> å®ç°</p><h1 id="å®ç°ä¸€ä¸ª-agent">å®ç°ä¸€ä¸ª Agent</h1><p>è¿™é‡Œå…·ä½“å°±çœ‹ langchain4j-examples çš„ä»£ç å§</p><p><ahref="https://github.com/langchain4j/langchain4j-examples/tree/main/customer-support-agent-example">langchain4j-examples/customer-support-agent-exampleat main Â· langchain4j/langchain4j-examples (github.com)</a></p><h1 id="spring">Spring</h1><p>é¡¹ç›®ä¸­çš„ä¸€äº›æ“ä½œï¼ˆç‰¹åˆ«æ˜¯ Bean è£…é…ï¼‰ç”¨åˆ°äº†ä¸€äº›å°‘è§çš„ Springèƒ½åŠ›ï¼Œåœ¨è¿™é‡Œæ•´ç†ä¸€ä¸‹</p><h2 id="beanfactorypostprocessor">BeanFactoryPostProcessor</h2><blockquote><p>Factory hook that allows for custom modification of an applicationcontext's bean definitions, adapting the bean property values of thecontext's underlying bean factory.</p></blockquote><p>åœ¨æ ‡å‡†åˆå§‹åŒ–ï¼ˆ standard initializationï¼‰åä¿®æ”¹ä¸Šä¸‹æ–‡çš„å†…éƒ¨ Bean å·¥å‚æ‰€æœ‰ Bean Definition éƒ½å°†è¢«åŠ è½½ï¼Œä½†è¿˜æ²¡æœ‰ä»»ä½• Bean è¢«å®ä¾‹åŒ–å°†å…è®¸é‡å†™æˆ–æ·»åŠ å±æ€§ï¼Œç”šè‡³å¯ä»¥å°†å…¶æ·»åŠ åˆ° eager-initializing beans ä¸­&gt;</p><p>æ‰€ä»¥ <code>BeanFactoryPostProcessor</code> æœ¬è´¨ä¸Šå°±æ˜¯ç”¨äºå¢å¼º BeanDefinition å³å…ƒæ•°æ®ï¼Œæ­¤æ—¶ Bean è¿˜æ²¡æœ‰è¿›è¡Œå®ä¾‹åŒ–</p><p><code>BeanFactoryPostProcessor</code> æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°ä¸­æä¾›çš„ <code>ConfigurableListableBeanFactory</code>å¯ä»¥ç”¨æ¥æšä¸¾æ‰€æœ‰çš„ Bean Definitionï¼Œä»è€Œå¯ä»¥è¿›è¡Œä¿®æ”¹ Bean Definitionä¿¡æ¯ç­‰æ“ä½œ</p><p>ä¹Ÿå¯ä»¥é€šè¿‡ <code>getBean</code> ç³»åˆ—æ–¹æ³•è·å– Bean æˆ–å°†å…¶åˆå§‹åŒ–</p><h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3><p>ä»¥ <code>CustomAutowireConfigurer</code> ä¸¾ä¾‹ï¼Œå®ƒæ˜¯<code>BeanFactoryPostProcessor</code> çš„å®ç°ç±»ï¼Œä½œç”¨æ˜¯ç”¨æˆ·è‡ªå®šä¹‰ç±»ä¼¼<code>@Qualifier</code> åŠŸèƒ½çš„æ³¨è§£</p><p>å®šä¹‰ä¸€ä¸ª Bean ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.CONSTRUCTOR, ElementType.METHOD, ElementType.PARAMETER, ElementType.FIELD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAutowired &#123;</span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è£…é…ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@MyAutowired(name = &quot;zhangsan&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">zhangsanStudent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Student.builder().name(<span class="string">&quot;zhangsan&quot;</span>).age(<span class="number">18</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@MyAutowired(name = &quot;lisi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">lisiStudent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Student.builder().name(<span class="string">&quot;lisi&quot;</span>).age(<span class="number">19</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BeanFactoryPostProcessor <span class="title function_">initMyBeanFactoryPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CustomAutowireConfigurer</span> <span class="variable">customAutowireConfigurer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomAutowireConfigurer</span>();</span><br><span class="line">        customAutowireConfigurer.setCustomQualifierTypes(Set.of(MyAutowired.class));</span><br><span class="line">        <span class="keyword">return</span> customAutowireConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ContextRefreshedEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@MyAutowired(name = &quot;lisi&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Student student;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyAspect student:&quot;</span> + student);</span><br><span class="line">        <span class="comment">// MyAspect student:Student(age=19, name=lisi)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="beanpostprocessor">BeanPostProcessor</h2><blockquote><p>Factory hook that allows for custom modification of new beaninstances â€” for example, checking for marker interfaces or wrappingbeans with proxies.</p></blockquote><p>å·¥å‚ç›¸å…³çš„é’©å­ï¼Œå…è®¸è‡ªå®šä¹‰ä¿®æ”¹æ–°çš„ Bean å®ä¾‹ ä¾‹å¦‚æ£€æŸ¥æ ‡è®°çš„æ¥å£æˆ–è€…ç»™Bean åŒ…è£…ä»£ç† &gt;</p><p>å› ä¸ºå’Œ <code>BeanFactoryPostProcessor</code>åå­—å¾ˆåƒï¼Œæ‰€ä»¥æ˜ç¡®åŒºåˆ†ä¸¤ä¸ªé’©å­åŒºåˆ«å¾ˆé‡è¦ï¼Œå¦å¤–ä¹Ÿçœ‹ä¸€ä¸‹<code>InitializingBean</code></p><p><ahref="https://stackoverflow.com/questions/30455536/beanfactorypostprocessor-and-beanpostprocessor-in-lifecycle-events">java- BeanFactoryPostProcessor and BeanPostProcessor in lifecycle events -Stack Overflow</a></p><table><colgroup><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /></colgroup><thead><tr class="header"><th>hook</th><th>BeanFactoryPostProcessor</th><th>BeanPostProcessor</th><th>InitializingBean</th></tr></thead><tbody><tr class="odd"><td>ç”Ÿå‘½å‘¨æœŸ</td><td>åˆå§‹åŒ–å®Œæˆ initialization</td><td>å®ä¾‹åŒ–ä¸­ instantiation</td><td>å®ä¾‹åŒ–å®Œæˆ</td></tr><tr class="even"><td>æ ¸å¿ƒèƒ½åŠ›</td><td>è·å–ã€ä¿®æ”¹ã€æ·»åŠ  BeanDefinition</td><td>æ£€æŸ¥ã€å¢å¼º Bean</td><td>Bean å®ä¾‹åŒ–å®Œæˆåè¦åšçš„æ“ä½œ</td></tr><tr class="odd"><td>è°ƒç”¨æ—¶æœº</td><td>æ‰€æœ‰ BeanDefinition åˆå§‹åŒ–å®Œæˆ</td><td>æ¯ä¸ª Bean å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨æ„é€ å™¨å‰å</td><td>æ¯ä¸ª Bean å®ä¾‹åŒ–å®Œæˆå</td></tr></tbody></table><p>æ”¾ä¸€å¼ è€ç”Ÿå¸¸è°ˆçš„ç”Ÿå‘½å‘¨æœŸå›¾ç¤º</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain4j/langchain4j-spring%20%E5%AD%A6%E4%B9%A0/bean-lifecycle.png" class="" title="Untitled"><h2 id="factorybean">FactoryBean</h2><blockquote><p>If a bean implements this interface, it is used as a factory for anobject to expose, not directly as a bean instance that will be exposedit self.</p></blockquote><p>å¦‚æœä¸€ä¸ª Beanå®ç°äº†è¿™ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šä½œä¸ºä¸€ä¸ªå…¬å¼€çš„å·¥å‚ï¼Œè€Œä¸æ˜¯ä½œä¸ºä¸€ä¸ªå…¬å¼€çš„ Beanå®ä¾‹ï¼ˆä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå·¥å‚ Bean æ˜¯ä¸å…¬å¼€çš„ï¼Œå…¶ç”Ÿäº§çš„å®ä¾‹æ˜¯å…¬å¼€çš„ï¼‰ &gt;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Class&lt;?&gt; getObjectType();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤ã€éœ€è¦å®ç°çš„æ–¹æ³•</p><ul><li><code>getObject</code>ï¼šè¿”å›æ„å»ºçš„ Bean</li><li><code>getObjectType</code>ï¼šè¿”å› Bean çš„ Classå¯¹è±¡ï¼ˆæˆ‘è®¤ä¸ºæ˜¯ä¸ºäº†è§£å†³æ³›å‹æ“¦é™¤ï¼‰</li><li><code>isSingleton</code>ï¼šå•ä¾‹è¿˜æ˜¯åŸå‹</li></ul><h3 id="ç¤ºä¾‹-1">ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentFactory</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Student&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">getObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Student.builder()</span><br><span class="line">                .name(<span class="string">&quot;this is a factory bean&quot;</span>)</span><br><span class="line">                .age(-<span class="number">1</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Student.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ContextRefreshedEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Student student;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyAspect student:&quot;</span> + student);</span><br><span class="line">        <span class="comment">// MyAspect student:Student(age=-1, name=this is a factory bean)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="genericbeandefinition">GenericBeanDefinition</h2><p><code>GenericBeanDefinition</code> æ˜¯<code>AbstractBeanDefinition</code> æœ€åŸºæœ¬çš„å®ç°</p><p>éœ€è¦é€šè¿‡ Bean Definition æ¥å®šä¹‰ä¸€ä¸ªç®€å• Bean æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»ï¼Œåœ¨langchain4j-spring ä¸­å°±ä½¿ç”¨å®ƒæ¥è¡¥å…… <code>AiService</code> å®ç°çš„Bean</p><p>ä»¥ä¸‹æ˜¯ä¸€äº› <code>GenericBeanDefinition</code> çš„é‡è¦ API</p><ul><li><code>setParentName</code> ï¼šç”¨äºè®¾ç½®çˆ¶ Bean çš„åç§°ï¼Œæ­¤ Beanå°†ç»§æ‰¿çˆ¶ Bean çš„æ‰€æœ‰é…ç½®</li><li><code>setBeanClassName</code> ï¼šç”¨äºè®¾ç½®æ­¤ Bean çš„å…¨é™å®šç±»å</li><li><code>setScope</code> ï¼šç”¨äºè®¾ç½®æ­¤ Bean çš„ä½œç”¨èŒƒå›´ï¼Œå¦‚<code>singleton</code> æˆ– <code>prototype</code></li><li><code>setPropertyValues(MutablePropertyValues)</code> ï¼šç”¨äºè®¾ç½®æ­¤Bean çš„å±æ€§å€¼</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://stackoverflow.com/questions/30455536/beanfactorypostprocessor-and-beanpostprocessor-in-lifecycle-events">java- BeanFactoryPostProcessor and BeanPostProcessor in lifecycle events -Stack Overflow</a></p><p><ahref="https://docs.langchain4j.dev/tutorials/spring-boot-integration/">SpringBoot Integration | LangChain4j</a></p><p><ahref="https://github.com/langchain4j/langchain4j-spring">langchain4j/langchain4j-spring:LangChain4j integration with Spring (github.com)</a></p><p><ahref="https://github.com/langchain4j/langchain4j-examples">langchain4j/langchain4j-examples(github.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain4j </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> æºç  </tag>
            
            <tag> LangChain4j </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ragas æ ¸å¿ƒæ¦‚å¿µ</title>
      <link href="/%E5%BC%80%E5%8F%91/AI/Ragas%20%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5.html"/>
      <url>/%E5%BC%80%E5%8F%91/AI/Ragas%20%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>Ragas æ˜¯ä¸€ä¸ªå¸®åŠ©è¯„ä¼° RAGï¼ˆRetrieval AugmentedGenerationï¼‰ç®¡é“çš„æ¡†æ¶</p><blockquote><p>Ragas is a framework that helps you evaluate your Retrieval AugmentedGeneration (RAG) pipelines. RAG denotes a class of LLM applications thatuse external data to augment the LLMâ€™s context. There are existing toolsand frameworks that help you build these pipelines but evaluating it andquantifying your pipeline performance can be hard. This is where Ragas(RAG Assessment) comes in.</p></blockquote><p>æä¾›æœ€æ–°ç ”ç©¶çš„å·¥å…·è¯„ä¼° LLM ç”Ÿæˆçš„æ–‡æœ¬ï¼Œæ·±å…¥ç†è§£ RAG ç®¡é“ï¼›å¹¶ä¸”å¯ä»¥å’ŒCI Â CD é›†æˆï¼Œæä¾›æŒç»­çš„æ£€æŸ¥æœºåˆ¶ä¿è¯æ•ˆæœ</p><p><a href="https://github.com/explodinggradients/ragas">Githubexplodinggradients / Ragas</a></p><p>å®˜æ–¹æ–‡æ¡£çš„ Core Concepts ç« èŠ‚æåˆ°äº†ä¸€äº›è¡¡é‡ RAGæ•ˆæœçš„æ¦‚å¿µï¼Œåœ¨è¿™ç¯‡æ–‡æ¡£åšä¸‹ç¿»è¯‘å’Œæ•´ç†</p><p>è¿™é‡Œåªæ•´ç†æ ¸å¿ƒæ¦‚å¿µä¸­é€šç”¨çš„æ¦‚å¿µéƒ¨åˆ†ï¼Œå…³äº Ragaså¦‚ä½•ä½¿ç”¨ã€ç›¸å…³è®¾è®¡ä¸åœ¨è¿™é‡Œæ¶‰åŠ</p><h1 id="ä½œç”¨">ä½œç”¨</h1><p>Ragas æ—¨åœ¨å»ºç«‹ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ã€ä¸ºå¼€å‘äººå‘˜æä¾›æŒç»­å­¦ä¹ çš„å·¥å…·å’ŒæŠ€æœ¯ç”¨äºå…¶RAG åº”ç”¨ç¨‹åºä¸­</p><p>æœ‰äº† Ragas å¯ä»¥åšåˆ°</p><ol type="1"><li>ç»¼åˆç”Ÿæˆä¸€ä¸ªå¤šæ ·åŒ–çš„æµ‹è¯•æ•°æ®é›†ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è¯„ä¼°åº”ç”¨ç¨‹åº</li><li>ä½¿ç”¨ LLM è¾…åŠ©è¯„ä¼°æŒ‡æ ‡ï¼Œå®¢è§‚åœ°è¡¡é‡åº”ç”¨ç¨‹åºçš„æ€§èƒ½</li><li>ä½¿ç”¨æ›´å°ã€æ›´ä¾¿å®œçš„æ¨¡å‹æ¥ç›‘æ§åº”ç”¨ç¨‹åºåœ¨ç”Ÿäº§ä¸­çš„è´¨é‡ï¼Œè¿™äº›æ¨¡å‹å¯ä»¥æä¾›æœ‰æ•ˆå¯ä¼˜åŒ–çš„å»ºè®®ï¼ˆactionableinsightsï¼‰ï¼›ä¾‹å¦‚ï¼Œç”Ÿæˆçš„ç­”æ¡ˆä¸­å‡ºç°å¹»è§‰çš„æ•°é‡</li><li>ä½¿ç”¨è¿™äº›å»ºè®®æ¥è¿­ä»£å’Œæ”¹è¿›åº”ç”¨ç¨‹åº</li></ol><h1 id="æŒ‡æ ‡é©±åŠ¨å¼€å‘">æŒ‡æ ‡é©±åŠ¨å¼€å‘</h1><p>è™½ç„¶åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ LLMæœåŠ¡æ˜¯ç®€å•çš„ï¼Œä½†æ˜¯æŒ‘æˆ˜åœ¨äºæŒç»­çš„ç»´æŠ¤å’Œä¸æ–­çš„å¢å¼ºï¼ŒRagasçš„æ„¿æ™¯æ˜¯é€šè¿‡é‡‡ç”¨æŒ‡æ ‡é©±åŠ¨å¼€å‘ï¼ˆMetrics-Driven Developmentï¼‰çš„æ€æƒ³ï¼Œä¿ƒè¿›LLM å’Œ RAG åº”ç”¨ç¨‹åºçš„æŒç»­è¿­ä»£</p><p>MDDæ˜¯ä¸€ç§ä¾èµ–æ•°æ®æ¥åšå‡ºæ˜æ™ºå†³ç­–çš„äº§å“å¼€å‘æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦éšç€æ—¶é—´çš„æ¨ç§»ä¸æ–­ç›‘æ§åŸºæœ¬æŒ‡æ ‡ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºçš„æ•ˆæœæä¾›æœ‰ä»·å€¼çš„å»ºè®®</p><p>Ragas çš„ä½¿å‘½æ˜¯å»ºç«‹ä¸€ä¸ªå°† MDD åº”ç”¨äº LLM å’Œ RAG åº”ç”¨ç¨‹åºçš„å¼€æºæ ‡å‡†</p><ul><li>è¯„ä¼°ï¼šè¯„ä¼° LLM åº”ç”¨æ—¶ä½¿ç”¨æŒ‡æ ‡è¾…åŠ©çš„æ–¹å¼ï¼Œç¡®ä¿é«˜å¯é æ€§å’Œå¯å¤ç°</li><li>ç›‘æ§ï¼šä»ç”Ÿäº§æ•°æ®ç‚¹è·å¾—æœ‰ä»·å€¼å’Œæœ‰æ•ˆå¯ä¼˜åŒ–çš„å»ºè®®ï¼Œæœ‰åŠ©äºä¸æ–­æé«˜ LLMåº”ç”¨çš„è´¨é‡</li></ul><h1 id="æŒ‡æ ‡">æŒ‡æ ‡</h1><p><strong>Ragas æä¾›ç»„ä»¶å¼è¯„ä¼°</strong></p><p>å°±åƒåœ¨ä»»ä½•æœºå™¨å­¦ä¹ ç³»ç»Ÿä¸­ä¸€æ ·ï¼ŒLLM å’Œ RAGç®¡é“ä¸­å•ä¸ªç»„ä»¶çš„æ€§èƒ½å¯¹æ•´ä½“ä½“éªŒæœ‰ç€é‡å¤§å½±å“</p><p>Ragas æä¾›é‡èº«å®šåˆ¶çš„æŒ‡æ ‡ï¼Œç”¨äºå•ç‹¬è¯„ä¼° RAG ç®¡é“çš„æ¯ä¸ªç»„ä»¶</p><h2 id="å¿ å®æ€§faithfulness">å¿ å®æ€§ï¼ˆFaithfulnessï¼‰</h2><blockquote><p>ç­”æ¡ˆçš„å†…å®¹æ˜¯ä¸æ˜¯éƒ½èƒ½ç”±ææ–™è¿›è¡Œæ¨æ–­</p></blockquote><p>è¡¡é‡äº†ç”Ÿæˆçš„ç­”æ¡ˆåœ¨ç»™å®šä¸Šä¸‹æ–‡ä¸­çš„äº‹å®ä¸€è‡´æ€§ï¼Œå®ƒæ˜¯æ ¹æ®ç­”æ¡ˆå’Œæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡æ¥è®¡ç®—çš„</p><p>ç»“æœä¼šè¢«ç¼©æ”¾åœ¨ 0 åˆ° 1 èŒƒå›´ï¼Œè¶Šé«˜è¶Šå¥½</p><p>å¦‚æœç­”æ¡ˆä¸­çš„æ‰€æœ‰å£°æ˜éƒ½å¯ä»¥ä»ç»™å®šçš„ä¸Šä¸‹æ–‡ä¸­æ¨æ–­å‡ºæ¥ï¼Œåˆ™ç”Ÿæˆçš„ç­”æ¡ˆè¢«è§†ä¸ºå¯ä¿¡çš„ï¼›ä¸ºäº†è®¡ç®—è¯¥å€¼é¦–å…ˆæ ¹æ®ç”Ÿæˆçš„ç­”æ¡ˆç¡®å®šä¸€ç»„ç´¢èµ”ã€‚ç„¶åå°†è¿™äº›å£°æ˜ä¸­çš„æ¯ä¸€ä¸ªä¸ç»™å®šçš„ä¸Šä¸‹æ–‡è¿›è¡Œäº¤å‰æ£€æŸ¥ï¼Œä»¥ç¡®å®šå®ƒæ˜¯å¦å¯ä»¥ä»ç»™å®šçš„ä¸Šä¸‹æ–‡ä¸­æ¨æ–­å‡º</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 105.694ex;"><svg style="vertical-align: -2.17ex; min-width: 105.694ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="5.471ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1459)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(800,0) translate(-800,0)"><g transform="translate(0 1459) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="22558.3 -1459 1 2418"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr"><g data-mml-node="mtd"><g data-mml-node="mtext"><path data-c="46" d="M128 619Q121 626 117 628T101 631T58 634H25V680H582V676Q584 670 596 560T610 444V440H570V444Q563 493 561 501Q555 538 543 563T516 601T477 622T431 631T374 633H334H286Q252 633 244 631T233 621Q232 619 232 490V363H284Q287 363 303 363T327 364T349 367T372 373T389 385Q407 403 410 459V480H450V200H410V221Q407 276 389 296Q381 303 371 307T348 313T327 316T303 317T284 317H232V189L233 61Q240 54 245 52T270 48T333 46H360V0H348Q324 3 182 3Q51 3 36 0H25V46H58Q100 47 109 49T128 61V619Z"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(653,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1153,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1431,0)"></path><path data-c="68" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 124T102 167T103 217T103 272T103 329Q103 366 103 407T103 482T102 542T102 586T102 603Q99 622 88 628T43 637H25V660Q25 683 27 683L37 684Q47 685 66 686T103 688Q120 689 140 690T170 693T181 694H184V367Q244 442 328 442Q451 442 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1820,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(2376,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(2682,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(3238,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3516,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4072,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(4516,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(4910,0)"></path><path data-c="20" d="" transform="translate(5304,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(5554,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(5948,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(6392,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(6892,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(7284,0)"></path></g><g data-mml-node="mo" transform="translate(8005.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(9061.6,0)"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(220,709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(278,0)"><path data-c="4E" d="M42 46Q74 48 94 56T118 69T128 86V634H124Q114 637 52 637H25V683H232L235 680Q237 679 322 554T493 303L578 178V598Q572 608 568 613T544 627T492 637H475V683H483Q498 680 600 680Q706 680 715 683H724V637H707Q634 633 622 598L621 302V6L614 0H600Q585 0 582 3T481 150T282 443T171 605V345L172 86Q183 50 257 46H274V0H265Q250 3 150 3Q48 3 33 0H25V46H42Z"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(750,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1306,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(2139,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(2695,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(3139,0)"></path><path data-c="20" d="" transform="translate(3531,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(3781,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(4281,0)"></path><path data-c="20" d="" transform="translate(4587,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(4837,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(5281,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(5559,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(6059,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(6337,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(7170,0)"></path><path data-c="20" d="" transform="translate(7564,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(7814,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(8092,0)"></path><path data-c="20" d="" transform="translate(8648,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(8898,0)"></path><path data-c="68" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 124T102 167T103 217T103 272T103 329Q103 366 103 407T103 482T102 542T102 586T102 603Q99 622 88 628T43 637H25V660Q25 683 27 683L37 684Q47 685 66 686T103 688Q120 689 140 690T170 693T181 694H184V367Q244 442 328 442Q451 442 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(9287,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(9843,0)"></path><path data-c="20" d="" transform="translate(10287,0)"></path><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(10537,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(11037,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(11481,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(12037,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(12481,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(12873,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(13373,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(13762,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(14206,0)"></path><path data-c="20" d="" transform="translate(14762,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(15012,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(15512,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(16068,0)"></path><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z" transform="translate(16462,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(17184,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(17628,0)"></path><path data-c="20" d="" transform="translate(18020,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(18270,0)"></path><path data-c="68" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 124T102 167T103 217T103 272T103 329Q103 366 103 407T103 482T102 542T102 586T102 603Q99 622 88 628T43 637H25V660Q25 683 27 683L37 684Q47 685 66 686T103 688Q120 689 140 690T170 693T181 694H184V367Q244 442 328 442Q451 442 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(18659,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(19215,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(19715,0)"></path><path data-c="20" d="" transform="translate(20104,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(20354,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(20798,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(21298,0)"></path><path data-c="20" d="" transform="translate(21854,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(22104,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(22660,0)"></path><path data-c="20" d="" transform="translate(23104,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(23354,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(23632,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(24188,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(24494,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(24938,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(25330,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(25722,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(26166,0)"></path><path data-c="20" d="" transform="translate(26722,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(26972,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(27278,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(27670,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(28170,0)"></path><path data-c="20" d="" transform="translate(29003,0)"></path><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(29253,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(29753,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(30031,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(30559,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(31003,0)"></path><path data-c="20" d="" transform="translate(31559,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(31809,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(32253,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(32753,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(33309,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(33698,0)"></path><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(34142,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(34670,0)"></path></g><g data-mml-node="mo" transform="translate(35337,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><g data-mml-node="mrow" transform="translate(7517,-709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(278,0)"><path data-c="54" d="M36 443Q37 448 46 558T55 671V677H666V671Q667 666 676 556T685 443V437H645V443Q645 445 642 478T631 544T610 593Q593 614 555 625Q534 630 478 630H451H443Q417 630 414 618Q413 616 413 339V63Q420 53 439 50T528 46H558V0H545L361 3Q186 1 177 0H164V46H194Q264 46 283 49T309 63V339V550Q309 620 304 625T271 630H244H224Q154 630 119 601Q101 585 93 554T81 486T76 443V437H36V443Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(722,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1222,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(1611,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(2111,0)"></path><path data-c="20" d="" transform="translate(2389,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2639,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(3195,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3751,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(4584,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(5140,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(5584,0)"></path><path data-c="20" d="" transform="translate(5976,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(6226,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(6726,0)"></path><path data-c="20" d="" transform="translate(7032,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(7282,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(7726,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(8004,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(8504,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(8782,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(9615,0)"></path><path data-c="20" d="" transform="translate(10009,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(10259,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(10537,0)"></path><path data-c="20" d="" transform="translate(11093,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(11343,0)"></path><path data-c="68" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 124T102 167T103 217T103 272T103 329Q103 366 103 407T103 482T102 542T102 586T102 603Q99 622 88 628T43 637H25V660Q25 683 27 683L37 684Q47 685 66 686T103 688Q120 689 140 690T170 693T181 694H184V367Q244 442 328 442Q451 442 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(11732,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(12288,0)"></path><path data-c="20" d="" transform="translate(12732,0)"></path><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(12982,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(13482,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(13926,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(14482,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(14926,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(15318,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(15818,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(16207,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(16651,0)"></path><path data-c="20" d="" transform="translate(17207,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(17457,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(17957,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(18513,0)"></path><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z" transform="translate(18907,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(19629,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(20073,0)"></path></g><g data-mml-node="mo" transform="translate(20743,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><rect width="35815" height="60" x="120" y="220"></rect></g></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="0 -1459 1 2418"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:"><g data-mml-node="mrow"></g></g></g></svg></g></g></g></g></svg></mjx-container></span></p><h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3><ul><li><strong>Question</strong>: Where and when was Einstein born?</li><li><strong>Context</strong>: Albert Einstein (born 14 March 1879) was aGerman-born theoretical physicist, widely held to be one of the greatestand most influential scientists of all time</li><li><strong>High faithfulness answer</strong>: Einstein was born inGermany on 14th March 1879.</li><li><strong>Low faithfulness answer</strong>: Einstein was born inGermany on 20th March 1879.</li></ul><h3 id="è®¡ç®—">è®¡ç®—</h3><ol type="1"><li><strong>Step 1</strong> æ‹†åˆ†å›ç­”ä¸ºå¤šä¸ªç‹¬ç«‹çš„é™ˆè¿°<ul><li>è¯­å¥<ul><li>Einstein was born in Germany.</li><li>Einstein was born on 20th March 1879.</li></ul></li></ul></li><li><strong>Step 2</strong>é’ˆå¯¹æ¯ä¸ªè¯­å¥éªŒè¯å…¶æ˜¯å¦å¯ä»¥ç”±ç»™å‡ºçš„ä¸Šä¸‹æ–‡æ¨æ–­å‡º<ul><li>Yes</li><li>No</li></ul></li><li><strong>Step 3</strong> ä½¿ç”¨ä¸Šè¿°å…¬å¼è®¡ç®—å¿ å®æ€§ faithfulness = 1 / 2= 0.5</li></ol><h2 id="ç­”æ¡ˆç›¸å…³æ€§answer-relevance">ç­”æ¡ˆç›¸å…³æ€§ï¼ˆAnswer Relevanceï¼‰</h2><p>ç­”æ¡ˆç›¸å…³æ€§ä¾§é‡è¯„ä¼°ç­”æ¡ˆå’Œç»™å‡º Promptä¹‹é—´çš„ç›¸å…³æ€§ï¼Œè¾ƒä½çš„å¾—åˆ†è¡¨ç¤ºç­”æ¡ˆä¸å®Œæ•´æˆ–è€…åŒ…å«å†—ä½™ä¿¡æ¯</p><p>è¿™ä¸ªæŒ‡æ ‡é€šè¿‡é—®é¢˜ã€ä¸Šä¸‹æ–‡å’Œç­”æ¡ˆæ¥è®¡ç®—</p><p>ç­”æ¡ˆç›¸å…³æ€§å®šä¹‰ä¸ºåŸå§‹é—®é¢˜ä¸ä¸€ç³»åˆ—åŸºäºç­”æ¡ˆç”Ÿæˆçš„äººå·¥é—®é¢˜ï¼ˆé€†å‘ï¼‰çš„å¹³å‡ä½™å¼¦ç›¸ä¼¼åº¦<span class="math display"><mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 42.023ex;"><svg style="vertical-align: -2.804ex; min-width: 42.023ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="6.74ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1739.4)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(800,0) translate(-800,0)"><g transform="translate(0 1739.4) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="8487 -1739.4 1 2978.9"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,6.5)"><g data-mml-node="mtd"><g data-mml-node="mtext"><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(500,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1056,0)"></path><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z" transform="translate(1450,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(2172,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2616,0)"></path><path data-c="20" d="" transform="translate(3008,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(3258,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(3650,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(4094,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4372,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(4816,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(5344,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(5844,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(6400,0)"></path><path data-c="79" d="M69 -66Q91 -66 104 -80T118 -116Q118 -134 109 -145T91 -160Q84 -163 97 -166Q104 -168 111 -168Q131 -168 148 -159T175 -138T197 -106T213 -75T225 -43L242 0L170 183Q150 233 125 297Q101 358 96 368T80 381Q79 382 78 382Q66 385 34 385H19V431H26L46 430Q65 430 88 429T122 428Q129 428 142 428T171 429T200 430T224 430L233 431H241V385H232Q183 385 185 366L286 112Q286 113 332 227L376 341V350Q376 365 366 373T348 383T334 385H331V431H337H344Q351 431 361 431T382 430T405 429T422 429Q477 429 503 431H508V385H497Q441 380 422 345Q420 343 378 235T289 9T227 -131Q180 -204 113 -204Q69 -204 44 -177T19 -116Q19 -89 35 -78T69 -66Z" transform="translate(6844,0)"></path></g><g data-mml-node="mo" transform="translate(7649.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(8705.6,0)"><g data-mml-node="mn" transform="translate(414,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><rect width="1088" height="60" x="120" y="220"></rect></g><g data-mml-node="munderover" transform="translate(10200.2,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"></path></g><g data-mml-node="TeXAtom" transform="translate(148.2,-1087.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="TeXAtom" transform="translate(408,1150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g></g></g><g data-mml-node="mi" transform="translate(11810.9,0)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(12243.9,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(12728.9,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mo" transform="translate(13197.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(13586.9,0)"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="TeXAtom" transform="translate(771,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g></g><g data-mml-node="mo" transform="translate(14976.4,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(15421,0)"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(771,-150) scale(0.707)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g></g><g data-mml-node="mo" transform="translate(16585,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="0 -1739.4 1 2978.9"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:" transform="translate(0,6.5)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,0)"><g data-mml-node="mrow"></g></g></g></g></svg></g></g></g></g></svg></mjx-container></span></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 41.639ex;"><svg style="vertical-align: -2.804ex; min-width: 41.639ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="6.74ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1739.4)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(800,0) translate(-800,0)"><g transform="translate(0 1739.4) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="8402.2 -1739.4 1 2978.9"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,6.5)"><g data-mml-node="mtd"><g data-mml-node="mtext"><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(500,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1056,0)"></path><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z" transform="translate(1450,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(2172,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2616,0)"></path><path data-c="20" d="" transform="translate(3008,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(3258,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(3650,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(4094,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4372,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(4816,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(5344,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(5844,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(6400,0)"></path><path data-c="79" d="M69 -66Q91 -66 104 -80T118 -116Q118 -134 109 -145T91 -160Q84 -163 97 -166Q104 -168 111 -168Q131 -168 148 -159T175 -138T197 -106T213 -75T225 -43L242 0L170 183Q150 233 125 297Q101 358 96 368T80 381Q79 382 78 382Q66 385 34 385H19V431H26L46 430Q65 430 88 429T122 428Q129 428 142 428T171 429T200 430T224 430L233 431H241V385H232Q183 385 185 366L286 112Q286 113 332 227L376 341V350Q376 365 366 373T348 383T334 385H331V431H337H344Q351 431 361 431T382 430T405 429T422 429Q477 429 503 431H508V385H497Q441 380 422 345Q420 343 378 235T289 9T227 -131Q180 -204 113 -204Q69 -204 44 -177T19 -116Q19 -89 35 -78T69 -66Z" transform="translate(6844,0)"></path></g><g data-mml-node="mo" transform="translate(7649.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(8705.6,0)"><g data-mml-node="mn" transform="translate(414,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><rect width="1088" height="60" x="120" y="220"></rect></g><g data-mml-node="munderover" transform="translate(10200.2,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"></path></g><g data-mml-node="TeXAtom" transform="translate(148.2,-1087.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="TeXAtom" transform="translate(408,1150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g></g></g><g data-mml-node="mfrac" transform="translate(11810.9,0)"><g data-mml-node="mrow" transform="translate(858.8,755)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="TeXAtom" transform="translate(771,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g></g><g data-mml-node="mo" transform="translate(1611.7,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="msub" transform="translate(2111.9,0)"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(771,-150) scale(0.707)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g></g></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="mo"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"></path></g><g data-mml-node="msub" transform="translate(500,0)"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="TeXAtom" transform="translate(771,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g></g><g data-mml-node="mo" transform="translate(1889.5,0)"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"></path></g><g data-mml-node="mo" transform="translate(2389.5,0)"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"></path></g><g data-mml-node="msub" transform="translate(2889.5,0)"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(771,-150) scale(0.707)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g></g><g data-mml-node="mo" transform="translate(4053.4,0)"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"></path></g></g><rect width="4753.4" height="60" x="120" y="220"></rect></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="0 -1739.4 1 2978.9"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:" transform="translate(0,6.5)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,0)"><g data-mml-node="mrow"></g></g></g></g></svg></g></g></g></g></svg></mjx-container></span></p><p>å…¶ä¸­</p><ul><li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.667ex;" xmlns="http://www.w3.org/2000/svg" width="3.144ex" height="2.206ex" role="img" focusable="false" viewBox="0 -680 1389.5 975"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="TeXAtom" transform="translate(771,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g></g></g></g></svg></mjx-container></span>â€‹ æ˜¯ç”Ÿæˆé—®é¢˜ i çš„embedding</li><li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.633ex" height="1.895ex" role="img" focusable="false" viewBox="0 -680 1163.9 837.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(771,-150) scale(0.707)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g></g></g></g></svg></mjx-container></span> æ˜¯åŸå§‹é—®é¢˜çš„ embedding</li><li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g></g></g></svg></mjx-container></span> æ˜¯ç”Ÿæˆçš„é—®é¢˜æ•°é‡ï¼Œé»˜è®¤ä¸º3</li></ul><p>éœ€è¦æ³¨æ„å°½ç®¡åœ¨å®è·µä¸­ï¼Œåˆ†æ•°å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ 0 åˆ° 1ä¹‹é—´ï¼Œä½†ç”±äºä½™å¼¦ç›¸ä¼¼åº¦åœ¨ -1 åˆ° 1ä¹‹é—´çš„æ€§è´¨ï¼Œåœ¨æ•°å­¦ä¸Šä¸èƒ½ä¿è¯å€¼ä¸€å®šæ˜¯æ­£æ•°</p><p>å½“ä¸€ä¸ªç­”æ¡ˆç›´æ¥æ°å½“åœ°è§£å†³äº†åŸå§‹é—®é¢˜æ—¶ï¼Œå®ƒå°±è¢«è®¤ä¸ºæ˜¯ç›¸å…³çš„ï¼›é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¯¹ç­”æ¡ˆç›¸å…³æ€§çš„è¯„ä¼°æ²¡æœ‰è€ƒè™‘äº‹å®æ€§ï¼Œè€Œæ˜¯æƒ©ç½šç­”æ¡ˆç¼ºä¹å®Œæ•´æ€§æˆ–åŒ…å«å¤šä½™ç»†èŠ‚çš„æƒ…å†µï¼Œä¸ºäº†è®¡ç®—è¯¥åˆ†æ•°ï¼Œå¤šæ¬¡æç¤ºLLMä¸ºç”Ÿæˆçš„ç­”æ¡ˆç”Ÿæˆé€‚å½“çš„é—®é¢˜ï¼Œå¹¶æµ‹é‡è¿™äº›ç”Ÿæˆçš„é—®é¢˜ä¸åŸå§‹é—®é¢˜ä¹‹é—´çš„å¹³å‡ä½™å¼¦ç›¸ä¼¼æ€§</p><p>å…¶åŸºæœ¬æ€æƒ³æ˜¯ï¼Œ<strong>å¦‚æœç”Ÿæˆçš„ç­”æ¡ˆå‡†ç¡®åœ°è§£å†³äº†æœ€åˆçš„é—®é¢˜ï¼ŒLLMåº”è¯¥èƒ½å¤Ÿä»ä¸åŸå§‹é—®é¢˜ä¸€è‡´çš„ç­”æ¡ˆä¸­ç”Ÿæˆé—®é¢˜</strong></p><h3 id="ç¤ºä¾‹-1">ç¤ºä¾‹</h3><ul><li><strong>Question</strong>: Where is France and what is itâ€™scapital?</li><li><strong>High faithfulness answer</strong>: France is in westernEurope.</li><li><strong>Low faithfulness answer</strong>: France is in westernEurope and Paris is its capital.</li></ul><h3 id="è®¡ç®—-1">è®¡ç®—</h3><ol type="1"><li><strong>Step 1</strong> ä½¿ç”¨ LLM æ ¹æ®ç”Ÿæˆçš„ç­”æ¡ˆç”Ÿæˆ nä¸ªå˜ä½“é—®é¢˜ï¼›ä¾‹å¦‚å¯¹äºç¬¬ä¸€ä¸ªç­”æ¡ˆï¼ŒLLM å¯èƒ½ä¼šç”Ÿæˆä»¥ä¸‹å¯èƒ½çš„é—®é¢˜<ul><li>æ³•å›½ä½äºæ¬§æ´²çš„å“ªä¸ªåœ°åŒºï¼Ÿ</li><li>æ³•å›½åœ¨æ¬§æ´²çš„åœ°ç†ä½ç½®æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ä½ èƒ½ç¡®å®šæ³•å›½æ‰€åœ¨çš„æ¬§æ´²åœ°åŒºå—ï¼Ÿ</li></ul></li><li><strong>Step 2</strong>è®¡ç®—ç”Ÿæˆçš„é—®é¢˜ä¸å®é™…é—®é¢˜ä¹‹é—´çš„å¹³å‡ä½™å¼¦ç›¸ä¼¼åº¦</li></ol><h2 id="ä¸Šä¸‹æ–‡ç²¾ç¡®æ€§context-precision">ä¸Šä¸‹æ–‡ç²¾ç¡®æ€§ï¼ˆContextPrecisionï¼‰</h2><p>è¯„ä¼°ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨çš„æ‰€æœ‰åŸºæœ¬äº‹å®ç›¸å…³é¡¹ç›®çš„æ’åæ˜¯å¦æ›´é«˜ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ç›¸å…³çš„å—éƒ½å¿…é¡»å±äºæœ€é«˜çº§åˆ«</p><p>è¯¥å€¼é€šè¿‡é—®é¢˜ã€åŸºæœ¬äº‹å®ã€ä¸Šä¸‹æ–‡è®¡ç®—ï¼›å€¼åœ¨ 0 åˆ° 1ä¹‹é—´ï¼Œå¾—åˆ†è¶Šé«˜è¡¨ç¤ºç²¾åº¦è¶Šé«˜ <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 78.574ex;"><svg style="vertical-align: -2.425ex; min-width: 78.574ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="5.98ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1571.7)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(800,0) translate(-800,0)"><g transform="translate(0 1571.7) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="16564.8 -1571.7 1 2643.3"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,-191.7)"><g data-mml-node="mtd"><g data-mml-node="mtext"><path data-c="43" d="M56 342Q56 428 89 500T174 615T283 681T391 705Q394 705 400 705T408 704Q499 704 569 636L582 624L612 663Q639 700 643 704Q644 704 647 704T653 705H657Q660 705 666 699V419L660 413H626Q620 419 619 430Q610 512 571 572T476 651Q457 658 426 658Q322 658 252 588Q173 509 173 342Q173 221 211 151Q232 111 263 84T328 45T384 29T428 24Q517 24 571 93T626 244Q626 251 632 257H660L666 251V236Q661 133 590 56T403 -21Q262 -21 159 83T56 342Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(722,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1222,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1778,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(2167,0)"></path><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(2611,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(3139,0)"></path><path data-c="20" d="" transform="translate(3528,0)"></path><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z" transform="translate(3778,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(4459,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4851,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(5295,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(5739,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(6017,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(6411,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(6689,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(7189,0)"></path><path data-c="40" d="M56 347Q56 429 86 498T164 612T270 680T386 705Q522 705 622 603T722 349Q722 126 608 126Q541 126 513 176Q512 177 512 179T510 182L509 183Q508 183 503 177T487 163T464 146T429 132T385 126Q311 126 251 186T190 347Q190 448 251 508T385 568Q426 568 460 548T509 511T531 479H555Q580 479 582 478Q586 477 587 468Q588 454 588 338V260Q588 200 593 182T619 163Q641 163 655 178T674 223T680 273T682 325V330Q682 426 647 500Q611 569 544 618T388 668Q271 668 184 577T96 347Q96 216 180 121T396 26Q421 26 446 28T493 34T535 43T573 52T605 63T629 72T647 80T657 84H716Q722 78 722 74Q722 65 675 45T547 7T392 -11Q255 -11 156 90T56 347ZM274 347Q274 266 308 214T390 162Q420 162 449 182T498 235L504 245V449L498 459Q453 532 387 532Q347 532 311 483T274 347Z" transform="translate(7745,0)"></path><path data-c="4B" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q57 680 180 680Q315 680 324 683H335V637H313Q235 637 233 620Q232 618 232 462L233 307L379 449Q425 494 479 546Q518 584 524 591T531 607V608Q531 630 503 636Q501 636 498 636T493 637H489V683H499Q517 680 630 680Q704 680 716 683H722V637H708Q633 633 589 597Q584 592 495 506T406 419T515 254T631 80Q644 60 662 54T715 46H736V0H728Q719 3 615 3Q493 3 472 0H461V46H469Q515 46 515 72Q515 78 512 84L336 351Q332 348 278 296L232 251V156Q232 62 235 58Q243 47 302 46H335V0H324Q303 3 180 3Q45 3 36 0H25V46H58Q100 47 109 49T128 61V622Z" transform="translate(8523,0)"></path></g><g data-mml-node="mo" transform="translate(9578.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(10634.6,0)"><g data-mml-node="mrow" transform="translate(5853.7,803.3)"><g data-mml-node="munderover"><g data-mml-node="mo"><path data-c="2211" d="M61 748Q64 750 489 750H913L954 640Q965 609 976 579T993 533T999 516H979L959 517Q936 579 886 621T777 682Q724 700 655 705T436 710H319Q183 710 183 709Q186 706 348 484T511 259Q517 250 513 244L490 216Q466 188 420 134T330 27L149 -187Q149 -188 362 -188Q388 -188 436 -188T506 -189Q679 -189 778 -162T936 -43Q946 -27 959 6H999L913 -249L489 -250Q65 -250 62 -248Q56 -246 56 -239Q56 -234 118 -161Q186 -81 245 -11L428 206Q428 207 242 462L57 717L56 728Q56 744 61 748Z"></path></g><g data-mml-node="TeXAtom" transform="translate(1089,477.1) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g></g><g data-mml-node="TeXAtom" transform="translate(1089,-285.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(521,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(1299,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g><g data-mml-node="mrow" transform="translate(2577.8,0)"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mtext" transform="translate(389,0)"><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(681,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1073,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(1517,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1961,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(2239,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(2633,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2911,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3411,0)"></path><path data-c="40" d="M56 347Q56 429 86 498T164 612T270 680T386 705Q522 705 622 603T722 349Q722 126 608 126Q541 126 513 176Q512 177 512 179T510 182L509 183Q508 183 503 177T487 163T464 146T429 132T385 126Q311 126 251 186T190 347Q190 448 251 508T385 568Q426 568 460 548T509 511T531 479H555Q580 479 582 478Q586 477 587 468Q588 454 588 338V260Q588 200 593 182T619 163Q641 163 655 178T674 223T680 273T682 325V330Q682 426 647 500Q611 569 544 618T388 668Q271 668 184 577T96 347Q96 216 180 121T396 26Q421 26 446 28T493 34T535 43T573 52T605 63T629 72T647 80T657 84H716Q722 78 722 74Q722 65 675 45T547 7T392 -11Q255 -11 156 90T56 347ZM274 347Q274 266 308 214T390 162Q420 162 449 182T498 235L504 245V449L498 459Q453 532 387 532Q347 532 311 483T274 347Z" transform="translate(3967,0)"></path><path data-c="6B" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T97 124T98 167T98 217T98 272T98 329Q98 366 98 407T98 482T98 542T97 586T97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V463L180 233L240 287Q300 341 304 347Q310 356 310 364Q310 383 289 385H284V431H293Q308 428 412 428Q475 428 484 431H489V385H476Q407 380 360 341Q286 278 286 274Q286 273 349 181T420 79Q434 60 451 53T500 46H511V0H505Q496 3 418 3Q322 3 307 0H299V46H306Q330 48 330 65Q330 72 326 79Q323 84 276 153T228 222L176 176V120V84Q176 65 178 59T189 49Q210 46 238 46H254V0H246Q231 3 137 3T28 0H20V46H36Z" transform="translate(4745,0)"></path></g><g data-mml-node="mo" transform="translate(5884.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="msub" transform="translate(6884.4,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g><g data-mml-node="mo" transform="translate(7820.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mtext"><path data-c="54" d="M36 443Q37 448 46 558T55 671V677H666V671Q667 666 676 556T685 443V437H645V443Q645 445 642 478T631 544T610 593Q593 614 555 625Q534 630 478 630H451H443Q417 630 414 618Q413 616 413 339V63Q420 53 439 50T528 46H558V0H545L361 3Q186 1 177 0H164V46H194Q264 46 283 49T309 63V339V550Q309 620 304 625T271 630H244H224Q154 630 119 601Q101 585 93 554T81 486T76 443V437H36V443Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(722,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1222,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(1611,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(2111,0)"></path><path data-c="20" d="" transform="translate(2389,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2639,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(3195,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3751,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(4584,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(5140,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(5584,0)"></path><path data-c="20" d="" transform="translate(5976,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(6226,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(6726,0)"></path><path data-c="20" d="" transform="translate(7032,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(7282,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(7674,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(8118,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(8396,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(8840,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(9368,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(9868,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(10424,0)"></path><path data-c="20" d="" transform="translate(10813,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(11063,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(11341,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(11730,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(12174,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(13007,0)"></path><path data-c="20" d="" transform="translate(13401,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(13651,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(13929,0)"></path><path data-c="20" d="" transform="translate(14485,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(14735,0)"></path><path data-c="68" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 124T102 167T103 217T103 272T103 329Q103 366 103 407T103 482T102 542T102 586T102 603Q99 622 88 628T43 637H25V660Q25 683 27 683L37 684Q47 685 66 686T103 688Q120 689 140 690T170 693T181 694H184V367Q244 442 328 442Q451 442 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(15124,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(15680,0)"></path><path data-c="20" d="" transform="translate(16124,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(16374,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(16763,0)"></path><path data-c="70" d="M36 -148H50Q89 -148 97 -134V-126Q97 -119 97 -107T97 -77T98 -38T98 6T98 55T98 106Q98 140 98 177T98 243T98 296T97 335T97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 61 434T98 436Q115 437 135 438T165 441T176 442H179V416L180 390L188 397Q247 441 326 441Q407 441 464 377T522 216Q522 115 457 52T310 -11Q242 -11 190 33L182 40V-45V-101Q182 -128 184 -134T195 -145Q216 -148 244 -148H260V-194H252L228 -193Q205 -192 178 -192T140 -191Q37 -191 28 -194H20V-148H36ZM424 218Q424 292 390 347T305 402Q234 402 182 337V98Q222 26 294 26Q345 26 384 80T424 218Z" transform="translate(17263,0)"></path><path data-c="A0" d="" transform="translate(17819,0)"></path></g><g data-mml-node="mi" transform="translate(18069,0)"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mtext" transform="translate(18958,0)"><path data-c="A0" d=""></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(250,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(642,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1086,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(1480,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(2036,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2314,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(2703,0)"></path></g></g><rect width="22255" height="60" x="120" y="220"></rect></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="0 -1571.7 1 2643.3"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:" transform="translate(0,-191.7)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,0)"><g data-mml-node="mrow"></g></g></g></g></svg></g></g></g></g></svg></mjx-container></span></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.172ex;" xmlns="http://www.w3.org/2000/svg" width="52.905ex" height="5.296ex" role="img" focusable="false" viewBox="0 -1381 23384 2341"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(681,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1073,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(1517,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1961,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(2239,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(2633,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2911,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3411,0)"></path><path data-c="40" d="M56 347Q56 429 86 498T164 612T270 680T386 705Q522 705 622 603T722 349Q722 126 608 126Q541 126 513 176Q512 177 512 179T510 182L509 183Q508 183 503 177T487 163T464 146T429 132T385 126Q311 126 251 186T190 347Q190 448 251 508T385 568Q426 568 460 548T509 511T531 479H555Q580 479 582 478Q586 477 587 468Q588 454 588 338V260Q588 200 593 182T619 163Q641 163 655 178T674 223T680 273T682 325V330Q682 426 647 500Q611 569 544 618T388 668Q271 668 184 577T96 347Q96 216 180 121T396 26Q421 26 446 28T493 34T535 43T573 52T605 63T629 72T647 80T657 84H716Q722 78 722 74Q722 65 675 45T547 7T392 -11Q255 -11 156 90T56 347ZM274 347Q274 266 308 214T390 162Q420 162 449 182T498 235L504 245V449L498 459Q453 532 387 532Q347 532 311 483T274 347Z" transform="translate(3967,0)"></path><path data-c="6B" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T97 124T98 167T98 217T98 272T98 329Q98 366 98 407T98 482T98 542T97 586T97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V463L180 233L240 287Q300 341 304 347Q310 356 310 364Q310 383 289 385H284V431H293Q308 428 412 428Q475 428 484 431H489V385H476Q407 380 360 341Q286 278 286 274Q286 273 349 181T420 79Q434 60 451 53T500 46H511V0H505Q496 3 418 3Q322 3 307 0H299V46H306Q330 48 330 65Q330 72 326 79Q323 84 276 153T228 222L176 176V120V84Q176 65 178 59T189 49Q210 46 238 46H254V0H246Q231 3 137 3T28 0H20V46H36Z" transform="translate(4745,0)"></path></g><g data-mml-node="mo" transform="translate(5550.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(6606.6,0)"><g data-mml-node="mfrac"><g data-mml-node="mtext" transform="translate(4839.7,676)"><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(389,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(781,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1337,0)"></path><path data-c="20" d="" transform="translate(1781,0)"></path><path data-c="70" d="M36 -148H50Q89 -148 97 -134V-126Q97 -119 97 -107T97 -77T98 -38T98 6T98 55T98 106Q98 140 98 177T98 243T98 296T97 335T97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 61 434T98 436Q115 437 135 438T165 441T176 442H179V416L180 390L188 397Q247 441 326 441Q407 441 464 377T522 216Q522 115 457 52T310 -11Q242 -11 190 33L182 40V-45V-101Q182 -128 184 -134T195 -145Q216 -148 244 -148H260V-194H252L228 -193Q205 -192 178 -192T140 -191Q37 -191 28 -194H20V-148H36ZM424 218Q424 292 390 347T305 402Q234 402 182 337V98Q222 26 294 26Q345 26 384 80T424 218Z" transform="translate(2031,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2587,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(3087,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(3481,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(3759,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(4148,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(4426,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4954,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(5398,0)"></path><path data-c="40" d="M56 347Q56 429 86 498T164 612T270 680T386 705Q522 705 622 603T722 349Q722 126 608 126Q541 126 513 176Q512 177 512 179T510 182L509 183Q508 183 503 177T487 163T464 146T429 132T385 126Q311 126 251 186T190 347Q190 448 251 508T385 568Q426 568 460 548T509 511T531 479H555Q580 479 582 478Q586 477 587 468Q588 454 588 338V260Q588 200 593 182T619 163Q641 163 655 178T674 223T680 273T682 325V330Q682 426 647 500Q611 569 544 618T388 668Q271 668 184 577T96 347Q96 216 180 121T396 26Q421 26 446 28T493 34T535 43T573 52T605 63T629 72T647 80T657 84H716Q722 78 722 74Q722 65 675 45T547 7T392 -11Q255 -11 156 90T56 347ZM274 347Q274 266 308 214T390 162Q420 162 449 182T498 235L504 245V449L498 459Q453 532 387 532Q347 532 311 483T274 347Z" transform="translate(5792,0)"></path><path data-c="6B" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T97 124T98 167T98 217T98 272T98 329Q98 366 98 407T98 482T98 542T97 586T97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V463L180 233L240 287Q300 341 304 347Q310 356 310 364Q310 383 289 385H284V431H293Q308 428 412 428Q475 428 484 431H489V385H476Q407 380 360 341Q286 278 286 274Q286 273 349 181T420 79Q434 60 451 53T500 46H511V0H505Q496 3 418 3Q322 3 307 0H299V46H306Q330 48 330 65Q330 72 326 79Q323 84 276 153T228 222L176 176V120V84Q176 65 178 59T189 49Q210 46 238 46H254V0H246Q231 3 137 3T28 0H20V46H36Z" transform="translate(6570,0)"></path></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mtext" transform="translate(389,0)"><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(389,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(781,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1337,0)"></path><path data-c="20" d="" transform="translate(1781,0)"></path><path data-c="70" d="M36 -148H50Q89 -148 97 -134V-126Q97 -119 97 -107T97 -77T98 -38T98 6T98 55T98 106Q98 140 98 177T98 243T98 296T97 335T97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 61 434T98 436Q115 437 135 438T165 441T176 442H179V416L180 390L188 397Q247 441 326 441Q407 441 464 377T522 216Q522 115 457 52T310 -11Q242 -11 190 33L182 40V-45V-101Q182 -128 184 -134T195 -145Q216 -148 244 -148H260V-194H252L228 -193Q205 -192 178 -192T140 -191Q37 -191 28 -194H20V-148H36ZM424 218Q424 292 390 347T305 402Q234 402 182 337V98Q222 26 294 26Q345 26 384 80T424 218Z" transform="translate(2031,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2587,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(3087,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(3481,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(3759,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(4148,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(4426,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4954,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(5398,0)"></path><path data-c="40" d="M56 347Q56 429 86 498T164 612T270 680T386 705Q522 705 622 603T722 349Q722 126 608 126Q541 126 513 176Q512 177 512 179T510 182L509 183Q508 183 503 177T487 163T464 146T429 132T385 126Q311 126 251 186T190 347Q190 448 251 508T385 568Q426 568 460 548T509 511T531 479H555Q580 479 582 478Q586 477 587 468Q588 454 588 338V260Q588 200 593 182T619 163Q641 163 655 178T674 223T680 273T682 325V330Q682 426 647 500Q611 569 544 618T388 668Q271 668 184 577T96 347Q96 216 180 121T396 26Q421 26 446 28T493 34T535 43T573 52T605 63T629 72T647 80T657 84H716Q722 78 722 74Q722 65 675 45T547 7T392 -11Q255 -11 156 90T56 347ZM274 347Q274 266 308 214T390 162Q420 162 449 182T498 235L504 245V449L498 459Q453 532 387 532Q347 532 311 483T274 347Z" transform="translate(5792,0)"></path><path data-c="6B" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T97 124T98 167T98 217T98 272T98 329Q98 366 98 407T98 482T98 542T97 586T97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V463L180 233L240 287Q300 341 304 347Q310 356 310 364Q310 383 289 385H284V431H293Q308 428 412 428Q475 428 484 431H489V385H476Q407 380 360 341Q286 278 286 274Q286 273 349 181T420 79Q434 60 451 53T500 46H511V0H505Q496 3 418 3Q322 3 307 0H299V46H306Q330 48 330 65Q330 72 326 79Q323 84 276 153T228 222L176 176V120V84Q176 65 178 59T189 49Q210 46 238 46H254V0H246Q231 3 137 3T28 0H20V46H36Z" transform="translate(6570,0)"></path></g><g data-mml-node="mo" transform="translate(7709.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mtext" transform="translate(8709.4,0)"><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(306,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(806,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1084,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1478,0)"></path><path data-c="20" d="" transform="translate(1922,0)"></path><path data-c="70" d="M36 -148H50Q89 -148 97 -134V-126Q97 -119 97 -107T97 -77T98 -38T98 6T98 55T98 106Q98 140 98 177T98 243T98 296T97 335T97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 61 434T98 436Q115 437 135 438T165 441T176 442H179V416L180 390L188 397Q247 441 326 441Q407 441 464 377T522 216Q522 115 457 52T310 -11Q242 -11 190 33L182 40V-45V-101Q182 -128 184 -134T195 -145Q216 -148 244 -148H260V-194H252L228 -193Q205 -192 178 -192T140 -191Q37 -191 28 -194H20V-148H36ZM424 218Q424 292 390 347T305 402Q234 402 182 337V98Q222 26 294 26Q345 26 384 80T424 218Z" transform="translate(2172,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2728,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(3228,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(3622,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(3900,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(4289,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(4567,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(5095,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(5539,0)"></path><path data-c="40" d="M56 347Q56 429 86 498T164 612T270 680T386 705Q522 705 622 603T722 349Q722 126 608 126Q541 126 513 176Q512 177 512 179T510 182L509 183Q508 183 503 177T487 163T464 146T429 132T385 126Q311 126 251 186T190 347Q190 448 251 508T385 568Q426 568 460 548T509 511T531 479H555Q580 479 582 478Q586 477 587 468Q588 454 588 338V260Q588 200 593 182T619 163Q641 163 655 178T674 223T680 273T682 325V330Q682 426 647 500Q611 569 544 618T388 668Q271 668 184 577T96 347Q96 216 180 121T396 26Q421 26 446 28T493 34T535 43T573 52T605 63T629 72T647 80T657 84H716Q722 78 722 74Q722 65 675 45T547 7T392 -11Q255 -11 156 90T56 347ZM274 347Q274 266 308 214T390 162Q420 162 449 182T498 235L504 245V449L498 459Q453 532 387 532Q347 532 311 483T274 347Z" transform="translate(5933,0)"></path><path data-c="6B" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T97 124T98 167T98 217T98 272T98 329Q98 366 98 407T98 482T98 542T97 586T97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V463L180 233L240 287Q300 341 304 347Q310 356 310 364Q310 383 289 385H284V431H293Q308 428 412 428Q475 428 484 431H489V385H476Q407 380 360 341Q286 278 286 274Q286 273 349 181T420 79Q434 60 451 53T500 46H511V0H505Q496 3 418 3Q322 3 307 0H299V46H306Q330 48 330 65Q330 72 326 79Q323 84 276 153T228 222L176 176V120V84Q176 65 178 59T189 49Q210 46 238 46H254V0H246Q231 3 137 3T28 0H20V46H36Z" transform="translate(6711,0)"></path></g><g data-mml-node="mo" transform="translate(15948.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g><rect width="16537.4" height="60" x="120" y="220"></rect></g></g></g></g></svg></mjx-container></span></p><h3 id="ç¤ºä¾‹-2">ç¤ºä¾‹</h3><ul><li><strong>Question</strong>: Question: Where is France and what isitâ€™s capital? Ground truth: France is in Western Europe and its capitalis Paris.</li><li><strong>High faithfulness answer</strong>: [â€œFrance, in WesternEurope, encompasses medieval cities, alpine villages and Mediterraneanbeaches. Paris, its capital, is famed for its fashion houses, classicalart museums including the Louvre and monuments like the Eiffel Towerâ€,â€œThe country is also renowned for its wines and sophisticated cuisine.Lascauxâ€™s ancient cave drawings, Lyonâ€™s Roman theater and the vastPalace of Versailles attest to its rich history.â€]</li><li><strong>Low faithfulness answer</strong>: [â€œThe country is alsorenowned for its wines and sophisticated cuisine. Lascauxâ€™s ancient cavedrawings, Lyonâ€™s Roman theater andâ€, â€œFrance, in Western Europe,encompasses medieval cities, alpine villages and Mediterranean beaches.Paris, its capital, is famed for its fashion houses, classical artmuseums including the Louvre and monuments like the Eiffel Towerâ€,]</li></ul><h2 id="è®¡ç®—-2">è®¡ç®—</h2><ol type="1"><li><strong>Step 1</strong>å¯¹æ£€ç´¢å‡ºçš„æ¯ä¸€ä¸ªå—ï¼Œåˆ¤æ–­æ˜¯å¦å’Œç»™å‡ºé—®é¢˜çš„åŸºæœ¬äº‹å®ç›¸å…³ï¼ˆrelevantï¼‰</li><li><strong>Step 2</strong> é’ˆå¯¹ä¸Šä¸‹æ–‡æ¯ä¸€ä¸ªå—è®¡ç®— Precision@k<ul><li>Precision@1 = 0 / 1 = 0</li><li>Precision@2 = 1 / 2 = 0.5</li></ul></li><li><strong>Step 3</strong> è®¡ç®—å¹³å‡å€¼<ul><li>Context Precision = (1 + 0.5) / 1 = 0.5</li></ul></li></ol><h2 id="ä¸Šä¸‹æ–‡ç›¸å…³æ€§context-relevancy">ä¸Šä¸‹æ–‡ç›¸å…³æ€§ï¼ˆContextRelevancyï¼‰</h2><p>æ ¹æ®é—®é¢˜å’Œä¸Šä¸‹æ–‡è¿›è¡Œè®¡ç®—ï¼Œå€¼çš„èŒƒå›´åœ¨ (0,1)çš„èŒƒå›´å†…ï¼Œå€¼è¶Šé«˜è¡¨ç¤ºç›¸å…³æ€§è¶Šå¥½</p><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡åº”è¯¥åªåŒ…å«å¤„ç†æ‰€æä¾›æŸ¥è¯¢çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¸ºäº†è®¡ç®—è¯¥å€¼ï¼Œé¦–å…ˆé€šè¿‡è¯†åˆ«æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ä¸­ä¸å›ç­”ç»™å®šé—®é¢˜ç›¸å…³çš„å¥å­æ¥ä¼°ç®—<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.564ex;" xmlns="http://www.w3.org/2000/svg" width="2.717ex" height="2.26ex" role="img" focusable="false" viewBox="0 -749.5 1201 999"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(923,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g></g></svg></mjx-container></span> ï¼›æœ€ç»ˆå¾—åˆ†å…¬å¼å¦‚ä¸‹ <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 71.474ex;"><svg style="vertical-align: -2.17ex; min-width: 71.474ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="5.471ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1459)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(800,0) translate(-800,0)"><g transform="translate(0 1459) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="14995.8 -1459 1 2418"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr"><g data-mml-node="mtd"><g data-mml-node="mtext"><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(444,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(944,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1500,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1889,0)"></path><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(2333,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2861,0)"></path><path data-c="20" d="" transform="translate(3250,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(3500,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(3892,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(4336,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4614,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(5058,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(5586,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(6086,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(6642,0)"></path><path data-c="79" d="M69 -66Q91 -66 104 -80T118 -116Q118 -134 109 -145T91 -160Q84 -163 97 -166Q104 -168 111 -168Q131 -168 148 -159T175 -138T197 -106T213 -75T225 -43L242 0L170 183Q150 233 125 297Q101 358 96 368T80 381Q79 382 78 382Q66 385 34 385H19V431H26L46 430Q65 430 88 429T122 428Q129 428 142 428T171 429T200 430T224 430L233 431H241V385H232Q183 385 185 366L286 112Q286 113 332 227L376 341V350Q376 365 366 373T348 383T334 385H331V431H337H344Q351 431 361 431T382 430T405 429T422 429Q477 429 503 431H508V385H497Q441 380 422 345Q420 343 378 235T289 9T227 -131Q180 -204 113 -204Q69 -204 44 -177T19 -116Q19 -89 35 -78T69 -66Z" transform="translate(7086,0)"></path></g><g data-mml-node="mo" transform="translate(7891.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(8947.6,0)"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(9921.5,709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(923,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><g data-mml-node="mrow" transform="translate(220,-709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(278,0)"><path data-c="54" d="M36 443Q37 448 46 558T55 671V677H666V671Q667 666 676 556T685 443V437H645V443Q645 445 642 478T631 544T610 593Q593 614 555 625Q534 630 478 630H451H443Q417 630 414 618Q413 616 413 339V63Q420 53 439 50T528 46H558V0H545L361 3Q186 1 177 0H164V46H194Q264 46 283 49T309 63V339V550Q309 620 304 625T271 630H244H224Q154 630 119 601Q101 585 93 554T81 486T76 443V437H36V443Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(722,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1222,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(1611,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(2111,0)"></path><path data-c="20" d="" transform="translate(2389,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2639,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(3195,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3751,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(4584,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(5140,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(5584,0)"></path><path data-c="20" d="" transform="translate(5976,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(6226,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(6726,0)"></path><path data-c="20" d="" transform="translate(7032,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(7282,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(7676,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(8120,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(8676,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(9065,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(9509,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(10065,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(10509,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(10953,0)"></path><path data-c="20" d="" transform="translate(11347,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(11597,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(11875,0)"></path><path data-c="20" d="" transform="translate(12431,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(12681,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(13073,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(13517,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(13906,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(14298,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(14576,0)"></path><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(15020,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(15548,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(15992,0)"></path><path data-c="20" d="" transform="translate(16548,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(16798,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(17242,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(17742,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(18298,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(18687,0)"></path><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(19131,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(19659,0)"></path></g><g data-mml-node="mo" transform="translate(20326,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><rect width="20804" height="60" x="120" y="220"></rect></g></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="0 -1459 1 2418"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:"><g data-mml-node="mrow"></g></g></g></svg></g></g></g></g></svg></mjx-container></span></p><h3 id="ç¤ºä¾‹-3">ç¤ºä¾‹</h3><ul><li><strong>Question</strong>: What is the capital of France?</li><li><strong>High faithfulness answer</strong>: France, in WesternEurope, encompasses medieval cities, alpine villages and Mediterraneanbeaches. Paris, its capital, is famed for its fashion houses, classicalart museums including the Louvre and monuments like the EiffelTower.</li><li><strong>Low faithfulness answer</strong>: France, in Western Europe,encompasses medieval cities, alpine villages and Mediterranean beaches.Paris, its capital, is famed for its fashion houses, classical artmuseums including the Louvre and monuments like the Eiffel Tower. Thecountry is also renowned for its wines and sophisticated cuisine.Lascauxâ€™s ancient cave drawings, Lyonâ€™s Roman theater and the vastPalace of Versailles attest to its rich history.</li></ul><h2 id="ä¸Šä¸‹æ–‡å¬å›context-recall">ä¸Šä¸‹æ–‡å¬å›ï¼ˆContext Recallï¼‰</h2><p>ä¸Šä¸‹æ–‡å¬å›æŒ‡æ ‡è¡¡é‡æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡å’Œæ ‡æ³¨ç­”æ¡ˆï¼ˆè¢«è§†ä¸ºåŸºæœ¬äº‹å® groundtruthï¼‰çš„ä¸€è‡´ç¨‹åº¦</p><p>å®ƒæ˜¯åŸºäºåŸºæœ¬äº‹å®å’Œæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡è®¡ç®—çš„ï¼Œå€¼çš„èŒƒå›´åœ¨ 0 åˆ° 1ä¹‹é—´ï¼Œå€¼è¶Šé«˜è¡¨ç¤ºæ•ˆæœè¶Šå¥½</p><p>ä¸ºäº†ä»åŸºæœ¬äº‹å®ç­”æ¡ˆä¸­ä¼°è®¡ä¸Šä¸‹æ–‡å›å¿†ï¼Œåˆ†æåŸºæœ¬äº‹å®ç­”æ¡ˆçš„æ¯ä¸€å¥è¯ï¼Œä»¥ç¡®å®šå®ƒæ˜¯å¦å¯ä»¥å½’å› äºæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ï¼›åœ¨ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒåŸºæœ¬äº‹å®ç­”æ¡ˆä¸­çš„æ‰€æœ‰å¥å­éƒ½åº”å½’å› äºæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡<span class="math display"><mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 67.895ex;"><svg style="vertical-align: -2.17ex; min-width: 67.895ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="5.471ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1459)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(800,0) translate(-800,0)"><g transform="translate(0 1459) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="14204.8 -1459 1 2418"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr"><g data-mml-node="mtd"><g data-mml-node="mtext"><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(444,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(944,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1500,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1889,0)"></path><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(2333,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2861,0)"></path><path data-c="20" d="" transform="translate(3250,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(3500,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(3892,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(4336,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(4780,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(5280,0)"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(5558,0)"></path></g><g data-mml-node="mo" transform="translate(6113.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(7169.6,0)"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(220,709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(278,0)"><path data-c="47" d="M56 342Q56 428 89 500T174 615T283 681T391 705Q394 705 400 705T408 704Q499 704 569 636L582 624L612 663Q639 700 643 704Q644 704 647 704T653 705H657Q660 705 666 699V419L660 413H626Q620 419 619 430Q610 512 571 572T476 651Q457 658 426 658Q401 658 376 654T316 633T254 592T205 519T177 411Q173 369 173 335Q173 259 192 201T238 111T302 58T370 31T431 24Q478 24 513 45T559 100Q562 110 562 160V212Q561 213 557 216T551 220T542 223T526 225T502 226T463 227H437V273H449L609 270Q715 270 727 273H735V227H721Q674 227 668 215Q666 211 666 108V6Q660 0 657 0Q653 0 639 10Q617 25 600 42L587 54Q571 27 524 3T406 -22Q317 -22 238 22T108 151T56 342Z"></path><path data-c="54" d="M36 443Q37 448 46 558T55 671V677H666V671Q667 666 676 556T685 443V437H645V443Q645 445 642 478T631 544T610 593Q593 614 555 625Q534 630 478 630H451H443Q417 630 414 618Q413 616 413 339V63Q420 53 439 50T528 46H558V0H545L361 3Q186 1 177 0H164V46H194Q264 46 283 49T309 63V339V550Q309 620 304 625T271 630H244H224Q154 630 119 601Q101 585 93 554T81 486T76 443V437H36V443Z" transform="translate(785,0)"></path><path data-c="20" d="" transform="translate(1507,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1757,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(2151,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2595,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(3151,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(3540,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3984,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(4540,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(4984,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(5428,0)"></path><path data-c="20" d="" transform="translate(5822,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(6072,0)"></path><path data-c="68" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 124T102 167T103 217T103 272T103 329Q103 366 103 407T103 482T102 542T102 586T102 603Q99 622 88 628T43 637H25V660Q25 683 27 683L37 684Q47 685 66 686T103 688Q120 689 140 690T170 693T181 694H184V367Q244 442 328 442Q451 442 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(6461,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(7017,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(7517,0)"></path><path data-c="20" d="" transform="translate(7906,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(8156,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(8600,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(9100,0)"></path><path data-c="20" d="" transform="translate(9656,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(9906,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(10462,0)"></path><path data-c="20" d="" transform="translate(10906,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(11156,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(11656,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(12045,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(12434,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(12826,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(13104,0)"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(13660,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(14216,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(14605,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(15049,0)"></path><path data-c="20" d="" transform="translate(15605,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(15855,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(16244,0)"></path><path data-c="20" d="" transform="translate(16744,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(16994,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(17438,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(17938,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(18494,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(18883,0)"></path><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(19327,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(19855,0)"></path></g><g data-mml-node="mo" transform="translate(20522,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><g data-mml-node="mrow" transform="translate(4470.5,-709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(278,0)"><path data-c="4E" d="M42 46Q74 48 94 56T118 69T128 86V634H124Q114 637 52 637H25V683H232L235 680Q237 679 322 554T493 303L578 178V598Q572 608 568 613T544 627T492 637H475V683H483Q498 680 600 680Q706 680 715 683H724V637H707Q634 633 622 598L621 302V6L614 0H600Q585 0 582 3T481 150T282 443T171 605V345L172 86Q183 50 257 46H274V0H265Q250 3 150 3Q48 3 33 0H25V46H42Z"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(750,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1306,0)"></path><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z" transform="translate(2139,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(2695,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(3139,0)"></path><path data-c="20" d="" transform="translate(3531,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(3781,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(4281,0)"></path><path data-c="20" d="" transform="translate(4587,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(4837,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(5231,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(5675,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(6231,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(6620,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(7064,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(7620,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(8064,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(8508,0)"></path><path data-c="20" d="" transform="translate(8902,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(9152,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(9430,0)"></path><path data-c="20" d="" transform="translate(9986,0)"></path><path data-c="47" d="M56 342Q56 428 89 500T174 615T283 681T391 705Q394 705 400 705T408 704Q499 704 569 636L582 624L612 663Q639 700 643 704Q644 704 647 704T653 705H657Q660 705 666 699V419L660 413H626Q620 419 619 430Q610 512 571 572T476 651Q457 658 426 658Q401 658 376 654T316 633T254 592T205 519T177 411Q173 369 173 335Q173 259 192 201T238 111T302 58T370 31T431 24Q478 24 513 45T559 100Q562 110 562 160V212Q561 213 557 216T551 220T542 223T526 225T502 226T463 227H437V273H449L609 270Q715 270 727 273H735V227H721Q674 227 668 215Q666 211 666 108V6Q660 0 657 0Q653 0 639 10Q617 25 600 42L587 54Q571 27 524 3T406 -22Q317 -22 238 22T108 151T56 342Z" transform="translate(10236,0)"></path><path data-c="54" d="M36 443Q37 448 46 558T55 671V677H666V671Q667 666 676 556T685 443V437H645V443Q645 445 642 478T631 544T610 593Q593 614 555 625Q534 630 478 630H451H443Q417 630 414 618Q413 616 413 339V63Q420 53 439 50T528 46H558V0H545L361 3Q186 1 177 0H164V46H194Q264 46 283 49T309 63V339V550Q309 620 304 625T271 630H244H224Q154 630 119 601Q101 585 93 554T81 486T76 443V437H36V443Z" transform="translate(11021,0)"></path></g><g data-mml-node="mo" transform="translate(12021,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><rect width="21000" height="60" x="120" y="220"></rect></g></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="0 -1459 1 2418"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:"><g data-mml-node="mrow"></g></g></g></svg></g></g></g></g></svg></mjx-container></span></p><h3 id="ç¤ºä¾‹-4">ç¤ºä¾‹</h3><ul><li><strong>Question</strong>: Where is France and what is itâ€™scapital?</li><li><strong>Group truth</strong>: France is in Western Europe and itscapital is Paris.</li><li><strong>High faithfulness answer</strong>: France, in WesternEurope, encompasses medieval cities, alpine villages and Mediterraneanbeaches. Paris, its capital, is famed for its fashion houses, classicalart museums including the Louvre and monuments like the EiffelTower.</li><li><strong>Low faithfulness answer</strong>: France, in Western Europe,encompasses medieval cities, alpine villages and Mediterranean beaches.The country is also renowned for its wines and sophisticated cuisine.Lascauxâ€™s ancient cave drawings, Lyonâ€™s Roman theater and the vastPalace of Versailles attest to its rich history.</li></ul><h3 id="è®¡ç®—-3">è®¡ç®—</h3><ol type="1"><li><strong>Step 1</strong> æŠŠåŸºæœ¬äº‹å®ç­”æ¡ˆåˆ†è§£æˆå•ç‹¬çš„é™ˆè¿°<ul><li>France is in Western Europe.</li><li>Its capital is Paris.</li></ul></li><li><strong>Step 2</strong>å¯¹äºæ¯ä¸ªåŸºæœ¬äº‹å®é™ˆè¿°ï¼ŒéªŒè¯å…¶æ˜¯å¦å¯å½’å› äºæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡<ul><li>Yes</li><li>No</li></ul></li><li><strong>Step 3</strong> ä½¿ç”¨ä¸Šè¿°å…¬å¼è¿›è¡Œè®¡ç®— context recall = 1 / 2= 0.5</li></ol><h2 id="ä¸Šä¸‹æ–‡å®ä½“å¬å›context-entities-recall">ä¸Šä¸‹æ–‡å®ä½“å¬å›ï¼ˆContextentities recallï¼‰</h2><p>// TODO</p><h2 id="å›ç­”è¯­ä¹‰ç›¸ä¼¼æ€§answer-semantic-similarity">å›ç­”è¯­ä¹‰ç›¸ä¼¼æ€§ï¼ˆAnswersemantic similarityï¼‰</h2><p>å¯¹ç”Ÿæˆçš„ç­”æ¡ˆä¸åŸºæœ¬äº‹å®ä¹‹é—´çš„è¯­ä¹‰ç›¸ä¼¼æ€§è¿›è¡Œè¯„ä¼°</p><p>åŸºäºç­”æ¡ˆå’ŒåŸºæœ¬äº‹å®è¿›è¡Œè®¡ç®—ï¼Œå€¼åœ¨ 0 åˆ° 1ä¹‹é—´ï¼Œåˆ†æ•°è¶Šé«˜è¡¨ç¤ºç”Ÿæˆçš„ç­”æ¡ˆä¸åŸºæœ¬äº‹å®ä¹‹é—´çš„ä¸€è‡´æ€§è¶Šå¥½</p><p>æµ‹é‡ç­”æ¡ˆè¯­æ„ç›¸ä¼¼æ€§å¯ä»¥ä¸ºç”Ÿæˆçš„å“åº”çš„è´¨é‡æä¾›æœ‰ä»·å€¼çš„è§è§£ï¼Œè¯¥è¯„ä¼°åˆ©ç”¨äº¤å‰ç¼–ç å™¨æ¨¡å‹ï¼ˆcross-encodermodelï¼‰æ¥è®¡ç®—</p><h3 id="ç¤ºä¾‹-5">ç¤ºä¾‹</h3><ul><li><strong>Group truth</strong>: Albert Einsteinâ€™s theory of relativityrevolutionized our understanding of the universe.</li><li><strong>High faithfulness answer</strong>: Einsteinâ€™s groundbreakingtheory of relativity transformed our comprehension of the cosmos.</li><li><strong>Low faithfulness answer</strong>: Isaac Newtonâ€™s laws ofmotion greatly influenced classical physics.</li></ul><h3 id="è®¡ç®—-4">è®¡ç®—</h3><ol type="1"><li><strong>Step 1</strong> ä½¿ç”¨ç‰¹æ®Š embedding æ¨¡å‹å°†åŸºæœ¬äº‹å®å‘é‡åŒ–</li><li><strong>Step 2</strong> ä½¿ç”¨åŒæ ·æ¨¡å‹å¯¹ç»™å‡ºçš„å›ç­”å‘é‡åŒ–</li><li><strong>Step 3</strong> è®¡ç®—ä¸¤è€…ä½™å¼¦ç›¸ä¼¼æ€§</li></ol><h2 id="å›ç­”æ­£ç¡®æ€§answer-correctness">å›ç­”æ­£ç¡®æ€§ï¼ˆAnswerCorrectnessï¼‰</h2><p>ç­”æ¡ˆå’ŒåŸºæœ¬äº‹å®ç›¸æ¯”ï¼Œè¡¡é‡ç”Ÿæˆç­”æ¡ˆçš„å‡†ç¡®æ€§</p><p>é€šè¿‡ç­”æ¡ˆå’ŒåŸºæœ¬äº‹å®è®¡ç®—ï¼Œå¾—åˆ†åœ¨ 0 åˆ° 1ä¹‹é—´ï¼Œé«˜å¾—åˆ†æ„å‘³ç€ç»™å‡ºç­”æ¡ˆå’ŒåŸºæœ¬äº‹å®å…³è”æ›´ç´§å¯†ï¼ˆcloseralignmentï¼‰ï¼Œæ ‡å¿—ç€æ›´é«˜çš„æ­£ç¡®æ€§ <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 43.941ex;"><svg style="vertical-align: -2.171ex; min-width: 43.941ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="5.473ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1459.5)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(800,0) translate(-800,0)"><g transform="translate(0 1459.5) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="8910.9 -1459.5 1 2419"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,0.5)"><g data-mml-node="mtd"><g data-mml-node="mtext"><path data-c="46" d="M128 619Q121 626 117 628T101 631T58 634H25V680H582V676Q584 670 596 560T610 444V440H570V444Q563 493 561 501Q555 538 543 563T516 601T477 622T431 631T374 633H334H286Q252 633 244 631T233 621Q232 619 232 490V363H284Q287 363 303 363T327 364T349 367T372 373T389 385Q407 403 410 459V480H450V200H410V221Q407 276 389 296Q381 303 371 307T348 313T327 316T303 317T284 317H232V189L233 61Q240 54 245 52T270 48T333 46H360V0H348Q324 3 182 3Q51 3 36 0H25V46H58Q100 47 109 49T128 61V619Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(653,0)"></path><path data-c="20" d="" transform="translate(1153,0)"></path><path data-c="53" d="M55 507Q55 590 112 647T243 704H257Q342 704 405 641L426 672Q431 679 436 687T446 700L449 704Q450 704 453 704T459 705H463Q466 705 472 699V462L466 456H448Q437 456 435 459T430 479Q413 605 329 646Q292 662 254 662Q201 662 168 626T135 542Q135 508 152 480T200 435Q210 431 286 412T370 389Q427 367 463 314T500 191Q500 110 448 45T301 -21Q245 -21 201 -4T140 27L122 41Q118 36 107 21T87 -7T78 -21Q76 -22 68 -22H64Q61 -22 55 -16V101Q55 220 56 222Q58 227 76 227H89Q95 221 95 214Q95 182 105 151T139 90T205 42T305 24Q352 24 386 62T420 155Q420 198 398 233T340 281Q284 295 266 300Q261 301 239 306T206 314T174 325T141 343T112 367T85 402Q55 451 55 507Z" transform="translate(1403,0)"></path><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(1959,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2403,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2903,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(3295,0)"></path></g><g data-mml-node="mo" transform="translate(4016.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5072.6,0)"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(5395.2,709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(278,0)"><path data-c="54" d="M36 443Q37 448 46 558T55 671V677H666V671Q667 666 676 556T685 443V437H645V443Q645 445 642 478T631 544T610 593Q593 614 555 625Q534 630 478 630H451H443Q417 630 414 618Q413 616 413 339V63Q420 53 439 50T528 46H558V0H545L361 3Q186 1 177 0H164V46H194Q264 46 283 49T309 63V339V550Q309 620 304 625T271 630H244H224Q154 630 119 601Q101 585 93 554T81 486T76 443V437H36V443Z"></path><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z" transform="translate(722,0)"></path></g><g data-mml-node="mo" transform="translate(1681,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(220,-710)"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(389,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(667,0)"><path data-c="54" d="M36 443Q37 448 46 558T55 671V677H666V671Q667 666 676 556T685 443V437H645V443Q645 445 642 478T631 544T610 593Q593 614 555 625Q534 630 478 630H451H443Q417 630 414 618Q413 616 413 339V63Q420 53 439 50T528 46H558V0H545L361 3Q186 1 177 0H164V46H194Q264 46 283 49T309 63V339V550Q309 620 304 625T271 630H244H224Q154 630 119 601Q101 585 93 554T81 486T76 443V437H36V443Z"></path><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z" transform="translate(722,0)"></path></g><g data-mml-node="mo" transform="translate(2070,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(2570.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(3570.4,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(778,0)"></path></g><g data-mml-node="mo" transform="translate(5070.7,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(6070.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(6459.9,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(6737.9,0)"><path data-c="46" d="M128 619Q121 626 117 628T101 631T58 634H25V680H582V676Q584 670 596 560T610 444V440H570V444Q563 493 561 501Q555 538 543 563T516 601T477 622T431 631T374 633H334H286Q252 633 244 631T233 621Q232 619 232 490V363H284Q287 363 303 363T327 364T349 367T372 373T389 385Q407 403 410 459V480H450V200H410V221Q407 276 389 296Q381 303 371 307T348 313T327 316T303 317T284 317H232V189L233 61Q240 54 245 52T270 48T333 46H360V0H348Q324 3 182 3Q51 3 36 0H25V46H58Q100 47 109 49T128 61V619Z"></path><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z" transform="translate(653,0)"></path></g><g data-mml-node="mo" transform="translate(8071.9,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(8572.1,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(9572.3,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mtext" transform="translate(9850.3,0)"><path data-c="46" d="M128 619Q121 626 117 628T101 631T58 634H25V680H582V676Q584 670 596 560T610 444V440H570V444Q563 493 561 501Q555 538 543 563T516 601T477 622T431 631T374 633H334H286Q252 633 244 631T233 621Q232 619 232 490V363H284Q287 363 303 363T327 364T349 367T372 373T389 385Q407 403 410 459V480H450V200H410V221Q407 276 389 296Q381 303 371 307T348 313T327 316T303 317T284 317H232V189L233 61Q240 54 245 52T270 48T333 46H360V0H348Q324 3 182 3Q51 3 36 0H25V46H58Q100 47 109 49T128 61V619Z"></path><path data-c="4E" d="M42 46Q74 48 94 56T118 69T128 86V634H124Q114 637 52 637H25V683H232L235 680Q237 679 322 554T493 303L578 178V598Q572 608 568 613T544 627T492 637H475V683H483Q498 680 600 680Q706 680 715 683H724V637H707Q634 633 622 598L621 302V6L614 0H600Q585 0 582 3T481 150T282 443T171 605V345L172 86Q183 50 257 46H274V0H265Q250 3 150 3Q48 3 33 0H25V46H42Z" transform="translate(653,0)"></path></g><g data-mml-node="mo" transform="translate(11253.3,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(11531.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(11920.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g><rect width="12509.3" height="60" x="120" y="220"></rect></g></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="0 -1459.5 1 2419"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:" transform="translate(0,0.5)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,0)"><g data-mml-node="mrow"></g></g></g></g></svg></g></g></g></g></svg></mjx-container></span> æ˜ç¡®å…¬å¼ä¸­çš„æ¦‚å¿µ</p><ul><li>TPï¼ˆTruePrositiveï¼‰ï¼šå­˜åœ¨äºåŸºæœ¬äº‹å®å’Œç”Ÿæˆç­”æ¡ˆä¸­çš„äº‹å®æˆ–é™ˆè¿°ï¼ˆå’Œäº‹å®åŒ¹é…ï¼‰<em>åŒ¹é…</em></li><li>FPï¼ˆFalsePrositiveï¼‰ï¼šå‡ºç°åœ¨ç”Ÿæˆçš„ç­”æ¡ˆä¸­ä½†ä¸åœ¨åŸºæœ¬äº‹å®ä¸­çš„äº‹å®æˆ–é™ˆè¿°ï¼ˆæ¯”äº‹å®å¤šçš„ï¼‰<em>å¹»è§‰</em></li><li>FN ï¼ˆFalseNegativeï¼‰ï¼šå­˜åœ¨äºåŸºæœ¬äº‹å®ä¸­ä½†ä¸å­˜åœ¨äºç”Ÿæˆçš„ç­”æ¡ˆä¸­çš„äº‹å®æˆ–é™ˆè¿°ï¼ˆæ¯”äº‹å®å°‘çš„ï¼‰<em>é—æ¼</em></li></ul><h3 id="ç¤ºä¾‹-6">ç¤ºä¾‹</h3><ul><li><strong>Group truth</strong>: Einstein was born in 1879 inGermany.</li><li><strong>High faithfulness answer</strong>: In 1879, Einstein wasborn in Germany.</li><li><strong>Low faithfulness answer</strong>: Einstein was born in Spainin 1879.</li></ul><h3 id="è®¡ç®—-5">è®¡ç®—</h3><ol type="1"><li><strong>Step 1</strong> æ ¹æ®å›ç­”å’Œäº‹å®ç¡®è®¤ TPã€FPã€FN<ul><li>TP <code>[Einstein was born in 1879]</code></li><li>FP <code>[Einstein was born in Spain]</code></li><li>FN <code>[Einstein was born in Germany]</code></li></ul></li><li><strong>Step 2</strong> è®¡ç®— F1 åˆ†æ•°<ul><li>F1 Score = 1 / (1 + 0.5 * (1 + 1)) = 0.5</li></ul></li><li><strong>Step 3</strong>ç»“åˆå›ç­”è¯­ä¹‰ç›¸ä¼¼æ€§å’Œåˆé€‚çš„æƒé‡è®¡ç®—åŠ æƒå¹³å‡æ•°</li></ol><h2 id="æ–¹é¢è¯„ä¼°aspect-critique">æ–¹é¢è¯„ä¼°ï¼ˆAspect Critiqueï¼‰</h2><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯å®šä¹‰æŸä¸€æ–¹é¢çš„è¯„ä¼°ç»´åº¦ï¼ˆä¾‹å¦‚å±å®³æ€§ã€æ­£ç¡®æ€§ï¼‰</p><p>ä½¿ç”¨å›ç­”é€šè¿‡ LLM è¿›è¡Œè¯„ä¼°</p><h3 id="ç¤ºä¾‹-7">ç¤ºä¾‹</h3><p>SUPPORTED_ASPECTS = [ harmfulness, maliciousness, coherence,correctness, conciseness ]</p><h3 id="è®¡ç®—-6">è®¡ç®—</h3><ol type="1"><li><strong>Step 1</strong> åˆ¤æ–­æ–¹é¢å±äºå±å®³æ€§ï¼Œä½¿ç”¨å¯¹åº”çš„Promptï¼Œä½¿ç”¨ç‰¹å®šçš„æŸ¥è¯¢å®Œæˆ<ul><li>å…³äºå±å®³æ€§ï¼Œé—®é¢˜æ˜¯ Does the submission cause or have the potentialto cause harm to individuals, groups, or society at large?</li><li>ä½¿ç”¨ä¸‰ä¸ªä¸åŒçš„ LLM è¿›è¡Œåˆ¤æ–­<ul><li>Verdict 1: YES</li><li>Verdict 2: NO</li><li>Verdict 3: YES</li></ul></li></ul></li><li><strong>Step 2</strong> è¿”å›å¤šæ•°ç»“æœ YES</li></ol><h1 id="æŒ‡æ ‡æ€»ç»“">æŒ‡æ ‡æ€»ç»“</h1><p>è¡¡é‡æŒ‡æ ‡çš„åŸºç¡€æ¦‚å¿µï¼š</p><ul><li>question é—®é¢˜</li><li>answer å›ç­”</li><li>context ä¸Šä¸‹æ–‡</li><li>chunk æ–‡æ¡£å—</li><li>group truth åŸºæœ¬äº‹å®</li></ul><table><colgroup><col style="width: 26%"><col style="width: 32%"><col style="width: 6%"><col style="width: 36%"></colgroup><thead><tr class="header"><th style="text-align: center;">æŒ‡æ ‡</th><th style="text-align: center;">èŒƒå›´</th><th style="text-align: center;">ç›¸å…³æ€§</th><th style="text-align: center;">æè¿°</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Faithfulness</td><td style="text-align: center;">(0,1)</td><td style="text-align: center;">æ­£</td><td style="text-align: center;">ç”Ÿæˆçš„å›ç­”åœ¨ç»™å®šä¸Šä¸‹æ–‡ä¸­çš„äº‹å®ä¸€è‡´æ€§</td></tr><tr class="even"><td style="text-align: center;">Answer Relevance</td><td style="text-align: center;">(0,1) ä½†å› ä¸ºä½™å¼¦ç›¸ä¼¼æ€§ç‰¹æ€§ä¸ç»å¯¹</td><td style="text-align: center;">æ­£</td><td style="text-align: center;">ç­”æ¡ˆå’Œç»™å‡ºèµ„æ–™ä¹‹é—´çš„ç›¸å…³æ€§</td></tr><tr class="odd"><td style="text-align: center;">Context Precision</td><td style="text-align: center;">(0,1)</td><td style="text-align: center;">æ­£</td><td style="text-align: center;">ä¸Šä¸‹æ–‡æ£€ç´¢çš„å‡†ç¡®æ€§</td></tr><tr class="even"><td style="text-align: center;">Context Relevancy</td><td style="text-align: center;">(0,1)</td><td style="text-align: center;">æ­£</td><td style="text-align: center;">ä¸Šä¸‹æ–‡æ£€ç´¢çš„ç›¸å…³æ€§</td></tr><tr class="odd"><td style="text-align: center;">Context Recall</td><td style="text-align: center;">(0,1)</td><td style="text-align: center;">æ­£</td><td style="text-align: center;">ä¸Šä¸‹æ–‡æ£€ç´¢å’ŒåŸºç¡€äº‹å®çš„ä¸€è‡´ç¨‹åº¦</td></tr><tr class="even"><td style="text-align: center;">Context entities recall</td><td style="text-align: center;">TODO</td><td style="text-align: center;">TODO</td><td style="text-align: center;">TODO</td></tr><tr class="odd"><td style="text-align: center;">Answer semantic similarity</td><td style="text-align: center;">(0,1)</td><td style="text-align: center;">æ­£</td><td style="text-align: center;">ç­”æ¡ˆä¸åŸºæœ¬äº‹å®ä¹‹é—´çš„è¯­ä¹‰ç›¸ä¼¼æ€§</td></tr><tr class="even"><td style="text-align: center;">Aspect Critique</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">åŸºäº LLM çš„æŠ•ç¥¨åˆ¶è¯„ä¼°</td></tr></tbody></table><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://docs.ragas.io/en/stable/concepts/metrics/index.html">Metrics| Ragas</a></p><p><a href="https://github.com/explodinggradients/ragas">explodinggradients/ragas:Evaluation framework for your Retrieval Augmented Generation (RAG)pipelines (github.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RAG </tag>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.11 - ç´¢å¼•</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.11%20-%20%E7%B4%A2%E5%BC%95.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.11%20-%20%E7%B4%A2%E5%BC%95.html</url>
      
        <content type="html"><![CDATA[<p>ç´¢å¼•ï¼ˆIndexingï¼‰APIæ”¯æŒå°†ä»»ä½•æ¥æºçš„æ–‡æ¡£åŠ è½½åˆ°å‘é‡å­˜å‚¨ä¸­å¹¶ä¿æŒåŒæ­¥ï¼Œå…·ä½“æ¥è¯´æœ‰åŠ©äºï¼š</p><ul><li>é¿å…é‡å¤æ•°æ®å†™å…¥å‘é‡æ•°æ®åº“</li><li>é¿å…é‡å†™æœªæ›´æ”¹çš„æ•°æ®</li><li>é¿å…åœ¨æœªæ›´æ”¹çš„å†…å®¹ä¸Šé‡æ–°è®¡ç®— embeddings</li></ul><p>è¿™äº›ç›®æ ‡å¯ä»¥å¸®åŠ©èŠ‚çœæ—¶é—´å’Œé‡‘é’±ã€æ”¹è¿›çŸ¢é‡æœç´¢ç»“æœ</p><p>é‡è¦çš„æ˜¯ï¼Œå³ä½¿åŸå§‹æ–‡æœ¬ç»è¿‡äº†ä¸€äº›è½¬æ¢æ­¥éª¤ï¼ˆä¾‹å¦‚æ–‡æœ¬åˆ‡åˆ†chunkingï¼‰ç´¢å¼•ä¾ç„¶å¯ä»¥ç”Ÿæ•ˆ</p><h1 id="å¦‚ä½•å·¥ä½œ">å¦‚ä½•å·¥ä½œ</h1><p>LangChain Indexing ä½¿ç”¨è®°å½•ç®¡ç†å™¨ <code>RecordManager</code>æ¥è·Ÿè¸ªæ–‡æ¡£å†™å…¥å‘é‡å­˜å‚¨çš„æƒ…å†µ</p><p>å½“è¿›è¡Œå†…å®¹ç´¢å¼•æ—¶ï¼Œä¼šè®¡ç®—æ¯ä¸€ä¸ªæ–‡æ¡£çš„å“ˆå¸Œå€¼ï¼Œå¹¶ä¸”è®°å½•ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>æ–‡æ¡£çš„å“ˆå¸Œå€¼ï¼ˆé¡µå†…å®¹å’Œå…ƒæ•°æ®ï¼‰</li><li>å†™å…¥æ—¶é—´</li><li>èµ„æº IDï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½åº”è¯¥åœ¨å…¶å…ƒæ•°æ®ä¸­åŒ…å« IDä¿¡æ¯ï¼Œä»¥ä¾¿èƒ½å¤Ÿç¡®å®šè¯¥æ–‡æ¡£çš„æœ€ç»ˆæ¥æº</li></ul><h1 id="åˆ é™¤æ¨¡å¼">åˆ é™¤æ¨¡å¼</h1><p>å°†æ–‡æ¡£æ·»åŠ åˆ°å‘é‡æ•°æ®åº“åï¼Œå¯èƒ½éœ€è¦åˆ é™¤ä¸€äº›å·²ç»å­˜åœ¨çš„æ–‡æ¡£</p><p>æœ‰æ—¶å¯èƒ½å¸Œæœ›åˆ é™¤ä¸æ­£åœ¨ç´¢å¼•çš„æ–°æ–‡æ¡£æ¥æºç›¸åŒçš„ä»»ä½•ç°æœ‰æ–‡æ¡£ï¼ˆåˆ é™¤åŒæºæ–‡æ¡£ï¼‰</p><p>æˆ–è€…å¸Œæœ›æ‰¹é‡åˆ é™¤æ‰€æœ‰ç°æœ‰æ–‡æ¡£ï¼ŒAPIæä¾›çš„åˆ é™¤æ¨¡å¼æä¾›äº†æ‰€éœ€çš„è¡Œä¸ºï¼š</p><table><colgroup><col style="width: 21%" /><col style="width: 15%" /><col style="width: 7%" /><col style="width: 19%" /><col style="width: 15%" /><col style="width: 19%" /></colgroup><thead><tr class="header"><th style="text-align: center;">æ¨¡å¼</th><th style="text-align: center;">é‡å¤æ•°æ®</th><th style="text-align: center;">å¹¶è¡Œ</th><th style="text-align: center;">æ¸…ç†æºæ–‡ä»¶</th><th style="text-align: center;">åŒæºåˆ é™¤</th><th style="text-align: center;">åˆ é™¤æ—¶æœº</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">None</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">âŒ</td><td style="text-align: center;">âŒ</td><td style="text-align: center;">/</td></tr><tr class="even"><td style="text-align: center;">Incremental</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">âŒ</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">ç«‹å³</td></tr><tr class="odd"><td style="text-align: center;">Full</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">âŒ</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">âœ…</td><td style="text-align: center;">ç´¢å¼•ç»“æŸæ—¶</td></tr></tbody></table><ul><li>None æ¨¡å¼ä¸ä¼šåšä»»ä½•è‡ªåŠ¨åŒ–çš„æ¸…ç†ï¼Œå…è®¸ç”¨æˆ·æ‰‹åŠ¨è¿›è¡Œåˆ é™¤</li><li>Incremental å’Œ Full å°†ä¼šè¿›è¡Œè‡ªåŠ¨æ¸…ç†<ul><li>å¦‚æœæºæ–‡æ¡£æˆ–æ´¾ç”Ÿæ–‡æ¡£çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹ï¼Œåˆ™ Incremental æˆ– Fullæ¨¡å¼éƒ½å°†æ¸…é™¤ï¼ˆåˆ é™¤ï¼‰æ—§ç‰ˆæœ¬çš„å†…å®¹</li><li>å¦‚æœæºæ–‡æ¡£å·²è¢«åˆ é™¤ï¼ˆæ„å‘³ç€å®ƒä¸åŒ…æ‹¬åœ¨å½“å‰æ­£åœ¨ç´¢å¼•çš„æ–‡æ¡£ä¸­ï¼‰ï¼Œåˆ™ Fullæ¨¡å¼å°†æ­£ç¡®åœ°å°†å…¶ä»å‘é‡å­˜å‚¨ä¸­åˆ é™¤ï¼Œä½† Incremental æ¨¡å¼ä¸ä¼š</li></ul></li><li>å½“å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚ï¼Œæº PDFæ–‡ä»¶è¢«ä¿®æ”¹ï¼‰ï¼Œåœ¨ç´¢å¼•æœŸé—´åœ¨ä¸€å®šæ—¶é—´çª—å£å†…ï¼Œæ–°ç‰ˆæœ¬å’Œæ—§ç‰ˆæœ¬éƒ½å¯ä»¥è¿”å›ç»™ç”¨æˆ·ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨å†™å…¥æ–°å†…å®¹ä¹‹åï¼Œä½†åœ¨åˆ é™¤æ—§ç‰ˆæœ¬ä¹‹å‰ï¼ˆå…ˆåŠ ååˆ ï¼‰<ul><li>Incremental æœ€å¤§é™åº¦åœ°å¤„ç†äº†è¿™ç§æƒ…å†µï¼Œèƒ½å¤Ÿåœ¨å†™å…¥æ—¶è¿ç»­è¿›è¡Œæ¸…ç†</li><li>Full åªèƒ½åœ¨æ‰¹é‡å†™å…¥åè¿›è¡Œæ¸…ç†</li></ul></li></ul><h1 id="è¦æ±‚">è¦æ±‚</h1><p><em>ä»å®ç°çš„åŠŸèƒ½ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæƒ³è¦å®ç° Indexingçš„åŠŸèƒ½å¯¹å‘é‡å­˜å‚¨çš„èƒ½åŠ›æœ‰è¦æ±‚</em></p><ol type="1"><li>ä¸è¦å¯¹é¢„å…ˆå†™å…¥è¿‡æ•°æ®çš„å‘é‡å­˜å‚¨ä½¿ç”¨ï¼Œå› ä¸ºè¿™äº›æ—§æ•°æ®æ²¡æœ‰è¢«ç®¡ç†</li><li>ä»…é€‚ç”¨äº LangChain é›†æˆçš„ <code>vectorstore</code><ul><li>æ”¯æŒé€šè¿‡ ID æ·»åŠ ï¼ˆ<code>add_documents</code> æ–¹æ³•å¸¦æœ‰<code>ids</code> å‚æ•°ï¼‰</li><li>æ”¯æŒé€šè¿‡ ID åˆ é™¤ï¼ˆ<code>delete</code> æ–¹æ³•å¸¦æœ‰ <code>ids</code>å‚æ•°ï¼‰</li></ul></li></ol><h1 id="æ³¨æ„">æ³¨æ„</h1><p>è®°å½•ç®¡ç†å™¨åŸºäºæ—¶é—´æ¥ç¡®å®šå¯ä»¥æ¸…ç†å“ªäº›å†…å®¹ï¼ˆå½“ä½¿ç”¨ Incremental æˆ– Fullæ¨¡å¼æ—¶ï¼‰</p><p>å¦‚æœä¸¤ä¸ªä»»åŠ¡æ¥è¿è¿è¡Œï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªä»»åŠ¡åœ¨æ—¶é—´æ›´æ–°ä¹‹å‰å®Œæˆï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªä»»åŠ¡å¯èƒ½æ— æ³•æ¸…ç†å†…å®¹</p><p>ä¸è¿‡è¿™ç§æƒ…å†µä¸å¤ªå¯èƒ½å‘ç”Ÿï¼Œå› ä¸ºï¼š</p><ul><li><code>RecordManager</code> ä½¿ç”¨æ›´é«˜ç²¾åº¦ï¼ˆhigherresolutionï¼‰çš„æ—¶é—´æˆ³</li><li>æ•°æ®å˜æ›´åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡å’Œç¬¬äºŒä¸ªä»»åŠ¡è¿™ä¸ªèŒƒå›´å†…ï¼Œä¸å¤ªå‘ç”Ÿåœ¨å¾ˆå°çš„æ—¶é—´é—´éš”å†…</li><li>ç´¢å¼•ä»»åŠ¡é€šå¸¸éœ€è¦å‡ æ¯«ç§’ä»¥ä¸Šçš„æ—¶é—´</li></ul><h1 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</h1><p>éœ€è¦ç”¨åˆ°çš„ API</p><ul><li>SQLRecordManager</li><li>index</li><li>Document</li><li>ElasticsearchStore</li><li>OpenAIEmbeddings</li></ul><p>åˆå§‹åŒ–å‘é‡æ•°æ®åº“å¹¶è®¾ç½® embeddings</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">collection_name = <span class="string">&quot;test_index&quot;</span></span><br><span class="line"></span><br><span class="line">embedding = OpenAIEmbeddings()</span><br><span class="line"></span><br><span class="line">vectorstore = ElasticsearchStore(</span><br><span class="line">    es_url=<span class="string">&quot;http://localhost:9200&quot;</span>, index_name=<span class="string">&quot;test_index&quot;</span>, embedding=embedding</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–ä¸€ä¸ªè®°å½•ç®¡ç†å™¨ï¼ˆrecord manageï¼‰é€‰æ‹©åˆé€‚çš„å‘½åç©ºé—´</p><p>å»ºè®®ä½¿ç”¨ä¸€ä¸ªæ—¢èƒ½è¡¨è¾¾å‘é‡å­˜å‚¨ï¼Œåˆèƒ½è¡¨è¾¾å‘é‡å­˜å‚¨å†…é›†åˆçš„åå­—ï¼Œä¾‹å¦‚<code>redis/my_docs</code>ã€<code>chromadb/my_docs</code> ç­‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">namespace = <span class="string">f&quot;elasticsearch/<span class="subst">&#123;collection_name&#125;</span>&quot;</span></span><br><span class="line">record_manager = SQLRecordManager(</span><br><span class="line">    namespace, db_url=<span class="string">&quot;sqlite:///record_manager_cache.sql&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è®°å½•ç®¡ç†å™¨å‰åˆ›å»ºä¸€ä¸ª schema</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">record_manager.create_schema()</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å¼€å§‹ç´¢å¼•æ–‡æ¡£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">doc1 = Document(page_content=<span class="string">&quot;kitty&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;kitty.txt&quot;</span>&#125;)</span><br><span class="line">doc2 = Document(page_content=<span class="string">&quot;doggy&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;doggy.txt&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><h1 id="source">Source</h1><p>å…ƒæ•°æ®å±æ€§ä¸­æœ‰ä¸€ä¸ªåå« <code>source</code>çš„å˜é‡ï¼Œèµ„æºåº”è¯¥æŒ‡å‘æœ€ç»ˆç›¸å…³çš„æ–‡æ¡£</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæœ‰ä¸€äº›æ–‡æ¡£éƒ½æ˜¯ç”±çˆ¶æ–‡æ¡£è¿›è¡Œæ‹†åˆ†çš„ï¼Œé‚£ä¹ˆå®ƒä»¬çš„<code>source</code> å±æ€§åº”è¯¥ç›¸åŒå¹¶ä¸”æŒ‡å‘ç›¸å…³çš„çˆ¶æ–‡æ¡£</p><p>é€šå¸¸ <code>source</code> åº”è¯¥æ˜¯å­˜åœ¨æ˜ç¡®å€¼çš„ï¼Œåœ¨ä»¥ä¸‹åœºæ™¯å¯èƒ½ä¸º<code>None</code></p><ul><li>ä¸æ‰“ç®—ä½¿ç”¨ Incremental æ¨¡å¼</li><li>å› ä¸ºä¸€äº›åŸå› ä¸èƒ½æ˜ç¡®æ–‡æ¡£çš„æ¥æº</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> CharacterTextSplitter</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰çˆ¶æ–‡æ¡£</span></span><br><span class="line">doc1 = Document(</span><br><span class="line">    page_content=<span class="string">&quot;kitty kitty kitty kitty kitty&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;kitty.txt&quot;</span>&#125;</span><br><span class="line">)</span><br><span class="line">doc2 = Document(page_content=<span class="string">&quot;doggy doggy the doggy&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;doggy.txt&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹†åˆ†å­æ–‡æ¡£</span></span><br><span class="line">new_docs = CharacterTextSplitter(</span><br><span class="line">    separator=<span class="string">&quot;t&quot;</span>, keep_separator=<span class="literal">True</span>, chunk_size=<span class="number">12</span>, chunk_overlap=<span class="number">2</span></span><br><span class="line">).split_documents([doc1, doc2])</span><br></pre></td></tr></table></figure><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">Document</span>(<span class="name">page_content=</span><span class="symbol">&#x27;kitty</span> kit&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;kitty.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;tty</span> kitty ki&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;kitty.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;tty</span> kitty&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;kitty.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;doggy</span> doggy&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;the</span> doggy&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;)]</span><br></pre></td></tr></table></figure><p>ç´¢å¼•æ–‡æ¡£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index(</span><br><span class="line">    new_docs,</span><br><span class="line">    record_manager,</span><br><span class="line">    vectorstore,</span><br><span class="line">    cleanup=<span class="string">&quot;incremental&quot;</span>,</span><br><span class="line">    source_id_key=<span class="string">&quot;source&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;num_added&#x27;: <span class="number">5</span>, &#x27;num_updated&#x27;: <span class="number">0</span>, &#x27;num_skipped&#x27;: <span class="number">0</span>, &#x27;num_deleted&#x27;: <span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿç›¸åŒ source çš„æ–‡æ¡£ï¼Œå¿…é¡»è®¾ç½® <code>source = doggy.txt</code>æ‰èƒ½è®©æ–‡æ¡£æ›¿æ¢ä¸ºæ–°ç‰ˆæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">changed_doggy_docs = [</span><br><span class="line">    Document(page_content=<span class="string">&quot;woof woof&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;doggy.txt&quot;</span>&#125;),</span><br><span class="line">    Document(page_content=<span class="string">&quot;woof woof woof&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;doggy.txt&quot;</span>&#125;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index(</span><br><span class="line">    changed_doggy_docs,</span><br><span class="line">    record_manager,</span><br><span class="line">    vectorstore,</span><br><span class="line">    cleanup=<span class="string">&quot;incremental&quot;</span>,</span><br><span class="line">    source_id_key=<span class="string">&quot;source&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ–°å¢äº†ä¸¤æ¡å¹¶ä¸”åˆ é™¤äº†ä¸¤æ¡</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;num_added&#x27;: <span class="number">2</span>, &#x27;num_updated&#x27;: <span class="number">0</span>, &#x27;num_skipped&#x27;: <span class="number">0</span>, &#x27;num_deleted&#x27;: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure><p>åšä¸€æ¬¡æŸ¥è¯¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vectorstore.similarity_search(<span class="string">&quot;dog&quot;</span>, k=<span class="number">30</span>)</span><br></pre></td></tr></table></figure><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">Document</span>(<span class="name">page_content=</span><span class="symbol">&#x27;woof</span> woof&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;woof</span> woof woof&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;tty</span> kitty&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;kitty.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;tty</span> kitty ki&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;kitty.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;kitty</span> kit&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;kitty.txt</span>&#x27;&#125;)]</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨åŠ è½½å™¨loader">ä½¿ç”¨åŠ è½½å™¨ï¼ˆLoaderï¼‰</h1><p>ç´¢å¼•å¯ä»¥æ¥å—æ–‡æ¡£çš„ iterableï¼Œä¹Ÿå¯ä»¥æ¥å—ä»»æ„çš„ loader</p><p><strong>éœ€è¦æ³¨æ„ï¼šä½¿ç”¨ loader éœ€è¦æ˜ç¡®è®¾ç½® source</strong></p><p>å®ç°ä¸€ä¸ª <code>BaseLoader</code>ï¼Œmock åŠ è½½äº†å‡ ä¸ªæ–‡æ¡£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders.base <span class="keyword">import</span> BaseLoader</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyCustomLoader</span>(<span class="title class_ inherited__">BaseLoader</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">lazy_load</span>(<span class="params">self</span>):</span><br><span class="line">        text_splitter = CharacterTextSplitter(</span><br><span class="line">            separator=<span class="string">&quot;t&quot;</span>, keep_separator=<span class="literal">True</span>, chunk_size=<span class="number">12</span>, chunk_overlap=<span class="number">2</span></span><br><span class="line">        )</span><br><span class="line">        docs = [</span><br><span class="line">            Document(page_content=<span class="string">&quot;woof woof&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;doggy.txt&quot;</span>&#125;),</span><br><span class="line">            Document(page_content=<span class="string">&quot;woof woof woof&quot;</span>, metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;doggy.txt&quot;</span>&#125;),</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> text_splitter.split_documents(docs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(self.lazy_load())</span><br></pre></td></tr></table></figure><p>ä» loader ä¸­è¯»å–æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loader = MyCustomLoader()</span><br><span class="line">loader.load()</span><br></pre></td></tr></table></figure><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">Document</span>(<span class="name">page_content=</span><span class="symbol">&#x27;woof</span> woof&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;woof</span> woof woof&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;)]</span><br></pre></td></tr></table></figure><p>ç´¢å¼•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index(loader, record_manager, vectorstore, cleanup=<span class="string">&quot;full&quot;</span>, source_id_key=<span class="string">&quot;source&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;num_added&#x27;: <span class="number">2</span>, &#x27;num_updated&#x27;: <span class="number">0</span>, &#x27;num_skipped&#x27;: <span class="number">0</span>, &#x27;num_deleted&#x27;: <span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vectorstore.similarity_search(<span class="string">&quot;dog&quot;</span>, k=<span class="number">30</span>)</span><br></pre></td></tr></table></figure><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">Document</span>(<span class="name">page_content=</span><span class="symbol">&#x27;woof</span> woof&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;),</span><br><span class="line"> Document(<span class="name">page_content=</span><span class="symbol">&#x27;woof</span> woof woof&#x27;, metadata=&#123;<span class="symbol">&#x27;source</span><span class="symbol">&#x27;:</span> <span class="symbol">&#x27;doggy.txt</span>&#x27;&#125;)]</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://python.langchain.com/v0.1/docs/modules/data_connection/indexing/#deletion-modes">Indexing| ğŸ¦œï¸ğŸ”— LangChain</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯»æ‡‚ GC æ—¥å¿—</title>
      <link href="/%E5%BC%80%E5%8F%91/Java/%E8%AF%BB%E6%87%82%20GC%20%E6%97%A5%E5%BF%97.html"/>
      <url>/%E5%BC%80%E5%8F%91/Java/%E8%AF%BB%E6%87%82%20GC%20%E6%97%A5%E5%BF%97.html</url>
      
        <content type="html"><![CDATA[<p>å½“ä½¿ç”¨ Java æˆ–ä»»ä½•å…¶ä»–åŸºäº JVMçš„ç¼–ç¨‹è¯­è¨€æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½æ˜¯å†…å­˜æ¸…ç†ï¼ˆåƒåœ¾å›æ”¶ï¼‰</p><p>å’Œ C å’Œ C++ ç­‰è¯­è¨€ä¸åŒï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³æ³¨å†…å­˜ç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚<code>malloc</code>ã€<code>calloc</code>ã€<code>realloc</code>ã€<code>free</code>ç­‰å‡½æ•°</p><p>é‡Šæ”¾å†…å­˜çš„æ“ä½œå°±æ˜¯ç”± JVM ä¸­åä¸º <strong>Garbage Collector</strong>çš„è§’è‰²å®Œæˆçš„</p><h1 id="åƒåœ¾å›æ”¶å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„">åƒåœ¾å›æ”¶å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„</h1><p>JVMåœ¨åå°è¿è¡Œåƒåœ¾å›æ”¶å™¨æ¥æŸ¥æ‰¾æœªä½¿ç”¨çš„å¼•ç”¨ï¼Œè¿™äº›å¼•ç”¨å ç”¨çš„å†…å­˜å¯ä»¥è¢«é‡Šæ”¾å¹¶é‡æ–°ä½¿ç”¨</p><p>å †å†…å­˜è¢«åˆ’åˆ†ä¸ºä¸åŒçš„åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸéƒ½æœ‰è‡ªå·±çš„åƒåœ¾æ”¶é›†å™¨ç±»å‹</p><p>åƒåœ¾å›æ”¶å™¨æœ‰å¾ˆå¤šç§å®ç°ï¼ŒåŒæ—¶ JVMåœ¨ç¬¦åˆè§„èŒƒçš„æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰ä¸åŒçš„å®ç°ï¼Œåœ¨ç†è®ºå’Œå®è·µä¸­æ¯ä¸ª JVMå®ç°éƒ½å¯ä»¥æä¾›è‡ªå·±çš„åƒåœ¾æ”¶é›†å™¨å®ç°ï¼Œä»è€Œæä¾›ä¸åŒçš„æ€§èƒ½</p><p>JVM å †çš„ä¸‰ä¸ªä¸»è¦åŒºåŸŸçš„ç®€åŒ–è§†å›¾å¯ä»¥å¯è§†åŒ–å¦‚ä¸‹ï¼š</p><img src="/%E5%BC%80%E5%8F%91/Java/%E8%AF%BB%E6%87%82%20GC%20%E6%97%A5%E5%BF%97/java-collection-7.png.webp" class="" title="java garbage collection logs"><p>æ‹¥æœ‰ä¸€ä¸ªå¥åº·çš„åƒåœ¾æ”¶é›†è¿‡ç¨‹æ˜¯å®ç°åŸºäº JVMçš„åº”ç”¨ç¨‹åºçš„æœ€ä½³æ€§èƒ½çš„å…³é”®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç¡®ä¿ç›‘æ§ Javaè™šæ‹ŸæœºåŠå…¶åƒåœ¾å›æ”¶å™¨ï¼Œé€šè¿‡ GC logsï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£ JVMçš„åƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œ</p><h1 id="ä»€ä¹ˆæ˜¯-gc-æ—¥å¿—">ä»€ä¹ˆæ˜¯ GC æ—¥å¿—</h1><p>åƒåœ¾æ”¶é›†å™¨æ—¥å¿—æ˜¯ Javaè™šæ‹Ÿæœºç”Ÿæˆçš„æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨äºæè¿°åƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œ</p><p>åŒ…å«æŸ¥çœ‹å†…å­˜æ¸…ç†è¿‡ç¨‹å¦‚ä½•å·¥ä½œæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæä¾›äº†åƒåœ¾æ”¶é›†å™¨çš„è¡Œä¸ºä»¥åŠå®ƒä½¿ç”¨äº†å¤šå°‘èµ„æºï¼›å°½ç®¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨APMæä¾›ç¨‹åºæˆ–å†…éƒ¨æ„å»ºçš„ç›‘æ§å·¥å…·æ¥ç›‘æ§æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œä½†åƒåœ¾æ”¶é›†å™¨æ—¥å¿—å¯¹äºå¿«é€Ÿè¯†åˆ«å †å†…å­˜åˆ©ç”¨ç‡æ–¹é¢çš„ä»»ä½•æ½œåœ¨é—®é¢˜å’Œç“¶é¢ˆå°†æ˜¯éå¸¸å®è´µçš„</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ª GC æ—¥å¿—çš„ç¤ºä¾‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CommandLine flags: -XX:-BytecodeVerificationLocal -XX:-BytecodeVerificationRemote -XX:InitialHeapSize=52428800 -XX:+ManagementServer -XX:MaxGCPauseMillis=200 -XX:MaxHeapSize=52428800 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:-PrintGCDetails -XX:+PrintGCTimeStamps -XX:TieredStopAtLevel=1 -XX:-UseAdaptiveSizePolicy -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC </span><br><span class="line">2024-05-11T15:55:49.541-0800: 0.517: [GC (Allocation Failure)  12800K-&gt;2492K(49152K), 0.0021661 secs]</span><br><span class="line">2024-05-11T15:55:49.710-0800: 0.687: [GC (Allocation Failure)  15292K-&gt;3412K(49152K), 0.0025412 secs]</span><br><span class="line">2024-05-11T15:55:49.810-0800: 0.787: [GC (Allocation Failure)  16212K-&gt;4807K(49152K), 0.0024151 secs]</span><br><span class="line">2024-05-11T15:55:49.899-0800: 0.876: [GC (Allocation Failure)  17607K-&gt;6061K(49152K), 0.0021924 secs]</span><br><span class="line">2024-05-11T15:55:49.997-0800: 0.973: [GC (Allocation Failure)  18861K-&gt;7424K(49152K), 0.0029084 secs]</span><br><span class="line">2024-05-11T15:55:50.076-0800: 1.053: [GC (Allocation Failure)  20224K-&gt;8503K(49152K), 0.0023001 secs]</span><br><span class="line">2024-05-11T15:55:50.112-0800: 1.089: [GC (Allocation Failure)  21303K-&gt;9742K(49152K), 0.0025567 secs]</span><br><span class="line">2024-05-11T15:55:50.153-0800: 1.129: [GC (Allocation Failure)  22542K-&gt;10927K(49152K), 0.0025338 secs]</span><br><span class="line">2024-05-11T15:55:50.192-0800: 1.168: [GC (Allocation Failure)  23727K-&gt;12205K(49152K), 0.0027763 secs]</span><br><span class="line">2024-05-11T15:55:50.298-0800: 1.275: [GC (Allocation Failure)  25005K-&gt;13338K(49152K), 0.0041218 secs]</span><br><span class="line">2024-05-11T15:55:50.394-0800: 1.371: [GC (Metadata GC Threshold)  24027K-&gt;14554K(49152K), 0.0026052 secs]</span><br><span class="line">2024-05-11T15:55:50.397-0800: 1.373: [Full GC (Metadata GC Threshold)  14554K-&gt;8390K(49152K), 0.0282067 secs]</span><br><span class="line">2024-05-11T15:55:50.472-0800: 1.448: [GC (Allocation Failure)  21190K-&gt;9606K(49152K), 0.0011170 secs]</span><br><span class="line">2024-05-11T15:55:50.553-0800: 1.530: [GC (Allocation Failure)  22406K-&gt;10211K(49152K), 0.0021453 secs]</span><br><span class="line">2024-05-11T15:55:50.625-0800: 1.602: [GC (Allocation Failure)  23011K-&gt;10545K(49152K), 0.0015239 secs]</span><br><span class="line">2024-05-11T15:55:50.722-0800: 1.698: [GC (Allocation Failure)  23345K-&gt;11492K(49152K), 0.0021307 secs]</span><br><span class="line">2024-05-11T15:55:50.810-0800: 1.786: [GC (Allocation Failure)  24292K-&gt;12785K(49152K), 0.0017124 secs]</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/Java/%E8%AF%BB%E6%87%82%20GC%20%E6%97%A5%E5%BF%97/java-collection-6.png.webp" class="" title="java gc logs"><h1 id="å¯åŠ¨-gc-æ—¥å¿—">å¯åŠ¨ GC æ—¥å¿—</h1><p>åœ¨ç°ä»£è®¾å¤‡ä¸Šï¼Œå¯ç”¨åƒåœ¾æ”¶é›†å™¨æ—¥å¿—æ—¶ä¸å¿…æ‹…å¿ƒæ€§èƒ½é—®é¢˜ï¼Œç†è®ºä¸Šåº”è¯¥å§‹ç»ˆæ‰“å¼€Java åƒåœ¾æ”¶é›†æ—¥å¿—</p><p>å¯¹äº Java 8 åŠæ›´æ—©ç‰ˆæœ¬ï¼Œé€šè¿‡å¦‚ä¸‹å‚æ•°å¯åŠ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintGCDetails -Xloggc:&lt;PATH_TO_GC_LOG_FILE&gt;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>PATH_TO_GC_LOG_FILE</code> æ˜¯æ—¥å¿—æ–‡ä»¶å­˜æ”¾çš„ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintGCDetails -Xloggc:/home/shared/log/gc.log -jar my_app.jar</span><br></pre></td></tr></table></figure><p><br></p><p>å¯¹äº Java 9 åŠæ›´æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥ç®€åŒ–ä¸Šé¢çš„å‘½ä»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xlog:gc*:file=&lt;PATH_TO_GC_LOG_FILE&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xlog:gc*:file=/home/shared/gc.log -jar my_app.jar</span><br></pre></td></tr></table></figure><p>Java 9 åŠæ›´æ–°çš„ç‰ˆæœ¬è¿˜æ”¯æŒ GCè°ƒè¯•æ—¥å¿—ï¼Œä¼šè¾“å…¥æ›´è¯¦ç»†çš„æ—¥å¿—å†…å®¹ï¼Œé€šè¿‡å¦‚ä¸‹é…ç½®è®¾ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xlog:gc*,gc+phases=debug</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦å¯ç”¨äº† GCæ—¥å¿—ï¼Œé‚£ä¹ˆéœ€è¦æ³¨æ„è½®æ¢ï¼ˆrotationï¼‰çš„é‡è¦é…ç½®ï¼Œå½“ä½¿ç”¨è¾ƒæ—§çš„ JVM ç‰ˆæœ¬ï¼ˆå¦‚JDK 8ï¼‰æ—¶ï¼Œå¯èƒ½éœ€è¦è½®æ¢ GC æ—¥å¿—</p><p>æœ‰ä»¥ä¸‹å‚æ•°è¿›è¡Œæ§åˆ¶ï¼š</p><ul><li>-XX:+UseGCLogFileRotation å¯ç”¨æ—¥å¿—è½®æ¢</li><li>-XX:NumberOfGCLogFiles è®¾ç½®ä¿ç•™å¤šå°‘ GC æ—¥å¿—æ–‡ä»¶ï¼Œä¾‹å¦‚<code>-XX:NumberOfGCLogFiles=10</code> å°†ä¿ç•™æœ€å¤š 10 ä¸ª GC æ—¥å¿—æ–‡ä»¶</li><li>-XX:GCLogFileSize å•ä¸ª GC æ—¥å¿—æ–‡ä»¶å¯ä»¥æœ‰å¤šå¤§ï¼Œä¾‹å¦‚<code>-XX/GCLogFileSize=10m</code> å°†åœ¨æ—¥å¿—æ–‡ä»¶è¾¾åˆ° 10 MB æ—¶è¦†ç›– GCæ—¥å¿—æ–‡ä»¶</li></ul><p>å¼€å¯ GC æ—¥å¿—åï¼Œå°±å¯ä»¥æ ¹æ®æ—¥å¿—è¿›è¡Œåˆ†æäº†</p><h1 id="å¦‚ä½•åˆ†æ">å¦‚ä½•åˆ†æ</h1><p>åƒåœ¾æ”¶é›†æ—¥å¿—å°†èƒ½å¤Ÿå›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>Young åŒºä»€ä¹ˆæ—¶å€™è¿›è¡Œçš„ GC</li><li>Old åŒºä»€ä¹ˆæ—¶å€™è¿›è¡Œçš„ GC</li><li>è¿è¡Œäº†å¤šå°‘æ¬¡ GC</li><li>GC ä¸€å…±è¿›è¡Œäº†å¤šé•¿æ—¶é—´</li><li>GC å‰åçš„å†…å­˜åˆ©ç”¨ç‡æ˜¯å¤šå°‘</li></ul><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸ª JVMåƒåœ¾æ”¶é›†å™¨æ—¥å¿—ä¸­çš„ç¤ºä¾‹ï¼Œå¹¶åˆ†ææ¯ä¸ªç‰‡æ®µï¼Œçªå‡ºæ˜¾ç¤ºå…¶èƒŒåçš„å…³é”®éƒ¨åˆ†</p><h2 id="ps-cms">PS + CMS</h2><p>ä¸€è¡Œæ—¥å¿—å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-10-30T11:13:00.920-0100: 6.399: [Full GC (Allocation Failure) 2019-10-30T11:13:00.920-0100: 6.399: [CMS: 43711K-&gt;43711K(43712K), 0.1417937 secs] 63359K-&gt;48737K(63360K), [Metaspace: 47130K-&gt;47130K(1093632K)], 0.1418689 secs] [Times: user=0.14 sys=0.00, real=0.14 secs]</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ—¶é—´ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ¡æ—¥å¿—æ˜¯åœ¨<strong>2019-10-30T11:13:00.920-0100</strong> äº§ç”Ÿçš„</p><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯ GC çš„ç±»å‹ï¼Œå¯ä»¥çœ‹åˆ°æ—¥å¿—çš„ç±»å‹æ˜¯ <strong>FullGC</strong></p><p>å¯¹äº GC çš„ç±»å‹æœ‰å¦‚ä¸‹ä¸‰ç§</p><ul><li>Minor GCï¼šå½“ EdenåŒºå·²æ»¡æˆ–å³å°†æ»¡æ—¶è§¦å‘ï¼Œå¦‚æœåº”ç”¨ä¼šé¢‘ç¹åˆ›å»ºæ–°å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ª GCä¼šç»å¸¸è¿›è¡Œï¼›Eden åŒºå’Œ Survivor ä¸ä¼šäº§ç”Ÿç¢ç‰‡</li><li>Major GCï¼šMajor GC æ„å‘³ç€äº§ç”Ÿäº†è€å¹´ä»£çš„GCï¼Œæ ¹æ®ä¸åŒåƒåœ¾æ”¶é›†å™¨çš„è®¾ç½®ï¼Œè¯¥æ“ä½œå¯èƒ½å‘ç”Ÿçš„æ›´å°‘æˆ–è€…æ›´é¢‘ç¹</li><li>FullGCï¼šå®Œå…¨æ”¶é›†ï¼Œè¡¨ç¤ºå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½ä¼šè¿›è¡Œæ”¶é›†ï¼›é€šè¿‡æ ‡è®°ã€æ‰«æã€å‹ç¼©çš„æ­¥éª¤é¿å…å†…å­˜ç¢ç‰‡</li></ul><p><em>Major å’Œ Full GC æ²¡æœ‰ä¸¥æ ¼åŒºåˆ†ï¼Œä¸è¦ç‰¹åˆ«åœ¨æ„ï¼Œè§https://stackoverflow.com/questions/50081873/full-garbage-collection-vs-major-garbage-collection</em></p><img src="/%E5%BC%80%E5%8F%91/Java/%E8%AF%BB%E6%87%82%20GC%20%E6%97%A5%E5%BF%97/java-collection-4.png" class="" title="how to read gc logs"><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯è¿›è¡Œ GC çš„åŸå› ï¼Œå¯ä»¥çœ‹åˆ°è¯¥æ—¥å¿—çš„åŸå› æ˜¯ <strong>AllocationFailure</strong>ï¼Œé€šå¸¸æ„å‘³ç€å †å†…å­˜çš„ EdenåŒºä¸­æ²¡æœ‰ç©ºé—´ç”¨äºæ–°å¯¹è±¡åˆ†é…ï¼Œåƒåœ¾æ”¶é›†å™¨è¯•å›¾ä¸ºæ–°å¯¹è±¡é‡Šæ”¾ä¸€äº›å†…å­˜</p><p>å†æ¬¡æ›´è¯¦ç»†åœ°äº†è§£è¿™è¡Œæ—¥å¿—ï¼š</p><img src="/%E5%BC%80%E5%8F%91/Java/%E8%AF%BB%E6%87%82%20GC%20%E6%97%A5%E5%BF%97/java-collection-3.png.webp" class="" title="java garbage collection log analysis"><p>JVMåƒåœ¾æ”¶é›†å™¨ç»™æˆ‘ä»¬çš„ä¸€æ¡éå¸¸é‡è¦çš„ä¿¡æ¯æ˜¯åº”ç”¨ç¨‹åºçº¿ç¨‹åœæ­¢çš„æ€»æ—¶é—´ï¼Œåº”è¯¥é¢„æœŸçº¿ç¨‹ä¼šç»å¸¸åœæ­¢ï¼Œä½†æ—¶é—´å¾ˆçŸ­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-10-29T10:00:28.879-0100: 0.488: Total time for which application threads were stopped: 0.0001006 seconds, Stopping threads took: 0.0000065 seconds</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çº¿ç¨‹åœæ­¢äº† 0.0001006 ç§’ï¼Œçº¿ç¨‹çš„åœæ­¢èŠ±è´¹äº† 0.0000065ç§’ï¼Œæˆ‘ä»¬å°†åœ¨ GC logs ä¸­ä¸€æ¬¡åˆä¸€æ¬¡åœ°çœ‹åˆ°è¿™æ ·çš„ä¿¡æ¯</p><p>åº”è¯¥å¼•èµ·ä¸€ä¸ªå±é™©ä¿¡å·çš„æ˜¯é•¿çº¿ç¨‹åœæ­¢æ—¶é—´â€”â€”ä¹Ÿç§°ä¸º stop theworldï¼Œå®ƒçš„å‘ç”Ÿå°†åŸºæœ¬åœæ­¢æ•´ä¸ªåº”ç”¨ï¼Œä¾‹å¦‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-11-02T17:11:54.259-0100: 7.438: Total time for which application threads were stopped: 11.2305001 seconds, Stopping threads took: 0.5230011 seconds</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„æ—¥å¿—è¡Œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹åœæ­¢çš„æ—¶é—´è¶…è¿‡äº† 11ç§’ï¼Œæ„å‘³ç€åº”ç”¨ç¨‹åºæ²¡æœ‰å“åº”çš„æ—¶é—´è¶…è¿‡äº† 11ç§’ï¼Œåº”è¯¥ä¸æƒœä¸€åˆ‡ä»£ä»·é¿å…å‡ºç°è¿™ç§æƒ…å†µ</p><h2 id="g1">G1</h2><p>ä½¿ç”¨å¦‚ä¸‹é…ç½®æ¥è®¾ç½®ä½¿ç”¨ G1 åƒåœ¾å›æ”¶å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:-UseConcMarkSweepGC</span><br><span class="line">-XX:-UseCMSInitiatingOccupancyOnly</span><br></pre></td></tr></table></figure><p>G1 çš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">2019-11-03T21:26:21.827-0100: 2.069: [GC pause (G1 Evacuation Pause) (young)</span><br><span class="line">Desired survivor size 2097152 bytes, new threshold 15 (max 15)</span><br><span class="line">- age   1:     341608 bytes,     341608 total</span><br><span class="line">, 0.0021740 secs]</span><br><span class="line">   [Parallel Time: 0.9 ms, GC Workers: 10]</span><br><span class="line">      [GC Worker Start (ms): Min: 2069.4, Avg: 2069.5, Max: 2069.6, Diff: 0.1]</span><br><span class="line">      [Ext Root Scanning (ms): Min: 0.1, Avg: 0.2, Max: 0.4, Diff: 0.3, Sum: 1.5]</span><br><span class="line">      [Update RS (ms): Min: 0.1, Avg: 0.2, Max: 0.3, Diff: 0.2, Sum: 2.3]</span><br><span class="line">         [Processed Buffers: Min: 1, Avg: 1.4, Max: 4, Diff: 3, Sum: 14]</span><br><span class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">      [Object Copy (ms): Min: 0.2, Avg: 0.3, Max: 0.3, Diff: 0.1, Sum: 3.0]</span><br><span class="line">      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</span><br><span class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 10]</span><br><span class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span><br><span class="line">      [GC Worker Total (ms): Min: 0.6, Avg: 0.7, Max: 0.8, Diff: 0.1, Sum: 7.0]</span><br><span class="line">      [GC Worker End (ms): Min: 2070.2, Avg: 2070.2, Max: 2070.2, Diff: 0.0]</span><br><span class="line">   [Code Root Fixup: 0.0 ms]</span><br><span class="line">   [Code Root Purge: 0.0 ms]</span><br><span class="line">   [Clear CT: 0.2 ms]</span><br><span class="line">   [Other: 1.1 ms]</span><br><span class="line">      [Choose CSet: 0.0 ms]</span><br><span class="line">      [Ref Proc: 0.8 ms]</span><br><span class="line">      [Ref Enq: 0.0 ms]</span><br><span class="line">      [Redirty Cards: 0.2 ms]</span><br><span class="line">      [Humongous Register: 0.0 ms]</span><br><span class="line">      [Humongous Reclaim: 0.0 ms]</span><br><span class="line">      [Free CSet: 0.0 ms]</span><br><span class="line">   [Eden: 26.0M(26.0M)-&gt;0.0B(30.0M) Survivors: 5120.0K-&gt;3072.0K Heap: 51.4M(64.0M)-&gt;22.6M(64.0M)]</span><br><span class="line"> [Times: user=0.01 sys=0.00, real=0.01 secs]</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ—¥å¿—å±•ç¤ºäº†ä¸€æ¬¡å¹´è½»ä»£çš„ GC äº‹ä»¶ <strong>[GC pause (G1 EvacuationPause) (young)</strong></p><p>å¯¼è‡´ä¸€äº›å†…å­˜åŒºåŸŸè¢«æ¸…ç† <strong>[Eden: 26.0M(26.0M)-&gt;0.0B(30.0M)Survivors: 5120.0K-&gt;3072.0K Heap:51.4M(64.0M)-&gt;22.6M(64.0M)]</strong></p><p>è¿˜å¯ä»¥çœ‹åˆ°æ—¶é—´å’Œ CPU çš„ç›¸å…³ä¿¡æ¯ <strong>[Times: user=0.01 sys=0.00,real=0.01 secs]</strong></p><p>ä¸‹é¢æ˜¯æ›´è¯¦ç»†çš„å†…å­˜ä¿¡æ¯æ‘˜è¦</p><ul><li>Eden åŒºè¢«å®Œå…¨æ¸…ç©ºäº†</li><li>Survivors çš„ç©ºé—´ç”± 5120K é™ä¸º 3072K</li><li>æ•´ä¸ªå †çš„ç©ºé—´ä» 64 MB çš„æ€»å¤§å°ä¸­çš„ 51.4 MB å¼€å§‹ï¼Œåˆ° 22.6 MB ç»“æŸ</li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°æœ‰å…³å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨å·¥ä½œç¨‹åºå†…éƒ¨åŠå…¶å·¥ä½œé˜¶æ®µï¼ˆå¦‚å¯åŠ¨ã€æ‰«æå’Œå·¥ä½œï¼‰çš„æ›´è¯¦ç»†ä¿¡æ¯</p><p>è¿˜å¯ä»¥çœ‹åˆ°ä¸ G1 åƒåœ¾æ”¶é›†å™¨ç›¸å…³çš„å…¶ä»–æ—¥å¿—æ¡ç›®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2019-11-03T21:26:23.704-0100: 2019-11-03T21:26:23.704-0100: 3.946: 3.946: [GC concurrent-root-region-scan-start]</span><br><span class="line">Total time for which application threads were stopped: 0.0035771 seconds, Stopping threads took: 0.0000111 seconds</span><br><span class="line">2019-11-03T21:26:23.706-0100: 3.948: [GC concurrent-root-region-scan-end, 0.0017994 secs]</span><br><span class="line">2019-11-03T21:26:23.706-0100: 3.948: [GC concurrent-mark-start]</span><br><span class="line">2019-11-03T21:26:23.737-0100: 3.979: [GC concurrent-mark-end, 0.0315921 secs]</span><br><span class="line">2019-11-03T21:26:23.737-0100: 3.979: [GC remark 2019-11-03T21:26:23.737-0100: 3.979: [Finalize Marking, 0.0002017 secs] 2019-11-03T21:26:23.738-0100: 3.980: [GC ref-proc, 0.0004151 secs] 2019-11-03T21:26:23.738-0100: 3.980: [Unloading, 0.0025065 secs], 0.0033738 secs]</span><br><span class="line"> [Times: user=0.04 sys=0.01, real=0.01 secs]</span><br><span class="line">2019-11-03T21:26:23.741-0100: 3.983: Total time for which application threads were stopped: 0.0034705 seconds, Stopping threads took: 0.0000308 seconds</span><br><span class="line">2019-11-03T21:26:23.741-0100: 3.983: [GC cleanup 54M-&gt;54M(64M), 0.0004419 secs]</span><br><span class="line"> [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br></pre></td></tr></table></figure><p>æ—¥å¿—ä¸ºæˆ‘ä»¬æä¾›äº†æœ‰å…³åº”ç”¨ç¨‹åºçº¿ç¨‹åœæ­¢çš„æ€»æ—¶é—´ã€åƒåœ¾æ”¶é›†å™¨æ‰€åšæ¸…ç†çš„ç»“æœä»¥åŠæ‰€ä½¿ç”¨çš„èµ„æºçš„ä¿¡æ¯</p><h1 id="è¡¥å……">è¡¥å……</h1><h2 id="outofmemory-é”™è¯¯">OutOfMemory é”™è¯¯</h2><h3 id="java-heap-space">Java heap space</h3><ul><li>å¯¹è±¡ä¸èƒ½è¢«åˆ†é…è¿›å †å†…å­˜</li><li>è¿‡å¤§çš„æµé‡</li><li>åº”ç”¨ä¸­å¼•ç”¨æŒæœ‰è¿‡å¤šï¼Œå¯¼è‡´æ— æ³•å›æ”¶è¶³å¤Ÿçš„ç©ºé—´ï¼ˆæ³„æ¼ï¼‰</li><li>åº”ç”¨ä¸­ä½¿ç”¨äº†è¿‡å¤šçš„ Finalizersï¼ŒFinalizers çš„å¯¹è±¡ä¸ä¼šç«‹å³è¿›è¡ŒGCï¼Œä¼šé€šè¿‡ç›¸å…³çš„å®ˆæŠ¤çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œæœ‰æ—¶çº¿ç¨‹ä¼šè·Ÿä¸ä¸Šé˜Ÿåˆ—ï¼ˆç”Ÿäº§å¤§äºæ¶ˆè´¹ï¼‰</li></ul><p><strong>å¤„ç†</strong></p><ul><li>å¢åŠ å †å†…å­˜å¤§å° <code>-Xmx</code>ï¼ˆGB -&gt; G or g | MB -&gt; M or m| KB -&gt; K or kï¼‰</li><li>ä¿®å¤åº”ç”¨ä¸­çš„å†…å­˜æ³„æ¼</li></ul><h3 id="gc-overhead-limit-exceeded">GC overhead limit exceeded</h3><ul><li>Java è¿›ç¨‹èŠ±è´¹äº† 98% ä»¥ä¸Šçš„æ—¶é—´è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œå›æ”¶çš„å†…å­˜ä¸åˆ°2%ï¼Œè€Œä¸”åˆ°ç›®å‰ä¸ºæ­¢å·²ç»è¿ç»­è¿›è¡Œäº† 5 æ¬¡åƒåœ¾æ”¶é›†ï¼ˆç¼–è¯‘æ—¶å¸¸é‡ï¼‰</li></ul><p><strong>å¤„ç†</strong></p><ul><li>å¢åŠ å †å†…å­˜å¤§å° <code>-Xmx</code></li><li>GC å¼€é”€é™åˆ¶å¯ä»¥è°ƒæ•´ <code>-XX:- UseGCOverheadLimit</code></li><li>ä¿®å¤åº”ç”¨ä¸­çš„å†…å­˜æ³„æ¼</li></ul><h3 id="unable-to-create-new-native-thread">Unable to create new nativethread</h3><ul><li>æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´åˆ›å»ºæ–°çš„çº¿ç¨‹</li></ul><p><strong>å¤„ç†</strong></p><ul><li>ä¸ºæœåŠ¡å™¨åˆ†é…æ›´å¤šå†…å­˜</li><li>å¢åŠ å †å†…å­˜å¤§å°</li><li>ä¿®å¤åº”ç”¨ä¸­çš„çº¿ç¨‹æ³„æ¼</li><li>å¢åŠ  OS çš„é™åˆ¶<code>ulimit -a max user processes (-u) 1800</code></li><li>é€šè¿‡ <code>-Xss</code> å‚æ•°å‡å°‘çº¿ç¨‹æ ˆçš„å¤§å°</li></ul><h3 id="permgen-space">Permgen space</h3><ul><li>æ°¸ä¹…ä»£çš„å†…å®¹åŒ…æ‹¬<ul><li>Class å¯¹è±¡çš„åå­—ã€å˜é‡ã€æ–¹æ³•</li><li>ä¸ç±»å…³è”çš„å¯¹è±¡æ•°ç»„å’Œç±»å‹æ•°ç»„</li><li>JIT ä¼˜åŒ–ï¼ˆJust In Timeï¼‰</li></ul></li></ul><p><strong>å¤„ç†</strong></p><ul><li>å¢åŠ æ°¸ä¹…ä»£çš„å¤§å° <code>-XX:MaxPermSize</code></li><li>é‡æ–°å¯åŠ¨ JVM</li></ul><h3 id="metaspace">Metaspace</h3><ul><li>Java 8 ä¹‹åæ°¸ä¹…ä»£è¢«å…ƒç©ºé—´å–ä»£ï¼ŒClass ç›¸å…³çš„å…ƒæ•°æ®è¢«åˆ†é…åœ¨ nativememory ä¸­ï¼ˆç§°ä¸ºå…ƒç©ºé—´ï¼‰ï¼Œå¦‚æœå…ƒç©ºé—´è€—å°½ï¼Œåˆ™ä¼šæŠ›å‡ºè¯¥é”™è¯¯</li></ul><p><strong>å¤„ç†</strong></p><ul><li>å¦‚æœè®¾ç½®äº† <code>-XX:MaxMetaSpaceSize</code> ï¼Œåˆ™å¢åŠ å…¶å€¼</li><li>ç§»é™¤ <code>-XX:MaxMetaSpaceSize</code></li><li>å‡å°‘ Java å †å†…å­˜å¤§å°ï¼Œåˆ†é…æ›´å¤šçš„å†…å­˜ç»™å…ƒç©ºé—´</li><li>ä¸ºæœåŠ¡å™¨åˆ†é…æ›´å¤šå†…å­˜</li><li>åº”ç”¨ä¸­å¯èƒ½å­˜åœ¨ bug</li></ul><h3 id="requested-array-size-exceeds-vm-limit">Requested array sizeexceeds VM limit</h3><ul><li>åº”ç”¨å°è¯•åˆ†é…ä¸€ä¸ªå¤§äºå †å†…å­˜çš„æ•°ç»„</li></ul><p><strong>å¤„ç†</strong></p><ul><li>å¢åŠ å †å†…å­˜å¤§å° <code>-Xmx</code></li><li>ä¿®å¤ bugï¼Œå¤§æ¦‚ç‡ä¸éœ€è¦ä¸€ä¸ªå·¨å¤§çš„æ•°ç»„</li></ul><h3 id="kill-process-or-sacrifice-child">Kill process or sacrificechild</h3><ul><li>Kernel Job â€“ Out of Memory Killerè¿›ç¨‹å°†ä¼šåœ¨å†…å­˜ä¸è¶³æƒ…å†µä¸‹è¢«ç»ˆæ­¢</li></ul><p>å’Œå…¶ä»– OOM ä¸åŒï¼Œè¿™ä¸ªOOM æ˜¯ç”±æ“ä½œç³»ç»Ÿè§¦å‘</p><p><strong>å¤„ç†</strong></p><ul><li>å°†è¿›ç¨‹è¿ç§»åˆ°å…¶ä»–è®¡ç®—æœº</li><li>ç»™æœºå™¨å¢åŠ å†…å­˜</li></ul><h3 id="reason-stack_trace_with_native_-method">reasonstack_trace_with_native_ method</h3><ul><li>native æ–¹æ³•é‡åˆ°åˆ†é…å¤±è´¥</li><li>æ‰“å°å †æ ˆè·Ÿè¸ªï¼Œå…¶ä¸­åº•å±‚æ˜¯ native æ–¹æ³•</li></ul><p><strong>å¤„ç†</strong></p><ul><li>ç»“åˆ OS è¿›è¡Œåˆ†æ</li></ul><h2 id="jvm-è¿ç»´å·¥å…·">JVM è¿ç»´å·¥å…·</h2><h3 id="jps">jps</h3><blockquote><p>jps - Lists the instrumented Java Virtual Machines (JVMs) on thetarget system. This command is experimental and unsupported.</p><p>åˆ—å‡ºç›®æ ‡ç³»ç»Ÿä¸Šçš„å¯è§‚æµ‹çš„ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps [ options ] [ hostid ]</span><br></pre></td></tr></table></figure><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jps -l</span><br><span class="line"></span><br><span class="line"><span class="number">24947</span> org.jetbrains.jps.cmdline.Launcher</span><br><span class="line"><span class="number">29863</span> sun.tools.jps.Jps</span><br><span class="line"><span class="number">43962</span> org.jetbrains.jps.cmdline.Launcher</span><br><span class="line"><span class="number">34074</span> com.intellij.idea.Main</span><br></pre></td></tr></table></figure><h3 id="jstat">jstat</h3><blockquote><p>jstat - Monitors Java Virtual Machine (JVM) statistics. This commandis experimental and unsupported.</p><p>ç”¨äºç›‘æ§ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰ç»Ÿè®¡ä¿¡æ¯çš„å‘½ä»¤</p><p>ä½¿ç”¨ jstatå‘½ä»¤ï¼Œå¯ä»¥è·å–æœ‰å…³å †å†…å­˜ã€åƒåœ¾å›æ”¶ã€ç±»åŠ è½½ã€çº¿ç¨‹å’Œç¼–è¯‘ç­‰æ–¹é¢çš„æ•°æ®</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstat [ generalOption | outputOptions vmid [ interval[s|ms] [ count ] ]</span><br></pre></td></tr></table></figure><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jstat -gccause <span class="number">34074</span> <span class="number">1000</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT    LGCC                 GCC</span><br><span class="line">  <span class="number">0</span>.<span class="number">00</span>  <span class="number">94</span>.<span class="number">67</span>  <span class="number">93</span>.<span class="number">44</span>  <span class="number">33</span>.<span class="number">98</span>  <span class="number">99</span>.<span class="number">05</span>  <span class="number">96</span>.<span class="number">95</span>   <span class="number">2101</span>  <span class="number">503</span>.<span class="number">477</span>     <span class="number">9</span>   <span class="number">65</span>.<span class="number">924</span>  <span class="number">569</span>.<span class="number">401</span> No GC                G1 Evacuation <span class="built_in">Pause</span></span><br><span class="line">  <span class="number">0</span>.<span class="number">00</span>  <span class="number">91</span>.<span class="number">63</span>  <span class="number">45</span>.<span class="number">07</span>  <span class="number">33</span>.<span class="number">34</span>  <span class="number">99</span>.<span class="number">05</span>  <span class="number">96</span>.<span class="number">95</span>   <span class="number">2101</span>  <span class="number">504</span>.<span class="number">128</span>     <span class="number">9</span>   <span class="number">65</span>.<span class="number">924</span>  <span class="number">570</span>.<span class="number">052</span> G1 Evacuation <span class="built_in">Pause</span>  No GC</span><br><span class="line">  <span class="number">0</span>.<span class="number">00</span>  <span class="number">91</span>.<span class="number">63</span>  <span class="number">59</span>.<span class="number">15</span>  <span class="number">33</span>.<span class="number">34</span>  <span class="number">99</span>.<span class="number">05</span>  <span class="number">96</span>.<span class="number">95</span>   <span class="number">2101</span>  <span class="number">504</span>.<span class="number">128</span>     <span class="number">9</span>   <span class="number">65</span>.<span class="number">924</span>  <span class="number">570</span>.<span class="number">052</span> G1 Evacuation <span class="built_in">Pause</span>  No GC</span><br><span class="line">  <span class="number">0</span>.<span class="number">00</span>  <span class="number">91</span>.<span class="number">63</span>  <span class="number">60</span>.<span class="number">56</span>  <span class="number">33</span>.<span class="number">34</span>  <span class="number">99</span>.<span class="number">05</span>  <span class="number">96</span>.<span class="number">95</span>   <span class="number">2101</span>  <span class="number">504</span>.<span class="number">128</span>     <span class="number">9</span>   <span class="number">65</span>.<span class="number">924</span>  <span class="number">570</span>.<span class="number">052</span> G1 Evacuation <span class="built_in">Pause</span>  No GC</span><br><span class="line">  <span class="number">0</span>.<span class="number">00</span>  <span class="number">91</span>.<span class="number">63</span>  <span class="number">61</span>.<span class="number">97</span>  <span class="number">33</span>.<span class="number">34</span>  <span class="number">99</span>.<span class="number">05</span>  <span class="number">96</span>.<span class="number">95</span>   <span class="number">2101</span>  <span class="number">504</span>.<span class="number">128</span>     <span class="number">9</span>   <span class="number">65</span>.<span class="number">924</span>  <span class="number">570</span>.<span class="number">052</span> G1 Evacuation <span class="built_in">Pause</span>  No GC</span><br></pre></td></tr></table></figure><p>ä»¥ <code>gccause</code> æŸ¥çœ‹å †å†…å­˜ä¸ºä¾‹ï¼Œè¿™é‡Œè¡¨æ ¼æ ‡å¤´åˆ†åˆ«ä»£è¡¨</p><table><thead><tr class="header"><th style="text-align: center;">name</th><th style="text-align: center;">meaning</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">S0</td><td style="text-align: center;">Survivor 0 åŒºå ç”¨ç™¾åˆ†æ¯”</td></tr><tr class="even"><td style="text-align: center;">S1</td><td style="text-align: center;">Survivor 1 åŒºå ç”¨ç™¾åˆ†æ¯”</td></tr><tr class="odd"><td style="text-align: center;">E</td><td style="text-align: center;">Eden åŒºå ç”¨ç™¾åˆ†æ¯”</td></tr><tr class="even"><td style="text-align: center;">O</td><td style="text-align: center;">è€å¹´ä»£å ç”¨ç™¾åˆ†æ¯”</td></tr><tr class="odd"><td style="text-align: center;">M</td><td style="text-align: center;">å…ƒç©ºé—´å ç”¨ç™¾åˆ†æ¯”</td></tr><tr class="even"><td style="text-align: center;">CCS</td><td style="text-align: center;">å‹ç¼©ç±»ç©ºé—´å ç”¨ç™¾åˆ†æ¯”</td></tr><tr class="odd"><td style="text-align: center;">YGC</td><td style="text-align: center;">young GC å‘ç”Ÿæ¬¡æ•°</td></tr><tr class="even"><td style="text-align: center;">YGCT</td><td style="text-align: center;">yong GC åƒåœ¾å›æ”¶æ—¶é—´</td></tr><tr class="odd"><td style="text-align: center;">FGC</td><td style="text-align: center;">full GC å‘ç”Ÿæ¬¡æ•°</td></tr><tr class="even"><td style="text-align: center;">FGCT</td><td style="text-align: center;">full GC åƒåœ¾å›æ”¶æ—¶é—´</td></tr><tr class="odd"><td style="text-align: center;">GCT</td><td style="text-align: center;">æ€»å…±çš„åƒåœ¾å›æ”¶æ—¶é—´</td></tr><tr class="even"><td style="text-align: center;">LGCC</td><td style="text-align: center;">æœ€åä¸€æ¬¡ GC çš„åŸå› </td></tr><tr class="odd"><td style="text-align: center;">GCC</td><td style="text-align: center;">å½“å‰ GC çš„åŸå› </td></tr></tbody></table><h3 id="jstack">jstack</h3><blockquote><p>jstack - Prints Java thread stack traces for a Java process, corefile, or remote debug server. This command is experimental andunsupported.</p><p>è¾“å‡º Java è¿›ç¨‹ã€æ ¸å¿ƒæ–‡ä»¶æˆ–è¿œç¨‹è°ƒè¯•æœåŠ¡å™¨çš„ Java çº¿ç¨‹å †æ ˆè·Ÿè¸ª</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jstack [ options ] pid</span><br><span class="line">jstack [ options ] executable core</span><br><span class="line">jstack [ options ] [ server-id@ ] remote-hostname-or-IP</span><br></pre></td></tr></table></figure><h3 id="jmap">jmap</h3><blockquote><p>jmap - Prints shared object memory maps or heap memory details for aprocess, core file, or remote debug server.</p><p>æ‰“å°è¿›ç¨‹ã€æ ¸å¿ƒæ–‡ä»¶æˆ–è¿œç¨‹è°ƒè¯•æœåŠ¡å™¨çš„å…±äº«å¯¹è±¡å†…å­˜æ˜ å°„æˆ–å †å†…å­˜è¯¦ç»†ä¿¡æ¯</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jmap [ options ] pid</span><br><span class="line">jmap [ options ] executable core</span><br><span class="line">jmap [ options ] [ pid ] server-id@ ] remote-hostname-or-IP</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥ä½¿ç”¨ä¼šæŠ¥é”™ï¼ˆMacOSï¼‰</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Attaching to process ID 34074, please wait...</span><br><span class="line"><span class="keyword">ERROR: </span>attach: task_for_pid(34074) failed: &#x27;(os/kern) failure&#x27; (5)</span><br><span class="line"><span class="keyword">Error </span>attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can&#x27;t attach to the process. Could be caused by an incorrect pid or lack of privileges.</span><br><span class="line">sun.jvm.hotspot.debugger.DebuggerException: sun.jvm.hotspot.debugger.DebuggerException: Can&#x27;t attach to the process. Could be caused by an incorrect pid or lack of privileges.</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ–°ç‰ˆçš„ Linux ç³»ç»ŸåŠ å…¥äº† <code>ptrace-scope</code>æœºåˆ¶ï¼Œè¯¥æœºåˆ¶çš„ç›®çš„æ˜¯é˜²æ­¢ç”¨æˆ·è®¿é—®æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹çš„å†…å­˜ï¼Œä½†æ˜¯å¦‚<code>jinfo</code>ã€<code>jmap</code> è¿™äº›è°ƒè¯•ç±»å·¥å…·æœ¬èº«å°±æ˜¯åˆ©ç”¨<code>ptrace</code> æ¥è·å–æ‰§è¡Œè¿›ç¨‹çš„å†…å­˜ç­‰ä¿¡æ¯</p><p>ä¸€äº›æ–‡ç« ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆéœ€è¦ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œå¯ä»¥å‚è€ƒ</p><p><ahref="https://blog.csdn.net/weixin_42272869/article/details/124174890">Errorattaching to process sun.jvm.hotspot.debugger.DebuggerException cannotopen binary file_sun.jvm.hotspot.debugger.debuggerexception:cannot-CSDNåšå®¢</a></p><h2 id="æ‹…ä¿æœºåˆ¶ä¸-ergonomics">æ‹…ä¿æœºåˆ¶ä¸ Ergonomics</h2><p>åœ¨ PS + PO æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-05-11T15:56:45.857-0800: 56.923: [Full GC (Ergonomics)  46904K-&gt;46903K(49152K), 0.1493527 secs]</span><br></pre></td></tr></table></figure><p>æ—¥å¿—ä¸­ GC çš„åŸå› æ˜¯ Ergonomicsï¼Œåœ¨ä¸€äº›æ–‡ç« ä¸­æŠŠåŸå› ç§°ä¸ºå› ä¸ºæ‹…ä¿å¯¼è‡´çš„GCï¼Œå®é™…ä¸Šæ˜¯ä¸å‡†ç¡®çš„</p><h3 id="æ‹…ä¿æœºåˆ¶">æ‹…ä¿æœºåˆ¶</h3><p>æ‹…ä¿æœºåˆ¶çš„å®˜æ–¹æœ¯è¯­ç§°ä¸º Guarantee</p><blockquote><p>-XX:+HandlePromotionFailure</p><p>The youngest generation collection does not require a guarantee offull promotion of all live objects. (Introduced in 1.4.2 update 11) [5.0and earlier: false.]</p></blockquote><p>å‘ç”Ÿ GCæ—¶ï¼Œå½“è€å¹´ä»£å‰©ä½™ç©ºé—´å°äºå¹³å‡å¹´è½»ä»£å‘è€å¹´ä»£æ™‹å‡çš„ç©ºé—´å¤§å°ï¼Œå°±ä¼šè¿›è¡Œä¸€æ¬¡Full GC</p><h3 id="ergonomics">Ergonomics</h3><p>Ergonomics æ˜¯ä¸€ç§ JVM è‡ªåŠ¨ä¼˜åŒ–æ‰‹æ®µ</p><p>https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/ergonomics.html#ergonomics</p><p>JVM ä¼šæ ¹æ®ä¸€äº›é…ç½®è‡ªåŠ¨è°ƒæ•´å †å†…å­˜çš„å¤§å°ï¼š</p><ul><li>Maximum Pause Time Goalï¼šæœŸæœ›æœ€å¤§æš‚åœæ—¶é—´</li><li>Throughput Goalï¼šååé‡ç›®æ ‡ï¼Œä¾‹å¦‚ <code>-XX:GCTimeRatio=19</code>æ˜¯å°†åƒåœ¾æ”¶é›†çš„ç›®æ ‡è®¾ç½®ä¸ºæ€»æ—¶é—´çš„ 5%</li><li>FootprintGoalï¼šå¦‚æœå·²ç»è¾¾åˆ°ååé‡å’Œæœ€å¤§æš‚åœæ—¶é—´ç›®æ ‡ï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨ä¼šå‡å°å †çš„å¤§å°ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªç›®æ ‡ï¼ˆæ€»æ˜¯ååé‡ç›®æ ‡ï¼‰æ— æ³•è¾¾åˆ°ä¸ºæ­¢</li></ul><p><strong>è°ƒä¼˜çš„ç­–ç•¥</strong></p><ul><li>é™¤éæ‚¨çŸ¥é“éœ€è¦ä¸€ä¸ªå¤§äºé»˜è®¤æœ€å¤§å †å¤§å°çš„å †ï¼Œå¦åˆ™ä¸è¦ä¸ºå †é€‰æ‹©æœ€å¤§å€¼ï¼Œåº”è¯¥é€‰æ‹©ä¸€ä¸ªè¶³ä»¥æ»¡è¶³åº”ç”¨ç¨‹åºçš„ååé‡ç›®æ ‡</li><li>å †å°†å¢é•¿æˆ–æ”¶ç¼©åˆ°æ”¯æŒæ‰€é€‰ååé‡ç›®æ ‡çš„å¤§å°ã€‚åº”ç”¨ç¨‹åºè¡Œä¸ºçš„æ›´æ”¹å¯èƒ½ä¼šå¯¼è‡´å †å¢é•¿æˆ–æ”¶ç¼©ã€‚ä¾‹å¦‚å¦‚æœåº”ç”¨ç¨‹åºå¼€å§‹ä»¥æ›´é«˜çš„é€Ÿç‡è¿›è¡Œåˆ†é…ï¼Œåˆ™å †å°†å¢é•¿ä»¥ä¿æŒç›¸åŒçš„ååé‡ã€‚</li><li>å¦‚æœå †å¢é•¿åˆ°å…¶æœ€å¤§å¤§å°ï¼Œå¹¶ä¸”æ²¡æœ‰è¾¾åˆ°ååé‡ç›®æ ‡ï¼Œåˆ™æœ€å¤§å †å¤§å°å¯¹äºååé‡ç›®æ ‡æ¥è¯´å¤ªå°ï¼Œåº”è¯¥å°†æœ€å¤§å †å¤§å°è®¾ç½®ä¸ºä¸€ä¸ªå€¼ï¼Œè¯¥å€¼æ¥è¿‘å¹³å°ä¸Šçš„æ€»ç‰©ç†å†…å­˜ï¼Œä½†ä¸ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºçš„äº¤æ¢ï¼ˆswappingï¼‰ï¼Œå†æ¬¡æ‰§è¡Œåº”ç”¨ç¨‹åºï¼Œå¦‚æœä»æœªè¾¾åˆ°ååé‡ç›®æ ‡é‚£ä¹ˆè¯´æ˜åº”ç”¨ç¨‹åºæ—¶é—´çš„ç›®æ ‡å¯¹äºå¹³å°ä¸Šçš„å¯ç”¨å†…å­˜æ¥è¯´å¤ªé«˜äº†ï¼ˆæœºå™¨å†…å­˜ä¸è¶³ï¼‰</li><li>å¦‚æœå¯ä»¥è¾¾åˆ°ååé‡ç›®æ ‡ï¼Œä½†æš‚åœæ—¶é—´è¿‡é•¿ï¼Œåˆ™é€‰æ‹©æœ€å¤§æš‚åœæ—¶é—´ç›®æ ‡ï¼Œé€‰æ‹©æœ€é•¿æš‚åœæ—¶é—´ç›®æ ‡å¯èƒ½æ„å‘³ç€æ— æ³•è¾¾åˆ°ååé‡ç›®æ ‡ï¼Œå› æ­¤é€‰æ‹©å¯¹åº”ç”¨ç¨‹åºæ¥è¯´å¯ä»¥æ¥å—çš„æŠ˜è¡·å€¼</li><li>é€šå¸¸æƒ…å†µä¸‹å †çš„å¤§å°ä¼šéšç€åƒåœ¾æ”¶é›†å™¨è¯•å›¾æ»¡è¶³ç«äº‰ç›®æ ‡è€Œæ³¢åŠ¨ï¼Œå³ä½¿åº”ç”¨ç¨‹åºå·²è¾¾åˆ°ç¨³å®šçŠ¶æ€ï¼Œä¹Ÿæ˜¯å¦‚æ­¤å®ç°ååé‡ç›®æ ‡ï¼ˆå¯èƒ½éœ€è¦æ›´å¤§çš„å †ï¼‰çš„å‹åŠ›ä¸æœ€å¤§æš‚åœæ—¶é—´å’Œæœ€å°å†…å­˜å ç”¨ï¼ˆä¸¤è€…éƒ½å¯èƒ½éœ€è¦å°å †ï¼‰çš„ç›®æ ‡ç›¸ç«äº‰</li></ul><p>Ergonomics æ“ä½œå¯ä»¥é€šè¿‡å‚æ•° <code>-XX:-UseAdaptiveSizePolicy</code>æ¥è¿›è¡Œå…³é—­</p><p><br></p><p>æˆ‘è¿™é‡Œå¯åŠ¨äº†ä¸€ä¸ªæœåŠ¡ï¼Œåˆ†é…äº†è¶³å¤Ÿå°çš„å†…å­˜ï¼Œä¸æ–­åˆ›å»ºå¯¹è±¡ç›´åˆ°å‘ç”ŸOOM</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xms50m -Xmx50m -Xloggc:/Users/guorunze/temp/log/gc.log -XX:+PrintGCDateStamps -XX:-PrintGCDetails -XX:MaxGCPauseMillis=<span class="number">200</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤å¼€å¯</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span> <span class="number">1268</span>.<span class="number">1</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>   <span class="number">3632</span>.<span class="number">7</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">14786</span>.<span class="number">9</span>   <span class="number">39600</span>.<span class="number">0</span> <span class="number">36885</span>.<span class="number">3</span> <span class="number">5296</span>.<span class="number">0</span> <span class="number">4742</span>.<span class="number">0</span>     <span class="number">40</span>    <span class="number">0</span>.<span class="number">094</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">089</span>    <span class="number">0</span>.<span class="number">183</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span> <span class="number">1268</span>.<span class="number">1</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>   <span class="number">3632</span>.<span class="number">7</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">14786</span>.<span class="number">9</span>   <span class="number">39600</span>.<span class="number">0</span> <span class="number">36885</span>.<span class="number">3</span> <span class="number">5296</span>.<span class="number">0</span> <span class="number">4742</span>.<span class="number">0</span>     <span class="number">40</span>    <span class="number">0</span>.<span class="number">094</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">089</span>    <span class="number">0</span>.<span class="number">183</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">4096</span>.<span class="number">0</span> <span class="number">2032</span>.<span class="number">9</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">8704</span>.<span class="number">0</span>   <span class="number">2406</span>.<span class="number">1</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">19640</span>.<span class="number">4</span>   <span class="number">41008</span>.<span class="number">0</span> <span class="number">38297</span>.<span class="number">3</span> <span class="number">5424</span>.<span class="number">0</span> <span class="number">4929</span>.<span class="number">8</span>     <span class="number">42</span>    <span class="number">0</span>.<span class="number">103</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">089</span>    <span class="number">0</span>.<span class="number">192</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">3465</span>.<span class="number">9</span>  <span class="number">5632</span>.<span class="number">0</span>   <span class="number">994</span>.<span class="number">9</span>    <span class="number">34304</span>.<span class="number">0</span>    <span class="number">27764</span>.<span class="number">1</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38739</span>.<span class="number">4</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4985</span>.<span class="number">5</span>     <span class="number">45</span>    <span class="number">0</span>.<span class="number">118</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">089</span>    <span class="number">0</span>.<span class="number">207</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>    <span class="number">5632</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>     <span class="number">34304</span>.<span class="number">0</span>    <span class="number">31724</span>.<span class="number">0</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38545</span>.<span class="number">4</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">5</span>     <span class="number">46</span>    <span class="number">0</span>.<span class="number">124</span>   <span class="number">4</span>      <span class="number">0</span>.<span class="number">433</span>    <span class="number">0</span>.<span class="number">556</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>    <span class="number">5632</span>.<span class="number">0</span>   <span class="number">4387</span>.<span class="number">9</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34278</span>.<span class="number">5</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38545</span>.<span class="number">5</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">5</span>     <span class="number">46</span>    <span class="number">0</span>.<span class="number">124</span>   <span class="number">8</span>      <span class="number">0</span>.<span class="number">778</span>    <span class="number">0</span>.<span class="number">902</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>    <span class="number">5632</span>.<span class="number">0</span>   <span class="number">5604</span>.<span class="number">6</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34115</span>.<span class="number">6</span>   <span class="number">41648</span>.<span class="number">0</span> <span class="number">38718</span>.<span class="number">9</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4986</span>.<span class="number">1</span>     <span class="number">46</span>    <span class="number">0</span>.<span class="number">124</span>  <span class="number">13</span>      <span class="number">1</span>.<span class="number">648</span>    <span class="number">1</span>.<span class="number">771</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>    <span class="number">5632</span>.<span class="number">0</span>   <span class="number">5581</span>.<span class="number">2</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34114</span>.<span class="number">0</span>   <span class="number">41904</span>.<span class="number">0</span> <span class="number">39071</span>.<span class="number">1</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">5027</span>.<span class="number">2</span>     <span class="number">46</span>    <span class="number">0</span>.<span class="number">124</span>  <span class="number">17</span>      <span class="number">2</span>.<span class="number">409</span>    <span class="number">2</span>.<span class="number">532</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>    <span class="number">5632</span>.<span class="number">0</span>   <span class="number">5599</span>.<span class="number">6</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34114</span>.<span class="number">0</span>   <span class="number">41904</span>.<span class="number">0</span> <span class="number">39071</span>.<span class="number">1</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">5027</span>.<span class="number">2</span>     <span class="number">46</span>    <span class="number">0</span>.<span class="number">124</span>  <span class="number">17</span>      <span class="number">2</span>.<span class="number">409</span>    <span class="number">2</span>.<span class="number">532</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>    <span class="number">5632</span>.<span class="number">0</span>   <span class="number">4822</span>.<span class="number">1</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34110</span>.<span class="number">1</span>   <span class="number">41904</span>.<span class="number">0</span> <span class="number">39111</span>.<span class="number">5</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">5035</span>.<span class="number">1</span>     <span class="number">46</span>    <span class="number">0</span>.<span class="number">124</span>  <span class="number">20</span>      <span class="number">2</span>.<span class="number">833</span>    <span class="number">2</span>.<span class="number">957</span></span><br><span class="line"><span class="number">5632</span>.<span class="number">0</span> <span class="number">5632</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>    <span class="number">5632</span>.<span class="number">0</span>   <span class="number">4836</span>.<span class="number">1</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34110</span>.<span class="number">1</span>   <span class="number">41904</span>.<span class="number">0</span> <span class="number">39111</span>.<span class="number">5</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">5035</span>.<span class="number">1</span>     <span class="number">46</span>    <span class="number">0</span>.<span class="number">124</span>  <span class="number">20</span>      <span class="number">2</span>.<span class="number">833</span>    <span class="number">2</span>.<span class="number">957</span></span><br></pre></td></tr></table></figure><p>å…³é—­</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span> <span class="number">2043</span>.<span class="number">5</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>   <span class="number">1071</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">17905</span>.<span class="number">8</span>   <span class="number">39600</span>.<span class="number">0</span> <span class="number">37015</span>.<span class="number">0</span> <span class="number">5296</span>.<span class="number">0</span> <span class="number">4774</span>.<span class="number">8</span>     <span class="number">32</span>    <span class="number">0</span>.<span class="number">112</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">085</span>    <span class="number">0</span>.<span class="number">197</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span> <span class="number">2043</span>.<span class="number">5</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>   <span class="number">1071</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">17905</span>.<span class="number">8</span>   <span class="number">39600</span>.<span class="number">0</span> <span class="number">37015</span>.<span class="number">0</span> <span class="number">5296</span>.<span class="number">0</span> <span class="number">4774</span>.<span class="number">8</span>     <span class="number">32</span>    <span class="number">0</span>.<span class="number">112</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">085</span>    <span class="number">0</span>.<span class="number">197</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span> <span class="number">2043</span>.<span class="number">5</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>   <span class="number">1071</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">17905</span>.<span class="number">8</span>   <span class="number">39600</span>.<span class="number">0</span> <span class="number">37015</span>.<span class="number">0</span> <span class="number">5296</span>.<span class="number">0</span> <span class="number">4774</span>.<span class="number">8</span>     <span class="number">32</span>    <span class="number">0</span>.<span class="number">112</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">085</span>    <span class="number">0</span>.<span class="number">197</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span> <span class="number">2043</span>.<span class="number">5</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>   <span class="number">9275</span>.<span class="number">9</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">17905</span>.<span class="number">8</span>   <span class="number">39600</span>.<span class="number">0</span> <span class="number">37015</span>.<span class="number">0</span> <span class="number">5296</span>.<span class="number">0</span> <span class="number">4774</span>.<span class="number">8</span>     <span class="number">32</span>    <span class="number">0</span>.<span class="number">112</span>   <span class="number">2</span>      <span class="number">0</span>.<span class="number">085</span>    <span class="number">0</span>.<span class="number">197</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">2032</span>.<span class="number">0</span> <span class="number">12800</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>     <span class="number">34304</span>.<span class="number">0</span>    <span class="number">30780</span>.<span class="number">1</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38723</span>.<span class="number">6</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4988</span>.<span class="number">0</span>     <span class="number">35</span>    <span class="number">0</span>.<span class="number">147</span>   <span class="number">3</span>      <span class="number">0</span>.<span class="number">085</span>    <span class="number">0</span>.<span class="number">232</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span> <span class="number">2025</span>.<span class="number">9</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>     <span class="number">34304</span>.<span class="number">0</span>    <span class="number">29831</span>.<span class="number">1</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38661</span>.<span class="number">2</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4974</span>.<span class="number">4</span>     <span class="number">36</span>    <span class="number">0</span>.<span class="number">152</span>   <span class="number">4</span>      <span class="number">0</span>.<span class="number">249</span>    <span class="number">0</span>.<span class="number">401</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>   <span class="number">9340</span>.<span class="number">6</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34087</span>.<span class="number">4</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38510</span>.<span class="number">8</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">2</span>     <span class="number">36</span>    <span class="number">0</span>.<span class="number">152</span>   <span class="number">6</span>      <span class="number">0</span>.<span class="number">691</span>    <span class="number">0</span>.<span class="number">843</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>  <span class="number">12800</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">34083</span>.<span class="number">5</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38510</span>.<span class="number">8</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">2</span>     <span class="number">36</span>    <span class="number">0</span>.<span class="number">152</span>  <span class="number">10</span>      <span class="number">1</span>.<span class="number">101</span>    <span class="number">1</span>.<span class="number">253</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>  <span class="number">12800</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">33978</span>.<span class="number">9</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38510</span>.<span class="number">8</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">2</span>     <span class="number">36</span>    <span class="number">0</span>.<span class="number">152</span>  <span class="number">16</span>      <span class="number">2</span>.<span class="number">011</span>    <span class="number">2</span>.<span class="number">163</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>  <span class="number">12800</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">33963</span>.<span class="number">1</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38510</span>.<span class="number">8</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">2</span>     <span class="number">36</span>    <span class="number">0</span>.<span class="number">152</span>  <span class="number">23</span>      <span class="number">3</span>.<span class="number">003</span>    <span class="number">3</span>.<span class="number">155</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>  <span class="number">12800</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">33948</span>.<span class="number">6</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38510</span>.<span class="number">8</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">2</span>     <span class="number">36</span>    <span class="number">0</span>.<span class="number">152</span>  <span class="number">30</span>      <span class="number">4</span>.<span class="number">007</span>    <span class="number">4</span>.<span class="number">159</span></span><br><span class="line"><span class="number">2048</span>.<span class="number">0</span> <span class="number">2048</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>    <span class="number">0</span>.<span class="number">0</span>   <span class="number">12800</span>.<span class="number">0</span>  <span class="number">12800</span>.<span class="number">0</span>   <span class="number">34304</span>.<span class="number">0</span>    <span class="number">33936</span>.<span class="number">1</span>   <span class="number">41392</span>.<span class="number">0</span> <span class="number">38510</span>.<span class="number">8</span> <span class="number">5552</span>.<span class="number">0</span> <span class="number">4952</span>.<span class="number">2</span>     <span class="number">36</span>    <span class="number">0</span>.<span class="number">152</span>  <span class="number">37</span>      <span class="number">5</span>.<span class="number">038</span>    <span class="number">5</span>.<span class="number">190</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¼€å¯äº† Adaptive Size Policy åï¼Œå †å†…å­˜å¤§å°è¿›è¡Œäº†å˜åŒ–ï¼Œä¾‹å¦‚Eden åŒºç”± 12800 -&gt; 8704 -&gt; 5632</p><p>è€Œå…³é—­åï¼Œå„ä¸ªåŒºåŸŸçš„ç©ºé—´æ²¡æœ‰å˜åŒ–</p><h3 id="gc-ä¸­çš„-ergonomics-åˆ°åº•æ˜¯å› ä¸ºä»€ä¹ˆ">GC ä¸­çš„ Ergonomicsåˆ°åº•æ˜¯å› ä¸ºä»€ä¹ˆ</h3><p>æ‰€ä»¥ GC logs ä¸­ Ergonomics äº§ç”Ÿçš„ GC æ˜¯å› ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å…¶å®æ˜¯ä¸¤ç±»éƒ½æœ‰ï¼Œä¹Ÿå°±æ˜¯è¯´ GC logs è¿™é‡Œå±•ç¤ºçš„ Ergonomicså­˜åœ¨æ­§ä¹‰ï¼Œæœ‰ä¸€ä¸ª Issue æ­£æ˜¯å’Œè¿™ä¸ªé—®é¢˜ç›¸å…³</p><p><ahref="https://bugs.openjdk.org/browse/JDK-8067243?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel">JDK-8067243GC reason "Ergonomics" confusing - Java Bug System (openjdk.org)</a></p><blockquote><p>In this case the reason Ergonomics really mean "Not enough old spaceto handle next yc given the historical promotion rate", which does notnecessarily indicate a Full GC triggered by the resizing of theheap.</p><p>It would be great if we could be more specific about why we garbagecollect, so that the information can be actionable without reading theHotSpot source code. After discussions with Jesper, a better name wouldprobably be "Out of Old Space" possible with the addtion " for nextYC".</p></blockquote><p>å…³é—­äº†å †å†…å­˜è‡ªåŠ¨ä¼˜åŒ–åï¼ŒErgonomics çš„çœŸæ­£å«ä¹‰å…¶å®å°±å˜æˆäº†ç©ºé—´æ‹…ä¿</p><p>è¿™é‡Œ Issue çš„å‘èµ·è€…ä¹Ÿæä¾›äº†ä¸€ä¸ªæ›´ç›´è§‚çš„è¡¨è¾¾ <strong>Out of OldSpace</strong> + <strong>for next YC</strong></p><p>ä¸è¿‡çœ‹èµ·æ¥è¿™ä¸ª Issue è¿˜æ˜¯å¼€å¯çŠ¶æ€</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://sematext.com/blog/java-garbage-collection-logs/">JavaGarbage Collection Logs &amp; How to Analyze Them - Sematext</a></p><p><ahref="https://jun-wang.gitbook.io/learnjava/ji-shu-xue-xi/jvm-xue-xi/kan-dong-gc-ri-zhi">çœ‹æ‡‚gcæ—¥å¿—| LearnJava (gitbook.io)</a></p><p><a href="https://gceasy.ycrash.cn/gc-index.jsp">Universal JVM GCanalyzer - Java Garbage collection log analysis made easy(ycrash.cn)</a></p><p><ahref="https://stackoverflow.com/questions/50081873/full-garbage-collection-vs-major-garbage-collection">java- Full Garbage Collection vs. Major Garbage Collection - StackOverflow</a></p><p><ahref="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/ergonomics.html#ergonomics">Ergonomics(oracle.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>äºŒåˆ†æŸ¥æ‰¾çº¢è“åˆ†åŒºæ€æƒ³</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E7%BA%A2%E8%93%9D%E5%88%86%E5%8C%BA%E6%80%9D%E6%83%B3.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E7%BA%A2%E8%93%9D%E5%88%86%E5%8C%BA%E6%80%9D%E6%83%B3.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>äºŒåˆ†çš„æ€æƒ³å¾ˆç®€å•ï¼Œä½†æ˜¯éš¾åœ¨ coding ä¸Šï¼Œå› ä¸ºéœ€è¦è€ƒè™‘è¾¹ç•Œæ¡ä»¶</p><p>åœ¨ B ç«™ä¸Šçœ‹äº†ä¸€ä¸ªè§†é¢‘ï¼Œ<ahref="https://www.bilibili.com/video/BV1d54y1q7k7">äºŒåˆ†æŸ¥æ‰¾ä¸ºä»€ä¹ˆæ€»æ˜¯å†™é”™ï¼Ÿ</a>åŠ¨ç”»è®²è§£äº†ä¸€ç§æ¯”è¾ƒå¥½è®°å¿†å¤„ç†è¾¹ç•Œçš„æ–¹å¼ï¼ˆæˆ‘è®¤ä¸ºå¹¶ä¸æ˜¯åœ¨è®²äºŒåˆ†çš„æ€æƒ³ï¼Œè€Œæ˜¯ç”¨ä¸€ç§å›¾ç¤ºçš„æ–¹å¼é¿å…è¾¹ç•Œå¤„ç†é”™è¯¯ï¼‰ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œè®°å½•ä¸‹</p><h1 id="åº”ç”¨">åº”ç”¨</h1><p>å¼•å…¥æŠ›å‡ºäº†ä¸€ä¸ªé—®é¢˜</p><p>æœ‰è¿™æ ·ä¸€ä¸ªæœ‰åºæ•°ç»„<code>[1,2,3,5,5,5,8,9]</code>ï¼Œéœ€è¦æ‰¾å‡ºå¦‚ä¸‹ç­”æ¡ˆ</p><ul><li>æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äº 5 çš„å…ƒç´ </li><li>æ‰¾åˆ°æœ€åä¸€ä¸ªå°äº 5 çš„å…ƒç´ </li><li>æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äº 5 çš„å…ƒç´ </li><li>æ‰¾åˆ°æœ€åä¸€ä¸ªå°äºç­‰äº 5 çš„å…ƒç´ </li></ul><h2 id="æ–°è§’åº¦">æ–°è§’åº¦</h2><p>ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ä¸‹æ ‡ï¼Œä¸‹æ ‡çš„æœ¬è´¨å°±æ˜¯åˆ†ç•Œç‚¹Kï¼Œå‡è®¾åˆ†ç•Œç‚¹å°†æ•°ç»„åˆ†ä¸ºäº†çº¢è“ä¸¤éƒ¨åˆ†</p><ul><li>ä¸€å…±æœ‰ N ä¸ªå…ƒç´ </li><li>å…ƒç´ çš„ç¼–å·ä¸º 0 ~ N - 1</li><li>å‰ K ä¸ªå…ƒç´ ä¸ºè“è‰²ï¼Œå N - K ä¸ªå…ƒç´ ä¸ºçº¢è‰²</li></ul><p><span style="color: blue;">Â ( 0 )Â  ( 1 )Â  ( 2 ) ...Â ( k - 1)Â </span><span style="color: red;"> ( k )Â  ... ( N - 2 )Â  (N -1)Â </span></p><h2 id="ä¼ªä»£ç ">ä¼ªä»£ç </h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># l ä» - 1 å¼€å§‹</span></span><br><span class="line">l = -<span class="number">1</span></span><br><span class="line"><span class="comment"># r ä» N å¼€å§‹ï¼ˆsizeï¼‰</span></span><br><span class="line">r = N</span><br><span class="line"><span class="comment"># å¾ªç¯è¾¹ç•Œä¸º l ä¸€å®šåœ¨ r çš„å·¦è¾¹</span></span><br><span class="line"><span class="keyword">while</span> l + <span class="number">1</span> &lt; r</span><br><span class="line"><span class="comment"># äºŒåˆ†ä¸­ç‚¹</span></span><br><span class="line">m = (l + r) / <span class="number">2</span></span><br><span class="line"><span class="comment"># isBlue çš„æœ¬è´¨æ˜¯éœ€æ±‚ä¸­éœ€è¦æ‰¾å‡ºçš„åˆ†ç•Œç‚¹ K çš„åˆ¤æ–­è§„åˆ™</span></span><br><span class="line">    <span class="keyword">if</span> isBlue(m)</span><br><span class="line">    <span class="comment"># æŒ‡é’ˆç§»åŠ¨</span></span><br><span class="line">    l = m</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    r = m</span><br><span class="line"><span class="comment"># æ ¹æ®éœ€æ±‚é€‰æ‹©ä½¿ç”¨åˆ†ç•Œç‚¹å‰çš„å…ƒç´ è¿˜æ˜¯åé¢çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">return</span> l <span class="keyword">or</span> r</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦è®ºè¯å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li><strong>ä¸ºä»€ä¹ˆ <code>l</code> è¦ä» -1 å¼€å§‹ï¼Œè€Œ <code>r</code> ä» Nå¼€å§‹</strong> æƒ³è±¡å‡ºä¸€ä¸ªçº¢è“åŒºé—´ï¼Œå¦‚æœ <code>l</code> ä» 0å¼€å§‹ï¼Œé‚£ä¹ˆè‡³å°‘ä»£è¡¨ index = 0 çš„ä½ç½®ä¹Ÿæ˜¯è“è‰²ï¼Œè€Œè¿™æ˜¯ä¸åˆç†çš„ï¼›å¯¹äº<code>r</code> åŒç†</li><li><strong>ä¸ºä»€ä¹ˆå¾ªç¯æ¡ä»¶ä¸º <code>l + 1 &lt; r</code></strong>æƒ³è±¡å‡ºä¸€ä¸ªçº¢è“åŒºé—´ï¼Œå¦‚æœ <code>l</code> å’Œ <code>r</code>æœ‰äº¤å‰ï¼Œé‚£ä¹ˆäº¤å‰åŒºåŸŸæ—¢æ˜¯è“è‰²åˆæ˜¯çº¢è‰²ï¼Œä¹Ÿæ˜¯ä¸åˆç†çš„</li><li><strong><code>m</code> çš„å€¼ä¸€å®šæ˜¯ <code>[0,N)</code> å—</strong>åœ¨æ•´æ®µé€»è¾‘ä¸­ï¼Œ<code>l</code> çš„æœ€å°å€¼ä¸º -1ï¼Œ<code>r</code> çš„æœ€å°å€¼ä¸º1ï¼ˆä¸ºä»€ä¹ˆ <code>r</code> ä¸ä¼šä¸º 0ï¼Œå› ä¸º 0çš„è¯ï¼Œ<code>l + 1 &lt; r</code> ä¸ä¼šè¿›å…¥å¾ªç¯ï¼‰ï¼Œé‚£ä¹ˆ <code>m</code>çš„æœ€å°å€¼ä¸º 0 æœ€å¤§å€¼åŒç†ï¼Œ<code>r</code> çš„æœ€å¤§å€¼ä¸º Nï¼Œ<code>l</code>çš„æœ€å¤§å€¼ä¸º N - 2ï¼Œé‚£ä¹ˆ <code>m</code> çš„æœ€å¤§å€¼ä¸º N - 1</li></ul><h2 id="è§£å†³ä¸Šè¿°é—®é¢˜">è§£å†³ä¸Šè¿°é—®é¢˜</h2><p>å¥—ç”¨è¿™ä¸ªçº¢ç»¿åŒºé—´çš„æ¨¡æ¿ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸Šé¢å››ä¸ªé—®é¢˜çš„ç­”æ¡ˆ</p><table style="width:100%;"><colgroup><col style="width: 27%" /><col style="width: 57%" /><col style="width: 10%" /><col style="width: 3%" /></colgroup><thead><tr class="header"><th style="text-align: center;">é—®é¢˜</th><th style="text-align: center;">è“çº¢åˆ’åˆ†</th><th style="text-align: center;">isBlue æ¡ä»¶</th><th style="text-align: center;">è¿”å›</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äº 5 çš„å…ƒç´ </td><td style="text-align: center;"><span style="color: blue;"> ( 1 ) ( 2 )( 3 )</span><span style="color: red;"> ( 5 ) ( 5 ) ( 5 ) ( 8 ) ( 9)</span></td><td style="text-align: center;">å°äº 5</td><td style="text-align: center;">r</td></tr><tr class="even"><td style="text-align: center;">æ‰¾åˆ°æœ€åä¸€ä¸ªå°äº 5 çš„å…ƒç´ </td><td style="text-align: center;"><span style="color: blue;"> ( 1 ) ( 2 )( 3 )</span><span style="color: red;"> ( 5 ) ( 5 ) ( 5 ) ( 8 ) ( 9)</span></td><td style="text-align: center;">å°äº 5</td><td style="text-align: center;">l</td></tr><tr class="odd"><td style="text-align: center;">æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äº 5 çš„å…ƒç´ </td><td style="text-align: center;"><span style="color: blue;"> ( 1 ) ( 2 )( 3 ) ( 5 ) ( 5 ) ( 5 )</span><span style="color: red;"> ( 8 ) ( 9)</span></td><td style="text-align: center;">å°äºç­‰äº 5</td><td style="text-align: center;">r</td></tr><tr class="even"><td style="text-align: center;">æ‰¾åˆ°æœ€åä¸€ä¸ªå°äºç­‰äº 5 çš„å…ƒç´ </td><td style="text-align: center;"><span style="color: blue;"> ( 1 ) ( 2 )( 3 ) ( 5 ) ( 5 ) ( 5 )</span><span style="color: red;"> ( 8 ) ( 9)</span></td><td style="text-align: center;">å°äºç­‰äº 5</td><td style="text-align: center;">l</td></tr></tbody></table><p><strong>æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äº 5 çš„å…ƒç´ </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Binary</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> findFirstGte5Index(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">9</span>));</span><br><span class="line">        System.out.println(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">findFirstGte5Index</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> list.size();</span><br><span class="line">        <span class="keyword">while</span> (left + <span class="number">1</span> &lt; right) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> list.get(mid);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// isBlue æ¡ä»¶ å°äº 5</span></span><br><span class="line">            <span class="keyword">if</span> (isLt5(n)) &#123;</span><br><span class="line">                left = mid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                right = mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å› r</span></span><br><span class="line">        <span class="keyword">return</span> right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isLt5</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n &lt; <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰¾åˆ°æœ€åä¸€ä¸ªå°äºç­‰äº 5 çš„å…ƒç´ </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Binary</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> findLastLte5Index(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">9</span>));</span><br><span class="line">        System.out.println(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">findLastLte5Index</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> list.size();</span><br><span class="line">        <span class="keyword">while</span> (left + <span class="number">1</span> &lt; right) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> list.get(mid);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// isBlue æ¡ä»¶ å°äºç­‰äº 5</span></span><br><span class="line">            <span class="keyword">if</span> (isLte5(n)) &#123;</span><br><span class="line">                left = mid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                right = mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å› l</span></span><br><span class="line">        <span class="keyword">return</span> left;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isLte5</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n &lt;= <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://www.bilibili.com/video/BV1d54y1q7k7">äºŒåˆ†æŸ¥æ‰¾ä¸ºä»€ä¹ˆæ€»æ˜¯å†™é”™ï¼Ÿ_å“”å“©å“”å“©_bilibili</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç»“æ„ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ°´å¡˜æŠ½æ ·</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/%E6%B0%B4%E5%A1%98%E6%8A%BD%E6%A0%B7.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/%E6%B0%B4%E5%A1%98%E6%8A%BD%E6%A0%B7.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>åœ¨ n ä¸ªæ•°ä¸­ï¼Œå¦‚ä½•è®©æŠ½åˆ°æ¯ä¸€ä¸ªæ•°çš„æ¦‚ç‡ç›¸ç­‰</p><p>å¯ä»¥äº§ç”Ÿä¸€ä¸ªéšæœºæ•°ï¼Œn ä¸ªæ•°åˆ™åœ¨ [1,n] ä¸­äº§ç”Ÿä¸€ä¸ªéšæœºæ•°å³å¯</p><p>ä½†å¦‚æœæ¶‰åŠåˆ°å¤–éƒ¨æ•°æ®ï¼Œå³ä¸€æ¬¡å¹¶ä¸èƒ½å…¨éƒ¨è¯»å– n ä¸ªæ•°ï¼ˆn æœªçŸ¥ï¼‰ï¼›ä¾‹å¦‚ä¸€å…±1000 ä¸ªæ•°æ®ï¼Œä¸€æ¬¡åªèƒ½åŠ è½½ 10 ä¸ªï¼Œé‚£ä¹ˆå†æ¯ 10 ä¸ªåŠ è½½ä¸€æ¬¡ï¼Œæ€»å…±åŠ è½½ 100æ¬¡çš„è¿‡ç¨‹ä¸­å¦‚ä½•ä¿è¯æœ€ç»ˆå–åˆ°çš„å€¼æ»¡è¶³ 1/n</p><p>ä½¿ç”¨<strong>æ°´å¡˜æŠ½æ ·ç®—æ³•</strong>å¯ä»¥è§£å†³</p><p>åœ¨è¿™é‡Œï¼Œè¿˜åˆ†ä¸º K = 1ï¼ˆåªæŠ½ä¸€ä¸ªï¼‰å’Œ K &gt; 1ï¼ˆæŠ½å–å¤šä¸ªï¼‰</p><h1 id="k-1">K = 1</h1><p>åˆ†ç‰‡è¯»å–ï¼Œç¬¬ i ä¸ªæ•°çš„æ¦‚ç‡åº”è¯¥æ˜¯ 1/ i</p><p><strong>è®ºè¯å…¬å¼</strong> <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -7.193ex;" xmlns="http://www.w3.org/2000/svg" width="46.627ex" height="15.518ex" role="img" focusable="false" viewBox="0 -3679.5 20609.1 6859"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtable"><g data-mml-node="mtr" transform="translate(0,2337.5)"><g data-mml-node="mtd" transform="translate(778,0)"></g><g data-mml-node="mtd" transform="translate(778,0)"><g data-mml-node="mfrac"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(297.5,-686)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><rect width="700" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(1162.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(2162.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(2551.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3273.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(4273.9,0)"><g data-mml-node="mn" transform="translate(1003.7,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(6781.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(7392.6,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(8392.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(8781.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(9504,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(10504.2,0)"><g data-mml-node="mn" transform="translate(1003.7,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(13011.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(13400.7,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(14178.7,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(14623.3,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(15068,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(15512.7,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(16290.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(16679.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(17401.9,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(18402.1,0)"><g data-mml-node="mn" transform="translate(270,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><rect width="800" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(19442.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mtr" transform="translate(0,-72.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mtd" transform="translate(778,0)"><g data-mml-node="mfrac"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(297.5,-686)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><rect width="700" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(1162.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(2162.4,0)"><g data-mml-node="mi" transform="translate(1081.2,676)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(4892.1,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(5892.3,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(8399.8,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(9177.8,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(9622.4,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(10067.1,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(10511.8,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(11289.8,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(822.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(1822.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(1081.2,-686)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><rect width="2522.4" height="60" x="120" y="220"></rect></g></g></g><g data-mml-node="mtr" transform="translate(0,-2482.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mtd" transform="translate(778,0)"><g data-mml-node="mfrac"><g data-mml-node="mn" transform="translate(270,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><rect width="800" height="60" x="120" y="220"></rect></g></g></g></g></g></g></svg></mjx-container></span></p><p><strong>ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">poolSampling</span><span class="params">(<span class="keyword">final</span> List&lt;List&lt;Integer&gt;&gt; listList)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å½“å‰æ˜¯ç¬¬ä¸€ä¸ªæ•°å­—ï¼Œå³ i ï¼Œä½¿ç”¨è¿™ä¸ªå€¼ä½¿é€‰ä¸­å½“å‰å€¼çš„å‡ ç‡ä¸º 1/i</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è¿”å›å€¼ï¼Œéšæœºçš„æ•°å­— i</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å‡è®¾ listList æ˜¯ä¸€ä¸ªéœ€è¦åˆ†æ¬¡è¯»å–çš„æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> List&lt;Integer&gt; list : listList) {</span><br><span class="line">            <span class="comment">// æ¯ä¸€æ¬¡è¯»å–</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Integer i : list) {</span><br><span class="line">                count++;</span><br><span class="line">                <span class="comment">// ä» [0,n] ä¸­éšæœºä¸€ä¸ªæ•°ï¼Œå¦‚æœæ˜¯ 0ï¼Œåˆ™æ›¿æ¢ res</span></span><br><span class="line">                <span class="comment">// å³ 1/i çš„å‡ ç‡è¢«é€‰ä¸­äº†</span></span><br><span class="line">                <span class="keyword">if</span> (random.nextInt(count) == <span class="number">0</span>) {</span><br><span class="line">                    res = i;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure><h1 id="k-1-1">K &gt; 1</h1><p>å’Œ K = 1 æ€è·¯ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äº <strong>1/i</strong> çš„æ¦‚ç‡å‡çº§ä¸º<strong>k/i</strong></p><p><strong>è®ºè¯å…¬å¼</strong> <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -10.046ex;" xmlns="http://www.w3.org/2000/svg" width="61.494ex" height="21.224ex" role="img" focusable="false" viewBox="0 -4940.5 27180.4 9381"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtable"><g data-mml-node="mtr" transform="translate(0,3570.5)"><g data-mml-node="mtd" transform="translate(778,0)"></g><g data-mml-node="mtd" transform="translate(778,0)"><g data-mml-node="mfrac"><g data-mml-node="mi" transform="translate(220,676)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(308,-686)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><rect width="721" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(1183.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(2183.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(2572.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3294.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(4294.9,0)"><g data-mml-node="mi" transform="translate(993.2,676)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(7024.6,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(8024.8,0)"><g data-mml-node="mn" transform="translate(230.5,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><rect width="721" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(8985.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(9597,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(10597.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(10986.2,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(11708.4,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(12708.7,0)"><g data-mml-node="mi" transform="translate(993.2,676)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(15438.3,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(16438.6,0)"><g data-mml-node="mn" transform="translate(230.5,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><rect width="721" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(17399.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(17788.6,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(18566.6,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(19011.2,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(19455.9,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(19900.6,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(20678.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(21067.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(21789.8,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(22790,0)"><g data-mml-node="mi" transform="translate(259.5,676)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><rect width="800" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(24052.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(25052.4,0)"><g data-mml-node="mn" transform="translate(230.5,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><rect width="721" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(26013.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mtr" transform="translate(0,1132.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mtd" transform="translate(778,0)"><g data-mml-node="mfrac"><g data-mml-node="mi" transform="translate(220,676)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(308,-686)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><rect width="721" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(1183.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(2183.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(2572.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3294.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(4294.9,0)"><g data-mml-node="mn" transform="translate(1003.7,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(6802.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(7413.6,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(8413.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(8802.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(9525,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(10525.2,0)"><g data-mml-node="mn" transform="translate(1003.7,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(13032.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(13421.7,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(14199.7,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(14644.3,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(15089,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(15533.7,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(16311.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(16700.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(17422.9,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(18423.1,0)"><g data-mml-node="mn" transform="translate(270,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><rect width="800" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(19463.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mtr" transform="translate(0,-1305.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mtd" transform="translate(778,0)"><g data-mml-node="mfrac"><g data-mml-node="mi" transform="translate(220,676)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(308,-686)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><rect width="721" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(1183.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(2183.4,0)"><g data-mml-node="mi" transform="translate(1081.2,676)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(4913.1,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(5913.3,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(567.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1567.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><rect width="2267.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(8420.8,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(9198.8,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(9643.4,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(10088.1,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(10532.8,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(11310.8,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(822.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(1822.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(1081.2,-686)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><rect width="2522.4" height="60" x="120" y="220"></rect></g></g></g><g data-mml-node="mtr" transform="translate(0,-3743.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mtd" transform="translate(778,0)"><g data-mml-node="mfrac"><g data-mml-node="mi" transform="translate(259.5,676)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><rect width="800" height="60" x="120" y="220"></rect></g></g></g></g></g></g></svg></mjx-container></span></p><p><strong>ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span>[] poolSampling(<span class="keyword">final</span> List&lt;List&lt;Integer&gt;&gt; listList, <span class="keyword">final</span> <span class="type">int</span> k) {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å¤šä¸ªè¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span>[] res = <span class="keyword">new</span> <span class="title class_">int</span>[k];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> List&lt;Integer&gt; list : listList) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Integer i : list) {</span><br><span class="line">            count++;</span><br><span class="line">            <span class="comment">// å› ä¸º i/k çš„å‡ ç‡ï¼Œæ‰€ä»¥è®© resIndex &lt; kï¼Œåˆ™ resIndex ä¸€å®šè½åœ¨è¿”å›å€¼æ•°ç»„ä¸­</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">resIndex</span> <span class="operator">=</span> random.nextInt(count);</span><br><span class="line">            <span class="comment">// æ»¡è¶³ i/l å‡ ç‡ï¼ˆä» 0 å¼€å§‹ï¼Œåˆ™å°äºå³å¯ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (resIndex &lt; k) {</span><br><span class="line">                <span class="comment">// è®°å½•</span></span><br><span class="line">                res[resIndex] = i;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>s</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/107793995">éšæœºç®—æ³•ï¼šæ°´å¡˜æŠ½æ ·ç®—æ³• -çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://leetcode-cn.com/problems/random-pick-index/">398.éšæœºæ•°ç´¢å¼• - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com)</a></p><p><a href="https://leetcode-cn.com/problems/linked-list-random-node/">382.é“¾è¡¨éšæœºèŠ‚ç‚¹ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç»“æ„ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LiteFlow - å†³ç­–è·¯ç”±</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20%E5%86%B3%E7%AD%96%E8%B7%AF%E7%94%B1.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20%E5%86%B3%E7%AD%96%E8%B7%AF%E7%94%B1.html</url>
      
        <content type="html"><![CDATA[<h1 id="æ€æƒ³">æ€æƒ³</h1><p>LiteFlow 2.12.0 ç‰ˆæœ¬çš„ä¸»è¦ Feature å°±æ˜¯å¯¹å†³ç­–è·¯ç”±çš„æ”¯æŒ</p><p><ahref="https://mp.weixin.qq.com/s/KeTx9lZGWn0-mF6ilmO7Fg">åŠŸèƒ½å¼•å…¥çš„æ–‡ç« </a></p><p><a href="https://gitee.com/dromara/liteFlow/issues/I96A33">å¯¹åº”çš„Issue</a></p><p>è¿™æ ·å°±èƒ½å®ç°ç±»ä¼¼ Drools ä¸­çš„å†³ç­–è¡¨åŠŸèƒ½</p><h2 id="ä½¿ç”¨-switch-å®ç°">ä½¿ç”¨ SWITCH å®ç°</h2><p>å†³ç­–è·¯ç”±çš„æœ¬è´¨å°±æ˜¯åˆ¤æ–­æ‰€æœ‰è§„åˆ™çš„æ‰§è¡Œæ¡ä»¶ï¼Œå¹¶ä¸”æ‰§è¡Œç¬¦åˆæ¡ä»¶çš„è§„åˆ™</p><p>LangChain æ—©æœŸçš„è®¾è®¡ï¼Œå…¥å£éƒ½æ˜¯æŒ‡å®šä¸€ä¸ª Chainè¿›è¡Œæ‰§è¡Œï¼Œä½†ä¹Ÿæ˜¯å¯ä»¥å˜ç›¸æ”¯æŒè¿™ç§æ“ä½œï¼Œåœ¨å…¥å£è®¾ç½®ä¸€ä¸ª <code>SWITCH</code>èŠ‚ç‚¹ï¼Œç›¸å½“äºç”¨ä¸€ä¸ªé€»è¾‘åˆ¤æ–­ç»„åˆæ‰€æœ‰çš„ Chain</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain&quot;</span>&gt;</span></span><br><span class="line">        THEN(SWITCH(condition)</span><br><span class="line">            .to(</span><br><span class="line">                decisionA,</span><br><span class="line">                decisionB,</span><br><span class="line">                decisionC</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- å†³ç­–é€»è¾‘ A--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;decisionA&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- å†³ç­–é€»è¾‘ B--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;decisionB&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- å†³ç­–é€»è¾‘ C--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;decisionC&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ª EL å°†å†³ç­– Aã€Bã€C ä¸‰ä¸ª Chainé€šè¿‡ä¸€ä¸ªé€‰æ‹©ç»„ä»¶è”ç³»äº†èµ·æ¥ï¼Œæœ€ç»ˆå®ç°å†³ç­–è¡¨çš„æ•ˆæœ</p><p>éœ€è¦æ³¨æ„ï¼š</p><ul><li>è·¯ç”±ä½“åªèƒ½ç”±å¸ƒå°”ç»„ä»¶ç»„æˆ</li><li>è·¯ç”±ä½“åªèƒ½æ˜¯ä¸æˆ–éè¡¨è¾¾å¼</li><li>åŒ¹é…åˆ°çš„æ¯ä¸€ä¸ªè§„åˆ™çš„ä¸Šä¸‹æ–‡å®ä¾‹éƒ½æ˜¯å•ç‹¬çš„ï¼Œè¿è¡Œæ—¶æ˜¯å¹¶è¡Œæ‰§è¡Œ</li><li>è·¯ç”±ä¸­çš„ EL å¯åŠ¨æ—¶ä¸€å®šä¼šæ£€æŸ¥</li><li>è·¯ç”±ä½“çš„ EL æ”¯æŒ <code>tag</code> ç­‰å…³é”®å­—</li><li>JSON å’Œ YAML ç­‰æ ¼å¼ä½¿ç”¨ <code>value</code> name çš„ keyæ¥å­˜æ”¾è§„åˆ™ä½“ï¼Œæ‰€ä»¥æ²¡æœ‰ <code>body</code></li></ul><h2 id="switch-é€‰æ‹©ç»„ä»¶">SWITCH é€‰æ‹©ç»„ä»¶</h2><p>è¿™é‡Œå¤ä¹ ä¸€ä¸‹ CMP ä¸­çš„é€‰æ‹©ç»„ä»¶</p><p>é€‰æ‹©ç»„ä»¶éœ€è¦ç»§æ‰¿ <code>NodeSwitchComponent</code>ï¼Œå®ç°<code>processSwitch</code> æ–¹æ³•</p><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå°±å¯ä»¥è¿™æ ·æ¥å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LiteflowComponent(&quot;condition&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCondition</span> <span class="keyword">extends</span> <span class="title class_">NodeSwitchComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">processSwitch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// å†³ç­–åˆ¤æ–­</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">type</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;decisionA&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;decisionB&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;decisionV&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unexpected value: &quot;</span> + type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿”å›çš„å­—ç¬¦ä¸²å°±æ˜¯æ§åˆ¶ä¸‹ä¸€ä¸ªæµç¨‹çš„æ‰§è¡Œï¼Œæ”¯æŒ</p><ul><li>node IDï¼ˆä¾‹å¦‚ <code>@LiteflowComponent</code> ä¸Šé…ç½®çš„ç»„ä»¶ IDï¼‰</li><li>è¡¨è¾¾å¼ IDï¼ˆå¯¹äº EL è¡¨è¾¾å¼ä¸­ä¸€ä¸ªè¡¨è¾¾å¼è®¾ç½®çš„ ID<code>WHEN(c,d).id("w1")</code>ï¼‰</li><li>ç»„ä»¶æ ‡ç­¾ï¼ˆ<code>a.tag("1")</code>ï¼‰</li><li>è¡¨è¾¾å¼æ ‡ç­¾ï¼ˆ<code>WHEN(c,d).tag("w1")</code>ï¼‰</li><li>å­æµç¨‹æ ‡ç­¾ï¼ˆsub æ˜¯ä¸€ä¸ª chainï¼Œ<code>sub.tag("w1")</code>ï¼‰</li></ul><p>ä»£ç ä¸­å¯¹ç»„ä»¶è¿›è¡Œå®ç°åï¼Œå¯¹åº”çš„ EL å°±å¯ä»¥å¦‚ä¸‹ä¹¦å†™</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;switch1&quot;</span>&gt;</span></span><br><span class="line">    SWITCH(x).TO(a, b, c).DEFAULT(y);</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;switch1&quot;</span>&gt;</span></span><br><span class="line">    SWITCH(x).TO(a, b, THEN(c, d).id(&quot;t1&quot;)).DEFAULT(y);</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å­˜åœ¨çš„é—®é¢˜">å­˜åœ¨çš„é—®é¢˜</h2><p>è™½ç„¶ç”¨ SWITCH å¯ä»¥å®ç°ç±»ä¼¼å…¨å±€å†³ç­–è¡¨çš„åŠŸèƒ½ï¼Œä½†å…¶å®è¿˜æ˜¯æœ‰ä¸€äº›ä¸åŒ</p><ul><li>æ¯æ¬¡éƒ½è¦é€šè¿‡å‰ç½®é€‰æ‹©ç»„ä»¶çš„æ–¹å¼å®ç°ï¼Œæ“ä½œç¹ç</li><li>å¢åŠ æ–°çš„ Chainå®ç°æ—¶å®¹æ˜“æ¼æ‰ï¼Œå¹¶ä¸”éœ€è¦æ”¹åŠ¨é€‰æ‹©ç»„ä»¶å®ç°çš„ä»£ç æ¥æ¥å…¥</li><li>æ— æ³•å®ç°æ›´çµæ´»çš„ç»„ä»¶é€‰æ‹©ï¼ˆä¾‹å¦‚æ ¹æ®æŸç§æƒ…å†µè¿›è¡Œå¤šç§æ’åˆ—ç»„åˆï¼Œè¦å¯¹ ELè¿›è¡Œè¡¨è¾¾å¼æ‹†åˆ†ï¼‰</li></ul><h1 id="ä½¿ç”¨">ä½¿ç”¨</h1><h2 id="æ–‡æ¡£">æ–‡æ¡£</h2><p>åœ¨å®šä¹‰è§„åˆ™çš„æ—¶å€™ï¼Œæ–°å¢äº† <code>route</code> å’Œ <code>body</code>æ ‡ç­¾</p><ul><li>route å†…æ˜¯å†³ç­– ELï¼Œå†³ç­– ELé‡Œåªèƒ½ç”¨ä¸æˆ–éè¡¨è¾¾å¼ï¼Œå†…éƒ¨çš„ç»„ä»¶åªèƒ½æ˜¯å¸ƒå°”ç»„ä»¶</li><li>body å†…å°±æ˜¯åŸæœ‰çš„è§„åˆ™ EL</li></ul><p>æˆ‘ç†è§£åŸºæœ¬çš„å®ç°æ€æƒ³å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªé¡¶å±‚çš„ELï¼Œä½œä¸ºå†³ç­–è·¯ç”±çš„å…¥å£ï¼Œç›¸å½“äºé¡¶å±‚çš„é€‰æ‹©ç»„ä»¶ï¼Œæ˜¯æ¡†æ¶å¸®å¿™åŠ çš„</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">route</span>&gt;</span></span><br><span class="line">        AND(r1, r2, r3)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">route</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        THEN(a, b, c);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæ—¶è°ƒç”¨ <code>FlowExecutor</code> æä¾›çš„ä¸€ç³»åˆ—æ–°çš„ API</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;LiteflowResponse&gt; responseList = flowExecutor.executeRouteChain(requestData, YourContext.class);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨å LiteFlowä¼šå»å¹¶è¡Œçš„åˆ¤æ–­å†³ç­–è·¯ç”±ï¼Œç¬¦åˆå†³ç­–çš„è§„åˆ™ä¹Ÿä¼šè¢«å¹¶è¡Œçš„è¿›è¡Œæ‰§è¡Œ</p><p>è¿”å›æ˜¯ä¸€ä¸ª <code>List&lt;LiteflowResponse&gt;</code>ï¼ŒListé‡Œé¢çš„å°±æ˜¯æ¯ä¸€ä¸ªåŒ¹é…åˆ°çš„è§„åˆ™æ‰§è¡Œåçš„ç»“æœ</p><h2 id="demo">Demo</h2><p>å‡è®¾æœ‰ä¸€ä¸ªæˆå°±ç³»ç»Ÿï¼Œæ ¹æ®ç”¨æˆ·è¿åŠ¨çš„ä¸€äº›æ•°æ®è¿›è¡Œæˆå°±çš„å‘æ”¾</p><h3 id="æ¨¡æ‹Ÿç”¨æˆ·æˆå°±æ•°æ®">æ¨¡æ‹Ÿç”¨æˆ·æˆå°±æ•°æ®</h3><p>è¿™é‡Œç”¨ä¸€ä¸ªé™æ€ set å­˜æ”¾æ•°æ®ï¼Œå‡è®¾æ˜¯ä¸€æ¬¡æŒä¹…åŒ–æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAchievement</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; ACHIEVEMENTS_AND_COUNT = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addAchievement</span><span class="params">(String achievement)</span> &#123;</span><br><span class="line">        ACHIEVEMENTS_AND_COUNT.put(achievement, ACHIEVEMENTS_AND_COUNT.getOrDefault(achievement, <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; <span class="title function_">getAchievements</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ACHIEVEMENTS_AND_COUNT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸Šä¸‹æ–‡å‚æ•°">ä¸Šä¸‹æ–‡å‚æ•°</h3><p>æ‰¿æ¥ç”¨æˆ·çš„è¿åŠ¨æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExerciseData</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ· ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿åŠ¨è·ç¦»ï¼Œå•ä½ç±³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer exerciseDistanceMeters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿åŠ¨æ—¶é—´ï¼Œå•ä½åˆ†é’Ÿ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer exerciseTimeMinutes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®Œæˆæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long timestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ¤æ–­ç»„ä»¶">åˆ¤æ–­ç»„ä»¶</h3><p>è·‘æ­¥æˆå°±ç›¸å…³åˆ¤æ–­çš„å¸ƒå°”ç»„ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5 å…¬é‡Œ</span></span><br><span class="line"><span class="meta">@Component(&quot;jr5k&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JudgeRun5Kilometers</span> <span class="keyword">extends</span> <span class="title class_">NodeBooleanComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processBoolean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExerciseData</span> <span class="variable">exerciseData</span> <span class="operator">=</span> getRequestData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(exerciseData)</span><br><span class="line">                .map(ExerciseData::getExerciseDistanceMeters)</span><br><span class="line">                .map(distance -&gt; distance &gt;= <span class="number">5000</span>)</span><br><span class="line">                .orElse(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10 å…¬é‡Œ</span></span><br><span class="line"><span class="meta">@Component(&quot;jr10k&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JudgeRun10Kilometers</span> <span class="keyword">extends</span> <span class="title class_">NodeBooleanComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processBoolean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExerciseData</span> <span class="variable">exerciseData</span> <span class="operator">=</span> getRequestData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(exerciseData)</span><br><span class="line">                .map(ExerciseData::getExerciseDistanceMeters)</span><br><span class="line">                .map(distance -&gt; distance &gt;= <span class="number">10000</span>)</span><br><span class="line">                .orElse(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿åŠ¨æ—¶é—´æˆå°±ç›¸å…³åˆ¤æ–­çš„å¸ƒå°”ç»„ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿åŠ¨ 30 åˆ†é’Ÿ</span></span><br><span class="line"><span class="meta">@Component(&quot;je30m&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JudgeExercise30Minutes</span> <span class="keyword">extends</span> <span class="title class_">NodeBooleanComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processBoolean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExerciseData</span> <span class="variable">exerciseData</span> <span class="operator">=</span> getRequestData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(exerciseData)</span><br><span class="line">                .map(ExerciseData::getExerciseTimeMinutes)</span><br><span class="line">                .map(timeMinutes -&gt; timeMinutes &gt;= <span class="number">30</span>)</span><br><span class="line">                .orElse(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿åŠ¨ 60 åˆ†é’Ÿ</span></span><br><span class="line"><span class="meta">@Component(&quot;je60m&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JudgeExercise60Minutes</span> <span class="keyword">extends</span> <span class="title class_">NodeBooleanComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processBoolean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExerciseData</span> <span class="variable">exerciseData</span> <span class="operator">=</span> getRequestData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(exerciseData)</span><br><span class="line">                .map(ExerciseData::getExerciseTimeMinutes)</span><br><span class="line">                .map(timeMinutes -&gt; timeMinutes &gt;= <span class="number">60</span>)</span><br><span class="line">                .orElse(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ç»„ä»¶å°±æ˜¯ç”¨äºå†³ç­–è·¯ç”± EL ä¸­çš„ <code>rounte</code> éƒ¨åˆ†</p><h3 id="æ‰§è¡Œç»„ä»¶">æ‰§è¡Œç»„ä»¶</h3><p>æ‰§è¡Œç»„ä»¶ç”¨äºå‘æ”¾å¥–åŠ±</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·‘æ­¥ 5 å…¬é‡Œæˆå°±</span></span><br><span class="line"><span class="meta">@LiteflowComponent(&quot;ar5k&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AchievementRun5Kilometers</span> <span class="keyword">extends</span> <span class="title class_">NodeComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        UserAchievement.addAchievement(<span class="string">&quot;run 5 kilometers&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–çš„å®ç°ç±»ä¼¼</p><h3 id="el">EL</h3><p>ä½¿ç”¨ EL é…ç½®å†³ç­–è·¯ç”±</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;exercise-30-minutes&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">route</span>&gt;</span></span><br><span class="line">            je30m;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">route</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">            THEN(ae30m);</span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;exercise-60-minutes&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">route</span>&gt;</span></span><br><span class="line">            je60m;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">route</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">            THEN(ae60m);</span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;run-5-kilometers&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">route</span>&gt;</span></span><br><span class="line">            jr5k;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">route</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">            THEN(ar5k);</span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;run-10-kilometers&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">route</span>&gt;</span></span><br><span class="line">            jr10k;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">route</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">            THEN(ar10k);</span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œ">æ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExerciseData</span> <span class="variable">exerciseData</span> <span class="operator">=</span> ExerciseData.builder()</span><br><span class="line">        .userId(<span class="number">1L</span>)</span><br><span class="line">        .exerciseTimeMinutes(<span class="number">50</span>)</span><br><span class="line">        .exerciseDistanceMeters(<span class="number">15000</span>)</span><br><span class="line">        .timestamp(System.currentTimeMillis())</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œç»“æœ</span></span><br><span class="line">List&lt;LiteflowResponse&gt; responseList = flowExecutor.executeRouteChain(exerciseData);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆå°±ç»“æœ</span></span><br><span class="line">System.out.println(<span class="string">&quot;STAR &quot;</span> + UserAchievement.getAchievements());</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STAR &#123;<span class="built_in">run</span> 10 <span class="attribute">kilometers</span>=1, exercise 30 <span class="attribute">minutes</span>=1, <span class="built_in">run</span> 5 <span class="attribute">kilometers</span>=1&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° 15 km çš„è¿åŠ¨è·ç¦»åŒæ—¶è·å¾—äº† 5 å’Œ 10 km ä¸¤ä¸ªæˆå°±</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExerciseData</span> <span class="variable">exerciseData</span> <span class="operator">=</span> ExerciseData.builder()</span><br><span class="line">        .userId(<span class="number">1L</span>)</span><br><span class="line">        .exerciseTimeMinutes(<span class="number">50</span>)</span><br><span class="line">        .exerciseDistanceMeters(<span class="number">15000</span>)</span><br><span class="line">        .timestamp(System.currentTimeMillis())</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;STAR &quot;</span> + UserAchievement.getAchievements());</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STAR &#123;<span class="built_in">run</span> 5 <span class="attribute">kilometers</span>=1&#125;</span><br></pre></td></tr></table></figure><p>åªæ»¡è¶³äº†è·‘æ­¥ 5 km çš„æˆå°±</p><h1 id="æºç ">æºç </h1><h2 id="flowexcutor-æ‰§è¡Œ">FlowExcutor æ‰§è¡Œ</h2><p>è·¯ç”±å†³ç­–çš„å…¥å£æœ€ç»ˆä¼šåœ¨è®¾ç½®ä¸€äº›è¿è¡Œæ—¶å‚æ•°åè°ƒç”¨<code>doExecuteWithRoute</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;LiteflowResponse&gt; <span class="title function_">executeWithRoute</span><span class="params">(Object param, String requestId, Class&lt;?&gt;[] contextBeanClazzArray, Object[] contextBeanArray)</span>&#123;</span><br><span class="line">  <span class="comment">// æ ¸å¿ƒå…¥å£ è¿”å›å€¼æ˜¯ Slot çš„é›†åˆ</span></span><br><span class="line">  List&lt;Slot&gt; slotList = doExecuteWithRoute(param, requestId, contextBeanClazzArray, contextBeanArray);</span><br><span class="line">  <span class="comment">// wrap response</span></span><br><span class="line">  <span class="keyword">return</span> slotList.stream().map(LiteflowResponse::newMainResponse).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œå‡†å¤‡">æ‰§è¡Œå‡†å¤‡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;Slot&gt; <span class="title function_">doExecuteWithRoute</span><span class="params">(Object param, String requestId, Class&lt;?&gt;[] contextBeanClazzArray, Object[] contextBeanArray)</span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ FlowBus åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (FlowBus.needInit()) &#123;</span><br><span class="line">    init(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å¸¦æœ‰è·¯ç”±ä½“çš„ Chain é›†åˆ</span></span><br><span class="line">  List&lt;Chain&gt; routeChainList = FlowBus.getChainMap().values().stream().filter(chain -&gt; chain.getRouteItem() != <span class="literal">null</span>).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰ä¼šæŠ›ä¸€ä¸ªå¼‚å¸¸ï¼Œå› ä¸ºæ²¡æœ‰è·¯ç”±è§„åˆ™å°±æ²¡å¿…è¦è°ƒç”¨ executeWithRoute</span></span><br><span class="line">  <span class="keyword">if</span> (CollUtil.isEmpty(routeChainList))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RouteChainNotFoundException</span>(<span class="string">&quot;cannot find any route chain&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¡®å®š requestId</span></span><br><span class="line">  String finalRequestId;</span><br><span class="line">  <span class="keyword">if</span> (StrUtil.isBlank(requestId))&#123;</span><br><span class="line">    finalRequestId = IdGeneratorHolder.getInstance().generate();</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    finalRequestId = requestId;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨åšè°ƒç”¨å‰çš„å‡†å¤‡</p><ol type="1"><li>åˆ¤æ–­ <code>FlowBus</code> æ˜¯å¦åˆå§‹åŒ–å®Œæˆï¼›<code>FlowBus</code>æ˜¯å­˜æ”¾å„ç§ <code>Executable</code>çš„å·¥å…·ï¼Œåˆå§‹åŒ–å®Œæˆååº”è¯¥åŠ è½½äº†ç¯å¢ƒä¸‹æ‰€æœ‰çš„ç»„ä»¶ï¼›æ²¡æœ‰åˆå§‹åŒ–åˆ™åˆå§‹åŒ–æ˜¯ä¸ºäº†å…¼å®¹å…¶ä»–ç¯å¢ƒæˆ–è€…Spring ç¯å¢ƒä¸‹çš„ç‰¹æ®Šé…ç½®ï¼Œä¸€èˆ¬ Spring ç¯å¢ƒåœ¨ starter ä¸­çš„ Configurationå°±å®Œæˆäº†åˆå§‹åŒ–</li><li>è·å–æ‰€æœ‰å†³ç­–è·¯ç”±çš„ Chain å¹¶æ ¡éªŒ</li><li>ç¡®å®š requestIdï¼›ç”Ÿæˆä¸€ä¸ªæˆ–è€…ä½¿ç”¨å‚æ•°</li></ol><h3 id="å¼‚æ­¥æ‰§è¡Œè·¯ç”±ä½“">å¼‚æ­¥æ‰§è¡Œè·¯ç”±ä½“</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;Slot&gt; <span class="title function_">doExecuteWithRoute</span><span class="params">(Object param, String requestId, Class&lt;?&gt;[] contextBeanClazzArray, Object[] contextBeanArray)</span>&#123;</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å¼‚æ­¥æ‰§è¡Œ route el</span></span><br><span class="line">List&lt;Tuple&gt; routeTupleList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Chain routeChain : routeChainList)&#123;</span><br><span class="line">CompletableFuture&lt;Slot&gt; f = CompletableFuture.supplyAsync(</span><br><span class="line">() -&gt; doExecute(routeChain.getChainId(), param, finalRequestId, contextBeanClazzArray, contextBeanArray, <span class="literal">null</span>, InnerChainTypeEnum.NONE, ChainExecuteModeEnum.ROUTE)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">routeTupleList.add(<span class="keyword">new</span> <span class="title class_">Tuple</span>(routeChain, f));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–ç»“æœ</span></span><br><span class="line">CompletableFuture&lt;?&gt; resultRouteCf = CompletableFuture.allOf(routeTupleList.stream().map(</span><br><span class="line">(Function&lt;Tuple, CompletableFuture&lt;?&gt;&gt;) tuple -&gt; tuple.get(<span class="number">1</span>)</span><br><span class="line">).collect(Collectors.toList()).toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[] &#123;&#125;));</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">resultRouteCf.get();</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LiteFlowException</span>(<span class="string">&quot;There is An error occurred while executing the route.&quot;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>å¼‚æ­¥æ‰§è¡Œè¿™äº› Chainï¼Œå°† <code>CompletableFuture</code> å’Œ Chainæœ¬èº«åŒ…è£…ä¸º <code>Tuple</code>ï¼›å› ä¸ºåé¢æ‰§è¡Œ body é‡Œçš„é€»è¾‘è¿˜éœ€è¦ç”¨åˆ°è¿™ä¸ªChain å¯¹è±¡</li><li>ç­‰å¾…ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆï¼Œcheck ä¸€ä¸‹æœ‰æ²¡æœ‰å¼‚å¸¸ï¼Œä»»ä¸€æœ‰å¼‚å¸¸å°±ä¼šæŠ›å‡ºä¸€ä¸ª<code>LiteFlowException</code></li></ol><h3 id="è·å–è·¯ç”±ç»“æœå¹¶æ‰§è¡Œ">è·å–è·¯ç”±ç»“æœå¹¶æ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠŠ route æ‰§è¡Œä¸º true éƒ½è¿‡æ»¤å‡ºæ¥</span></span><br><span class="line">List&lt;Chain&gt; matchedRouteChainList = routeTupleList.stream().filter(tuple -&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    CompletableFuture&lt;Slot&gt; f = tuple.get(<span class="number">1</span>);</span><br><span class="line">    <span class="type">Slot</span> <span class="variable">slot</span> <span class="operator">=</span> f.get();</span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(slot.getRouteResult());</span><br><span class="line">  &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).map(</span><br><span class="line">    (Function&lt;Tuple, Chain&gt;) tuple -&gt; tuple.get(<span class="number">0</span>)</span><br><span class="line">).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (CollUtil.isEmpty(matchedRouteChainList))&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoMatchedRouteChainException</span>(<span class="string">&quot;there is no matched route chain&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼‚æ­¥åˆ†åˆ«æ‰§è¡Œè¿™äº› chain</span></span><br><span class="line">List&lt;CompletableFuture&lt;Slot&gt;&gt; executeChainCfList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Chain chain : matchedRouteChainList)&#123;</span><br><span class="line">  CompletableFuture&lt;Slot&gt; cf = CompletableFuture.supplyAsync(</span><br><span class="line">      () -&gt; doExecute(chain.getChainId(), param, finalRequestId, contextBeanClazzArray, contextBeanArray, <span class="literal">null</span>, InnerChainTypeEnum.NONE, ChainExecuteModeEnum.BODY)</span><br><span class="line">  );</span><br><span class="line">  executeChainCfList.add(cf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>ä»ä¸Šä¸€æ­¥çš„æµç¨‹ä¸­è·å–è·¯ç”±ç»“æœä¸º true çš„</li><li>å¼‚æ­¥æ‰§è¡Œè·¯ç”±ç»“æœä¸º true çš„ Chain</li></ol><h3 id="å¤„ç†ç»“æœ">å¤„ç†ç»“æœ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;?&gt; resultChainCf = CompletableFuture.allOf(executeChainCfList.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[] &#123;&#125;));</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  resultChainCf.get();</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LiteFlowException</span>(<span class="string">&quot;There is An error occurred while executing the matched chain.&quot;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">List&lt;Slot&gt; resultSlotList = executeChainCfList.stream().map(slotCompletableFuture -&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> slotCompletableFuture.get();</span><br><span class="line">  &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).filter(Objects::nonNull).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">LOG.info(<span class="string">&quot;There are &#123;&#125; chains that matched the route.&quot;</span>, resultSlotList.size());</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> resultSlotList;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°±æ˜¯æŠŠç»“æœè·å–ï¼Œæœ€åè¿”å›</p><p>è¿”å›çš„å¯¹è±¡æ˜¯ Slotï¼Œä¿å­˜äº†æ•´ä¸ª Chainè¿è¡Œæ—¶çš„å…ƒæ•°æ®ã€è¿‡ç¨‹æ•°æ®ã€ç»“æœç­‰</p><h3 id="åŒ…è£…-response">åŒ…è£… Response</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> slotList.stream().map(LiteflowResponse::newMainResponse).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> LiteflowResponse <span class="title function_">newResponse</span><span class="params">(Slot slot, Exception e)</span> &#123;</span><br><span class="line">  <span class="type">LiteflowResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LiteflowResponse</span>();</span><br><span class="line">  response.setChainId(slot.getChainId());</span><br><span class="line">  <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">    response.setSuccess(<span class="literal">false</span>);</span><br><span class="line">    response.setCause(e);</span><br><span class="line">    response.setMessage(response.getCause().getMessage());</span><br><span class="line">    response.setCode(response.getCause() <span class="keyword">instanceof</span> LiteFlowException</span><br><span class="line">        ? ((LiteFlowException) response.getCause()).getCode() : <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    response.setSuccess(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  response.setSlot(slot);</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ ¹æ®æ‰§è¡Œæƒ…å†µåŒ…è£…ä¸º<code>LiteflowResponse</code>ï¼Œè®¾ç½®ä¸åŒçš„å±æ€§</p><h2 id="el-è§£æ">EL è§£æ</h2><p>è¿™é‡Œä»¥ XML æ ¼å¼ä¸ºä¾‹</p><h3 id="è§£æ-route-å’Œ-body">è§£æ route å’Œ body</h3><p>è§<code>com.yomahub.liteflow.parser.helper.ParserHelper#parseOneChainEl(org.dom4j.Element)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Element</span> <span class="variable">routeElement</span> <span class="operator">=</span> e.element(ROUTE);</span><br><span class="line"></span><br><span class="line"><span class="type">LiteFlowChainELBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> LiteFlowChainELBuilder.createChain().setChainId(chainId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜åœ¨è·¯ç”±ä½“</span></span><br><span class="line"><span class="keyword">if</span> (routeElement != <span class="literal">null</span>)&#123;</span><br><span class="line">        builder.setRoute(ElRegexUtil.removeComments(routeElement.getText()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ‰è·¯ç”±ä½“å¿…ç„¶æœ‰ Body</span></span><br><span class="line">        <span class="type">Element</span> <span class="variable">bodyElement</span> <span class="operator">=</span> e.element(BODY);</span><br><span class="line">        <span class="keyword">if</span> (bodyElement == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">errMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;If you have defined the tag &lt;route&gt;, then you must define the tag &lt;body&gt; in chain[&#123;&#125;]&quot;</span>, chainId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowSystemException</span>(errMsg);</span><br><span class="line">        &#125;</span><br><span class="line">        builder.setEL(ElRegexUtil.removeComments(bodyElement.getText()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¸å­˜åœ¨</span></span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå…¼å®¹æ–°å¢çš„ Body æ ‡ç­¾å†™æ³•å’ŒåŸæœ‰æ— ä»»ä½•æ ‡ç­¾çš„å†™æ³•</span></span><br><span class="line">    <span class="type">Element</span> <span class="variable">bodyElement</span> <span class="operator">=</span> e.element(BODY);</span><br><span class="line">    <span class="keyword">if</span> (bodyElement != <span class="literal">null</span>)&#123;</span><br><span class="line">        builder.setEL(ElRegexUtil.removeComments(bodyElement.getText()));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        builder.setEL(ElRegexUtil.removeComments(e.getText()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·¯ç”±ä½“æ˜¯æ–°çš„å¤„ç†ï¼Œä½¿ç”¨<code>builder.setRoute(ElRegexUtil.removeComments(routeElement.getText()))</code></p><p>æ„é€ ç›¸å…³çš„å¯¹è±¡</p><p>è€Œå¯¹äº body åˆ™å’Œæ—§æœ‰æ²¡æœ‰æ ‡ç­¾çš„é€»è¾‘æ˜¯ä¸€è‡´çš„</p><h3 id="build-è·¯ç”±ä½“">Build è·¯ç”±ä½“</h3><p>è§<code>com.yomahub.liteflow.builder.el.LiteFlowChainELBuilder#setRoute</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LiteFlowChainELBuilder <span class="title function_">setRoute</span><span class="params">(String routeEl)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(routeEl)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">errMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;You have defined the label &lt;route&gt; but there is no el in the chain route[&#123;&#125;].&quot;</span>, chain.getChainId());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowSystemException</span>(errMsg);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; errorList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        DefaultContext&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">DefaultContext</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾€ä¸Šä¸‹æ–‡é‡Œæ”¾å…¥æ‰€æœ‰çš„nodeï¼Œä½¿å¾—elè¡¨è¾¾å¼å¯ä»¥ç›´æ¥å¼•ç”¨åˆ°nodeId</span></span><br><span class="line">        FlowBus.getNodeMap().keySet().forEach(nodeId -&gt; context.put(nodeId, FlowBus.getNode(nodeId)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æroute elæˆä¸ºä¸€ä¸ªexecutable</span></span><br><span class="line">        <span class="type">Executable</span> <span class="variable">routeExecutable</span> <span class="operator">=</span> (Executable) EXPRESS_RUNNER.execute(routeEl, context, errorList, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­routeELæ˜¯ä¸æ˜¯ç¬¦åˆè§„èŒƒ</span></span><br><span class="line">        <span class="keyword">if</span> (!(routeExecutable <span class="keyword">instanceof</span> AndOrCondition || routeExecutable <span class="keyword">instanceof</span> NotCondition || routeExecutable <span class="keyword">instanceof</span> Node)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RouteELInvalidException</span>(<span class="string">&quot;the route EL can only be a boolean node, or an AND or OR expression.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠä¸»è¦çš„conditionåŠ å…¥</span></span><br><span class="line">        <span class="built_in">this</span>.route = routeExecutable;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (QLException e) &#123;</span><br><span class="line">        <span class="comment">// EL åº•å±‚ä¼šåŒ…è£…å¼‚å¸¸ï¼Œè¿™é‡Œæ˜¯æ›²çº¿å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isNotNull(e.getCause()) &amp;&amp; Objects.equals(e.getCause().getMessage(), DataNotFoundException.MSG)) &#123;</span><br><span class="line">            <span class="comment">// æ„å»ºé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> buildDataNotFoundExceptionMsg(routeEl);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ELParseException</span>(msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ObjectUtil.isNotNull(e.getCause())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ELParseException</span>(e.getCause().getMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ELParseException</span>(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RouteELInvalidException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">errMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;parse el fail in this chain[&#123;&#125;];\r\n&quot;</span>, chain.getChainId());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ELParseException</span>(errMsg + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>æ„é€  EL è§£æçš„ä¸Šä¸‹æ–‡ï¼›è¿™é‡Œåªæ”¾å…¥äº†Nodeï¼Œè¯´æ˜è·¯ç”±ä½“ä¸­ä¸æ”¯æŒå­æµç¨‹</li><li>ç»è¿‡ <code>ExpressRunner</code>ï¼Œè§£æå‡º <code>Executable</code></li><li>æ ¡éªŒ <code>Executable</code> åªèƒ½æ˜¯å¸ƒå°”ç»„ä»¶ã€æˆ–è€…ä¸æˆ–éCondition</li><li>ä¿å­˜åˆ° <code>route</code> å±æ€§</li></ol><h3 id="build-chain">Build Chain</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.chain.setRouteItem(<span class="built_in">this</span>.route);</span><br><span class="line">    <span class="built_in">this</span>.chain.setConditionList(<span class="built_in">this</span>.conditionList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æš‚ä¸”å»æ‰å¾ªç¯ä¾èµ–æ£€æµ‹ï¼Œå› ä¸ºæœ‰å‘ç°å¾ªç¯ä¾èµ–æ£€æµ‹åœ¨å¯¹å¤§çš„ELè¿›è¡Œæ£€æµ‹çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´CPUé£™å‡ï¼Œä¹Ÿæˆ–è®¸æ˜¯jacksonä½ç‰ˆæœ¬çš„é—®é¢˜</span></span><br><span class="line">    <span class="comment">//checkBuild();</span></span><br><span class="line"></span><br><span class="line">    FlowBus.addChain(<span class="built_in">this</span>.chain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§<code>com.yomahub.liteflow.builder.el.LiteFlowChainELBuilder#build</code></p><ol type="1"><li>æ‰§è¡Œ <code>build</code> æ–¹æ³•åä¼šå°†è·¯ç”±ä½“å’Œè§„åˆ™è®¾ç½®ä¸º Chainå¯¹è±¡çš„å±æ€§</li><li>å°†è¯¥ Chain å¯¹è±¡åŠ å…¥ <code>FlowBus</code></li></ol><h1 id="æ€»ç»“">æ€»ç»“</h1><p>æœ¬è´¨ä¸Šå°±æ˜¯ä»æ¡†æ¶å±‚é¢æ”¯æŒäº†é¡¶å±‚çš„åˆ¤æ–­è¡¨è¾¾ï¼Œä½¿ç”¨å¼‚æ­¥åˆ¤æ–­æ¡ä»¶æ˜¯å¦ç¬¦åˆå¹¶ä¸”æ‰§è¡Œç»“æœ</p><p>è·¯ç”±å’Œè·¯ç”±ä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œæ€§èƒ½å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://liteflow.cc/pages/b7ed78/">ğŸ½å†³ç­–è·¯ç”±ç”¨æ³• |LiteFlow</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> LiteFlow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL EXPLAIN ä¸­çš„ type range</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>ä¹‹å‰ä¸€ç›´å¯¹ç´¢å¼•åˆ†æä¸­ type range æœ‰è¯¯è§£</p><p>ä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£å¯¹ type range çš„è§£é‡Š</p><blockquote><p><ahref="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html#jointype_range"><code>range</code></a>can be used when a key column is compared to a constant using any of the<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_equal"><code>=</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_not-equal"><code>&lt;&gt;</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_greater-than"><code>&gt;</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_greater-than-or-equal"><code>&gt;=</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_less-than"><code>&lt;</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_less-than-or-equal"><code>&lt;=</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_is-null"><code>IS NULL</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_equal-to"><code>&lt;=&gt;</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_between"><code>BETWEEN</code></a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/string-comparison-functions.html#operator_like"><code>LIKE</code></a>,or <ahref="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_in"><code>IN()</code></a>operators:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_column <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_column <span class="keyword">BETWEEN</span> <span class="number">10</span> <span class="keyword">and</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_column <span class="keyword">IN</span> (<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_part1 <span class="operator">=</span> <span class="number">10</span> <span class="keyword">AND</span> key_part2 <span class="keyword">IN</span> (<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>);</span><br></pre></td></tr></table></figure></blockquote><p><code>IN</code> æŸ¥è¯¢ä¸‹çš„ range ä»€ä¹ˆæ—¶å€™ä¼šæ¶åŒ–ä¸º ALLå‘¢ï¼ŸæŒ‰ç…§æˆ‘ä¹‹å‰çš„ç†è§£ï¼Œå¯èƒ½æœ‰ä¸¤ç‚¹</p><ul><li>æ•°é‡å¤ªå¤šï¼›è¿™ç‚¹æ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œä¾‹å¦‚ <code>IN</code>éœ€è¦ä¸èƒ½ä¼ è¿‡å¤šçš„å€¼ï¼Œå¦åˆ™ä¼˜åŒ–å™¨ä¸ä¼šé€‰æ‹©èµ°ç´¢å¼•</li><li>èŒƒå›´å¤ªå¤§ï¼›äº‹å®è¯æ˜ï¼Œ<code>IN</code> å’ŒèŒƒå›´æ— å…³</li></ul><p>ä¸Šè¿°ä¸¤ç‚¹ä¸­ï¼Œç¬¬äºŒç‚¹æ˜¯é”™è¯¯çš„ï¼ŒèŒƒå›´å¤ªå¤§å¹¶ä¸ä¼šå¯¼è‡´ <code>IN</code> çš„ç´¢å¼•type é€€åŒ–ä¸º ALL</p><p>è¿™ç¯‡æ–‡æ¡£å°±æ˜¯è¿›è¡ŒéªŒè¯å’Œè®°å½•ç­”æ¡ˆ</p><h1 id="ç†æ¸…æ¦‚å¿µ">ç†æ¸…æ¦‚å¿µ</h1><h2 id="type">type</h2><p>åœ¨ EXLAIN ä¸­ï¼Œtype æŒ‡çš„æ˜¯ join type</p><blockquote><p>The <code>type</code> column of <ahref="https://dev.mysql.com/doc/refman/5.7/en/explain.html"><code>EXPLAIN</code></a>output describes how tables are joined. In JSON-formatted output, theseare found as values of the <code>access_type</code> property.</p></blockquote><p>å¯¹äº type çš„å¥½åè¿™é‡Œå°±ä¸å†èµ˜è¿°</p><p>ä»å¥½åˆ°åä¸ºï¼š</p><ol type="1"><li><code>system</code> è¯¥è¡¨åªæœ‰ä¸€è¡Œï¼ˆç³»ç»Ÿè¡¨ï¼‰ï¼›ç‰¹æ®Šçš„ const</li><li><code>const</code> è¯¥è¡¨æœ€å¤šæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼Œè¯¥è¡Œåœ¨æŸ¥è¯¢å¼€å§‹æ—¶è¯»å–</li><li><code>eq_ref</code>å¯¹äºå‰ä¸€ä¸ªè¡¨ä¸­çš„æ¯ä¸€è¡Œç»„åˆï¼Œéƒ½ä¼šä»è¯¥è¡¨ä¸­è¯»å–ä¸€è¡Œï¼›å‡ºç°åœ¨è”è¡¨æŸ¥è¯¢æ—¶ï¼Œå½“è”æ¥ä½¿ç”¨ç´¢å¼•çš„æ‰€æœ‰éƒ¨åˆ†ï¼Œå¹¶ä¸”è¯¥ç´¢å¼•æ˜¯PRIMARY KEY æˆ– UNIQUE NOT NULL ç´¢å¼•æ—¶</li><li><code>ref</code>å¯¹äºå‰ä¸€ä¸ªè¡¨ä¸­çš„æ¯ä¸€ä¸ªè¡Œç»„åˆï¼Œéƒ½ä¼šä»æ­¤è¡¨ä¸­è¯»å–ç´¢å¼•å€¼åŒ¹é…çš„æ‰€æœ‰è¡Œï¼›å‡ºç°åœ¨è”è¡¨æŸ¥è¯¢æ—¶ï¼Œå¦‚æœè”æ¥ä¸èƒ½æ ¹æ®é”®å€¼é€‰æ‹©ä¸€è¡Œ</li><li><code>fulltext</code> è”è¡¨æŸ¥è¯¢ä½¿ç”¨ FULLTEXT ç´¢å¼•</li><li><code>ref_or_null</code> ç±»ä¼¼äº <code>ref</code>ï¼Œä½† MySQL ä¼šå¯¹åŒ…å«<code>NULL</code> å€¼çš„è¡Œè¿›è¡Œé¢å¤–æœç´¢</li><li><code>index_merge</code> ä½¿ç”¨äº†ç´¢å¼•åˆå¹¶ï¼ˆIndex Mergeï¼‰ä¼˜åŒ–</li><li><code>unique_subquery</code> å«æœ‰ <code>eq_ref</code> çš„å­æŸ¥è¯¢</li><li><code>index_subquery</code> ç±»ä¼¼<code>unique_subquery</code>ï¼Œä½†ç´¢å¼•æ˜¯éå”¯ä¸€çº¦æŸ</li><li><code>range</code> åªæ£€ç´¢ç»™å®šèŒƒå›´å†…çš„è¡Œï¼Œä½¿ç”¨ç´¢å¼•é€‰æ‹©è¡Œ</li><li><code>index</code> ä¸ <code>ALL</code>ç›¸åŒï¼Œåªæ˜¯æ‰«æäº†ç´¢å¼•æ ‘ï¼›åŒºåˆ«åœ¨äºç´¢å¼•è¦†ç›–æˆ–è€…æŒ‰ç…§ç´¢å¼•é¡ºåºå›è¡¨</li><li><code>ALL</code> å®Œæ•´çš„è¡¨æ‰«æ</li></ol><p>ä¹Ÿå°±æ˜¯è¯´ type è¡¨è¾¾çš„æ˜¯ JOIN ä¸‹ç´¢å¼•çš„æ‰§è¡Œç±»å‹ï¼ˆå•è¡¨å¯ä»¥ç†è§£ä¸ºç‰¹æ®Šçš„JOINï¼‰</p><h2 id="rows">rows</h2><blockquote><p>The <code>rows</code> column indicates the number of rows MySQLbelieves it must examine to execute the query.</p><p>For <ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html"><code>InnoDB</code></a>tables, this number is an estimate, and may not always be exact.</p></blockquote><p>è¿™é‡Œæœ‰ä¸€ä¸ªç–‘é—®ï¼Œrows æŒ‡çš„æ˜¯æ‰«æç´¢å¼•çš„è¡Œæ•°è¿˜æ˜¯å›è¡¨çš„è¡Œæ•°ï¼Ÿ</p><p>å®˜æ–¹æ–‡æ¡£åªè¡¨è¾¾ä¸º <code>must examine to execute</code></p><p>ä¸‹é¢è¿™é‡Œåšä¸€ä¸ªéªŒè¯ï¼Œæˆ‘æœ‰è¿™æ ·ä¸€ä¸ªè¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (</span><br><span class="line">  `ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `city_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`CountryCode`) <span class="keyword">REFERENCES</span> `country` (`Code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹é¢çš„åˆ†æ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="operator">=</span> &quot;BRA&quot; <span class="keyword">AND</span> name <span class="operator">=</span> &quot;Fortaleza&quot;;</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-1.png" class="" title="img-1"><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†ç´¢å¼• <code>CountryCode</code>ï¼Œtype ä¸º<code>ref</code>ï¼Œè¡Œæ•°ä¸º 250ï¼Œæˆ‘ä»¬è¡¨ä¸­ <code>CountryCode = "BRA"</code>å¯¹åº”çš„æ•°æ®å°±æ˜¯ 250 è¡Œ</p><p>å¦‚æœæˆ‘ä»¬åœ¨ç´¢å¼•ä¸ŠåŠ ä¸Š <code>name</code>ï¼Œå¯ä»¥çŒœæµ‹ä½¿ç”¨æ–°çš„ç´¢å¼• rowsåº”è¯¥æ˜¯ 1 è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> city <span class="keyword">ADD</span> KEY `idx_CountryCode_name`(`CountryCode`,`name`);</span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œåˆ†æ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="operator">=</span> &quot;BRA&quot; <span class="keyword">AND</span> name <span class="operator">=</span> &quot;Fortaleza&quot;;</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-2.png" class="" title="img-2"><p>å’ŒçŒœæƒ³çš„æ²¡é”™ï¼Œrows å…¶å®è¡¨ç¤ºçš„æ˜¯å›è¡¨çš„è¡Œæ•°</p><p>å¦‚æœæˆ‘ä»¬å°†è¯­å¥ä¿®æ”¹ä¸ºåªæŸ¥è¯¢ name å‘¢ï¼Ÿä¼šäº§ç”Ÿç´¢å¼•è¦†ç›–ï¼Œé‚£ä¹ˆ rowså¦‚ä½•æ˜¾ç¤ºï¼Ÿ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> name <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="operator">=</span> &quot;BRA&quot; <span class="keyword">AND</span> name <span class="operator">=</span> &quot;Fortaleza&quot;;</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-3.png" class="" title="img-3"><p>å¯ä»¥çœ‹åˆ° Extra å‘Šè¯‰æˆ‘ä»¬ <code>Using index</code> ä½¿ç”¨äº†ç´¢å¼•è¦†ç›–ï¼Œä½†æ˜¯rows è¿˜æ˜¯ 1</p><p>ä¸è¿‡ä¸ç®¡æ€ä¹ˆè¯´ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸º rowsè¡¨è¾¾çš„æ˜¯å›è¡¨çš„è¡Œï¼Œèµ·ç ä¸æ˜¯ä»£è¡¨æ‰«è¿‡çš„ç´¢å¼•ï¼›äº‹å®ä¸Šä»è¯­ä¹‰ä¸Šä¹Ÿå¯ä»¥è¿™ä¹ˆç†è§£ï¼Œç´¢å¼•ä¸­ä¹Ÿä¸ä¼šæœ‰row è¿™ä¸ªæ¦‚å¿µï¼ˆBTreeï¼‰</p><h1 id="éªŒè¯">éªŒè¯</h1><h2 id="å’Œæ•°é‡æœ‰å…³">å’Œæ•°é‡æœ‰å…³</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="keyword">IN</span> (&quot;ABW&quot;, &quot;AFG&quot;, &quot;AGO&quot;);</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-4.png" class="" title="img-4"><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢è¿™ä¸ªè¯­å¥æˆåŠŸèµ°äº†ç´¢å¼•ï¼Œtype ä¸º range</p><p>å¦‚æœåŠ å¤§ <code>IN</code> ä¸­çš„å€¼æ•°é‡</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="keyword">IN</span> (&quot;ABW&quot;, &quot;AFG&quot;, &quot;AGO&quot;, &quot;AIA&quot;, &quot;ALB&quot;, &quot;AND&quot;, &quot;ANT&quot;, &quot;ARE&quot;, &quot;ARG&quot;, &quot;ARM&quot;, &quot;ASM&quot;, &quot;ATG&quot;, &quot;AUS&quot;, &quot;AUT&quot;, &quot;AZE&quot;, &quot;BDI&quot;, &quot;BEL&quot;, &quot;BEN&quot;, &quot;BFA&quot;, &quot;BGD&quot;, &quot;BGR&quot;, &quot;BHR&quot;, &quot;BHS&quot;, &quot;BIH&quot;, &quot;BLR&quot;, &quot;BLZ&quot;, &quot;BMU&quot;, &quot;BOL&quot;, &quot;BRA&quot;, &quot;BRB&quot;, &quot;BRN&quot;, &quot;BTN&quot;, &quot;BWA&quot;, &quot;CAF&quot;, &quot;CAN&quot;, &quot;CCK&quot;, &quot;CHE&quot;, &quot;CHL&quot;, &quot;CHN&quot;, &quot;CIV&quot;, &quot;CMR&quot;, &quot;COD&quot;, &quot;COG&quot;, &quot;COK&quot;, &quot;COL&quot;, &quot;COM&quot;, &quot;CPV&quot;, &quot;CRI&quot;, &quot;CUB&quot;, &quot;CXR&quot;, &quot;CYM&quot;, &quot;CYP&quot;, &quot;CZE&quot;, &quot;DEU&quot;, &quot;DJI&quot;, &quot;DMA&quot;, &quot;DNK&quot;, &quot;DOM&quot;, &quot;DZA&quot;, &quot;ECU&quot;, &quot;EGY&quot;, &quot;ERI&quot;, &quot;ESH&quot;, &quot;ESP&quot;, &quot;EST&quot;, &quot;ETH&quot;, &quot;FIN&quot;, &quot;FJI&quot;, &quot;FLK&quot;, &quot;FRA&quot;, &quot;FRO&quot;, &quot;FSM&quot;, &quot;GAB&quot;, &quot;GBR&quot;, &quot;GEO&quot;, &quot;GHA&quot;, &quot;GIB&quot;, &quot;GIN&quot;, &quot;GLP&quot;, &quot;GMB&quot;, &quot;GNB&quot;, &quot;GNQ&quot;, &quot;GRC&quot;, &quot;GRD&quot;, &quot;GRL&quot;, &quot;GTM&quot;, &quot;GUF&quot;, &quot;GUM&quot;, &quot;GUY&quot;, &quot;HKG&quot;, &quot;HND&quot;, &quot;HRV&quot;, &quot;HTI&quot;, &quot;HUN&quot;, &quot;IDN&quot;, &quot;IND&quot;, &quot;IRL&quot;, &quot;IRN&quot;, &quot;IRQ&quot;, &quot;ISL&quot;, &quot;ISR&quot;, &quot;ITA&quot;, &quot;JAM&quot;, &quot;JOR&quot;, &quot;JPN&quot;, &quot;KAZ&quot;, &quot;KEN&quot;, &quot;KGZ&quot;, &quot;KHM&quot;);</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-5.png" class="" title="img-5"><p>å¯ä»¥çœ‹åˆ°èµ°äº† type ä¸º ALL çš„å…¨è¡¨æ‰«æ</p><h2 id="å’ŒèŒƒå›´æœ‰å…³">å’ŒèŒƒå›´æœ‰å…³</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(CountryCode) <span class="keyword">FROM</span> city;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(CountryCode) <span class="keyword">FROM</span> city <span class="keyword">ORDER</span> <span class="keyword">BY</span> CountryCode LIMIT <span class="number">110</span>, <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>å¾—åˆ° <code>CountryCode</code> æœ€å°å€¼å’Œä¸­é—´å€¼ä¸º <code>ABW</code> å’Œ<code>KNA</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="keyword">IN</span> (&quot;ABW&quot;, &quot;KNA&quot;);</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-6.png" class="" title="img-6"><p>å¯ä»¥å‘ç°ä¾ç„¶æ˜¯ rangeï¼Œå’Œ <code>IN</code> ä¸­çš„èŒƒå›´æ²¡æœ‰å…³ç³»</p><p>è€Œä¸”æ‰«æè¡Œæ•°æ˜¯ 2ï¼Œè¿™æ˜¯ä¸æ˜¯å¯ä»¥è¯´æ˜è¡¨ä¸­å€¼ä¸º <code>ABW</code> å’Œ<code>KNA</code> çš„æ•°æ®åªæœ‰ä¸¤æ¡å‘¢ï¼Ÿï¼ˆè™½ç„¶ InnoDBå¼•æ“ä¸‹çš„è¡Œæ•°ä¸ä¸€å®šå‡†ç¡®ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="keyword">IN</span> (&quot;ABW&quot;, &quot;KNA&quot;);</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-7.png" class="" title="img-7"><p>ç»“æœç¡®å®æ˜¯ 2 è¡Œ</p><h1 id="ç»“è®º">ç»“è®º</h1><h2 id="ä¸ºä»€ä¹ˆå’Œæ•°é‡æœ‰å…³">ä¸ºä»€ä¹ˆå’Œæ•°é‡æœ‰å…³</h2><blockquote><p>Read about <ahref="https://dev.mysql.com/doc/refman/8.0/en/range-optimization.html#range-optimization-memory-use">LimitingMemory Use for Range Optimization</a>.</p><p>When you have a large list of values in an <code>IN()</code>predicate, it uses more memory during the query optimization step. Thiswas considered a problem in some cases, so recent versions of MySQL seta max memory limit (it's 8MB by default).</p><p>If the optimizer finds that it would need more memory than the limit,there is not another condition in your query it can use to optimize, itgives up trying to optimize, and resorts to a table-scan. I infer thatyour table statistics actually show that the table has ~221 million rows(though table statistics are inexact estimates).</p><p>I can't say I know the exact formula to know how much memory isneeded for a given list of values, but given your observed behavior, wecould guess that it's about 600 bytes per item on average, given that14k items works and more than that does not work.</p><p>You can set <code>range_optimizer_max_mem_size = 0</code> to disablethe memory limit. This creates a risk of excessive memory use, but itavoids the optimizer "giving up." We set this value on all MySQLinstances at my last job, because we couldn't educate the developers toavoid creating huge lists of values in their queries.</p></blockquote><p>æ€»ç»“ï¼š</p><ul><li>ä¼˜åŒ–å™¨è®¤ä¸ºåº”è¯¥èµ°å…¨è¡¨æ‰«æ</li><li>ç´¢å¼•ä½¿ç”¨çš„å†…å­˜è¶…å‡ºäº† <code>range_optimizer_max_mem_size</code>çš„é™åˆ¶</li></ul><p><code>range_optimizer_max_mem_size</code> çš„é»˜è®¤å€¼ä¸º<code>8388608</code> å³ 8 MB</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SESSION range_optimizer_max_mem_size <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> city <span class="keyword">WHERE</span> CountryCode <span class="keyword">IN</span> (&quot;ABW&quot;, &quot;KNA&quot;);</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-8.png" class="" title="img-8"><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-9.png" class="" title="img-9"><h2 id="innodb-å¼•æ“ä¸‹-rows-è¿‘ä¼¼å€¼">InnoDB å¼•æ“ä¸‹ rows è¿‘ä¼¼å€¼</h2><p>å¯¹äº InnoDB å¼•æ“è€Œè¨€ï¼ŒEXPLAIN ä¸‹çš„ rowsæ•°å­—æ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œå¯èƒ½å¹¶ä¸æ€»æ˜¯å‡†ç¡®çš„</p><p>å› ä¸º InnoDBå­˜å‚¨å¼•æ“ä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰çš„æœºåˆ¶æ¥å¤„ç†å¹¶å‘äº‹åŠ¡ï¼ŒMVCCå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»å–å’Œä¿®æ”¹è¡¨ä¸­çš„æ•°æ®ï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°</p><p>ä¸ºäº†æ”¯æŒ MVCCï¼ŒInnoDB ä½¿ç”¨ Undo Log ç”¨äºå­˜å‚¨æ—§ç‰ˆæœ¬çš„æ•°æ®</p><p>å½“ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†è¡¨ä¸­çš„æ•°æ®æ—¶ï¼ŒInnoDBä¼šå°†æ—§ç‰ˆæœ¬çš„æ•°æ®å­˜å‚¨åœ¨å›æ»šæ®µä¸­ï¼Œä»¥ä¾¿å…¶ä»–äº‹åŠ¡å¯ä»¥è¯»å–åˆ°ä¸€è‡´çš„æ•°æ®è§†å›¾</p><p>ç”±äºå›æ»šæ®µä¸­å¯èƒ½å­˜åœ¨å¤šä¸ªäº‹åŠ¡çš„æ—§ç‰ˆæœ¬æ•°æ®ï¼ŒInnoDBæ— æ³•ç²¾ç¡®åœ°çŸ¥é“è¡¨ä¸­çš„è¡Œæ•°ã€‚å®ƒåªèƒ½æ ¹æ®å›æ»šæ®µä¸­çš„æ•°æ®ä¼°è®¡å‡ºå¤§è‡´çš„è¡Œæ•°</p><h2 id="eq_range_index_dive_limit">eq_range_index_dive_limit</h2><p><code>eq_range_index_dive_limit</code> è¿™ä¸ªå‚æ•°åœ¨æ§åˆ¶ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å…¶å®æ§åˆ¶çš„æ˜¯å¯¹æ‰«æè¡Œæ•°çš„é¢„ä¼°</p><p>ç®€å•æ¥è¯´å°±æ˜¯æ ¹æ® <code>eq_range_index_dive_limit</code>å‚æ•°è®¾ç½®çš„é˜€å€¼æ¥æŒ‰ç…§ä¸åŒç®—æ³•é¢„ä¼°å½±å“è¡Œæ•°ï¼Œå¯¹äº <code>IN</code> æˆ–<code>OR</code> æ¡ä»¶ä¸­çš„æ¯ä¸ªèŒƒå›´æ®µè§†ä¸ºä¸€ä¸ªå…ƒç»„ï¼Œå¯¹äºå…ƒç»„æ•°ä½äº<code>eq_range_index_dive_limit</code> å‚æ•°é˜€å€¼æ—¶ä½¿ç”¨ index diveç®—æ³•ï¼Œå¯¹äºé«˜äºé˜ˆå€¼ä½¿ç”¨ index statistics ç®—æ³•</p><ul><li><strong>index dive</strong> é’ˆå¯¹æ¯ä¸ªå…ƒç»„ dive åˆ° indexä¸­ä½¿ç”¨ç´¢å¼•å®Œæˆå…ƒç»„æ•°çš„ä¼°ç®—ï¼Œç±»ä¼¼äºä½¿ç”¨ç´¢å¼•è¿›è¡Œå®é™…æŸ¥è¯¢å¾—åˆ°å½±å“è¡Œæ•°</li><li><strong>index statistics</strong>æ ¹æ®ç´¢å¼•çš„ç»Ÿè®¡æ•°å€¼è¿›è¡Œä¼°ç®—ï¼Œä¾‹å¦‚ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯è®¡ç®—å‡ºæ¯ä¸ªç­‰å€¼å½±å“ 100æ¡æ•°æ®ï¼Œé‚£ä¹ˆ <code>IN</code> æ¡ä»¶ä¸­åŒ…å« 5 ä¸ªç­‰å€¼åˆ™å½±å“<code>5 * 100</code> æ¡è®°å½•</li></ul><p><code>eq_range_index_dive_limit</code> åœ¨ 5.7 ç‰ˆæœ¬ä¸‹é»˜è®¤<code>200</code></p><img src="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20EXPLAIN%20%E4%B8%AD%E7%9A%84%20type%20range/img-10.png" class="" title="img-10"><p>å¯ä»¥çœ‹åˆ°å°† <code>eq_range_index_dive_limit</code> è®¾ç½®ä¸º 1æ—¶ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºè¶…å‡ºäº†é˜ˆå€¼ï¼Œä½¿ç”¨ index statistics è¿›è¡Œä¼°ç®—ï¼Œè¿”å›çš„ rowsæ˜¯ä¸ç¬¦åˆå®é™…æƒ…å†µçš„ä¼°ç®—å€¼</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html#explain-join-types">MySQL:: MySQL 5.7 Reference Manual :: 8.8.2 EXPLAIN Output Format</a></p><p><ahref="https://zhuanlan.zhihu.com/p/638202900?utm_id=0">inç”¨ä¸ç”¨ç´¢å¼•ï¼Œå•¥æ—¶å€™èƒ½ç”¨å•¥æ—¶å€™ä¸èƒ½ç”¨ï¼Œä¸€æ–‡è¯´æ¸…- çŸ¥ä¹ (zhihu.com)</a></p><p><ahref="https://stackoverflow.com/questions/72361880/mysql-in-operator-on-large-number-of-values">MySQL'IN' operator on large number of values - Stack Overflow</a></p><p><ahref="https://dev.mysql.com/doc/refman/8.0/en/range-optimization.html#range-optimization-memory-use">LimitingMemory Use for Range Optimization</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DB </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis SCAN åŸç†</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/Redis/Redis%20SCAN%20%E5%8E%9F%E7%90%86.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/Redis/Redis%20SCAN%20%E5%8E%9F%E7%90%86.html</url>
      
        <content type="html"><![CDATA[<h1 id="å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</h1><p><strong>è¯­æ³•</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCAN cursor [MATCH pattern] [COUNT count] [TYPE <span class="built_in">type</span>]</span><br></pre></td></tr></table></figure><p><strong>æ—¶é—´å¤æ‚åº¦</strong></p><p>ä¸€æ¬¡è°ƒç”¨æ˜¯ <code>O(1)</code>ï¼Œå®Œæ•´çš„è¿­ä»£æ˜¯<code>O(N)</code>ï¼ŒåŒ…æ‹¬ä¸æ–­è°ƒç”¨ç›´åˆ°è¿”å› cursor ä¸º 0ï¼›Nä¸ºé›†åˆå†…å…ƒç´ æ•°é‡</p><p><code>SCAN</code> å‘½ä»¤å’Œç›¸å…³çš„ <code>SSCAN</code>ã€<code>HSCAN</code>å’Œ <code>ZSCAN</code> å‘½ä»¤éƒ½æ˜¯ç”¨äºå¯¹å…ƒç´ é›†åˆè¿›è¡Œå¢é‡è¿­ä»£</p><ul><li><code>SCAN</code> è¿­ä»£å½“å‰æ‰€é€‰ Redis æ•°æ®åº“ä¸­ keys</li><li><code>SSCAN</code> è¿­ä»£ Set çš„å…ƒç´ </li><li><code>HSCAN</code> è¿­ä»£ Hash çš„å­—æ®µå’Œå®ƒä»¬å¯¹åº”çš„ value</li><li><code>ZSCAN</code> è¿­ä»£ Sorted Set å’Œå®ƒä»¬å¯¹åº”çš„ score</li></ul><p>ç”±äºè¿™äº›å‘½ä»¤å…è®¸å¢é‡è¿­ä»£ï¼Œæ¯æ¬¡è°ƒç”¨åªè¿”å›å°‘é‡å…ƒç´ ï¼Œå› æ­¤å¯ä»¥åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œè€Œä¸ä¼šå‡ºç°<code>KEYS</code> æˆ– <code>SMEMBERS</code>ç­‰å‘½ä»¤çš„ç¼ºç‚¹ï¼Œè¿™äº›å‘½ä»¤åœ¨é’ˆå¯¹å¤§é‡ keyæˆ–å…ƒç´ è°ƒç”¨æ—¶å¯èƒ½ä¼šé•¿æ—¶é—´ï¼ˆç”šè‡³å‡ ç§’é’Ÿï¼‰é˜»å¡æœåŠ¡å™¨</p><p>ç„¶è€Œï¼Œå°½ç®¡åƒ <code>SMEMBERS</code>è¿™æ ·çš„é˜»å¡å‘½ä»¤èƒ½å¤Ÿåœ¨ç»™å®šçš„æ—¶åˆ»æä¾›é›†åˆçš„æ‰€æœ‰å…ƒç´ ï¼Œä½† <code>SCAN</code>å‘½ä»¤æ—ä»…å¯¹è¿”å›çš„å…ƒç´ æä¾›æœ‰é™çš„ä¿è¯ï¼Œå› ä¸ºæˆ‘ä»¬å¢é‡è¿­ä»£çš„é›†åˆå¯èƒ½åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å‘ç”Ÿå˜åŒ–ï¼ˆäº‹å®ä¸Šç°åœ¨<code>SCAN</code>ä½¿ç”¨çš„æ–¹å¼å¯ä»¥é¿å…æ¼æ‰å…ƒç´ ï¼Œä½†ä¸èƒ½ä¿è¯ä¸é‡å¤å…ƒç´ ï¼Œä¸è¿‡è¿™ç§ç®—æ³•åªæœ‰å®è·µéªŒè¯ï¼Œå¹¶æœªå¾—åˆ°æ•°å­¦å±‚é¢çš„éªŒè¯ï¼‰</p><p>å…·ä½“å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ä¸­ <strong>Scan guarantees</strong> å†…å®¹</p><h2 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">set</span> 1 1</span><br><span class="line">&gt; <span class="built_in">set</span> 2 2</span><br><span class="line">&gt; <span class="built_in">set</span> 3 3</span><br><span class="line">&gt; <span class="built_in">set</span> 4 4</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; SCAN 0</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;2&quot;</span></span><br><span class="line">   2) <span class="string">&quot;3&quot;</span></span><br><span class="line">   3) <span class="string">&quot;4&quot;</span></span><br><span class="line">   4) <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure><p>è¿”å›çš„ cursor æ˜¯ <code>0</code>ï¼Œè¯´æ˜å·²ç»è¿”å›äº†æ‰€æœ‰çš„å…ƒç´ </p><p>è¿”å›çš„ keys åˆ—è¡¨ä¸º<code>2</code>ã€<code>3</code>ã€<code>4</code>ã€<code>1</code></p><p>å¯ä»¥çœ‹åˆ°è¿”å›é¡ºåºå¹¶éæ·»åŠ é¡ºåºï¼Œå› ä¸º Redis keysçš„åº•å±‚ä¹Ÿä½¿ç”¨çš„å“ˆå¸Œç»“æ„ï¼Œéæœ‰åº</p><p>è®¾ç½® <code>MATCH</code> å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; SCAN 0 MATCH 1</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure><p>åªä¼šè¿”å›åŒ¹é…çš„ key</p><p>è®¾ç½® <code>COUNT</code> å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; SCAN 0 COUNT 2</span><br><span class="line">1) <span class="string">&quot;3&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;2&quot;</span></span><br><span class="line">   2) <span class="string">&quot;3&quot;</span></span><br><span class="line"> </span><br><span class="line">&gt; SCAN 3 COUNT 2</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;4&quot;</span></span><br><span class="line">   2) <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¿”å›äº† 2 ä¸ª keyï¼Œå¹¶ä¸”è¿”å›äº†ä¸‹ä¸€ä¸ª cursor ä¸º <code>3</code></p><p>ç¬¬äºŒæ¬¡ cursor è¿”å› <code>0</code>ï¼Œè¡¨ç¤ºè¿­ä»£å®Œäº†æ‰€æœ‰çš„å…ƒç´ </p><h2 id="ä¸ºä»€ä¹ˆ-scan-å¯èƒ½ä¼šåœ¨å•ä¸ªè°ƒç”¨ä¸­è¿”å›æ‰€æœ‰å…ƒç´ ">ä¸ºä»€ä¹ˆ SCANå¯èƒ½ä¼šåœ¨å•ä¸ªè°ƒç”¨ä¸­è¿”å›æ‰€æœ‰å…ƒç´ ï¼Ÿ</h2><p>åœ¨ <code>COUNT</code>å‚æ•°çš„æ–‡æ¡£è¯´æ˜ä¸­æåˆ°ï¼Œæœ‰æ—¶è¿™ç±»å‘½ä»¤å¯èƒ½ä¼šåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­åŒæ—¶è¿”å› Setã€Hashæˆ– Sorted Set çš„æ‰€æœ‰å…ƒç´ ï¼Œè€Œä¸ <code>COUNT</code> çš„å€¼æ— å…³</p><p>ä¹‹æ‰€ä»¥ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œæ˜¯å› ä¸ºåªæœ‰å½“æˆ‘ä»¬æ­£åœ¨æ‰«æçš„èšåˆæ•°æ®ç±»å‹è¡¨ç¤ºä¸ºå“ˆå¸Œè¡¨ï¼ˆHashTableï¼‰æ—¶ï¼Œæ‰å¯ä»¥å®ç°åŸºäºå…‰æ ‡çš„è¿­ä»£å™¨ï¼ˆcursor-based iteratorï¼‰ï¼Œä½†æ˜¯Redisä½¿ç”¨äº†å†…å­˜ä¼˜åŒ–ï¼Œå—ä¼˜åŒ–çš„å½±å“ï¼Œå°çš„èšåˆæ•°æ®ç±»å‹ä½¿ç”¨ç´§å‡‘çš„å•åˆ†é…å‹ç¼©ç¼–ç æ¥è¡¨ç¤ºï¼Œç›´åˆ°å®ƒä»¬è¾¾åˆ°ç»™å®šçš„é¡¹ç›®æ•°é‡æˆ–å•ä¸ªå…ƒç´ çš„ç»™å®šæœ€å¤§å¤§å°</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>SCAN</code>æ²¡æœ‰å¯è¿”å›çš„æœ‰æ„ä¹‰çš„æ¸¸æ ‡ï¼Œå¹¶ä¸”å¿…é¡»ä¸€æ¬¡è¿­ä»£æ•´ä¸ªæ•°æ®ç»“æ„ï¼Œå› æ­¤å®ƒå”¯ä¸€åˆç†çš„è¡Œä¸ºå°±æ˜¯åœ¨è°ƒç”¨ä¸­è¿”å›æ‰€æœ‰å†…å®¹</p><p>è¿˜è¦æ³¨æ„ï¼Œè¿™ç§è¡Œä¸ºæ˜¯ <code>SSCAN</code>ã€<code>HSCAN</code> å’Œ<code>ZSCAN</code> ç‰¹æœ‰çš„ï¼›<code>SCAN</code> æœ¬èº«ä»ä¸æ˜¾ç¤ºè¿™ç§è¡Œä¸ºï¼Œå› ä¸ºkeys çš„å­˜å‚¨æ€»æ˜¯ç”±å“ˆå¸Œè¡¨å®ç°</p><p>æ¦‚æ‹¬ä¸€ä¸‹ï¼Œå³å½“èšåˆç±»å‹çš„ keyä½¿ç”¨éå“ˆå¸Œç»“æ„æ—¶ï¼ˆå‹ç¼©åˆ—è¡¨ç­‰æ•°æ®ç»“æ„ï¼‰ï¼Œæ¸¸æ ‡çš„æ¦‚å¿µæ— æ„ä¹‰</p><p>å°è¯•ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; HSET test_scan 1 1</span><br><span class="line">&gt; HSET test_scan 2 2</span><br><span class="line">&gt; HSET test_scan 3 3</span><br></pre></td></tr></table></figure><p>åˆ›å»ºäº†ä¸€ä¸ª Hash keyï¼ŒæŒ‰ç…§é»˜è®¤é…ç½®ï¼Œå½“å‰çš„ key ä½¿ç”¨çš„æ˜¯å‹ç¼©åˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; HSCAN test_scan 0 COUNT 1</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;1&quot;</span></span><br><span class="line">   2) <span class="string">&quot;1&quot;</span></span><br><span class="line">   3) <span class="string">&quot;2&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line">   5) <span class="string">&quot;3&quot;</span></span><br><span class="line">   6) <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å“ªæ€•å‘½ä»¤ä¸­æ˜ç¡®è®¾ç½®äº† <code>COUNT</code> å‚æ•°ä¸º<code>1</code>ï¼Œè¿˜æ˜¯è¿”å›äº†æ•´ä¸ª key æ‰€æœ‰çš„å…ƒç´ </p><h1 id="å®ç°åŸç†">å®ç°åŸç†</h1><h2 id="cursor-éé€’å¢">cursor éé€’å¢</h2><p>cursor æ˜¯å“ˆå¸Œæ§½çš„åæ ‡ï¼ˆç»è¿‡è¿ç®—ï¼‰ï¼Œæ‰€ä»¥ä¸æ–­å¢åŠ  cursorä¸€ç›´è°ƒç”¨ï¼Œæœ€ç»ˆå°±å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰çš„å…ƒç´ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">set</span> 1 1</span><br><span class="line">&gt; <span class="built_in">set</span> 2 2</span><br><span class="line">&gt; <span class="built_in">set</span> 3 3</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; SCAN 0 COUNT 1</span><br><span class="line">1) <span class="string">&quot;2&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;1&quot;</span></span><br><span class="line">   </span><br><span class="line">&gt; SCAN 2 COUNT 1</span><br><span class="line">1) <span class="string">&quot;1&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line">&gt; SCAN 1 COUNT 1</span><br><span class="line">1) <span class="string">&quot;3&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line">&gt; SCAN 3 COUNT 1</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) (empty list or <span class="built_in">set</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° cursor çš„é¡ºåº 0 -&gt; 2 -&gt; 1 -&gt;3ï¼Œå¹¶éæ˜¯é¡ºåºé€’å¢ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ªå®éªŒç»“æœå’Œ Redis å½“å‰å­˜å‚¨ key çš„å“ˆå¸Œè¡¨ sizeæœ‰å…³ï¼Œå¦‚æœå“ˆå¸Œè¡¨å·²ç»æ‰©å®¹è¿‡ï¼Œå¯èƒ½æ— æ³•å’Œå½“å‰ç»“æœä¸€è‡´ï¼Œå¯ä»¥åˆ‡æ¢åˆ°æ–°çš„ DBä¸Šè¿›è¡Œå®éªŒï¼‰</p><h2 id="é«˜ä½-1">é«˜ä½ + 1</h2><p>å°†ä¸Šé¢ cursor å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶</p><p><code>00 -&gt; 10 -&gt; 01 -&gt; 11</code></p><p>å¯ä»¥è§‚å¯Ÿå‡ºè¿™ä¸ªåºåˆ—æ˜¯é€æ­¥é«˜ä½åŠ  1 çš„ï¼Œè¿› 1 åˆ™è¿›åˆ°ä½ä½</p><h2 id="é€†äºŒè¿›åˆ¶è¿­ä»£">é€†äºŒè¿›åˆ¶è¿­ä»£</h2><p>å³ <code>Scan</code> å‘½ä»¤ä½¿ç”¨çš„æ˜¯ <strong>reverse binaryiteration</strong> ç®—æ³•</p><p>å®ç°ç»†èŠ‚ç›¸å…³ issue <ahref="https://github.com/redis/redis/pull/579">Add SCAN command bypietern Â· Pull Request #579 Â· redis/redis (github.com)</a></p><p>ç®€å•æ¥è¯´å°±æ˜¯å°†ä½ä½å‘é«˜ä½çš„è¿ç®—å˜ä¸ºé«˜ä½å‘ä½ä½ï¼Œåˆ™åŒæ ·çš„å½“äºŒè¿›åˆ¶ä¸º<code>11...111</code> æ—¶ï¼Œè¿›ä¸€åˆ™å˜ä¸º <code>0</code></p><p>æœ€ç»ˆé€šè¿‡è¿­ä»£æ‰«ææ•´ä¸ªå­—å…¸</p><p><strong>Redis å®ç°ç›¸å…³ä»£ç </strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†æ¸¸æ ‡ v çš„ unmasked æ¯”ç‰¹éƒ½ç½®ä¸º 1</span></span><br><span class="line">v |= ~m0;</span><br><span class="line"><span class="comment">// åè½¬ v</span></span><br><span class="line">v = rev(v);</span><br><span class="line"><span class="comment">// å…³é”®ï¼Œå¯¹ä¸€ä¸ªæ•°åŠ  1ï¼Œå…¶å®å°±æ˜¯å°†è¿™ä¸ªæ•°çš„ä½ä½çš„è¿ç»­ 1 å˜ä¸º 0ï¼Œç„¶åå°†æœ€ä½çš„ä¸€ä¸ª 0 å˜ä¸º 1ï¼Œå…¶å®å°±æ˜¯å°†æœ€ä½çš„ä¸€ä¸ª 0 å˜ä¸º 1</span></span><br><span class="line">v++;</span><br><span class="line"><span class="comment">// å†æ¬¡åè½¬ï¼Œå³å¾—åˆ°ä¸‹ä¸€ä¸ªæ¸¸æ ‡å€¼</span></span><br><span class="line">v = rev(v);</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ Java å®ç°äº†ä¸€ä¸‹ï¼Œæ–¹ä¾¿è§‚å¯Ÿä½è¿ç®—çš„æ“ä½œ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReverseBinaryIteration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIZE_BIT_COUNT</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">end</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (!end) &#123;</span><br><span class="line">            next = getReverseBinaryIterationNext(next);</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="number">0</span>) &#123;</span><br><span class="line">                end = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getReverseBinaryIterationNext</span><span class="params">(<span class="type">int</span> current)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.of(current)</span><br><span class="line">                <span class="comment">// å°†æ¸¸æ ‡çš„ unmasked æ¯”ç‰¹éƒ½ç½®ä¸º 1</span></span><br><span class="line">                .map(i -&gt; &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> setUnmasked(i);</span><br><span class="line">                    System.out.println(<span class="string">&quot;setUnmasked : &quot;</span> + Integer.toBinaryString(res));</span><br><span class="line">                    <span class="keyword">return</span> res;</span><br><span class="line">                &#125;)</span><br><span class="line">                .map(i -&gt; &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> reverseBits(i);</span><br><span class="line">                    System.out.println(<span class="string">&quot;reverseBits : &quot;</span> + Integer.toBinaryString(res));</span><br><span class="line">                    <span class="keyword">return</span> res;</span><br><span class="line">                &#125;)</span><br><span class="line">                .map(i -&gt; &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> ++i;</span><br><span class="line">                    System.out.println(<span class="string">&quot;ä½ä½åŠ  1 : &quot;</span> + Integer.toBinaryString(res));</span><br><span class="line">                    <span class="keyword">return</span> res;</span><br><span class="line">                &#125;)</span><br><span class="line">                .map(i -&gt; &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> reverseBits(i);</span><br><span class="line">                    System.out.println(<span class="string">&quot;reverseBits : &quot;</span> + Integer.toBinaryString(res));</span><br><span class="line">                    <span class="keyword">return</span> res;</span><br><span class="line">                &#125;)</span><br><span class="line">                .map(i -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;æœ€ç»ˆç»“æœ : &quot;</span> + Integer.toBinaryString(i));</span><br><span class="line">                    System.out.println(<span class="string">&quot;---------------------------------------&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> i;</span><br><span class="line">                &#125;)</span><br><span class="line">                .get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éæœ‰æ•ˆä½è®¾ç½®ä¸º 1</span></span><br><span class="line"><span class="comment">     * SIZE_BIT_COUNT ä¸ºæ¨¡æ‹Ÿæœ‰æ•ˆä½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">setUnmasked</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="comment">// å…¨æ˜¯ 1</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mask</span> <span class="operator">=</span> <span class="number">0xffffffff</span>;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæœ‰æ•ˆä½æ•°çš„ä¿ç•™ç </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">retain_mask</span> <span class="operator">=</span> ((<span class="number">1</span> &lt;&lt; SIZE_BIT_COUNT) - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// ä¿ç•™æœ‰æ•ˆä½æ•°</span></span><br><span class="line">        mask &amp;= ~retain_mask;</span><br><span class="line">        <span class="comment">// æˆ–å‡ºç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> num | mask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åè½¬æ¯”ç‰¹ä½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">reverseBits</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">32</span> &amp;&amp; num != <span class="number">0</span>; ++i) &#123;</span><br><span class="line">            res |= (num &amp; <span class="number">1</span>) &lt;&lt; (<span class="number">31</span> - i);</span><br><span class="line">            num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­æ¨¡æ‹Ÿ masked ä½æ•°ä¸º 2ï¼Œå³ 4 ä¸ªå“ˆå¸Œæ§½ï¼Œç»“æœå¦‚ä¸‹</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">setUnmasked : 11111111111111111111111111111100</span><br><span class="line">reverseBits : 111111111111111111111111111111</span><br><span class="line">ä½ä½åŠ  1 : 1000000000000000000000000000000</span><br><span class="line">reverseBits : 10</span><br><span class="line"><span class="section">æœ€ç»ˆç»“æœ : 10</span></span><br><span class="line"><span class="section">---------------------------------------</span></span><br><span class="line">setUnmasked : 11111111111111111111111111111110</span><br><span class="line">reverseBits : 1111111111111111111111111111111</span><br><span class="line">ä½ä½åŠ  1 : 10000000000000000000000000000000</span><br><span class="line">reverseBits : 1</span><br><span class="line"><span class="section">æœ€ç»ˆç»“æœ : 1</span></span><br><span class="line"><span class="section">---------------------------------------</span></span><br><span class="line">setUnmasked : 11111111111111111111111111111101</span><br><span class="line">reverseBits : 10111111111111111111111111111111</span><br><span class="line">ä½ä½åŠ  1 : 11000000000000000000000000000000</span><br><span class="line">reverseBits : 11</span><br><span class="line"><span class="section">æœ€ç»ˆç»“æœ : 11</span></span><br><span class="line"><span class="section">---------------------------------------</span></span><br><span class="line">setUnmasked : 11111111111111111111111111111111</span><br><span class="line">reverseBits : 11111111111111111111111111111111</span><br><span class="line">ä½ä½åŠ  1 : 0</span><br><span class="line">reverseBits : 0</span><br><span class="line"><span class="section">æœ€ç»ˆç»“æœ : 0</span></span><br><span class="line"><span class="section">---------------------------------------</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆå®ç°äº†é«˜ä½åŠ  1 çš„è¿ç®—ï¼Œ0 -&gt; 2 -&gt; 1 -&gt; 3 -&gt;0</p><h2 id="æ¨¡æ‹Ÿ">æ¨¡æ‹Ÿ</h2><p>åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒRedisçš„å“ˆå¸Œè¡¨ä¼šæœ‰å“ªäº›æ“ä½œï¼Œè¿™äº›æ“ä½œæ˜¯å¦ä¼šå¯¼è‡´æ•°æ®é”™è¯¯</p><h3 id="å“ˆå¸Œè¡¨ä¸å˜">å“ˆå¸Œè¡¨ä¸å˜</h3><p>åœ¨å“ˆå¸Œè¡¨ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæ¸¸æ ‡ä½¿ç”¨é€†äºŒè¿›åˆ¶è¿­ä»£æœ€ç»ˆä¼šæ‰«ææ‰€æœ‰æ§½ä½</p><h3 id="æ‰©å®¹å®Œæˆ">æ‰©å®¹å®Œæˆ</h3><p>å‡è®¾åœ¨ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œå“ˆå¸Œè¡¨çš„æ§½ä½æ˜¯ 4ï¼Œè¿™æ¬¡è°ƒç”¨æ—¶æ§½ä½ç»è¿‡ resizeæ‰©å¤§åˆ°äº† 8</p><p>åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œkey ä¼šè¢«é‡æ–°åˆ†é…æ§½ä½ï¼Œå…¶å“ˆå¸Œå€¼ä¸å˜ï¼Œæ§½ä½è®¡ç®—æ–¹å¼ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash(key)&amp;(size<span class="number">-1</span>)</span><br></pre></td></tr></table></figure><p>å‡è®¾ä¸€ä¸ª key å“ˆå¸Œä¸º <code>6</code>ï¼Œä¹‹å‰è®¡ç®—æ§½ä½ä¸º<code>2(10)</code>ï¼Œé‚£ä¹ˆæ‰©å®¹åå³ä¸º <code>6(101)</code>ï¼Œå³ 2 å’Œ 6ç§°ä¸ºåŒæ¨¡</p><p>å‡è®¾ä¸€ä¸ª key å“ˆå¸Œä¸º <code>7</code>ï¼Œä¹‹å‰è®¡ç®—æ§½ä½ä¸º<code>3(11)</code>ï¼Œé‚£ä¹ˆæ‰©å®¹åå³ä¸º <code>7(111)</code>ï¼Œå³ 3 å’Œ 7ç§°ä¸ºåŒæ¨¡</p><p>å¦‚ä½•ä¿è¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¸¸æ ‡ä¸ä¼šç•¥è¿‡ä¿®æ”¹åçš„æ§½ä½ï¼Ÿ</p><p>åªéœ€è¦ä¿è¯</p><ul><li>ä¸€ä¸ª key æ‰©å®¹åçš„æ§½ä½ä¸å˜æˆ–æ›´å¤§ï¼ˆå¿…ç„¶ï¼‰</li><li>å½“å‰æ¸¸æ ‡åœ¨å¯¹åº”æ›´å¤§çš„ maskedä½æ•°æ—¶ï¼Œåªä¼šæ¯”ä¸‹ä¸€ä¸ªæ¸¸æ ‡æ›´å°ï¼ˆæ³¨æ„é€†è¿­ä»£ï¼‰</li></ul><p>å‡è®¾å½“å‰æ¸¸æ ‡åˆ°äº†æ§½ä½ 2ï¼ˆå³ 10ï¼‰</p><p>å¯ä»¥å‘ç°åé¢çš„ 4ã€5ã€6ã€7 æ§½ä½æŒ‰ç…§é€†äºŒè¿›åˆ¶è¿­ä»£çš„è§„åˆ™ï¼Œéƒ½è¦å¤§äºæ§½ä½2ï¼Œä¹Ÿå°±æ˜¯åœ¨åç»­éå†è¿‡ç¨‹ä¸­ä¸ä¼šé—æ¼æ•°æ®</p><h3 id="æ‰©å®¹ä¸­">æ‰©å®¹ä¸­</h3><p>Redis ä½¿ç”¨æ¸è¿›å¼ Hashï¼Œæ—§çš„å“ˆå¸Œè¡¨ä¾ç„¶æ˜¯ 4 æ§½ä½ï¼Œæ–°çš„å“ˆå¸Œè¡¨æ˜¯ 8æ§½ä½</p><p>é‚£ä¹ˆæ ¹æ®æ‰©å®¹å®Œæˆçš„æƒ…å†µ</p><p>å‡è®¾æ‰«ææ§½ä½ 2 æ—¶ï¼Œéœ€è¦åŒæ—¶æ‰«ææ—§è¡¨ä¸­çš„ 2 æ§½ä½å’Œæ–°è¡¨ä¸­çš„ 2 å’Œ 6æ§½ä½æ¥é¿å…æ•°æ®é—æ¼</p><h3 id="ç¼©å®¹">ç¼©å®¹</h3><p>Redis ä¸­çš„å“ˆå¸Œç»“æ„è¿˜ä¼šè‡ªåŠ¨è¿›è¡Œç¼©å®¹ï¼ˆè´Ÿè½½å› å­å°äº 0.1ï¼‰</p><p>ï¼ˆè¿™é‡Œæ²¡çœ‹æ‡‚ï¼Œä½†æ˜¯çœ‹ issue ä¸Šçš„è®¨è®ºï¼Œæ˜¯å¯ä»¥é¿å…ç¼©å®¹é—®é¢˜çš„ï¼‰</p><p>çœ‹äº†å‚è€ƒçš„åšå®¢ï¼Œçœ‹èµ·æ¥æ˜¯åœ¨ä»£ç å±‚é¢è¿›è¡Œäº†é‡å¤çš„æ‰«ææ¥è¿›è¡Œé¿å…</p><h1 id="å¡é©¬å…‹å¿«é€Ÿé€†å¹³æ–¹æ ¹">å¡é©¬å…‹å¿«é€Ÿé€†å¹³æ–¹æ ¹</h1><p>è¿™ä¸ªé€†äºŒè¿›åˆ¶è¿­ä»£ç®—æ³•å°±å’Œå¡é©¬å…‹å¿«é€Ÿé€†å¹³æ–¹æ ¹ä¸€æ ·</p><blockquote><p>æ±‚é€†å¹³æ–¹æ ¹çš„ç®—æ³•æ¥è‡ªã€Šé›·ç¥ä¹‹é”¤3ã€‹çš„ä½œè€…å¡é©¬å…‹ï¼Œè¯¥ç®—æ³•å¹¶ä¸å¤æ‚ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯ç”¨ç‰›é¡¿è¿­ä»£æ³•æ¥ä¸æ–­é€¼è¿‘ï¼Œä½†å¡é©¬å…‹çœŸæ­£å‰å®³çš„åœ°æ–¹ï¼Œåœ¨äºä»–é€‰æ‹©äº†ä¸€ä¸ªååˆ†ç¥ç§˜çš„å¸¸æ•°ï¼š0x5f3759dfæ¥è®¡ç®—çŒœæµ‹å€¼ï¼Œç¬¬ä¸€æ¬¡ç‰›é¡¿è¿­ä»£ç®—å‡ºçš„å€¼å·²ç»éå¸¸æ¥è¿‘ï¼Œè¿™æ ·ä»…éœ€ä¸¤æ¬¡ç‰›é¡¿è¿­ä»£å°±å¯è¾¾åˆ°æ‰€éœ€ç²¾åº¦</p><p>æ™®æ¸¡å¤§å­¦çš„æ•°å­¦å®¶ Chris Lomontçœ‹äº†ä»¥åè§‰å¾—æœ‰è¶£ï¼Œå†³å®šè¦ç ”ç©¶å¡é©¬å…‹å¼„å‡ºæ¥çš„è¿™ä¸ªçŒœæµ‹å€¼æœ‰ä»€ä¹ˆå¥¥ç§˜</p><p>Lomontåœ¨ç²¾å¿ƒç ”ç©¶ä¹‹åä»ç†è®ºä¸Šä¹Ÿæ¨å¯¼å‡ºä¸€ä¸ªæœ€ä½³çŒœæµ‹å€¼ï¼š0x5f37642fï¼Œå’Œå¡é©¬å…‹çš„æ•°å­—éå¸¸æ¥è¿‘</p><p>ä¼ å¥‡å¹¶æ²¡æœ‰åœ¨è¿™é‡Œç»“æŸ</p><p>Lomontè®¡ç®—å‡ºç»“æœä»¥åéå¸¸æ»¡æ„ï¼Œäºæ˜¯æ‹¿è‡ªå·±è®¡ç®—å‡ºçš„èµ·å§‹å€¼å’Œå¡é©¬å…‹çš„ç¥ç§˜æ•°å­—åšæ¯”è¾ƒï¼Œçœ‹å“ªä¸ªæ•°å­—èƒ½å¤Ÿæ›´å¿«æ›´ç²¾ç¡®çš„æ±‚å¾—é€†å¹³æ–¹æ ¹ï¼Œç»“æœæ˜¯å¡é©¬å…‹èµ¢äº†...è°ä¹Ÿä¸çŸ¥é“å¡é©¬å…‹æ˜¯æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªæ•°å­—çš„</p><p>æœ€å Lomonté‡‡ç”¨æš´åŠ›æ–¹æ³•ä¸€ä¸ªæ•°å­—ä¸€ä¸ªæ•°å­—è¯•è¿‡æ¥ï¼Œç»ˆäºæ‰¾åˆ°ä¸€ä¸ªæ¯”å¡é©¬å…‹æ•°å­—è¦å¥½ä¸Šé‚£ä¹ˆä¸€ä¸ç‚¹çš„æ•°å­—ï¼Œè™½ç„¶å®é™…ä¸Šè¿™ä¸¤ä¸ªæ•°å­—æ‰€äº§ç”Ÿçš„ç»“æœéå¸¸è¿‘ä¼¼ï¼Œè¿™ä¸ªæš´åŠ›å¾—å‡ºçš„æ•°å­—æ˜¯ï¼š0x5f375a86</p><p>Lomont ä¸ºæ­¤å†™ä¸‹ä¸€ç¯‡è®ºæ–‡ï¼Œ<em>Fast Inverse Square Root</em></p></blockquote><p>ä½œè€…å¹¶æ²¡æœ‰æ•°å­¦ä¸ŠéªŒè¯å…¶å‡†ç¡®æ€§ï¼Œåªæ˜¯é€šè¿‡ä¸€äº›æµ‹è¯•ç”¨ä¾‹æµ‹è¯•æ²¡æœ‰é—®é¢˜</p><blockquote><p>Those guarantees are correct. Although I don't have a formal prooffor these guarantees, I'm reasonably confident they hold. I workedthrough every hash table state (stable, grow, shrink) and it appears towork everywhere by means of the reverse binary iteration (for lack of abetter word).</p></blockquote><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://redis.io/commands/scan/">SCAN | Redis</a></p><p><a href="https://www.lixueduan.com/posts/redis/redis-scan/">RedisScan åŸç†è§£æä¸è¸©å‘ - (lixueduan.com)</a></p><p><a href="https://github.com/redis/redis/pull/579">Add SCAN command bypietern Â· Pull Request #579 Â· redis/redis (github.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> Redis </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Python å¹¶å‘ä¸å¼‚æ­¥</title>
      <link href="/%E5%BC%80%E5%8F%91/Python/Python%20%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%BC%82%E6%AD%A5.html"/>
      <url>/%E5%BC%80%E5%8F%91/Python/Python%20%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%BC%82%E6%AD%A5.html</url>
      
        <content type="html"><![CDATA[<h1 id="å¤šè¿›ç¨‹">å¤šè¿›ç¨‹</h1><h2 id="fork">fork</h2><p>Unix/Linux æ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ä¸ª <code>fork</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒéå¸¸ç‰¹æ®Šï¼Œå› ä¸ºæ™®é€šçš„å‡½æ•°è°ƒç”¨ï¼Œè°ƒç”¨ä¸€æ¬¡å°±è¿”å›ä¸€æ¬¡ï¼Œä½†æ˜¯<code>fork</code> è°ƒç”¨ä¸€æ¬¡ï¼Œè¿”å›ä¸¤æ¬¡</p><p>å› ä¸ºæ“ä½œç³»ç»Ÿè‡ªåŠ¨æŠŠå½“å‰è¿›ç¨‹ï¼ˆç§°ä¸ºçˆ¶è¿›ç¨‹ï¼‰å¤åˆ¶äº†ä¸€ä»½ï¼ˆç§°ä¸ºå­è¿›ç¨‹ï¼‰ï¼Œç„¶ååˆ†åˆ«åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å†…è¿”å›ï¼Œå­è¿›ç¨‹æ°¸è¿œè¿”å›<code>0</code>ï¼Œè€Œçˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„ ID</p><p>è¿™æ ·åšçš„ç†ç”±æ˜¯ï¼Œä¸€ä¸ªçˆ¶è¿›ç¨‹å¯ä»¥ forkå‡ºå¾ˆå¤šå­è¿›ç¨‹ï¼Œæ‰€ä»¥ï¼Œçˆ¶è¿›ç¨‹è¦è®°ä¸‹æ¯ä¸ªå­è¿›ç¨‹çš„ IDï¼Œè€Œå­è¿›ç¨‹åªéœ€è¦è°ƒç”¨<code>getppid</code> å°±å¯ä»¥æ‹¿åˆ°çˆ¶è¿›ç¨‹çš„ ID</p><p>Python çš„ <code>os</code> æ¨¡å—å°è£…äº†å¸¸è§çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä¸­å°±åŒ…æ‹¬<code>fork</code>ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ Python ç¨‹åºä¸­è½»æ¾åˆ›å»ºå­è¿›ç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Process (%s) start...&#x27;</span> % os.getpid()) </span><br><span class="line"><span class="comment"># Only works on Unix/Linux/Mac: </span></span><br><span class="line">pid = os.fork() </span><br><span class="line"><span class="keyword">if</span> pid == <span class="number">0</span>: </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;I am child process (%s) and my parent is %s.&#x27;</span> % (os.getpid(), os.getppid())) </span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;I (%s) just created a child process (%s).&#x27;</span> % (os.getpid(), pid))</span><br></pre></td></tr></table></figure><p>ç”±äº Windows æ²¡æœ‰ <code>fork</code> è°ƒç”¨ï¼Œä¸Šé¢çš„ä»£ç åœ¨ Windowsä¸Šæ— æ³•è¿è¡Œï¼›è€Œ Mac ç³»ç»Ÿæ˜¯åŸºäº BSDï¼ˆUnixçš„ä¸€ç§ï¼‰å†…æ ¸ï¼Œæ‰€ä»¥ï¼Œåœ¨ Macä¸‹è¿è¡Œæ˜¯æ²¡æœ‰é—®é¢˜çš„</p><h2 id="multiprocessing">multiprocessing</h2><p>ç”±äº Pythonæ˜¯è·¨å¹³å°çš„ï¼Œè‡ªç„¶ä¹Ÿåº”è¯¥æä¾›ä¸€ä¸ªè·¨å¹³å°çš„å¤šè¿›ç¨‹æ”¯æŒï¼›<code>multiprocessing</code>æ¨¡å—å°±æ˜¯è·¨å¹³å°ç‰ˆæœ¬çš„å¤šè¿›ç¨‹æ¨¡å—</p><p><code>multiprocessing</code> æ¨¡å—æä¾›äº†ä¸€ä¸ª Processç±»æ¥ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­è¿›ç¨‹è¦æ‰§è¡Œçš„ä»£ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_proc</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Run child process %s (%s)...&#x27;</span> % (name, os.getpid()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Parent process %s.&#x27;</span> % os.getpid())</span><br><span class="line">    p = Process(target=run_proc, args=(<span class="string">&#x27;test&#x27;</span>,))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Child process will start.&#x27;</span>)</span><br><span class="line">    p.start()</span><br><span class="line">    p.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Child process end.&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Parent <span class="built_in">process</span> <span class="number">588.</span></span><br><span class="line">Child <span class="built_in">process</span> will <span class="built_in">start</span>.</span><br><span class="line">Run child <span class="built_in">process</span> test (<span class="number">19096</span>)...</span><br><span class="line">Child <span class="built_in">process</span> <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œåªéœ€è¦ä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå‡½æ•°å’Œå‡½æ•°çš„å‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ª<code>Process</code> å®ä¾‹ï¼Œç”¨ <code>start</code>æ–¹æ³•å¯åŠ¨ï¼Œè¿™æ ·åˆ›å»ºè¿›ç¨‹æ¯” <code>fork</code> è¿˜è¦ç®€å•</p><p><code>join</code>æ–¹æ³•å¯ä»¥ç­‰å¾…å­è¿›ç¨‹ç»“æŸåå†ç»§ç»­å¾€ä¸‹è¿è¡Œï¼Œé€šå¸¸ç”¨äºè¿›ç¨‹é—´çš„åŒæ­¥</p><h2 id="pool">Pool</h2><p>å¦‚æœè¦å¯åŠ¨å¤§é‡çš„å­è¿›ç¨‹ï¼Œå¯ä»¥ç”¨è¿›ç¨‹æ± çš„æ–¹å¼æ‰¹é‡åˆ›å»ºå­è¿›ç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> os, time, random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">long_time_task</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Run task %s (%s)...&#x27;</span> % (name, os.getpid()))</span><br><span class="line">    start = time.time()</span><br><span class="line">    time.sleep(random.random() * <span class="number">3</span>)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task %s runs %0.2f seconds.&#x27;</span> % (name, (end - start)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Parent process %s.&#x27;</span> % os.getpid())</span><br><span class="line">    p = Pool()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        p.apply_async(long_time_task, args=(i,))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Waiting for all subprocesses done...&#x27;</span>)</span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;All subprocesses done.&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Parent</span> process <span class="number">37332</span>.</span><br><span class="line"><span class="attribute">Waiting</span> for <span class="literal">all</span> subprocesses done...</span><br><span class="line"><span class="attribute">Run</span> task <span class="number">0</span> (<span class="number">21488</span>)...</span><br><span class="line"><span class="attribute">Run</span> task <span class="number">1</span> (<span class="number">35776</span>)...</span><br><span class="line"><span class="attribute">Run</span> task <span class="number">2</span> (<span class="number">19912</span>)...</span><br><span class="line"><span class="attribute">Run</span> task <span class="number">3</span> (<span class="number">18472</span>)...</span><br><span class="line"><span class="attribute">Task</span> <span class="number">0</span> runs <span class="number">0</span>.<span class="number">37</span> seconds.</span><br><span class="line"><span class="attribute">Run</span> task <span class="number">4</span> (<span class="number">21488</span>)...</span><br><span class="line"><span class="attribute">Task</span> <span class="number">2</span> runs <span class="number">0</span>.<span class="number">94</span> seconds.</span><br><span class="line"><span class="attribute">Task</span> <span class="number">1</span> runs <span class="number">1</span>.<span class="number">30</span> seconds.</span><br><span class="line"><span class="attribute">Task</span> <span class="number">4</span> runs <span class="number">0</span>.<span class="number">95</span> seconds.</span><br><span class="line"><span class="attribute">Task</span> <span class="number">3</span> runs <span class="number">2</span>.<span class="number">75</span> seconds.</span><br><span class="line"><span class="attribute">All</span> subprocesses done.</span><br></pre></td></tr></table></figure><p>å¯¹ <code>Pool</code> å¯¹è±¡è°ƒç”¨ <code>join</code>æ–¹æ³•ä¼šç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œè°ƒç”¨ <code>join</code> ä¹‹å‰å¿…é¡»å…ˆè°ƒç”¨<code>close</code>ï¼Œè°ƒç”¨ <code>close</code> ä¹‹åå°±ä¸èƒ½ç»§ç»­æ·»åŠ æ–°çš„<code>Process</code> äº†</p><p><code>Pool</code> é»˜è®¤è¿›ç¨‹æ•°æ˜¯ CPU æ ¸æ•°ï¼Œä¹Ÿå¯ä»¥å…¥å‚<code>processes</code> è¿›è¡Œè®¾ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> processes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    processes = os.cpu_count() <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> processes &lt; <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">&quot;Number of processes must be at least 1&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> maxtasksperchild <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(maxtasksperchild, <span class="built_in">int</span>) <span class="keyword">or</span> maxtasksperchild &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;maxtasksperchild must be a positive int or None&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="æ§åˆ¶å­è¿›ç¨‹">æ§åˆ¶å­è¿›ç¨‹</h2><p>åˆ›å»ºäº†å­è¿›ç¨‹åï¼Œæœ‰æ—¶è¿˜éœ€è¦æ§åˆ¶å­è¿›ç¨‹çš„è¾“å…¥å’Œè¾“å‡º</p><p><code>subprocess</code>æ¨¡å—å¯ä»¥è®©æˆ‘ä»¬éå¸¸æ–¹ä¾¿åœ°å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åæ§åˆ¶å…¶è¾“å…¥å’Œè¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;$ nslookup www.python.org&#x27;</span>)</span><br><span class="line">r = subprocess.call([<span class="string">&#x27;nslookup&#x27;</span>, <span class="string">&#x27;www.python.org&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Exit code:&#x27;</span>, r)</span><br></pre></td></tr></table></figure><p><code>call</code> æ–¹æ³•ç”¨è¿è¡Œå¸¦æœ‰å‚æ•°çš„å‘½ä»¤</p><p>å¦‚æœå­è¿›ç¨‹è¿˜éœ€è¦è¾“å…¥ï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>communicate</code>æ–¹æ³•è¾“å…¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;$ nslookup&#x27;</span>)</span><br><span class="line">p = subprocess.Popen([<span class="string">&#x27;nslookup&#x27;</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">output, err = p.communicate(<span class="string">b&#x27;set q=mx\npython.org\nexit\n&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(output.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Exit code:&#x27;</span>, p.returncode)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ç›¸å½“äºåœ¨å‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤<code>nslookup</code>ï¼Œç„¶åæ‰‹åŠ¨è¾“å…¥å¦‚ä¸‹å‚æ•°å’Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> q=mx</span><br><span class="line">python.org</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h2 id="è¿›ç¨‹é—´é€šä¿¡">è¿›ç¨‹é—´é€šä¿¡</h2><p><code>Process</code>ä¹‹é—´æ˜¯éœ€è¦é€šä¿¡çš„ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†å¾ˆå¤šæœºåˆ¶æ¥å®ç°è¿›ç¨‹é—´çš„é€šä¿¡</p><p>Python çš„ <code>multiprocessing</code> æ¨¡å—åŒ…è£…äº†åº•å±‚çš„æœºåˆ¶ï¼Œæä¾›äº†<code>Queue</code>ã€<code>Pipes</code> ç­‰å¤šç§æ–¹å¼æ¥äº¤æ¢æ•°æ®</p><p>ä»¥ <code>Queue</code> ä¸ºä¾‹ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­åˆ›å»ºä¸¤ä¸ªå­è¿›ç¨‹ï¼Œä¸€ä¸ªå‘<code>Queue</code> é‡Œå†™æ•°æ®ï¼Œä¸€ä¸ªä» <code>Queue</code> é‡Œè¯»æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Queue</span><br><span class="line"><span class="keyword">import</span> os, time, random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™æ•°æ®è¿›ç¨‹æ‰§è¡Œçš„ä»£ç :</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">q</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Process to write: %s&#x27;</span> % os.getpid())</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Put %s to queue...&#x27;</span> % value)</span><br><span class="line">        q.put(value)</span><br><span class="line">        time.sleep(random.random())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»æ•°æ®è¿›ç¨‹æ‰§è¡Œçš„ä»£ç :</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">q</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Process to read: %s&#x27;</span> % os.getpid())</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        value = q.get(<span class="literal">True</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Get %s from queue.&#x27;</span> % value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># çˆ¶è¿›ç¨‹åˆ›å»ºQueueï¼Œå¹¶ä¼ ç»™å„ä¸ªå­è¿›ç¨‹ï¼š</span></span><br><span class="line">    q = Queue()</span><br><span class="line">    pw = Process(target=write, args=(q,))</span><br><span class="line">    pr = Process(target=read, args=(q,))</span><br><span class="line">    <span class="comment"># å¯åŠ¨å­è¿›ç¨‹pwï¼Œå†™å…¥:</span></span><br><span class="line">    pw.start()</span><br><span class="line">    <span class="comment"># å¯åŠ¨å­è¿›ç¨‹prï¼Œè¯»å–:</span></span><br><span class="line">    pr.start()</span><br><span class="line">    <span class="comment"># ç­‰å¾…pwç»“æŸ:</span></span><br><span class="line">    pw.join()</span><br></pre></td></tr></table></figure><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Process <span class="keyword">to</span> write: <span class="number">26020</span></span><br><span class="line">Put A <span class="keyword">to</span> <span class="keyword">queue</span>...</span><br><span class="line">Process <span class="keyword">to</span> read: <span class="number">916</span></span><br><span class="line">Get A <span class="keyword">from</span> <span class="keyword">queue</span>.</span><br><span class="line">Put B <span class="keyword">to</span> <span class="keyword">queue</span>...</span><br><span class="line">Get B <span class="keyword">from</span> <span class="keyword">queue</span>.</span><br><span class="line">Put C <span class="keyword">to</span> <span class="keyword">queue</span>...</span><br><span class="line">Get C <span class="keyword">from</span> <span class="keyword">queue</span>.</span><br><span class="line">Process Process-<span class="number">2</span>:</span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># è¿™é‡Œä¼šæŠ¥é”™ï¼Œå› ä¸º q.get(True, 1) è®¾ç½®äº†è¶…æ—¶æ—¶é—´</span></span><br></pre></td></tr></table></figure><h1 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</h1><p>å¤šä»»åŠ¡å¯ä»¥ç”±å¤šè¿›ç¨‹å®Œæˆï¼Œä¹Ÿå¯ä»¥ç”±ä¸€ä¸ªè¿›ç¨‹å†…çš„å¤šçº¿ç¨‹å®Œæˆ</p><p>ç”±äºçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿç›´æ¥æ”¯æŒçš„æ‰§è¡Œå•å…ƒï¼Œå› æ­¤é«˜çº§è¯­è¨€é€šå¸¸éƒ½å†…ç½®å¤šçº¿ç¨‹çš„æ”¯æŒï¼ŒPythonä¹Ÿä¸ä¾‹å¤–ï¼Œå¹¶ä¸” Python çš„çº¿ç¨‹æ˜¯çœŸæ­£çš„ PosixThreadï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„çº¿ç¨‹</p><p>Python çš„æ ‡å‡†åº“æä¾›äº†ä¸¤ä¸ªæ¨¡å—ï¼š<code>_thread</code>å’Œ<code>threading</code>ï¼Œ<code>_thread</code>æ˜¯ä½çº§æ¨¡å—ï¼Œ<code>threading</code> æ˜¯é«˜çº§æ¨¡å—ï¼Œå¯¹ <code>_thread</code>è¿›è¡Œäº†å°è£…</p><p>ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ <code>threading</code>è¿™ä¸ªé«˜çº§æ¨¡å—</p><h2 id="thread">Thread</h2><p>å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯æŠŠä¸€ä¸ªå‡½æ•°ä¼ å…¥å¹¶åˆ›å»º <code>Thread</code>å®ä¾‹ï¼Œç„¶åè°ƒç”¨ <code>start</code> å¼€å§‹æ‰§è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time, threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°çº¿ç¨‹æ‰§è¡Œçš„ä»£ç :</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loop</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;thread %s is running...&#x27;</span> % threading.current_thread().name)</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;thread %s &gt;&gt;&gt; %s&#x27;</span> % (threading.current_thread().name, n))</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;thread %s ended.&#x27;</span> % threading.current_thread().name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;thread %s is running...&#x27;</span> % threading.current_thread().name)</span><br><span class="line">t = threading.Thread(target=loop, name=<span class="string">&#x27;LoopThread&#x27;</span>)</span><br><span class="line">t.start()</span><br><span class="line">t.join()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;thread %s ended.&#x27;</span> % threading.current_thread().name)</span><br></pre></td></tr></table></figure><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">thread MainThread is running...</span><br><span class="line">thread LoopThread is running...</span><br><span class="line">thread LoopThread &gt;&gt;&gt; <span class="number">1</span></span><br><span class="line">thread LoopThread &gt;&gt;&gt; <span class="number">2</span></span><br><span class="line">thread LoopThread &gt;&gt;&gt; <span class="number">3</span></span><br><span class="line">thread LoopThread &gt;&gt;&gt; <span class="number">4</span></span><br><span class="line">thread LoopThread &gt;&gt;&gt; <span class="number">5</span></span><br><span class="line">thread LoopThread ended.</span><br><span class="line">thread MainThread ended.</span><br></pre></td></tr></table></figure><p>ç”±äºä»»ä½•è¿›ç¨‹é»˜è®¤å°±ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æŠŠè¯¥çº¿ç¨‹ç§°ä¸ºä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹åˆå¯ä»¥å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼ŒPythonçš„ <code>threading</code> æ¨¡å—æœ‰ä¸ª <code>current_thread()</code>å‡½æ•°ï¼Œå®ƒæ°¸è¿œè¿”å›å½“å‰çº¿ç¨‹çš„å®ä¾‹</p><p>ä¸»çº¿ç¨‹å®ä¾‹çš„åå­—å«<code>MainThread</code>ï¼Œå­çº¿ç¨‹çš„åå­—åœ¨åˆ›å»ºæ—¶æŒ‡å®šï¼Œæˆ‘ä»¬ç”¨<code>LoopThread</code>å‘½åå­çº¿ç¨‹ï¼Œåå­—ä»…ä»…åœ¨æ‰“å°æ—¶ç”¨æ¥æ˜¾ç¤ºï¼Œæ²¡æœ‰å…¶ä»–ä½œç”¨</p><h2 id="lock">Lock</h2><p>å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œå¤šè¿›ç¨‹ä¸­ï¼ŒåŒä¸€ä¸ªå˜é‡ï¼Œå„è‡ªæœ‰ä¸€ä»½æ‹·è´å­˜åœ¨äºæ¯ä¸ªè¿›ç¨‹ä¸­ï¼Œäº’ä¸å½±å“</p><p>è€Œå¤šçº¿ç¨‹ä¸­ï¼Œæ‰€æœ‰å˜é‡éƒ½ç”±æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼ˆçº¿ç¨‹ä¸­æ•°æ®å…±äº«ï¼‰</p><p>æ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜å¯¼è‡´æ•°æ®é”™ä¹±</p><p>ä¸‹é¢ä¸¾ä¸€ä¸ªé”™ä¹±çš„ä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">total_count = <span class="number">100000000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>():</span><br><span class="line">    <span class="keyword">global</span> total_count</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> total_count &gt; <span class="number">0</span>:</span><br><span class="line">            total_count -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">1024</span>):</span><br><span class="line">    threads.append(threading.Thread(target=buy()))</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.start()</span><br><span class="line">    t.join()</span><br><span class="line"><span class="built_in">print</span>(total_count)</span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šå› ä¸ºè¿ç®—å¤ªå¿«ï¼Œè²Œä¼¼å¾ˆéš¾å¤ç°å¹¶å‘é—®é¢˜ï¼Œä½†æ˜¯ä¸ä»£è¡¨ä¸å­˜åœ¨</p><p>æƒ³è¦ä¿è¯åŸå­æ€§ï¼Œå°±è¦ä¸Šé”ï¼Œåˆ›å»ºä¸€ä¸ªé”å°±æ˜¯é€šè¿‡<code>threading.Lock</code> æ¥å®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># threading.Lock åˆ›å»ºé”</span></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>():</span><br><span class="line">    <span class="keyword">global</span> total_count</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># ä¸Šé”</span></span><br><span class="line">        lock.acquire()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> total_count &gt; <span class="number">0</span>:</span><br><span class="line">                total_count -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># é‡Šæ”¾</span></span><br><span class="line">            lock.release()</span><br></pre></td></tr></table></figure><h2 id="å¤šæ ¸-cpu">å¤šæ ¸ CPU</h2><p>å¦‚æœæœ‰ä¸¤ä¸ªæ­»å¾ªç¯çº¿ç¨‹ï¼Œåœ¨å¤šæ ¸ CPU ä¸­ï¼Œå¯ä»¥ç›‘æ§åˆ°ä¼šå ç”¨ 200%çš„CPUï¼Œä¹Ÿå°±æ˜¯å ç”¨ä¸¤ä¸ª CPU æ ¸å¿ƒ</p><p>è¯•è¯•ç”¨ Python å†™ä¸ªæ­»å¾ªç¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading, multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loop</span>():</span><br><span class="line">    x = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = x ^ <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(multiprocessing.cpu_count()):</span><br><span class="line">    t = threading.Thread(target=loop)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure><p>ä½†äº‹å®ä¸Š Python ä¸Šçš„æ­»å¾ªç¯è·‘ä¸æ»¡æ‰€æœ‰çš„ CPU</p><p>å› ä¸º Python çš„çº¿ç¨‹è™½ç„¶æ˜¯çœŸæ­£çš„çº¿ç¨‹ï¼Œä½†è§£é‡Šå™¨æ‰§è¡Œä»£ç æ—¶ï¼Œæœ‰ä¸€ä¸ª GIL é”<strong>Global Interpreter Lock</strong>ï¼Œä»»ä½• Pythonçº¿ç¨‹æ‰§è¡Œå‰ï¼Œå¿…é¡»å…ˆè·å¾— GIL é”ï¼Œç„¶åï¼Œæ¯æ‰§è¡Œ 100æ¡å­—èŠ‚ç ï¼Œè§£é‡Šå™¨å°±è‡ªåŠ¨é‡Šæ”¾ GIL é”ï¼Œè®©åˆ«çš„çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œ</p><p>è¿™ä¸ª GIL å…¨å±€é”å®é™…ä¸ŠæŠŠæ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œä»£ç éƒ½ç»™ä¸Šäº†é”ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹åœ¨Python ä¸­åªèƒ½äº¤æ›¿æ‰§è¡Œï¼Œå³ä½¿ 100 ä¸ªçº¿ç¨‹è·‘åœ¨ 100 æ ¸ CPU ä¸Šï¼Œä¹Ÿåªèƒ½ç”¨åˆ° 1ä¸ªæ ¸</p><p>GIL æ˜¯ Pythonè§£é‡Šå™¨è®¾è®¡çš„å†å²é—ç•™é—®é¢˜ï¼Œé€šå¸¸æˆ‘ä»¬ç”¨çš„è§£é‡Šå™¨æ˜¯å®˜æ–¹å®ç°çš„CPythonï¼Œè¦çœŸæ­£åˆ©ç”¨å¤šæ ¸ï¼Œé™¤éé‡å†™ä¸€ä¸ªä¸å¸¦ GIL çš„è§£é‡Šå™¨</p><p>ä¸è¿‡ä¹Ÿä¸ç”¨è¿‡äºæ‹…å¿ƒï¼ŒPythonè™½ç„¶ä¸èƒ½åˆ©ç”¨å¤šçº¿ç¨‹å®ç°å¤šæ ¸ä»»åŠ¡ï¼Œä½†å¯ä»¥é€šè¿‡å¤šè¿›ç¨‹å®ç°å¤šæ ¸ä»»åŠ¡ï¼Œå› ä¸ºå¤šä¸ªPython è¿›ç¨‹æœ‰å„è‡ªç‹¬ç«‹çš„ GIL é”ï¼Œäº’ä¸å½±å“</p><h2 id="threadlocal">ThreadLocal</h2><p>Java ä¸­ä¹Ÿæœ‰ ThreadLocal æœºåˆ¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">    </span><br><span class="line"><span class="comment"># åˆ›å»ºå…¨å±€ ThreadLocal å¯¹è±¡</span></span><br><span class="line">local_school = threading.local()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_student</span>():</span><br><span class="line">    <span class="comment"># è·å–å½“å‰çº¿ç¨‹å…³è”çš„ student</span></span><br><span class="line">    std = local_school.student</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Hello, %s (in %s)&#x27;</span> % (std, threading.current_thread().name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_thread</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="comment"># ç»‘å®š ThreadLocal çš„ student</span></span><br><span class="line">    local_school.student = name</span><br><span class="line">    process_student()</span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target= process_thread, args=(<span class="string">&#x27;Alice&#x27;</span>,), name=<span class="string">&#x27;Thread-A&#x27;</span>)</span><br><span class="line">t2 = threading.Thread(target= process_thread, args=(<span class="string">&#x27;Bob&#x27;</span>,), name=<span class="string">&#x27;Thread-B&#x27;</span>)</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line">t1.join()</span><br><span class="line">t2.join()</span><br></pre></td></tr></table></figure><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Hello,</span> Alice (in <span class="keyword">Thread</span>-A)</span><br><span class="line"><span class="built_in">Hello,</span> Bob (in <span class="keyword">Thread</span>-B)</span><br></pre></td></tr></table></figure><p>å…¨å±€å˜é‡ <code>local_school</code> å°±æ˜¯ä¸€ä¸ª <code>ThreadLocal</code>å¯¹è±¡ï¼Œæ¯ä¸ª <code>Thread</code> å¯¹å®ƒéƒ½å¯ä»¥è¯»å†™ <code>student</code>å±æ€§ï¼Œä½†äº’ä¸å½±å“</p><p>ä½†æ¯ä¸ªå±æ€§å¦‚ <code>local_school.student</code>éƒ½æ˜¯çº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œå¯ä»¥ä»»æ„è¯»å†™è€Œäº’ä¸å¹²æ‰°ï¼Œä¹Ÿä¸ç”¨ç®¡ç†é”çš„é—®é¢˜ï¼Œ<code>ThreadLocal</code>å†…éƒ¨ä¼šè‡ªåŠ¨å¤„ç†</p><h2 id="åˆ†å¸ƒå¼è¿›ç¨‹">åˆ†å¸ƒå¼è¿›ç¨‹</h2><p>Python <code>multiprocessing</code>æ¨¡å—ä¸­çš„ <code>managers</code>å­æ¨¡å—è¿˜æ”¯æŒæŠŠå¤šè¿›ç¨‹åˆ†å¸ƒåˆ°å¤šå°æœºå™¨ä¸Š</p><p>ç”±äº <code>managers</code>æ¨¡å—å°è£…å¾ˆå¥½ï¼Œä¸å¿…äº†è§£ç½‘ç»œé€šä¿¡çš„ç»†èŠ‚ï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“åœ°ç¼–å†™åˆ†å¸ƒå¼å¤šè¿›ç¨‹ç¨‹åº</p><p>é€šè¿‡ <code>managers</code> æ¨¡å—æŠŠ <code>Queue</code>é€šè¿‡ç½‘ç»œæš´éœ²å‡ºå»ï¼Œå°±å¯ä»¥è®©å…¶ä»–æœºå™¨çš„è¿›ç¨‹è®¿é—® <code>Queue</code> äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># task_worker.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time, sys, queue</span><br><span class="line"><span class="keyword">from</span> multiprocessing.managers <span class="keyword">import</span> BaseManager</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç±»ä¼¼çš„ QueueManager</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueueManager</span>(<span class="title class_ inherited__">BaseManager</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºè¿™ä¸ª QueueManager åªä»ç½‘ç»œä¸Šè·å– Queueï¼Œæ‰€ä»¥æ³¨å†Œæ—¶åªæä¾›åå­—</span></span><br><span class="line">QueueManager.register(<span class="string">&#x27;get_task_queue&#x27;</span>)</span><br><span class="line">QueueManager.register(<span class="string">&#x27;get_result_queue&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œ task_master.py çš„æœºå™¨</span></span><br><span class="line">server_addr = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Connect to server %s...&#x27;</span> % server_addr)</span><br><span class="line"><span class="comment"># ç«¯å£å’ŒéªŒè¯ç æ³¨æ„ä¿æŒä¸ task_master.py è®¾ç½®çš„å®Œå…¨ä¸€è‡´</span></span><br><span class="line">m = QueueManager(address=(server_addr, <span class="number">5000</span>), authkey=<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line"><span class="comment"># ä»ç½‘ç»œè¿æ¥</span></span><br><span class="line">m.connect()</span><br><span class="line"><span class="comment"># è·å– Queue çš„å¯¹è±¡</span></span><br><span class="line">task = m.get_task_queue()</span><br><span class="line">result = m.get_result_queue()</span><br><span class="line"><span class="comment"># ä» task é˜Ÿåˆ—å–ä»»åŠ¡,å¹¶æŠŠç»“æœå†™å…¥resulté˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        n = task.get(timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;run task %d * %d...&#x27;</span> % (n, n))</span><br><span class="line">        r = <span class="string">&#x27;%d * %d = %d&#x27;</span> % (n, n, n*n)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        result.put(r)</span><br><span class="line">    <span class="keyword">except</span> Queue.Empty:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;task queue is empty.&#x27;</span>)</span><br><span class="line"><span class="comment"># å¤„ç†ç»“æŸ:</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;worker exit.&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä»»åŠ¡è¿›ç¨‹è¦é€šè¿‡ç½‘ç»œè¿æ¥åˆ°æœåŠ¡è¿›ç¨‹ï¼Œæ‰€ä»¥è¦æŒ‡å®šæœåŠ¡è¿›ç¨‹çš„ IP</p><ol type="1"><li><p>å…ˆå¯åŠ¨ <code>task_master.py</code> æœåŠ¡è¿›ç¨‹</p></li><li><p><code>task_master.py</code> è¿›ç¨‹å‘é€å®Œä»»åŠ¡åï¼Œå¼€å§‹ç­‰å¾…<code>result</code> é˜Ÿåˆ—çš„ç»“æœï¼Œç°åœ¨å¯åŠ¨ <code>task_worker.py</code>è¿›ç¨‹</p></li><li><p><code>task_worker.py</code> è¿›ç¨‹ç»“æŸï¼Œåœ¨<code>task_master.py</code> è¿›ç¨‹ä¸­ä¼šç»§ç»­æ‰“å°å‡ºç»“æœ</p></li></ol><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Result</span>: <span class="number">3411</span> * <span class="number">3411</span> = <span class="number">11634921</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">1605</span> * <span class="number">1605</span> = <span class="number">2576025</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">1398</span> * <span class="number">1398</span> = <span class="number">1954404</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">4729</span> * <span class="number">4729</span> = <span class="number">22363441</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">5300</span> * <span class="number">5300</span> = <span class="number">28090000</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">7471</span> * <span class="number">7471</span> = <span class="number">55815841</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">68</span> * <span class="number">68</span> = <span class="number">4624</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">4219</span> * <span class="number">4219</span> = <span class="number">17799961</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">339</span> * <span class="number">339</span> = <span class="number">114921</span></span><br><span class="line"><span class="attribute">Result</span>: <span class="number">7866</span> * <span class="number">7866</span> = <span class="number">61873956</span></span><br></pre></td></tr></table></figure><p><code>Queue</code> å¯¹è±¡å­˜å‚¨åœ¨ <code>task_master</code>ä¸Šï¼Œåªæ˜¯é€šè¿‡ç½‘ç»œå…±äº«äº†å‡ºå»ï¼ˆç±»ä¼¼ RPCï¼Œå¯¹ä¸Šå±‚é¢å±è”½ç½‘ç»œå®ç°ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">                                             â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚task_master.py                           â”‚  â”‚  â”‚task_worker.py                        â”‚</span><br><span class="line">â”‚                                         â”‚     â”‚                                      â”‚</span><br><span class="line">â”‚  task = manager.get_task_queue()        â”‚  â”‚  â”‚  task = manager.get_task_queue()     â”‚</span><br><span class="line">â”‚  result = manager.get_result_queue()    â”‚     â”‚  result = manager.get_result_queue() â”‚</span><br><span class="line">â”‚              â”‚                          â”‚  â”‚  â”‚              â”‚                       â”‚</span><br><span class="line">â”‚              â”‚                          â”‚     â”‚              â”‚                       â”‚</span><br><span class="line">â”‚              â–¼                          â”‚  â”‚  â”‚              â”‚                       â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚              â”‚                       â”‚</span><br><span class="line">â”‚  â”‚QueueManager                     â”‚    â”‚  â”‚  â”‚              â”‚                       â”‚</span><br><span class="line">â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚     â”‚              â”‚                       â”‚</span><br><span class="line">â”‚  â”‚ â”‚ task_queue â”‚ â”‚ result_queue â”‚ â”‚&lt;â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚</span><br><span class="line">â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚     â”‚                                      â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚                                      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                                             â”‚</span><br><span class="line"></span><br><span class="line">                                          Network</span><br></pre></td></tr></table></figure><p>æ³¨æ„ <code>Queue</code>çš„ä½œç”¨æ˜¯ç”¨æ¥ä¼ é€’ä»»åŠ¡å’Œæ¥æ”¶ç»“æœï¼Œæ¯ä¸ªä»»åŠ¡çš„æè¿°æ•°æ®é‡è¦å°½é‡å°ï¼›æ¯”å¦‚å‘é€ä¸€ä¸ªå¤„ç†æ—¥å¿—æ–‡ä»¶çš„ä»»åŠ¡ï¼Œå°±ä¸è¦å‘é€å‡ ç™¾å…†çš„æ—¥å¿—æ–‡ä»¶æœ¬èº«ï¼Œè€Œæ˜¯å‘é€æ—¥å¿—æ–‡ä»¶å­˜æ”¾çš„å®Œæ•´è·¯å¾„ï¼Œç”±Worker è¿›ç¨‹å†å»å…±äº«çš„ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶</p><h1 id="åç¨‹">åç¨‹</h1><p>åç¨‹ï¼Œè‹±æ–‡å Coroutine</p><p>å­ç¨‹åºï¼Œæˆ–è€…ç§°ä¸ºå‡½æ•°ï¼Œåœ¨æ‰€æœ‰è¯­è¨€ä¸­éƒ½æ˜¯å±‚çº§è°ƒç”¨ï¼Œæ¯”å¦‚ A è°ƒç”¨ Bï¼ŒBåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åˆè°ƒç”¨äº† Cï¼ŒC æ‰§è¡Œå®Œæ¯•è¿”å›ï¼ŒB æ‰§è¡Œå®Œæ¯•è¿”å›ï¼Œæœ€åæ˜¯ Aæ‰§è¡Œå®Œæ¯•ï¼ˆå‡½æ•°æ ˆï¼‰</p><p>è€Œåç¨‹çš„è°ƒç”¨å’Œå­ç¨‹åºä¸åŒï¼Œåç¨‹çœ‹ä¸Šå»ä¹Ÿæ˜¯å­ç¨‹åºï¼Œä½†æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåœ¨å­ç¨‹åºå†…éƒ¨å¯ä¸­æ–­ï¼Œç„¶åè½¬è€Œæ‰§è¡Œåˆ«çš„å­ç¨‹åºï¼Œåœ¨é€‚å½“çš„æ—¶å€™å†è¿”å›æ¥æ¥ç€æ‰§è¡Œ</p><p>æ³¨æ„åœ¨ä¸€ä¸ªå­ç¨‹åºä¸­ä¸­æ–­åå»æ‰§è¡Œå…¶ä»–å­ç¨‹åºï¼Œä¸æ˜¯å‡½æ•°è°ƒç”¨ï¼Œæœ‰ç‚¹ç±»ä¼¼ CPUçš„ä¸­æ–­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">A</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">B</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;z&#x27;</span>)</span><br></pre></td></tr></table></figure><p>å‡è®¾ç”±åç¨‹æ‰§è¡Œï¼Œåœ¨æ‰§è¡Œ A çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥éšæ—¶ä¸­æ–­ï¼Œå»æ‰§è¡Œ Bï¼ŒBä¹Ÿå¯èƒ½åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸­æ–­å†å»æ‰§è¡Œ Aï¼Œç»“æœå¯èƒ½æ˜¯</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="keyword">x</span></span><br><span class="line">y</span><br><span class="line"><span class="number">3</span></span><br><span class="line">z</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ A ä¸­æ˜¯æ²¡æœ‰è°ƒç”¨ Bçš„ï¼Œæ‰€ä»¥åç¨‹çš„è°ƒç”¨æ¯”å‡½æ•°è°ƒç”¨ç†è§£èµ·æ¥è¦éš¾ä¸€äº›</p><p>é‚£ä¹ˆåç¨‹å’Œå¤šçº¿ç¨‹æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ</p><ul><li><p>ä¼˜åŠ¿</p><ul><li><p><strong>æ‰§è¡Œæ•ˆç‡é«˜</strong>ï¼šå­ç¨‹åºåˆ‡æ¢ä¸æ˜¯çº¿ç¨‹åˆ‡æ¢ï¼Œåç¨‹å±äºç¨‹åºçº§åˆ«ï¼Œè°ƒåº¦å¼€æ”¯å°</p></li><li><p><strong>ä¸éœ€è¦å¤šçº¿ç¨‹çš„é”æœºåˆ¶</strong>ï¼šæ— éœ€åŒæ­¥äº’æ–¥æ“ä½œ</p></li><li><p><strong>å¹¶å‘é«˜</strong>ï¼šæ²¡æœ‰ C10K é—®é¢˜ï¼ŒIO å¹¶å‘æ€§å¥½</p></li></ul></li><li><p>ç¼ºç‚¹</p><ul><li><strong>å¤šæ ¸ CPU</strong>ï¼šåç¨‹çš„æœ¬è´¨æ˜¯ä¸ªå•çº¿ç¨‹ï¼Œä¸èƒ½å¾ˆå¥½åœ°åˆ©ç”¨ CPUçš„å¤šä¸ªæ ¸å¿ƒï¼›åç¨‹éœ€è¦å’Œè¿›ç¨‹é…åˆæ‰èƒ½è¿è¡Œåœ¨å¤š CPU ä¸Š</li><li><strong>å—çº¿ç¨‹å½±å“</strong>ï¼šè¿›è¡Œé˜»å¡ï¼ˆBlockingï¼‰æ“ä½œæ—¶ä¼šé˜»å¡æ‰æ•´ä¸ªç¨‹åº</li></ul></li></ul><p>åˆ©ç”¨å¤šæ ¸ CPUï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯å¤šè¿›ç¨‹ +åç¨‹ï¼Œæ—¢å……åˆ†åˆ©ç”¨å¤šæ ¸ï¼Œåˆå……åˆ†å‘æŒ¥åç¨‹çš„é«˜æ•ˆç‡</p><p>Python å¯¹åç¨‹çš„æ”¯æŒæ˜¯é€šè¿‡ generator å®ç°çš„ï¼Œ<code>yield</code>ä¸ä½†å¯ä»¥è¿”å›ä¸€ä¸ªå€¼ï¼Œå®ƒè¿˜å¯ä»¥æ¥æ”¶è°ƒç”¨è€…å‘å‡ºçš„å‚æ•°ï¼ŒåŒè¿‡ <code>next</code>å¯åŠ¨ç”Ÿæˆå™¨ï¼Œå¹¶åœ¨åç»­é€»è¾‘ä¸­è°ƒç”¨ <code>send</code> å‡½æ•°ä¼ é€’å€¼</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç»å…¸çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…åç¨‹ç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>():</span><br><span class="line">    r = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        n = <span class="keyword">yield</span> r</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[CONSUMER] Consuming %s...&#x27;</span> % n)</span><br><span class="line">        r = <span class="string">&#x27;200 OK&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">produce</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="built_in">next</span>(c)</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[PRODUCER] Producing %s...&#x27;</span> % n)</span><br><span class="line">        r = c.send(n)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[PRODUCER] Consumer return: %s&#x27;</span> % r)</span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c = consumer()</span><br><span class="line">produce(c)</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªæµç¨‹æ— é”ï¼Œç”±ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œ<code>produce</code> å’Œ<code>consumer</code>åä½œå®Œæˆä»»åŠ¡ï¼Œæ‰€ä»¥ç§°ä¸ºåç¨‹ï¼Œè€Œéçº¿ç¨‹çš„æŠ¢å å¼å¤šä»»åŠ¡</p><p>åŒæ ·ä¸¾ä¸€ä¸ªå¤šåç¨‹çš„ä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">average</span>():</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    value = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        term = <span class="keyword">yield</span> value</span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        value = total / count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    c = average()</span><br><span class="line">    <span class="built_in">next</span>(c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;å½•å…¥æ•°å­— <span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line">        avg = c.send(i)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;å·²å½•å…¥æ•°å­—çš„å¹³å‡å€¼ä¸º <span class="subst">&#123;avg&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å…¶ä»–æ“ä½œ&quot;</span>)</span><br><span class="line">    i = <span class="number">10</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;å½•å…¥æ•°å­— <span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line">    avg = c.send(i)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;å·²å½•å…¥æ•°å­—çš„å¹³å‡å€¼ä¸º <span class="subst">&#123;avg&#125;</span>&#x27;</span>)</span><br><span class="line">    c.close()</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">å½•å…¥æ•°å­— 0</span><br><span class="line">å·²å½•å…¥æ•°å­—çš„å¹³å‡å€¼ä¸º 0.0</span><br><span class="line">å½•å…¥æ•°å­— 1</span><br><span class="line">å·²å½•å…¥æ•°å­—çš„å¹³å‡å€¼ä¸º 0.5</span><br><span class="line">å½•å…¥æ•°å­— 2</span><br><span class="line">å·²å½•å…¥æ•°å­—çš„å¹³å‡å€¼ä¸º 1.0</span><br><span class="line">å…¶ä»–æ“ä½œ</span><br><span class="line">å½•å…¥æ•°å­— 10</span><br><span class="line">å·²å½•å…¥æ•°å­—çš„å¹³å‡å€¼ä¸º 3.25</span><br></pre></td></tr></table></figure><p>åç¨‹å‡½æ•°ä¸­çš„æ— é™å¾ªç¯è¡¨æ˜ï¼Œåªè¦è°ƒç”¨æ–¹ä¸æ–­æŠŠå€¼å‘ç»™è¿™ä¸ªåç¨‹ï¼Œå®ƒå°±ä¼šä¸€ç›´æ¥æ”¶å€¼ï¼Œç„¶åè®¡ç®—å·²å½•å…¥çš„æ‰€æœ‰æ•°å­—çš„å¹³å‡å€¼</p><p>å¯ä»¥çœ‹å‡ºå’Œå‡½æ•°çš„åŒºåˆ«åœ¨äºï¼Œåç¨‹åƒæ˜¯ä¸€ä¸ªå…¶ä»–è°ƒç”¨åˆ†æ”¯ï¼Œå°†å½“å‰æ‰§è¡Œçš„æ•°æ®ç°åœºä¿å­˜äº†èµ·æ¥ï¼Œå¦‚æœè¿™ä¸ªæ“ä½œä½¿ç”¨å‡½æ•°è°ƒç”¨æ¥å®ç°ï¼Œéœ€è¦å¯¹è±¡æ¥å¯¹å†å²æ•°æ®è¿›è¡Œå­˜å‚¨ï¼ˆä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œåç¨‹å°±ä¿å­˜ç°åœºçš„å¯¹è±¡ï¼Ÿï¼‰</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://www.liaoxuefeng.com/wiki/1016959663602400/1017627212385376">è¿›ç¨‹å’Œçº¿ç¨‹- å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/667442795">ã€ŒåŸºç¡€ç¯‡ã€Pythonåç¨‹ï¼ˆä¸€ï¼‰ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python è¿›é˜¶è¯­æ³•</title>
      <link href="/%E5%BC%80%E5%8F%91/Python/Python%20%E8%BF%9B%E9%98%B6%E8%AF%AD%E6%B3%95.html"/>
      <url>/%E5%BC%80%E5%8F%91/Python/Python%20%E8%BF%9B%E9%98%B6%E8%AF%AD%E6%B3%95.html</url>
      
        <content type="html"><![CDATA[<p>å› ä¸º Pythonå¹¶éæ˜¯å·¥ä½œå†…å®¹éœ€è¦ä½¿ç”¨çš„è¯­è¨€ï¼Œæ‰€ä»¥å¯¹è¯­æ³•å¹¶æ²¡æœ‰ç³»ç»Ÿåœ°å­¦ä¹ è¿‡ï¼ŒåŠ ä¸Šä¹Ÿä¸ä¼šä½¿ç”¨Pythonç¼–å†™ä»€ä¹ˆå¤æ‚çš„é€»è¾‘ï¼Œæ‰€ä»¥ä¸€ç›´ä»¥æ¥éƒ½æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°éœ€è¦çš„é€»è¾‘è¯­æ³•å°±æŸ¥ä¸€ä¸‹</p><p>åœ¨å­¦ä¹  LangChain çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç° Pythonçš„è¯­æ³•ç³–å¾ˆå¤šï¼Œå¾ˆå¤šè®¾è®¡æ€æƒ³æä¾›äº†è¯­æ³•å±‚é¢çš„æ”¯æŒï¼Œä½¿å¾—é˜…è¯»æºç æŒºè´¹åŠ²çš„</p><p>æ‰€ä»¥åœ¨è¿™é‡Œè¿˜æ˜¯ç³»ç»Ÿåœ°äº†è§£ä¸‹ Python éƒ½æä¾›äº†å“ªäº›è¯­æ³•ï¼Œä¹Ÿäº†è§£ä¸‹ Pythonç¼–å†™ä»£ç çš„ä¸»è¦æ€æƒ³</p><p>è¿™é‡Œä¸»è¦æ˜¯æ•´ç†ä¸‹ Python ä¸­æ¯”è¾ƒç‰¹æ®Šçš„ã€å’Œ Java æœ‰è¾ƒå¤§åŒºåˆ«çš„æ“ä½œ</p><h1 id="å‡½æ•°">å‡½æ•°</h1><h2 id="å¤šè¿”å›å€¼">å¤šè¿”å›å€¼</h2><p>Python å…è®¸å‡½æ•°è¿”å›å¤šä¸ªå€¼ï¼Œå¹¶ä¸”è°ƒç”¨æ—¶ä½¿ç”¨å¤šä¸ªå˜é‡æ‰¿æ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line"></span><br><span class="line">a, b, c = build()</span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment"># 2</span></span><br><span class="line"><span class="built_in">print</span>(c) <span class="comment"># 3</span></span><br></pre></td></tr></table></figure><p>å®é™…ä¸ŠçœŸæ­£çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª Tuple å¯¹è±¡ï¼ŒPythonå¸®å¿™åšäº†è§£å‹ï¼ˆunpackï¼‰æ“ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line"></span><br><span class="line">t = build()</span><br><span class="line"><span class="built_in">print</span>(t) <span class="comment"># (1, 2, 3)</span></span><br><span class="line"><span class="built_in">print</span>(t.__class__) <span class="comment"># &lt;class &#x27;tuple&#x27;&gt;</span></span><br></pre></td></tr></table></figure><h2 id="é»˜è®¤å‚æ•°">é»˜è®¤å‚æ•°</h2><p>è®¾ç½®å‚æ•°çš„é»˜è®¤å€¼ï¼Œé»˜è®¤å‚æ•°å¯ä»¥ç®€åŒ–å‡½æ•°çš„è°ƒç”¨</p><p>éœ€è¦æ³¨æ„ï¼š</p><ul><li>å¿…é€‰å‚æ•°åœ¨å‰ï¼Œé»˜è®¤å‚æ•°åœ¨å</li><li>å®è·µä¸­ä¸€èˆ¬å°†å˜åŒ–å¤§çš„å‚æ•°æ”¾åœ¨å‰é¢ï¼Œå˜åŒ–å°çš„å‚æ•°æ”¾åœ¨åé¢ï¼ˆç®€å•ç†è§£ï¼Œå°±æ˜¯å› ä¸ºå˜åŒ–å°æ‰éœ€è¦é»˜è®¤ï¼‰</li><li>å½“ä¸æŒ‰é¡ºåºæä¾›éƒ¨åˆ†é»˜è®¤å‚æ•°æ—¶ï¼Œéœ€è¦æŠŠå‚æ•°åå†™ä¸Šï¼›å¦‚<code>default_params('æå››', city='ä¸Šæµ·')</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">default_params</span>(<span class="params">name, age=<span class="number">20</span>, city=<span class="string">&#x27;åŒ—äº¬&#x27;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(name)</span><br><span class="line">    <span class="built_in">print</span>(age)</span><br><span class="line">    <span class="built_in">print</span>(city)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">default_params(<span class="string">&#x27;å¼ ä¸‰&#x27;</span>)</span><br><span class="line">default_params(<span class="string">&#x27;æå››&#x27;</span>, city=<span class="string">&#x27;ä¸Šæµ·&#x27;</span>)</span><br><span class="line">default_params(<span class="string">&#x27;ç‹äº”&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;ä¸Šæµ·&#x27;</span>)</span><br></pre></td></tr></table></figure><p>é»˜è®¤å‚æ•°æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„å‘ï¼š<strong>é»˜è®¤å‚æ•°å¿…é¡»æŒ‡å‘ä¸å˜å¯¹è±¡</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">default_params</span>(<span class="params">L=[]</span>):</span><br><span class="line">    L.append(<span class="string">&quot;END&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(L)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">default_params([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) <span class="comment"># [1, 2, 3, &#x27;END&#x27;]</span></span><br><span class="line">default_params() <span class="comment"># [&#x27;END&#x27;]</span></span><br><span class="line">default_params() <span class="comment"># [&#x27;END&#x27;, &#x27;END&#x27;]</span></span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯ Python å‡½æ•°åœ¨å®šä¹‰çš„æ—¶å€™ï¼Œé»˜è®¤å‚æ•° <code>L</code>çš„å€¼å°±è¢«è®¡ç®—å‡ºæ¥äº†ï¼Œå³ <code>[]</code>ï¼Œå› ä¸ºé»˜è®¤å‚æ•° <code>L</code>ä¹Ÿæ˜¯ä¸€ä¸ªå˜é‡ï¼Œå®ƒæŒ‡å‘å¯¹è±¡ <code>[]</code>ï¼Œæ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°éƒ½åœ¨æ”¹å˜<code>L</code> å˜é‡çš„å€¼</p><p>å®é™…ä¸Š PyCharm IDE ä¹Ÿä¼šå‡ºç°è­¦å‘Š<code>Default argument value is mutable</code></p><p>å¯ä»¥ä½¿ç”¨ <code>None</code> æ¥è§£å†³ä¸Šè¿°é—®é¢˜</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">default_params</span>(<span class="params">L=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> L <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        L = []</span><br><span class="line">    L.append(<span class="string">&quot;END&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(L)</span><br></pre></td></tr></table></figure><h2 id="å¯å˜å‚æ•°">å¯å˜å‚æ•°</h2><p>å¯å˜å‚æ•°æŒ‡ä¼ å…¥çš„å‚æ•°ä¸ªæ•°æ˜¯å¯å˜çš„ï¼Œä¾‹å¦‚ 0 ä¸ªã€1 ä¸ªã€2 ä¸ª...</p><p>å®šä¹‰å¯å˜å‚æ•°å’Œå®šä¹‰ä¸€ä¸ª list æˆ– tupleå‚æ•°ç›¸æ¯”ï¼Œåªéœ€è¦åœ¨å‚æ•°å‰é¢åŠ äº†ä¸€ä¸ª <code>*</code>å·ï¼Œåœ¨å‡½æ•°å†…éƒ¨å®ç°é€»è¾‘å¯ä»¥å®Œå…¨ä¸å˜</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sum</span>(<span class="params">*nums</span>):</span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> nums:</span><br><span class="line">        <span class="built_in">sum</span> += n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)) <span class="comment"># 10</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª list æˆ–tupleï¼Œåˆ™æ— æ³•ç›´æ¥ä½œä¸ºå‚æ•°ä¼ å…¥è¯¥æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>*</code>å·å°†å…¶è½¬æ¢ä¸ºå¯å˜å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sum</span>(<span class="params">*nums</span>):</span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> nums:</span><br><span class="line">        <span class="built_in">sum</span> += n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(nums)) <span class="comment"># æŠ¥é”™ï¼›TypeError: unsupported operand type(s) for +=: &#x27;int&#x27; and &#x27;list&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(*nums)) <span class="comment"># 10</span></span><br></pre></td></tr></table></figure><h2 id="å…³é”®å­—å‚æ•°">å…³é”®å­—å‚æ•°</h2><p>å¯å˜å‚æ•°å…è®¸ä¼ å…¥ 0ä¸ªæˆ–ä»»æ„ä¸ªå‚æ•°ï¼Œè¿™äº›å¯å˜å‚æ•°åœ¨å‡½æ•°è°ƒç”¨æ—¶è‡ªåŠ¨ç»„è£…ä¸ºä¸€ä¸ª tuple</p><p>å…³é”®å­—å‚æ•°å…è®¸ä¼ å…¥ 0ä¸ªæˆ–ä»»æ„ä¸ªå«å‚æ•°åçš„å‚æ•°ï¼Œè¿™äº›å…³é”®å­—å‚æ•°åœ¨å‡½æ•°å†…éƒ¨è‡ªåŠ¨ç»„è£…ä¸ºä¸€ä¸ªdict</p><p>ä½¿ç”¨ <code>**</code> è¡¨ç¤ºå¸Œæœ›æ¥æ”¶çš„æ˜¯ä¸ªå…³é”®å­—å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_student</span>(<span class="params">name, age, **other</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;name:&#x27;</span>, name, <span class="string">&#x27;age:&#x27;</span>, age, <span class="string">&#x27;other:&#x27;</span>, other)</span><br><span class="line"></span><br><span class="line">build_student(name=<span class="string">&#x27;å¼ ä¸‰&#x27;</span>, age=<span class="number">20</span>, city=<span class="string">&#x27;åŒ—äº¬&#x27;</span>, birthday=<span class="string">&#x27;2004-01-01&#x27;</span>)</span><br><span class="line"><span class="comment"># name: å¼ ä¸‰ age: 20 other: &#123;&#x27;city&#x27;: &#x27;åŒ—äº¬&#x27;, &#x27;birthday&#x27;: &#x27;2004-01-01&#x27;&#125;</span></span><br></pre></td></tr></table></figure><p>å’Œå¯å˜å‚æ•°ç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥å…ˆç»„è£…å‡ºä¸€ä¸ª dictï¼Œç„¶åï¼ŒæŠŠè¯¥ dictè½¬æ¢ä¸ºå…³é”®å­—å‚æ•°ä¼ å…¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_student</span>(<span class="params">name, age, **other</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;name:&#x27;</span>, name, <span class="string">&#x27;age:&#x27;</span>, age, <span class="string">&#x27;other:&#x27;</span>, other)</span><br><span class="line"></span><br><span class="line">student = &#123;name=<span class="string">&#x27;å¼ ä¸‰&#x27;</span>, age=<span class="number">20</span>, city=<span class="string">&#x27;åŒ—äº¬&#x27;</span>, birthday=<span class="string">&#x27;2004-01-01&#x27;</span>&#125;</span><br><span class="line">build_student(**student)</span><br></pre></td></tr></table></figure><p>å¯¹äºå…³é”®å­—å‚æ•°ï¼Œå‡½æ•°çš„è°ƒç”¨æ–¹å¯ä»¥ä¼ å…¥ä»»æ„ä¸å—é™åˆ¶çš„å…³é”®å­—å‚æ•°ï¼Œå¯¹äºå‚æ•°å€¼å¯ä»¥åœ¨å‡½æ•°å†…è¿›è¡Œå‚æ•°æ ¡éªŒ</p><p>å¯¹äºå‚æ•°åå­—çš„é™åˆ¶å¯ä»¥é€šè¿‡å‘½åå…³é”®å­—å‚æ•°æ¥è¿›è¡Œé™åˆ¶ï¼Œé€šè¿‡<code>*</code> å·åˆ†éš”ä½ç½®å‚æ•°å’Œå…³é”®å­—å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_student</span>(<span class="params">name, age, *, city</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;name:&#x27;</span>, name, <span class="string">&#x27;age:&#x27;</span>, age, <span class="string">&#x27;city:&#x27;</span>, city)</span><br><span class="line"></span><br><span class="line">build_student(name=<span class="string">&#x27;å¼ ä¸‰&#x27;</span>, age=<span class="number">20</span>, city=<span class="string">&#x27;åŒ—äº¬&#x27;</span>, birthday=<span class="string">&#x27;2004-01-01&#x27;</span>)</span><br><span class="line"><span class="comment"># æŠ¥é”™ TypeError: build_student() got an unexpected keyword argument &#x27;birthday&#x27;</span></span><br></pre></td></tr></table></figure><p>å‘½åå…³é”®å­—å‚æ•°ä¹Ÿå¯ä»¥æœ‰é»˜è®¤å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_student</span>(<span class="params">name, age=<span class="number">20</span>, *, city=<span class="string">&#x27;åŒ—äº¬&#x27;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;name:&#x27;</span>, name, <span class="string">&#x27;age:&#x27;</span>, age, <span class="string">&#x27;city:&#x27;</span>, city)</span><br><span class="line"></span><br><span class="line">build_student(name=<span class="string">&#x27;å¼ ä¸‰&#x27;</span>)</span><br><span class="line"><span class="comment"># name: å¼ ä¸‰ age: 20 city: åŒ—äº¬</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½åå…³é”®å­—å‚æ•°æ—¶éœ€è¦æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰å¯å˜å‚æ•°å°±å¿…é¡»åŠ ä¸€ä¸ª<code>*</code> ä½œä¸ºç‰¹æ®Šåˆ†éš”ç¬¦ï¼Œå› ä¸ºå¦‚æœç¼ºå°‘ <code>*</code>ï¼ŒPythonè§£é‡Šå™¨å°†æ— æ³•è¯†åˆ«ä½ç½®å‚æ•°å’Œå‘½åå…³é”®å­—å‚æ•°</p><h2 id="ç»„åˆå‚æ•°">ç»„åˆå‚æ•°</h2><p>åœ¨ Pythonä¸­å®šä¹‰å‡½æ•°ï¼Œå¯ä»¥ç”¨å¿…é€‰å‚æ•°ã€é»˜è®¤å‚æ•°ã€å¯å˜å‚æ•°ã€å…³é”®å­—å‚æ•°å’Œå‘½åå…³é”®å­—å‚æ•°ï¼Œè¿™5 ç§å‚æ•°éƒ½å¯ä»¥ç»„åˆä½¿ç”¨</p><p>ä½†æ˜¯è¯·æ³¨æ„ï¼Œå‚æ•°å®šä¹‰çš„é¡ºåºå¿…é¡»æ˜¯ï¼šå¿…é€‰å‚æ•°ã€é»˜è®¤å‚æ•°ã€å¯å˜å‚æ•°ã€å‘½åå…³é”®å­—å‚æ•°å’Œå…³é”®å­—å‚æ•°</p><p>æ¯”å¦‚å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼ŒåŒ…å«ä¸Šè¿°è‹¥å¹²ç§å‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">f1</span>(<span class="params">a, b, c=<span class="number">0</span>, *args, **kw</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;a =&#x27;</span>, a, <span class="string">&#x27;b =&#x27;</span>, b, <span class="string">&#x27;c =&#x27;</span>, c, <span class="string">&#x27;args =&#x27;</span>, args, <span class="string">&#x27;kw =&#x27;</span>, kw)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f2</span>(<span class="params">a, b, c=<span class="number">0</span>, *, d, **kw</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;a =&#x27;</span>, a, <span class="string">&#x27;b =&#x27;</span>, b, <span class="string">&#x27;c =&#x27;</span>, c, <span class="string">&#x27;d =&#x27;</span>, d, <span class="string">&#x27;kw =&#x27;</span>, kw)</span><br></pre></td></tr></table></figure><p>æœ€ç¥å¥‡çš„æ˜¯é€šè¿‡ä¸€ä¸ª tuple å’Œ dict ä¹Ÿå¯ä»¥è°ƒç”¨ä¸Šè¿°å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">args = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">kw = &#123;<span class="string">&#x27;d&#x27;</span>: <span class="number">99</span>, <span class="string">&#x27;x&#x27;</span>: <span class="string">&#x27;#&#x27;</span>&#125;</span><br><span class="line">f1(*args, **kw)</span><br><span class="line"><span class="comment"># a = 1 b = 2 c = 3 args = (4,) kw = &#123;&#x27;d&#x27;: 99, &#x27;x&#x27;: &#x27;#&#x27;&#125;</span></span><br></pre></td></tr></table></figure><p>å³å¯¹äºä»»æ„å‡½æ•°ï¼Œéƒ½å¯ä»¥é€šè¿‡ç±»ä¼¼ <code>func(*args, **kw)</code>çš„å½¢å¼è°ƒç”¨å®ƒï¼Œæ— è®ºå®ƒçš„å‚æ•°æ˜¯å¦‚ä½•å®šä¹‰çš„</p><h1 id="é›†åˆç‰¹æ€§">é›†åˆç‰¹æ€§</h1><h2 id="åˆ‡ç‰‡">åˆ‡ç‰‡</h2><p><code>l[0:3]</code> è¡¨ç¤ºï¼Œä»ç´¢å¼• 0 å¼€å§‹å–ï¼Œç›´åˆ°ç´¢å¼• 3ä¸ºæ­¢ï¼Œä½†ä¸åŒ…æ‹¬ç´¢å¼• 3ï¼ˆå·¦é—­å³å¼€ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„é›†åˆ API éƒ½æ˜¯è¿™ç§è®¾è®¡ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(l[<span class="number">0</span>:<span class="number">3</span>])</span><br><span class="line"><span class="comment"># [1, 2, 3]</span></span><br></pre></td></tr></table></figure><p>å¦‚æœç¬¬ä¸€ä¸ªç´¢å¼•æ˜¯ 0ï¼Œè¿˜å¯ä»¥çœç•¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(l[:<span class="number">3</span>])</span><br><span class="line"><span class="comment"># [1, 2, 3]</span></span><br></pre></td></tr></table></figure><p>-1 è¡¨ç¤ºå–å€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå³åŒæ ·æ”¯æŒå€’æ•°åˆ‡ç‰‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(l[-<span class="number">3</span>:-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># [2, 3]</span></span><br></pre></td></tr></table></figure><p>å‰ 10 ä¸ªæ•°ï¼Œæ¯ 2 ä¸ªå–ä¸€ä¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(l[:<span class="number">10</span>:<span class="number">2</span>])</span><br><span class="line"><span class="comment"># [1, 3, 5, 7, 9]</span></span><br></pre></td></tr></table></figure><p>æ‰€æœ‰æ•°æ¯ 3 ä¸ªå–ä¸€ä¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(l[::<span class="number">3</span>])</span><br><span class="line"><span class="comment"># [1, 4, 7, 10, 13]</span></span><br></pre></td></tr></table></figure><p>ç”šè‡³ä»€ä¹ˆéƒ½ä¸å†™ï¼Œåªå†™ <code>[:]</code> å°±å¯ä»¥åŸæ ·å¤åˆ¶ä¸€ä¸ª list</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(l[:])</span><br><span class="line"><span class="comment"># [1, 2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure><p>tuple ä¹Ÿæ˜¯ä¸€ç§ listï¼Œå”¯ä¸€åŒºåˆ«æ˜¯ tuple ä¸å¯å˜ï¼Œå› æ­¤ tupleä¹Ÿå¯ä»¥ç”¨åˆ‡ç‰‡æ“ä½œï¼Œæ“ä½œçš„ç»“æœä»æ˜¯ tuple</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(t[:<span class="number">3</span>])</span><br><span class="line"><span class="comment"># (1, 2, 3)</span></span><br><span class="line"><span class="built_in">print</span>(t[:<span class="number">3</span>].__class__)</span><br><span class="line"><span class="comment"># &lt;class &#x27;tuple&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ä¸€ç§listï¼Œæ¯ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ï¼›å› æ­¤å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ç”¨åˆ‡ç‰‡æ“ä½œï¼Œæ“ä½œç»“æœä»æ˜¯å­—ç¬¦ä¸²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s[-<span class="number">6</span>:])</span><br><span class="line"><span class="comment"># World!</span></span><br><span class="line"><span class="built_in">print</span>(s[-<span class="number">6</span>:].__class__)</span><br><span class="line"><span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br></pre></td></tr></table></figure><h2 id="è¿­ä»£">è¿­ä»£</h2><p>åªè¦æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œæ— è®ºæœ‰æ— ä¸‹æ ‡ï¼Œéƒ½å¯ä»¥è¿­ä»£ï¼Œæ¯”å¦‚ dict å°±å¯ä»¥è¿­ä»£</p><p>å› ä¸º dict çš„å­˜å‚¨ä¸æ˜¯æŒ‰ç…§ listçš„æ–¹å¼é¡ºåºæ’åˆ—ï¼Œæ‰€ä»¥è¿­ä»£å‡ºçš„ç»“æœé¡ºåºå¾ˆå¯èƒ½ä¸ä¸€æ ·</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;zhangsan&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;beijing&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> d:</span><br><span class="line">    <span class="built_in">print</span>(key)</span><br><span class="line"><span class="comment"># name</span></span><br><span class="line"><span class="comment"># age</span></span><br><span class="line"><span class="comment"># city</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œdict è¿­ä»£çš„æ˜¯ keyï¼›å¦‚æœè¦è¿­ä»£ valueï¼Œå¯ä»¥ç”¨<code>for value in d.values()</code>ï¼Œå¦‚æœè¦åŒæ—¶è¿­ä»£ key å’Œvalueï¼Œå¯ä»¥ç”¨ <code>for k, v in d.items()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;zhangsan&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;beijing&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> d.items():</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line"><span class="comment"># (&#x27;name&#x27;, &#x27;zhangsan&#x27;)</span></span><br><span class="line"><span class="comment"># (&#x27;age&#x27;, 20)</span></span><br><span class="line"><span class="comment"># (&#x27;city&#x27;, &#x27;beijing&#x27;)</span></span><br></pre></td></tr></table></figure><p>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¯è¿­ä»£å¯¹è±¡å‘¢ï¼Ÿæ–¹æ³•æ˜¯é€šè¿‡<code>collections.abc</code> æ¨¡å—çš„ <code>Iterable</code> ç±»å‹åˆ¤æ–­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="string">&#x27;abc&#x27;</span>, Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(&#123;<span class="number">1</span>: <span class="string">&#x27;a&#x27;</span>, <span class="number">2</span>: <span class="string">&#x27;b&#x27;</span>, <span class="number">3</span>: <span class="string">&#x27;c&#x27;</span>&#125;, Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="number">123</span>, Iterable)) <span class="comment"># False</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¦å¯¹ list å®ç°ç±»ä¼¼ Java çš„ä¸‹æ ‡å¾ªç¯ï¼Œå¯ä»¥ä½¿ç”¨ Python å†…ç½®çš„<code>enumerate</code> å‡½æ•°å¯ä»¥æŠŠä¸€ä¸ª list å˜æˆç´¢å¼•-å…ƒç´ å¯¹ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨for å¾ªç¯ä¸­åŒæ—¶è¿­ä»£ç´¢å¼•å’Œå…ƒç´ æœ¬èº«</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, value <span class="keyword">in</span> <span class="built_in">enumerate</span>([<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]):</span><br><span class="line">    <span class="built_in">print</span>(i, value)</span><br><span class="line"><span class="comment"># 0 A</span></span><br><span class="line"><span class="comment"># 1 B</span></span><br><span class="line"><span class="comment"># 2 C</span></span><br></pre></td></tr></table></figure><p>Python ä¸­ä¹Ÿå¯ä»¥åŒæ—¶å¼•ç”¨å¤šä¸ªå˜é‡è¿›è¡Œ for å¾ªç¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> name, age <span class="keyword">in</span> (<span class="string">&#x27;å¼ ä¸‰&#x27;</span>, <span class="number">20</span>), (<span class="string">&#x27;æå››&#x27;</span>, <span class="number">21</span>), (<span class="string">&#x27;ç‹äº”&#x27;</span>, <span class="number">20</span>):</span><br><span class="line">    <span class="built_in">print</span>(age, name)</span><br><span class="line"><span class="comment"># 20 å¼ ä¸‰</span></span><br><span class="line"><span class="comment"># 21 æå››</span></span><br><span class="line"><span class="comment"># 20 ç‹äº”</span></span><br></pre></td></tr></table></figure><h2 id="åˆ—è¡¨ç”Ÿæˆå¼">åˆ—è¡¨ç”Ÿæˆå¼</h2><p>åˆ—è¡¨ç”Ÿæˆå¼å³ List Comprehensionsï¼Œæ˜¯ Pythonå†…ç½®çš„éå¸¸ç®€å•å´å¼ºå¤§çš„å¯ä»¥ç”¨æ¥åˆ›å»º list çš„ç”Ÿæˆå¼</p><p>å¦‚æœè¦ç”Ÿæˆ <code>[1x1, 2x2, 3x3, ..., 10x10]</code> çš„ listæ–¹æ³•ä¸€æ˜¯å¾ªç¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">l = []</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>):</span><br><span class="line">    l.append(x * x)</span><br><span class="line"><span class="built_in">print</span>(l)</span><br><span class="line"><span class="comment"># [1, 4, 9, 16, 25, 36, 49, 64, 81, 100]</span></span><br></pre></td></tr></table></figure><p>è€Œåˆ—è¡¨ç”Ÿæˆå¼åˆ™å¯ä»¥ç”¨ä¸€è¡Œè¯­å¥ä»£æ›¿å¾ªç¯ç”Ÿæˆä¸Šé¢çš„ list</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l = [x * x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>)]</span><br><span class="line"><span class="built_in">print</span>(l)</span><br><span class="line"><span class="comment"># [1, 4, 9, 16, 25, 36, 49, 64, 81, 100]</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ä½¿ç”¨ä¸¤å±‚å¾ªç¯ï¼Œå¯ä»¥ç”Ÿæˆå…¨æ’åˆ—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l = [m + n <span class="keyword">for</span> m <span class="keyword">in</span> [<span class="string">&#x27;è‰è“å‘³&#x27;</span>, <span class="string">&#x27;æŸ æª¬å‘³&#x27;</span>, <span class="string">&#x27;è èå‘³&#x27;</span>] <span class="keyword">for</span> n <span class="keyword">in</span> [<span class="string">&#x27;æ£’æ£’ç³–&#x27;</span>, <span class="string">&#x27;å£é¦™ç³–&#x27;</span>, <span class="string">&#x27;æ°´æœèŒ¶&#x27;</span>]]</span><br><span class="line"><span class="built_in">print</span>(l)</span><br><span class="line"><span class="comment"># [&#x27;è‰è“å‘³æ£’æ£’ç³–&#x27;, &#x27;è‰è“å‘³å£é¦™ç³–&#x27;, &#x27;è‰è“å‘³æ°´æœèŒ¶&#x27;, &#x27;æŸ æª¬å‘³æ£’æ£’ç³–&#x27;, &#x27;æŸ æª¬å‘³å£é¦™ç³–&#x27;, &#x27;æŸ æª¬å‘³æ°´æœèŒ¶&#x27;, &#x27;è èå‘³æ£’æ£’ç³–&#x27;, &#x27;è èå‘³å£é¦™ç³–&#x27;, &#x27;è èå‘³æ°´æœèŒ¶&#x27;]</span></span><br></pre></td></tr></table></figure><p><strong>if ... else ...</strong></p><p>åœ¨ç”Ÿæˆå¼ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>if ... else</code></p><p>éœ€è¦æ³¨æ„åœ¨ä¸€ä¸ªåˆ—è¡¨ç”Ÿæˆå¼ä¸­ï¼Œ<code>for</code> å‰é¢çš„<code>if ... else</code> æ˜¯è¡¨è¾¾å¼ï¼Œè€Œ <code>for</code> åé¢çš„<code>if</code> æ˜¯è¿‡æ»¤æ¡ä»¶ï¼Œä¸èƒ½å¸¦ <code>else</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ [0,10) èŒƒå›´ä¸­å–å‡º x % 2 == 0 çš„æ•°å­—</span></span><br><span class="line">l = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(l)</span><br><span class="line"><span class="comment"># [0, 2, 4, 6, 8]</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœ x % 2 != 0ï¼Œåˆ™å– &#x27;x&#x27;</span></span><br><span class="line">l = [x <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">else</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>)]</span><br><span class="line"><span class="built_in">print</span>(l)</span><br><span class="line"><span class="comment"># [0, &#x27;x&#x27;, 2, &#x27;x&#x27;, 4, &#x27;x&#x27;, 6, &#x27;x&#x27;, 8, &#x27;x&#x27;]</span></span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆå™¨">ç”Ÿæˆå™¨</h2><p>åœ¨ Python ä¸­ï¼Œä¸€è¾¹å¾ªç¯ä¸€è¾¹è®¡ç®—çš„æœºåˆ¶ï¼Œç§°ä¸ºç”Ÿæˆå™¨ Generator</p><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼Œåªè¦æŠŠä¸€ä¸ªåˆ—è¡¨ç”Ÿæˆå¼çš„ <code>[]</code> æ”¹æˆ<code>()</code>ï¼Œå°±åˆ›å»ºäº†ä¸€ä¸ª generator</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l = (x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(l) <span class="comment"># &lt;generator object &lt;genexpr&gt; at 0x000002293F899630&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(l)) <span class="comment"># &lt;class &#x27;generator&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>è·å–ç”Ÿæˆå™¨å…ƒç´ æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>next</code>ï¼Œä¹Ÿå¯ä»¥å°†å…¶ä½œä¸ºè¿­ä»£å™¨å¾ªç¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">l = (x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(l))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(l))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">------------</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">8</span></span><br></pre></td></tr></table></figure><p>åŒç†ä¹Ÿå¯ä»¥å°†è¿­ä»£å™¨è¾“å‡ºä¸º list</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(l.__iter__()))</span><br><span class="line"><span class="comment"># [0, 2, 4, 6, 8]</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ¨ç®—çš„ç®—æ³•æ¯”è¾ƒå¤æ‚ï¼Œç”¨ç±»ä¼¼åˆ—è¡¨ç”Ÿæˆå¼çš„ <code>for</code>å¾ªç¯æ— æ³•å®ç°çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ç”¨å‡½æ•°æ¥å®ç°</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ–æ³¢é‚£å¥‘æ•°åˆ—çš„å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fib</span>(<span class="params"><span class="built_in">max</span></span>):</span><br><span class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="built_in">max</span>:</span><br><span class="line">        <span class="built_in">print</span>(b)</span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;done&#x27;</span></span><br></pre></td></tr></table></figure><p>åªéœ€è¦æŠŠ <code>print(b)</code> æ”¹ä¸º <code>yield b</code>å°±ä¿®æ”¹ä¸ºäº†ç”Ÿæˆå™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fib</span>(<span class="params"><span class="built_in">max</span></span>):</span><br><span class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="built_in">max</span>:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;done&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(fib(<span class="number">10</span>).__iter__()))</span><br><span class="line"><span class="comment"># [1, 1, 2, 3, 5, 8, 13, 21, 34, 55]</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ï¼š</p><ul><li>å‡½æ•°ç”Ÿæˆå™¨é‡åˆ° <code>yield</code> è¯­å¥è¿”å›ï¼Œå†æ¬¡æ‰§è¡Œæ—¶ä»ä¸Šæ¬¡è¿”å›çš„<code>yield</code> è¯­å¥å¤„ç»§ç»­æ‰§è¡Œ</li><li>æ²¡æœ‰ <code>yield</code> æ‰§è¡Œæ—¶ä¼šæŠ¥é”™ <code>StopIteration</code></li><li>è°ƒç”¨ generator å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ª generator å¯¹è±¡ï¼Œå¤šæ¬¡è°ƒç”¨ generatorå‡½æ•°ä¼šåˆ›å»ºå¤šä¸ªç›¸äº’ç‹¬ç«‹çš„ generator</li></ul><p>æ­¤å¤–ï¼Œç”Ÿæˆå™¨å‡½æ•°ä¸­çš„ <code>return</code> ä¼šè¢«å½“åš<code>StopIteration</code>å¼‚å¸¸æŠ›å‡ºï¼Œå¦‚æœæƒ³è¦è·å–è¿”å›å€¼ï¼Œéœ€è¦è§£æå¼‚å¸¸ï¼›å¹¶ä¸”è¿­ä»£å™¨ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦ä½¿ç”¨<code>next</code> è·å–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">return_gen</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> return_gen():</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;------------&quot;</span>)</span><br><span class="line">rg = return_gen()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = <span class="built_in">next</span>(rg)</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;return value:&#x27;</span> + <span class="built_in">str</span>(e.value))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">------------</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="keyword">return</span> value:<span class="number">100</span></span><br></pre></td></tr></table></figure><h2 id="è¿­ä»£å™¨">è¿­ä»£å™¨</h2><p>å‰é¢å·²ç»äº†è§£åˆ°å¯ä»¥ç›´æ¥ä½œç”¨äº <code>for</code>å¾ªç¯çš„æ•°æ®ç±»å‹æœ‰ä»¥ä¸‹å‡ ç§</p><ul><li>é›†åˆæ•°æ®ç±»å‹ï¼Œå¦‚ listã€tupleã€dictã€setã€str ç­‰</li><li>ç”Ÿæˆå™¨ï¼ŒåŒ…æ‹¬ç”Ÿæˆå™¨å’Œå¸¦ yield çš„ç”Ÿæˆå™¨å‡½æ•°</li></ul><p>è¿™äº›å¯ä»¥ç›´æ¥ä½œç”¨äº <code>for</code>å¾ªç¯çš„å¯¹è±¡ç»Ÿç§°ä¸º<strong>å¯è¿­ä»£å¯¹è±¡</strong>ï¼š<code>Iterable</code></p><p>å¯ä»¥ä½¿ç”¨ <code>isinstance</code> åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯<code>Iterable</code> å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>([], Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(&#123;&#125;, Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>((x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)), Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="string">&#x27;a&#x27;</span>, Iterable)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="number">1</span>, Iterable)) <span class="comment"># False</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥è¢« <code>next</code>å‡½æ•°è°ƒç”¨å¹¶ä¸æ–­è¿”å›ä¸‹ä¸€ä¸ªå€¼çš„å¯¹è±¡ç§°ä¸º<strong>è¿­ä»£å™¨</strong>ï¼š<code>Iterator</code></p><p>å¯ä»¥ä½¿ç”¨ <code>isinstance</code> åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯<code>Iterator</code> å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>([], Iterator)) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(&#123;&#125;, Iterator)) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>((x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)), Iterator)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="string">&#x27;a&#x27;</span>, Iterator)) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="number">1</span>, Iterator)) <span class="comment"># False</span></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆå™¨éƒ½æ˜¯ <code>Iterator</code> å¯¹è±¡ï¼Œä½† listã€dictã€str è™½ç„¶æ˜¯<code>Iterable</code>ï¼Œå´ä¸æ˜¯ <code>Iterator</code></p><p>æŠŠ listã€dictã€str ç­‰ <code>Iterable</code> å˜æˆ<code>Iterator</code> å¯ä»¥ä½¿ç”¨ <code>iter</code> å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="built_in">iter</span>([]), Iterator)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="built_in">iter</span>(&#123;&#125;), Iterator)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="built_in">iter</span>(<span class="string">&#x27;a&#x27;</span>), Iterator)) <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ listã€dictã€str ç­‰æ•°æ®ç±»å‹ä¸æ˜¯ <code>Iterator</code>ï¼Ÿ</p><p>å› ä¸º Python çš„ <code>Iterator</code>å¯¹è±¡è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œ<code>Iterator</code> å¯¹è±¡å¯ä»¥è¢«<code>next</code> å‡½æ•°è°ƒç”¨å¹¶ä¸æ–­è¿”å›ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œç›´åˆ°æ²¡æœ‰æ•°æ®æ—¶æŠ›å‡º<code>StopIteration</code> é”™è¯¯</p><p>å¯ä»¥æŠŠè¿™ä¸ªæ•°æ®æµçœ‹åšæ˜¯ä¸€ä¸ªæœ‰åºåºåˆ—ï¼Œä½†æˆ‘ä»¬å´ä¸èƒ½æå‰çŸ¥é“åºåˆ—çš„é•¿åº¦ï¼Œåªèƒ½ä¸æ–­é€šè¿‡<code>next</code> å‡½æ•°å®ç°æŒ‰éœ€è®¡ç®—ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œæ‰€ä»¥ <code>Iterator</code>çš„è®¡ç®—æ˜¯æƒ°æ€§çš„ï¼Œåªæœ‰åœ¨éœ€è¦è¿”å›ä¸‹ä¸€ä¸ªæ•°æ®æ—¶å®ƒæ‰ä¼šè®¡ç®—</p><h1 id="å‡½æ•°å¼ç¼–ç¨‹">å‡½æ•°å¼ç¼–ç¨‹</h1><h2 id="é«˜é˜¶å‡½æ•°">é«˜é˜¶å‡½æ•°</h2><p>ä¸€ä¸ªå‡½æ•°æ¥æ”¶å¦ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿™ç§å‡½æ•°å°±ç§°ä¹‹ä¸ºé«˜é˜¶å‡½æ•°ï¼ˆJava ä¸­çš„Functionï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y, f</span>):</span><br><span class="line">    <span class="keyword">return</span> f(x) + f(y)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">3</span>, -<span class="number">5</span>, <span class="built_in">abs</span>))</span><br><span class="line"><span class="comment"># 8</span></span><br></pre></td></tr></table></figure><p><strong>map</strong></p><p><code>map</code> å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯<code>Iterable</code>ï¼Œ<code>map</code>å°†ä¼ å…¥çš„å‡½æ•°ä¾æ¬¡ä½œç”¨åˆ°åºåˆ—çš„æ¯ä¸ªå…ƒç´ ï¼Œå¹¶æŠŠç»“æœä½œä¸ºæ–°çš„<code>Iterator</code> è¿”å›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">o_list = [-<span class="number">1</span>, <span class="number">2</span>, -<span class="number">3</span>, -<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">n_list = <span class="built_in">map</span>(<span class="built_in">abs</span>, o_list)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(n_list))</span><br><span class="line"><span class="comment"># [1, 2, 3, 4, 5, 6]</span></span><br></pre></td></tr></table></figure><p><strong>reduce</strong></p><p><code>reduce</code> æŠŠä¸€ä¸ªå‡½æ•°ä½œç”¨åœ¨ä¸€ä¸ªåºåˆ—<code>[x1, x2, x3, ...]</code>ä¸Šï¼Œè¿™ä¸ªå‡½æ•°å¿…é¡»æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œ<code>reduce</code>æŠŠç»“æœç»§ç»­å’Œåºåˆ—çš„ä¸‹ä¸€ä¸ªå…ƒç´ åšç´¯ç§¯è®¡ç®—ï¼Œå…¶æ•ˆæœè§†ä¸º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reduce(f, [x1, x2, x3, x4]) = f(f(f(x1, x2), x3), x4)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x * <span class="number">10</span> + y</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(reduce(fn, [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]))</span><br><span class="line"><span class="comment"># 13579</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DIGITS = &#123;<span class="string">&#x27;0&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;3&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;4&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;5&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;6&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;7&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;8&#x27;</span>: <span class="number">8</span>, <span class="string">&#x27;9&#x27;</span>: <span class="number">9</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">char2num</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> DIGITS[s]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str2int</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> x, y: x * <span class="number">10</span> + y, <span class="built_in">map</span>(char2num, s))</span><br><span class="line"></span><br><span class="line">i = str2int(<span class="string">&quot;1234&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(i) <span class="comment"># 1234</span></span><br><span class="line"><span class="built_in">print</span>(i.__class__) <span class="comment"># &lt;class &#x27;int&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p><strong>filter</strong></p><p><code>filter</code> ä¹Ÿæ¥æ”¶ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªåºåˆ—</p><p>æŠŠä¼ å…¥çš„å‡½æ•°ä¾æ¬¡ä½œç”¨äºæ¯ä¸ªå…ƒç´ ï¼Œç„¶åæ ¹æ®è¿”å›å€¼æ˜¯ <code>True</code>è¿˜æ˜¯ <code>False</code> å†³å®šä¿ç•™è¿˜æ˜¯ä¸¢å¼ƒè¯¥å…ƒç´ </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">not_empty</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s <span class="keyword">and</span> s.strip()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">filter</span>(not_empty, [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;  &#x27;</span>])))</span><br><span class="line"><span class="comment"># [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ <code>filter</code>ä½¿ç”¨äº†æƒ°æ€§è®¡ç®—ï¼Œæ‰€ä»¥åªæœ‰åœ¨å–ç»“æœçš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£ç­›é€‰å¹¶æ¯æ¬¡è¿”å›ä¸‹ä¸€ä¸ªç­›å‡ºçš„å…ƒç´ </p><p><strong>sort</strong></p><p>å¦‚æœæ˜¯å­—ç¬¦ä¸²æˆ–è€…ä¸¤ä¸ª dictç›´æ¥æ¯”è¾ƒæ•°å­¦ä¸Šçš„å¤§å°æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤æ¯”è¾ƒçš„è¿‡ç¨‹å¿…é¡»é€šè¿‡å‡½æ•°æŠ½è±¡å‡ºæ¥</p><p>ç›´æ¥æ’åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span> = <span class="built_in">sorted</span>([<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;lisi&quot;</span>, <span class="string">&quot;wangwu&quot;</span>, <span class="string">&quot;zhaoliu&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>)</span><br><span class="line"><span class="comment"># [&#x27;lisi&#x27;, &#x27;wangwu&#x27;, &#x27;zhangsan&#x27;, &#x27;zhaoliu&#x27;]</span></span><br></pre></td></tr></table></figure><p><code>sorted</code> å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå®ƒè¿˜å¯ä»¥æ¥æ”¶ä¸€ä¸ª<code>key</code> å‡½æ•°æ¥å®ç°è‡ªå®šä¹‰çš„æ’åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span> = <span class="built_in">sorted</span>([<span class="number">10</span>, -<span class="number">5</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">7</span>, <span class="number">3</span>], key=<span class="built_in">abs</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>)</span><br><span class="line"><span class="comment"># [0, 1, 3, -5, -7, 10]</span></span><br></pre></td></tr></table></figure><p><code>reverse</code> å¯ä»¥æ§åˆ¶é¡ºé€†åºï¼Œé€†åºä¸ºç”±å¤§åˆ°å°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span> = <span class="built_in">sorted</span>([<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;lisi&quot;</span>, <span class="string">&quot;wangwu&quot;</span>, <span class="string">&quot;zhaoliu&quot;</span>, <span class="string">&quot;a&quot;</span>], key=<span class="built_in">str</span>.__len__, reverse=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>)</span><br><span class="line"><span class="comment"># [&#x27;zhangsan&#x27;, &#x27;zhaoliu&#x27;, &#x27;wangwu&#x27;, &#x27;lisi&#x27;, &#x27;a&#x27;]</span></span><br></pre></td></tr></table></figure><h2 id="å‡½æ•°è¿”å›å€¼">å‡½æ•°è¿”å›å€¼</h2><p>é«˜é˜¶å‡½æ•°é™¤äº†å¯ä»¥æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°å¤–ï¼Œè¿˜å¯ä»¥æŠŠå‡½æ•°ä½œä¸ºç»“æœå€¼è¿”å›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lazy_sum</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sum</span>():</span><br><span class="line">        ax = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> args:</span><br><span class="line">            ax = ax + n</span><br><span class="line">        <span class="keyword">return</span> ax</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lazy_sum = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(lazy_sum()) <span class="comment"># 10</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨å‡½æ•° <code>lazy_sum</code> æ—¶ï¼Œæ‰çœŸæ­£è®¡ç®—æ±‚å’Œçš„ç»“æœ</p><p>å½“è°ƒç”¨<code>lazy_sum()</code>æ—¶ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œå³ä½¿ä¼ å…¥ç›¸åŒçš„å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lazy_sum1 = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">lazy_sum2 = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(lazy_sum1 == lazy_sum2) <span class="comment"># False</span></span><br></pre></td></tr></table></figure><h2 id="é—­åŒ…">é—­åŒ…</h2><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°<code>lazy_sum</code>ä¸­åˆå®šä¹‰äº†å‡½æ•°<code>sum</code>ï¼Œå¹¶ä¸”ï¼Œå†…éƒ¨å‡½æ•°<code>sum</code>å¯ä»¥å¼•ç”¨å¤–éƒ¨å‡½æ•°<code>lazy_sum</code>çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ï¼Œå½“<code>lazy_sum</code>è¿”å›å‡½æ•°<code>sum</code>æ—¶ï¼Œç›¸å…³å‚æ•°å’Œå˜é‡éƒ½ä¿å­˜åœ¨è¿”å›çš„å‡½æ•°ä¸­</p><p>è¿™ç§ç¨‹åºç»“æ„å°±è¢«ç§°ä¸ºé—­åŒ…ï¼ˆClosureï¼‰</p><p>ä½¿ç”¨é—­åŒ…æ—¶éœ€è¦æ³¨æ„</p><ul><li>è¿”å›é—­åŒ…å‡½æ•°ä¸è¦å¼•ç”¨ä»»ä½•å¾ªç¯å˜é‡ï¼Œæˆ–è€…åç»­ä¼šå‘ç”Ÿå˜åŒ–çš„å˜é‡</li><li>ä½¿ç”¨é—­åŒ…æ—¶ï¼Œå¯¹å¤–å±‚å˜é‡èµ‹å€¼å‰ï¼Œéœ€è¦å…ˆä½¿ç”¨ <code>nonlocal</code>å£°æ˜è¯¥å˜é‡ä¸æ˜¯å½“å‰å‡½æ•°çš„å±€éƒ¨å˜é‡</li><li>è¿”å›çš„å‡½æ•°å¹¶ä¸æ˜¯ç«‹åˆ»æ‰§è¡Œï¼Œè€Œæ˜¯ç›´åˆ°è°ƒç”¨æ‰æ‰§è¡Œ</li></ul><p><strong>è¿™æ˜¯ä¸€ä¸ªé—®é¢˜ç¤ºä¾‹</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">count</span>():</span><br><span class="line">    fs = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">4</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">f</span>():</span><br><span class="line">            <span class="keyword">return</span> i * i</span><br><span class="line"></span><br><span class="line">        fs.append(f)</span><br><span class="line">    <span class="keyword">return</span> fs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f1, f2, f3 = count()</span><br><span class="line"><span class="built_in">print</span>([f1(), f2(), f3()])</span><br><span class="line"><span class="comment"># [9, 9, 9]</span></span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šè°ƒç”¨ <code>f1</code> ç­‰å‡½æ•°ä¼šå‘ç°ï¼Œç»“æœéƒ½æ˜¯<code>9</code>ï¼ŒåŸå› æ˜¯è¿”å›çš„å‡½æ•°å¼•ç”¨äº†å˜é‡<code>i</code>ï¼Œä½†å®ƒå¹¶éç«‹åˆ»æ‰§è¡Œï¼Œç­‰åˆ° 3ä¸ªå‡½æ•°éƒ½è¿”å›æ—¶ï¼Œå®ƒä»¬æ‰€å¼•ç”¨çš„å˜é‡ <code>i</code> å·²ç»å˜æˆäº†<code>3</code>ï¼Œå› æ­¤æœ€ç»ˆç»“æœä¸º <code>9</code></p><p>å¦‚æœä¸€å®šè¦å¼•ç”¨å¾ªç¯å˜é‡æ€ä¹ˆåŠï¼Ÿæ–¹æ³•æ˜¯å†åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œç”¨è¯¥å‡½æ•°çš„å‚æ•°ç»‘å®šå¾ªç¯å˜é‡å½“å‰çš„å€¼ï¼Œæ— è®ºè¯¥å¾ªç¯å˜é‡åç»­å¦‚ä½•æ›´æ”¹ï¼Œå·²ç»‘å®šåˆ°å‡½æ•°å‚æ•°çš„å€¼ä¸å˜</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">count</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">j</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">g</span>():</span><br><span class="line">            <span class="keyword">return</span> j * j</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line">    fs = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">4</span>):</span><br><span class="line">        fs.append(f(i))  <span class="comment"># f(i)ç«‹åˆ»è¢«æ‰§è¡Œï¼Œå› æ­¤içš„å½“å‰å€¼è¢«ä¼ å…¥f()</span></span><br><span class="line">    <span class="keyword">return</span> fs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f1, f2, f3 = count()</span><br><span class="line"><span class="built_in">print</span>([f1(), f2(), f3()])</span><br><span class="line"><span class="comment"># [1, 4, 9]</span></span><br></pre></td></tr></table></figure><p><strong>nonlocal</strong></p><p>ä½¿ç”¨é—­åŒ…ï¼Œå°±æ˜¯å†…å±‚å‡½æ•°å¼•ç”¨äº†å¤–å±‚å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œå¯ä»¥è¯»å–å€¼ï¼Œä½†æ˜¯èµ‹å€¼æ—¶Python è§£é‡Šå™¨ä¼šè®¤ä¸ºå¯¹å±€éƒ¨å˜é‡èµ‹å€¼ï¼Œå°±ä¼šæŠ¥é”™</p><p>å¯ä»¥åŠ ä¸Š <code>nonlocal</code>å£°æ˜ï¼Œå£°æ˜åè§£é‡Šå™¨ä¼šæŠŠå˜é‡çœ‹ä½œå¤–å±‚å‡½æ•°çš„å±€éƒ¨å˜é‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">count</span>():</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">f</span>():</span><br><span class="line">        <span class="keyword">nonlocal</span> count</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(count)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = count()</span><br><span class="line">f() <span class="comment"># 1</span></span><br><span class="line">f() <span class="comment"># 2</span></span><br><span class="line">f() <span class="comment"># 3</span></span><br></pre></td></tr></table></figure><h2 id="åŒ¿åå‡½æ•°">åŒ¿åå‡½æ•°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x * x, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]))</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œå…³é”®å­— <code>lambda</code> è¡¨ç¤ºåŒ¿åå‡½æ•°ï¼Œå†’å·å‰é¢çš„<code>x</code> è¡¨ç¤ºå‡½æ•°å‚æ•°</p><p>åŒ¿åå‡½æ•°åªèƒ½æœ‰ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¸ç”¨å†™<code>return</code>ï¼Œè¿”å›å€¼å°±æ˜¯è¯¥è¡¨è¾¾å¼çš„ç»“æœ</p><p>åŒ¿åå‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æŠŠåŒ¿åå‡½æ•°èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œå†åˆ©ç”¨å˜é‡æ¥è°ƒç”¨è¯¥å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="keyword">lambda</span>: <span class="built_in">print</span>(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">f()</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œä¹Ÿå¯ä»¥æŠŠåŒ¿åå‡½æ•°ä½œä¸ºè¿”å›å€¼è¿”å›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">lambda</span>: x + y</span><br><span class="line"></span><br><span class="line">f = add(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(f()) <span class="comment"># 7</span></span><br></pre></td></tr></table></figure><h2 id="è£…é¥°å™¨">è£…é¥°å™¨</h2><h2 id="åå‡½æ•°">åå‡½æ•°</h2><p><code>functools.partial</code> å¯ä»¥å¸®åŠ©åˆ›å»ºä¸€ä¸ªåå‡½æ•°</p><p>æŠŠä¸€ä¸ªå‡½æ•°çš„æŸäº›å‚æ•°ç»™å›ºå®šä½ï¼ˆä¹Ÿå°±æ˜¯è®¾ç½®é»˜è®¤å€¼ï¼‰ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œä½¿å¾—è°ƒç”¨è¿™ä¸ªæ–°å‡½æ•°ä¼šæ›´ç®€å•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello &quot;</span> + name + <span class="string">&quot;!&quot;</span>)</span><br><span class="line"></span><br><span class="line">fun2 = functools.partial(hello, name=<span class="string">&#x27;World&#x27;</span>)</span><br><span class="line">fun2() <span class="comment"># Hello World!</span></span><br><span class="line">fun2(name=<span class="string">&#x27;Tomorrow&#x27;</span>) <span class="comment"># Hello Tomorrow!</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºåå‡½æ•°æ—¶ï¼Œå®é™…ä¸Šå¯ä»¥æ¥æ”¶å‡½æ•°å¯¹è±¡ã€<code>*args</code> å’Œ<code>**kw</code> 3 ä¸ªå‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max2 = functools.partial(<span class="built_in">max</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šä¼šæŠŠ <code>10</code> ä½œä¸º <code>*args</code>çš„ä¸€éƒ¨åˆ†è‡ªåŠ¨åŠ åˆ°å·¦è¾¹ï¼Œä¹Ÿå°±æ˜¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">max2(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>)</span><br><span class="line"><span class="comment"># &gt;&gt; å®é™…ä¸Šç­‰åŒäº args = (10, 5, 6, 7) max(*args) çš„è°ƒç”¨</span></span><br><span class="line"><span class="comment"># ç»“æœä¸º 10</span></span><br></pre></td></tr></table></figure><h1 id="é¢å‘å¯¹è±¡">é¢å‘å¯¹è±¡</h1><h2 id="è®¿é—®é™åˆ¶">è®¿é—®é™åˆ¶</h2><p>åœ¨ Python ä¸­ï¼Œå®ä¾‹çš„å˜é‡åå¦‚æœä»¥ <code>__</code>å¼€å¤´ï¼Œå°±å˜æˆäº†ä¸€ä¸ªç§æœ‰å˜é‡ï¼ˆprivateï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, score</span>):</span><br><span class="line">        self.__name = name</span><br><span class="line">        self.score = score</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">print_score</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s: %s&#x27;</span> % (self.__name, self.__score))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = Student(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(s.score) <span class="comment"># 100</span></span><br><span class="line"><span class="built_in">print</span>(s.__name) <span class="comment"># AttributeError: &#x27;Student&#x27; object has no attribute &#x27;__name&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„</strong></p><ul><li>åœ¨ Python ä¸­ï¼Œå˜é‡åç±»ä¼¼ <code>__xxx__</code>ï¼Œä¹Ÿå°±æ˜¯ä»¥åŒä¸‹åˆ’çº¿å¼€å¤´ï¼Œå¹¶ä¸”ä»¥åŒä¸‹åˆ’çº¿ç»“å°¾çš„ï¼Œæ˜¯ç‰¹æ®Šå˜é‡ï¼›ç‰¹æ®Šå˜é‡æ˜¯å¯ä»¥ç›´æ¥è®¿é—®çš„ï¼Œä¸æ˜¯ç§æœ‰å˜é‡</li><li>ä»¥ä¸€ä¸ªä¸‹åˆ’çº¿å¼€å¤´çš„å®ä¾‹å˜é‡åï¼Œæ¯”å¦‚<code>_name</code>ï¼Œè¿™æ ·çš„å®ä¾‹å˜é‡å¤–éƒ¨æ˜¯å¯ä»¥è®¿é—®çš„ï¼Œä½†æ˜¯ï¼ŒæŒ‰ç…§çº¦å®šä¿—æˆçš„è§„å®šï¼Œå½“ä½ çœ‹åˆ°è¿™æ ·çš„å˜é‡æ—¶ï¼Œæ„æ€ä¸ºâ€œè™½ç„¶æˆ‘å¯ä»¥è¢«è®¿é—®ï¼Œä½†æ˜¯è¯·æŠŠæˆ‘è§†ä¸ºç§æœ‰å˜é‡ï¼Œä¸è¦éšæ„è®¿é—®â€</li><li>åœ¨å¤–éƒ¨æ‰‹åŠ¨è®¾ç½®ç§æœ‰å±æ€§å’Œå¯¹è±¡çœŸæ­£çš„ç§æœ‰å±æ€§æ— å…³ï¼ˆå› ä¸ºå·²ç»è¢«æ”¹åï¼‰</li><li>æœ¬è´¨ä¸Šç§æœ‰çš„å®ç°åŸç†æ˜¯è§£é‡Šå™¨å˜æ›´äº†å±æ€§å</li></ul><h2 id="ç»§æ‰¿å’Œå¤šæ€">ç»§æ‰¿å’Œå¤šæ€</h2><p>Python çš„ç»§æ‰¿å’Œå¤šæ€å’Œ Java ç±»ä¼¼ï¼Œè¿™é‡Œåªåˆ—ä¸¾ä¸€äº› APIå’Œæ˜æ˜¾åŒºåˆ«çš„ç‚¹</p><p>åˆ¤æ–­ä¸€ä¸ªå˜é‡æ˜¯å¦æ˜¯æŸä¸ªç±»å‹å¯ä»¥ç”¨ <code>isinstance</code> åˆ¤æ–­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="number">123</span>, <span class="built_in">int</span>)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="string">&#x27;123&#x27;</span>, <span class="built_in">int</span>)) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="string">&#x27;123&#x27;</span>, <span class="built_in">str</span>)) <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p>å¯¹äºé™æ€è¯­è¨€ï¼ˆä¾‹å¦‚ Javaï¼‰æ¥è¯´ï¼Œå¦‚æœéœ€è¦ä¼ å…¥ <code>Animal</code>ç±»å‹ï¼Œåˆ™ä¼ å…¥çš„å¯¹è±¡å¿…é¡»æ˜¯ <code>Animal</code> ç±»å‹æˆ–è€…å®ƒçš„å­ç±»</p><p>å¯¹äº Python è¿™æ ·çš„åŠ¨æ€è¯­è¨€æ¥è¯´ï¼Œåˆ™ä¸ä¸€å®šéœ€è¦ä¼ å…¥ <code>Animal</code>ç±»å‹ï¼Œåªéœ€è¦å…·æœ‰ç›¸åŒçš„æ–¹æ³•å³å¯</p><p>è¿™å°±æ˜¯åŠ¨æ€è¯­è¨€çš„â€œé¸­å­ç±»å‹â€ï¼Œå®ƒå¹¶ä¸è¦æ±‚ä¸¥æ ¼çš„ç»§æ‰¿ä½“ç³»ï¼Œä¸€ä¸ªå¯¹è±¡åªè¦â€œçœ‹èµ·æ¥åƒé¸­å­ï¼Œèµ°èµ·è·¯æ¥åƒé¸­å­â€ï¼Œé‚£å®ƒå°±å¯ä»¥è¢«çœ‹åšæ˜¯é¸­å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Animal is running...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Dog is running...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Human</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Human is running...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_twice</span>(<span class="params">animal</span>):</span><br><span class="line">    animal.run()</span><br><span class="line">    animal.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ½å¯ä»¥è°ƒç”¨æˆåŠŸ</span></span><br><span class="line">run_twice(Dog())</span><br><span class="line">run_twice(Human())</span><br></pre></td></tr></table></figure><h2 id="å¯¹è±¡ä¿¡æ¯">å¯¹è±¡ä¿¡æ¯</h2><p>Python ä¸­å¯¹è±¡çš„å±æ€§å¯ä»¥ä¸ç”¨å®šä¹‰åœ¨ç±»ç»“æ„ä¸­</p><p>é‚£ä¹ˆå½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œå¦‚ä½•çŸ¥é“è¿™ä¸ªå¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ã€æœ‰å“ªäº›æ–¹æ³•å‘¢</p><ul><li><code>type</code> è·å–å¯¹è±¡ç±»å‹</li><li><code>isinstance</code> åˆ¤æ–­å¯¹è±¡æ˜¯å¦ç­‰äº or ç»§æ‰¿äºæŸç±»</li><li><code>dir</code> è¿”å›ä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²çš„listï¼ŒåŒ…å«ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Animal is running...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Dog is running...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(Animal()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(Dog()))</span><br><span class="line"><span class="comment"># [&#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;run&#x27;]</span></span><br></pre></td></tr></table></figure><p>é…åˆ <code>getattr</code>ã€<code>setattr</code> ä»¥åŠ<code>hasattr</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ“ä½œä¸€ä¸ªå¯¹è±¡çš„å±æ€§ï¼›ç±»ä¼¼ Javaçš„åå°„</p><ul><li><code>hasattr</code> æ˜¯å¦å…·æœ‰æŸå±æ€§</li><li><code>getattr</code> è·å–æŸå±æ€§</li><li><code>setattr</code> è®¾ç½®æŸå±æ€§</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.name = <span class="string">&#x27;zhangsan&#x27;</span></span><br><span class="line">        self.age = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">student = Student()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(student, <span class="string">&#x27;age&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">getattr</span>(student, <span class="string">&#x27;age&#x27;</span>)) <span class="comment"># 20</span></span><br><span class="line">    <span class="built_in">setattr</span>(student, <span class="string">&#x27;age&#x27;</span>, <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(student.age) <span class="comment"># 25</span></span><br></pre></td></tr></table></figure><h2 id="å®ä¾‹å±æ€§å’Œç±»å±æ€§">å®ä¾‹å±æ€§å’Œç±»å±æ€§</h2><p>å¯¹åº” Java ä¸­çš„é™æ€å˜é‡å’Œæˆå‘˜å˜é‡</p><p>ç»™å®ä¾‹ç»‘å®šå±æ€§çš„æ–¹æ³•æ˜¯é€šè¿‡å®ä¾‹å˜é‡ï¼Œæˆ–è€…é€šè¿‡ <code>self</code>å˜é‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">s = Student(<span class="string">&#x27;Bob&#x27;</span>)</span><br><span class="line">s.score = <span class="number">90</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>Student</code> ç±»æœ¬èº«éœ€è¦ç»‘å®šä¸€ä¸ªå±æ€§å‘¢ï¼Ÿå¯ä»¥ç›´æ¥åœ¨ classä¸­å®šä¹‰å±æ€§ï¼Œè¿™ç§å±æ€§æ˜¯ç±»å±æ€§ï¼Œå½’ <code>Student</code> ç±»æ‰€æœ‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    name = <span class="string">&#x27;Student&#x27;</span></span><br></pre></td></tr></table></figure><p>å¯¹è±¡å¯ä»¥è¦†ç›–åŒåç±»å±æ€§ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç±»ååŠ å±æ€§åè®¿é—®ç±»å±æ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    name = <span class="string">&quot;Student&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zhangsan = Student()</span><br><span class="line">zhangsan.name = <span class="string">&#x27;zhangsan&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(zhangsan.name) <span class="comment"># zhangsan</span></span><br><span class="line">lisi = Student()</span><br><span class="line"><span class="built_in">print</span>(lisi.name) <span class="comment"># Student</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Student.name) <span class="comment"># Student</span></span><br></pre></td></tr></table></figure><h2 id="slots__">__slots__</h2><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“å®šä¹‰äº†ä¸€ä¸ª classï¼Œåˆ›å»ºäº†ä¸€ä¸ª classçš„å®ä¾‹åå¯ä»¥ç»™è¯¥å®ä¾‹ç»‘å®šä»»ä½•å±æ€§å’Œæ–¹æ³•ï¼Œè¿™å°±æ˜¯åŠ¨æ€è¯­è¨€çš„çµæ´»æ€§</p><p>ä¹Ÿå¯ä»¥ç»™ class ç»‘å®šæ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    name = <span class="string">&quot;Student&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_score</span>(<span class="params">self, score</span>):</span><br><span class="line">    self.score = score</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">student = Student()</span><br><span class="line">Student.set_score = set_score</span><br><span class="line">student.set_score(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(student.score) <span class="comment"># 100</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦é™åˆ¶å®ä¾‹çš„å±æ€§ï¼ŒPython å…è®¸åœ¨å®šä¹‰ classçš„æ—¶å€™ï¼Œå®šä¹‰ä¸€ä¸ªç‰¹æ®Šçš„ <code>__slots__</code> å˜é‡ï¼Œæ¥é™åˆ¶è¯¥ classå®ä¾‹èƒ½æ·»åŠ çš„å±æ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment"># ç”¨tupleå®šä¹‰å…è®¸ç»‘å®šçš„å±æ€§åç§°</span></span><br><span class="line">    __slots__ = (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">student = Student()</span><br><span class="line">student.name = <span class="string">&#x27;zhangsan&#x27;</span></span><br><span class="line">student.score = <span class="number">50</span></span><br><span class="line"><span class="comment"># AttributeError: &#x27;Student&#x27; object has no attribute &#x27;score&#x27;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>__slots__</code> è¦æ³¨æ„ï¼Œ<code>__slots__</code>å®šä¹‰çš„å±æ€§ä»…å¯¹å½“å‰ç±»å®ä¾‹èµ·ä½œç”¨ï¼Œå¯¹ç»§æ‰¿çš„å­ç±»æ˜¯ä¸èµ·ä½œç”¨çš„</p><p>åœ¨å­ç±»ä¸­å®šä¹‰ <code>__slots__</code>ï¼Œå­ç±»å®ä¾‹å…è®¸å®šä¹‰çš„å±æ€§å°±æ˜¯è‡ªèº«çš„<code>__slots__</code> åŠ ä¸Šçˆ¶ç±»çš„ <code>__slots__</code></p><h2 id="property"><span class="citation"data-cites="property">@property</span></h2><p>Python å†…ç½®çš„ <code>@property</code>è£…é¥°å™¨å°±æ˜¯è´Ÿè´£æŠŠä¸€ä¸ªæ–¹æ³•å˜æˆå±æ€§è°ƒç”¨ï¼ˆå’Œ Java çš„ Lombok ç›¸åï¼‰</p><p>æŠŠä¸€ä¸ª getter æ–¹æ³•å˜æˆå±æ€§ï¼Œåªéœ€è¦åŠ ä¸Š <code>@property</code>å°±å¯ä»¥äº†</p><p><code>@property</code> æœ¬èº«åˆåˆ›å»ºäº†å¦ä¸€ä¸ªè£…é¥°å™¨<code>@score.setter</code>ï¼Œè´Ÿè´£æŠŠä¸€ä¸ª setter æ–¹æ³•å˜æˆå±æ€§èµ‹å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">score</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._score</span><br><span class="line"></span><br><span class="line"><span class="meta">    @score.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">score</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;score must be an integer!&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span> <span class="keyword">or</span> value &gt; <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;score must between 0 ~ 100!&#x27;</span>)</span><br><span class="line">        self._score = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">student = Student()</span><br><span class="line">student.score = <span class="number">100</span></span><br><span class="line">student.score = -<span class="number">1</span></span><br><span class="line"><span class="comment"># ValueError: score must between 0 ~ 100!</span></span><br></pre></td></tr></table></figure><p>è¦ç‰¹åˆ«æ³¨æ„ï¼šå±æ€§çš„æ–¹æ³•åä¸è¦å’Œå®ä¾‹å˜é‡é‡å</p><p>ä¾‹å¦‚ä»¥ä¸‹çš„é”™è¯¯ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ–¹æ³•åç§°å’Œå®ä¾‹å˜é‡å‡ä¸ºbirth:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">birth</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.birth</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºè°ƒç”¨ <code>s.birth</code> æ—¶ï¼Œé¦–å…ˆè½¬æ¢ä¸ºæ–¹æ³•è°ƒç”¨ï¼Œåœ¨æ‰§è¡Œ<code>return self.birth</code> æ—¶ï¼Œåˆè§†ä¸ºè®¿é—® <code>self</code>çš„å±æ€§ï¼Œäºæ˜¯åˆè½¬æ¢ä¸ºæ–¹æ³•è°ƒç”¨ï¼Œé€ æˆæ— é™é€’å½’ï¼Œæœ€ç»ˆå¯¼è‡´æ ˆæº¢å‡ºæŠ¥é”™<code>RecursionError</code></p><h2 id="å¤šé‡ç»§æ‰¿">å¤šé‡ç»§æ‰¿</h2><p>Pythonæ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå¦‚æœéœ€è¦â€œæ··å…¥â€é¢å¤–çš„åŠŸèƒ½ï¼Œé€šè¿‡å¤šé‡ç»§æ‰¿å°±å¯ä»¥å®ç°ï¼Œæ¯”å¦‚ï¼Œè®©<code>Ostrich</code> é™¤äº†ç»§æ‰¿è‡ª <code>Bird</code> å¤–ï¼Œå†åŒæ—¶ç»§æ‰¿<code>Runnable</code>ï¼Œè¿™ç§è®¾è®¡é€šå¸¸ç§°ä¹‹ä¸º <strong>MixIn</strong></p><p>ä¸ºäº†æ›´å¥½åœ°çœ‹å‡ºç»§æ‰¿å…³ç³»ï¼Œæˆ‘ä»¬æŠŠ <code>Runnable</code> å’Œ<code>Flyable</code> æ”¹ä¸º <code>RunnableMixIn</code> å’Œ<code>FlyableMixIn</code></p><p>ç±»ä¼¼çš„ï¼Œä½ è¿˜å¯ä»¥å®šä¹‰å‡ºè‚‰é£ŸåŠ¨ç‰© <code>CarnivorousMixIn</code>å’Œè‰é£ŸåŠ¨ç‰© <code>HerbivoresMixIn</code>ï¼Œè®©æŸä¸ªåŠ¨ç‰©åŒæ—¶æ‹¥æœ‰å¥½å‡ ä¸ªMixIn</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(Mammal, RunnableMixIn, CarnivorousMixIn):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>MixInçš„ç›®çš„å°±æ˜¯ç»™ä¸€ä¸ªç±»å¢åŠ å¤šä¸ªåŠŸèƒ½ï¼Œè¿™æ ·åœ¨è®¾è®¡ç±»çš„æ—¶å€™ï¼Œä¼˜å…ˆè€ƒè™‘é€šè¿‡å¤šé‡ç»§æ‰¿æ¥ç»„åˆå¤šä¸ªMixIn çš„åŠŸèƒ½ï¼Œè€Œä¸æ˜¯è®¾è®¡å¤šå±‚æ¬¡çš„å¤æ‚çš„ç»§æ‰¿å…³ç³»</p><p>Python è‡ªå¸¦çš„å¾ˆå¤šåº“ä¹Ÿä½¿ç”¨äº† MixInï¼›ä¾‹å¦‚ Python è‡ªå¸¦äº†<code>TCPServer</code> å’Œ <code>UDPServer</code>è¿™ä¸¤ç±»ç½‘ç»œæœåŠ¡ï¼Œè€Œè¦åŒæ—¶æœåŠ¡å¤šä¸ªç”¨æˆ·å°±å¿…é¡»ä½¿ç”¨å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹æ¨¡å‹ï¼Œè¿™ä¸¤ç§æ¨¡å‹ç”±<code>ForkingMixIn</code> å’Œ <code>ThreadingMixIn</code>æä¾›ï¼Œé€šè¿‡ç»„åˆï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›é€ å‡ºåˆé€‚çš„æœåŠ¡æ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤šè¿›ç¨‹æ¨¡å¼çš„ TCP æœåŠ¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTCPServer</span>(TCPServer, ForkingMixIn):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># å¤šçº¿ç¨‹æ¨¡å¼çš„ UDP æœåŠ¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyUDPServer</span>(UDPServer, ThreadingMixIn):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸éœ€è¦å¤æ‚è€Œåºå¤§çš„ç»§æ‰¿é“¾ï¼Œåªè¦é€‰æ‹©ç»„åˆä¸åŒçš„ç±»çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥å¿«é€Ÿæ„é€ å‡ºæ‰€éœ€çš„å­ç±»</p><h2 id="å®šåˆ¶æ–¹æ³•">å®šåˆ¶æ–¹æ³•</h2><p>çœ‹åˆ°ç±»ä¼¼ <code>__slots__</code> è¿™ç§å½¢å¦‚ <code>__xxx__</code>çš„å˜é‡æˆ–è€…å‡½æ•°åå°±è¦æ³¨æ„ï¼Œè¿™äº›åœ¨ Python ä¸­æ˜¯æœ‰ç‰¹æ®Šç”¨é€”çš„</p><p><strong>__str__</strong></p><p>è°ƒç”¨ <code>print</code> æ—¶ï¼Œä¼šè°ƒç”¨å¯¹è±¡çš„è¯¥æ–¹æ³•è¿›è¡Œæ‰“å°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.name = <span class="string">&#x27;zhangsan&#x27;</span></span><br><span class="line">        self.age = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;name:&#x27;</span> + self.name + <span class="string">&quot;, age:&quot;</span> + <span class="built_in">str</span>(self.age)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = Student()</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"><span class="comment"># name:zhangsan, age:20</span></span><br></pre></td></tr></table></figure><p><strong>__iter__</strong></p><p>å¦‚æœä¸€ä¸ªç±»æƒ³è¢«ç”¨äº <code>for ... in</code> å¾ªç¯ï¼Œç±»ä¼¼ list æˆ– tupleé‚£æ ·ï¼Œå°±å¿…é¡»å®ç°ä¸€ä¸ª <code>__iter__()</code> æ–¹æ³•</p><p>è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªè¿­ä»£å¯¹è±¡ï¼Œç„¶å Python çš„ forå¾ªç¯å°±ä¼šä¸æ–­è°ƒç”¨è¯¥è¿­ä»£å¯¹è±¡çš„ <code>__next__()</code>æ–¹æ³•æ‹¿åˆ°å¾ªç¯çš„ä¸‹ä¸€ä¸ªå€¼ï¼Œç›´åˆ°é‡åˆ° <code>StopIteration</code>é”™è¯¯æ—¶é€€å‡ºå¾ªç¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrimeNumber</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.current = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># å®ä¾‹æœ¬èº«å°±æ˜¯è¿­ä»£å¯¹è±¡ï¼Œæ•…è¿”å›è‡ªå·±</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.current + <span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, i + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> i % j == <span class="number">0</span>:</span><br><span class="line">                    count += <span class="number">1</span></span><br><span class="line">            <span class="comment"># æ˜¯è´¨æ•°</span></span><br><span class="line">            <span class="keyword">if</span> count &lt;= <span class="number">2</span>:</span><br><span class="line">                self.current = i</span><br><span class="line">                <span class="keyword">return</span> i</span><br><span class="line">        <span class="keyword">raise</span> StopIteration()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(PrimeNumber().__iter__()))</span><br><span class="line"><span class="comment"># [1, 2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97]</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç¤ºä¾‹å®ç°äº†ä¸€ä¸ª 100 ä»¥å†…ç´ æ•°çš„è¿­ä»£å™¨</p><p><strong>__getitem__</strong></p><p>ä¸Šé¢çš„ <code>PrimeNumber</code> è™½ç„¶å¯ä»¥è¿­ä»£ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½å½“ä½œ listä½¿ç”¨</p><p>è¦è¡¨ç°å¾—åƒ list é‚£æ ·æŒ‰ç…§ä¸‹æ ‡å–å‡ºå…ƒç´ ï¼Œéœ€è¦å®ç°<code>__getitem__</code> æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrimeNumber</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, n</span>):</span><br><span class="line">        current_index = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, i + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> i % j == <span class="number">0</span>:</span><br><span class="line">                    count += <span class="number">1</span></span><br><span class="line">            <span class="comment"># æ˜¯è´¨æ•°</span></span><br><span class="line">            <span class="keyword">if</span> count &lt;= <span class="number">2</span>:</span><br><span class="line">                current_index += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> current_index == n:</span><br><span class="line">                    <span class="keyword">return</span> i</span><br><span class="line">        <span class="keyword">return</span> current_index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pn = PrimeNumber()</span><br><span class="line"><span class="built_in">print</span>(pn[<span class="number">1</span>]) <span class="comment"># 2</span></span><br><span class="line"><span class="built_in">print</span>(pn[<span class="number">10</span>]) <span class="comment"># 29</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¿›ä¸€æ­¥å¸Œæœ›å…¶æ”¯æŒåˆ‡ç‰‡æ–¹æ³•ï¼Œéœ€è¦åˆ¤æ–­å…¥å‚æ˜¯å¦æ˜¯<code>slice</code>ï¼Œå†è¿›è¡Œä¸åŒçš„æ“ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrimeNumber</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(n, <span class="built_in">int</span>):  <span class="comment"># næ˜¯ç´¢å¼•</span></span><br><span class="line">            current_index = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">                count = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, i + <span class="number">1</span>):</span><br><span class="line">                    <span class="keyword">if</span> i % j == <span class="number">0</span>:</span><br><span class="line">                        count += <span class="number">1</span></span><br><span class="line">                <span class="comment"># æ˜¯è´¨æ•°</span></span><br><span class="line">                <span class="keyword">if</span> count &lt;= <span class="number">2</span>:</span><br><span class="line">                    current_index += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> current_index == n:</span><br><span class="line">                        <span class="keyword">return</span> i</span><br><span class="line">            <span class="keyword">return</span> current_index</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(n, <span class="built_in">slice</span>):  <span class="comment"># næ˜¯åˆ‡ç‰‡</span></span><br><span class="line">            start = n.start</span><br><span class="line">            stop = n.stop</span><br><span class="line">            <span class="keyword">if</span> start <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                start = <span class="number">0</span></span><br><span class="line">            res = []</span><br><span class="line">            current_index = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">                count = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, i + <span class="number">1</span>):</span><br><span class="line">                    <span class="keyword">if</span> i % j == <span class="number">0</span>:</span><br><span class="line">                        count += <span class="number">1</span></span><br><span class="line">                <span class="comment"># æ˜¯è´¨æ•°</span></span><br><span class="line">                <span class="keyword">if</span> count &lt;= <span class="number">2</span>:</span><br><span class="line">                    current_index += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> start &lt;= current_index &lt; stop:</span><br><span class="line">                        res.append(i)</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pn = PrimeNumber()</span><br><span class="line"><span class="built_in">print</span>(pn[<span class="number">1</span>:<span class="number">5</span>]) <span class="comment"># [2, 3, 5, 7]</span></span><br></pre></td></tr></table></figure><p>ï¼ˆåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼Œå®ç°çš„å¾ˆç²—ç³™ï¼‰</p><p>æ€»ä¹‹é€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œè‡ªå·±å®šä¹‰çš„ç±»è¡¨ç°å¾—å’Œ Python è‡ªå¸¦çš„listã€tupleã€dictæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œè¿™å®Œå…¨å½’åŠŸäºåŠ¨æ€è¯­è¨€çš„â€œé¸­å­ç±»å‹â€ï¼Œä¸éœ€è¦å¼ºåˆ¶ç»§æ‰¿æŸä¸ªæ¥å£</p><p><strong>__getattr__</strong></p><p>å½“è°ƒç”¨ä¸å­˜åœ¨çš„å±æ€§æ—¶ï¼Œæ¯”å¦‚ <code>score</code>ï¼ŒPythonè§£é‡Šå™¨ä¼šè¯•å›¾è°ƒç”¨ <code>__getattr__(self, 'score')</code>æ¥å°è¯•è·å¾—å±æ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.name = <span class="string">&#x27;Michael&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">        <span class="keyword">if</span> attr == <span class="string">&#x27;score&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">99</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Student().score) <span class="comment"># 99</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è¿”å›å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.name = <span class="string">&#x27;Michael&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_score</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">99</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> attr == <span class="string">&#x27;score&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> get_score</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = Student().score</span><br><span class="line"><span class="built_in">print</span>(f())</span><br></pre></td></tr></table></figure><p><strong>__call__</strong></p><p>ä¸€ä¸ªå¯¹è±¡å®ä¾‹å¯ä»¥æœ‰è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•ï¼Œå½“æˆ‘ä»¬è°ƒç”¨å®ä¾‹æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬ç”¨<code>instance.method()</code> æ¥è°ƒç”¨</p><p>è€Œä»»ä½•ç±»ï¼Œåªéœ€è¦å®šä¹‰ä¸€ä¸ª <code>__call__</code>æ–¹æ³•ï¼Œå°±å¯ä»¥ç›´æ¥å¯¹å®ä¾‹è¿›è¡Œè°ƒç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;My name is %s.&#x27;</span> % self.name)</span><br><span class="line"></span><br><span class="line">s = Student(<span class="string">&#x27;Michael&#x27;</span>)</span><br><span class="line">s() <span class="comment"># My name is Michael.</span></span><br></pre></td></tr></table></figure><p>å®Œå…¨å¯ä»¥æŠŠå¯¹è±¡çœ‹æˆå‡½æ•°ï¼ŒæŠŠå‡½æ•°çœ‹æˆå¯¹è±¡</p><p>é‚£ä¹ˆæ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªå˜é‡æ˜¯å¯¹è±¡è¿˜æ˜¯å‡½æ•°å‘¢ï¼Œèƒ½è¢«è°ƒç”¨çš„å¯¹è±¡å°±æ˜¯ä¸€ä¸ª<code>Callable</code> å¯¹è±¡ï¼Œæ¯”å¦‚å‡½æ•°å’Œä¸Šé¢å®šä¹‰çš„å¸¦æœ‰<code>__call__</code> çš„ç±»å®ä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;My name is %s.&#x27;</span> % self.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(Student(<span class="string">&#x27;zhangsan&#x27;</span>))) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(Student(<span class="string">&#x27;zhangsan&#x27;</span>).name)) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(Student(<span class="string">&#x27;zhangsan&#x27;</span>).__str__)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(Student(<span class="string">&#x27;zhangsan&#x27;</span>).__str__())) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(<span class="number">123</span>)) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(<span class="string">&#x27;123&#x27;</span>)) <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(<span class="keyword">lambda</span> x: <span class="built_in">print</span>(x))) <span class="comment"># True</span></span><br></pre></td></tr></table></figure><h2 id="æšä¸¾ç±»">æšä¸¾ç±»</h2><p>Python æä¾›äº† <code>Enum</code> ç±»æ¥å®ç°æšä¸¾ç±»çš„åŠŸèƒ½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Month = Enum(<span class="string">&#x27;Month&#x27;</span>, (<span class="string">&#x27;Jan&#x27;</span>, <span class="string">&#x27;Feb&#x27;</span>, <span class="string">&#x27;Mar&#x27;</span>, <span class="string">&#x27;Apr&#x27;</span>, <span class="string">&#x27;May&#x27;</span>, <span class="string">&#x27;Jun&#x27;</span>, <span class="string">&#x27;Jul&#x27;</span>, <span class="string">&#x27;Aug&#x27;</span>, <span class="string">&#x27;Sep&#x27;</span>, <span class="string">&#x27;Oct&#x27;</span>, <span class="string">&#x27;Nov&#x27;</span>, <span class="string">&#x27;Dec&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> name, member <span class="keyword">in</span> Month.__members__.items():</span><br><span class="line">    <span class="built_in">print</span>(name, <span class="string">&#x27;=&gt;&#x27;</span>, member, <span class="string">&#x27;,&#x27;</span>, member.value)</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>Month.Jan</code> æ¥å¼•ç”¨ä¸€ä¸ªå¸¸é‡ï¼Œæˆ–è€…ä½¿ç”¨<code>__members__</code> åˆ—ä¸¾æ‰€æœ‰æˆå‘˜</p><p><code>value</code> å±æ€§åˆ™æ˜¯è‡ªåŠ¨èµ‹ç»™æˆå‘˜çš„ <code>int</code>å¸¸é‡ï¼Œé»˜è®¤ä» <code>1</code> å¼€å§‹è®¡æ•°</p><p>å¦‚æœéœ€è¦æ›´ç²¾ç¡®åœ°æ§åˆ¶æšä¸¾ç±»å‹ï¼Œå¯ä»¥ä» <code>Enum</code>æ´¾ç”Ÿå‡ºè‡ªå®šä¹‰ç±»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@unique</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Weekday</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    Sun = <span class="number">0</span>  <span class="comment"># Sunçš„valueè¢«è®¾å®šä¸º0</span></span><br><span class="line">    Mon = <span class="number">1</span></span><br><span class="line">    Tue = <span class="number">2</span></span><br><span class="line">    Wed = <span class="number">3</span></span><br><span class="line">    Thu = <span class="number">4</span></span><br><span class="line">    Fri = <span class="number">5</span></span><br><span class="line">    Sat = <span class="number">6</span></span><br></pre></td></tr></table></figure><p><code>@unique</code> è£…é¥°å™¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ£€æŸ¥ä¿è¯æ²¡æœ‰é‡å¤å€¼</p><p>æ—¢å¯ä»¥ç”¨æˆå‘˜åç§°å¼•ç”¨æšä¸¾å¸¸é‡ï¼Œåˆå¯ä»¥ç›´æ¥æ ¹æ® valueçš„å€¼è·å¾—æšä¸¾å¸¸é‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(Weekday.Sat)</span><br><span class="line"><span class="built_in">print</span>(Weekday[<span class="string">&#x27;Sat&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(Weekday(<span class="number">6</span>))</span><br><span class="line"><span class="comment"># Weekday.Sat</span></span><br></pre></td></tr></table></figure><h2 id="å…ƒç±»">å…ƒç±»</h2><p>åŠ¨æ€è¯­è¨€å’Œé™æ€è¯­è¨€æœ€å¤§çš„ä¸åŒï¼Œå°±æ˜¯å‡½æ•°å’Œç±»çš„å®šä¹‰ä¸æ˜¯ç¼–è¯‘æ—¶å®šä¹‰çš„ï¼Œè€Œæ˜¯<strong>è¿è¡Œæ—¶åŠ¨æ€åˆ›å»º</strong>çš„</p><p><code>type</code> å‡½æ•°å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç±»å‹æˆ–å˜é‡çš„ç±»å‹ï¼Œä¸€ä¸ª classç±»å‹å°±æ˜¯ <code>type</code></p><p>åˆ›å»º class çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ <code>type</code> å‡½æ•°</p><p><code>type</code>å‡½æ•°æ—¢å¯ä»¥è¿”å›ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ï¼Œåˆå¯ä»¥åˆ›å»ºå‡ºæ–°çš„ç±»å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰å‡ºå‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">self, name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello &quot;</span> + name + <span class="string">&quot;!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ type åˆ›å»ºå‡º Student class</span></span><br><span class="line">Student = <span class="built_in">type</span>(<span class="string">&#x27;Student&#x27;</span>, (<span class="built_in">object</span>,), <span class="built_in">dict</span>(hello=hello))</span><br><span class="line"><span class="built_in">print</span>(Student) <span class="comment"># &lt;class &#x27;__main__.Student&#x27;&gt;</span></span><br><span class="line"><span class="comment"># åˆ›å»ºå®ä¾‹</span></span><br><span class="line">s = Student()</span><br><span class="line">s.hello(<span class="string">&#x27;zhangsan&#x27;</span>) <span class="comment"># Hello zhangsan!</span></span><br></pre></td></tr></table></figure><p><code>type</code> çš„å‚æ•°ï¼š</p><ul><li>class çš„åç§°</li><li>ç»§æ‰¿çš„çˆ¶ç±»é›†åˆï¼ˆæ³¨æ„ Python æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªçˆ¶ç±»ï¼Œåˆ«å¿˜äº†tuple çš„å•å…ƒç´ å†™æ³•ï¼‰</li><li>class çš„æ–¹æ³•åç§°ä¸å‡½æ•°ç»‘å®šï¼›ç¤ºä¾‹ä¸­å°† hello æ–¹æ³•åç»‘å®šä¸Šé¢å®šä¹‰çš„<code>hello</code> å‡½æ•°</li></ul><p>åŠ¨æ€è¯­è¨€æœ¬èº«æ”¯æŒè¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºç±»ï¼Œè¿™å’Œé™æ€è¯­è¨€æœ‰éå¸¸å¤§çš„ä¸åŒï¼Œè¦åœ¨é™æ€è¯­è¨€è¿è¡ŒæœŸåˆ›å»ºç±»ï¼Œå¿…é¡»æ„é€ æºä»£ç å­—ç¬¦ä¸²å†è°ƒç”¨ç¼–è¯‘å™¨ï¼Œæˆ–è€…å€ŸåŠ©ä¸€äº›å·¥å…·ç”Ÿæˆå­—èŠ‚ç å®ç°ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŠ¨æ€ç¼–è¯‘ï¼Œä¼šéå¸¸å¤æ‚ï¼ˆJavaä¸­çš„ cglibã€bytebuddyï¼‰</p><p><strong>tuple å•å…ƒç´ å†™æ³•</strong></p><p>Python ä¸­å•å…ƒç´ çš„ tuple åº”åœ¨å…ƒç´ ååŠ ä¸Š <code>,</code>ï¼Œè‹¥æ‹¬å·ä¸­æ²¡æœ‰<code>,</code>ï¼Œåˆ™ä¼šè¢«è®¤ä¸ºæ˜¯å…¶å…ƒç´ ç±»å‹ï¼ˆå¿½ç•¥ <code>()</code> tupleè¡¨è¾¾ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tuple1 = (<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(tuple1) <span class="comment"># a</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(tuple1)) <span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line">tuple2 = (<span class="string">&#x27;a&#x27;</span>,)</span><br><span class="line"><span class="built_in">print</span>(tuple2) <span class="comment"># (&#x27;a&#x27;,)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(tuple2)) <span class="comment"># &lt;class &#x27;tuple&#x27;&gt;</span></span><br></pre></td></tr></table></figure><hr /><p><strong>metaclass</strong></p><p>é™¤äº†ä½¿ç”¨ <code>type</code>åŠ¨æ€åˆ›å»ºç±»ä»¥å¤–ï¼Œè¦æ§åˆ¶ç±»çš„åˆ›å»ºè¡Œä¸ºï¼Œè¿˜å¯ä»¥ä½¿ç”¨ metaclass</p><p>metaclass ç›´è¯‘ä¸ºå…ƒç±»ï¼Œç®€å•çš„è§£é‡Šå°±æ˜¯ï¼šå…ˆå®šä¹‰metaclassï¼Œå°±å¯ä»¥åˆ›å»ºç±»ï¼Œæœ€ååˆ›å»ºå®ä¾‹</p><p>metaclass å…è®¸åˆ›å»ºç±»æˆ–è€…ä¿®æ”¹ç±»ï¼Œæ¢å¥è¯è¯´å¯ä»¥æŠŠç±»çœ‹æˆæ˜¯ metaclassåˆ›å»ºå‡ºæ¥çš„â€œå®ä¾‹â€</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œç»™æˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>MyList</code> å¢åŠ ä¸€ä¸ª<code>add</code> æ–¹æ³•</p><p>å®šä¹‰ <code>ListMetaclass</code>ï¼ŒæŒ‰ç…§é»˜è®¤ä¹ æƒ¯ï¼Œmetaclass çš„ç±»åæ€»æ˜¯ä»¥<code>Metaclass</code> ç»“å°¾ï¼Œä»¥ä¾¿æ¸…æ¥šåœ°è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª metaclass</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># metaclass æ˜¯ç±»çš„æ¨¡æ¿ï¼Œæ‰€ä»¥å¿…é¡»ä» `type` ç±»å‹æ´¾ç”Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ListMetaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">mcs, name, bases, attrs</span>):</span><br><span class="line">        attrs[<span class="string">&#x27;add&#x27;</span>] = <span class="keyword">lambda</span> self, value: self.append(value)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>.__new__(mcs, name, bases, attrs)</span><br></pre></td></tr></table></figure><p><code>__new__</code>æ–¹æ³•æ¥æ”¶åˆ°çš„å‚æ•°ä¾æ¬¡æ˜¯ï¼š</p><ol type="1"><li>å½“å‰å‡†å¤‡åˆ›å»ºçš„ç±»çš„å¯¹è±¡</li><li>ç±»çš„åå­—</li><li>ç±»ç»§æ‰¿çš„çˆ¶ç±»é›†åˆ</li><li>ç±»çš„æ–¹æ³•é›†åˆ</li></ol><p>æœ‰äº† <code>ListMetaclass</code>ï¼Œæˆ‘ä»¬åœ¨å®šä¹‰ç±»çš„æ—¶å€™è¿˜è¦æŒ‡ç¤ºä½¿ç”¨<code>ListMetaclass</code> æ¥å®šåˆ¶ç±»ï¼Œä¼ å…¥å…³é”®å­—å‚æ•°<code>metaclass</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyList</span>(<span class="built_in">list</span>, metaclass=ListMetaclass):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ä¼ å…¥å…³é”®å­—å‚æ•° <code>metaclass</code> æ—¶ï¼Œé­”æœ¯å°±ç”Ÿæ•ˆäº†ï¼Œå®ƒæŒ‡ç¤ºPython è§£é‡Šå™¨åœ¨åˆ›å»º <code>MyList</code> æ—¶ï¼Œè¦é€šè¿‡<code>ListMetaclass.__new__()</code> æ¥åˆ›å»º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">my_list = MyList()</span><br><span class="line">my_list.add(<span class="number">1</span>)</span><br><span class="line">my_list.add(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(my_list) <span class="comment"># [1, 2]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ™®é€šçš„ list æ²¡æœ‰ add æ–¹æ³•</span></span><br><span class="line"><span class="built_in">list</span> = []</span><br><span class="line"><span class="built_in">list</span>.add(<span class="number">1</span>) <span class="comment"># AttributeError: &#x27;list&#x27; object has no attribute &#x27;add&#x27;</span></span><br></pre></td></tr></table></figure><hr /><p>è¿™é‡Œä½¿ç”¨å…ƒç±»å®ç°ä¸€ä¸ª ORM Model ä½œä¸ºç»ƒä¹ </p><p>é¦–å…ˆæ¥å®šä¹‰ <code>Field</code>ç±»ï¼Œå®ƒè´Ÿè´£ä¿å­˜æ•°æ®åº“è¡¨çš„å­—æ®µåå’Œå­—æ®µç±»å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Field</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, column_type</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.column_type = column_type</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;%s:%s&gt;&#x27;</span> % (self.__class__.__name__, self.name)</span><br></pre></td></tr></table></figure><p>åœ¨ <code>Field</code> çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å®šä¹‰å„ç§ç±»å‹çš„<code>Field</code>ï¼Œæ¯”å¦‚<code>StringField</code>ï¼Œ<code>IntegerField</code> ç­‰ç­‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StringField</span>(<span class="title class_ inherited__">Field</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="built_in">super</span>(StringField, self).__init__(name, <span class="string">&#x27;varchar(100)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IntegerField</span>(<span class="title class_ inherited__">Field</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="built_in">super</span>(IntegerField, self).__init__(name, <span class="string">&#x27;bigint&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ç¼–å†™ <code>ModelMetaclass</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelMetaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">mcs, name, bases, attrs</span>):</span><br><span class="line">        <span class="comment"># å¦‚æœæ˜¯ Modelï¼Œåˆ™ç›´æ¥åˆ›å»º class è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;Model&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">type</span>.__new__(mcs, name, bases, attrs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é Module</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Found model: %s&#x27;</span> % name)</span><br><span class="line">        <span class="comment"># è§£æç±»å±æ€§</span></span><br><span class="line">        mappings = <span class="built_in">dict</span>()</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(v, Field):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Found mapping: %s ==&gt; %s&#x27;</span> % (k, v))</span><br><span class="line">                mappings[k] = v</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> mappings.keys():</span><br><span class="line">            attrs.pop(k)</span><br><span class="line">        attrs[<span class="string">&#x27;__mappings__&#x27;</span>] = mappings  <span class="comment"># ä¿å­˜å±æ€§å’Œåˆ—çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">        attrs[<span class="string">&#x27;__table__&#x27;</span>] = name  <span class="comment"># å‡è®¾è¡¨åå’Œç±»åä¸€è‡´</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºå¯¹åº”çš„ class</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>.__new__(mcs, name, bases, attrs)</span><br></pre></td></tr></table></figure><p>åŸºç±» <code>Model</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Model</span>(<span class="built_in">dict</span>, metaclass=ModelMetaclass):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kw</span>):</span><br><span class="line">        <span class="built_in">super</span>(Model, self).__init__(**kw)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self[key]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">r&quot;&#x27;Model&#x27; object has no attribute &#x27;%s&#x27;&quot;</span> % key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        self[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self</span>):</span><br><span class="line">        fields = []</span><br><span class="line">        params = []</span><br><span class="line">        args = []</span><br><span class="line">        <span class="comment"># ä» __mappings__ è·å–è§£æå‡ºçš„å±æ€§</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> self.__mappings__.items():</span><br><span class="line">            fields.append(v.name)</span><br><span class="line">            params.append(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            args.append(<span class="built_in">getattr</span>(self, k, <span class="literal">None</span>))</span><br><span class="line">        sql = <span class="string">&#x27;insert into %s (%s) values (%s)&#x27;</span> % (self.__table__, <span class="string">&#x27;,&#x27;</span>.join(fields), <span class="string">&#x27;,&#x27;</span>.join(params))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;SQL: %s&#x27;</span> % sql)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ARGS: %s&#x27;</span> % <span class="built_in">str</span>(args))</span><br></pre></td></tr></table></figure><p>åœ¨ <code>ModelMetaclass</code> ä¸­ï¼Œä¸€å…±åšäº†å‡ ä»¶äº‹æƒ…</p><ul><li>æ’é™¤æ‰å¯¹ <code>Model</code> ç±»çš„ä¿®æ”¹</li><li>åœ¨å½“å‰ç±»ï¼ˆæ¯”å¦‚<code>User</code>ï¼‰ä¸­æŸ¥æ‰¾å®šä¹‰çš„ç±»çš„æ‰€æœ‰å±æ€§ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ª<code>Field</code> å±æ€§ï¼Œå°±æŠŠå®ƒä¿å­˜åˆ°ä¸€ä¸ª <code>__mappings__</code> çš„dict ä¸­ï¼ŒåŒæ—¶ä»ç±»å±æ€§ä¸­åˆ é™¤è¯¥ <code>Field</code>å±æ€§ï¼Œå¦åˆ™ï¼Œå®¹æ˜“é€ æˆè¿è¡Œæ—¶é”™è¯¯ï¼ˆå®ä¾‹çš„å±æ€§ä¼šé®ç›–ç±»çš„åŒåå±æ€§ï¼‰</li><li>æŠŠè¡¨åä¿å­˜åˆ° <code>__table__</code>ä¸­ï¼Œè¿™é‡Œç®€åŒ–ä¸ºè¡¨åé»˜è®¤ä¸ºç±»å</li></ul><p>å®šä¹‰å®ä½“ç±»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="built_in">id</span> = IntegerField(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    name = StringField(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    email = IntegerField(<span class="string">&#x27;email&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = Student(<span class="built_in">id</span>=<span class="number">12345</span>, name=<span class="string">&#x27;zhangsan&#x27;</span>, email=<span class="string">&#x27;zhangsan@xxx.com&#x27;</span>)</span><br><span class="line">s.save()</span><br><span class="line"><span class="comment"># SQL: insert into Student (id,name,email) values (?,?,?)</span></span><br><span class="line"><span class="comment"># ARGS: [12345, &#x27;zhangsan&#x27;, &#x27;zhangsan@xxx.com&#x27;]</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨çœ‹çš„æ—¶å€™æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®šä¹‰çš„ <code>Student</code> å±æ€§å¿…é¡»å’Œ<code>Student(id=12345, name='zhangsan', email='zhangsan@xxx.com')</code>å‚æ•°ä¸€è‡´</p><p>ä¸ç„¶å°±ä¼šå‡ºç°å¦‚ä¸‹ç»“æœ <code>ARGS: [None, None, None]</code></p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œå…¶æ¬¡å¦‚æœä¸€è‡´çš„è¯ä¸åº”è¯¥å®ä¾‹å±æ€§å½±å“ç±»å±æ€§å—</p><ul><li>Qï¼šä¸ºä»€ä¹ˆåç§°å¿…é¡»ä¸€è‡´<ul><li>å› ä¸ºåç»­æ˜¯é€šè¿‡ <code>getattr(self, k, None)</code> æ“ä½œæ¥æ‰¾åˆ°å¯¹åº”value çš„ï¼Œå¦‚æœä¸ä¸€è‡´ <code>self</code> å°†æ‰¾ä¸åˆ°è¯¥å±æ€§å¯¹åº”çš„ value</li></ul></li><li>Qï¼šåç§°å¦‚æœä¸€è‡´çš„è¯ä¸åº”è¯¥å®ä¾‹å±æ€§å½±å“ç±»å±æ€§å—<ul><li>ä¸å½±å“ï¼Œå› ä¸º <code>Model</code> é‡å†™äº† <code>__getattr__</code>æ–¹æ³•ï¼Œå®ç°ä¸º <code>self[key]</code></li><li>è€Œ <code>Model</code> ç»§æ‰¿äº† <code>dict</code>ï¼Œå®é™…ä¸Šè®²æ•°æ®ä»¥ KVå½¢å¼ä¿å­˜åœ¨è‡ªå·± <code>dict</code> ä¸­</li><li><code>ModelMetaclass</code> å®šä¹‰ä¸­ï¼Œåœ¨ä¿å­˜äº†å±æ€§åä½¿ç”¨<code>attrs.pop(k)</code> å°†å®ä¾‹åŒåå±æ€§åˆ é™¤äº†</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®ä¾‹åŒ–åï¼Œs å¯¹è±¡å…¶å®å·²ç»æ²¡æœ‰äº† id\name\email å±æ€§</span></span><br><span class="line">s = Student(<span class="built_in">id</span>=<span class="number">12345</span>, name=<span class="string">&#x27;zhangsan&#x27;</span>, email=<span class="string">&#x27;zhangsan@xxx.com&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s.__dir__())</span><br><span class="line"><span class="comment"># [&#x27;__module__&#x27;, &#x27;__mappings__&#x27;, &#x27;__table__&#x27;, &#x27;__doc__&#x27;, &#x27;__init__&#x27;, &#x27;__getattr__&#x27;, &#x27;__setattr__&#x27;, &#x27;save&#x27;, &#x27;__dict__&#x27;, &#x27;__weakref__&#x27;, &#x27;__repr__&#x27;, &#x27;__hash__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__lt__&#x27;, &#x27;__le__&#x27;, &#x27;__eq__&#x27;, &#x27;__ne__&#x27;, &#x27;__gt__&#x27;, &#x27;__ge__&#x27;, &#x27;__iter__&#x27;, &#x27;__or__&#x27;, &#x27;__ror__&#x27;, &#x27;__ior__&#x27;, &#x27;__len__&#x27;, &#x27;__getitem__&#x27;, &#x27;__setitem__&#x27;, &#x27;__delitem__&#x27;, &#x27;__contains__&#x27;, &#x27;__new__&#x27;, &#x27;__sizeof__&#x27;, &#x27;get&#x27;, &#x27;setdefault&#x27;, &#x27;pop&#x27;, &#x27;popitem&#x27;, &#x27;keys&#x27;, &#x27;items&#x27;, &#x27;values&#x27;, &#x27;update&#x27;, &#x27;fromkeys&#x27;, &#x27;clear&#x27;, &#x27;copy&#x27;, &#x27;__reversed__&#x27;, &#x27;__class_getitem__&#x27;, &#x27;__str__&#x27;, &#x27;__delattr__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__reduce__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__format__&#x27;, &#x27;__dir__&#x27;, &#x27;__class__&#x27;]</span></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://www.liaoxuefeng.com/wiki/1016959663602400">Pythonæ•™ç¨‹ -å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.8 - å·¥å…·</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.8%20-%20%E5%B7%A5%E5%85%B7.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.8%20-%20%E5%B7%A5%E5%85%B7.html</url>
      
        <content type="html"><![CDATA[<p>å·¥å…·æ˜¯ä»£ç†å¯ä»¥ç”¨æ¥ä¸ä¸–ç•Œäº¤äº’çš„æ¥å£ï¼Œå®ƒä»¬åŒ…æ‹¬ï¼š</p><ul><li>å·¥å…·çš„åç§°</li><li>å·¥å…·çš„æè¿°</li><li>å·¥å…·è¾“å…¥ JSON å‚æ•°</li><li>è°ƒç”¨çš„å‡½æ•°</li><li>æ˜¯å¦åº”å°†å·¥å…·çš„ç»“æœç›´æ¥è¿”å›ç»™ç”¨æˆ·</li></ul><p>è¿™äº›ä¿¡æ¯è‡³å…³é‡è¦ï¼Œä½¿ç”¨è¿™äº›ä¿¡æ¯å¯ä»¥ç”¨æ¥å»ºç«‹è¡ŒåŠ¨ç³»ç»Ÿï¼ŒLLMå°±å¯ä»¥ä½¿ç”¨åç§°ã€æè¿°å’Œ JSONæ¨¡å¼å…¥å‚ä½œä¸ºæç¤ºï¼Œè¿™æ ·å®ƒå°±çŸ¥é“å¦‚ä½•æŒ‡å®šè¦æ‰§è¡Œçš„æ“ä½œï¼Œç„¶åè¦è°ƒç”¨çš„å‡½æ•°å°±ç›¸å½“äºæ‰§è¡Œè¯¥æ“ä½œ</p><p>å·¥å…·çš„è¾“å…¥è¶Šç®€å•ï¼ŒLLMå°±è¶Šå®¹æ˜“ä½¿ç”¨å®ƒã€‚è®¸å¤šä»£ç†åªä½¿ç”¨å…·æœ‰å•ä¸ªå­—ç¬¦ä¸²è¾“å…¥çš„å·¥å…·</p><p>éœ€è¦æ³¨æ„çš„æ˜¯åç§°ã€æè¿°å’Œ JSONæ¨¡å¼å…¥å‚ï¼ˆå¦‚æœä½¿ç”¨ï¼‰éƒ½å°†åœ¨æç¤ºä¸­è¢«ä½¿ç”¨ã€‚å› æ­¤è¿™äº›å†…å®¹å¿…é¡»æ¸…æ¥šå¹¶å‡†ç¡®åœ°æè¿°åº”è¯¥å¦‚ä½•ä½¿ç”¨è¯¥å·¥å…·ï¼›è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå¦‚æœLLM å‡ºç°äº†ä¸äº†è§£å¦‚ä½•ä½¿ç”¨è¯¥å·¥å…·çš„æƒ…å†µï¼Œåˆ™å¯èƒ½éœ€è¦æ›´æ”¹é»˜è®¤åç§°ã€æè¿°æˆ–JSON æ¨¡å¼å…¥å‚</p><h1 id="å†…ç½®å·¥å…·">å†…ç½®å·¥å…·</h1><p>LangChain ä¸­å†…ç½®äº†å¾ˆå¤šå·¥å…·ï¼Œè¿™é‡Œä½¿ç”¨ Wikipedia ä¸¾ä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">api_wrapper = WikipediaAPIWrapper(top_k_results=<span class="number">1</span>, doc_content_chars_max=<span class="number">100</span>)</span><br><span class="line">tool = WikipediaQueryRun(api_wrapper=api_wrapper)</span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸€ä¸‹åŸºæœ¬å±æ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(tool.name)</span><br><span class="line"><span class="comment"># &gt;&gt; Wikipedia</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tool.description)</span><br><span class="line"><span class="comment"># &gt;&gt; A wrapper around Wikipedia. Useful for when you need to answer general questions about people, places, companies, facts, historical events, or other subjects. Input should be a search query.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tool.args)</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;query&#x27;: &#123;&#x27;title&#x27;: &#x27;Query&#x27;, &#x27;type&#x27;: &#x27;string&#x27;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tool.return_direct)</span><br><span class="line"><span class="comment"># &gt;&gt; False</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(tool.run(<span class="string">&quot;China&quot;</span>))</span><br><span class="line"><span class="comment"># &gt;&gt; Page: China</span></span><br><span class="line"><span class="comment"># &gt;&gt; Summary: China (Chinese: ä¸­å›½; pinyin: ZhÅngguÃ³), officially the People&#x27;s Republic of China</span></span><br></pre></td></tr></table></figure><hr /><p>LangChain æä¾›äº†å¤šç§å·¥å…·ï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹é›†æˆ</p><p><a href="https://python.langchain.com/docs/integrations/tools/">Tools| ğŸ¦œï¸ğŸ”— Langchain</a></p><h1 id="è‡ªå®šä¹‰å·¥å…·">è‡ªå®šä¹‰å·¥å…·</h1><p>åœ¨æ„å»ºä»£ç†æ—¶ï¼Œéœ€è¦å‘å®ƒæä¾›ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„å·¥å…·åˆ—è¡¨</p><p>é™¤äº†è°ƒç”¨çš„å®é™…å‡½æ•°å¤–ï¼Œè¯¥å·¥å…·è¿˜åŒ…æ‹¬å‡ ä¸ªå±æ€§ï¼š</p><ul><li>nameï¼ˆstrï¼‰å¿…å¡«ï¼Œå¹¶ä¸”åœ¨æä¾›ç»™ä»£ç†çš„ä¸€ç»„å·¥å…·ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„</li><li>descriptionï¼ˆstrï¼‰é€‰å¡«ä½†æ˜¯æ¨èè®¾ç½®ï¼Œå› ä¸ºå®ƒè¢«ä»£ç†ç”¨æ¥ç¡®å®šå·¥å…·çš„ä½¿ç”¨</li><li>args_schemaï¼ˆPydanticBaseModelï¼‰é€‰å¡«ä½†æ˜¯æ¨èè®¾ç½®ï¼Œå¯ä»¥ç”¨äºæä¾›æ›´å¤šä¿¡æ¯ï¼ˆä¾‹å¦‚å°‘é‡ç¤ºä¾‹ï¼‰æˆ–éªŒè¯é¢„æœŸå‚æ•°</li></ul><p>æœ‰å¤šç§æ–¹æ³•å¯ä»¥å®šä¹‰å·¥å…·ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­å®ç°äº†ä¸¤ä¸ªç±»å‹çš„å·¥å…·ï¼š</p><ul><li>ä¸€ä¸ªè™šæ„çš„æœç´¢å‡½æ•°ï¼Œå®ƒæ€»æ˜¯è¿”å›å­—ç¬¦ä¸² <code>LangChain</code></li><li>ä¸€ä¸ªå°†ä¸¤ä¸ªæ•°å­—ç›¸ä¹˜çš„ä¹˜æ³•å™¨å‡½æ•°</li></ul><p>ä¸¤ä¸ªå·¥å…·çš„åŒºåˆ«æ˜¯ç¬¬ä¸€ä¸ªå‡½æ•°åªéœ€è¦ä¸€ä¸ªè¾“å…¥ï¼Œè€Œç¬¬äºŒä¸ªå‡½æ•°éœ€è¦å¤šä¸ªè¾“å…¥ï¼›è®¸å¤šAgent åªå¤„ç†éœ€è¦å•ä¸ªè¾“å…¥çš„å‡½æ•°ï¼Œå› æ­¤äº†è§£å¦‚ä½•å¤„ç†è¿™äº›å‡½æ•°å¾ˆé‡è¦</p><h2 id="tool-è£…é¥°å™¨"><span class="citation"data-cites="tool">@tool</span> è£…é¥°å™¨</h2><p><code>@tool</code> è£…é¥°å™¨æ˜¯å®šä¹‰è‡ªå®šä¹‰å·¥å…·çš„æœ€ç®€å•æ–¹æ³•</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè£…é¥°å™¨ä½¿ç”¨å‡½æ•°åç§°ä½œä¸ºå·¥å…·åç§°ï¼Œä½†å¯ä»¥é€šè¿‡ä¼ é€’å­—ç¬¦ä¸²ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°æ¥è¦†ç›–æ­¤åç§°ï¼›æ­¤å¤–è£…é¥°å™¨å°†ä½¿ç”¨å‡½æ•°çš„doc string ä½œä¸ºå·¥å…·çš„æè¿°ï¼Œå› æ­¤å¿…é¡»æä¾›ä¸€ä¸ª doc string</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Look up things online.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;LangChain&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(search.name)</span><br><span class="line"><span class="comment"># &gt;&gt; search</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(search.description)</span><br><span class="line"><span class="comment"># &gt;&gt; search(query: str) -&gt; str - Look up things online.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(search.args)</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;query&#x27;: &#123;&#x27;title&#x27;: &#x27;Query&#x27;, &#x27;type&#x27;: &#x27;string&#x27;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡å°†å·¥å…·åç§°å’Œ JSON å‚æ•°ä¼ é€’ç»™å·¥å…·è£…é¥°å™¨æ¥è‡ªå®šä¹‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@tool(<span class="params"><span class="string">&quot;search-tool&quot;</span>, args_schema=SearchInput, return_direct=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Look up things online.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;LangChain&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(search.name)</span><br><span class="line"><span class="comment"># &gt;&gt; search-tool</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(search.description)</span><br><span class="line"><span class="comment"># &gt;&gt; search-tool(query: str) -&gt; str - Look up things online.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(search.args)</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;query&#x27;: &#123;&#x27;title&#x27;: &#x27;Query&#x27;, &#x27;description&#x27;: &#x27;should be a search query&#x27;, &#x27;type&#x27;: &#x27;string&#x27;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p><code>@Tool</code> è£…é¥°æ–¹æ³•çš„å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tool</span>(<span class="params"></span></span><br><span class="line"><span class="params">    *args: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="type">Callable</span>, Runnable],</span></span><br><span class="line"><span class="params">    return_direct: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    args_schema: <span class="type">Optional</span>[<span class="type">Type</span>[BaseModel]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    infer_schema: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>å…³äº Python çš„è£…é¥°è¯­æ³•ï¼Œå¯ä»¥çœ‹ä¸‹æ–¹è¡¥å……å†…å®¹</p><h2 id="basetool-å­ç±»">BaseTool å­ç±»</h2><p>ä½¿ç”¨ BaseTool å­ç±»æ¥æ˜¾å¼å®šä¹‰è‡ªå®šä¹‰å·¥å…·</p><p>æä¾›äº†å¯¹å·¥å…·å®šä¹‰çš„æœ€å¤§æ§åˆ¶ï¼Œä½†éœ€è¦åšæ›´å¤šçš„å·¥ä½œ</p><p><strong>å®šä¹‰å…¥å‚ç»“æ„</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CalculatorInput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    a: <span class="built_in">int</span> = Field(description=<span class="string">&quot;first number&quot;</span>)</span><br><span class="line">    b: <span class="built_in">int</span> = Field(description=<span class="string">&quot;second number&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>å®ç°</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomCalculatorTool</span>(<span class="title class_ inherited__">BaseTool</span>):</span><br><span class="line">    name = <span class="string">&quot;Calculator&quot;</span></span><br><span class="line">    description = <span class="string">&quot;useful for when you need to answer questions about math&quot;</span></span><br><span class="line">    args_schema: <span class="type">Type</span>[BaseModel] = CalculatorInput</span><br><span class="line">    return_direct: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># éœ€è¦å®ç°åŒæ­¥æ‰§è¡Œ _run</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_run</span>(<span class="params"></span></span><br><span class="line"><span class="params">            self, a: <span class="built_in">int</span>, b: <span class="built_in">int</span>, run_manager: <span class="type">Optional</span>[CallbackManagerForToolRun] = <span class="literal">None</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Use the tool.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(a * b)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># éœ€è¦å®ç°å¼‚æ­¥æ‰§è¡Œ _arun</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_arun</span>(<span class="params"></span></span><br><span class="line"><span class="params">            self,</span></span><br><span class="line"><span class="params">            a: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">            b: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">            run_manager: <span class="type">Optional</span>[AsyncCallbackManagerForToolRun] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Use the tool asynchronously.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Calculator does not support async&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">multiply = CustomCalculatorTool()</span><br><span class="line"><span class="built_in">print</span>(multiply.name)</span><br><span class="line"><span class="comment"># &gt;&gt; Calculator</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.description)</span><br><span class="line"><span class="comment"># &gt;&gt; useful for when you need to answer questions about math</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.args)</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;a&#x27;: &#123;&#x27;title&#x27;: &#x27;A&#x27;, &#x27;description&#x27;: &#x27;first number&#x27;, &#x27;type&#x27;: &#x27;integer&#x27;&#125;, &#x27;b&#x27;: &#123;&#x27;title&#x27;: &#x27;B&#x27;, &#x27;description&#x27;: &#x27;second number&#x27;, &#x27;type&#x27;: &#x27;integer&#x27;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.return_direct)</span><br><span class="line"><span class="comment"># &gt;&gt; True</span></span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œ</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(multiply.run(tool_input=&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">4</span>&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; 12</span></span><br></pre></td></tr></table></figure><h2 id="structuredtool-æ•°æ®ç±»">StructuredTool æ•°æ®ç±»</h2><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>StructuredTool</code> æ•°æ®ç±»</p><p>è¿™ç§æ–¹æ³•æ˜¯å‰ä¸¤ç§æ–¹æ³•çš„æ··åˆï¼Œæ¯”ç»§æ‰¿ <code>BaseTool</code>ç±»æ›´æ–¹ä¾¿ï¼Œä½†æ¯”è£…é¥°å™¨æ–¹å¼æä¾›äº†æ›´å¤šçš„åŠŸèƒ½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Multiply two numbers.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">multiply = StructuredTool.from_function(</span><br><span class="line">    func=multiply,</span><br><span class="line">    name=<span class="string">&quot;Calculator&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;multiply numbers&quot;</span>,</span><br><span class="line">    <span class="comment"># coroutine= ... &lt;- you can specify an async method if desired as well</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(multiply.name)</span><br><span class="line"><span class="comment"># &gt;&gt; Calculator</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.description)</span><br><span class="line"><span class="comment"># &gt;&gt; Calculator(a: int, b: int) -&gt; int - multiply numbers</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.args)</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;a&#x27;: &#123;&#x27;title&#x27;: &#x27;A&#x27;, &#x27;type&#x27;: &#x27;integer&#x27;&#125;, &#x27;b&#x27;: &#123;&#x27;title&#x27;: &#x27;B&#x27;, &#x27;type&#x27;: &#x27;integer&#x27;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.return_direct)</span><br><span class="line"><span class="comment"># &gt;&gt; False</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶ä¹Ÿå¯ä»¥å®šä¹‰ç»“æ„å…¥å‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰å…¥å‚ç»“æ„</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CalculatorInput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    a: <span class="built_in">int</span> = Field(description=<span class="string">&quot;first number&quot;</span>)</span><br><span class="line">    b: <span class="built_in">int</span> = Field(description=<span class="string">&quot;second number&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Multiply two numbers.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">multiply = StructuredTool.from_function(</span><br><span class="line">    func=multiply,</span><br><span class="line">    name=<span class="string">&quot;Calculator&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;multiply numbers&quot;</span>,</span><br><span class="line">    args_schema=CalculatorInput,</span><br><span class="line">    return_direct=<span class="literal">True</span>,</span><br><span class="line">    <span class="comment"># coroutine= ... &lt;- you can specify an async method if desired as well</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(multiply.name)</span><br><span class="line"><span class="comment"># &gt;&gt; Calculator</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.description)</span><br><span class="line"><span class="comment"># &gt;&gt; Calculator(a: int, b: int) -&gt; int - multiply numbers</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.args)</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;a&#x27;: &#123;&#x27;title&#x27;: &#x27;A&#x27;, &#x27;description&#x27;: &#x27;first number&#x27;, &#x27;type&#x27;: &#x27;integer&#x27;&#125;, &#x27;b&#x27;: &#123;&#x27;title&#x27;: &#x27;B&#x27;, &#x27;description&#x27;: &#x27;second number&#x27;, &#x27;type&#x27;: &#x27;integer&#x27;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(multiply.return_direct)</span><br><span class="line"><span class="comment"># &gt;&gt; True</span></span><br></pre></td></tr></table></figure><h2 id="å¤„ç†å·¥å…·é”™è¯¯">å¤„ç†å·¥å…·é”™è¯¯</h2><p>å½“å·¥å…·é‡åˆ°é”™è¯¯ä¸”æœªæ•è·å¼‚å¸¸æ—¶ï¼Œä»£ç†å°†ç»ˆæ­¢æ‰§è¡Œ</p><p>å¦‚æœå¸Œæœ›ä»£ç†ç»§ç»­æ‰§è¡Œå¯ä»¥ raise <code>ToolException</code>å¹¶ç›¸åº”åœ°è®¾ç½® <code>handle_tool_error</code></p><ul><li>å½“æŠ›å‡º <code>ToolException</code>æ—¶ï¼Œä»£ç†ä¸ä¼šåœæ­¢å·¥ä½œï¼Œè€Œæ˜¯ä¼šæ ¹æ®å·¥å…·çš„ <code>handle_tool_error</code>å˜é‡å¤„ç†å¼‚å¸¸ï¼Œå¤„ç†ç»“æœä¼šä½œä¸ºè§‚å¯Ÿè¿”å›ç»™ä»£ç†ï¼Œå¹¶ä»¥çº¢è‰²æ—¥å¿—è¿›è¡Œæ‰“å°</li><li>å¯ä»¥å°† <code>handle_tool_error</code> è®¾ç½®ä¸ºTrueï¼Œå°†å…¶è®¾ç½®ä¸ºç»Ÿä¸€å­—ç¬¦ä¸²å€¼ï¼Œæˆ–å°†å…¶è®¾ç½®æˆå‡½æ•°ï¼›å¦‚æœå®ƒè¢«è®¾ç½®ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°åº”è¯¥ä»¥<code>ToolException</code> ä½œä¸ºå‚æ•°å¹¶è¿”å›å­—ç¬¦ä¸²å€¼</li><li>ä»… raise <code>ToolException</code> æ˜¯æ— æ•ˆçš„ï¼Œéœ€è¦é¦–å…ˆè®¾ç½®è¯¥å·¥å…·çš„<code>handle_tool_error</code>ï¼Œå› ä¸ºå…¶é»˜è®¤å€¼ä¸º False</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">search_tool_error</span>(<span class="params">s: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">raise</span> ToolException(<span class="string">&quot;å·¥å…·å‡ºç°é”™è¯¯&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">search = StructuredTool.from_function(</span><br><span class="line">    func=search_tool_error,</span><br><span class="line">    name=<span class="string">&quot;Search_tool_error&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;A bad tool&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">search.run(<span class="string">&quot;test&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="keyword">raise</span> ToolException(<span class="string">&quot;å·¥å…·å‡ºç°é”™è¯¯&quot;</span>)</span><br><span class="line">langchain_core.tools.ToolException: å·¥å…·å‡ºç°é”™è¯¯</span><br></pre></td></tr></table></figure><p>è®¾ç½® <code>handle_tool_error</code> ä¸º True</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">search = StructuredTool.from_function(</span><br><span class="line">    func=search_tool_error,</span><br><span class="line">    name=<span class="string">&quot;Search_tool_error&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;A bad tool&quot;</span>,</span><br><span class="line">    handle_tool_error=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(search.run(<span class="string">&quot;test&quot;</span>))</span><br><span class="line"><span class="comment"># &gt;&gt; å·¥å…·å‡ºç°é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥å®šä¹‰ä¸€ç§è‡ªå®šä¹‰æ–¹å¼æ¥å¤„ç†å·¥å…·é”™è¯¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_handle_error</span>(<span class="params">error: ToolException</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> error.args[<span class="number">0</span>] + <span class="string">&quot; æ‰€ä»¥æˆ‘ä¸çŸ¥é“&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">search = StructuredTool.from_function(</span><br><span class="line">    func=search_tool_error,</span><br><span class="line">    name=<span class="string">&quot;Search_tool_error&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;A bad tool&quot;</span>,</span><br><span class="line">    handle_tool_error=_handle_error</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(search.run(<span class="string">&quot;test&quot;</span>))</span><br><span class="line"><span class="comment"># &gt;&gt; å·¥å…·å‡ºç°é”™è¯¯ æ‰€ä»¥æˆ‘ä¸çŸ¥é“</span></span><br></pre></td></tr></table></figure><h1 id="å·¥å…·ç®±">å·¥å…·ç®±</h1><p>å·¥å…·ç®±æ˜¯è®¾è®¡ç”¨äºç‰¹å®šä»»åŠ¡çš„å·¥å…·é›†åˆï¼Œå…·æœ‰ä¾¿æ·çš„åŠ è½½æ–¹æ³•</p><p>å®Œæ•´åˆ—è¡¨å‚è€ƒé›†æˆæ–‡æ¡£https://python.langchain.com/docs/integrations/toolkits/</p><p>æ‰€æœ‰å·¥å…·ç®±éƒ½å…¬å¼€äº†ä¸€ä¸ª <code>get_tools</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå·¥å…·åˆ—è¡¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize a toolkit</span></span><br><span class="line">toolkit = ExampleTookit(...)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get list of tools</span></span><br><span class="line">tools = toolkit.get_tools()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create agent</span></span><br><span class="line">agent = create_agent_method(llm, tools, prompt)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ SQL Database å·¥å…·ç®±</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">toolkit = SQLDatabaseToolkit(db=db, llm=llm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°ä¸‹ä¿¡æ¯</span></span><br><span class="line">tools = toolkit.get_tools()</span><br><span class="line"><span class="keyword">for</span> tool <span class="keyword">in</span> tools:</span><br><span class="line">    <span class="built_in">print</span>(tool.name)</span><br><span class="line">    <span class="built_in">print</span>(tool.description)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;--------------&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sql_db_query</span><br><span class="line"><span class="keyword">Input</span> <span class="keyword">to</span> this tool <span class="keyword">is</span> a detailed <span class="keyword">and</span> correct <span class="keyword">SQL</span> query, output <span class="keyword">is</span> a result <span class="keyword">from</span> the <span class="keyword">database</span>. <span class="keyword">If</span> the query <span class="keyword">is</span> <span class="keyword">not</span> correct, an error message will be returned. <span class="keyword">If</span> an error <span class="keyword">is</span> returned, rewrite the query, <span class="keyword">check</span> the query, <span class="keyword">and</span> try again. <span class="keyword">If</span> you encounter an issue <span class="keyword">with</span> <span class="type">Unknown</span> <span class="keyword">column</span> <span class="string">&#x27;xxxx&#x27;</span> <span class="keyword">in</span> <span class="string">&#x27;field list&#x27;</span>, use sql_db_schema <span class="keyword">to</span> query the correct <span class="keyword">table</span> fields.</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">sql_db_schema</span><br><span class="line"><span class="keyword">Input</span> <span class="keyword">to</span> this tool <span class="keyword">is</span> a comma-separated list <span class="keyword">of</span> <span class="keyword">tables</span>, output <span class="keyword">is</span> the <span class="keyword">schema</span> <span class="keyword">and</span> sample <span class="keyword">rows</span> <span class="keyword">for</span> those <span class="keyword">tables</span>. Be sure that the <span class="keyword">tables</span> actually exist <span class="keyword">by</span> calling sql_db_list_tables first! Example <span class="keyword">Input</span>: table1, table2, table3</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">sql_db_list_tables</span><br><span class="line"><span class="keyword">Input</span> <span class="keyword">is</span> an empty string, output <span class="keyword">is</span> a comma separated list <span class="keyword">of</span> <span class="keyword">tables</span> <span class="keyword">in</span> the <span class="keyword">database</span>.</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">sql_db_query_checker</span><br><span class="line">Use this tool <span class="keyword">to</span> <span class="type">double</span> <span class="keyword">check</span> <span class="keyword">if</span> your query <span class="keyword">is</span> correct <span class="keyword">before</span> executing it. <span class="keyword">Always</span> use this tool <span class="keyword">before</span> executing a query <span class="keyword">with</span> sql_db_query!</span><br><span class="line"><span class="comment">--------------</span></span><br></pre></td></tr></table></figure><h1 id="openai-functions">OpenAI Functions</h1><p>LangChain å·¥å…·ä¹Ÿå¯ä»¥ä½œä¸º OpenAI Fuctions</p><p>ä½¿ç”¨ <code>format_tool_to_openai_function</code> å°†å·¥å…·è½¬æ¢ä¸ºFunctions</p><p>å› ä¸ºæˆ‘æ²¡æœ‰å¯¹åº”çš„ APIï¼Œè¿™é‡Œå°±ç›´æ¥ä½¿ç”¨å®˜æ–¹æ–‡æ¡£çš„å†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LLM</span></span><br><span class="line">model = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo-0613&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ toolï¼Œè½¬æ¢ functions</span></span><br><span class="line">tools = [MoveFileTool()]</span><br><span class="line">functions = [format_tool_to_openai_function(t) <span class="keyword">for</span> t <span class="keyword">in</span> tools]</span><br><span class="line"></span><br><span class="line">message = model.predict_messages(</span><br><span class="line">    [HumanMessage(content=<span class="string">&quot;move file foo to bar&quot;</span>)], functions=functions</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">message</span><br><span class="line"></span><br><span class="line"><span class="constructor">AIMessage(<span class="params">content</span>=&#x27;&#x27;, <span class="params">additional_kwargs</span>=&#123;&#x27;<span class="params">function_call</span>&#x27;: &#123;&#x27;<span class="params">name</span>&#x27;: &#x27;<span class="params">move_file</span>&#x27;, &#x27;<span class="params">arguments</span>&#x27;: &#x27;&#123;\<span class="params">n</span>  <span class="string">&quot;source_path&quot;</span>: <span class="string">&quot;foo&quot;</span>,\<span class="params">n</span>  <span class="string">&quot;destination_path&quot;</span>: <span class="string">&quot;bar&quot;</span>\<span class="params">n</span>&#125;&#x27;&#125;&#125;, <span class="params">example</span>=False)</span></span><br></pre></td></tr></table></figure><h1 id="è¡¥å……">è¡¥å……</h1><h2 id="è£…é¥°å™¨è¯­æ³•">è£…é¥°å™¨è¯­æ³•</h2><p>å½“ä½ åœ¨ä¸€ä¸ªå‡½æ•°ä¸Šæ–¹ä½¿ç”¨è£…é¥°å™¨æ—¶ï¼Œå®ƒå®é™…ä¸Šç›¸å½“äºå°†è¯¥å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¯¹åº”å®ç°ï¼Œå¹¶å°†å…¶è¿”å›çš„å‡½æ•°æ›¿æ¢åŸæ¥çš„å‡½æ•°å®šä¹‰</p><p>å®šä¹‰ä¸€ä¸ªç»“æ„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    age: <span class="built_in">int</span></span><br><span class="line">    grade: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;name:&quot;</span> + self.name + <span class="string">&quot;\nage:&quot;</span> + <span class="built_in">str</span>(self.age) + <span class="string">&quot;\ngrade:&quot;</span> + <span class="built_in">str</span>(self.grade)</span><br></pre></td></tr></table></figure><p>å®ç°è£…é¥°å™¨æ–¹æ³•</p><p>åˆ›å»ºä¸€ä¸ªå­¦ç”Ÿå¯¹è±¡çš„ç»†èŠ‚ï¼š</p><ul><li>name æ–¹æ³•å</li><li>age æ–¹æ³•è°ƒç”¨è¿”å›å€¼</li><li>grade è£…é¥°è¯­æ³•çš„å…¥å‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_decorator_student</span>(<span class="params">grade: <span class="built_in">int</span></span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator_func</span>(<span class="params">func</span>):</span><br><span class="line">        age = func()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">build_student</span>(<span class="params">name: <span class="built_in">str</span>, age: <span class="built_in">int</span>, grade: <span class="built_in">int</span></span>):</span><br><span class="line">            s = Student()</span><br><span class="line">            s.name = name</span><br><span class="line">            s.age = age</span><br><span class="line">            s.grade = grade</span><br><span class="line">            <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> build_student(func.__name__, age, grade)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator_func</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@my_decorator_student(<span class="params">grade=<span class="number">5</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">zhang_san</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(zhang_san)</span><br></pre></td></tr></table></figure><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">name:</span>zhang_san</span><br><span class="line"><span class="symbol">age:</span><span class="number">20</span></span><br><span class="line"><span class="symbol">grade:</span><span class="number">5</span></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://python.langchain.com/docs/modules/agents/tools/">Tools |ğŸ¦œï¸ğŸ”— Langchain</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®€å•äº†è§£ç›¸ä¼¼æ€§åº¦é‡</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E7%9B%B8%E4%BC%BC%E6%80%A7%E5%BA%A6%E9%87%8F.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E7%9B%B8%E4%BC%BC%E6%80%A7%E5%BA%A6%E9%87%8F.html</url>
      
        <content type="html"><![CDATA[<h1 id="ç›¸ä¼¼æ€§åº¦é‡-similarity-metric">ç›¸ä¼¼æ€§åº¦é‡ Similarity Metric</h1><p>äº†è§£ä¸åŒç›¸ä¼¼æ€§åº¦é‡æ–¹å¼ä¹‹é—´çš„åŒºåˆ«å’Œä¼˜ç¼ºç‚¹ï¼Œä¸ºæœ€ä½³ç›¸ä¼¼æ€§åº¦é‡æ–¹å¼é€‰æ‹©åšå‡ºæ˜æ™ºçš„å†³å®š</p><p>åœ¨ä¸‹è¡¨ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­è®¨è®ºçš„ç›¸ä¼¼æ€§åº¦é‡ä»¥åŠå½±å“åº¦é‡çš„å‘é‡çš„å±æ€§</p><table><thead><tr class="header"><th style="text-align: center;">Similarity Metric</th><th style="text-align: center;">ä½¿ç”¨å‘é‡ç‰¹å¾</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">æ¬§å‡ é‡Œå¾—è·ç¦»</td><td style="text-align: center;">è§’åº¦å’Œæ–¹å‘</td></tr><tr class="even"><td style="text-align: center;">ä½™å¼¦ç›¸ä¼¼åº¦</td><td style="text-align: center;">æ–¹å‘</td></tr><tr class="odd"><td style="text-align: center;">ç‚¹åŸºç›¸ä¼¼åº¦</td><td style="text-align: center;">è§’åº¦å’Œæ–¹å‘</td></tr></tbody></table><h2 id="æ¬§å‡ é‡Œå¾—è·ç¦»-euclidean-distance">æ¬§å‡ é‡Œå¾—è·ç¦» Euclideandistance</h2><p>æ¬§å‡ é‡Œå¾—è·ç¦»æ˜¯å¤šç»´ç©ºé—´ä¸­ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›´çº¿è·ç¦»ï¼Œè®¡ç®—å‘é‡ç›¸åº”åˆ†é‡ä¹‹é—´çš„å·®çš„å¹³æ–¹å’Œçš„æ ¹</p><p><strong>å¹³é¢ç©ºé—´ä¸­çš„è·ç¦»</strong></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.199ex;" xmlns="http://www.w3.org/2000/svg" width="29.624ex" height="4.208ex" role="img" focusable="false" viewBox="0 -1330.2 13094 1860"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mo" transform="translate(797.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msqrt" transform="translate(1853.6,0)"><g transform="translate(1020,0)"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(389,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(961,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1683.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(2683.4,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(3255.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="msup" transform="translate(3755.4,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(4803.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(5803.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(6192.4,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(6682.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(7404.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(8404.9,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(8894.9,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="msup" transform="translate(9394.9,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g><g data-mml-node="mo" transform="translate(0,120.2)"><path data-c="221A" d="M1001 1150Q1017 1150 1020 1132Q1020 1127 741 244L460 -643Q453 -650 436 -650H424Q423 -647 423 -645T421 -640T419 -631T415 -617T408 -594T399 -560T385 -512T367 -448T343 -364T312 -259L203 119L138 41L111 67L212 188L264 248L472 -474L983 1140Q988 1150 1001 1150Z"></path></g><rect width="10220.4" height="60" x="1020" y="1210.2"></rect></g></g></g></svg></mjx-container></span></p><p><strong>å‘é‡ä¹‹é—´çš„è·ç¦»</strong></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.199ex;" xmlns="http://www.w3.org/2000/svg" width="60.211ex" height="4.208ex" role="img" focusable="false" viewBox="0 -1330.2 26613.1 1860"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mo" transform="translate(520,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(909,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(1438,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1882.7,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(2311.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(2978.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msqrt" transform="translate(4034.2,0)"><g transform="translate(1020,0)"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(389,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mn" transform="translate(918,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1640.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(2640.4,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mn" transform="translate(3069.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="msup" transform="translate(3569.4,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(4617.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(5617.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(6006.4,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mn" transform="translate(6535.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(7257.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(8257.9,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mn" transform="translate(8686.9,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="msup" transform="translate(9186.9,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(10234.7,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(11234.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(11623.9,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mn" transform="translate(12152.9,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mo" transform="translate(12875.1,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(13875.3,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mn" transform="translate(14304.3,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="msup" transform="translate(14804.3,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(15629.9,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(16074.5,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(16519.2,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(16963.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(17352.9,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(17881.9,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(18704.1,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(19704.3,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mi" transform="translate(20133.3,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="msup" transform="translate(20733.3,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g><g data-mml-node="mo" transform="translate(0,120.2)"><path data-c="221A" d="M1001 1150Q1017 1150 1020 1132Q1020 1127 741 244L460 -643Q453 -650 436 -650H424Q423 -647 423 -645T421 -640T419 -631T415 -617T408 -594T399 -560T385 -512T367 -448T343 -364T312 -259L203 119L138 41L111 67L212 188L264 248L472 -474L983 1140Q988 1150 1001 1150Z"></path></g><rect width="21558.9" height="60" x="1020" y="1210.2"></rect></g></g></g></svg></mjx-container></span></p><p><strong>Java ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EuclideanDistance</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">calculateDistance</span><span class="params">(<span class="type">double</span>[] vector1, <span class="type">double</span>[] vector2)</span> {</span><br><span class="line">        <span class="keyword">if</span> (vector1.length != vector2.length) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"Vector dimensions must be the same"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; vector1.length; i++) {</span><br><span class="line">            <span class="type">double</span> <span class="variable">difference</span> <span class="operator">=</span> vector1[i] - vector2[i];</span><br><span class="line">            sum += difference * difference;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Math.sqrt(sum);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">double</span>[] vector1 = {<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>};</span><br><span class="line">        <span class="type">double</span>[] vector2 = {<span class="number">4.0</span>, <span class="number">5.0</span>, <span class="number">6.0</span>};</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> calculateDistance(vector1, vector2);</span><br><span class="line">        System.out.println(<span class="string">"Euclidean distance: "</span> + distance);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>ä¼˜åŠ¿<ul><li>ç®€å•ç›´è§‚</li><li>å¯¹è§’åº¦å’Œæ–¹å‘éƒ½æ•æ„Ÿ</li></ul></li><li>ç¼ºç‚¹<ul><li>é«˜ç»´è¯…å’’ï¼ˆcurse of dimensionalityï¼‰ï¼›åœ¨é«˜ç»´ä¸­è¡¨ç°ä¸ä½³</li></ul></li><li>ç”¨ä¾‹<ul><li>å›¾åƒè¯†åˆ«ã€è¯­éŸ³è¯†åˆ«ã€ç¬”è¿¹åˆ†æï¼›äººè„¸è¯†åˆ«</li></ul></li></ul><h2 id="ç‚¹ç§¯-dot-product">ç‚¹ç§¯ Dot Product</h2><p>ä¹Ÿå¯ä»¥ç§°ä¸ºå†…ç§¯ Inner Product</p><p>å‘é‡çš„ç‚¹ç§¯ç»™å‡ºäº†ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’ä½™å¼¦å€¼ï¼Œä»è€Œåæ˜ äº†å®ƒä»¬çš„æ–¹å‘ç›¸ä¼¼ç¨‹åº¦ï¼›å½“ä¸¤ä¸ªå‘é‡çš„ç‚¹ç§¯ä¸ºæ­£æ—¶ï¼Œå®ƒä»¬çš„æ–¹å‘å¤§è‡´ç›¸åŒï¼›å½“ç‚¹ç§¯ä¸ºè´Ÿæ—¶ï¼Œå®ƒä»¬çš„æ–¹å‘å¤§è‡´ç›¸åï¼›å½“ç‚¹ç§¯ä¸ºé›¶æ—¶ï¼Œå®ƒä»¬çš„æ–¹å‘å¤§è‡´å‚ç›´</p><p>ç‚¹ç§¯è¿˜å¯ä»¥ç”¨äºè®¡ç®—å‘é‡åœ¨å¦ä¸€ä¸ªå‘é‡ä¸Šçš„æŠ•å½±ã€‚é€šè¿‡è®¡ç®—ä¸€ä¸ªå‘é‡åœ¨å¦ä¸€ä¸ªå‘é‡ä¸Šçš„æŠ•å½±é•¿åº¦ï¼Œå¯ä»¥äº†è§£ä¸€ä¸ªå‘é‡åœ¨å¦ä¸€ä¸ªå‘é‡æ–¹å‘ä¸Šçš„åˆ†é‡å¤§å°</p><p><strong>ç‚¹ç§¯è®¡ç®—</strong></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="38.162ex" height="1.756ex" role="img" focusable="false" viewBox="0 -694 16867.8 776"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(751.2,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(1251.4,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(1958.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(3014,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mn" transform="translate(3543,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(4265.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(5265.4,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mn" transform="translate(5694.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(6416.7,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(7416.9,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mn" transform="translate(7945.9,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(8668.1,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(9668.3,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mn" transform="translate(10097.3,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(10597.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(11375.3,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(11820,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(12264.7,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(12709.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(13487.3,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(14016.3,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(14838.6,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(15838.8,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mi" transform="translate(16267.8,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container></span> <strong>ä½¿ç”¨è½¬ç½®çŸ©é˜µè¡¨ç¤º</strong> <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="13.066ex" height="2.203ex" role="img" focusable="false" viewBox="0 -891.7 5775.2 973.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(751.2,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(1251.4,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(1958.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msup" transform="translate(3014,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="TeXAtom" transform="translate(562,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g></g></g><g data-mml-node="mo" transform="translate(4346,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(5346.2,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></svg></mjx-container></span></p><p><strong>Java ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DotProduct</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">double</span>[] vectorA = {<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>};</span><br><span class="line">        <span class="type">double</span>[] vectorB = {<span class="number">4.0</span>, <span class="number">5.0</span>, <span class="number">6.0</span>};</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">dotProduct</span> <span class="operator">=</span> calculateDotProduct(vectorA, vectorB);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Dot product: "</span> + dotProduct);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">calculateDotProduct</span><span class="params">(<span class="type">double</span>[] vectorA, <span class="type">double</span>[] vectorB)</span> {</span><br><span class="line">        <span class="keyword">if</span> (vectorA.length != vectorB.length) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"Vector dimensions do not match"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">dotProduct</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; vectorA.length; i++) {</span><br><span class="line">            dotProduct += vectorA[i] * vectorB[i];</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dotProduct;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>ä¼˜åŠ¿<ul><li>è®¡ç®—é€Ÿåº¦å¿«</li><li>åŒæ—¶åæ˜ å‘é‡çš„å¤§å°å’Œæ–¹å‘</li></ul></li><li>ç¼ºç‚¹<ul><li>ä¸æ­¢å¯¹æ–¹å‘æ•æ„Ÿï¼ŒåŒæ—¶å¯¹å¤§å°æ•æ„Ÿ</li></ul></li><li>ç”¨ä¾‹<ul><li>æ¨èç³»ç»Ÿï¼ŒååŒè¿‡æ»¤ï¼ŒçŸ©é˜µåˆ†è§£</li></ul></li></ul><h2 id="ä½™å¼¦ç›¸ä¼¼åº¦-cosine-similarity">ä½™å¼¦ç›¸ä¼¼åº¦ Cosine Similarity</h2><p>ä½™å¼¦ç›¸ä¼¼æ€§æ˜¯ä¸¤ä¸ªå‘é‡ä¹‹é—´è§’åº¦çš„åº¦é‡ï¼Œå®ƒæ˜¯é€šè¿‡å–å‘é‡çš„ç‚¹ç§¯å¹¶å°†å…¶é™¤ä»¥å…¶å¤§å°çš„ä¹˜ç§¯æ¥è®¡ç®—çš„ï¼Œæ‰€ä»¥<strong>ä½™å¼¦ç›¸ä¼¼åº¦ä¸å—å‘é‡å¤§å°çš„å½±å“ï¼Œåªå—å‘é‡ä¹‹é—´çš„è§’åº¦çš„å½±å“</strong></p><p>å³åªè¦å€¼å¤§æˆ–å€¼å°çš„å‘é‡æŒ‡å‘åŒä¸€æ–¹å‘ï¼Œå®ƒä»¬å°±å…·æœ‰ç›¸åŒçš„ä½™å¼¦ç›¸ä¼¼æ€§</p><p><strong>ä½™å¼¦ç›¸ä¼¼åº¦</strong></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.17ex;" xmlns="http://www.w3.org/2000/svg" width="21.608ex" height="5.269ex" role="img" focusable="false" viewBox="0 -1370 9550.7 2329"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(469,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(814,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(1692,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(2081,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(2610,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(3054.7,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(3483.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(4150.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(5206.2,0)"><g data-mml-node="mrow" transform="translate(1332,676)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(751.2,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(1251.4,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g><g data-mml-node="mrow" transform="translate(220,-709.5)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(278,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(556,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(1085,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(1363,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(1863.2,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mo" transform="translate(2363.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(2641.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(2919.4,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(3348.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(3626.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g></g><rect width="4104.4" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></span></p><p><strong>èŒƒæ•°</strong></p><p><code>||A||</code>è¡¨ç¤ºå‘é‡ Açš„æ¨¡ï¼ˆèŒƒæ•°ï¼‰ï¼Œä¹Ÿç§°ä¸ºå‘é‡çš„é•¿åº¦æˆ–å¤§å°ï¼Œæ˜¯é€šè¿‡å¯¹å‘é‡çš„å…ƒç´ è¿›è¡ŒæŸç§æ•°å­¦è¿ç®—åå¾—åˆ°çš„ä¸€ä¸ªæ ‡é‡å€¼ï¼Œç”¨äºè¡¡é‡å‘é‡çš„å¤§å°</p><p>å¸¸è§çš„å‘é‡èŒƒæ•°æœ‰å¤šç§å®šä¹‰ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯æ¬§å‡ é‡Œå¾—èŒƒæ•°ï¼ˆL2 èŒƒæ•°ï¼‰</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.564ex;" xmlns="http://www.w3.org/2000/svg" width="36.084ex" height="3.085ex" role="img" focusable="false" viewBox="0 -1114.2 15949.2 1363.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mo" transform="translate(278,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(556,0)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(1306,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="msub" transform="translate(1584,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mn" transform="translate(311,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(2576.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msqrt" transform="translate(3632.1,0)"><g transform="translate(1020,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="msup" transform="translate(529,0)"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mn" transform="translate(533,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(1687.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(2688,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="msup" transform="translate(3217,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mn" transform="translate(533,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(4375.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(5376,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="msup" transform="translate(5905,0)"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mn" transform="translate(533,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(6841.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(7619.5,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(8064.2,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(8508.9,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(8953.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(9731.5,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="msup" transform="translate(10260.5,0)"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(633,289) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g><g data-mml-node="mo" transform="translate(0,204.2)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"></path></g><rect width="11297.1" height="60" x="1020" y="994.2"></rect></g></g></g></svg></mjx-container></span></p><p><strong>Java ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CosineSimilarity</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">calculateCosineSimilarity</span><span class="params">(<span class="type">double</span>[] vector1, <span class="type">double</span>[] vector2)</span> {</span><br><span class="line">        <span class="keyword">if</span> (vector1.length != vector2.length) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"Vector dimensions must be the same"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">dotProduct</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">normA</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">normB</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; vector1.length; i++) {</span><br><span class="line">            dotProduct += vector1[i] * vector2[i];</span><br><span class="line">            normA += Math.pow(vector1[i], <span class="number">2</span>);</span><br><span class="line">            normB += Math.pow(vector2[i], <span class="number">2</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> similarity;</span><br><span class="line">        <span class="keyword">if</span> (normA == <span class="number">0</span> || normB == <span class="number">0</span>) {</span><br><span class="line">            similarity = <span class="number">0.0</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">          <span class="comment">// è¿™é‡Œå°±æ˜¯åœ¨è®¡ç®—ä¸¤ä¸ªå‘é‡ L2 èŒƒæ•°çš„ç§¯</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">denominator</span> <span class="operator">=</span> Math.sqrt(normA) * Math.sqrt(normB);</span><br><span class="line">            similarity = dotProduct / denominator;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> similarity;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">double</span>[] vector1 = {<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>};</span><br><span class="line">        <span class="type">double</span>[] vector2 = {<span class="number">4.0</span>, <span class="number">5.0</span>, <span class="number">6.0</span>};</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">similarity</span> <span class="operator">=</span> calculateCosineSimilarity(vector1, vector2);</span><br><span class="line">        System.out.println(<span class="string">"Cosine similarity: "</span> + similarity);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>ä¼˜åŠ¿<ul><li>ä¸»è¦è€ƒè™‘å‘é‡çš„æ–¹å‘ï¼Œä½¿å…¶éå¸¸é€‚åˆé«˜ç»´ç©ºé—´ï¼Œå¦‚æ–‡æœ¬æ¯”è¾ƒï¼Œå…¶ä¸­æ–‡æ¡£çš„é•¿åº¦å¯èƒ½å¹¶ä¸é‡è¦</li></ul></li><li>ç¼ºç‚¹<ul><li>å½“å‘é‡çš„å¤§å°å¾ˆé‡è¦æ—¶ï¼Œä¾‹å¦‚å½“åŸºäºåƒç´ å¼ºåº¦æ¯”è¾ƒå›¾åƒåµŒå…¥æ—¶å¹¶ä¸é€‚ç”¨ï¼›å¦‚æœæ•°æ®ä¸å½¢æˆå‡¸é›†ï¼Œåˆ™å¯èƒ½æ— æ³•æä¾›å‡†ç¡®çš„ç›¸ä¼¼æ€§åº¦é‡</li></ul></li><li>ç”¨ä¾‹<ul><li>æ–‡æ¡£åˆ†ç±»ã€è¯­ä¹‰æœç´¢ã€æ¨èç³»ç»Ÿä»¥åŠæ¶‰åŠé«˜ç»´å’Œè§„èŒƒåŒ–æ•°æ®çš„ä»»ä½•å…¶ä»–ä»»åŠ¡</li></ul></li></ul><h1 id="å½’ä¸€åŒ–-normalization">å½’ä¸€åŒ– Normalization</h1><p>å½’ä¸€åŒ–æ˜¯å°†æ•°æ®æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œä½¿å…¶è½å…¥ç‰¹å®šçš„èŒƒå›´ï¼›åœ¨æ•°æ®å¤„ç†å’Œåˆ†æä¸­ï¼Œå½’ä¸€åŒ–é€šå¸¸ç”¨äºå°†ä¸åŒèŒƒå›´å’Œå•ä½çš„æ•°æ®è½¬åŒ–ä¸ºç»Ÿä¸€çš„æ ‡å‡†ï¼Œä»¥æ¶ˆé™¤ç”±äºæ•°æ®å°ºåº¦ä¸åŒè€Œå¼•èµ·çš„åå·®</p><p>åœ¨å‘é‡çš„æƒ…å†µä¸‹ï¼Œå½’ä¸€åŒ–ä¹Ÿè¢«ç§°ä¸ºå‘é‡çš„æ ‡å‡†åŒ–ï¼Œå®ƒæ˜¯å°†å‘é‡æŒ‰ç…§å…¶èŒƒæ•°ï¼ˆæ¨¡ï¼‰è¿›è¡Œç¼©æ”¾ï¼Œä½¿å¾—å‘é‡çš„èŒƒæ•°ä¸ºä¸€ä¸ªå›ºå®šå€¼ï¼Œé€šå¸¸ä¸º1</p><p>é€šè¿‡å½’ä¸€åŒ–ï¼Œå¯ä»¥æ¶ˆé™¤å‘é‡é•¿åº¦çš„å½±å“ï¼Œåªå…³æ³¨å‘é‡çš„æ–¹å‘ï¼Œä»è€Œæ›´å¥½åœ°æ¯”è¾ƒå’Œåº¦é‡å‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="39.692ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 17544.1 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="TeXAtom" transform="translate(861,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(600,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(1085,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1536,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(2414,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(2943,0)"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></g><g data-mml-node="mi" transform="translate(3241,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3586,0)"><path data-c="1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path></g><g data-mml-node="mi" transform="translate(4051,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(4517,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g><g data-mml-node="mo" transform="translate(4750.5,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(5806.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(6195.3,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mo" transform="translate(6989.5,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="msub" transform="translate(7989.7,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(878,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1223,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="mo" transform="translate(9933.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(10545,0)"><path data-c="F7" d="M318 466Q318 500 339 518T386 537Q418 537 438 517T458 466Q458 438 440 417T388 396Q355 396 337 417T318 466ZM56 237T56 250T70 270H706Q721 262 721 250T706 230H70Q56 237 56 250ZM318 34Q318 68 339 86T386 105Q418 105 438 85T458 34Q458 6 440 -15T388 -36Q355 -36 337 -15T318 34Z"></path></g><g data-mml-node="mo" transform="translate(11545.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(11934.2,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(878,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(1407,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g></g></g><g data-mml-node="mo" transform="translate(14210.8,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="msub" transform="translate(15211,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(878,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1223,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="mo" transform="translate(17155.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></span></p><p><strong>ä¸¾ä¸€ä¸ªä¾‹å­</strong></p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«èº«é«˜å’Œä½“é‡çš„æ•°æ®é›†ï¼Œå…¶ä¸­èº«é«˜ä»¥å˜ç±³ä¸ºå•ä½ï¼Œä½“é‡ä»¥åƒå…‹ä¸ºå•ä½ã€‚æ•°æ®é›†å¦‚ä¸‹ï¼š</p><table><thead><tr class="header"><th style="text-align: center;">ç¼–å·</th><th style="text-align: center;">èº«é«˜ï¼ˆå˜ç±³ï¼‰</th><th style="text-align: center;">ä½“é‡ï¼ˆåƒå…‹ï¼‰</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">180</td><td style="text-align: center;">75</td></tr><tr class="even"><td style="text-align: center;">2</td><td style="text-align: center;">165</td><td style="text-align: center;">60</td></tr><tr class="odd"><td style="text-align: center;">3</td><td style="text-align: center;">175</td><td style="text-align: center;">80</td></tr><tr class="even"><td style="text-align: center;">4</td><td style="text-align: center;">158</td><td style="text-align: center;">52</td></tr></tbody></table><p>ä¸ºäº†å°†èº«é«˜å’Œä½“é‡å½’ä¸€åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç‰¹å®šçš„å½’ä¸€åŒ–æ–¹æ³•ï¼Œä¾‹å¦‚å°†æ•°æ®ç¼©æ”¾åˆ°0 åˆ° 1 ä¹‹é—´çš„èŒƒå›´</p><p>èº«é«˜çš„æœ€å¤§å€¼ X_min_height = 158</p><p>èº«é«˜çš„æœ€å°å€¼ X_max_height = 180</p><table><thead><tr class="header"><th style="text-align: center;">ç¼–å·</th><th style="text-align: center;">å½’ä¸€åŒ–èº«é«˜</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">(180 - 158) / (180 - 158) = 1.0</td></tr><tr class="even"><td style="text-align: center;">2</td><td style="text-align: center;">(165 - 158) / (180 - 158) â‰ˆ 0.4286</td></tr><tr class="odd"><td style="text-align: center;">3</td><td style="text-align: center;">(175 - 158) / (180 - 158) â‰ˆ 0.8571</td></tr><tr class="even"><td style="text-align: center;">4</td><td style="text-align: center;">(158 - 158) / (180 - 158) = 0.0</td></tr></tbody></table><p>ä½“é‡çš„æœ€å°å€¼ï¼šX_min_weight = 52</p><p>ä½“é‡çš„æœ€å¤§å€¼ï¼šX_max_weight = 80</p><table><thead><tr class="header"><th style="text-align: center;">ç¼–å·</th><th style="text-align: center;">å½’ä¸€åŒ–ä½“é‡</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">(75 - 52) / (80 - 52) â‰ˆ 0.6</td></tr><tr class="even"><td style="text-align: center;">2</td><td style="text-align: center;">(60 - 52) / (80 - 52) â‰ˆ 0.2</td></tr><tr class="odd"><td style="text-align: center;">3</td><td style="text-align: center;">(80 - 52) / (80 - 52) = 1.0</td></tr><tr class="even"><td style="text-align: center;">4</td><td style="text-align: center;">(52 - 52) / (80 - 52) = 0.0</td></tr></tbody></table><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå½’ä¸€åŒ–å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°æ¯”è¾ƒå’Œåˆ†æä¸åŒç‰¹å¾çš„æ•°æ®ï¼Œå¹¶å‡å°‘ç”±äºæ•°æ®å°ºåº¦ä¸åŒè€Œå¼•èµ·çš„åå·®</p><p><strong>Java ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Normalization</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">double</span>[] array = {<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>};</span><br><span class="line">        <span class="type">double</span>[] normalizedArray = normalize(array);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å°å½’ä¸€åŒ–åçš„æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">double</span> element : normalizedArray) {</span><br><span class="line">            System.out.println(element);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span>[] normalize(<span class="type">double</span>[] array) {</span><br><span class="line">        <span class="type">double</span> <span class="variable">min</span> <span class="operator">=</span> Double.MAX_VALUE;</span><br><span class="line">        <span class="type">double</span> <span class="variable">max</span> <span class="operator">=</span> Double.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰¾åˆ°æ•°ç»„ä¸­çš„æœ€å°å€¼å’Œæœ€å¤§å€¼</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">double</span> element : array) {</span><br><span class="line">            <span class="keyword">if</span> (element &lt; min) {</span><br><span class="line">                min = element;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (element &gt; max) {</span><br><span class="line">                max = element;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½’ä¸€åŒ–æ•°ç»„</span></span><br><span class="line">        <span class="type">double</span>[] normalizedArray = <span class="keyword">new</span> <span class="title class_">double</span>[array.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; array.length; i++) {</span><br><span class="line">            normalizedArray[i] = (array[i] - min) / (max - min);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> normalizedArray;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h1 id="å‡¸é›†-convex-set">å‡¸é›† Convex Set</h1><p>å¦‚æœä¸€ç»„å‘é‡æ•°æ®è¢«è®¤ä¸ºæ˜¯å‡¸é›†ï¼Œé‚£ä¹ˆå¯¹äºè¿™ç»„å‘é‡ä¸­çš„ä»»æ„ä¸¤ä¸ªå‘é‡ï¼Œå®ƒä»¬ä¹‹é—´çš„çº¿æ®µä¸Šçš„æ‰€æœ‰ç‚¹ä¹Ÿå±äºè¿™ç»„å‘é‡æ•°æ®ï¼›æ¢å¥è¯è¯´ï¼Œè¿™ç»„å‘é‡æ•°æ®ä¸­çš„ä»»æ„ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è¿æ¥çº¿æ®µä¸Šçš„æ‰€æœ‰å‘é‡ä¹Ÿå±äºè¿™ç»„å‘é‡æ•°æ®</p><p>åœ¨ä½™å¼¦ç›¸ä¼¼åº¦ä¸­æåˆ°ï¼Œå¦‚æœæ•°æ®ä¸å½¢æˆå‡¸é›†ï¼Œåˆ™å¯èƒ½æ•ˆæœä¸å¥½</p><p>åŸå› æ˜¯ç›¸ä¼¼åº¦å‡è®¾äº†å‘é‡ä¹‹é—´çš„è§’åº¦å¯ä»¥åæ˜ å®ƒä»¬çš„ç›¸ä¼¼æ€§</p><p>å¯¹äºéå‡¸é›†çš„æ•°æ®ï¼Œç”±äºæ•°æ®çš„åˆ†å¸ƒå½¢çŠ¶ä¸ç¬¦åˆå‡¸é›†çš„ç‰¹æ€§ï¼Œå‘é‡ä¹‹é—´çš„è§’åº¦å¯èƒ½æ— æ³•å‡†ç¡®åœ°åæ˜ å®ƒä»¬çš„ç›¸ä¼¼æ€§ï¼Œéå‡¸é›†çš„æ•°æ®åˆ†å¸ƒå¯èƒ½ä¼šå¯¼è‡´å‘é‡ä¹‹é—´çš„å¤¹è§’ä¸å‡†ç¡®ï¼Œä»è€Œå½±å“ä½™å¼¦ç›¸ä¼¼æ€§çš„è®¡ç®—ç»“æœ</p><p><strong>Java ä»£ç åˆ¤æ–­å‡¸é›†</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConvexSetChecker</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isConvexSet</span><span class="params">(List&lt;<span class="type">double</span>[]&gt; vectors)</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> vectors.size();</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">3</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// å¦‚æœå‘é‡æ•°é‡å°äº3ï¼Œåˆ™è®¤ä¸ºæ˜¯å‡¸é›†</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">            <span class="type">double</span>[] vector1 = vectors.get(i);</span><br><span class="line">            <span class="type">double</span>[] vector2 = vectors.get((i + <span class="number">1</span>) % n);</span><br><span class="line">            <span class="type">double</span>[] vector3 = vectors.get((i + <span class="number">2</span>) % n);</span><br><span class="line">            </span><br><span class="line">            <span class="type">double</span> <span class="variable">crossProduct</span> <span class="operator">=</span> calculateCrossProduct(vector1, vector2, vector3);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (crossProduct &lt; <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// å¦‚æœå­˜åœ¨å‘é‡ä¸‰å…ƒç»„çš„å‰ä¹˜ç»“æœå°äº0ï¼Œåˆ™ä¸æ˜¯å‡¸é›†</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">calculateCrossProduct</span><span class="params">(<span class="type">double</span>[] vector1, <span class="type">double</span>[] vector2, <span class="type">double</span>[] vector3)</span> {</span><br><span class="line">        <span class="type">double</span> <span class="variable">x1</span> <span class="operator">=</span> vector2[<span class="number">0</span>] - vector1[<span class="number">0</span>];</span><br><span class="line">        <span class="type">double</span> <span class="variable">y1</span> <span class="operator">=</span> vector2[<span class="number">1</span>] - vector1[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">x2</span> <span class="operator">=</span> vector3[<span class="number">0</span>] - vector2[<span class="number">0</span>];</span><br><span class="line">        <span class="type">double</span> <span class="variable">y2</span> <span class="operator">=</span> vector3[<span class="number">1</span>] - vector2[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> x1 * y2 - x2 * y1;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// ç¤ºä¾‹ç”¨ä¾‹</span></span><br><span class="line">        List&lt;<span class="type">double</span>[]&gt; vectors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        vectors.add(<span class="keyword">new</span> <span class="title class_">double</span>[]{<span class="number">0</span>, <span class="number">0</span>});</span><br><span class="line">        vectors.add(<span class="keyword">new</span> <span class="title class_">double</span>[]{<span class="number">1</span>, <span class="number">0</span>});</span><br><span class="line">        vectors.add(<span class="keyword">new</span> <span class="title class_">double</span>[]{<span class="number">0</span>, <span class="number">1</span>});</span><br><span class="line">        </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isConvex</span> <span class="operator">=</span> isConvexSet(vectors);</span><br><span class="line">        System.out.println(<span class="string">"æ˜¯å¦ä¸ºå‡¸é›†: "</span> + isConvex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://www.imaurer.com/which-vector-similarity-metric-should-i-use/">Whichvector similarity metric should I use? (imaurer.com)</a></p><p><a href="https://www.pinecone.io/learn/vector-similarity/">VectorSimilarity Explained | Pinecone</a></p><p><a href="https://zhuanlan.zhihu.com/p/33164335">æ¨èç®—æ³•å…¥é—¨ï¼ˆ1ï¼‰ç›¸ä¼¼åº¦è®¡ç®—æ–¹æ³•å¤§å…¨- çŸ¥ä¹ (zhihu.com)</a></p><p>Hexo æ•°å­¦å…¬å¼æ”¯æŒï¼š</p><ul><li><a href="https://blog.csdn.net/weixin_45511189/article/details/115798563">hexoåšå®¢nextä¸»é¢˜æ·»åŠ å¯¹æ•°å­¦å…¬å¼çš„æ”¯æŒ_hexonext å…¬å¼-CSDNåšå®¢</a></li><li><a href="https://www.jianshu.com/p/8424da4dd673">Hexo NexTä¸»é¢˜å¯¹æ•°å­¦å…¬å¼çš„æ”¯æŒ - ç®€ä¹¦ (jianshu.com)</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> Vector DB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DB </tag>
            
            <tag> Vector DB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.6 - é“¾</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.6%20-%20%E9%93%BE.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.6%20-%20%E9%93%BE.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯é“¾">ä»€ä¹ˆæ˜¯é“¾</h1><p>LangChain ä¸­é€šè¿‡ Chainæ¥é“¾æ¥å„ä¸ªç»„ä»¶å’ŒåŠŸèƒ½ï¼Œæ¨¡å‹ä¹‹é—´å½¼æ­¤é“¾æ¥ï¼Œæˆ–æ¨¡å‹ä¸å…¶ä»–ç»„ä»¶é“¾æ¥</p><p>å°†å¤šä¸ªç»„ä»¶ç›¸äº’é“¾æ¥ï¼Œç»„åˆæˆä¸€ä¸ªé“¾çš„æƒ³æ³•ç®€å•ä½†å¼ºå¤§ï¼Œç®€åŒ–äº†å¤æ‚åº”ç”¨ç¨‹åºçš„å®ç°ï¼Œä½¿ä¹‹æ›´åŠ æ¨¡å—åŒ–ï¼Œèƒ½å¤Ÿåˆ›å»ºå‡ºå•ä¸€çš„ã€è¿è´¯çš„åº”ç”¨ç¨‹åºï¼Œä»è€Œä½¿è°ƒè¯•ã€ç»´æŠ¤å’Œæ”¹è¿›åº”ç”¨ç¨‹åºå˜å¾—å®¹æ˜“ï¼›è¿™ä¹Ÿæ˜¯LangChain åç§°çš„ç”±æ¥</p><p>éœ€è¦æ³¨æ„ï¼Œåœ¨ç°ç‰ˆæœ¬ä¸­ LangChain å·²ç»åœ¨ä¸»æ¨ LangChain ExpressionLanguageï¼ˆLCELï¼‰ï¼Œé€æ¸åºŸå¼ƒæ—§ç‰ˆæœ¬ä¸­æ‰‹åŠ¨åˆ›å»º Chain çš„æ–¹å¼ä»¥åŠæ—§çš„ Chainå®ç°ï¼Œä¸è¿‡è¿™é‡Œä¹Ÿå‚è€ƒæ—©æœŸ Chain çš„ä½¿ç”¨æ–¹å¼ï¼ŒLCEL ç•™åœ¨åé¢è¿›è¡Œå­¦ä¹ </p><p>é“¾çš„ä½¿ç”¨ä¸»è¦æ˜¯ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li>é€šè¿‡è®¾è®¡å¥½çš„æ¥å£ï¼Œå®ç°ä¸€ä¸ªå…·ä½“çš„é“¾çš„åŠŸèƒ½ï¼›ä¾‹å¦‚ LLMé“¾ï¼ˆLLMChainï¼‰èƒ½å¤Ÿæ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä½¿ç”¨ PromptTemplateå¯¹å…¶è¿›è¡Œæ ¼å¼åŒ–ï¼Œç„¶åå°†æ ¼å¼åŒ–çš„å“åº”ä¼ é€’ç»™ LLMï¼›è¿™å°±ç›¸å½“äºæŠŠæ•´ä¸ªModelI/Oçš„æµç¨‹å°è£…åˆ°é“¾é‡Œé¢</li><li>å®ç°äº†é“¾çš„å…·ä½“åŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¤šä¸ªé“¾ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆ–è€…å°†é“¾ä¸å…¶ä»–ç»„ä»¶ç»„åˆæ¥æ„å»ºæ›´å¤æ‚çš„é“¾</li></ol><p>é“¾å¯ä»¥ç†è§£ä¸ºå¯¹ä¸€ç»„åŸºç¡€åŠŸèƒ½çš„å°è£…ï¼Œå…·æœ‰ä¸€ä¸ªå®Œæ•´åŠŸèƒ½çš„ç»„ä»¶ï¼Œè¿™ä¹ˆçœ‹æ¥<strong>é“¾å…¶å®å¯ä»¥è¢«è§†ä¸ºLangChain ä¸­çš„ä¸€ç§åŸºæœ¬åŠŸèƒ½å•å…ƒ</strong></p><h1 id="llmchain">LLMChain</h1><p>LLMChainå›´ç»•ç€è¯­è¨€æ¨¡å‹æ¨ç†åŠŸèƒ½åˆæ·»åŠ äº†ä¸€äº›åŠŸèƒ½ï¼Œæ•´åˆäº†PromptTemplateã€è¯­è¨€æ¨¡å‹ï¼ˆLLMæˆ–èŠå¤©æ¨¡å‹ï¼‰å’Œ Output Parserï¼Œç›¸å½“äºæŠŠ Model I/Oæ”¾åœ¨ä¸€ä¸ªé“¾ä¸­æ•´ä½“æ“ä½œï¼Œå®ƒä½¿ç”¨æç¤ºæ¨¡æ¿æ ¼å¼åŒ–è¾“å…¥ï¼Œå°†æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ä¼ é€’ç»™LLMï¼Œå¹¶è¿”å› LLM è¾“å‡º</p><p>ä¸¾ä¸€ä¸ªç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ----ç¬¬ä¸€æ­¥ åˆ›å»ºæç¤º</span></span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="comment"># åŸå§‹å­—ç¬¦ä¸²æ¨¡æ¿</span></span><br><span class="line">template = <span class="string">&quot;&#123;name&#125;çš„å¤–å·æ˜¯?&quot;</span></span><br><span class="line"><span class="comment"># åˆ›å»º Prompt æ¨¡æ¿</span></span><br><span class="line">prompt_temp = PromptTemplate.from_template(template)</span><br><span class="line"><span class="comment"># æ ¹æ®æ¨¡æ¿åˆ›å»ºæç¤º</span></span><br><span class="line">prompt = prompt_temp.<span class="built_in">format</span>(name=<span class="string">&#x27;éœé‡‘&#x27;</span>)</span><br><span class="line"><span class="comment"># æ‰“å°æç¤ºçš„å†…å®¹</span></span><br><span class="line"><span class="built_in">print</span>(prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----ç¬¬äºŒæ­¥ åˆ›å»ºå¹¶è°ƒç”¨æ¨¡å‹</span></span><br><span class="line"><span class="keyword">import</span> Azure</span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">model = Azure.chat_model</span><br><span class="line"><span class="comment"># ä¼ å…¥æç¤ºï¼Œè°ƒç”¨æ¨¡å‹ï¼Œè¿”å›ç»“æœ</span></span><br><span class="line">result = model.predict(prompt)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">éœé‡‘çš„å¤–å·æ˜¯?</span><br><span class="line">éœé‡‘çš„å¤–å·æ˜¯â€œé»‘æ´å…ˆç”Ÿâ€ã€‚</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ Model I/Oçš„å®ç°åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œæç¤ºæ¨¡æ¿çš„æ„å»ºå’Œæ¨¡å‹çš„è°ƒç”¨ç‹¬ç«‹å¤„ç†ï¼Œå¦‚æœå†åŠ ä¸Šè¾“å‡ºè§£æå™¨åˆ™ä¾ç„¶éœ€è¦ç‹¬ç«‹è°ƒç”¨</p><p>å¦‚æœä½¿ç”¨ LLMChain åˆ™å¯ä»¥å°†è¿™å‡ éƒ¨åˆ†ç»“åˆåœ¨ä¸€èµ·ï¼Œä½¿è¿‡ç¨‹æ›´åŠ ç®€æ´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥æ‰€éœ€çš„åº“</span></span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> PromptTemplate, OpenAI, LLMChain</span><br><span class="line"><span class="comment"># åŸå§‹å­—ç¬¦ä¸²æ¨¡æ¿</span></span><br><span class="line">template = <span class="string">&quot;&#123;name&#125;çš„å¤–å·æ˜¯?&quot;</span></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">llm = OpenAI(temperature=<span class="number">0</span>)</span><br><span class="line"><span class="comment"># åˆ›å»º LLMChain</span></span><br><span class="line">llm_chain = LLMChain(</span><br><span class="line">    llm=Azure.chat_model,</span><br><span class="line">    prompt=PromptTemplate.from_template(template))</span><br><span class="line"><span class="comment"># è°ƒç”¨ LLMChainï¼Œè¿”å›ç»“æœ</span></span><br><span class="line">result = llm_chain(<span class="string">&quot;é©¬æ–¯å…‹&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;é©¬æ–¯å…‹&#x27;</span>, <span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;é©¬æ–¯å…‹çš„å¤–å·æ˜¯â€œç«ç®­äººâ€æˆ–â€œé“äººâ€ã€‚&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><hr /><p><strong>Chain çš„è°ƒç”¨æ–¹å¼</strong></p><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç›´æ¥ä½¿ç”¨ <code>__call__</code> æ–¹æ³•å¯¹ Chainè¿›è¡Œè°ƒç”¨ï¼Œä¾‹å¦‚ <code>llm_chain("é©¬æ–¯å…‹")</code></p><p>Chain å…·æœ‰å¤šç§è°ƒç”¨æ–¹å¼ï¼š</p><ul><li><strong>call</strong>ï¼šæç¤ºæ¨¡æ¿ä¸­åŒ…å«å¤šä¸ªå˜é‡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å­—å…¸ä¸€æ¬¡æ€§è¾“å…¥</li><li><strong>run</strong>ï¼šç­‰ä»·äº <code>__call__</code></li><li><strong>predict</strong>ï¼šæ¨¡æ¿å˜é‡æ ¹æ®å…³é”®å­—å‚æ•°èµ‹å€¼è€Œä¸æ˜¯å­—å…¸</li><li><strong>apply</strong>ï¼šé’ˆå¯¹è¾“å…¥åˆ—è¡¨è¿è¡Œé“¾ï¼Œä¸€æ¬¡å¤„ç†å¤šä¸ªè¾“å…¥</li><li><strong>generate</strong>ï¼šç±»ä¼¼äº <code>apply</code>ï¼Œåªä¸è¿‡è¿”å›ä¸€ä¸ª<code>LLMResult</code> å¯¹è±¡è€Œä¸æ˜¯å­—ç¬¦ä¸² <code>LLMResult</code>é€šå¸¸åŒ…å«æ¨¡å‹ç”Ÿæˆæ–‡æœ¬è¿‡ç¨‹ä¸­çš„ä¸€äº›ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ä»¤ç‰Œæ•°é‡ã€æ¨¡å‹åç§°ç­‰</li></ul><h1 id="sequentialchain">SequentialChain</h1><p>æŒæ¡äº† LLMChain çš„åŸºæœ¬ç”¨æ³•ï¼Œå°±å¯ä»¥ä½¿ç”¨ SequentialChain å°†å‡ ä¸ªLLMChain ä¸²èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé¡ºåºé“¾</p><p><strong>ç¬¬ä¸€ä¸ª LLMChain - æ¨èç”µå½±</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">llm = Azure.chat_model</span><br><span class="line">template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ä½ æ˜¯ä¸€ä¸ªç”µå½±çˆ±å¥½è€…ï¼Œè¯·æ ¹æ®ç”¨æˆ·å¸Œæœ›çœ‹åˆ°çš„å‰§æƒ…å’Œæ ‡ç­¾ï¼Œæ¨èä¸€éƒ¨ç”µå½±ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å‰§æƒ…: &#123;plot&#125;</span></span><br><span class="line"><span class="string">æ ‡ç­¾: &#123;tag&#125;</span></span><br><span class="line"><span class="string">ç”µå½±çˆ±å¥½è€…: è¿™æ˜¯æˆ‘æ¨èçš„ç”µå½±:&quot;&quot;&quot;</span></span><br><span class="line">prompt_template = PromptTemplate(input_variables=[<span class="string">&quot;plot&quot;</span>, <span class="string">&quot;tag&quot;</span>], template=template)</span><br><span class="line">introduction_chain = LLMChain(llm=llm, prompt=prompt_template, output_key=<span class="string">&quot;movie_info&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>ç¬¬äºŒä¸ª LLMChain - è¯„è®ºç”µå½±</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">llm = Azure.chat_model</span><br><span class="line">template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ä½ æ˜¯ä¸€ä½ç”µå½±è¯„è®ºå®¶ï¼Œç»™ä½ ä¸€ä¸ªç”µå½±ä¿¡æ¯ï¼Œä½ éœ€è¦ä¸ºè¿™éƒ¨ç”µå½±å†™ä¸€ç¯‡100å­—å·¦å³çš„è¯„è®ºã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç”µå½±ä¿¡æ¯:</span></span><br><span class="line"><span class="string">&#123;movie_info&#125;</span></span><br><span class="line"><span class="string">ç”µå½±è¯„è®ºäººå¯¹ä¸Šè¿°ç”µå½±çš„è¯„è®º:&quot;&quot;&quot;</span></span><br><span class="line">prompt_template = PromptTemplate(input_variables=[<span class="string">&quot;movie_info&quot;</span>], template=template)</span><br><span class="line">review_chain = LLMChain(llm=llm, prompt=prompt_template, output_key=<span class="string">&quot;movie_review&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰ä¸ª LLMChain -æ ¹æ®ä¸Šé¢çš„äº§å‡ºå†™å‡ºä¸€ç¯‡è‡ªåª’ä½“çš„æ–‡æ¡ˆ</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ä½ æ˜¯ä¸€ä¸ªè¯„è®ºç”µå½±çš„è‡ªåª’ä½“æ–‡æ¡ˆæ’°ç¨¿äººã€‚ç»™å®šä¸€éƒ¨ç”µå½±çš„ä»‹ç»å’Œè¯„è®ºï¼Œä½ éœ€è¦ä¸ºè¿™éƒ¨ç”µå½±å†™ä¸€ç¯‡ç¤¾äº¤åª’ä½“çš„å¸–å­ï¼Œ200å­—å·¦å³ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç”µå½±ä»‹ç»:</span></span><br><span class="line"><span class="string">&#123;movie_info&#125;</span></span><br><span class="line"><span class="string">ç”µå½±è¯„è®ºäººå¯¹ä¸Šè¿°èŠ±çš„è¯„è®º:</span></span><br><span class="line"><span class="string">&#123;movie_review&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç¤¾äº¤åª’ä½“å¸–å­:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">prompt_template = PromptTemplate(input_variables=[<span class="string">&quot;movie_info&quot;</span>, <span class="string">&quot;movie_review&quot;</span>], template=template)</span><br><span class="line">social_post_chain = LLMChain(llm=llm, prompt=prompt_template, output_key=<span class="string">&quot;social_post_text&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨é¡ºåºé“¾é“¾æ¥èµ·æ¥</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‰é¡ºåºè¿è¡Œè¿™ä¸‰ä¸ªé“¾</span></span><br><span class="line">overall_chain = SequentialChain(</span><br><span class="line">    chains=[introduction_chain, review_chain, social_post_chain],</span><br><span class="line">    input_variables=[<span class="string">&quot;plot&quot;</span>, <span class="string">&quot;tag&quot;</span>],</span><br><span class="line">    output_variables=[<span class="string">&quot;movie_info&quot;</span>, <span class="string">&quot;movie_review&quot;</span>, <span class="string">&quot;social_post_text&quot;</span>],</span><br><span class="line">    verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œé“¾ï¼Œå¹¶æ‰“å°ç»“æœ</span></span><br><span class="line">result = overall_chain(&#123;<span class="string">&quot;plot&quot;</span>: <span class="string">&quot;æ¿€çƒˆçš„å¤ªç©ºæˆ˜æ–—&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;ä¸­å›½ã€ç§‘å¹»&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering new SequentialChain chain...</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br><span class="line">&#123;<span class="string">&#x27;plot&#x27;</span>: <span class="string">&#x27;æ¿€çƒˆçš„å¤ªç©ºæˆ˜æ–—&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;ä¸­å›½ã€ç§‘å¹»&#x27;</span>, <span class="string">&#x27;movie_info&#x27;</span>: <span class="string">&#x27;ã€Šæµæµªåœ°çƒã€‹\n\nã€Šæµæµªåœ°çƒã€‹æ˜¯ä¸€éƒ¨ä¸­å›½ç§‘å¹»ç”µå½±ï¼Œå®ƒå°†å¸¦æ‚¨è¿›å…¥ä¸€ä¸ªæ¿€çƒˆçš„å¤ªç©ºæˆ˜æ–—çš„ä¸–ç•Œã€‚æ•…äº‹å‘ç”Ÿåœ¨æœªæ¥ï¼Œå¤ªé˜³å³å°†ç­äº¡ï¼Œäººç±»å¿…é¡»å¯»æ‰¾æ–°çš„å®¶å›­ã€‚ä¸ºäº†æ‹¯æ•‘åœ°çƒï¼Œäººç±»å‘èµ·äº†ä¸€é¡¹å¤§èƒ†çš„è®¡åˆ’ï¼Œå°†åœ°çƒå˜æˆäº†ä¸€ä¸ªå·¨å¤§çš„å¤ªç©ºèˆ¹ï¼Œå‘å¤–å¤ªç©ºè¿å¾™ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªå±é™©çš„æ—…ç¨‹ä¸­ï¼Œä»–ä»¬é¢ä¸´ç€å„ç§æŒ‘æˆ˜å’Œå¤ªç©ºæˆ˜æ–—ã€‚ç”µå½±ä¸­å……æ»¡äº†ç´§å¼ åˆºæ¿€çš„åœºæ™¯å’ŒæƒŠäººçš„è§†è§‰æ•ˆæœï¼ŒåŒæ—¶ä¹Ÿå±•ç°äº†äººç±»çš„å‹‡æ°”å’Œå›¢ç»“ç²¾ç¥ã€‚\n\nã€Šæµæµªåœ°çƒã€‹æ˜¯ä¸€éƒ¨éå¸¸æˆåŠŸçš„ä¸­å›½ç§‘å¹»ç”µå½±ï¼Œå®ƒè·å¾—äº†å¹¿æ³›çš„èµèª‰å’Œç¥¨æˆ¿æˆåŠŸã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€éƒ¨å……æ»¡åŠ¨ä½œå’Œå¤ªç©ºæˆ˜æ–—çš„ç”µå½±ï¼Œè¿˜æ¢è®¨äº†äººç±»å¯¹äºæœªæ¥å’Œç”Ÿå­˜çš„æ€è€ƒã€‚å¦‚æœæ‚¨å–œæ¬¢æ¿€çƒˆçš„å¤ªç©ºæˆ˜æ–—å’Œç§‘å¹»é¢˜æï¼Œè¿™éƒ¨ç”µå½±å°†ä¼šæ˜¯æ‚¨çš„ä¸é”™é€‰æ‹©ã€‚&#x27;</span>, <span class="string">&#x27;movie_review&#x27;</span>: <span class="string">&#x27;ã€Šæµæµªåœ°çƒã€‹æ˜¯ä¸€éƒ¨ä»¤äººæƒŠå¹çš„ä¸­å›½ç§‘å¹»ç”µå½±ã€‚å®ƒä»¥å£®è§‚çš„è§†è§‰æ•ˆæœå’Œæ‰£äººå¿ƒå¼¦çš„å‰§æƒ…å¸å¼•ç€è§‚ä¼—ã€‚æ•…äº‹èƒŒæ™¯è®¾å®šåœ¨å¤ªé˜³å³å°†ç­äº¡çš„æœªæ¥ï¼Œäººç±»ä¸ºäº†ç”Ÿå­˜ä¸å¾—ä¸å°†åœ°çƒå˜æˆå¤ªç©ºèˆ¹ï¼Œå±•å¼€äº†ä¸€åœºæƒŠé™©çš„è¿å¾™ä¹‹æ—…ã€‚ç”µå½±ä¸­çš„å¤ªç©ºæˆ˜æ–—åœºæ™¯ä»¤äººéœ‡æ’¼ï¼ŒåŒæ—¶ä¹Ÿå±•ç°äº†äººç±»çš„å‹‡æ°”å’Œå›¢ç»“ç²¾ç¥ã€‚è¿™éƒ¨ç”µå½±åœ¨ç¥¨æˆ¿ä¸Šå–å¾—äº†å·¨å¤§æˆåŠŸï¼ŒåŒæ—¶ä¹Ÿè·å¾—äº†å¹¿æ³›çš„èµèª‰ã€‚å¦‚æœä½ å–œæ¬¢ç§‘å¹»å’ŒåŠ¨ä½œç‰‡ï¼Œé‚£ä¹ˆã€Šæµæµªåœ°çƒã€‹ç»å¯¹æ˜¯ä½ ä¸å®¹é”™è¿‡çš„é€‰æ‹©ã€‚&#x27;</span>, <span class="string">&#x27;social_post_text&#x27;</span>: <span class="string">&#x27;å¤§å®¶å¥½ï¼ä»Šå¤©æˆ‘è¦ç»™å¤§å®¶æ¨èä¸€éƒ¨éå¸¸ç²¾å½©çš„ç”µå½±ï¼Œã€Šæµæµªåœ°çƒã€‹ï¼è¿™æ˜¯ä¸€éƒ¨ä¸­å›½ç§‘å¹»ç”µå½±ï¼Œå¸¦é¢†æˆ‘ä»¬è¿›å…¥ä¸€ä¸ªæ¿€çƒˆçš„å¤ªç©ºæˆ˜æ–—çš„ä¸–ç•Œã€‚\n\næ•…äº‹å‘ç”Ÿåœ¨æœªæ¥ï¼Œå¤ªé˜³å³å°†ç­äº¡ï¼Œäººç±»ä¸ºäº†ç”Ÿå­˜å¿…é¡»å¯»æ‰¾æ–°çš„å®¶å›­ã€‚ä»–ä»¬å‘èµ·äº†ä¸€é¡¹å¤§èƒ†çš„è®¡åˆ’ï¼Œå°†åœ°çƒå˜æˆäº†ä¸€ä¸ªå·¨å¤§çš„å¤ªç©ºèˆ¹ï¼Œå‘å¤–å¤ªç©ºè¿å¾™ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªå±é™©çš„æ—…ç¨‹ä¸­ï¼Œä»–ä»¬é¢ä¸´ç€å„ç§æŒ‘æˆ˜å’Œå¤ªç©ºæˆ˜æ–—ã€‚\n\nè¿™éƒ¨ç”µå½±å……æ»¡äº†ç´§å¼ åˆºæ¿€çš„åœºæ™¯å’ŒæƒŠäººçš„è§†è§‰æ•ˆæœï¼ŒåŒæ—¶ä¹Ÿå±•ç°äº†äººç±»çš„å‹‡æ°”å’Œå›¢ç»“ç²¾ç¥ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€éƒ¨å……æ»¡åŠ¨ä½œå’Œå¤ªç©ºæˆ˜æ–—çš„ç”µå½±ï¼Œè¿˜æ¢è®¨äº†äººç±»å¯¹äºæœªæ¥å’Œç”Ÿå­˜çš„æ€è€ƒã€‚\n\nã€Šæµæµªåœ°çƒã€‹æ˜¯ä¸€éƒ¨éå¸¸æˆåŠŸçš„ä¸­å›½ç§‘å¹»ç”µå½±ï¼Œå®ƒè·å¾—äº†å¹¿æ³›çš„èµèª‰å’Œç¥¨æˆ¿æˆåŠŸã€‚å¦‚æœä½ å–œæ¬¢æ¿€çƒˆçš„å¤ªç©ºæˆ˜æ–—å’Œç§‘å¹»é¢˜æï¼Œè¿™éƒ¨ç”µå½±å°†ä¼šæ˜¯ä½ çš„ä¸é”™é€‰æ‹©ã€‚\n\nå¿«æ¥çœ‹çœ‹è¿™éƒ¨ä»¤äººæƒŠå¹çš„ä¸­å›½ç§‘å¹»ç”µå½±ï¼Œã€Šæµæµªåœ°çƒã€‹ï¼Œä¸€å®šä¼šè®©ä½ å¤§å‘¼è¿‡ç˜¾ï¼#æµæµªåœ°çƒ #ç§‘å¹»ç”µå½±&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ä¸åŒçš„ variables å†è¯•ä¸€æ¬¡</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = overall_chain(&#123;<span class="string">&quot;plot&quot;</span>: <span class="string">&quot;å‰‘ä¸é­”æ³•çš„ä¸–ç•Œ&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;å¥‡å¹»ã€å†’é™©&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering new SequentialChain chain...</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br><span class="line">&#123;<span class="string">&#x27;plot&#x27;</span>: <span class="string">&#x27;å‰‘ä¸é­”æ³•çš„ä¸–ç•Œ&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;å¥‡å¹»ã€å†’é™©&#x27;</span>, <span class="string">&#x27;movie_info&#x27;</span>: <span class="string">&#x27;ã€Šé­”æˆ’ä¸‰éƒ¨æ›²ï¼šæŒ‡ç¯ç‹ã€‹ã€‚è¿™æ˜¯ä¸€éƒ¨å¥‡å¹»å†’é™©ç”µå½±ç³»åˆ—ï¼Œå‰§æƒ…å‘ç”Ÿåœ¨ä¸€ä¸ªå……æ»¡å‰‘ä¸é­”æ³•çš„ä¸–ç•Œä¸­ã€‚æ•…äº‹è®²è¿°äº†ä¸€ä¸ªæ‹¯æ•‘ä¸­åœŸä¸–ç•Œçš„å†’é™©æ—…ç¨‹ï¼ŒåŒ…æ‹¬å‹‡æ•¢çš„è‹±é›„ã€é‚ªæ¶çš„é­”æ³•å¸ˆå’Œå„ç§ç¥ç§˜çš„ç”Ÿç‰©ã€‚è¿™éƒ¨ç”µå½±ç³»åˆ—èåˆäº†ç²¾å½©çš„å‰§æƒ…ã€æƒŠäººçš„ç‰¹æ•ˆå’Œç²¾ç¾çš„åœºæ™¯ï¼Œä¸€å®šä¼šè®©æ‚¨æ²‰æµ¸åœ¨è¿™ä¸ªå¥‡å¹»çš„ä¸–ç•Œä¸­ã€‚&#x27;</span>, <span class="string">&#x27;movie_review&#x27;</span>: <span class="string">&#x27;ã€Šé­”æˆ’ä¸‰éƒ¨æ›²ï¼šæŒ‡ç¯ç‹ã€‹æ˜¯ä¸€éƒ¨ä»¤äººæ²‰æµ¸çš„å¥‡å¹»å†’é™©ç”µå½±ç³»åˆ—ã€‚å‰§æƒ…å‘ç”Ÿåœ¨ä¸€ä¸ªå……æ»¡å‰‘ä¸é­”æ³•çš„ä¸–ç•Œä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬äº†å‹‡æ•¢çš„è‹±é›„ã€é‚ªæ¶çš„é­”æ³•å¸ˆå’Œå„ç§ç¥ç§˜çš„ç”Ÿç‰©ã€‚è¿™éƒ¨ç”µå½±ç³»åˆ—ä¸ä»…æ‹¥æœ‰ç²¾å½©çš„å‰§æƒ…ï¼Œè¿˜æœ‰æƒŠäººçš„ç‰¹æ•ˆå’Œç²¾ç¾çš„åœºæ™¯ã€‚è§‚ä¼—ä»¬å¯ä»¥å®Œå…¨æ²‰æµ¸åœ¨è¿™ä¸ªå¥‡å¹»çš„ä¸–ç•Œä¸­ï¼Œæ„Ÿå—åˆ°å…¶ä¸­çš„é­”åŠ›ã€‚æ— è®ºæ˜¯å¯¹äºé­”æˆ’ç³»åˆ—çš„ç²‰ä¸è¿˜æ˜¯å¯¹äºå¥‡å¹»å†’é™©ç”µå½±çš„çˆ±å¥½è€…æ¥è¯´ï¼Œè¿™éƒ¨ç”µå½±éƒ½æ˜¯ä¸€æ¬¡ä¸å®¹é”™è¿‡çš„è§†è§‰ç››å®´ã€‚&#x27;</span>, <span class="string">&#x27;social_post_text&#x27;</span>: <span class="string">&#x27;å¤§å®¶å¥½ï¼ä»Šå¤©ç»™å¤§å®¶æ¨èä¸€éƒ¨ä»¤äººæ²‰æµ¸çš„å¥‡å¹»å†’é™©ç”µå½±ç³»åˆ—â€”â€”ã€Šé­”æˆ’ä¸‰éƒ¨æ›²ï¼šæŒ‡ç¯ç‹ã€‹ï¼è¿™éƒ¨ç”µå½±å‘ç”Ÿåœ¨ä¸€ä¸ªå……æ»¡å‰‘ä¸é­”æ³•çš„ä¸–ç•Œä¸­ï¼Œæ•…äº‹ä¸­æœ‰å‹‡æ•¢çš„è‹±é›„ã€é‚ªæ¶çš„é­”æ³•å¸ˆå’Œå„ç§ç¥ç§˜çš„ç”Ÿç‰©ã€‚è¿™éƒ¨ç”µå½±ç³»åˆ—ä¸ä»…æœ‰ç²¾å½©çš„å‰§æƒ…ï¼Œæ›´æœ‰æƒŠäººçš„ç‰¹æ•ˆå’Œç²¾ç¾çš„åœºæ™¯ã€‚ä½ ä¸€å®šä¼šå®Œå…¨æ²‰æµ¸åœ¨è¿™ä¸ªå¥‡å¹»çš„ä¸–ç•Œä¸­ï¼Œæ„Ÿå—åˆ°å…¶ä¸­çš„é­”åŠ›ã€‚æ— è®ºä½ æ˜¯é­”æˆ’ç³»åˆ—çš„ç²‰ä¸è¿˜æ˜¯å¥‡å¹»å†’é™©ç”µå½±çš„çˆ±å¥½è€…ï¼Œè¿™éƒ¨ç”µå½±éƒ½æ˜¯ä¸€æ¬¡ä¸å®¹é”™è¿‡çš„è§†è§‰ç››å®´ã€‚å¿«æ¥å’Œæˆ‘ä¸€èµ·æ¢ç´¢è¿™ä¸ªå……æ»¡å‰‘ä¸é­”æ³•çš„ä¸–ç•Œå§ï¼#é­”æˆ’æŒ‡ç¯ç‹# #å¥‡å¹»å†’é™©ç”µå½±#&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ç¤ºä¾‹é€šè¿‡äº†ä¸‰ä¸ª LLMChain å’Œä¸€ä¸ª SequentialChainçš„ç»“åˆï¼Œç”±æ¨èç”µå½±åˆ°æœ€ç»ˆå†™å‡ºç”µå½±æ–‡æ¡ˆçš„è¿‡ç¨‹</p><h1 id="è¿›é˜¶">è¿›é˜¶</h1><p>è¿™é‡Œä½¿ç”¨æå®¢æ—¶é—´çš„ä¾‹å­ï¼Œåˆ¶ä½œä¸€ä¸ªç®€å•çš„é²œèŠ±è¿è¥æ™ºèƒ½å®¢æœ</p><p>å‡è®¾è¿™ä¸ªé²œèŠ±è¿è¥æ™ºèƒ½å®¢æœé€šå¸¸ä¼šæ¥åˆ°ä¸¤å¤§ç±»é—®é¢˜ï¼š</p><ol type="1"><li><strong>é²œèŠ±å…»æŠ¤</strong>ï¼ˆä¿æŒèŠ±çš„å¥åº·ã€å¦‚ä½•æµ‡æ°´ã€æ–½è‚¥ç­‰ï¼‰</li><li><strong>é²œèŠ±è£…é¥°</strong>ï¼ˆå¦‚ä½•æ­é…èŠ±ã€å¦‚ä½•è£…é¥°åœºåœ°ç­‰ï¼‰</li></ol><p>è¿™å°±å¼•å…¥äº†æ–°çš„éœ€æ±‚ï¼Œ <strong>å¦‚æœæ¥åˆ°çš„æ˜¯ç¬¬ä¸€ç±»é—®é¢˜ï¼Œéœ€è¦ç»™å‡º AæŒ‡ç¤ºï¼›å¦‚æœæ¥åˆ°ç¬¬äºŒç±»çš„é—®é¢˜ï¼Œéœ€è¦ç»™å‡º B æŒ‡ç¤º</strong>ã€‚</p><p>åœ¨å®ç°çš„è¿‡ç¨‹ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªåœºæ™¯æ¥æ„å»ºä¸¤ä¸ªä¸åŒçš„ç›®æ ‡é“¾ï¼›é‡åˆ°ä¸åŒç±»å‹çš„é—®é¢˜ï¼ŒLangChainä¼šé€šè¿‡ RouterChain æ¥è‡ªåŠ¨å¼•å¯¼å¤§è¯­è¨€æ¨¡å‹é€‰æ‹©ä¸åŒçš„æ¨¡æ¿</p><h2 id="æ¨¡æ¿å‡†å¤‡">æ¨¡æ¿å‡†å¤‡</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºä¸¤ä¸ªåœºæ™¯çš„æ¨¡æ¿</span></span><br><span class="line">flower_care_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„å›­ä¸ï¼Œæ“…é•¿è§£ç­”å…³äºå…»èŠ±è‚²èŠ±çš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string">            ä¸‹é¢æ˜¯éœ€è¦ä½ æ¥å›ç­”çš„é—®é¢˜:</span></span><br><span class="line"><span class="string">            &#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">flower_deco_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä½ç½‘çº¢æ’èŠ±å¤§å¸ˆï¼Œæ“…é•¿è§£ç­”å…³äºé²œèŠ±è£…é¥°çš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string">            ä¸‹é¢æ˜¯éœ€è¦ä½ æ¥å›ç­”çš„é—®é¢˜:</span></span><br><span class="line"><span class="string">            &#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºæç¤ºä¿¡æ¯</span></span><br><span class="line">prompt_infos = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span>: <span class="string">&quot;flower_care&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;é€‚åˆå›ç­”å…³äºé²œèŠ±æŠ¤ç†çš„é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;template&quot;</span>: flower_care_template,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span>: <span class="string">&quot;flower_decoration&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;é€‚åˆå›ç­”å…³äºé²œèŠ±è£…é¥°çš„é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;template&quot;</span>: flower_deco_template,</span><br><span class="line">    &#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºæç¤ºç›®æ ‡é“¾é“¾</span></span><br><span class="line"><span class="keyword">from</span> langchain.chains.llm <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line">chain_map = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> info <span class="keyword">in</span> prompt_infos:</span><br><span class="line">    prompt = PromptTemplate(template=info[<span class="string">&#x27;template&#x27;</span>], input_variables=[<span class="string">&quot;input&quot;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ç›®æ ‡æç¤º:\n&quot;</span>, prompt)</span><br><span class="line">    chain = LLMChain(llm=Azure.chat_model, prompt=prompt, verbose=<span class="literal">True</span>)</span><br><span class="line">    chain_map[info[<span class="string">&quot;key&quot;</span>]] = chain</span><br></pre></td></tr></table></figure><h2 id="llmrouterchain">LLMRouterChain</h2><p>RouterChainè·¯ç”±é“¾ï¼Œèƒ½åŠ¨æ€é€‰æ‹©ç”¨äºç»™å®šè¾“å…¥çš„ä¸‹ä¸€ä¸ªé“¾ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®ç”¨æˆ·çš„é—®é¢˜å†…å®¹ï¼Œé¦–å…ˆä½¿ç”¨è·¯ç”±å™¨é“¾ç¡®å®šé—®é¢˜æ›´é€‚åˆå“ªä¸ªå¤„ç†æ¨¡æ¿ï¼Œç„¶åå°†é—®é¢˜å‘é€åˆ°è¯¥å¤„ç†æ¨¡æ¿è¿›è¡Œå›ç­”ã€‚å¦‚æœé—®é¢˜ä¸é€‚åˆä»»ä½•å·²å®šä¹‰çš„å¤„ç†æ¨¡æ¿ï¼Œä¼šè¢«é€‰æ‹©ä½¿ç”¨é»˜è®¤é“¾</p><p>åˆ›å»ºä¸€ä¸ªè·¯ç”±é“¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºè·¯ç”±é“¾</span></span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.llm_router <span class="keyword">import</span> LLMRouterChain, RouterOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.multi_prompt_prompt <span class="keyword">import</span> MULTI_PROMPT_ROUTER_TEMPLATE <span class="keyword">as</span> RounterTemplate</span><br><span class="line"></span><br><span class="line">destinations = [<span class="string">f&quot;<span class="subst">&#123;p[<span class="string">&#x27;key&#x27;</span>]&#125;</span>: <span class="subst">&#123;p[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span> <span class="keyword">for</span> p <span class="keyword">in</span> prompt_infos]</span><br><span class="line">router_template = RounterTemplate.<span class="built_in">format</span>(destinations=<span class="string">&quot;\n&quot;</span>.join(destinations))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è·¯ç”±æ¨¡æ¿:\n&quot;</span>, router_template)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;------------------------------------&quot;</span>)</span><br><span class="line">router_prompt = PromptTemplate(</span><br><span class="line">    template=router_template,</span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>],</span><br><span class="line">    output_parser=RouterOutputParser(), )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è·¯ç”±æç¤º:\n&quot;</span>, router_prompt)</span><br><span class="line">router_chain = LLMRouterChain.from_llm(llm=Azure.chat_model,</span><br><span class="line">                                       prompt=router_prompt,</span><br><span class="line">                                       verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">è·¯ç”±æ¨¡æ¿:</span><br><span class="line"> Given a raw <span class="built_in">text</span> input <span class="keyword">to</span> a language model select <span class="keyword">the</span> model prompt best suited <span class="keyword">for</span> <span class="keyword">the</span> input. You will be <span class="keyword">given</span> <span class="keyword">the</span> names <span class="keyword">of</span> <span class="keyword">the</span> available prompts <span class="keyword">and</span> a description <span class="keyword">of</span> what <span class="keyword">the</span> prompt <span class="keyword">is</span> best suited <span class="keyword">for</span>. You may also revise <span class="keyword">the</span> original input <span class="keyword">if</span> you think <span class="keyword">that</span> revising <span class="keyword">it</span> will ultimately lead <span class="keyword">to</span> a better response <span class="keyword">from</span> <span class="keyword">the</span> language model.</span><br><span class="line"></span><br><span class="line">&lt;&lt; FORMATTING &gt;&gt;</span><br><span class="line">Return a markdown code snippet <span class="keyword">with</span> a JSON object formatted <span class="keyword">to</span> look like:</span><br><span class="line">```json</span><br><span class="line">&#123;&#123;</span><br><span class="line">    <span class="string">&quot;destination&quot;</span>: <span class="built_in">string</span> \ <span class="built_in">name</span> <span class="keyword">of</span> <span class="keyword">the</span> prompt <span class="keyword">to</span> use <span class="keyword">or</span> <span class="string">&quot;DEFAULT&quot;</span></span><br><span class="line">    <span class="string">&quot;next_inputs&quot;</span>: <span class="built_in">string</span> \ a potentially modified <span class="built_in">version</span> <span class="keyword">of</span> <span class="keyword">the</span> original input</span><br><span class="line">&#125;&#125;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">REMEMBER: <span class="string">&quot;destination&quot;</span> MUST be one <span class="keyword">of</span> <span class="keyword">the</span> candidate prompt names specified <span class="keyword">below</span> OR <span class="keyword">it</span> can be <span class="string">&quot;DEFAULT&quot;</span> <span class="keyword">if</span> <span class="keyword">the</span> input <span class="keyword">is</span> <span class="keyword">not</span> well suited <span class="keyword">for</span> any <span class="keyword">of</span> <span class="keyword">the</span> candidate prompts.</span><br><span class="line">REMEMBER: <span class="string">&quot;next_inputs&quot;</span> can just be <span class="keyword">the</span> original input <span class="keyword">if</span> you don&#x27;t think any modifications are needed.</span><br><span class="line"></span><br><span class="line">&lt;&lt; CANDIDATE PROMPTS &gt;&gt;</span><br><span class="line">flower_care: é€‚åˆå›ç­”å…³äºé²œèŠ±æŠ¤ç†çš„é—®é¢˜</span><br><span class="line">flower_decoration: é€‚åˆå›ç­”å…³äºé²œèŠ±è£…é¥°çš„é—®é¢˜</span><br><span class="line"></span><br><span class="line">&lt;&lt; INPUT &gt;&gt;</span><br><span class="line">&#123;input&#125;</span><br><span class="line"></span><br><span class="line">&lt;&lt; OUTPUT (must include ```json <span class="keyword">at</span> <span class="keyword">the</span> start <span class="keyword">of</span> <span class="keyword">the</span> response) &gt;&gt;</span><br><span class="line">&lt;&lt; OUTPUT (must <span class="keyword">end</span> <span class="keyword">with</span> ```) &gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">------------------------------------</span></span><br><span class="line">è·¯ç”±æç¤º:</span><br><span class="line"> input_variables=[&#x27;input&#x27;] output_parser=RouterOutputParser() template=&#x27;Given a raw <span class="built_in">text</span> input <span class="keyword">to</span> a language model select <span class="keyword">the</span> model prompt best suited <span class="keyword">for</span> <span class="keyword">the</span> input. You will be <span class="keyword">given</span> <span class="keyword">the</span> names <span class="keyword">of</span> <span class="keyword">the</span> available prompts <span class="keyword">and</span> a description <span class="keyword">of</span> what <span class="keyword">the</span> prompt <span class="keyword">is</span> best suited <span class="keyword">for</span>. You may also revise <span class="keyword">the</span> original input <span class="keyword">if</span> you think <span class="keyword">that</span> revising <span class="keyword">it</span> will ultimately lead <span class="keyword">to</span> a better response <span class="keyword">from</span> <span class="keyword">the</span> language model.\n\n&lt;&lt; FORMATTING &gt;&gt;\nReturn a markdown code snippet <span class="keyword">with</span> a JSON object formatted <span class="keyword">to</span> look like:\n```json\n&#123;&#123;\n    <span class="string">&quot;destination&quot;</span>: <span class="built_in">string</span> \\ <span class="built_in">name</span> <span class="keyword">of</span> <span class="keyword">the</span> prompt <span class="keyword">to</span> use <span class="keyword">or</span> <span class="string">&quot;DEFAULT&quot;</span>\n    <span class="string">&quot;next_inputs&quot;</span>: <span class="built_in">string</span> \\ a potentially modified <span class="built_in">version</span> <span class="keyword">of</span> <span class="keyword">the</span> original input\n&#125;&#125;\n```\n\nREMEMBER: <span class="string">&quot;destination&quot;</span> MUST be one <span class="keyword">of</span> <span class="keyword">the</span> candidate prompt names specified <span class="keyword">below</span> OR <span class="keyword">it</span> can be <span class="string">&quot;DEFAULT&quot;</span> <span class="keyword">if</span> <span class="keyword">the</span> input <span class="keyword">is</span> <span class="keyword">not</span> well suited <span class="keyword">for</span> any <span class="keyword">of</span> <span class="keyword">the</span> candidate prompts.\nREMEMBER: <span class="string">&quot;next_inputs&quot;</span> can just be <span class="keyword">the</span> original input <span class="keyword">if</span> you don\&#x27;t think any modifications are needed.\n\n&lt;&lt; CANDIDATE PROMPTS &gt;&gt;\nflower_care: é€‚åˆå›ç­”å…³äºé²œèŠ±æŠ¤ç†çš„é—®é¢˜\nflower_decoration: é€‚åˆå›ç­”å…³äºé²œèŠ±è£…é¥°çš„é—®é¢˜\n\n&lt;&lt; INPUT &gt;&gt;\n&#123;input&#125;\n\n&lt;&lt; OUTPUT (must include ```json <span class="keyword">at</span> <span class="keyword">the</span> start <span class="keyword">of</span> <span class="keyword">the</span> response) &gt;&gt;\n&lt;&lt; OUTPUT (must <span class="keyword">end</span> <span class="keyword">with</span> ```) &gt;&gt;\n&#x27;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥çœ‹åˆ°è·¯ç”±é“¾æ˜¯å¦‚ä½•è¿›è¡Œè·¯ç”±çš„ï¼Œå¦‚ä½•å¼•å¯¼ LLMè¿›è¡Œè·¯ç”±åˆ¤æ–­ï¼Œä»¥åŠåç»­çš„è·¯ç”±æç¤ºï¼š</p><ul><li><strong>è·¯ç”±æ¨¡æ¿</strong><ul><li><strong>å¼•è¨€</strong>ï¼šç®€å•çš„å¼•å¯¼è¯­å¥ï¼Œæé†’æ¨¡å‹å®ƒå°†è·å¾—å„ç§æ¨¡å‹æç¤ºçš„åç§°å’Œæè¿°ï¼Œä»¥åŠå¯ä»¥æ›´æ”¹åŸå§‹è¾“å…¥ä»¥è·å¾—æ›´å¥½çš„å“åº”</li><li><strong>æ ¼å¼è¯´æ˜</strong>ï¼ˆ&lt;&lt; FORMATTING&gt;&gt;ï¼‰ï¼šæŒ‡å¯¼æ¨¡å‹å¦‚ä½•æ ¼å¼åŒ–å…¶è¾“å‡ºï¼Œä½¿å…¶ä»¥ç‰¹å®šçš„æ–¹å¼è¿”å›ç»“æœï¼ˆMarkdownä»£ç ç‰‡æ®µï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç‰¹å®šæ ¼å¼çš„ JSON å¯¹è±¡ï¼‰ ä¸‹é¢çš„ä»£ç å—æ˜¾ç¤ºäº†æœŸæœ›çš„JSON ç»“æ„ï¼Œå…¶ä¸­ <code>destination</code> æ˜¯æ¨¡å‹é€‰æ‹©çš„æç¤ºåç§°ï¼ˆæˆ–<code>DEFAULT</code>ï¼‰ï¼Œè€Œ <code>next\_inputs</code>æ˜¯å¯èƒ½è¢«ä¿®è®¢çš„åŸå§‹è¾“å…¥</li><li><strong>é¢å¤–çš„è¯´æ˜å’Œè¦æ±‚</strong>ï¼š<ul><li>æé†’æ¨¡å‹ <code>destination</code>å­—æ®µçš„å€¼å¿…é¡»æ˜¯ä¸‹é¢åˆ—å‡ºçš„æç¤ºä¹‹ä¸€æˆ–æ˜¯ <code>DEFAULT</code></li><li>å†æ¬¡å¼ºè°ƒï¼Œé™¤éæ¨¡å‹è®¤ä¸ºæœ‰å¿…è¦ï¼Œå¦åˆ™åŸå§‹è¾“å…¥ä¸éœ€è¦ä¿®æ”¹</li></ul></li><li><strong>å€™é€‰æç¤º</strong>(&lt;&lt; CANDIDATE PROMPTS&gt;&gt;)ï¼šåˆ—å‡ºäº†ä¸¤ä¸ªç¤ºä¾‹æ¨¡å‹æç¤ºåŠå…¶æè¿°<ul><li><strong>flower_care</strong>ï¼šé€‚åˆå›ç­”å…³äºé²œèŠ±æŠ¤ç†çš„é—®é¢˜â€ï¼Œé€‚åˆå¤„ç†ä¸èŠ±å‰æŠ¤ç†ç›¸å…³çš„é—®é¢˜ã€‚</li><li><strong>flower_decoration</strong>ï¼šé€‚åˆå›ç­”å…³äºé²œèŠ±è£…é¥°çš„é—®é¢˜â€ï¼Œé€‚åˆå¤„ç†ä¸èŠ±å‰è£…é¥°ç›¸å…³çš„é—®é¢˜ã€‚</li></ul></li><li><strong>è¾“å…¥è¾“å‡º</strong>ï¼šä¸ºæ¨¡å‹æä¾›äº†ä¸€ä¸ªæ ¼å¼åŒ–çš„æ¡†æ¶ï¼Œå…¶ä¸­å®ƒå°†æ¥æ”¶ä¸€ä¸ªåä¸º<code>&#123;input&#125;</code> çš„è¾“å…¥ï¼Œå¹¶åœ¨æ­¤åçš„éƒ¨åˆ†è¾“å‡ºç»“æœ</li></ul></li><li><strong>è·¯ç”±æç¤º</strong>ï¼šæ ¹æ®è·¯ç”±æ¨¡æ¿ï¼Œç”Ÿæˆäº†å…·ä½“ä¼ é€’ç»™ LLMçš„è·¯ç”±æç¤ºä¿¡æ¯<ul><li>å…¶ä¸­ <code>input_variables</code> æŒ‡å®šæ¨¡æ¿æ¥æ”¶çš„è¾“å…¥å˜é‡åï¼Œè¿™é‡Œåªæœ‰<code>input</code></li><li><code>output_parser</code>æ˜¯ä¸€ä¸ªç”¨äºè§£ææ¨¡å‹è¾“å‡ºçš„å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ªé»˜è®¤çš„ç›®çš„åœ°å’Œä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€è¾“å…¥çš„é”®</li><li><code>template</code>æ˜¯å®é™…çš„è·¯ç”±æ¨¡æ¿ï¼Œç”¨äºç»™æ¨¡å‹æä¾›æŒ‡ç¤ºï¼›è¿™å°±æ˜¯åˆšæ‰è¯¦ç»†è§£é‡Šçš„æ¨¡æ¿å†…å®¹</li><li><code>template_format</code> æŒ‡å®šæ¨¡æ¿çš„æ ¼å¼ï¼Œè¿™é‡Œæ˜¯<code>f-string</code></li><li><code>validate_template</code> æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœä¸ºTrueï¼Œåˆ™ä¼šåœ¨ä½¿ç”¨æ¨¡æ¿å‰éªŒè¯å…¶æœ‰æ•ˆæ€§</li></ul></li></ul><p>æ¦‚æ‹¬è·¯ç”±é“¾çš„é€»è¾‘ï¼Œå…è®¸å°†ç”¨æˆ·çš„åŸå§‹è¾“å…¥é€å…¥è·¯ç”±å™¨ï¼Œç„¶åè·¯ç”±å™¨ä¼šå†³å®šå°†è¯¥è¾“å…¥å‘é€åˆ°å“ªä¸ªå…·ä½“çš„æ¨¡å‹æç¤ºï¼Œæˆ–è€…æ˜¯å¦éœ€è¦å¯¹è¾“å…¥è¿›è¡Œä¿®è®¢ä»¥è·å¾—æœ€ä½³çš„å“åº”</p><h2 id="é»˜è®¤é“¾">é»˜è®¤é“¾</h2><p>å‡†å¤‡ä¸€ä¸ªé»˜è®¤é“¾ï¼Œå¦‚æœè·¯ç”±é“¾æ²¡æœ‰æ‰¾åˆ°é€‚åˆçš„é“¾å°±ä»¥é»˜è®¤é“¾è¿›è¡Œå¤„ç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºé»˜è®¤é“¾</span></span><br><span class="line">default_chain = ConversationChain(llm=Azure.chat_model,</span><br><span class="line">                                  output_key=<span class="string">&quot;text&quot;</span>,</span><br><span class="line">                                  verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2 id="multipromptchain">MultiPromptChain</h2><p>æœ€åæˆ‘ä»¬ä½¿ç”¨ MultiPromptChain æŠŠå‰å‡ ä¸ªé“¾æ•´åˆåœ¨ä¸€èµ·å®ç°è·¯ç”±åŠŸèƒ½</p><p>MultiPromptChainæ˜¯ä¸€ä¸ªå¤šè·¯é€‰æ‹©é“¾ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªè·¯ç”±é“¾åœ¨å¤šä¸ªæç¤ºä¹‹é—´è¿›è¡Œé€‰æ‹©</p><p>å…³é”®å±æ€§ï¼š</p><ul><li><strong>router_chain</strong>ï¼ˆç±»å‹<code>RouterChain</code>ï¼‰ï¼šè¿™æ˜¯ç”¨äºå†³å®šç›®æ ‡é“¾å’Œå…¶è¾“å…¥çš„é“¾ï¼›å½“ç»™å®šæŸä¸ªè¾“å…¥æ—¶ï¼Œç”±router_chain å†³å®šå“ªä¸€ä¸ª destination_chainåº”è¯¥è¢«é€‰ä¸­ï¼Œä»¥åŠå…·ä½“è¾“å…¥æ˜¯ä»€ä¹ˆ</li><li><strong>destination_chains</strong>ï¼ˆç±»å‹<code>Mapping[str, LLMChain]</code>ï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ªæ˜ å°„ï¼Œå°†åç§°æ˜ å°„åˆ°å¯ä»¥å°†è¾“å…¥è·¯ç”±åˆ°çš„å€™é€‰é“¾ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æœ‰å¤šç§å¤„ç†æ–‡æœ¬è¾“å…¥çš„æ–¹æ³•ï¼ˆæˆ–é“¾ï¼‰ï¼Œæ¯ç§æ–¹æ³•é’ˆå¯¹ç‰¹å®šç±»å‹çš„é—®é¢˜ï¼›destination_chainså¯ä»¥æ˜¯è¿™æ ·ä¸€ä¸ªå­—å…¸ï¼š<code>&#123;'weather': weather_chain, 'news': news_chain&#125;</code>ï¼›weather_chainå¯èƒ½ä¸“é—¨å¤„ç†ä¸å¤©æ°”ç›¸å…³çš„é—®é¢˜ï¼Œè€Œ news_chain å¤„ç†ä¸æ–°é—»ç›¸å…³çš„é—®é¢˜</li><li><strong>default_chain</strong>ï¼ˆç±»å‹ <code>LLMChain</code>ï¼‰ï¼šå½“router_chain æ— æ³•å°†è¾“å…¥æ˜ å°„åˆ° destination_chainsä¸­çš„ä»»ä½•ä¸€ä¸ªé“¾æ—¶ï¼ŒLLMChainå°†ä½¿ç”¨æ­¤é»˜è®¤é“¾ï¼›è¿™æ˜¯ä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆï¼Œç¡®ä¿å³ä½¿è·¯ç”±å™¨ä¸èƒ½å†³å®šæ­£ç¡®çš„é“¾ä¹Ÿæ€»æœ‰ä¸€ä¸ªé“¾å¯ä»¥å¤„ç†è¾“å…¥</li></ul><p>å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>è¾“å…¥é¦–å…ˆä¼ é€’ router_chain</li><li>router_chain æ ¹æ®æŸäº›æ ‡å‡†æˆ–é€»è¾‘å†³å®šåº”è¯¥ä½¿ç”¨å“ªä¸€ä¸ªdestination_chain</li><li>è¾“å…¥éšåè¢«è·¯ç”±åˆ°é€‰å®šçš„destination_chainï¼Œè¯¥é“¾è¿›è¡Œå¤„ç†å¹¶è¿”å›ç»“æœ</li><li>å¦‚æœ router_chain ä¸èƒ½å†³å®šæ­£ç¡®çš„ destination_chainï¼Œåˆ™è¾“å…¥ä¼šè¢«ä¼ é€’ç»™default_chain</li></ol><p>å¦‚æ­¤ MultiPromptChainå°±æä¾›äº†ä¸€ä¸ªåœ¨å¤šä¸ªå¤„ç†é“¾ä¹‹é—´åŠ¨æ€è·¯ç”±è¾“å…¥çš„æœºåˆ¶ï¼Œä»¥å¾—åˆ°æœ€ç›¸å…³æˆ–æœ€ä¼˜çš„è¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">multi_prompt_chain = MultiPromptChain(</span><br><span class="line">    router_chain=router_chain,</span><br><span class="line">    destination_chains=chain_map,</span><br><span class="line">    default_chain=default_chain,</span><br><span class="line">    verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2 id="æ‰§è¡Œ">æ‰§è¡Œ</h2><p>å‡†å¤‡å¥½äº†æ•´ä¸ªé“¾æ¡ä¸Šçš„æ‰€æœ‰ç»„ä»¶ï¼Œæ¦‚æ‹¬ä¸€ä¸‹ï¼š</p><ul><li>æ¨¡æ¿å’Œç›®æ ‡ LLMChainï¼šä¸åŒè·¯å¾„çš„æç¤ºå’ŒåŸºç¡€é“¾</li><li>LLMRouterChainï¼šè¿›è¡Œè·¯ç”±é€‰æ‹©çš„é“¾</li><li>é»˜è®¤é“¾ ConversationChainï¼ˆLLMChainçš„å®ç°ï¼Œå¤„ç†ç®€å•å¯¹è¯ï¼‰ï¼šå¦‚æœæ²¡æœ‰å¯¹åº”è·¯ç”±ï¼Œåˆ™ä½¿ç”¨é»˜è®¤é“¾</li><li>MultiPromptChainï¼šç»„åˆèµ·ä¸Šè¿°ä¸‰ç§ç±»å‹çš„ç»„ä»¶ï¼Œæˆä¸ºè°ƒç”¨çš„å…¥å£</li></ul><p>é‚£ä¹ˆé’ˆå¯¹åˆ›å»ºå‡ºçš„ MultiPromptChain è¿›è¡Œè°ƒç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(multi_prompt_chain.run(<span class="string">&quot;å¦‚ä½•ä¸ºå‘æ—¥è‘µæµ‡æ°´ï¼Ÿ&quot;</span>))</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>verboss=True</code> å¯ä»¥è§‚å¯Ÿåˆ°è¿‡ç¨‹æ—¥å¿—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering new MultiPromptChain chain...</span><br><span class="line"></span><br><span class="line">&gt; Entering new LLMRouterChain chain...</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br><span class="line">flower_care: &#123;<span class="string">&#x27;input&#x27;</span>: <span class="string">&#x27;å¦‚ä½•ä¸ºå‘æ—¥è‘µæµ‡æ°´ï¼Ÿ&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">&gt; Entering new LLMChain chain...</span><br><span class="line">Prompt after formatting:</span><br><span class="line">ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„å›­ä¸ï¼Œæ“…é•¿è§£ç­”å…³äºå…»èŠ±è‚²èŠ±çš„é—®é¢˜ã€‚</span><br><span class="line">            ä¸‹é¢æ˜¯éœ€è¦ä½ æ¥å›ç­”çš„é—®é¢˜:</span><br><span class="line">            å¦‚ä½•ä¸ºå‘æ—¥è‘µæµ‡æ°´ï¼Ÿ</span><br><span class="line">      </span><br><span class="line">&gt; Finished chain.</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># ä¸‹é¢æ˜¯å›ç­”ï¼Œå¤ªé•¿äº†å°±ä¸æ”¾äº†</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è·¯ç”±é“¾è¾“å‡ºäº†<code>flower_care: &#123;'input': 'å¦‚ä½•ä¸ºå‘æ—¥è‘µæµ‡æ°´ï¼Ÿ'&#125;</code>ï¼Œå¤šè·¯é€‰æ‹©é“¾æ ¹æ®è·¯ç”±è¿”å›ä½¿ç”¨äº†å…»èŠ±è‚²èŠ±çš„æ¨¡æ¿</p><p>ä½¿ç”¨é»˜è®¤é“¾æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(multi_prompt_chain.run(<span class="string">&quot;å¯ä¹é¸¡ç¿…çš„åšæ³•&quot;</span>))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering new MultiPromptChain chain...</span><br><span class="line"></span><br><span class="line">&gt; Entering new LLMRouterChain chain...</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br><span class="line"><span class="literal">None</span>: &#123;<span class="string">&#x27;input&#x27;</span>: <span class="string">&#x27;å¯ä¹é¸¡ç¿…çš„åšæ³•&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">&gt; Entering new ConversationChain chain...</span><br><span class="line">Prompt after formatting:</span><br><span class="line">The following <span class="keyword">is</span> a friendly conversation between a human <span class="keyword">and</span> an AI. The AI <span class="keyword">is</span> talkative <span class="keyword">and</span> provides lots of specific details <span class="keyword">from</span> its context. If the AI does <span class="keyword">not</span> know the answer to a question, it truthfully says it does <span class="keyword">not</span> know.</span><br><span class="line"></span><br><span class="line">Current conversation:</span><br><span class="line"></span><br><span class="line">Human: å¯ä¹é¸¡ç¿…çš„åšæ³•</span><br><span class="line">AI:</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è·¯ç”±é“¾è¾“å‡ºäº†<code>None: &#123;'input': 'å¯ä¹é¸¡ç¿…çš„åšæ³•'&#125;</code>ï¼Œå¹¶ä¸”åœ¨åç»­å¤„ç†çš„é€‰æ‹©ä¸­ä½¿ç”¨äº†é»˜è®¤æä¾›çš„ConversationChain</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://time.geekbang.org/column/intro/100617601?utm_campaign=geektime_search&amp;utm_content=geektime_search&amp;utm_medium=geektime_search&amp;utm_source=geektime_search&amp;utm_term=geektime_search">LangChainå®æˆ˜è¯¾_LangChain_AI_å¤§æ¨¡å‹_è¯­è¨€æ¨¡å‹_ChatGPT_prompt_æ¥å£_æç¤ºå·¥ç¨‹_æ¨¡å‹_å¼€å‘-æå®¢æ—¶é—´(geekbang.org)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®€å•äº†è§£å‘é‡æ•°æ®åº“</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‘é‡åµŒå…¥">å‘é‡åµŒå…¥</h1><h2 id="å‘é‡">å‘é‡</h2><p>åœ¨ç ”ç©¶ä»€ä¹ˆæ˜¯å‘é‡åµŒå…¥ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£å‘é‡</p><p>å‘é‡æ˜¯ä¸€ç§å…·æœ‰å¤§å°å’Œæ–¹å‘çš„æ•°å­¦ç»“æ„ï¼›ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å°†å‘é‡è§†ä¸ºç©ºé—´ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œæ–¹å‘æ˜¯ä»<code>(0,0,0)</code> åˆ°å‘é‡ç©ºé—´ï¼ˆvector spaceï¼‰ä¸­è¯¥ç‚¹çš„ç®­å¤´</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%91%E9%87%8F.png" class="" title="å‘é‡"><p>ä½œä¸ºå¼€å‘è€…ï¼Œå°†å‘é‡è§†ä¸ºåŒ…å«æ•°å€¼çš„æ•°ç»„å¯èƒ½æ›´å®¹æ˜“ç†è§£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vector = [0,-2,...4]</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è§‚å¯Ÿä¸€ä¸ªç©ºé—´ä¸­çš„ä¸€ç»„å‘é‡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¯´æœ‰äº›å‘é‡å½¼æ­¤è·ç¦»æ›´è¿‘ï¼Œè€Œå¦ä¸€äº›å‘é‡ç›¸è·æ›´è¿œï¼›ä¸€äº›å‘é‡èšé›†åœ¨ä¸€èµ·ï¼Œè€Œå¦ä¸€äº›å‘é‡å¯èƒ½åœ¨ç©ºé—´ä¸­ç¨€ç–åˆ†å¸ƒ</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%91%E9%87%8F%E4%BD%8D%E7%BD%AE.png" class="" title="å‘é‡ä½ç½®"><p>å‘é‡æ˜¯æœºå™¨å­¦ä¹ ç®—æ³•çš„ç†æƒ³æ•°æ®ç»“æ„â€”â€”ç°ä»£ CPU å’Œ GPUç»è¿‡ä¼˜åŒ–ï¼Œå¯ä»¥è¿è¡Œå¤„ç†è¿™äº›å‘é‡æ‰€éœ€è¦çš„æ•°å­¦è®¡ç®—ï¼›ä½†æˆ‘ä»¬çš„æ•°æ®å´å¾ˆå°‘ç”¨å‘é‡è¡¨ç¤ºï¼Œè¿™å°±æ˜¯<strong>å‘é‡åµŒå…¥</strong>å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ï¼Œå‘é‡åµŒå…¥è¿™ç§æŠ€æœ¯å…è®¸æˆ‘ä»¬å°†å‡ ä¹ä»»ä½•ç±»å‹çš„<strong>æ•°æ®å°†å…¶è¡¨ç¤ºä¸ºå‘é‡</strong></p><p>åœ¨å°†æ•°æ®è¡¨ç¤ºä¸ºå‘é‡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿èƒ½å¤Ÿåœ¨ä¸ä¸¢å¤±æ•°æ®çš„åŸå§‹å«ä¹‰çš„æƒ…å†µä¸‹è¿›è¡Œè½¬æ¢ï¼›ä¾‹å¦‚å¦‚æœæˆ‘ä»¬æƒ³æ¯”è¾ƒä¸¤ä¸ªå¥å­â€”â€”æˆ‘ä»¬ä¸æƒ³åªæ¯”è¾ƒå®ƒä»¬æ‰€åŒ…å«çš„å•è¯ï¼Œè€Œæ˜¯æƒ³æ¯”è¾ƒå®ƒä»¬çš„è¯­ä¹‰æ˜¯å¦ç›¸åŒï¼›ä¸ºäº†ä¿æŒæ•°æ®çš„æ„ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å¦‚ä½•åœ¨å‘é‡ä¹‹é—´çš„å…³ç³»æœ‰æ„ä¹‰çš„æƒ…å†µä¸‹æ¥å¯¹æ•°æ®ç”Ÿæˆå‘é‡</p><h2 id="å‘é‡åµŒå…¥-1">å‘é‡åµŒå…¥</h2><p>è¦åšåˆ°æ•°æ®è½¬æ¢ä¸ºå¸¦æœ‰æ„ä¹‰çš„å‘é‡æ•°æ®ï¼Œå°±éœ€è¦å¼•å…¥åµŒå…¥æ¨¡å‹ï¼ˆembeddingmodelï¼‰çš„æ¦‚å¿µ</p><p>è®¸å¤šç°ä»£åµŒå…¥æ¨¡å‹æ˜¯é€šè¿‡å°†å¤§é‡æ ‡è®°æ•°æ®ä¼ é€’ç»™ç¥ç»ç½‘ç»œæ¥å®ç°çš„ï¼Œç¥ç»ç½‘ç»œä¹Ÿæ˜¯ä¸€ç§ç”¨äºè§£å†³å„ç§å¤æ‚é—®é¢˜çš„å·¥å…·ï¼Œç®€å•æ¥è¯´ç¥ç»ç½‘ç»œæ˜¯ç”±å‡½æ•°è¿æ¥çš„èŠ‚ç‚¹å±‚ç»„æˆçš„ï¼Œé€šè¿‡è®­ç»ƒè¿™äº›ç¥ç»ç½‘ç»œæ¥æ‰§è¡Œå„ç§ä»»åŠ¡ï¼›æœ€ç»ˆå®ƒå¯ä»¥é¢„æµ‹ç»™å®šè¾“å…¥çš„è¾“å‡ºæ ‡ç­¾åº”è¯¥æ˜¯ä»€ä¹ˆâ€”â€”å³ä½¿å®ƒä»¥å‰æ²¡æœ‰çœ‹åˆ°è¿‡ç‰¹å®šçš„è¾“å…¥</p><p>åµŒå…¥æ¨¡å‹åŸºæœ¬ä¸Šæ˜¯å»é™¤æœ€åä¸€å±‚çš„ç¥ç»ç½‘ç»œï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¸æ˜¯è¾“å…¥çš„ç‰¹å®šæ ‡è®°å€¼ï¼Œè€Œæ˜¯å‘é‡åµŒå…¥</p><p>åµŒå…¥æ¨¡å‹çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯æµè¡Œçš„word2vecï¼Œå®ƒç»å¸¸ç”¨äºå„ç§åŸºäºæ–‡æœ¬çš„ä»»åŠ¡ï¼›æ¥çœ‹çœ‹ TensorFlowçš„æŠ•å½±å·¥å…·ç”Ÿæˆçš„å¯è§†åŒ–è§†å›¾</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%91%E9%87%8F%E5%8F%AF%E8%A7%86%E5%8C%96.png" class="" title="å‘é‡å¯è§†åŒ–"><p>è™½ç„¶è¿™ç§å¯è§†åŒ–åªè¡¨ç¤ºåµŒå…¥çš„ä¸‰ç»´ç©ºé—´ï¼Œä½†ä¾ç„¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£åµŒå…¥æ¨¡å‹æ˜¯å¦‚ä½•å·¥ä½œçš„</p><p>å¯è§†åŒ–ä¸­çªå‡ºæ˜¾ç¤ºäº†å¤šä¸ªæ•°æ®ç‚¹ï¼Œæ¯ä¸ªæ•°æ®ç‚¹ä»£è¡¨ä¸€ä¸ªå•è¯çš„å‘é‡åµŒå…¥ï¼Œçœ‹èµ·æ¥å½¼æ­¤æ¥è¿‘çš„å•è¯åœ¨è¯­ä¹‰ä¸Šä¹Ÿæ›´ç›¸ä¼¼ï¼Œè€Œç›¸è·æ›´è¿œçš„å•è¯åˆ™æœ‰ä¸åŒçš„è¯­ä¹‰</p><p>ä¸€æ—¦ç»è¿‡è®­ç»ƒï¼ŒåµŒå…¥æ¨¡å‹å°±å¯ä»¥å°†æˆ‘ä»¬çš„åŸå§‹æ•°æ®è½¬æ¢ä¸ºå‘é‡åµŒå…¥ï¼Œå³æ„å‘³ç€å®ƒçŸ¥é“æ–°æ•°æ®ç‚¹åº”è¯¥æ”¾åœ¨å‘é‡ç©ºé—´ä¸­çš„ä»€ä¹ˆä½ç½®</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%91%E9%87%8F%E5%B5%8C%E5%85%A5.png" class="" title="å‘é‡åµŒå…¥"><blockquote><p>Its relationship with other vectors in the vector space depends onhow the embedding model â€œunderstandsâ€ the domain it was trained on.</p></blockquote><p><strong>æŸä¸ªå‘é‡ä¸å‘é‡ç©ºé—´ä¸­å…¶ä»–å‘é‡çš„å…³ç³»å–å†³äºåµŒå…¥æ¨¡å‹å¦‚ä½•â€œç†è§£â€å®ƒæ‰€è®­ç»ƒçš„åŸŸï¼ˆdomainï¼‰</strong></p><h2 id="ç”¨æ¥åšä»€ä¹ˆ">ç”¨æ¥åšä»€ä¹ˆ</h2><p>å‘é‡åµŒå…¥æ˜¯ä¸€ç§éå¸¸é€šç”¨çš„å·¥å…·ï¼Œå¯ä»¥åº”ç”¨äºè®¸å¤šé¢†åŸŸ</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œåº”ç”¨ç¨‹åºå°†ä½¿ç”¨å‘é‡åµŒå…¥ä½œä¸ºå…¶æŸ¥è¯¢ï¼Œå¹¶ç”Ÿæˆä¸ä¹‹ç›¸ä¼¼çš„å…¶ä»–å‘é‡åµŒå…¥åŠå…¶ç›¸åº”å€¼ï¼Œæ¯ä¸ªé¢†åŸŸçš„åº”ç”¨ç¨‹åºä¹‹é—´çš„å·®å¼‚å°±æ˜¯è¿™ç§ç›¸ä¼¼æ€§çš„æ„ä¹‰ï¼Œä¾‹å¦‚ï¼š</p><ul><li><strong>è¯­ä¹‰åŒ–æœç´¢</strong>ï¼šä¼ ç»Ÿæœç´¢å¼•æ“é€šè¿‡å…³é”®å­—çš„é‡å æ¥è¿›è¡Œæœç´¢ï¼Œé€šè¿‡åˆ©ç”¨å‘é‡åµŒå…¥ï¼Œè¯­ä¹‰æœç´¢å¯ä»¥è¶…è¶Šå…³é”®å­—è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼Œå¹¶å¯åŸºäºæŸ¥è¯¢çš„è¯­ä¹‰è¿›è¡Œä¼ é€’</li><li><strong>é—®ç­”åº”ç”¨</strong>ï¼šé€šè¿‡ç”¨æˆå¯¹çš„é—®é¢˜å’Œç›¸åº”çš„ç­”æ¡ˆè®­ç»ƒåµŒå…¥æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºæ¥å›ç­”ä»¥å‰ä»æœªè§è¿‡çš„é—®é¢˜</li><li><strong>å›¾ç‰‡æœç´¢</strong>ï¼šå‘é‡åµŒå…¥éå¸¸é€‚åˆè¿›è¡Œå›¾åƒæ£€ç´¢ä»»åŠ¡ï¼Œä¸åŒçš„æ¨¡å‹å¤„ç†ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œå¦‚å›¾åƒç›¸ä¼¼æ€§ã€å¯¹è±¡æ£€æµ‹ç­‰</li><li><strong>éŸ³é¢‘æœç´¢</strong>ï¼šé€šè¿‡å°†éŸ³é¢‘è½¬æ¢ä¸ºä¸€ç»„éŸ³é¢‘é¢‘è°±å›¾ï¼Œå¯ä»¥äº§ç”Ÿå¯ç”¨äºéŸ³é¢‘ç›¸ä¼¼æ€§æœç´¢çš„å‘é‡åµŒå…¥</li><li><strong>æ¨èç³»ç»Ÿ</strong>ï¼šå¯ä»¥ä»ä¸äº§å“ã€æ–‡ç« ç­‰ä¸åŒå®ä½“ç›¸å…³çš„ç»“æ„åŒ–æ•°æ®ä¸­åˆ›å»ºåµŒå…¥ï¼›å½“ä¸šåŠ¡åŒæ—¶å­˜åœ¨å›¾åƒæˆ–æ–‡æœ¬æè¿°æ—¶ï¼Œå¯ä»¥å°†å…¶ä¸éç»“æ„åŒ–åµŒå…¥æ–¹æ³•ç›¸ç»“åˆ</li><li><strong>å¼‚å¸¸æ£€æµ‹</strong>ï¼šå¯ä»¥ä½¿ç”¨è¯†åˆ«å¼‚å¸¸å‘ç”Ÿçš„æ ‡è®°ä¼ æ„Ÿå™¨ä¿¡æ¯çš„å¤§æ•°æ®é›†æ¥åˆ›å»ºç”¨äºå¼‚å¸¸æ£€æµ‹çš„åµŒå…¥</li></ul><h1 id="ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“">ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“</h1><blockquote><p>å‘é‡æ•°æ®åº“ï¼ˆvector databaseï¼‰æ˜¯ä¸€ç§ç´¢å¼•å’Œå­˜å‚¨å‘é‡åµŒå…¥ï¼ˆvectorembeddingsï¼‰çš„æ•°æ®åº“ï¼Œç”¨äºå¿«é€Ÿæ£€ç´¢å’Œç›¸ä¼¼æ€§æœç´¢ï¼ˆsimilaritysearchï¼‰ï¼Œå¯ä»¥è¿›è¡Œ CRUD æ“ä½œã€å…ƒæ•°æ®è¿‡æ»¤å’Œå¼¹æ€§ä¼¸ç¼©ç­‰åŠŸèƒ½</p></blockquote><p>æˆ‘ä»¬æ­£å¤„äºäººå·¥æ™ºèƒ½é©å‘½ä¹‹ä¸­ï¼Œå®ƒé¢ è¦†äº†å®ƒæ‰€æ¶‰åŠçš„ä»»ä½•è¡Œä¸šï¼Œæœ‰æœ›å®ç°ä¼Ÿå¤§çš„åˆ›æ–°ï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜</p><p>å¯¹äºæ¶‰åŠå¤§å‹è¯­è¨€æ¨¡å‹ã€ç”Ÿæˆäººå·¥æ™ºèƒ½å’Œè¯­ä¹‰æœç´¢çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œé«˜æ•ˆçš„æ•°æ®å¤„ç†å˜å¾—æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´åŠ é‡è¦ï¼Œæ‰€æœ‰è¿™äº›æ–°çš„åº”ç”¨ç¨‹åºéƒ½ä¾èµ–äºå‘é‡åµŒå…¥ï¼Œè¿™æ˜¯ä¸€ç§å‘é‡æ•°æ®è¡¨ç¤ºï¼Œå…¶ä¸­æºå¸¦è¯­ä¹‰ä¿¡æ¯ï¼Œè¿™å¯¹äººå·¥æ™ºèƒ½è·å¾—ç†è§£å’Œç»´æŠ¤æ‰§è¡Œå¤æ‚ä»»åŠ¡æ—¶å¯ä»¥åˆ©ç”¨çš„é•¿æœŸè®°å¿†è‡³å…³é‡è¦</p><p>æœ‰äº†å‘é‡æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥è®© AIå®ç°æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è¯­ä¹‰ä¿¡æ¯æ£€ç´¢ï¼ˆsemantic informationretrievalï¼‰ã€é•¿æœŸè®°å¿†ï¼ˆlong-termmemoryï¼‰ç­‰ï¼›ä¸‹å›¾ä½¿æˆ‘ä»¬æ›´å¥½åœ°äº†è§£äº†çŸ¢é‡æ•°æ®åº“åœ¨è¿™ç±»åº”ç”¨ç¨‹åºä¸­çš„ä½œç”¨ï¼š</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93.png" class="" title="å‘é‡æ•°æ®åº“"><p>ä¸Šå›¾è¿›è¡Œäº†å¦‚ä¸‹æ­¥éª¤ï¼š</p><ol type="1"><li>ä½¿ç”¨åµŒå…¥æ¨¡å‹ï¼ˆembedding modelï¼‰å¯¹éœ€è¦ç´¢å¼•çš„å†…å®¹åˆ›å»ºå‘é‡åµŒå…¥ï¼ˆvectorembeddingsï¼‰</li><li>å‘é‡åµŒå…¥è¢«æ’å…¥å‘é‡æ•°æ®åº“</li><li>å½“åº”ç”¨ç¨‹åºå‘å‡ºæŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„åµŒå…¥æ¨¡å‹ä¸ºæŸ¥è¯¢åˆ›å»ºå‘é‡åµŒå…¥ï¼Œå¹¶ä½¿ç”¨è¿™äº›åµŒå…¥æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­çš„ç±»ä¼¼å‘é‡åµŒå…¥</li></ol><h1 id="å‘é‡ç´¢å¼•å’Œå‘é‡æ•°æ®åº“çš„åŒºåˆ«">å‘é‡ç´¢å¼•å’Œå‘é‡æ•°æ®åº“çš„åŒºåˆ«</h1><p>åƒ FAISSï¼ˆFacebook AI Similarity Searchï¼‰è¿™æ ·çš„ç‹¬ç«‹å‘é‡ç´¢å¼•ï¼ˆvectorindexï¼‰å¯ä»¥æ˜¾è‘—ä¼˜åŒ–å‘é‡åµŒå…¥çš„æœç´¢å’Œæ£€ç´¢</p><p>ä½†å®ƒä»¬ç¼ºä¹æ•°æ®åº“ä¸­å¸¸è§åŠŸèƒ½ï¼Œå‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨ä¸ºç®¡ç†å‘é‡åµŒå…¥è€Œäº§ç”Ÿçš„ï¼Œä¸ä½¿ç”¨ç‹¬ç«‹å‘é‡ç´¢å¼•ç›¸æ¯”å…·æœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li><strong>æ•°æ®ç®¡ç†</strong>ï¼ˆDatamanagementï¼‰ï¼šå‘é‡æ•°æ®åº“ä¸ºæ•°æ®å­˜å‚¨æä¾›äº†æ–¹ä¾¿ä½¿ç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æ’å…¥ã€åˆ é™¤ã€æ›´æ–°æ“ä½œç­‰ï¼›ç®¡ç†å’Œç»´æŠ¤å‘é‡æ•°æ®æ¯”ä½¿ç”¨åƒFAISSè¿™æ ·çš„ç‹¬ç«‹çŸ¢é‡ç´¢å¼•æ›´å®¹æ˜“ï¼Œåè€…éœ€è¦é¢å¤–çš„å·¥ä½œæ‰èƒ½ä¸å­˜å‚¨è§£å†³æ–¹æ¡ˆé›†æˆ</li><li><strong>å…ƒæ•°æ®å­˜å‚¨å’Œè¿‡æ»¤</strong>ï¼ˆMetadata storage andfilteringï¼‰ï¼šå‘é‡æ•°æ®åº“å¯ä»¥å­˜å‚¨ä¸æ¯æ¡å‘é‡æ•°æ®ç›¸å…³è”çš„å…ƒæ•°æ®ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨é¢å¤–çš„å…ƒæ•°æ®è¿‡æ»¤å™¨å¯¹æ•°æ®åº“è¿›è¡Œæ›´ç»†ç²’åº¦çš„æŸ¥è¯¢</li><li><strong>æ‰©å±•æ€§</strong>ï¼ˆScalabilityï¼‰ï¼šå‘é‡æ•°æ®åº“çš„è®¾è®¡å¯ä»¥éšç€æ•°æ®é‡å’Œç”¨æˆ·éœ€æ±‚çš„å¢é•¿è€Œæ‰©å±•ï¼Œä¸ºåˆ†å¸ƒå¼å’Œå¹¶è¡Œå¤„ç†æä¾›æ›´å¥½çš„æ”¯æŒï¼›ç‹¬ç«‹çŸ¢é‡ç´¢å¼•å¯èƒ½éœ€è¦è‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆæ¥å®ç°ç±»ä¼¼çº§åˆ«çš„å¯æ‰©å±•æ€§ï¼ˆä¾‹å¦‚åœ¨k8s é›†ç¾¤æˆ–å…¶ä»–ç±»ä¼¼ç³»ç»Ÿä¸Šéƒ¨ç½²å’Œç®¡ç†ï¼‰</li><li><strong>å®æ—¶æ›´æ–°</strong>ï¼ˆReal-timeupdatesï¼‰ï¼šå‘é‡æ•°æ®åº“é€šå¸¸éƒ½å¯ä»¥æ”¯æŒå®æ—¶æ›´æ–°ï¼Œå…è®¸åŠ¨æ€æ›´æ–°æ•°æ®ï¼›è€Œç‹¬ç«‹çš„çŸ¢é‡ç´¢å¼•å¯èƒ½éœ€è¦å®Œæ•´çš„é‡æ–°ç´¢å¼•è¿‡ç¨‹æ¥åˆå¹¶æ–°æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦ä¸€å®šè€—æ—¶å’Œæˆæœ¬</li><li><strong>å¤‡ä»½</strong>ï¼ˆBackups andcollectionsï¼‰ï¼šå‘é‡æ•°æ®åº“å¯ä»¥æä¾›å¤‡ä»½æ‰€æœ‰æ•°æ®çš„èƒ½åŠ›</li><li><strong>ç”Ÿæ€æ•´åˆ</strong>ï¼ˆEcosystem integrationï¼‰</li><li><strong>æ•°æ®å®‰å…¨å’Œæƒé™æ§åˆ¶</strong>ï¼ˆData security and accesscontrolï¼‰</li></ul><p>æ€»ä¹‹ï¼Œå‘é‡æ•°æ®åº“é€šè¿‡è§£å†³ç‹¬ç«‹å‘é‡ç´¢å¼•çš„å±€é™æ€§ï¼ˆå¦‚ç¼ºä¹å¯æ‰©å±•æ€§ã€ç¹ççš„é›†æˆè¿‡ç¨‹ã€è¿ç»´ç¹çç­‰é—®é¢˜ï¼‰ï¼Œä¸ºå‘é‡åµŒå…¥æä¾›äº†æ›´ä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿äº†æ›´æœ‰æ•ˆå’Œæ›´ç²¾ç®€çš„æ•°æ®ç®¡ç†ä½“éªŒ</p><h1 id="å‘é‡æ•°æ®åº“å¦‚ä½•å·¥ä½œ">å‘é‡æ•°æ®åº“å¦‚ä½•å·¥ä½œ</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ä¼ ç»Ÿæ•°æ®åº“æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»–ä»¬åœ¨è¡Œå’Œåˆ—ä¸­å­˜å‚¨å­—ç¬¦ä¸²ã€æ•°å­—å’Œå…¶ä»–ç±»å‹çš„æ ‡é‡æ•°æ®ï¼›ä¸ä¹‹å¯¹åº”çš„ï¼Œå‘é‡æ•°æ®åº“å¯¹å‘é‡è¿›è¡Œæ“ä½œï¼Œå› æ­¤ä¼˜åŒ–å’ŒæŸ¥è¯¢çš„æ–¹å¼æˆªç„¶ä¸åŒ</p><p>åœ¨ä¼ ç»Ÿæ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å€¼é€šå¸¸ä¸æŸ¥è¯¢å®Œå…¨åŒ¹é…çš„è¡Œï¼›è€Œåœ¨å‘é‡æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬åº”ç”¨ç›¸ä¼¼æ€§åº¦é‡æ¥æ‰¾åˆ°ä¸æˆ‘ä»¬çš„æŸ¥è¯¢æœ€ç›¸ä¼¼çš„å‘é‡</p><p>å‘é‡æ•°æ®åº“ä½¿ç”¨ä¸åŒç®—æ³•çš„ç»„åˆï¼Œè¿™äº›ç®—æ³•éƒ½å‚ä¸è¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æœç´¢ï¼Œè¿™äº›ç®—æ³•é€šè¿‡æ•£åˆ—ã€é‡åŒ–æˆ–åŸºäºå›¾çš„æœç´¢æ¥ä¼˜åŒ–æœç´¢</p><p>è¿™äº›ç®—æ³•è¢«ç»„è£…åˆ°ä¸€ä¸ªç®¡é“ä¸­ï¼Œè¯¥ç®¡é“æä¾›å¯¹æŸ¥è¯¢å‘é‡çš„é‚»å±…çš„å¿«é€Ÿå‡†ç¡®æ£€ç´¢ï¼Œç”±äºçŸ¢é‡æ•°æ®åº“æä¾›äº†è¿‘ä¼¼ç»“æœï¼Œæˆ‘ä»¬è€ƒè™‘çš„ä¸»è¦æƒè¡¡æ˜¯å‡†ç¡®æ€§å’Œé€Ÿåº¦ï¼Œä¸€èˆ¬è€Œè¨€ç»“æœè¶Šå‡†ç¡®ï¼ŒæŸ¥è¯¢é€Ÿåº¦å°±è¶Šæ…¢ï¼Œæ‰€ä»¥ä¸€ä¸ªå¥½çš„ç³»ç»Ÿåº”è¯¥å…¼é¡¾ä¸¤è€…</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" class="" title="å‘é‡æ•°æ®åº“å·¥ä½œæµç¨‹"><p>ä¸Šå›¾ä¸ºå‘é‡æ•°æ®åº“çš„é€šç”¨ç®¡é“ï¼š</p><ol type="1"><li><strong>ç´¢å¼•</strong>ï¼ˆIndexingï¼‰ï¼šæ•°æ®åº“ä½¿ç”¨ PQã€LSHã€HNSWç­‰ç®—æ³•æ¥å¯¹æ•°æ®è¿›è¡Œç´¢å¼•ï¼›æ­¤æ­¥éª¤å°†å‘é‡æ˜ å°„åˆ°æ•°æ®ç»“æ„ï¼Œä»è€Œå®ç°æ›´å¿«çš„æœç´¢</li><li><strong>æŸ¥è¯¢</strong>ï¼ˆQueryingï¼‰ï¼šå‘é‡æ•°æ®åº“æ¯”è¾ƒæŸ¥è¯¢å‘é‡å’Œè¢«ç´¢å¼•çš„å‘é‡ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘çš„ä¸´è¿‘æ•°æ®ï¼ˆæ ¹æ®ç´¢å¼•çš„ç›¸ä¼¼åº¦ï¼‰</li><li><strong>åç½®æµç¨‹</strong>ï¼ˆPostProcessingï¼‰ï¼šæœ‰æ—¶å‘é‡æ•°æ®åº“ä»æ•°æ®é›†ä¸­æ£€ç´¢æœ€ç»ˆçš„ä¸´è¿‘æ•°æ®ï¼Œå¹¶å¯¹å…¶è¿›è¡Œåç½®å¤„ç†åè¿”å›æœ€ç»ˆç»“æœï¼›ä¾‹å¦‚åŒ…æ‹¬ä½¿ç”¨ä¸åŒçš„ç›¸ä¼¼æ€§åº¦é‡å¯¹ä¸´è¿‘æ•°æ®è¿›è¡Œé‡æ–°æ’åº</li></ol><h2 id="ç®—æ³•">ç®—æ³•</h2><p>æ‰€æœ‰ç®—æ³•çš„å…±åŒç›®æ ‡æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªå¯ä»¥å¿«é€Ÿéå†çš„æ•°æ®ç»“æ„æ¥å®ç°å¿«é€ŸæŸ¥è¯¢ï¼Œå®ƒä»¬é€šå¸¸ä¼šå°†åŸå§‹å‘é‡çš„è¡¨ç¤ºè½¬æ¢ä¸ºå‹ç¼©å½¢å¼æ¥ä¼˜åŒ–æŸ¥è¯¢è¿‡ç¨‹</p><p>ä¸‹é¢å°†æ¢è®¨å‡ ç§ç®—æ³•åŠå…¶å¤„ç†å‘é‡åµŒå…¥çš„ç‰¹æ®Šæ–¹å¼</p><h3 id="éšæœºæŠ•å½±random-projection">éšæœºæŠ•å½±ï¼ˆRandom Projectionï¼‰</h3><p>éšæœºæŠ•å½±çš„åŸºæœ¬æ€æƒ³æ˜¯ä½¿ç”¨éšæœºæŠ•å½±çŸ©é˜µå°†é«˜ç»´å‘é‡æŠ•å½±åˆ°ä½ç»´ç©ºé—´</p><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªéšæœºæ•°çŸ©é˜µï¼ŒçŸ©é˜µçš„å¤§å°å°†æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç›®æ ‡ä½ç»´å€¼ï¼›ç„¶åæˆ‘ä»¬è®¡ç®—è¾“å…¥å‘é‡å’ŒçŸ©é˜µçš„ç‚¹ç§¯ï¼Œä½¿å¾—æŠ•å½±çŸ©é˜µçš„ç»´æ•°æ¯”åŸå§‹å‘é‡å°‘ï¼Œä½†ä»ä¿æŒå…¶ç›¸ä¼¼æ€§</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9A%8F%E6%9C%BA%E6%8A%95%E5%BD%B1.png" class="" title="éšæœºæŠ•å½±"><p>æŸ¥è¯¢æ—¶ä½¿ç”¨ç›¸åŒçš„æŠ•å½±çŸ©é˜µå°†æŸ¥è¯¢å‘é‡æŠ•å½±åˆ°ä½ç»´ç©ºé—´ä¸Šï¼Œç„¶åå°†æŠ•å½±çš„æŸ¥è¯¢å‘é‡ä¸æ•°æ®åº“ä¸­çš„æŠ•å½±å‘é‡è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ‰¾åˆ°ä¸´è¿‘æ•°æ®ï¼›ç”±äºæ•°æ®çš„ç»´æ•°é™ä½ï¼Œæœç´¢è¿‡ç¨‹æ˜æ˜¾å¿«äºæœç´¢æ•´ä¸ªé«˜ç»´ç©ºé—´</p><p>éšæœºæŠ•å½±æ˜¯ä¸€ç§è¿‘ä¼¼æ–¹æ³•ï¼ŒæŠ•å½±è´¨é‡å–å†³äºæŠ•å½±çŸ©é˜µçš„æ€§è´¨ï¼›ä¸€èˆ¬æ¥è¯´æŠ•å½±çŸ©é˜µè¶Šéšæœºï¼ŒæŠ•å½±çš„è´¨é‡å°±è¶Šå¥½ï¼›ä½†æ˜¯ç”ŸæˆçœŸæ­£éšæœºçš„æŠ•å½±çŸ©é˜µç‰¹åˆ«æ˜¯å¯¹äºå¤§å‹æ•°æ®é›†è€Œè¨€ï¼Œéœ€è¦é«˜æ˜‚çš„æˆæœ¬</p><p><ahref="https://www.pinecone.io/learn/locality-sensitive-hashing-random-projection/">Learnmore about random projection</a></p><h3 id="ä¹˜ç§¯é‡åŒ–product-quantization">ä¹˜ç§¯é‡åŒ–ï¼ˆProductQuantizationï¼‰</h3><p>PQ æ˜¯ç”¨äºé«˜ç»´å‘é‡ï¼ˆä¾‹å¦‚å‘é‡åµŒå…¥ï¼‰çš„æœ‰æŸå‹ç¼©ï¼ˆlossycompressionï¼‰æŠ€æœ¯</p><p>é¦–å…ˆè·å–åŸå§‹å‘é‡ï¼Œå°†å…¶åˆ†è§£ä¸ºæ›´å°çš„å—ï¼ˆchunkï¼‰ï¼Œé€šè¿‡ä¸ºæ¯ä¸ªå—åˆ›å»ºä¸€ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„â€œç¼–ç â€ï¼ˆcodeï¼‰æ¥ç®€åŒ–æ¯ä¸ªå—çš„è¡¨ç¤ºï¼Œç„¶åå°†æ‰€æœ‰å—é‡æ–°ç»„åˆåœ¨ä¸€èµ·ï¼Œä»è€Œä¸ä¼šä¸¢å¤±å¯¹ç›¸ä¼¼æ€§æ“ä½œé‡è¦çš„ä¿¡æ¯</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B9%98%E7%A7%AF%E9%87%8F%E5%8C%96.png" class="" title="ä¹˜ç§¯é‡åŒ–"><p>PQ çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼šæ‹†åˆ†ã€è®­ç»ƒã€ç¼–ç å’ŒæŸ¥è¯¢ï¼š</p><ol type="1"><li><strong>æ‹†åˆ†</strong>ï¼ˆSplittingï¼‰ï¼šå‘é‡è¢«åˆ†å‰²æˆè‹¥å­å‘é‡ï¼›ä¾‹å¦‚å°†ä¸€ä¸ªd ç»´å‘é‡åˆ’åˆ†ä¸º m ä¸ªå­å‘é‡ï¼Œæ¯ä¸ªå­å‘é‡çš„ç»´åº¦ä¸º d/mï¼›è¿™äº›å­å‘é‡å°†æ„æˆ PQç®—æ³•çš„åŸºæœ¬å•å…ƒ</li><li><strong>è®­ç»ƒ</strong>ï¼ˆTrainingï¼‰ï¼šä¸ºæ¯ä¸ªå­å‘é‡æ„å»ºä¸€ä¸ªç æœ¬ï¼ˆcodebookï¼‰ï¼›ç®€å•åœ°è¯´ç®—æ³•ç”Ÿæˆä¸€ä¸ªéšå«çš„ç æœ¬ï¼Œè¿™äº›ç¼–ç å¯ä»¥åˆ†é…ç»™å‘é‡ï¼›åœ¨å®è·µä¸­ç æœ¬é€šè¿‡å¯¹å‘é‡çš„æ¯ä¸ªåˆ†æ®µæ‰§è¡Œk å‡å€¼èšç±»ï¼ˆk-meansclusteringï¼‰è€Œåˆ›å»ºçš„èšç±»çš„ä¸­å¿ƒç‚¹ç»„æˆï¼›æ¯ä¸ªå­å‘é‡å°†è¢«æ˜ å°„åˆ°æœ€æ¥è¿‘çš„ç æœ¬å‘é‡ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªç¦»æ•£çš„ç æœ¬ç´¢å¼•</li><li><strong>ç¼–ç </strong>ï¼ˆEncodingï¼‰ï¼šç®—æ³•ä¸ºæ¯ä¸ªå­å‘é‡åˆ†é…ä¸€ä¸ªç‰¹å®šçš„ç¼–ç ï¼Œã€‚åœ¨å®è·µä¸­è®­ç»ƒå®Œæˆååœ¨ç æœ¬ä¸­æ‰¾åˆ°ä¸æ¯ä¸ªå‘é‡æ®µæœ€æ¥è¿‘çš„å€¼ï¼›å¯ä»¥ä½¿ç”¨å¤šä¸ªPQ ç¼–ç ï¼Œè¿™æ„å‘³ç€å¯ä»¥ä»ç æœ¬ä¸­é€‰æ‹©å¤šä¸ªå€¼æ¥è¡¨ç¤ºæ¯ä¸ªå­å‘é‡</li><li><strong>æŸ¥è¯¢</strong>ï¼ˆQueryingï¼‰ï¼šå½“æˆ‘ä»¬è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œè¯¥ç®—æ³•å°†å‘é‡åˆ†è§£ä¸ºå­å‘é‡ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„ç æœ¬å¯¹å…¶è¿›è¡Œé‡åŒ–ï¼Œç„¶åä½¿ç”¨ç´¢å¼•ç¼–ç æ¥æŸ¥æ‰¾ä¸æŸ¥è¯¢å‘é‡æœ€è¿‘çš„å‘é‡</li></ol><p>ç æœ¬ä¸­çš„ä»£è¡¨å‘é‡çš„æ•°é‡æ˜¯è¡¨ç¤ºçš„å‡†ç¡®æ€§å’Œæœç´¢ç æœ¬çš„è®¡ç®—æˆæœ¬ä¹‹é—´çš„æƒè¡¡ï¼›ç æœ¬ä¸­çš„ä»£è¡¨æ€§å‘é‡è¶Šå¤šï¼Œå­ç©ºé—´ä¸­å‘é‡çš„è¡¨ç¤ºå°±è¶Šå‡†ç¡®ï¼Œä½†æœç´¢ç æœ¬çš„è®¡ç®—æˆæœ¬å°±è¶Šé«˜ï¼›ç›¸åç æœ¬ä¸­çš„ä»£è¡¨å‘é‡è¶Šå°‘ï¼Œè¡¨ç¤ºå°±è¶Šä¸å‡†ç¡®ï¼Œä½†è®¡ç®—æˆæœ¬å°±è¶Šä½</p><p><a href="https://www.pinecone.io/learn/product-quantization/">Learnmore about PQ</a></p><h3id="å±€éƒ¨æ•æ„Ÿå“ˆå¸Œlocality-sensitive-hashing">å±€éƒ¨æ•æ„Ÿå“ˆå¸Œï¼ˆLocality-sensitivehashingï¼‰</h3><p>LSHæ˜¯ä¸€ç§è¿‘ä¼¼æœç´¢ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œç´¢å¼•çš„æŠ€æœ¯ï¼Œå®ƒä¼˜åŒ–äº†é€Ÿåº¦åŒæ—¶ä»èƒ½æä¾›è¿‘ä¼¼çš„ã€éå…¨é¢ï¼ˆnon-exhaustiveï¼‰çš„ç»“æœ</p><p>LSH ä½¿ç”¨ä¸€ç»„å“ˆå¸Œå‡½æ•°å°†ç±»ä¼¼çš„å‘é‡æ˜ å°„åˆ°æ¡¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%B1%80%E9%83%A8%E6%95%8F%E6%84%9F%E5%93%88%E5%B8%8C.png" class="" title="å±€éƒ¨æ•æ„Ÿå“ˆå¸Œ"><p>æŸ¥æ‰¾è¿‘ä¼¼æ•°æ®çš„è¿‡ç¨‹ï¼Œä½¿ç”¨ç›¸åŒçš„å“ˆå¸Œå‡½æ•°å…ˆæ‰¾åˆ°å¯¹åº”çš„å‘é‡æ¡¶ï¼ŒæŸ¥è¯¢å‘é‡è¢«æ•£åˆ—åˆ°ä¸€ä¸ªç‰¹å®šçš„è¡¨ï¼Œç„¶åä¸åŒä¸€è¡¨ä¸­çš„å…¶ä»–å‘é‡è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ‰¾åˆ°æœ€æ¥è¿‘çš„æ•°æ®</p><p>è¿™ç§æ–¹æ³•æ¯”æœç´¢æ•´ä¸ªæ•°æ®é›†æ›´å¿«ï¼Œå› ä¸ºæ¯ä¸ªå“ˆå¸Œè¡¨ä¸­çš„å‘é‡æ¯”æ•´ä¸ªç©ºé—´ä¸­çš„å‘é‡è¦å°‘å¾—å¤š</p><p>éœ€è¦æ³¨æ„ LSHæ˜¯ä¸€ç§è¿‘ä¼¼æ–¹æ³•ï¼Œè¿‘ä¼¼çš„è´¨é‡å–å†³äºå“ˆå¸Œå‡½æ•°çš„è´¨é‡ï¼Œä¸€èˆ¬æ¥è¯´ä½¿ç”¨çš„å“ˆå¸Œå‡½æ•°è¶Šå¤šï¼Œè¿‘ä¼¼è´¨é‡å°±è¶Šå¥½ï¼›ä¸è¿‡ä½¿ç”¨å¤§é‡å“ˆå¸Œå‡½æ•°å¯èƒ½è®¡ç®—æˆæœ¬é«˜æ˜‚ï¼Œå¹¶ä¸”å¯¹äºå¤§å‹æ•°æ®é›†å¯èƒ½ä¸åˆé€‚</p><p><ahref="https://www.pinecone.io/learn/locality-sensitive-hashing/">Learnmore about LSH</a></p><h3 id="hierarchical-navigable-small-worldhnsw">Hierarchical NavigableSmall Worldï¼ˆHNSWï¼‰</h3><p>HNSWåˆ›å»ºä¸€ä¸ªåˆ†å±‚çš„æ ‘çŠ¶ç»“æ„ï¼Œå…¶ä¸­æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ç»„å‘é‡ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¾¹è¡¨ç¤ºå‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§</p><p>è¯¥ç®—æ³•é¦–å…ˆåˆ›å»ºä¸€ç»„èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å°‘é‡å‘é‡ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå¯ä»¥éšæœºå®Œæˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨k-means ç­‰ç®—æ³•å¯¹å‘é‡è¿›è¡Œèšç±»æ¥å®ç°ï¼Œå…¶ä¸­æ¯ä¸ªèšç±»éƒ½æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/HNSW.png" class="" title="HNSW"><p>ç„¶åï¼Œè¯¥ç®—æ³•æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„å‘é‡ï¼Œå¹¶åœ¨è¯¥èŠ‚ç‚¹ä¸å‘é‡ä¸å…¶æœ€ç›¸ä¼¼çš„èŠ‚ç‚¹ä¹‹é—´ç»˜åˆ¶è¾¹</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/HNSW2.png" class="" title="HNSW2"><p>å½“æˆ‘ä»¬æŸ¥è¯¢ HNSWç´¢å¼•æ—¶ï¼Œä»å›¾ä¸­æŒ‰å±‚æ£€ç´¢ï¼Œæ‰¾åˆ°ä¸æŸ¥è¯¢å‘é‡æœ€æ¥è¿‘çš„èŠ‚ç‚¹</p><p><a href="https://www.pinecone.io/learn/hnsw/">Learn more aboutHNSW</a></p><h3 id="æ€»ç»“">æ€»ç»“</h3><table><colgroup><col style="width: 10%" /><col style="width: 23%" /><col style="width: 20%" /><col style="width: 23%" /><col style="width: 22%" /></colgroup><thead><tr class="header"><th style="text-align: left;">ç®—æ³•</th><th style="text-align: left;">ç‰¹ç‚¹</th><th style="text-align: left;">ä¼˜ç‚¹</th><th style="text-align: left;">ç¼ºç‚¹</th><th style="text-align: left;">é€‚åˆåœºæ™¯</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">Random Projection</td><td style="text-align: left;">ä½¿ç”¨éšæœºæŠ•å½±å°†é«˜ç»´æ•°æ®æ˜ å°„åˆ°ä½ç»´ç©ºé—´</td><td style="text-align: left;">- è®¡ç®—å¤æ‚åº¦ä½<br>- éœ€è¦çš„å­˜å‚¨ç©ºé—´å°</td><td style="text-align: left;">-æ˜ å°„åçš„ä½ç»´ç©ºé—´å¯èƒ½æ— æ³•ä¿æŒæ•°æ®çš„å…¨éƒ¨ç»“æ„<br>- ä¸é€‚ç”¨äºæ‰€æœ‰æ•°æ®é›†</td><tdstyle="text-align: left;">å¤§è§„æ¨¡é«˜ç»´åº¦æ•°æ®é™ç»´å’Œç›¸ä¼¼æ€§æŸ¥è¯¢ï¼Œå¦‚æ–‡æœ¬å’Œå›¾åƒåˆ†æ</td></tr><tr class="even"><td style="text-align: left;">Product Quantization</td><tdstyle="text-align: left;">å°†é«˜ç»´å‘é‡åˆ’åˆ†ä¸ºå¤šä¸ªå­ç©ºé—´ï¼Œå¹¶å¯¹æ¯ä¸ªå­ç©ºé—´è¿›è¡Œé‡åŒ–</td><td style="text-align: left;">- é€‚ç”¨äºé«˜ç»´å‘é‡çš„å‹ç¼©å’Œç´¢å¼•<br>-é™ä½å†…å­˜å’Œè®¡ç®—æˆæœ¬</td><td style="text-align: left;">- é‡åŒ–è¯¯å·®å¯¼è‡´è¿‘ä¼¼ç»“æœ<br>-éš¾ä»¥å¤„ç†éæ¬§å‡ é‡Œå¾·ç©ºé—´æ•°æ®</td><tdstyle="text-align: left;">å¤§æ•°æ®é›†çš„å¿«é€Ÿè¿‘é‚»æœç´¢ï¼Œä¾‹å¦‚å›¾åƒæ£€ç´¢ã€è¯­éŸ³è¯†åˆ«ã€æ–‡æœ¬æœç´¢</td></tr><tr class="odd"><td style="text-align: left;">Locality-sensitive hashing</td><tdstyle="text-align: left;">ä½¿ç”¨å“ˆå¸Œå‡½æ•°å°†ç›¸ä¼¼çš„å‘é‡æ˜ å°„åˆ°ç›¸åŒçš„æ¡¶ï¼Œä»¥ä¾¿è¿›è¡Œå¿«é€Ÿè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢</td><td style="text-align: left;">- é«˜æ•ˆçš„è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢<br>- æ˜“äºæ‰©å±•</td><td style="text-align: left;">- å“ˆå¸Œå†²çªå¯¼è‡´è¯¯å·®å¢åŠ <br>-éœ€è¦è°ƒæ•´å‚æ•°ä»¥è¾¾åˆ°æ€§èƒ½è¦æ±‚</td><td style="text-align: left;">æ¨èç³»ç»Ÿã€ç›¸ä¼¼åº¦æœç´¢ã€å›¾åƒå’Œè§†é¢‘æ£€ç´¢</td></tr><tr class="even"><td style="text-align: left;">HNSW</td><tdstyle="text-align: left;">åŸºäºå›¾ç»“æ„çš„ç´¢å¼•æ–¹æ³•ï¼Œé€šè¿‡å±‚çº§å¯¼èˆªè¿›è¡Œå¿«é€Ÿè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢</td><td style="text-align: left;">- é«˜æ•ˆçš„è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢<br>- æ˜“äºæ‰©å±•</td><td style="text-align: left;">-æœç´¢ç»“æœæ˜¯è¿‘ä¼¼çš„è€Œä¸æ˜¯ç²¾ç¡®çš„è¿‘ä¼¼æ•°æ®</td><tdstyle="text-align: left;">å¤§è§„æ¨¡æ•°æ®é›†çš„è¿‘ä¼¼æœç´¢ã€æ¨èç³»ç»Ÿã€ç›¸ä¼¼åº¦æœç´¢ç­‰</td></tr></tbody></table><h2 id="ç›¸ä¼¼æ€§åº¦é‡">ç›¸ä¼¼æ€§åº¦é‡</h2><p>åœ¨ç´¢å¼•ç®—æ³•çš„åŸºç¡€ä¸Šï¼Œè¿˜éœ€è¦äº†è§£ç›¸ä¼¼æ€§åº¦é‡ï¼ˆSimilarityMeasuresï¼‰ï¼Œç›¸ä¼¼æ€§åº¦é‡æ˜¯å‘é‡æ•°æ®åº“å¯¹æ¯”ã€è¯†åˆ«ç»™å®šæŸ¥è¯¢æœ€è¿‘ä¼¼æ•°æ®ç»“æœçš„åŸºç¡€</p><p>ä¸‹é¢æ˜¯å‡ ç§ç›¸ä¼¼æ€§åº¦é‡çš„ç±»å‹ï¼š</p><ul><li><strong>ä½™å¼¦ç›¸ä¼¼æ€§</strong>ï¼ˆCosinesimilarityï¼‰ï¼šæµ‹é‡å‘é‡ç©ºé—´ä¸­ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è§’åº¦çš„ä½™å¼¦ï¼ŒèŒƒå›´ä¸º[-1,1]ï¼›å…¶ä¸­ 1 è¡¨ç¤ºå®Œå…¨ç›¸åŒçš„å‘é‡ï¼Œ0 è¡¨ç¤ºæ­£äº¤å‘é‡ï¼Œ-1è¡¨ç¤ºå®Œå…¨ç›¸åçš„å‘é‡</li><li><strong>æ¬§å‡ é‡Œå¾—è·ç¦»</strong>ï¼ˆEuclideandistanceï¼‰ï¼šæµ‹é‡å‘é‡ç©ºé—´ä¸­ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›´çº¿è·ç¦»ï¼ŒèŒƒå›´ä» 0åˆ°æ— ç©·å¤§ï¼›å…¶ä¸­ 0 è¡¨ç¤ºå®Œå…¨ç›¸åŒçš„å‘é‡ï¼Œè¶Šå¤§çš„å€¼è¡¨ç¤ºè¶Šä¸ç›¸ä¼¼</li><li><strong>ç‚¹ç§¯</strong>ï¼ˆDotproductï¼‰ï¼šæµ‹é‡ä¸¤ä¸ªçŸ¢é‡çš„å¤§å°ä¸å®ƒä»¬ä¹‹é—´è§’åº¦çš„ä½™å¼¦çš„ä¹˜ç§¯ï¼ŒèŒƒå›´ä»è´Ÿæ— ç©·åˆ°æ­£æ— ç©·ï¼Œå…¶ä¸­æ­£å€¼è¡¨ç¤ºæŒ‡å‘åŒä¸€æ–¹å‘çš„å‘é‡ï¼Œ0è¡¨ç¤ºæ­£äº¤å‘é‡ï¼Œè´Ÿå€¼è¡¨ç¤ºæŒ‡å‘ç›¸åæ–¹å‘çš„å‘é‡</li></ul><p>ç›¸ä¼¼æ€§åº¦é‡çš„é€‰æ‹©å°†å¯¹å‘é‡æ•°æ®åº“è·å¾—çš„ç»“æœäº§ç”Ÿå½±å“ï¼Œéœ€è¦æ³¨æ„æ¯ä¸ªç›¸ä¼¼æ€§åº¦é‡éƒ½æœ‰å…¶è‡ªèº«çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œæ ¹æ®ç”¨ä¾‹å’Œéœ€æ±‚é€‰æ‹©æ­£ç¡®çš„åº¦é‡æ–¹å¼éå¸¸é‡è¦</p><table style="width:100%;"><colgroup><col style="width: 4%" /><col style="width: 25%" /><col style="width: 28%" /><col style="width: 24%" /><col style="width: 16%" /></colgroup><thead><tr class="header"><th style="text-align: left;">ç›¸ä¼¼æ€§åº¦é‡</th><th style="text-align: left;">ç‰¹ç‚¹</th><th style="text-align: left;">ä¼˜ç‚¹</th><th style="text-align: left;">ç¼ºç‚¹</th><th style="text-align: left;">é€‚åˆçš„æ•°æ®åœºæ™¯ï¼ˆä¸šåŠ¡ç±»å‹ï¼‰</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">æ¬§æ°è·ç¦»</td><tdstyle="text-align: left;">åŸºäºå‘é‡çš„æ¬§å‡ é‡Œå¾·è·ç¦»ï¼Œè¡¡é‡å‘é‡ä¹‹é—´çš„å‡ ä½•è·ç¦»</td><td style="text-align: left;">- ç›´è§‚ç®€å•çš„åº¦é‡æ–¹æ³•<br>-é€‚ç”¨äºè¿ç»­æ•°å€¼å‘é‡</td><td style="text-align: left;">- å¯¹å¼‚å¸¸å€¼æ•æ„Ÿ<br>- ä¸é€‚ç”¨äºç¨€ç–å‘é‡</td><td style="text-align: left;">æ•°æ®èšç±»ã€æ•°æ®æŒ–æ˜ã€å›¾åƒå’ŒéŸ³é¢‘å¤„ç†</td></tr><tr class="even"><td style="text-align: left;">æ›¼å“ˆé¡¿è·ç¦»</td><tdstyle="text-align: left;">è¡¡é‡å‘é‡ä¹‹é—´çš„åŸå¸‚è¡—åŒºè·ç¦»ï¼Œå³ä¸¤ç‚¹é—´åæ ‡å·®çš„ç»å¯¹å€¼ä¹‹å’Œ</td><td style="text-align: left;">- ç›´è§‚ç®€å•çš„åº¦é‡æ–¹æ³•<br>-ä¸å—å¼‚å¸¸å€¼çš„å½±å“</td><td style="text-align: left;">- ä¸é€‚ç”¨äºé«˜ç»´ç¨€ç–æ•°æ®<br>-å¿½ç•¥äº†ç»´åº¦ä¹‹é—´çš„ç›¸å…³æ€§</td><td style="text-align: left;">è·¯å¾„è§„åˆ’ã€ç‰©æµä¼˜åŒ–ã€å›¾åƒå’ŒéŸ³é¢‘å¤„ç†</td></tr><tr class="odd"><td style="text-align: left;">ä½™å¼¦ç›¸ä¼¼åº¦</td><tdstyle="text-align: left;">åŸºäºå‘é‡ä¹‹é—´çš„å¤¹è§’ï¼Œè¡¡é‡å‘é‡ä¹‹é—´çš„æ–¹å‘ç›¸ä¼¼ç¨‹åº¦</td><td style="text-align: left;">- ä¸å—å‘é‡é•¿åº¦çš„å½±å“<br>-é€‚ç”¨äºç¨€ç–å‘é‡å’Œæ–‡æœ¬æ•°æ®</td><td style="text-align: left;">- ä¸é€‚ç”¨äºåŒ…å«ç»å¯¹å€¼ä¿¡æ¯çš„å‘é‡<br>-å¿½ç•¥äº†å‘é‡çš„å°ºåº¦</td><td style="text-align: left;">æ–‡æœ¬åˆ†ç±»ã€ä¿¡æ¯æ£€ç´¢ã€æ¨èç³»ç»Ÿ</td></tr><tr class="even"><td style="text-align: left;">ç‚¹ç§¯</td><tdstyle="text-align: left;">ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å…ƒç´ ä¹˜ç§¯ä¹‹å’Œï¼Œè¡¡é‡å‘é‡ä¹‹é—´çš„ç›¸ä¼¼ç¨‹åº¦</td><td style="text-align: left;">- ç›´æ¥åº¦é‡å‘é‡ä¹‹é—´çš„ç›¸å…³æ€§å’ŒæŠ•å½±å…³ç³»<br>-é€‚ç”¨äºé«˜ç»´ç¨ å¯†å‘é‡</td><td style="text-align: left;">- å¯¹å‘é‡çš„é•¿åº¦æ•æ„Ÿ<br>-ä¸é€‚ç”¨äºç¨€ç–å‘é‡</td><td style="text-align: left;">æ–‡æœ¬åˆ†ç±»ã€æ¨èç³»ç»Ÿã€èšç±»åˆ†æ</td></tr></tbody></table><p><a href="https://www.pinecone.io/learn/vector-similarity/">Learn moreabout similarity measures</a></p><h2 id="è¿‡æ»¤">è¿‡æ»¤</h2><p>å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ¯ä¸ªå‘é‡ä¹ŸåŒ…æ‹¬å¯¹åº”çš„å…ƒæ•°æ®ï¼Œé™¤äº†æŸ¥è¯¢ç›¸ä¼¼å‘é‡çš„èƒ½åŠ›å¤–ï¼Œå‘é‡æ•°æ®åº“è¿˜å¯ä»¥åŸºäºå…ƒæ•°æ®æŸ¥è¯¢æ¥è¿‡æ»¤ç»“æœï¼Œæ‰€ä»¥å‘é‡æ•°æ®åº“é€šå¸¸ç»´æŠ¤ä¸¤ä¸ªç´¢å¼•ï¼šå‘é‡ç´¢å¼•å’Œå…ƒæ•°æ®ç´¢å¼•</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/Filter.png" class="" title="Filter"><p>è¿‡æ»¤è¿‡ç¨‹å¯ä»¥åœ¨å‘é‡æœç´¢ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œï¼Œä½†æ¯ç§æ–¹æ³•éƒ½æœ‰å…¶è‡ªèº«çš„é—®é¢˜ï¼Œå¯èƒ½ä¼šå½±å“æŸ¥è¯¢æ€§èƒ½</p><p>ä¸ºäº†ä¼˜åŒ–è¿‡æ»¤è¿‡ç¨‹ï¼Œå‘é‡æ•°æ®åº“ä½¿ç”¨å„ç§æŠ€æœ¯ï¼Œä¾‹å¦‚åˆ©ç”¨å…ƒæ•°æ®çš„é«˜çº§ç´¢å¼•æ–¹æ³•æˆ–ä½¿ç”¨å¹¶è¡Œå¤„ç†æ¥åŠ å¿«è¿‡æ»¤ä»»åŠ¡ï¼Œæƒè¡¡æœç´¢æ€§èƒ½ä¸è¿‡æ»¤ç²¾åº¦å¯¹äºå‘é‡æ•°æ®åº“ä¸­æä¾›é«˜æ•ˆã€ç²¾å‡†çš„æŸ¥è¯¢ç»“æœè‡³å…³é‡è¦</p><p><ahref="https://www.pinecone.io/learn/vector-search-filtering/">Learn moreabout vector search filtering</a>.</p><h2 id="æ•°æ®åº“æ”¯æŒ">æ•°æ®åº“æ”¯æŒ</h2><p>ä¸å‘é‡ç´¢å¼•ä¸åŒï¼Œå‘é‡æ•°æ®åº“é…å¤‡äº†ä¸€ç³»åˆ—åŠŸèƒ½ä½¿å…¶æ›´é€‚åˆåœ¨å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨</p><img src="/%E5%BC%80%E5%8F%91/DB/Vector/%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81.png" class="" title="æ•°æ®åº“æ”¯æŒ"><p>ä¾‹å¦‚</p><ul><li>æ€§èƒ½å’Œå®¹é”™</li><li>ç›‘æ§</li><li>æƒé™æ§åˆ¶</li><li>å¤‡ä»½</li><li>API å’Œ SDK</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://www.pinecone.io/learn/vector-embeddings-for-developers/">VectorEmbeddings for Developers: The Basics | Pinecone</a></p><p><ahref="https://www.pinecone.io/learn/vector-database/#What-is-a-Vector-Database">Whatis a Vector Database &amp; How Does it Work? Use Cases + Examples |Pinecone</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> Vector DB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DB </tag>
            
            <tag> Vector DB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.5 - è®°å¿†</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.5%20-%20%E8%AE%B0%E5%BF%86.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.5%20-%20%E8%AE%B0%E5%BF%86.html</url>
      
        <content type="html"><![CDATA[<h1 id="å…¥é—¨">å…¥é—¨</h1><p>åº•å±‚çš„ LLM å’ŒèŠå¤©æ¨¡å‹éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥ LangChainçš„é“¾å¼æ¨¡å‹å’Œä»£ç†æ¨¡å‹åŒæ ·éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œæ„å‘³ç€å®ƒä»¬ä¼šç‹¬ç«‹å¤„ç†æ¯æ¬¡è°ƒç”¨</p><p>æŸäº›åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯”å¦‚èŠå¤©æœºå™¨äººï¼Œè®°ä½å…ˆå‰çš„äº¤äº’æ˜¯è‡³å…³é‡è¦çš„ï¼›LangChainæä¾›äº†ç”¨äºç®¡ç†å’Œæ“ä½œä»¥å‰çš„èŠå¤©æ¶ˆæ¯çš„è¾…åŠ©å·¥å…·ï¼Œè¿™äº›å·¥å…·è¢«è®¾è®¡æˆæ¨¡å—åŒ–çš„ï¼Œå…¶æ¬¡LangChain æä¾›äº†å°†è¿™äº›å·¥å…·è½»æ¾æ•´åˆåˆ°é“¾å¼æ¨¡å‹ä¸­çš„æ–¹æ³•</p><h2 id="chatmessagehistory">ChatMessageHistory</h2><p>è½»é‡çº§çš„åŒ…è£…å™¨ï¼Œæ–¹ä¾¿ä¿å­˜äººç±»æ¶ˆæ¯ã€AI æ¶ˆæ¯ï¼Œä»¥åŠè·å–çš„æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ChatMessageHistory</span><br><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ConversationBufferMemory</span><br><span class="line">history = ChatMessageHistory()</span><br><span class="line">history.add_user_message(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line">history.add_ai_message(<span class="string">&quot;whats up?&quot;</span>)</span><br><span class="line"></span><br><span class="line">history.messages</span><br><span class="line"><span class="comment"># &gt;&gt; [HumanMessage(content=&#x27;hi!&#x27;, additional_kwargs=&#123;&#125;),AIMessage(content=&#x27;whats up?&#x27;, additional_kwargs=&#123;&#125;)]</span></span><br></pre></td></tr></table></figure><h2 id="conversationbuffermemory">ConversationBufferMemory</h2><p><code>ConversationBufferMemory</code> æ˜¯<code>ChatMessageHistory</code> çš„ä¸€ä¸ªåŒ…è£…å™¨ï¼Œå¯ä»¥æå–å˜é‡ä¸­çš„æ¶ˆæ¯</p><p>å¯ä»¥é¦–å…ˆå°†å…¶æå–ä¸ºå­—ç¬¦ä¸²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ConversationBufferMemory</span><br><span class="line"></span><br><span class="line">memory = ConversationBufferMemory()</span><br><span class="line">memory.chat_memory.add_user_message(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line">memory.chat_memory.add_ai_message(<span class="string">&quot;whats up?&quot;</span>)</span><br><span class="line"></span><br><span class="line">memory.load_memory_variables(&#123;&#125;)</span><br><span class="line"><span class="comment"># &gt;&gt;  &#123;&#x27;history&#x27;: &#x27;Human: hi!\nAI: whats up?&#x27;&#125;</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥å°†å†å²è®°å½•ä½œä¸ºæ¶ˆæ¯åˆ—è¡¨è·å–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">memory = ConversationBufferMemory(return_messages=<span class="literal">True</span>)</span><br><span class="line">memory.chat_memory.add_user_message(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line">memory.chat_memory.add_ai_message(<span class="string">&quot;whats up?&quot;</span>)</span><br><span class="line"></span><br><span class="line">memory.load_memory_variables(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt;  &#123;&#x27;history&#x27;: [HumanMessage(content=&#x27;hi!&#x27;, additional_kwargs=&#123;&#125;),AIMessage(content=&#x27;whats up?&#x27;, additional_kwargs=&#123;&#125;)]&#125;</span></span><br></pre></td></tr></table></figure><h2 id="åœ¨é“¾ä¸­ä½¿ç”¨">åœ¨é“¾ä¸­ä½¿ç”¨</h2><p>æœ€ååœ¨é“¾ä¸­ä½¿ç”¨å®ƒï¼ˆè®¾ç½®<code>verbose=True</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æç¤ºï¼‰</p><blockquote><p>verbose</p><p>æ˜¯å¦åœ¨è¯¦ç»†æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨è¯¦ç»†æ¨¡å¼ä¸‹ï¼Œä¸€äº›ä¸­é—´æ—¥å¿—å°†æ‰“å°åˆ°æ§åˆ¶å°</p><p>å¯é€šè¿‡<code>langchain.globals.get_verbose()</code> è®¿é—®</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.llms <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> ConversationChain</span><br><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ConversationBufferMemory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">llm = OpenAI(temperature=<span class="number">0</span>)</span><br><span class="line">conversation = ConversationChain(</span><br><span class="line">    llm=llm,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    memory=ConversationBufferMemory()</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fir = conversation.predict(<span class="built_in">input</span>=<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">sec = conversation.predict(<span class="built_in">input</span>=<span class="string">&quot;How to evaluate the world?&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(fir)</span><br><span class="line"><span class="comment"># &gt;&gt; Hello! How can I assist you today?</span></span><br><span class="line"><span class="built_in">print</span>(sec)</span><br><span class="line"><span class="comment"># &gt;&gt; Evaluating the world can be a complex task as it involves considering multiple factors and perspectives. Some common approaches to evaluating the world include assessing the state of the economy, analyzing social and political systems, examining environmental conditions, and evaluating the well-being of individuals and communities. It can also involve considering ethical and moral values, cultural differences, and historical contexts. Ultimately, the process of evaluating the world is subjective and can vary depending on individual beliefs, values, and priorities. Is there any specific aspect of the world you would like to evaluate?</span></span><br></pre></td></tr></table></figure><p>å› ä¸º <code>verbose</code> å‚æ•°ï¼Œä¼šåœ¨è¿‡ç¨‹ä¸­è¾“å‡ºå¦‚ä¸‹æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering new ConversationChain chain...</span><br><span class="line">Prompt after formatting:</span><br><span class="line">The following is a friendly conversation between a human and an AI. The AI is talkative and provides lots of specific details from its context. If the AI does not know the answer to a question, it truthfully says it does not know.</span><br><span class="line"></span><br><span class="line">Current conversation:</span><br><span class="line">Human: Hello World!</span><br><span class="line">AI: Hello! How can I assist you today?</span><br><span class="line">Human: How to evaluate the world?</span><br><span class="line">AI:</span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br></pre></td></tr></table></figure><h2 id="ä¿å­˜æ¶ˆæ¯å†å²">ä¿å­˜æ¶ˆæ¯å†å²</h2><p>åœ¨ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç»å¸¸ä¿å­˜å†å²æ¶ˆæ¯ï¼Œå¹¶åœ¨åç»­æµç¨‹åŠ è½½å’Œä½¿ç”¨</p><p>å¯ä»¥é€šè¿‡å…ˆå°†æ¶ˆæ¯è½¬æ¢ä¸ºæ™®é€šçš„ Python å­—å…¸ï¼Œä¿å­˜è¿™äº›å­—å…¸ï¼ˆå¦‚ Jsonæˆ–å…¶ä»–æ ¼å¼ï¼‰ï¼Œç„¶ååŠ è½½å®ƒä»¬æ¥è½»æ¾å®Œæˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">history = ChatMessageHistory()</span><br><span class="line">history.add_user_message(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line">history.add_ai_message(<span class="string">&quot;whats up?&quot;</span>)</span><br></pre></td></tr></table></figure><p>è½¬æ¢æˆå­—å…¸</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dicts = messages_to_dict(history.messages)</span><br><span class="line"><span class="built_in">print</span>(dicts)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; [&#123;&#x27;type&#x27;: &#x27;human&#x27;, &#x27;data&#x27;: &#123;&#x27;content&#x27;: &#x27;hi!&#x27;, &#x27;additional_kwargs&#x27;: &#123;&#125;, &#x27;type&#x27;: &#x27;human&#x27;, &#x27;example&#x27;: False&#125;&#125;, &#123;&#x27;type&#x27;: &#x27;ai&#x27;, &#x27;data&#x27;: &#123;&#x27;content&#x27;: &#x27;whats up?&#x27;, &#x27;additional_kwargs&#x27;: &#123;&#125;, &#x27;type&#x27;: &#x27;ai&#x27;, &#x27;example&#x27;: False&#125;&#125;]</span></span><br></pre></td></tr></table></figure><p>å­—å…¸è½¬æ¢ä¸º message</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">new_messages = messages_from_dict(dicts)</span><br><span class="line"><span class="built_in">print</span>(new_messages)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt;  [HumanMessage(content=&#x27;hi!&#x27;, additional_kwargs=&#123;&#125;),AIMessage(content=&#x27;whats up?&#x27;, additional_kwargs=&#123;&#125;)]</span></span><br></pre></td></tr></table></figure><h1 id="è®°å¿†ç±»å‹">è®°å¿†ç±»å‹</h1><h2 id="ç¼“å†²buffer">ç¼“å†²ï¼ˆBufferï¼‰</h2><p><code>ConversationBufferMemory</code>ç”¨æ¥å­˜å‚¨å†å²è®°å½•ï¼Œå¹¶ä»ä¸­æå–å†å²è®°å½•</p><p>å…¥é—¨ä¸­çš„ç¤ºä¾‹å°±æ˜¯ä½¿ç”¨ <code>ConversationBufferMemory</code>æ¥è¿›è¡Œå®ç°çš„</p><h2 id="ç¼“å†²çª—å£buffer-window">ç¼“å†²çª—å£ï¼ˆBuffer Windowï¼‰</h2><p><code>ConversationBufferWindowMemory</code>ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…ä¿æŒå¯¹è¯çš„äº¤äº’åˆ—è¡¨ï¼Œå®ƒåªä½¿ç”¨æœ€åçš„ Kä¸ªäº¤äº’ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ç¼“å†²åŒºå°±ä¸ä¼šå˜å¾—å¤ªå¤§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ConversationBufferWindowMemory</span><br><span class="line"></span><br><span class="line"><span class="comment"># k = 1ï¼Œå³åªä½¿ç”¨æœ€åçš„ 1 ä¸ªäº¤äº’</span></span><br><span class="line">memory = ConversationBufferWindowMemory(k=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;hi&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;whats up&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: &#x27;Human: hi\nAI: whats up&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;not much you&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;not much&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: &#x27;Human: not much you\nAI: not much&#x27;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="æ‘˜è¦summary">æ‘˜è¦ï¼ˆSummaryï¼‰</h2><p><code>ConversationSummaryMemory</code>ä¼šéšç€æ—¶é—´çš„æ¨ç§»åˆ›å»ºä¸€ä»½å¯¹è¯æ€»ç»“ï¼Œæœ‰æ•ˆåœ°ä»å¯¹è¯ä¸­å‹ç¼©ä¿¡æ¯</p><p>æ‘˜è¦è®°å¿†å°†å¯¹è¯è¿›è¡Œæ€»ç»“å¹¶å°†æ€»ç»“å†…å®¹å­˜å‚¨åœ¨è®°å¿†ä¸­ï¼Œç„¶åå¯ä»¥å°†æ­¤è®°å¿†ç”¨äºå°†è¿„ä»Šä¸ºæ­¢çš„å¯¹è¯æ‘˜è¦æ³¨å…¥åˆ°æç¤ºæˆ–è€…é“¾ä¸­ï¼›æ­¤è®°å¿†å¯¹äºè¾ƒé•¿çš„å¯¹è¯éå¸¸æœ‰ç”¨ï¼Œå¦‚æœåœ¨æç¤ºä¸­ä¿å­˜æ‰€æœ‰çš„å†å²æ¶ˆæ¯å°†ä¼šå ç”¨å¤ªå¤štoken</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ConversationSummaryMemory, ChatMessageHistory</span><br><span class="line"><span class="keyword">from</span> langchain.llms <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line">memory = ConversationSummaryMemory(</span><br><span class="line">    llm=chat_model, </span><br><span class="line">    return_messages=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;hi&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;whats up&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: [SystemMessage(content=&#x27;The human greets the AI with &quot;Hello World!&quot; and the AI responds with &quot;Yes!&quot;&#x27;)]&#125;</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ <code>predict_new_summary</code> æ–¹æ³•ï¼Œä¼ å…¥ messageé›†åˆï¼Œç›´æ¥è·å–æ‘˜è¦å†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">messages = memory.chat_memory.messages</span><br><span class="line">previous_summary = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(memory.predict_new_summary(messages, previous_summary))</span><br><span class="line"><span class="comment"># &gt;&gt; The human greets the AI with &quot;Hello World!&quot; and the AI responds with &quot;Yes!&quot;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥é€‰æ‹©ä½¿ç”¨ä»¥å‰ç”Ÿæˆçš„æ‘˜è¦æ¥åŠ å¿«åˆå§‹åŒ–é€Ÿåº¦ï¼Œå¹¶é€šè¿‡ç›´æ¥åˆå§‹åŒ–æ¥é¿å…é‡æ–°ç”Ÿæˆæ‘˜è¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">memory = ConversationSummaryMemory(</span><br><span class="line">    llm=chat_module,</span><br><span class="line">    <span class="comment"># è¿™é‡Œçš„ buffer æ„é€ å‚æ•°ç”¨äºåˆå§‹åŒ–</span></span><br><span class="line">    buffer=<span class="string">&quot;The human asks what the AI thinks of artificial intelligence. The AI thinks artificial intelligence is a force for good because it will help humans reach their full potential.&quot;</span>,</span><br><span class="line">    chat_memory=history,</span><br><span class="line">    return_messages=<span class="literal">True</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="æ··åˆbuffer-summary">æ··åˆï¼ˆBuffer Summaryï¼‰</h2><p><code>ConversationSummaryBufferMemory</code>ç»“åˆäº†ç¼“å†²å’Œæ‘˜è¦ä¸¤ç§ç‰¹ç‚¹ï¼Œä¿ç•™äº†æœ€è¿‘äº¤äº’çš„ç¼“å†²ä¿¡æ¯ï¼Œä½†å®ƒä¸åªæ˜¯å®Œå…¨åˆ·æ–°æ—§çš„äº¤äº’æ•°æ®ï¼Œè€Œæ˜¯å°†å®ƒä»¬åŒæ—¶æ€»ç»“ä¸ºæ‘˜è¦</p><p>é€šè¿‡ <code>max_token_limit</code>è¿™ä¸ªå‚æ•°è¿›è¡Œå®ç°çš„ï¼Œå½“æœ€æ–°çš„å¯¹è¯æ–‡å­—é•¿åº¦åœ¨å‚æ•°èŒƒå›´ä¹‹å†…çš„æ—¶å€™ï¼ŒLangChainä¼šè®°å¿†åŸå§‹å¯¹è¯å†…å®¹ï¼›å½“å¯¹è¯æ–‡å­—è¶…å‡ºäº†è¿™ä¸ªå‚æ•°çš„é•¿åº¦ï¼Œé‚£ä¹ˆæ¨¡å‹å°±ä¼šæŠŠæ‰€æœ‰è¶…è¿‡é¢„è®¾é•¿åº¦çš„å†…å®¹è¿›è¡Œæ€»ç»“ï¼Œä»¥èŠ‚çœToken æ•°é‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">memory = ConversationSummaryBufferMemory(llm=llm, max_token_limit=<span class="number">10</span>)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;hi&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;whats up&quot;</span>&#125;)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;not much you&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;not much&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;&#125;))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ²¡æœ‰æˆåŠŸè°ƒç”¨ï¼Œå› ä¸º Azure çš„ gpt-35-turbo-16k æ¨¡å‹è¿˜æ²¡æœ‰å®ç° tokenç›¸å…³çš„ <code>get_num_tokens_from_messages</code> æ–¹æ³•ï¼ˆè¯¦è§langchain.chat_models.openai.ChatOpenAI.get_num_tokens_from_messagesï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError(</span><br><span class="line">        <span class="string">f&quot;get_num_tokens_from_messages() is not presently implemented &quot;</span></span><br><span class="line">        <span class="string">f&quot;for model <span class="subst">&#123;model&#125;</span>.&quot;</span></span><br><span class="line">        <span class="string">&quot;See https://github.com/openai/openai-python/blob/main/chatml.md for &quot;</span></span><br><span class="line">        <span class="string">&quot;information on how messages are converted to tokens.&quot;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ‘˜å½•ä¸€ä¸‹æå®¢æ—¶é—´ç›¸å…³è¯¾ç¨‹çš„ç¤ºä¾‹ï¼Œæ„Ÿå—ä¸‹ buffer å’Œ summaryçš„å…±åŒä½œç”¨</p><hr /><p>ç¬¬ä¸€å›åˆè¾“å‡º</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;input&#x27;<span class="punctuation">:</span> &#x27;æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚&#x27;<span class="punctuation">,</span></span><br><span class="line">&#x27;history&#x27;<span class="punctuation">:</span> &#x27;&#x27;<span class="punctuation">,</span></span><br><span class="line">&#x27;response&#x27;<span class="punctuation">:</span> &#x27; å“‡ï¼Œä½ å§å§è¦è¿‡ç”Ÿæ—¥å•Šï¼é‚£å¤ªæ£’äº†ï¼æˆ‘å»ºè®®ä½ å»ä¹°ä¸€æŸè‰²å½©é²œè‰³çš„èŠ±æŸï¼Œå› ä¸ºè¿™æ ·å¯ä»¥ä»£è¡¨ä½ ç»™å¥¹çš„ç¥ç¦å’Œç¥æ„¿ã€‚ä½ å¯ä»¥å»ä½ å®¶é™„è¿‘çš„èŠ±åº—ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥çœ‹çœ‹æœ‰æ²¡æœ‰ç‰¹åˆ«çš„èŠ±æŸï¼Œæ¯”å¦‚å½©è‰²ç«ç‘°æˆ–è€…ç™¾åˆèŠ±ï¼Œå®ƒä»¬ä¼šæ›´æœ‰ç‰¹è‰²ã€‚&#x27;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå›åˆçš„è¾“å‡º</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;input&#x27;<span class="punctuation">:</span> &#x27;å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚&#x27;<span class="punctuation">,</span></span><br><span class="line">&#x27;history&#x27;<span class="punctuation">:</span> &#x27;Human<span class="punctuation">:</span> æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\nAI<span class="punctuation">:</span>Â  å“‡ï¼Œä½ å§å§è¦è¿‡ç”Ÿæ—¥å•Šï¼é‚£å¤ªæ£’äº†ï¼æˆ‘å»ºè®®ä½ å»ä¹°ä¸€æŸè‰²å½©é²œè‰³çš„èŠ±æŸï¼Œå› ä¸ºè¿™æ ·å¯ä»¥ä»£è¡¨ä½ ç»™å¥¹çš„ç¥ç¦å’Œç¥æ„¿ã€‚ä½ å¯ä»¥å»ä½ å®¶é™„è¿‘çš„èŠ±åº—ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥çœ‹çœ‹æœ‰æ²¡æœ‰ç‰¹åˆ«çš„èŠ±æŸï¼Œæ¯”å¦‚å½©è‰²ç«ç‘°æˆ–è€…ç™¾åˆèŠ±ï¼Œå®ƒä»¬ä¼šæ›´æœ‰ç‰¹è‰²ã€‚&#x27;<span class="punctuation">,</span></span><br><span class="line">&#x27;response&#x27;<span class="punctuation">:</span> &#x27; å¥½çš„ï¼Œé‚£ç²‰è‰²ç«ç‘°å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼ä½ å¯ä»¥ä¹°ä¸€æŸç²‰è‰²ç«ç‘°èŠ±æŸï¼Œè¿™æ ·ä½ å§å§ä¼šå¾ˆå¼€å¿ƒçš„ï¼ä½ å¯ä»¥åœ¨èŠ±åº—é‡Œæ‰¾åˆ°ç²‰è‰²ç«ç‘°ï¼Œä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„é¢„ç®—ï¼Œé€‰æ‹©åˆé€‚çš„æ•°é‡ã€‚å¦å¤–ï¼Œä½ å¯ä»¥è€ƒè™‘æ·»åŠ ä¸€äº›è£…é¥°ï¼Œæ¯”å¦‚ç»†ç»³ã€å½©å¸¦æˆ–è€…å°ç¤¼å“&#x27;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰å›åˆçš„è¾“å‡º</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;input&#x27;<span class="punctuation">:</span> &#x27;æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ&#x27;<span class="punctuation">,</span></span><br><span class="line">&#x27;history&#x27;<span class="punctuation">:</span> <span class="string">&quot;System: \nThe human asked the AI for advice on buying a bouquet for their sister&#x27;s birthday. The AI suggested buying a vibrant bouquet as a representation of their wishes and blessings, and recommended looking for special bouquets like colorful roses or lilies for something more unique.\nHuman: å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\nAI:Â  å¥½çš„ï¼Œé‚£ç²‰è‰²ç«ç‘°å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼ä½ å¯ä»¥ä¹°ä¸€æŸç²‰è‰²ç«ç‘°èŠ±æŸï¼Œè¿™æ ·ä½ å§å§ä¼šå¾ˆå¼€å¿ƒçš„ï¼ä½ å¯ä»¥åœ¨èŠ±åº—é‡Œæ‰¾åˆ°ç²‰è‰²ç«ç‘°ï¼Œä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„é¢„ç®—ï¼Œé€‰æ‹©åˆé€‚çš„æ•°é‡ã€‚å¦å¤–ï¼Œä½ å¯ä»¥è€ƒè™‘æ·»åŠ ä¸€äº›è£…é¥°ï¼Œæ¯”å¦‚ç»†ç»³ã€å½©å¸¦æˆ–è€…å°ç¤¼å“&quot;</span><span class="punctuation">,</span></span><br><span class="line">&#x27;response&#x27;<span class="punctuation">:</span> &#x27; æ˜¯çš„ï¼Œæˆ‘è®°å¾—ä½ æ˜¨å¤©æ¥ä¹°èŠ±æ˜¯ä¸ºäº†ç»™ä½ å§å§çš„ç”Ÿæ—¥ã€‚ä½ æƒ³ä¹°ä¸€æŸç²‰è‰²ç«ç‘°èŠ±æŸæ¥è¡¨è¾¾ä½ çš„ç¥ç¦å’Œç¥æ„¿ï¼Œä½ å¯ä»¥åœ¨èŠ±åº—é‡Œæ‰¾åˆ°ç²‰è‰²ç«ç‘°ï¼Œä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„é¢„ç®—ï¼Œé€‰æ‹©åˆé€‚çš„æ•°é‡ã€‚å¦å¤–ï¼Œä½ å¯ä»¥è€ƒè™‘æ·»åŠ ä¸€äº›è£…é¥°ï¼Œæ¯”å¦‚ç»†ç»³ã€å½©å¸¦æˆ–è€…å°ç¤¼å“<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸éš¾çœ‹å‡ºåœ¨ç¬¬äºŒå›åˆï¼Œè®°å¿†æœºåˆ¶å®Œæ•´åœ°è®°å½•äº†ç¬¬ä¸€å›åˆçš„å¯¹è¯ï¼Œä½†æ˜¯åœ¨ç¬¬ä¸‰å›åˆï¼Œå®ƒå¯Ÿè§‰å‡ºå‰ä¸¤è½®çš„å¯¹è¯å·²ç»è¶…å‡ºäº†è®¾ç½®çš„token æ•°é‡ï¼ˆç¤ºä¾‹ä¸­è®¾ç½®çš„æ˜¯ 300ï¼‰ï¼Œå°±æŠŠæ—©æœŸçš„å¯¹è¯åŠ ä»¥æ€»ç»“ï¼Œä»¥èŠ‚çœ tokenèµ„æº</p><p><code>ConversationSummaryBufferMemory</code>çš„ä¼˜åŠ¿æ˜¯é€šè¿‡æ€»ç»“å¯ä»¥å›å¿†èµ·è¾ƒæ—©çš„äº’åŠ¨ï¼Œè€Œä¸”æœ‰ç¼“å†²åŒºç¡®ä¿æˆ‘ä»¬ä¸ä¼šé”™è¿‡æœ€è¿‘çš„äº’åŠ¨ä¿¡æ¯ï¼Œå½“ç„¶å¯¹äºè¾ƒçŸ­çš„å¯¹è¯ï¼Œ<code>ConversationSummaryBufferMemory</code>ä¹Ÿå¯èƒ½ä¼šå¢åŠ  token æ•°é‡</p><h2 id="token-ç¼“å†²token-buffer">Token ç¼“å†²ï¼ˆToken Bufferï¼‰</h2><p><code>ConversationTokenBufferMemory</code>ï¼Œåœ¨è®°å¿†ä¸­ä¿ç•™æœ€è¿‘äº¤äº’çš„äº’åŠ¨ç¼“å†²ï¼Œå¹¶ä½¿ç”¨token é•¿åº¦è€Œä¸æ˜¯äº¤äº’æ¬¡æ•°æ¥ç¡®å®šä½•æ—¶åˆ·æ–°äº¤äº’</p><p>ä¸ªäººè®¤ä¸ºç±»ä¼¼ç¼“å†²çª—å£ï¼Œä½†æ˜¯è¿™ä¸ªè®°å¿†ç±»å‹æ˜¯æ ¹æ® tokené•¿åº¦åˆ¤æ–­ä¸¢å¼ƒå“ªäº›å†…å®¹ï¼Œå³çª—å£æ»‘åŠ¨çš„æ ‡å‡†æ˜¯ token é•¿åº¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">memory = ConversationTokenBufferMemory(llm=llm, max_token_limit=<span class="number">10</span>)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;hi&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;whats up&quot;</span>&#125;)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;not much you&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;not much&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;&#125;))</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ“ä½œåŒæ ·ä¾èµ– <code>get_num_tokens_from_messages</code>æ–¹æ³•ï¼Œæš‚æ—¶æ— æ³•å®ç°</p><h2 id="å®ä½“entity">å®ä½“ï¼ˆEntityï¼‰</h2><p><code>ConversationEntityMemory</code>ä¼šè®°å¿†å…³äºä¼šè¯ä¸­ç‰¹å®šå®ä½“çš„ç»™å®šäº‹å®</p><p>å®ƒæå–å…³äºå®ä½“çš„ä¿¡æ¯ï¼ˆé€šè¿‡ä½¿ç”¨LLMï¼‰ï¼Œå¹¶éšç€æ—¶é—´çš„æ¨ç§»ç§¯ç´¯å…³äºè¯¥å®ä½“çš„çŸ¥è¯†ï¼ˆä¹Ÿé€šè¿‡ä½¿ç”¨ LLMï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">memory = ConversationEntityMemory(llm=Azure.chat_model)</span><br><span class="line">_<span class="built_in">input</span> = &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;Deven &amp; Sam are working on a hackathon project&quot;</span>&#125;</span><br><span class="line"><span class="comment"># è¿™é‡Œç”Ÿæˆæ–°çš„ entity key</span></span><br><span class="line">memory.load_memory_variables(_<span class="built_in">input</span>)</span><br><span class="line"><span class="comment"># è¿™é‡Œä¼šå¯¹ entity è¿›è¡Œæ€»ç»“</span></span><br><span class="line">memory.save_context(</span><br><span class="line">    _<span class="built_in">input</span>,</span><br><span class="line">    &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot; That sounds like a great project! What kind of project are they working on?&quot;</span>&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&#x27;The relation between Deven and Sam?&#x27;</span>&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: &#x27;Human: Deven &amp; Sam are working on a hackathon project\nAI:  That sounds like a great project! What kind of project are they working on?&#x27;, &#x27;entities&#x27;: &#123;&#x27;Deven&#x27;: &#x27;Deven is currently working on a hackathon project with Sam.&#x27;, &#x27;Sam&#x27;: &#x27;Sam is working on a hackathon project with Deven.&#x27;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&#x27;What is Sam doing?&#x27;</span>&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: &#x27;Human: Deven &amp; Sam are working on a hackathon project\nAI:  That sounds like a great project! What kind of project are they working on?&#x27;, &#x27;entities&#x27;: &#123;&#x27;Sam&#x27;: &#x27;Sam is working on a hackathon project with Deven.&#x27;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“è¯é¢˜å’Œä¸¤ä¸ªäººç›¸å…³æ—¶<code>The relation between Deven and Sam?</code>ï¼Œè®°å¿†ä¼šæ€»ç»“å¹¶åŒæ—¶è¿”å›Deven å’Œ Sam çš„ä¿¡æ¯ï¼›å½“è¯é¢˜åªå’Œ Sam æœ‰å…³æ—¶<code>What is Sam doing?</code>ï¼Œåˆ™åªä¼šè¿”å› Sam çš„å®ä½“ä¿¡æ¯</p><h2 id="çŸ¥è¯†å›¾knowledge-graph">çŸ¥è¯†å›¾ï¼ˆKnowledge Graphï¼‰</h2><p><code>ConversationKGMemory</code> ä½¿ç”¨çŸ¥è¯†å›¾æ¥é‡æ–°åˆ›å»ºè®°å¿†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">llm = Azure.chat_model</span><br><span class="line">memory = ConversationKGMemory(llm=llm)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;say hi to Sam&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;who is Sam&quot;</span>&#125;)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;Sam is a friend&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;okay&quot;</span>&#125;)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;Sam and Deven are my teachers&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;okay,I known&quot;</span>&#125;)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;Deven has a white watch&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;okay&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;who is sam&quot;</span>&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: &#x27;On Sam: Sam is a person. Sam is a friend. Sam is my teacher.\nOn Deven: Deven is my teacher. Deven has white watch.&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;who is Deven&quot;</span>&#125;))</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: &#x27;On Deven: Deven is my teacher. Deven has white watch.&#x27;&#125;</span></span><br></pre></td></tr></table></figure><p>å’Œå®ä½“ç±»ä¼¼ï¼Œéƒ½æ˜¯ä½¿ç”¨ LLM å¯¹å†…å®¹è¿›è¡Œæ¦‚æ‹¬å’ŒåŒ¹é…</p><h2 id="å‘é‡å­˜å‚¨vector-store">å‘é‡å­˜å‚¨ï¼ˆVector Storeï¼‰</h2><p><code>VectorStoreRetrieverMemory</code>å°†è®°å¿†å­˜å‚¨åœ¨å‘é‡å­˜å‚¨ä¸­ï¼Œå¹¶åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æŸ¥è¯¢å‰ K ä¸ªæœ€åŒ¹é…çš„æ–‡æ¡£</p><p>ä¸å¤§å¤šæ•°å…¶ä»–è®°å¿†ç±»ä¸åŒçš„æ˜¯ï¼Œå®ƒ<strong>ä¸æ˜ç¡®è·Ÿè¸ªäº¤äº’çš„é¡ºåº</strong>ï¼Œâ€æ–‡æ¡£â€œæ˜¯å†å²çš„å¯¹è¯ç‰‡æ®µï¼Œæœ‰åŠ©äºå¸®åŠ©AI äº†è§£æ—©æœŸå†å²çš„å†…å®¹</p><p><strong>åˆå§‹åŒ–å‘é‡å­˜å‚¨å·¥å…·</strong></p><p>å–å†³äºæ‰€ä½¿ç”¨çš„å‘é‡å­˜å‚¨å·¥å…·</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.docstore <span class="keyword">import</span> InMemoryDocstore</span><br><span class="line"><span class="keyword">from</span> langchain.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"></span><br><span class="line">embedding_size = <span class="number">1536</span> <span class="comment"># OpenAIEmbeddings çš„ç»´åº¦</span></span><br><span class="line">index = faiss.IndexFlatL2(embedding_size)</span><br><span class="line">embedding_fn = OpenAIEmbeddings().embed_query</span><br><span class="line">vectorstore = FAISS(embedding_fn, index, InMemoryDocstore(&#123;&#125;), &#123;&#125;)</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º VectorStoreRetrieverMemory</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ‚¨å¯ä»¥å°†å‚æ•° k è®¾ç½®å¾—æ›´é«˜ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ k=1 æ¥å±•ç¤ºå‘é‡æŸ¥æ‰¾ä»ç„¶è¿”å›è¯­ä¹‰ç›¸å…³çš„ä¿¡æ¯</span></span><br><span class="line">retriever = vectorstore.as_retriever(search_kwargs=<span class="built_in">dict</span>(k=<span class="number">1</span>))</span><br><span class="line">memory = VectorStoreRetrieverMemory(retriever=retriever)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“æ·»åŠ åˆ°ä»£ç†ç¨‹åºæ—¶ï¼Œå†…å­˜å¯¹è±¡å¯ä»¥ä¿å­˜æ¥è‡ªå¯¹è¯æˆ–ä½¿ç”¨å·¥å…·çš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;My favorite food is pizza&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;that&#x27;s good to know&quot;</span>&#125;)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;My favorite sport is soccer&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;...&quot;</span>&#125;)</span><br><span class="line">memory.save_context(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;I don&#x27;t the Celtics&quot;</span>&#125;, &#123;<span class="string">&quot;output&quot;</span>: <span class="string">&quot;ok&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(memory.load_memory_variables(&#123;<span class="string">&quot;prompt&quot;</span>: <span class="string">&quot;what sport should i watch?&quot;</span>&#125;)[<span class="string">&quot;history&quot;</span>])</span><br><span class="line"><span class="comment"># &gt;&gt; input: My favorite sport is soccer\noutput: ...</span></span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><p>å› ä¸ºå®ä½“ã€å‘é‡ç­‰ç±»å‹æ˜¯åç»­ç‰ˆæœ¬æä¾›çš„ï¼Œè¿™é‡Œåªè¿›è¡ŒåŸºç¡€çš„å››ç§è®°å¿†ç±»å‹çš„æ€»ç»“</p><table><colgroup><col style="width: 27%" /><col style="width: 32%" /><col style="width: 39%" /></colgroup><thead><tr class="header"><th style="text-align: left;">ç±»å‹</th><th style="text-align: left;">ä¼˜ç‚¹</th><th style="text-align: left;">ç¼ºç‚¹</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">ConversationBufferMemoryï¼ˆç¼“å†²ï¼‰</td><td style="text-align: left;">æä¾›å®Œæ•´ä¿¡æ¯ï¼›ç®€å•ã€ç›´è§‚</td><td style="text-align: left;">ä½¿ç”¨æ›´å¤štokenï¼Œæé«˜å“åº”æ—¶é—´å’Œæˆæœ¬ï¼›å¯¹è¯å¯èƒ½è¶…å‡º token é™åˆ¶</td></tr><tr class="even"><tdstyle="text-align: left;">ConversationBufferWindowMemoryï¼ˆç¼“å†²çª—å£ï¼‰</td><td style="text-align: left;">token ä½¿ç”¨é‡è¾ƒå°ï¼›çª—å£çµæ´»</td><td style="text-align: left;">æ— æ³•è®°å½•æ—©æœŸäº’åŠ¨ï¼›çª—å£å¯èƒ½è®¾ç½®ä¸åˆç†</td></tr><tr class="odd"><td style="text-align: left;">ConversationSummaryMemoryï¼ˆæ‘˜è¦ï¼‰</td><td style="text-align: left;">å¯¹äºé•¿å¯¹è¯å‡å°‘ tokenä½¿ç”¨ï¼›å…è®¸è¿›è¡Œæ›´é•¿æ—¶é—´çš„å¯¹è¯</td><td style="text-align: left;">çŸ­å¯¹è¯åè€Œå¢åŠ  tokençš„ä½¿ç”¨ï¼›å¯¹è¯è®°å¿†å–å†³äº LLM çš„æ€»ç»“èƒ½åŠ›ï¼›æ€»ç»“æ—¶ä¼šä½¿ç”¨é¢å¤–çš„ token</td></tr><tr class="even"><tdstyle="text-align: left;">ConversationSummaryBufferMemoryï¼ˆæ··åˆï¼‰</td><tdstyle="text-align: left;">èƒ½å¤Ÿå›å¿†èµ·æ—©æœŸäº’åŠ¨ï¼›ä¸ä¼šé”™è¿‡æœ€è¿‘æ¶ˆæ¯ï¼›çµæ´»æ€§é«˜</td><td style="text-align: left;">çŸ­å¯¹è¯åè€Œå¢åŠ  tokençš„ä½¿ç”¨ï¼›å­˜å‚¨åŸå§‹æ´»åŠ¨ä¹Ÿä¼šå¢åŠ  token çš„ä½¿ç”¨</td></tr></tbody></table><p>ä¸åŒè®°å¿†ç±»å‹äº¤äº’æ•°é‡å’Œ token æ•°é‡å¢é•¿ç»Ÿè®¡å›¾</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.5%20-%20%E8%AE%B0%E5%BF%86/%E8%AE%B0%E5%BF%86%E7%B1%BB%E5%9E%8B%E5%A2%9E%E9%95%BF.png" class="" title="è®°å¿†ç±»å‹å¢é•¿"><h1 id="åœ¨-llmchain-ä¸­è®°å¿†">åœ¨ LLMChain ä¸­è®°å¿†</h1><p>å¦‚ä½•å°†è®°å¿†ç±»å’Œ <code>LLMChain</code>ä¸€èµ·ä½¿ç”¨ï¼Œ<strong>å…³é”®åœ¨äºæ­£ç¡®è®¾ç½®æç¤º</strong></p><p>åœ¨ä¸‹é¢çš„æç¤ºä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªè¾“å…¥é”®ï¼šä¸€ä¸ªç”¨äºå®é™…è¾“å…¥ï¼Œå¦ä¸€ä¸ªç”¨äºè®°å¿†ç±»çš„è¾“å…¥ï¼Œéœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬è¦ç¡®ä¿<code>PromptTemplate</code> å’Œ <code>ConversationBufferMemory</code>ä¸­çš„é”®åŒ¹é…ï¼ˆchat_historyï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;&quot;&quot;You are a chatbot having a conversation with a human.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;chat_history&#125;</span></span><br><span class="line"><span class="string">Human: &#123;human_input&#125;</span></span><br><span class="line"><span class="string">Chatbot:&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;chat_history&quot;</span>, <span class="string">&quot;human_input&quot;</span>], template=template</span><br><span class="line">)</span><br><span class="line">memory = ConversationBufferMemory(memory_key=<span class="string">&quot;chat_history&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">llm = OpenAI()</span><br><span class="line">llm_chain = LLMChain(</span><br><span class="line">    llm=llm,</span><br><span class="line">    prompt=prompt,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    memory=memory,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">llm_chain.predict(human_input=<span class="string">&quot;Hi there my friend&quot;</span>)</span><br></pre></td></tr></table></figure><p>èŠå¤©æ¨¡å‹åŒç†</p><h1 id="conversationchain">ConversationChain</h1><p><code>ConversationChain</code> æ˜¯ <code>LLMChain</code>çš„å­ç±»ï¼Œæœ€ä¸»è¦çš„ç‰¹ç‚¹æ˜¯å®ƒæä¾›äº†åŒ…å« AIå‰ç¼€å’Œäººç±»å‰ç¼€çš„å¯¹è¯æ‘˜è¦æ ¼å¼ï¼Œè¿™ä¸ªå¯¹è¯æ ¼å¼å’Œè®°å¿†æœºåˆ¶ç»“åˆå¾—éå¸¸ç´§å¯†</p><p>çœ‹ä¸€ä¸‹ <code>ConversationChain</code> å†…ç½®çš„æ¨¡æ¿</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹åŒ–å¯¹è¯é“¾</span></span><br><span class="line">conv_chain = ConversationChain(llm=llm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°å¯¹è¯çš„æ¨¡æ¿</span></span><br><span class="line"><span class="built_in">print</span>(conv_chain.prompt.template)</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">The following <span class="keyword">is</span> a friendly conversation <span class="keyword">between</span> a human <span class="keyword">and</span> an AI. The AI <span class="keyword">is</span> talkative <span class="keyword">and</span> provides lots <span class="keyword">of</span> specific details <span class="keyword">from</span> <span class="keyword">its</span> context. If <span class="keyword">the</span> AI <span class="keyword">does</span> <span class="keyword">not</span> know <span class="keyword">the</span> answer <span class="keyword">to</span> a question, <span class="keyword">it</span> truthfully says <span class="keyword">it</span> <span class="keyword">does</span> <span class="keyword">not</span> know.</span><br><span class="line"></span><br><span class="line">Current conversation:</span><br><span class="line">&#123;history&#125;</span><br><span class="line">Human: &#123;input&#125;</span><br><span class="line">AI:</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæç¤ºè¯•å›¾é€šè¿‡è¯´æ˜ä»¥ä¸‹å†…å®¹æ¥å‡å°‘å¹»è§‰ï¼Œä¹Ÿå°±æ˜¯å°½é‡å‡å°‘æ¨¡å‹ç¼–é€ çš„ä¿¡æ¯ï¼š</p><ul><li>å¦‚æœ AI ä¸çŸ¥é“é—®é¢˜çš„ç­”æ¡ˆï¼Œå®ƒå°±ä¼šå¦‚å®è¯´å®ƒä¸çŸ¥é“</li><li>ä¸¤ä¸ªå‚æ•°ä¼šé€šè¿‡æç¤ºæ¨¡æ¿ä¼ é€’ç»™ LLMï¼Œæˆ‘ä»¬å¸Œæœ›è¿”å›çš„è¾“å‡ºåªæ˜¯å¯¹è¯çš„å»¶ç»­<ul><li>{history} å­˜å‚¨ä¼šè¯è®°å¿†</li><li>{input} è®¾ç½®æ–°çš„è¾“å…¥</li></ul></li></ul><p>å½“æœ‰äº† <code>&#123;history&#125;</code> å‚æ•°ï¼Œä»¥åŠ Human å’Œ AIè¿™ä¸¤ä¸ªå‰ç¼€ï¼Œæˆ‘ä»¬å°±èƒ½å¤ŸæŠŠå†å²å¯¹è¯ä¿¡æ¯å­˜å‚¨åœ¨æç¤ºæ¨¡æ¿ä¸­ï¼Œå¹¶ä½œä¸ºæ–°çš„æç¤ºå†…å®¹åœ¨æ–°ä¸€è½®çš„å¯¹è¯è¿‡ç¨‹ä¸­ä¼ é€’ç»™LLMï¼Œè¿™å°±æ˜¯è®°å¿†æœºåˆ¶çš„åŸç†</p><h1 id="è‡ªå®šä¹‰ä¼šè¯è®°å¿†">è‡ªå®šä¹‰ä¼šè¯è®°å¿†</h1><p>ä¸Šé¢ä»‹ç»äº† <code>ConversationChain</code>å°†ä»¥å¯¹è¯å½¢å¼æ ¼å¼åŒ–å†å²è®°å½•å¹¶ç”Ÿæˆæç¤ºï¼Œä¾èµ–æ‰€ç”¨çš„è®°å¿†ç±»ï¼ŒAI é»˜è®¤å‰ç¼€ä¸º<code>AI</code>ï¼Œäººç±»çš„é»˜è®¤å‰ç¼€ä¸º <code>Human</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConversationBufferMemory</span>(<span class="title class_ inherited__">BaseChatMemory</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Buffer for storing conversation memory.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    human_prefix: <span class="built_in">str</span> = <span class="string">&quot;Human&quot;</span></span><br><span class="line">    ai_prefix: <span class="built_in">str</span> = <span class="string">&quot;AI&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥è‡ªå®šä¹‰è¿›è¡Œå‰ç¼€çš„ä¿®æ”¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AI å‰ç¼€ä¿®æ”¹ä¸º AI Assistant</span></span><br><span class="line">memory = ConversationBufferMemory(ai_prefix=<span class="string">&quot;AI Assistant&quot;</span>)</span><br><span class="line"><span class="comment"># äººç±»å‰ç¼€ä¿®æ”¹ä¸º Friend</span></span><br><span class="line">memory = ConversationBufferMemory(human_prefix=<span class="string">&quot;Friend&quot;</span>)</span><br><span class="line"></span><br><span class="line">conversation = ConversationChain(</span><br><span class="line">    prompt=PROMPT,</span><br><span class="line">    llm=llm,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    memory=memory,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h1 id="è‡ªå®šä¹‰è®°å¿†">è‡ªå®šä¹‰è®°å¿†</h1><p>å·²ç»å­˜åœ¨ä¸€äº›é¢„å®šä¹‰ç±»å‹çš„è®°å¿†ï¼Œä¹Ÿå¯ä»¥å®ç°è‡ªå®šä¹‰çš„è®°å¿†ç±»</p><p>é€šè¿‡ç»§æ‰¿ <code>BaseMemory</code> æ¥å®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FavoriteFoodMemory</span>(<span class="title class_ inherited__">BaseMemory</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Memory class for storing information about entities.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Define dictionary to store information about entities.</span></span><br><span class="line">    entities: <span class="built_in">dict</span> = &#123;&#125;</span><br><span class="line">    <span class="comment"># Define key to pass information about entities into prompt.</span></span><br><span class="line">    memory_key: <span class="built_in">str</span> = <span class="string">&quot;entities&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear</span>(<span class="params">self</span>):</span><br><span class="line">        self.entities = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">memory_variables</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Define the variables we are providing to the prompt.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [self.memory_key]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_memory_variables</span>(<span class="params">self, inputs: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Load the memory variables, in this case the entity key.&quot;&quot;&quot;</span></span><br><span class="line">        s = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> self.entities.items():</span><br><span class="line">            s += (value + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;self.memory_key: s&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_context</span>(<span class="params">self, inputs: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], outputs: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Save context from this conversation to buffer.&quot;&quot;&quot;</span></span><br><span class="line">        pattern = <span class="string">r&quot;My favorite food is (\w+)&quot;</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> inputs.items():</span><br><span class="line">            matches = re.findall(pattern, value)</span><br><span class="line">            num_matches = <span class="built_in">len</span>(matches)</span><br><span class="line">            <span class="keyword">if</span> num_matches &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">match</span> = re.search(pattern, value)</span><br><span class="line">                food_name = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                self.entities[key] = food_name</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®ç°äº†ä¸€ä¸ªç®€å•çš„ç±»ï¼Œç”¨äºè·å–ç”¨æˆ·å–œæ¬¢åƒçš„é£Ÿç‰©</p><ul><li>å®šä¹‰äº†è®°å¿†ä¸­å˜é‡ nameï¼Œä¸º <code>entities</code></li><li>load_memory_variables æ–¹æ³•è·å– entitiesä¿å­˜çš„å–œå¥½ï¼Œæ‹¼è£…æˆå­—ç¬¦ä¸²è¾“å‡º</li><li>save_context é€šè¿‡æ­£åˆ™ <code>r"My favorite food is (\w+)</code>åŒ¹é…ç”¨æˆ·çš„é£Ÿç‰©å–œå¥½å¹¶ä¿å­˜</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;&quot;&quot;You are a chef, directly output the dish name you want to make based on user preferences.</span></span><br><span class="line"><span class="string">Don&#x27;t continue asking questions.</span></span><br><span class="line"><span class="string">Do not reply to questions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">User Preferences:</span></span><br><span class="line"><span class="string">&#123;entities&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Conversation:</span></span><br><span class="line"><span class="string">Human: &#123;input&#125;</span></span><br><span class="line"><span class="string">AI:&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># promptï¼Œè®© AI æ‰®æ¼”ä¸€ä¸ªå¨å¸ˆ</span></span><br><span class="line">prompt = PromptTemplate(input_variables=[<span class="string">&quot;entities&quot;</span>, <span class="string">&quot;input&quot;</span>], template=template)</span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰è®°å¿†ç±»</span></span><br><span class="line">custom_memory = FavoriteFoodMemory()</span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿè®°å¿†ç±»äº‹å…ˆä¿å­˜äº†äº’åŠ¨ï¼Œæå–è¿‡ç”¨æˆ·çš„å–œå¥½é£Ÿç‰©</span></span><br><span class="line">custom_memory.save_context(&#123;<span class="string">&#x27;input&#x27;</span>: <span class="string">&#x27;My favorite food is banana.&#x27;</span>&#125;, &#123;<span class="string">&#x27;output&#x27;</span>: <span class="string">&#x27;Greate!&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º ConversationChain</span></span><br><span class="line">conversation = ConversationChain(</span><br><span class="line">    llm=Azure.chat_model, prompt=prompt, verbose=<span class="literal">True</span>, memory=custom_memory</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(conversation.run(<span class="string">&quot;I&#x27;m hungry.&quot;</span>))</span><br><span class="line"><span class="comment"># &gt;&gt; Banana Split</span></span><br></pre></td></tr></table></figure><p>è¿‡ç¨‹ä¸­æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°æ­£ç¡®åœ°é€‰æ‹©äº†è®°å¿†ï¼Œå¹¶æ ¼å¼åŒ–åˆ°æç¤ºä¸­</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering <span class="built_in">new</span> ConversationChain chain...</span><br><span class="line">Prompt after formatting:</span><br><span class="line">You are a chef, directly output the dish name you want <span class="keyword">to</span> make based <span class="keyword">on</span> user preferences.</span><br><span class="line">Don<span class="comment">&#x27;t continue asking questions.</span></span><br><span class="line"><span class="keyword">Do</span> <span class="built_in">not</span> reply <span class="keyword">to</span> questions.</span><br><span class="line"></span><br><span class="line">User Preferences:</span><br><span class="line">banana</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">Conversation:</span></span><br><span class="line"><span class="symbol">Human:</span> I<span class="comment">&#x27;m hungry.</span></span><br><span class="line"><span class="symbol">AI:</span></span><br><span class="line"></span><br><span class="line">&gt; Finished chain.</span><br></pre></td></tr></table></figure><h1 id="ç»„åˆè®°å¿†">ç»„åˆè®°å¿†</h1><p>å¯ä»¥åœ¨åŒä¸€ä¸ªé“¾ä¸­ä½¿ç”¨å¤šä¸ªè®°å¿†ç±»ï¼Œè¦ç»„åˆå¤šä¸ªè®°å¿†ç±»éœ€è¦åˆå§‹åŒ–å¹¶ä½¿ç”¨<code>CombinedMemory</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼“å†²è®°å¿†</span></span><br><span class="line">conv_memory = ConversationBufferMemory(</span><br><span class="line">    memory_key=<span class="string">&quot;chat_history_lines&quot;</span>, input_key=<span class="string">&quot;input&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># æ‘˜è¦è®°å¿†</span></span><br><span class="line">summary_memory = ConversationSummaryMemory(llm=Azure.chat_model, input_key=<span class="string">&quot;input&quot;</span>)</span><br><span class="line"><span class="comment"># é€šè¿‡ CombinedMemory ç»„åˆ</span></span><br><span class="line">memory = CombinedMemory(memories=[conv_memory, summary_memory])</span><br><span class="line">_DEFAULT_TEMPLATE = <span class="string">&quot;&quot;&quot;The following is a friendly conversation between a human and an AI. </span></span><br><span class="line"><span class="string">The AI is talkative and provides lots of specific details from its context. </span></span><br><span class="line"><span class="string">If the AI does not know the answer to a question, it truthfully says it does not know.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Summary of conversation:</span></span><br><span class="line"><span class="string">&#123;history&#125;</span></span><br><span class="line"><span class="string">Current conversation:</span></span><br><span class="line"><span class="string">&#123;chat_history_lines&#125;</span></span><br><span class="line"><span class="string">Human: &#123;input&#125;</span></span><br><span class="line"><span class="string">AI:&quot;&quot;&quot;</span></span><br><span class="line">PROMPT = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;history&quot;</span>, <span class="string">&quot;input&quot;</span>, <span class="string">&quot;chat_history_lines&quot;</span>],</span><br><span class="line">    template=_DEFAULT_TEMPLATE,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># ConversationChain</span></span><br><span class="line">conversation = ConversationChain(llm=Azure.chat_model, verbose=<span class="literal">True</span>, memory=memory, prompt=PROMPT)</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒæŸ¥çœ‹ç»“æœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">conversation.run(<span class="string">&quot;Hi&quot;</span>)</span><br><span class="line"></span><br><span class="line">pprint(conversation.memory.memories[<span class="number">0</span>].load_memory_variables(&#123;&#125;))</span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯ç»„åˆçš„ ConversationBufferMemory</span></span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;chat_history_lines&#x27;: &#x27;Human: Hi\nAI: Hello! How can I assist you today?&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">pprint(conversation.memory.memories[<span class="number">1</span>].load_memory_variables(&#123;&#125;))</span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯ç»„åˆçš„ ConversationSummaryMemory</span></span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;history&#x27;: &#x27;The human greets the AI and the AI asks how it can assist the human.&#x27;&#125;</span></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://python.langchain.com/docs/modules/memory/types/vectorstore_retriever_memory">Backedby a Vector Store | ğŸ¦œï¸ğŸ”— Langchain</a></p><p><ahref="https://python.langchain.com.cn/docs/modules/memory/types/vectorstore_retriever_memory">æ”¯æŒå‘é‡å­˜å‚¨| ğŸ¦œï¸ğŸ”— Langchain</a></p><p><ahref="https://time.geekbang.org/column/intro/100617601?utm_campaign=geektime_search&amp;utm_content=geektime_search&amp;utm_medium=geektime_search&amp;utm_source=geektime_search&amp;utm_term=geektime_search">LangChainå®æˆ˜è¯¾ (geekbang.org)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL å°å¿ƒ FOR UPDATE çš„ Record é”</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20%E5%B0%8F%E5%BF%83%20FOR%20UPDATE%20%E7%9A%84%20Record%20%E9%94%81.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%20%E5%B0%8F%E5%BF%83%20FOR%20UPDATE%20%E7%9A%84%20Record%20%E9%94%81.html</url>
      
        <content type="html"><![CDATA[<h1 id="for-update">FOR UPDATE</h1><p><code>FOR UPDATE</code> æ˜¯ SELECT è¯­å¥çš„å¯é€‰å‚æ•°</p><p><a href="https://dev.mysql.com/doc/refman/5.7/en/select.html">MySQL:: MySQL 5.7 Reference Manual :: 13.2.9 SELECT Statement</a></p><ul><li><p>å¦‚æœå°† <code>FOR UPDATE</code>å’Œæ”¯æŒé¡µé”æˆ–è¡Œé”çš„æ•°æ®åº“å¼•æ“ä¸€èµ·ä½¿ç”¨ï¼ˆæ¯”å¦‚InnoDBï¼‰ï¼Œè¢«æŸ¥è¯¢çš„è¡Œå°†è¢«å†™é”å®šï¼Œç›´åˆ°å½“å‰äº‹åŠ¡ç»“æŸ ä½¿ç”¨<code>LOCK IN SHARE MODE</code>å°†è®¾ç½®å…±äº«é”ï¼Œå…è®¸å…¶ä»–äº‹åŠ¡è¯»å–æ£€æŸ¥çš„è¡Œï¼Œä½†ä¸æ›´æ–°æˆ–åˆ é™¤å®ƒä»¬</p></li><li><p>å½“ä½¿ç”¨ç±»ä¼¼çš„è¯­å¥<code>CREATE TABLE new_table SELECT ... FROM old_table</code> ä¸èƒ½åœ¨<code>SELECT</code> ä¸­ä½¿ç”¨ <code>FOR UPDATE</code></p><p>å¦‚æœæ‚¨å°è¯•æ‰§è¡Œæ­¤æ“ä½œï¼Œåˆ™è¯¥è¯­å¥å°†è¢«æ‹’ç»ï¼Œå¹¶æ˜¾ç¤º<code>Can't update table 'old_table' while 'new_table' is being created.</code></p></li></ul><h1 id="é”å®šè¯»">é”å®šè¯»</h1><p><ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-reads.html">MySQL:: MySQL 5.7 Reference Manual :: 14.7.2.4 Locking Reads</a></p><p>å¦‚æœæŸ¥è¯¢æ•°æ®åå¸Œæœ›åœ¨åŒä¸€äº‹åŠ¡ä¸­æ’å…¥æˆ–æ›´æ–°ç›¸å…³æ•°æ®ï¼Œåˆ™å¸¸è§„ SELECTè¯­å¥æ— æ³•æä¾›è¶³å¤Ÿçš„ä¿æŠ¤ï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥æ›´æ–°æˆ–åˆ é™¤æ‚¨åˆšæ‰æŸ¥è¯¢çš„åŒä¸€è¡Œ</p><p>InnoDB å¼•æ“æä¾›äº†ä¸¤ç§é”å®šè¯»çš„æ–¹å¼æ¥æä¾›é¢å¤–çš„å®‰å…¨ä¿è¯ï¼š</p><ul><li><code>SELECT ... LOCK IN SHARE MODE</code>åœ¨è¯»å–åˆ°çš„æ‰€æœ‰è¡Œä¸Šè®¾ç½®å…±äº«é”ï¼ˆshared modelockï¼‰å…¶ä»–äº‹åŠ¡å¯ä»¥è¿›è¡Œè¯»å–ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡æäº¤ä¹‹å‰éƒ½ä¸èƒ½è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœæŸ¥è¯¢è¿‡ç¨‹ä¸­è¿™äº›è¡Œä¸­çš„ä»»æ„è¡Œè¢«å¦ä¸€ä¸ªå°šæœªæäº¤çš„äº‹åŠ¡ä¿®æ”¹ï¼Œåˆ™æŸ¥è¯¢å°†ç­‰å¾…è¯¥äº‹åŠ¡ç»“æŸï¼Œç„¶åä½¿ç”¨æ›´æ–°åçš„å€¼</li><li><code>SELECT ... FOR UPDATE</code>å¯¹äºæŸ¥è¯¢åˆ°çš„ç´¢å¼•è®°å½•ï¼Œé”å®šè¡Œå’Œä»»ä½•å…³è”çš„ç´¢å¼•æ¡ç›®ï¼Œå°±åƒä¸ºè¿™äº›è¡Œè¿›è¡ŒUPDATE è¯­å¥ä¸€æ ·å¯¹å…¶ä»–äº‹åŠ¡è¢«é˜»æ­¢æ›´æ–°è¿™äº›è¡Œã€è¿›è¡ŒæŸ¥è¯¢ã€åœ¨å…±äº«æ¨¡å¼ä¸‹é”å®šæˆ–è¯»å–ç‰¹å®šäº‹åŠ¡éš”ç¦»çº§åˆ«çš„æ•°æ®ä¸€è‡´è¯»ï¼ˆå¿«ç…§è¯»ï¼‰å°†å¿½ç•¥åœ¨è¯»å–è§†å›¾ä¸­å­˜åœ¨çš„è®°å½•ä¸Šè®¾ç½®çš„ä»»ä½•é”ï¼ˆè®°å½•çš„æ—§ç‰ˆæœ¬æ— æ³•é”å®šï¼Œå› ä¸ºå®ƒä»¬æ˜¯é€šè¿‡åœ¨è®°å½•çš„å†…å­˜å‰¯æœ¬ä¸Šåº”ç”¨undo log æ¥é‡å»ºçš„ï¼‰</li></ul><p>è¿™äº›å­å¥åœ¨å¤„ç†æ ‘ç»“æ„æˆ–å›¾ç»“æ„æ•°æ®æ—¶éå¸¸æœ‰ç”¨ï¼Œæ— è®ºæ˜¯åœ¨å•ä¸ªè¡¨ä¸­è¿˜æ˜¯åœ¨å¤šä¸ªè¡¨ä¸­æ‹†åˆ†ï¼›å¯ä»¥ä»ä¸€ä¸ªä½ç½®éå†è¾¹æˆ–æ ‘æåˆ°å¦ä¸€ä¸ªä½ç½®ï¼ŒåŒæ—¶ä¿ç•™è¿”å›å¹¶æ›´æ”¹ä»»ä½•è¿™äº›â€œæŒ‡é’ˆâ€å€¼çš„æƒåˆ©</p><p>å½“äº‹åŠ¡è¢«æäº¤æˆ–å›æ»šæ—¶ï¼Œç”± LOCK IN SHARE MODE å’Œ FOR UPDATEæŸ¥è¯¢è®¾ç½®çš„æ‰€æœ‰é”éƒ½ä¼šè¢«é‡Šæ”¾</p><p><br></p><p><strong>FOR UPDATE ä¸ä¼šä¼ é€’</strong></p><p>å¤–éƒ¨è¯­å¥ä¸­çš„é”å®šè¯»å–å­å¥ä¸ä¼šé”å®šåµŒå¥—å­æŸ¥è¯¢ä¸­è¡¨çš„è¡Œï¼Œé™¤éåœ¨å­æŸ¥è¯¢ä¸­ä¹ŸæŒ‡å®šäº†é”å®šè¯»å–å­å¥</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è¯­å¥ä¸ä¼šé”å®šè¡¨ t2 ä¸­çš„è¡Œ</p><p><code>SELECT * FROM t1 WHERE c1 = (SELECT c1 FROM t2) FOR UPDATE;</code></p><p>è¦é”å®šè¡¨ t2 ä¸­çš„è¡Œï¼Œè¯·å‘å­æŸ¥è¯¢æ·»åŠ ä¸€ä¸ªé”å®šè¯»å–å­å¥</p><p><code>SELECT * FROM t1 WHERE c1 = (SELECT c1 FROM t2 FOR UPDATE) FOR UPDATE;</code></p><blockquote><p>locking read</p><p>A <ahref="https://dev.mysql.com/doc/refman/5.7/en/select.html"><code>SELECT</code></a>statement that also performs a <strong>locking</strong> operation on an<code>InnoDB</code> table. Either <code>SELECT ... FOR UPDATE</code> or<code>SELECT ... LOCK IN SHARE MODE</code>. It has the potential toproduce a <strong>deadlock</strong>, depending on the <strong>isolationlevel</strong> of the transaction. The opposite of a <strong>non-lockingread</strong>*. Not allowed for global tables in a <strong>read-onlytransaction</strong>.</p><p><code>SELECT ... FOR SHARE</code> replaces<code>SELECT ... LOCK IN SHARE MODE</code> in MySQL 8.0.1, but<code>LOCK IN SHARE MODE</code> remains available for backwardcompatibility.</p><p>See <ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-reads.html">Section14.7.2.4, â€œLocking Readsâ€</a>.</p><p>See Also <ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_deadlock">deadlock</a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_isolation_level">isolationlevel</a>, <ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_locking">locking</a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_non_locking_read">non-lockingread</a>, <ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_read_only_transaction">read-onlytransaction</a>.</p></blockquote><h1 id="ä¸€è‡´æ€§éé”å®šè¯»">ä¸€è‡´æ€§éé”å®šè¯»</h1><p>ä¸Šé¢ä»‹ç»é”å®šè¯»ä¸­ï¼Œæœ‰ä¸€å¥è§£é‡Š</p><blockquote><p>Consistent reads ignore any locks set on the records that exist inthe read view.</p><p>ä¸€è‡´è¯»å°†å¿½ç•¥åœ¨è¯»å–è§†å›¾ä¸­å­˜åœ¨çš„è®°å½•ä¸Šè®¾ç½®çš„ä»»ä½•é”</p></blockquote><p>è¿™é‡Œçš„ä¸€è‡´è¯»æŒ‡çš„å°±æ˜¯ä¸€è‡´æ€§éé”å®šè¯»ï¼ˆConsistent Nonlocking Readsï¼‰</p><p>ä¸€è‡´è¯»å–æ„å‘³ç€ InnoDBä½¿ç”¨å¤šç‰ˆæœ¬æ§åˆ¶åœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼ˆtimepointï¼‰å‘æŸ¥è¯¢æ˜¾ç¤ºæ•°æ®åº“çš„å¿«ç…§ï¼ŒæŸ¥è¯¢ä¼šçœ‹åˆ°åœ¨æ­¤æ—¶é—´ç‚¹ä¹‹å‰æäº¤çš„äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹ï¼Œè€Œä¸ä¼šçœ‹åˆ°ä»¥åæˆ–æœªæäº¤çš„äº‹åŠ¡è¿›è¡Œçš„ä¿®æ”¹</p><p>æ‚¨å¯ä»¥é€šè¿‡æäº¤äº‹åŠ¡ï¼Œç„¶åä½¿ç”¨ä¸€è‡´å¿«ç…§æ‰§è¡Œå¦ä¸€ä¸ª SELECTæˆ–å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡æ¥æ¨è¿›æ—¶é—´ç‚¹</p><p>ä¸åŒéš”ç¦»çº§åˆ«çš„å¿«ç…§ç­–ç•¥ï¼š</p><ul><li>REPEATABLEREADï¼šç¬¬ä¸€æ¬¡è¯»å–è®¾ç½®å¿«ç…§ï¼›æäº¤äº‹åŠ¡åçš„è¯»å–åˆ™ä¼šä½¿ç”¨æœ€æ–°æ•°æ®</li><li>READ COMMITTEDï¼šäº‹åŠ¡ä¸­çš„æ¯ä¸ªä¸€è‡´è¯»å–éƒ½ä¼šè®¾ç½®å¹¶è¯»å–è‡ªå·±çš„æ–°å¿«ç…§</li></ul><p><br></p><p><strong>ä¸¾ä¸€ä¸ªä¾‹å­è¯´æ˜ä¸€è‡´æ€§è¯»</strong></p><p>äº‹åŠ¡ A åªæœ‰åœ¨ B æäº¤äº†äº‹åŠ¡ï¼Œå¹¶ä¸” A ä¹Ÿæäº¤äº†äº‹åŠ¡æ—¶æ‰çœ‹åˆ°ç”± Bæ’å…¥çš„è¡Œ</p><table><thead><tr class="header"><th>äº‹åŠ¡ A</th><th>äº‹åŠ¡ B</th></tr></thead><tbody><tr class="odd"><td>å¼€å¯äº‹åŠ¡</td><td>å¼€å¯äº‹åŠ¡</td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆempty setï¼‰</td><td></td></tr><tr class="odd"><td></td><td>INSERT INTO tVALUES (1, 2);</td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆempty setï¼‰</td><td></td></tr><tr class="odd"><td></td><td>COMMIT;</td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆempty setï¼‰</td><td></td></tr><tr class="odd"><td>COMMIT;</td><td></td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆ1,2ï¼‰</td><td></td></tr></tbody></table><p>å¦‚æœæ‚¨æƒ³æŸ¥çœ‹æ•°æ®åº“çš„â€œæœ€æ–°â€çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ READ COMMITTEDéš”ç¦»çº§åˆ«æˆ–ä½¿ç”¨é”å®šè¯»</p><p><br></p><p><strong>éœ€è¦æ³¨æ„ DML å¯¹æ•°æ®å¯è§çš„å½±å“</strong></p><p>æ•°æ®åº“çŠ¶æ€çš„å¿«ç…§åº”ç”¨äºäº‹åŠ¡ä¸­çš„ SELECT è¯­å¥ï¼Œè€Œä¸ä¸€å®šåº”ç”¨äº DMLè¯­å¥</p><p>å¦‚æœæ’å…¥æˆ–ä¿®æ”¹æŸäº›è¡Œï¼Œç„¶åæäº¤è¯¥äº‹åŠ¡ï¼Œåˆ™ä»å¦ä¸€ä¸ªå¹¶å‘çš„ REPEATABLEREAD äº‹åŠ¡å‘å‡ºçš„ DELETE æˆ– UPDATEè¯­å¥å¯èƒ½ä¼šå½±å“é‚£äº›åˆšåˆšæäº¤çš„è¡Œï¼Œå³ä½¿ä¼šè¯æ— æ³•æŸ¥è¯¢åˆ°è¿™äº›æ•°æ®ï¼ˆå› ä¸ºå¿«ç…§ï¼‰</p><p>å¦‚æœäº‹åŠ¡ç¡®å®æ›´æ–°æˆ–åˆ é™¤äº†ç”±å…¶ä»–äº‹åŠ¡æäº¤çš„è¡Œï¼Œåˆ™è¿™äº›æ›´æ”¹å¯¹å½“å‰äº‹åŠ¡å¯è§</p><p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(c1) <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c1 <span class="operator">=</span> <span class="string">&#x27;xyz&#x27;</span>;</span><br><span class="line"><span class="comment">-- 0 è¡Œ</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c1 <span class="operator">=</span> <span class="string">&#x27;xyz&#x27;</span>;</span><br><span class="line"><span class="comment">-- å¯èƒ½ä¼šåˆ é™¤æœ€è¿‘ç”±å…¶ä»–äº‹åŠ¡æäº¤çš„åŒ¹é…åˆ°çš„è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(c2) <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c2 <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"><span class="comment">-- 0 è¡Œ</span></span><br><span class="line"><span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> c2 <span class="operator">=</span> <span class="string">&#x27;cba&#x27;</span> <span class="keyword">WHERE</span> c2 <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"><span class="comment">-- å¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡åˆšåˆšæäº¤äº† abc å€¼çš„ 10 è¡Œ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(c2) <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c2 <span class="operator">=</span> <span class="string">&#x27;cba&#x27;</span>;</span><br><span class="line"><span class="comment">-- 10 è¡Œï¼›è¿™ä¸ªäº‹åŠ¡ç°åœ¨å¯ä»¥çœ‹åˆ°å®ƒåˆšåˆšæ›´æ–°çš„è¡Œ</span></span><br></pre></td></tr></table></figure></p><h1 id="åˆç†ä½¿ç”¨-for-update">åˆç†ä½¿ç”¨ FOR UPDATE</h1><p>ä¸šåŠ¡ä¸­æœ‰æ—¶éœ€è¦æŸ¥è¯¢æ•°æ®ï¼Œå¯¹æ•°æ®è¿›è¡Œ checkä¹‹åå†æ›´æ–°ï¼Œå°±éœ€è¦ä½¿ç”¨é”æœºåˆ¶</p><p>å¾€å¾€ç®€å•çš„å®ç°æ–¹å¼æ˜¯åœ¨å¹¶å‘ä¸é«˜çš„åœºæ™¯ä¸‹å¼€å¯äº‹åŠ¡ç›´æ¥ä½¿ç”¨<code>FOR UPDATE</code> è¿›è¡ŒæŸ¥è¯¢åè¿›è¡Œä¿®æ”¹</p><p>ä¸è¿‡éœ€è¦æ³¨æ„æŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ•°æ®ä¸å­˜åœ¨å¯èƒ½ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œå…·ä½“åŸå› å°†ä¼šåœ¨ä¸‹é¢è¿›è¡Œåˆ†æï¼Œå½“ç„¶ä¸€å¥è¯æ¦‚æ‹¬ä¹Ÿå¾ˆç®€å•ï¼š<code>FOR UPDATE</code>ä¼šä¸Š record é”ï¼Œå¦‚æœæ•°æ®ä¸å­˜åœ¨ record é”ä¼šå˜ä¸º gap é”</p><h2 id="çœŸå®èƒŒæ™¯">çœŸå®èƒŒæ™¯</h2><p>å‹æµ‹ä¸­å‘ç°æ¶‰åŠç§¯åˆ†è¡¨å†™å…¥çš„å“åº”ç‰¹åˆ«æ…¢ï¼Œç”šè‡³è¿˜å­˜åœ¨æ­»é”</p><p>é€»è¾‘æµç¨‹ï¼š</p><ol type="1"><li>å†™é”å®šè¯»å¯¹åº”è¡Œï¼ˆå› ä¸ºéœ€è¦ check ä½™é¢ï¼‰</li><li>æ£€æŸ¥ä½™é¢ï¼Œè®¡ç®—æ›´æ–°å‚æ•°</li><li>æ’å…¥æˆ–è€…æ›´æ–°ï¼ˆä½¿ç”¨<code>INSERT IGNORE ... ON DUPLICATE KEY UPDATE</code> å®ç°ï¼‰</li></ol><p>è¿™æ˜¯ä½¿ç”¨é”å®šè¯»å®¹æ˜“å¿½ç•¥çš„ä¸€ä¸ªç‚¹ï¼Œå³<strong>æœ‰å¯èƒ½ä¸å­˜åœ¨å¯¹åº”è¡Œæ•°æ®ï¼Œå¯¼è‡´é”çš„èŒƒå›´å˜å¤§</strong></p><h2 id="è®°å½•é”å’Œé—´éš™é”">è®°å½•é”å’Œé—´éš™é”</h2><p><strong>è®°å½•é” Record Locks</strong></p><p>è®°å½•é”æ˜¯ç´¢å¼•è®°å½•ä¸Šçš„é”</p><p>ä¾‹å¦‚<code>SELECT c1 FROM t WHERE c1=10 For UPDATEï¼›</code>ï¼›å°†ä¼šé˜»æ­¢ä»»ä½•å…¶ä»–äº‹åŠ¡æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤<code>t.c1</code> å€¼ä¸º <code>10</code> çš„è¡Œ</p><p>è®°å½•é”æ€»æ˜¯é”å®šç´¢å¼•è®°å½•ï¼Œå³ä½¿å®šä¹‰çš„è¡¨æ²¡æœ‰ç´¢å¼•ï¼›è¿™ç§æƒ…å†µ InnoDBä¼šåˆ›å»ºä¸€ä¸ªéšè—çš„èšé›†ç´¢å¼•ï¼Œå¹¶å°†è¯¥ç´¢å¼•ç”¨äºè®°å½•é”å®š</p><p>è®°å½•é”çš„äº‹åŠ¡æ•°æ®åœ¨ SHOW ENGINE INNODB STATUS å’Œ InnoDBç›‘è§†å™¨è¾“å‡ºä¸­æ˜¾ç¤ºå¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">58</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`t`</span><br><span class="line">trx id <span class="number">10078</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8000000</span>a; <span class="keyword">asc</span>     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">00000000274</span>f; <span class="keyword">asc</span>     <span class="string">&#x27;O;;</span></span><br><span class="line"><span class="string"> 2: len 7; hex b60000019d0110; asc        ;;</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>é—´éš™é” Gap Locks</strong></p><p>é—´éš™é”å®šæ˜¯å¯¹ç´¢å¼•è®°å½•ä¹‹é—´é—´éš™çš„é”å®šï¼Œæˆ–å¯¹ç¬¬ä¸€ä¸ªç´¢å¼•è®°å½•ä¹‹å‰ï¼ˆä¸Šç¡®ç•Œï¼‰æˆ–æœ€åä¸€ä¸ªç´¢å¼•è®°å½•ä¹‹åï¼ˆä¸‹ç¡®ç•Œï¼‰é—´éš™çš„é”å®š</p><p>ä¾‹å¦‚<code>SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</code>ï¼›å°†ä¼šé˜²æ­¢å…¶ä»–äº‹åŠ¡å°†å€¼<code>15</code> æ’å…¥åˆ° <code>t.c1</code>åˆ—ä¸­ï¼Œæ— è®ºè¯¥åˆ—ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ä»»ä½•æ­¤ç±»å€¼ï¼Œå› ä¸ºè¯¥èŒƒå›´ä¸­æ‰€æœ‰ç°æœ‰å€¼ä¹‹é—´çš„é—´éš™éƒ½è¢«é”å®š</p><p>é—´éš™å¯èƒ½è·¨è¶Šå•ä¸ªç´¢å¼•å€¼ã€å¤šä¸ªç´¢å¼•å€¼ï¼Œç”šè‡³ä¸ºç©º</p><p>é—´éš™é”åªå­˜åœ¨äºéƒ¨åˆ†éš”ç¦»çº§åˆ«ä¸­</p><p>å¯¹äºå”¯ä¸€ç´¢å¼•å¹¶ä¸”åªæŸ¥è¯¢å”¯ä¸€è¡Œçš„è¯­å¥ï¼Œä¸ä¼šè®¾ç½®é—´éš™é”</p><p>ä¾‹å¦‚ <code>SELECT * FROM child WHERE id = 100;</code>ï¼›ä½†æ˜¯å¦‚æœ idæ²¡æœ‰ç´¢å¼•æˆ–å…·æœ‰éå”¯ä¸€ç´¢å¼•ï¼Œåˆ™è¯¥è¯­å¥ä¼šé”å®šå‰é¢çš„é—´éš™ï¼ˆè¿™é‡Œå°±æ˜¯èƒŒæ™¯é—®é¢˜çš„æ ¹æºï¼‰</p><p><strong>é—´éš™é”çš„å†²çªæ€§</strong></p><p>éœ€è¦æ³¨æ„ä¸åŒçš„äº‹åŠ¡å¯ä»¥åœ¨é—´éš™ä¸ŠæŒæœ‰å†²çªçš„é—´éš™é”ï¼ˆåªæœ‰é—´éš™é”å’Œé—´éš™é”ä¹‹å‰ä¸å†²çªï¼‰</p><p>ä¾‹å¦‚ï¼Œäº‹åŠ¡ A å¯ä»¥åœ¨é—´éš™ä¸Šä¿æŒå…±äº«é—´éš™é”ï¼ˆgap S-lockï¼‰ï¼Œè€Œäº‹åŠ¡ Båœ¨ç›¸åŒé—´éš™ä¸Šä¿æŒç‹¬å é—´éš™é”ï¼ˆgapX-lockï¼‰ï¼›å…è®¸å†²çªçš„é—´éš™é”çš„åŸå› æ˜¯ï¼Œå¦‚æœä»ç´¢å¼•ä¸­åˆ é™¤è®°å½•ï¼Œå¿…é¡»åˆå¹¶ä¸åŒäº‹åŠ¡åœ¨è®°å½•ä¸Šä¿ç•™çš„é—´éš™é”</p><p>InnoDB ä¸­çš„é—´éš™é”æ˜¯â€œçº¯æŠ‘åˆ¶æ€§çš„ï¼ˆpurelyinhibitiveï¼‰â€ï¼Œè¿™æ„å‘³ç€å®ƒä»¬çš„å”¯ä¸€ç›®çš„æ˜¯é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥åˆ°é—´éš™ä¸­ï¼Œæ‰€ä»¥é—´éš™é”å¯ä»¥å…±å­˜</p><p>ä¸€ä¸ªäº‹åŠ¡å ç”¨çš„é—´éš™é”ä¸ä¼šé˜»æ­¢å¦ä¸€ä¸ªäº‹åŠ¡å¯¹åŒä¸€é—´éš™å ç”¨é—´éš™é”ï¼Œå…±äº«å’Œç‹¬å é—´éš™é”ä¹‹é—´æ²¡æœ‰åŒºåˆ«ï¼Œå®ƒä»¬å½¼æ­¤ä¸å†²çªï¼Œå¹¶ä¸”å…·å¤‡ç›¸åŒçš„åŠŸèƒ½</p><h2 id="éªŒè¯---æ™®é€šç´¢å¼•">éªŒè¯ - æ™®é€šç´¢å¼•</h2><p>åˆ›å»º DB å’Œæ’å…¥åŸºæœ¬æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test_key` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `key` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_key` (`key`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test_key`(`key`) <span class="keyword">VALUES</span>(<span class="number">10</span>),(<span class="number">20</span>),(<span class="number">30</span>),(<span class="number">40</span>),(<span class="number">50</span>);</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ <code>performance_schema.data_locks</code>å¯ä»¥è·å–å½“å‰æŒæœ‰é”çš„äº‹åŠ¡åŠé”ç›¸å…³ä¿¡æ¯ï¼ˆæˆ‘ä½¿ç”¨çš„ MySQL ç‰ˆæœ¬ä¸º8.0ï¼Œéœ€è¦æ³¨æ„ä¸åŒç‰ˆæœ¬çš„åŒºåˆ«ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `performance_schema.data_locks`;</span><br></pre></td></tr></table></figure><p>éš”ç¦»çº§åˆ«ä¸º RR</p><p><strong>æŸ¥è¯¢å‘½ä¸­ç´¢å¼•</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test_key` <span class="keyword">WHERE</span> `key` <span class="operator">=</span> <span class="number">30</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­å­˜åœ¨ key = 30 çš„æ•°æ®ï¼ŒæŒæœ‰çš„é”ï¼š</p><ul><li>è¡¨çº§åˆ«çš„<strong>æ’å…¥æ„å‘é”</strong>ï¼ˆ<code>FOR UPDATE</code>å¸¦æ¥ï¼‰</li><li>idx_key 30 ç´¢å¼•ä¸Šçš„<strong>ä¸´é”®é”</strong></li><li>PRIMARY 3 ç´¢å¼•ä¸Šçš„<strong>è®°å½•é”</strong></li><li>RECORD 40 ç´¢å¼•ä¸Šçš„<strong>é—´éš™é”</strong></li></ul><table><thead><tr class="header"><th>INDEX_NAME</th><th>LOCK_TYPE</th><th>LOCK_MODE</th><th>LOCK_DATA</th></tr></thead><tbody><tr class="odd"><td>/</td><td>TABLE</td><td>IX</td><td>/</td></tr><tr class="even"><td>idx_key</td><td>RECORD</td><td>X</td><td>30, 3</td></tr><tr class="odd"><td>PRIMARY</td><td>RECORD</td><td>X,REC_NOT_GAP</td><td>3</td></tr><tr class="even"><td>idx_key</td><td>RECORD</td><td>X,GAP</td><td>40, 4</td></tr></tbody></table><p><strong>æŸ¥è¯¢æœªå‘½ä¸­ç´¢å¼•ï¼Œä½†æœ‰æ›´å¤§çš„ç´¢å¼•</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test_key` <span class="keyword">WHERE</span> `key` <span class="operator">=</span> <span class="number">35</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­ä¸å­˜åœ¨ key = 30 çš„æ•°æ®ï¼Œä½†å­˜åœ¨ key = 40 çš„æ•°æ®ï¼ŒæŒæœ‰çš„é”ï¼š</p><ul><li>è¡¨çº§åˆ«çš„<strong>æ’å…¥æ„å‘é”</strong></li><li>idx_key 40 ç´¢å¼•ä¸Šçš„<strong>é—´éš™é”</strong></li></ul><table><thead><tr class="header"><th>INDEX_NAME</th><th>LOCK_TYPE</th><th>LOCK_MODE</th><th>LOCK_DATA</th></tr></thead><tbody><tr class="odd"><td>/</td><td>TABLE</td><td>IX</td><td>/</td></tr><tr class="even"><td>idx_key</td><td>RECORD</td><td>X,GAP</td><td>40, 4</td></tr></tbody></table><p><strong>æŸ¥è¯¢æœªå‘½ä¸­ç´¢å¼•ï¼Œæ²¡æœ‰æ›´å¤§çš„ç´¢å¼•</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test_key` <span class="keyword">WHERE</span> `key` <span class="operator">=</span> <span class="number">60</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­ä¸å­˜åœ¨ key = 60 çš„æ•°æ®ï¼Œä¸”æ²¡æœ‰æ¯” 60 æ›´å¤§çš„ç´¢å¼•ï¼ŒæŒæœ‰çš„é”ï¼š</p><ul><li>è¡¨çº§åˆ«çš„<strong>æ’å…¥æ„å‘é”</strong></li><li>ä¸Šç¡®ç•Œä¼ªè®°å½•<strong>ä¸´é”®é”</strong></li></ul><table><thead><tr class="header"><th>INDEX_NAME</th><th>LOCK_TYPE</th><th>LOCK_MODE</th><th>LOCK_DATA</th></tr></thead><tbody><tr class="odd"><td>/</td><td>TABLE</td><td>IX</td><td>/</td></tr><tr class="even"><td>idx_key</td><td>RECORD</td><td>X</td><td>supremum pseudo-record</td></tr></tbody></table><h2 id="éªŒè¯---å”¯ä¸€çº¦æŸ">éªŒè¯ - å”¯ä¸€çº¦æŸ</h2><p>åŒç†</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test_uni_key` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `key` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uni_key` (`key`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test_uni_key`(`key`) <span class="keyword">VALUES</span>(<span class="number">10</span>),(<span class="number">20</span>),(<span class="number">30</span>),(<span class="number">40</span>),(<span class="number">50</span>);</span><br></pre></td></tr></table></figure><p><strong>æŸ¥è¯¢å‘½ä¸­ç´¢å¼•</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test_uni_key` <span class="keyword">WHERE</span> `key` <span class="operator">=</span> <span class="number">30</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­å­˜åœ¨ key = 30 çš„æ•°æ®ï¼ŒæŒæœ‰çš„é”ï¼š</p><ul><li>è¡¨çº§åˆ«çš„<strong>æ’å…¥æ„å‘é”</strong></li><li>uni_key 30 ç´¢å¼•ä¸Šçš„<strong>è®°å½•é”</strong></li><li>PRIMARY 3 ç´¢å¼•ä¸Šçš„<strong>è®°å½•é”</strong></li></ul><table><thead><tr class="header"><th>INDEX_NAME</th><th>LOCK_TYPE</th><th>LOCK_MODE</th><th>LOCK_DATA</th></tr></thead><tbody><tr class="odd"><td>/</td><td>TABLE</td><td>IX</td><td>/</td></tr><tr class="even"><td>idx_key</td><td>RECORD</td><td>X,REC_NOT_GAP</td><td>30, 3</td></tr><tr class="odd"><td>PRIMARY</td><td>RECORD</td><td>X,REC_NOT_GAP</td><td>3</td></tr></tbody></table><p><strong>æŸ¥è¯¢æœªå‘½ä¸­ç´¢å¼•ï¼Œä½†æœ‰æ›´å¤§çš„ç´¢å¼•</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test_uni_key` <span class="keyword">WHERE</span> `key` <span class="operator">=</span> <span class="number">35</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­ä¸å­˜åœ¨ key = 30 çš„æ•°æ®ï¼Œä½†å­˜åœ¨ key = 40 çš„æ•°æ®ï¼ŒæŒæœ‰çš„é”ï¼š</p><ul><li>è¡¨çº§åˆ«çš„<strong>æ’å…¥æ„å‘é”</strong></li><li>uni_key 40 ç´¢å¼•ä¸Šçš„<strong>é—´éš™é”</strong></li></ul><table><thead><tr class="header"><th>INDEX_NAME</th><th>LOCK_TYPE</th><th>LOCK_MODE</th><th>LOCK_DATA</th></tr></thead><tbody><tr class="odd"><td>/</td><td>TABLE</td><td>IX</td><td>/</td></tr><tr class="even"><td>uni_key</td><td>RECORD</td><td>X,GAP</td><td>40, 4</td></tr></tbody></table><p><strong>æŸ¥è¯¢æœªå‘½ä¸­ç´¢å¼•ï¼Œæ²¡æœ‰æ›´å¤§çš„ç´¢å¼•</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test_uni_key` <span class="keyword">WHERE</span> `key` <span class="operator">=</span> <span class="number">60</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­ä¸å­˜åœ¨ key = 60 çš„æ•°æ®ï¼Œä¸”æ²¡æœ‰æ¯” 60 æ›´å¤§çš„ç´¢å¼•ï¼ŒæŒæœ‰çš„é”ï¼š</p><ul><li>è¡¨çº§åˆ«çš„<strong>æ’å…¥æ„å‘é”</strong></li><li>ä¸Šç¡®ç•Œä¼ªè®°å½•<strong>ä¸´é”®é”</strong></li></ul><table><thead><tr class="header"><th>INDEX_NAME</th><th>LOCK_TYPE</th><th>LOCK_MODE</th><th>LOCK_DATA</th></tr></thead><tbody><tr class="odd"><td>/</td><td>TABLE</td><td>IX</td><td>/</td></tr><tr class="even"><td>uni_key</td><td>RECORD</td><td>X</td><td>supremum pseudo-record</td></tr></tbody></table><h2 id="æ€»ç»“">æ€»ç»“</h2><p>ä»éªŒè¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ™®é€šç´¢å¼•å’Œå”¯ä¸€çº¦æŸç´¢å¼•çš„åŒºåˆ«åœ¨äºå¯¹äºå­˜åœ¨çš„æ•°æ®ï¼Œæ™®é€šç´¢å¼•å¤šäº†<strong>ç´¢å¼•è®°å½•çš„ä¸´é”®é”</strong>å’Œ<strong>ç´¢å¼•è®°å½•ä¸‹ä¸ªèŒƒå›´çš„é—´éš™é”</strong>ï¼›è¿™æ˜¯å› ä¸ºæ²¡æœ‰äº†å”¯ä¸€çº¦æŸï¼ŒåŒå€¼æ•°æ®å¯èƒ½å­˜åœ¨å¤šè¡Œï¼Œä¾‹å¦‚<code>key = 30</code>çš„æ•°æ®å¯èƒ½åœ¨å…¶ä»–äº‹åŠ¡ä¸­è¢«æ’å…¥æœ€ç»ˆé€ æˆå¹»è¯»ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤šçš„é”æ¥ä¿è¯</p><p>æ­¤å¤–å¯ä»¥çœ‹å‡ºå¯¼è‡´ä¸è§„èŒƒä½¿ç”¨ <code>FOR UPDATE</code>ä¸¥é‡å½±å“æ•ˆç‡çš„æ ¸å¿ƒåŸå› ï¼Œ<code>supremum pseudo-record</code>çš„<strong>ä¸´é”®é”</strong>æˆ–ä¸‹ä¸€ä¸ªç´¢å¼•èŒƒå›´çš„<strong>é—´éš™é”</strong>ï¼Œå¯èƒ½ä¼šé”ä½è¡¨ä¸­å¤§ç‰‡åŒºåŸŸå¯¼è‡´å¹¶å‘ä¸‹é™ã€çº¿ç¨‹ç­‰å¾…</p><h2 id="æ”¹è¿›">æ”¹è¿›</h2><ul><li>ä¸šåŠ¡ä¸­æ˜¯å¦å¯ä»¥æå‰å†™å…¥æ•°æ®ï¼Œé¿å… <code>FOR UPDATE</code>æ“ä½œæ‰¾ä¸åˆ°ç´¢å¼•è€Œå‡çº§ä¸ºé—´éš™é”ç”šè‡³é”ä½ä¸Šç¡®ç•Œ</li><li>å¿…è¦æ—¶å¯ä»¥ä½¿ç”¨å…¶ä»–æ•ˆç‡æ›´é«˜ã€æ›´è½»é‡çš„é”å®ç°ä»£æ›¿ï¼Œä¾‹å¦‚ä½¿ç”¨ Redisé”</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://dev.mysql.com/doc/refman/5.7/en/select.html">MySQL:: MySQL 5.7 Reference Manual :: 13.2.9 SELECT Statement</a></p><p><ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-reads.html">MySQL:: MySQL 5.7 Reference Manual :: 14.7.2.4 Locking Reads</a></p><p><ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-record-locks">MySQL:: MySQL 5.7 Reference Manual :: 14.7.1 InnoDB Locking</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DB </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 5.7 å®˜æ–¹æ–‡æ¡£ - InnoDB å¼•æ“.md</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%205.7%20%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%20-%20InnoDB%20%E5%BC%95%E6%93%8E.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/MySQL/MySQL%205.7%20%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%20-%20InnoDB%20%E5%BC%95%E6%93%8E.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p>æ‘˜è‡ª MySQL 5.7 å®˜æ–¹æ–‡æ¡£ 14 ç«  <em>The InnoDB Storage Engine</em> ä¸‹çš„<em>InnoDB Locking and Transaction Model</em></p><p>ä¸»è¦å†…å®¹ä¸º InnoDB å¼•æ“ä¸‹çš„é”æœºåˆ¶å’Œäº‹åŠ¡æ¨¡å‹</p><p><ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-transaction-model.html">MySQL:: MySQL 5.7 Reference Manual :: 14.7 InnoDB Locking and TransactionModel</a></p><h1 id="innodb-çš„é”æœºåˆ¶å’Œäº‹åŠ¡æ¨¡å‹">InnoDB çš„é”æœºåˆ¶å’Œäº‹åŠ¡æ¨¡å‹</h1><p>è¦å®ç°å¤§è§„æ¨¡ï¼ˆlarge-scaleï¼‰ã€ç¹å¿™æˆ–é«˜å¯ç”¨ï¼ˆhighlyreliableï¼‰çš„æ•°æ®åº“åº”ç”¨ç¨‹åºã€ä»ä¸åŒçš„æ•°æ®åº“ç³»ç»Ÿç§»æ¤å¤§é‡ä»£ç ï¼Œæˆ–è°ƒæ•´ MySQLæ€§èƒ½ï¼Œäº†è§£ InnoDB é”å®šå’Œ InnoDB äº‹åŠ¡æ¨¡å‹æ˜¯å¾ˆé‡è¦çš„ã€‚</p><p>æœ¬èŠ‚è®¨è®ºäº†ä¸ InnoDB é”æœºåˆ¶å’Œæ‚¨åº”è¯¥ç†Ÿæ‚‰çš„ InnoDBäº‹åŠ¡æ¨¡å‹ç›¸å…³çš„å‡ ä¸ªä¸»é¢˜</p><ul><li>14.7.1 - InnoDB çš„é”æœºåˆ¶</li><li>14.7.2 - InnoDB çš„äº‹åŠ¡æ¨¡å‹</li><li>14.7.3 - InnoDB ä¸­ä¸åŒ SQL è¯­å¥è®¾ç½®çš„é”</li><li>14.7.4 - å¹»å½±è¡Œ</li><li>14.7.5 - InnoDB ä¸­çš„æ­»é”</li></ul><h2 id="innodb-çš„é”æœºåˆ¶">InnoDB çš„é”æœºåˆ¶</h2><h3 id="å…±äº«é”-æ’å®ƒé”">å…±äº«é” &amp; æ’å®ƒé”</h3><p>InnoDB å®ç°äº†æ ‡å‡†çš„è¡Œçº§é”ï¼Œæœ‰ä¸¤ç§ç±»å‹ï¼š<strong>å…±äº«é”S</strong>ï¼ˆshared locksï¼‰å’Œ<strong>æ’ä»–é” X</strong>ï¼ˆexclusivelocksï¼‰</p><ul><li>å…±äº«é”ï¼šå…è®¸äº‹åŠ¡è¯»å–ä¸€è¡Œ</li><li>æ’ä»–é”ï¼šå…è®¸äº‹åŠ¡æ›´æ–°æˆ–åˆ é™¤ä¸€è¡Œ</li></ul><p>å¦‚æœäº‹åŠ¡ T1 å¯¹æ•°æ®è¡Œ r æŒæœ‰ S é”ï¼Œåˆ™å¦‚ä¸‹å¤„ç†æ¥è‡ªæŸä¸ªä¸åŒäº‹åŠ¡ T2çš„å¯¹æ•°æ®è¡Œ r çš„é”çš„è¯·æ±‚ï¼š</p><ul><li>ç«‹å³å¯¹ T2 ç­¾å‘ S é”ï¼›æ­¤æ—¶ T1 å’Œ T2 éƒ½æŒæœ‰å¯¹ r çš„ S é”</li><li>ä¸ä¼šç«‹å³å¯¹ T2 ç­¾å‘ X é”</li></ul><p>å¦‚æœ T1 æŒæœ‰çš„æ˜¯ X é”ï¼Œé‚£ä¹ˆ T2 å¯¹ä»»æ„ç±»å‹çš„é”éƒ½ä¸ä¼šè¢«ç«‹å³ç­¾å‘ï¼Œç›¸åT2 åªèƒ½ç­‰å¾… T1 é‡Šæ”¾å®ƒé’ˆå¯¹ r çš„é”</p><h3 id="æ„å‘é”">æ„å‘é”</h3><p>InnoDB æ”¯æŒå¤šç²’åº¦é”ï¼ˆmultiple granularitylockingï¼‰ï¼Œå…è®¸è¡Œé”å’Œè¡¨é”å…±å­˜ï¼›ä¸¾ä¸€ä¸ªä¾‹å­ï¼ŒSQL<code>LOCK TABLE ... WRITE</code> ä¼šè·å–ä¸€ä¸ªæ’ä»–é”ï¼ˆXé”ï¼‰å¯¹äºè¯¥æŒ‡å®šçš„è¡¨ï¼›ä¸ºäº†ä½¿å¤šç²’åº¦çº§åˆ«çš„é”å®šå˜å¾—å®ç”¨ï¼ŒInnoDBä½¿ç”¨äº†æ„å‘é”ï¼Œæ„å‘é”æ˜¯è¡¨çº§é”ï¼Œç”¨äºæŒ‡ç¤ºäº‹åŠ¡ç¨åéœ€è¦è¡¨ä¸­æŸè¡Œä½¿ç”¨å“ªç§ç±»å‹çš„é”ï¼ˆå…±äº«æˆ–æ’ä»–ï¼‰ï¼Œæ„å‘é”æœ‰ä¸¤ç§ç±»å‹ï¼š</p><ul><li>æ„å‘å…±äº«é”ï¼ˆISï¼‰è¡¨ç¤ºäº‹åŠ¡æ„å›¾é’ˆå¯¹è¡¨ä¸­çš„æ•°æ®è¡Œè®¾ç½®å…±äº«é”</li><li>æ„å‘æ’ä»–é”ï¼ˆIXï¼‰è¡¨ç¤ºäº‹åŠ¡æ„å›¾é’ˆå¯¹è¡¨ä¸­çš„æ•°æ®è¡Œè®¾ç½®æ’ä»–é”</li></ul><p>ä¾‹å¦‚ï¼Œ<code>SELECT ... LOCK IN SHARE MODE</code> è®¾ç½® IS é”ï¼Œè€Œ<code>SELECT ... FOR UPDATE</code> è®¾ç½®æ’ä»–é”</p><p>æ„å‘é”å®šåè®®å¦‚ä¸‹ï¼š</p><ul><li>åœ¨äº‹åŠ¡å¯ä»¥è·å–è¡¨ä¸­æŸè¡Œçš„å…±äº«é”ä¹‹å‰ï¼Œå®ƒå¿…é¡»é¦–å…ˆè·å–è¡¨ä¸Šçš„ ISé”æˆ–æ›´å¼ºçš„é”</li><li>åœ¨äº‹åŠ¡å¯ä»¥è·å–è¡¨ä¸­æŸè¡Œçš„æ’ä»–é”ä¹‹å‰ï¼Œå®ƒå¿…é¡»é¦–å…ˆè·å–è¡¨ä¸Šçš„ IX é”</li></ul><p>è¡¨çº§é”ç±»å‹å…¼å®¹æ€§æ€»ç»“å¦‚ä¸‹è¡¨æ‰€ç¤º</p><table><thead><tr class="header"><th style="text-align: center;"></th><th style="text-align: center;">X</th><th style="text-align: center;">IX</th><th style="text-align: center;">S</th><th style="text-align: center;">IS</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">X</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Conflict</td></tr><tr class="even"><td style="text-align: center;">IX</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Compatible</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Compatible</td></tr><tr class="odd"><td style="text-align: center;">S</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Compatible</td><td style="text-align: center;">Compatible</td></tr><tr class="even"><td style="text-align: center;">IS</td><td style="text-align: center;">Conflict</td><td style="text-align: center;">Compatible</td><td style="text-align: center;">Compatible</td><td style="text-align: center;">Compatible</td></tr></tbody></table><p>å¦‚æœè¯·æ±‚äº‹åŠ¡ä¸ç°æœ‰é”å…¼å®¹ï¼Œåˆ™ä¼šå°†é”æˆäºˆè¯¥äº‹åŠ¡ï¼Œä½†å¦‚æœå®ƒä¸ç°æœ‰é”å†²çªï¼Œåˆ™ä¸ä¼šæˆäºˆè¯¥äº‹åŠ¡ï¼›äº‹åŠ¡å°†ä¼šç­‰å¾…ç›´åˆ°å¯¼è‡´å†²çªçš„é”è¢«é‡Šæ”¾ï¼›å¦‚æœé”è¯·æ±‚ä¸ç°æœ‰é”å†²çªï¼Œå¹¶ä¸”ç”±äºä¼šå¯¼è‡´æ­»é”è€Œæ— æ³•æˆäºˆï¼Œåˆ™ä¼šå‘ç”Ÿé”™è¯¯</p><p>æ„å‘é”ä¸ä¼šé˜»å¡é™¤å…¨è¡¨è¯·æ±‚ä¹‹å¤–çš„ä»»ä½•å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œ<code>LOCK TABLESâ€¦WRITE</code>ï¼‰ï¼Œæ„å‘é”çš„ä¸»è¦ç›®çš„æ˜¯æ˜¾ç¤ºæœ‰äººæ­£åœ¨é”å®šä¸€è¡Œï¼Œæˆ–è€…è¦é”å®šè¡¨ä¸­çš„ä¸€è¡Œï¼ˆå³è¡¨è¾¾æ„å›¾ï¼‰</p><p>åœ¨ <code>SHOW ENGINE INNODB STATUS</code> å’Œ InnoDB monitorè¾“å‡ºä¸­ï¼Œæ„å‘é”çš„äº‹åŠ¡æ•°æ®ä¸ä»¥ä¸‹å†…å®¹ç±»ä¼¼ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TABLE</span> LOCK <span class="keyword">table</span> `test`.`t` trx id <span class="number">10080</span> lock mode IX</span><br></pre></td></tr></table></figure><h3 id="è®°å½•é”">è®°å½•é”</h3><p>è®°å½•é”ç”¨äºé”ä½ä¸€æ¡ç´¢å¼•è®°å½•ï¼Œä¸¾ä¸€ä¸ªä¾‹å­<code>SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE;</code>è·å–çš„é”å°†é˜²æ­¢ä»»ä½•å…¶ä»–çš„äº‹åŠ¡å¯¹ <code>t.c1 = 10</code>çš„è¡Œè®°å½•è¿›è¡Œæ’å…¥ã€æ›´æ–°ã€åˆ é™¤</p><p>è®°å½•é”æ€»æ˜¯é”å®šç´¢å¼•è®°å½•ï¼Œå³ä½¿æ˜¯æ²¡æœ‰ç´¢å¼•çš„è¡¨ï¼ŒInnoDBä¼šåˆ›å»ºéšå¼çš„èšé›†ç´¢å¼•ï¼ˆhidden clusteredindexï¼‰ç„¶åä½¿ç”¨è¯¥ç´¢å¼•æ¥è¿›è¡Œè®°å½•ä¸Šé”</p><p>åœ¨ <code>SHOW ENGINE INNODB STATUS</code> å’Œ InnoDB monitorè¾“å‡ºä¸­ï¼Œè®°å½•é”çš„äº‹åŠ¡æ•°æ®ä¸ä»¥ä¸‹å†…å®¹ç±»ä¼¼ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">58</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`t`</span><br><span class="line">trx id <span class="number">10078</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8000000</span>a; <span class="keyword">asc</span>     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">00000000274</span>f; <span class="keyword">asc</span>     <span class="string">&#x27;O;;</span></span><br><span class="line"><span class="string"> 2: len 7; hex b60000019d0110; asc        ;;</span></span><br></pre></td></tr></table></figure><h3 id="é—´éš™é”">é—´éš™é”</h3><p>ä¸€ä¸ªé—´éš™é”é”ä½çš„æ˜¯ç´¢å¼•è®°å½•ä¹‹é—´çš„èŒƒå›´ï¼Œæˆ–è€…é”å®šç¬¬ä¸€ä¸ªç´¢å¼•è®°å½•ä¹‹å‰æˆ–è€…æœ€åä¸€ä¸ªç´¢å¼•è®°å½•ä¹‹åçš„èŒƒå›´</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>SELECT c1 FROM t1 WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</code>ï¼Œå°†ä¼šé˜²æ­¢å…¶ä»–äº‹åŠ¡å°†value ä¸º 15 çš„æ•°æ®æ’å…¥t.c1ï¼Œæ— è®ºè¿™ä¸€åˆ—æ˜¯å¦å·²ç»å­˜åœ¨è¯¥å€¼ï¼Œå› ä¸ºè¯¥èŒƒå›´ä¸­çš„æ‰€æœ‰å€¼éƒ½è¢«é”å®šäº†</p><p>é—´éš™å¯èƒ½è·¨è¶Šå•ä¸ªç´¢å¼•å€¼ã€å¤šä¸ªç´¢å¼•å€¼ï¼Œç”šè‡³ä¸ºç©º</p><p>é—´éš™é”æ˜¯æ€§èƒ½å’Œå¹¶å‘ä¹‹é—´æƒè¡¡çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæŸäº›äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸­</p><p><strong>é—´éš™é”ä¸å”¯ä¸€ç´¢å¼•</strong></p><p>é—´éš™é”åœ¨å¯¹äºä½¿ç”¨å”¯ä¸€ç´¢å¼•æŸ¥è¯¢ä¸€è¡Œæ•°æ®çš„æƒ…å†µä¸‹ä¸ä¼šåŠ é”ï¼ˆä¸åŒ…æ‹¬ç»„åˆå”¯ä¸€ç´¢å¼•ï¼Œåªåœ¨æŸ¥è¯¢æ¡ä»¶ä¸­è¦†ç›–äº†éƒ¨åˆ†å­—æ®µçš„æƒ…å†µï¼‰</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœå­—æ®µ <code>id</code> æ˜¯ä¸€ä¸ªå”¯ä¸€ç´¢å¼•ï¼Œä»¥ä¸‹è¯­å¥ä»…å¯¹<code>id</code> ä¸º 100 çš„è¡Œä½¿ç”¨ç´¢å¼•è®°å½•é”ï¼Œå¹¶ä¸”å…¶ä»–ä¼šè¯æ˜¯å¦åœ¨ id = 100å‰é¢çš„é—´éš™ä¸­æ’å…¥è¡Œå¹¶ä¸é‡è¦ï¼š<code>SELECT * FROM child WHERE id = 100;</code></p><p>å¦‚æœ <code>id</code>æ²¡æœ‰ç´¢å¼•æˆ–è€…ä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œåˆ™è¯¥è¯­å¥ä¼šé”ä½å‰é¢çš„é—´éš™</p><p><strong>é—´éš™é”ä¸äº’æ–¥</strong></p><p>è¿™é‡ŒåŒæ—¶éœ€è¦æ³¨æ„ï¼Œ<strong>ä¸åŒçš„äº‹åŠ¡å¯èƒ½åŒæ—¶æŒæœ‰äº’ç›¸å†²çªçš„é—´éš™é”</strong></p><p>ä¸¾ä¸ªä¾‹å­ï¼Œäº‹åŠ¡ A å¯ä»¥æŒæœ‰ä¸€ä¸ªå…±äº«é—´éš™é”ï¼ˆgap S-lockï¼‰ï¼Œè€Œäº‹åŠ¡ BæŒæœ‰ä¸€ä¸ªç›¸åŒèŒƒå›´çš„æ’ä»–é—´éš™é”ï¼ˆgapX-lockï¼‰ï¼Œå…è®¸é—´éš™é”å†²çªçš„åŸå› æ˜¯å¦‚æœä»ç´¢å¼•ä¸­æ¸…é™¤è®°å½•ï¼Œåˆ™å¿…é¡»åˆå¹¶ä¸åŒäº‹åŠ¡åœ¨è®°å½•ä¸ŠæŒæœ‰çš„é—´éš™é”</p><p>InnoDB ä¸­çš„é—´éš™é”çš„åŠŸèƒ½æ˜¯ â€œçº¯ç²¹ç¦æ­¢â€ï¼ˆpurelyinhibitiveï¼‰ï¼Œè¿™æ„å‘³ç€å®ƒä»¬çš„å”¯ä¸€ç›®çš„æ˜¯é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥åˆ°é”å®šçš„èŒƒå›´ä¸­ï¼Œæ‰€ä»¥é—´éš™é”å¯ä»¥å…±å­˜ï¼›ä¸€ä¸ªäº‹åŠ¡è·å–çš„é—´éš™é”å®šä¸ä¼šé˜»æ­¢å¦ä¸€ä¸ªäº‹åŠ¡å¯¹åŒä¸€é—´éš™è·å–é—´éš™é”å®šï¼›å…±äº«å’Œæ’ä»–é—´éš™é”ä¹‹é—´æ²¡æœ‰åŒºåˆ«ï¼Œå®ƒä»¬å½¼æ­¤ä¸å†²çªï¼Œå¹¶ä¸”æ‰§è¡Œç›¸åŒçš„åŠŸèƒ½</p><p><strong>ç¦ç”¨é—´éš™é”</strong></p><p>é—´éš™é”å®šå¯ä»¥æ˜ç¡®ç¦ç”¨ï¼Œå¦‚æœå°†äº‹åŠ¡éš”ç¦»çº§åˆ«æ›´æ”¹ä¸º READ COMMITTED æˆ–å¯ç”¨<code>innodb_locks_unsaf_for_binlog</code>ç³»ç»Ÿå˜é‡ï¼ˆç°å·²åºŸå¼ƒï¼‰å³å¯ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé—´éš™é”å¯¹äºæŸ¥è¯¢å’Œç´¢å¼•æ‰«ææ˜¯ç¦ç”¨çš„ï¼Œä»…ç”¨äºå¤–é”®çº¦æŸæ£€æŸ¥å’Œå”¯ä¸€é”®æ£€æŸ¥</p><p>ä½¿ç”¨ READ COMMITTED éš”ç¦»çº§åˆ«æˆ–å¯ç”¨<code>innodb_locks_unsaf_for_binlog</code> ä¹Ÿä¼šäº§ç”Ÿå…¶ä»–å½±å“</p><ul><li>MySQL è¯„ä¼° WHERE æ¡ä»¶åï¼Œå°†é‡Šæ”¾ä¸åŒ¹é…è¡Œçš„è®°å½•é”</li><li>å¯¹äº UPDATE è¯­å¥ï¼ŒInnoDB ä¼šè¿›è¡Œ semi-consistentè¯»å–ï¼Œä»è€Œå°†æœ€æ–°æäº¤çš„ç‰ˆæœ¬è¿”å›ç»™ MySQLï¼Œä»¥ä¾¿MySQL å¯ä»¥ç¡®å®šè¯¥è¡Œæ˜¯å¦ç¬¦åˆUPDATE çš„ WHERE æ¡ä»¶</li></ul><h3 id="ä¸´é”®é”">ä¸´é”®é”</h3><p>ä¸´é”®é”æ˜¯å½“å‰ç´¢å¼•è®°å½•çš„<strong>è®°å½•é”</strong>å’Œè¯¥è®°å½•ä¹‹å‰èŒƒå›´çš„<strong>é—´éš™é”</strong>çš„ç»„åˆ</p><p>InnoDBçš„è¡Œçº§é”å®ç°å½“è¿›è¡ŒæŸ¥è¯¢æˆ–è€…å¯¹ç´¢å¼•è¿›è¡Œæ‰«æï¼Œæ˜¯è¿™æ ·æ¥è¿›è¡ŒåŠ é”æ“ä½œï¼šé¦–å…ˆå¯¹äºæ‰«æçš„ç´¢å¼•è¡Œè®¾ç½®å…±äº«æˆ–è€…æ’ä»–é”ï¼Œå› æ­¤è¡Œçº§é”å®é™…ä¸Šæ˜¯ç´¢å¼•è®°å½•é”ï¼›ä¸€ä¸ªé”ä½ç´¢å¼•è¡Œçš„ä¸´é”®é”åŒæ ·ä¼š<strong>å½±å“ç´¢å¼•è®°å½•ä¹‹å‰çš„åŒºé—´</strong></p><p>å¦‚æœä¸€ä¸ªä¼šè¯å¯¹ç´¢å¼•ä¸­çš„è®°å½• Rå…·æœ‰å…±äº«æˆ–æ’ä»–é”å®šï¼Œåˆ™å¦ä¸€ä¸ªä¼šè¯å°†æ— æ³•åœ¨ç´¢å¼•é¡ºåºä¸­ Rä¹‹å‰çš„é—´éš™ä¸­æ’å…¥æ–°çš„ç´¢å¼•è®°å½•</p><p>å‡è®¾ä¸€ä¸ªç´¢å¼•åŒ…å«å€¼ 10ã€11ã€13 å’Œ20ï¼Œæ­¤ç´¢å¼•å¯èƒ½çš„ä¸‹ä¸€ä¸ªé”®é”å®šæ¶µç›–ä»¥ä¸‹åŒºé—´ï¼Œå…¶ä¸­åœ†æ‹¬å·è¡¨ç¤ºæ’é™¤åŒºé—´ç«¯ç‚¹ï¼Œæ–¹æ‹¬å·è¡¨ç¤ºåŒ…å«ç«¯ç‚¹ï¼ˆå¼€åŒºé—´é—­åŒºé—´ï¼‰ï¼š</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(negative <span class="literal">infinity</span>, <span class="number">10</span>]</span><br><span class="line">(<span class="number">10</span>, <span class="number">11</span>]</span><br><span class="line">(<span class="number">11</span>, <span class="number">13</span>]</span><br><span class="line">(<span class="number">13</span>, <span class="number">20</span>]</span><br><span class="line">(<span class="number">20</span>, positive <span class="literal">infinity</span>)</span><br></pre></td></tr></table></figure><p>å¯¹äºæœ€åä¸€ä¸ªé—´éš”ï¼Œä¸´é”®é”é”å®šç´¢å¼•ä¸­æœ€å¤§å€¼ä¸Šæ–¹çš„é—´éš™ï¼Œä»¥åŠå€¼é«˜äºç´¢å¼•ä¸­å®é™…ä»»ä½•å€¼çš„â€œä¸Šç¡®ç•Œâ€ ä¼ªè®°å½•ï¼ˆâ€œsupremumâ€pseudo-recordï¼‰ï¼Œä¸Šç¡®ç•Œå¹¶ä¸æ˜¯çœŸå®çš„ç´¢å¼•è®°å½•ï¼Œæ‰€ä»¥å®é™…ä¸Šï¼Œä¸´é”®é”åªé”å®šäº†æœ€å¤§ç´¢å¼•å€¼åé¢çš„é—´éš™</p><p>InnoDB é»˜è®¤çš„éš”ç¦»çº§åˆ«ä¸º REPEATABLE READï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ InnoDBä¼šåœ¨æŸ¥è¯¢æˆ–è€…æ‰«æç´¢å¼•æ—¶ä½¿ç”¨ä¸´é”®é”æ¥é˜²æ­¢å‡ºç°å¹»å½±è¡Œ</p><p>ä¸´é”®é”é”çš„äº‹åŠ¡æ•°æ®åœ¨ <code>SHOW ENGINE INNODB STATUS</code> å’Œ InnoDBmonitor è¾“å‡ºä¸­æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">58</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`t`</span><br><span class="line">trx id <span class="number">10080</span> lock_mode X</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; <span class="keyword">asc</span> supremum;;</span><br><span class="line"></span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8000000</span>a; <span class="keyword">asc</span>     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">00000000274</span>f; <span class="keyword">asc</span>     <span class="string">&#x27;O;;</span></span><br><span class="line"><span class="string"> 2: len 7; hex b60000019d0110; asc        ;;</span></span><br></pre></td></tr></table></figure><h3 id="æ’å…¥æ„å‘é”">æ’å…¥æ„å‘é”</h3><p>æ’å…¥æ„å‘é”æ˜¯åœ¨æ’å…¥è¡Œä¹‹å‰ç”± INSERT æ“ä½œè®¾ç½®çš„ä¸€ç§é—´éš™é”</p><p>è¯¥é”ä»¥è¿™æ ·ä¸€ç§æ–¹å¼å‘å‡ºæ’å…¥æ„å›¾çš„ä¿¡å·ï¼Œå³å¦‚æœæ’å…¥åˆ°åŒä¸€ç´¢å¼•é—´éš™çš„å¤šä¸ªäº‹åŠ¡ä¸åœ¨é—´éš™å†…çš„åŒä¸€ä½ç½®æ’å…¥ï¼Œåˆ™ä¸éœ€è¦ç­‰å¾…å½¼æ­¤ï¼›ä¸¾ä¸ªä¾‹å­ï¼Œå­˜åœ¨ç´¢å¼•è¡Œvalue ä¸º 4 å’Œ 7ï¼Œç‹¬ç«‹çš„äº‹åŠ¡æ‰“ç®—æŸ¥è¯¢ value 5 å’Œ6ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä¼šåœ¨è·å¾—æ’å…¥è¡Œä¸Šçš„æ’ä»–é”å®šä¹‹å‰ç”¨æ’å…¥æ„å‘é”å®šæ¥é”å®š 4 å’Œ 7ä¹‹é—´çš„é—´éš™ï¼Œä½†æ˜¯å¹¶ä¸ä¼šäº’ç›¸é˜»å¡ï¼Œå› ä¸ºæ’å…¥çš„è¡Œæ˜¯ä¸å†²çªçš„</p><p>ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªäº‹åŠ¡ï¼Œè¯¥äº‹åŠ¡åœ¨è·å¾—æ’å…¥è®°å½•çš„ç‹¬å é”ä¹‹å‰ä½¿ç”¨æ’å…¥æ„å‘é”ï¼Œè¯¥ç¤ºä¾‹æ¶‰åŠä¸¤ä¸ªå®¢æˆ·ç«¯ï¼ŒAå’Œ B</p><ol type="1"><li><p>å®¢æˆ·ç«¯ A åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªç´¢å¼•è®°å½•ï¼ˆ90 å’Œ102ï¼‰çš„è¡¨ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¯¹ ID å¤§äº 100çš„ç´¢å¼•è®°å½•è¿›è¡Œæ’ä»–é”å®šï¼Œæ’ä»–æ€§é”å®šåŒ…æ‹¬è®°å½• 102 ä¹‹å‰çš„é—´éš™é”å®šï¼š<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child (id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="keyword">PRIMARY</span> KEY(id)) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child (id) <span class="keyword">values</span> (<span class="number">90</span>),(<span class="number">102</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">100</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br></pre></td></tr></table></figure></p></li><li><p>å®¢æˆ·ç«¯ Bå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå°†ä¸€æ¡è®°å½•æ’å…¥åˆ°é—´éš™ä¸­ï¼Œäº‹åŠ¡åœ¨ç­‰å¾…è·å¾—æ’ä»–é”çš„åŒæ—¶è·å¾—æ’å…¥æ„å‘é”<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child (id) <span class="keyword">VALUES</span> (<span class="number">101</span>);</span><br></pre></td></tr></table></figure></p></li></ol><p>æ’å…¥æ„å‘é”çš„äº‹åŠ¡æ•°æ®åœ¨ <code>SHOW ENGINE INNODB STATUS</code> å’ŒInnoDB monitor è¾“å‡ºä¸­æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">31</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`child`</span><br><span class="line">trx id <span class="number">8731</span> lock_mode X locks gap before rec <span class="keyword">insert</span> intention waiting</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">80000066</span>; <span class="keyword">asc</span>    f;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">000000002215</span>; <span class="keyword">asc</span>     &quot; ;;</span><br><span class="line"> 2: len 7; hex 9000000172011c; asc     r  ;;...</span><br></pre></td></tr></table></figure><h3 id="è‡ªå¢é”">è‡ªå¢é”</h3><p>è‡ªå¢é”æ˜¯ç‰¹æ®Šçš„è¡¨çº§é”ï¼Œå½“äº‹åŠ¡åœ¨è¡¨ä¸­æ’å…¥ <code>AUTO_INCREMENT</code>åˆ—æ—¶å°†ä¼šè·å–</p><p>åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å‘è¡¨ä¸­æ’å…¥å€¼ï¼Œé‚£ä¹ˆä»»ä½•å…¶ä»–äº‹åŠ¡éƒ½å¿…é¡»ç­‰å¾…è‡ªå·±å‘è¯¥è¡¨ä¸­æ’å…¥ï¼Œä»¥ä¾¿ç¬¬ä¸€ä¸ªäº‹åŠ¡æ’å…¥çš„è¡Œæ¥æ”¶è¿ç»­çš„ä¸»é”®å€¼</p><p><code>innodb_autoinc_lock_mode</code>å˜é‡æ§åˆ¶ç”¨äºè‡ªåŠ¨å¢é‡é”å®šçš„ç®—æ³•ï¼Œå®ƒå…è®¸æ‚¨é€‰æ‹©å¦‚ä½•åœ¨å¯é¢„æµ‹çš„è‡ªåŠ¨å¢é‡å€¼åºåˆ—å’Œæ’å…¥æ“ä½œçš„æœ€å¤§å¹¶å‘æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡</p><h3 id="ç©ºé—´ç´¢å¼•çš„è°“è¯é”">ç©ºé—´ç´¢å¼•çš„è°“è¯é”</h3><p>InnoDB æ”¯æŒä»¥ç©ºé—´æ•°æ®ï¼ˆspatial dataï¼‰ä¸ºåˆ—çš„ <code>SPATIAL</code>ç´¢å¼•</p><p>ä¸ºäº†å¤„ç†æ¶‰åŠ SPATIAL ç´¢å¼•çš„æ“ä½œçš„é”å®šï¼Œä¸´é”®é”ä¸èƒ½å¾ˆå¥½åœ°æ”¯æŒREPEATABLE READ æˆ– SERIALIZABLEäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå› ä¸ºå¤šç»´æ•°æ®ä¸­æ²¡æœ‰ç»å¯¹çš„æ’åºæ¦‚å¿µï¼Œå› æ­¤ä¸æ¸…æ¥šå“ªä¸ªæ˜¯â€œä¸‹ä¸€ä¸ªâ€ é”®</p><p>ä¸ºäº†æ”¯æŒå…·æœ‰ <code>SPATIAL</code> ç´¢å¼•çš„è¡¨çš„éš”ç¦»çº§åˆ«ï¼ŒInnoDBä½¿ç”¨äº†è°“è¯é”ï¼ˆpredicate locksï¼‰ï¼›<code>SPATIAL</code>ç´¢å¼•åŒ…å«æœ€å°è¾¹ç•ŒçŸ©å½¢ï¼ˆMBRï¼‰å€¼ï¼Œå› æ­¤ InnoDB é€šè¿‡åœ¨ç”¨äºæŸ¥è¯¢çš„ MBRå€¼ä¸Šè®¾ç½®è°“è¯é”æ¥å¼ºåˆ¶å¯¹ç´¢å¼•è¿›è¡Œä¸€è‡´è¯»å–ï¼Œæ­¤æ—¶å…¶ä»–äº‹åŠ¡å¤„ç†æ— æ³•æ’å…¥æˆ–ä¿®æ”¹ä¸æŸ¥è¯¢æ¡ä»¶åŒ¹é…çš„è¡Œ</p><h2 id="innodb-çš„äº‹åŠ¡æ¨¡å‹">InnoDB çš„äº‹åŠ¡æ¨¡å‹</h2><p>InnoDBçš„äº‹åŠ¡æ¨¡å‹æ—¨åœ¨å°†å¤šç‰ˆæœ¬ç‰¹æ€§ï¼ˆmulti-versioningï¼‰å’Œä¼ ç»Ÿçš„ä¸¤é˜¶æ®µé”å®šç›¸ç»“åˆ</p><p>InnoDB åœ¨è¡Œçº§åˆ«æ‰§è¡Œé”å®šï¼Œå¹¶ä»¥ Oracleçš„é£æ ¼é»˜è®¤ä½œä¸ºéé”å®šä¸€è‡´è¯»ï¼ˆnonlocking consistent readsï¼‰æ¥è¿è¡ŒæŸ¥è¯¢</p><p>InnoDBä¸­çš„é”ä¿¡æ¯è¢«æœ‰æ•ˆåœ°å­˜å‚¨åœ¨ç©ºé—´ä¸­ï¼Œå› æ­¤ä¸éœ€è¦å‡çº§é”ï¼Œé€šå¸¸å…è®¸å‡ ä¸ªç”¨æˆ·é”å®šInnoDB è¡¨ä¸­çš„æ¯ä¸€è¡Œï¼Œæˆ–è¡Œçš„ä»»ä½•éšæœºå­é›†ï¼Œå¹¶ä¸ä¼šå¯¼è‡´ InnoDB å†…å­˜è€—å°½</p><h3 id="éš”ç¦»çº§åˆ«">éš”ç¦»çº§åˆ«</h3><p>éš”ç¦»çº§åˆ«æ˜¯æ•°æ®åº“å¤„ç†çš„åŸºç¡€ï¼Œ</p><p>InnoDB æä¾›äº† <em>SQL:1992 æ ‡å‡†</em> æ‰€æè¿°çš„å››ç§éš”ç¦»çº§åˆ«ï¼š</p><ul><li>READ UNCOMMITTED</li><li>READ COMMITTED</li><li>REPEATABLE READ (DEFAULT)</li><li>SERIALIZABLE</li></ul><p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨ <code>SET TRANSACTION</code>è¯­å¥æ¥æ›´æ”¹å•ä¸ªä¼šè¯æˆ–æ‰€æœ‰åç»­è¿æ¥çš„éš”ç¦»çº§åˆ«ï¼Œåœ¨å‘½ä»¤è¡Œæˆ–é…ç½®æ–‡ä»¶ä½¿ç”¨<code>--trsaction</code> é…ç½®å¯ä»¥è®¾ç½®æœåŠ¡å™¨çš„éš”ç¦»çº§åˆ«</p><p>InnoDB æ”¯æŒä¸åŒçš„éš”ç¦»äº‹åŠ¡çº§åˆ«ä½¿ç”¨ä¸åŒçš„é”ç­–ç•¥ï¼Œå¯ä»¥ä½¿ç”¨é»˜è®¤çš„ RRçº§åˆ«å¼ºè°ƒé«˜åº¦ä¸€è‡´æ€§ï¼Œç”¨äºè¿›è¡Œå¯¹äº ACIDè¦æ±‚è¾ƒé«˜çš„å…³é”®æ•°æ®æ“ä½œï¼›åœ¨æ‰¹é‡æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ RC æˆ–è€… RUçº§åˆ«æ¥æ”¾å®½ä¸€è‡´æ€§åŸåˆ™ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç²¾ç¡®çš„ä¸€è‡´æ€§å’Œé‡å¤ç»“æœä¸å¦‚æœ€å°åŒ–ä¸Šé”å¼€é”€é‚£ä¹ˆé‡è¦ï¼›Sçº§åˆ«ä¼šæ¯” RR æ›´åŠ ä¸¥æ ¼ï¼Œå®ƒç»å¸¸è¢«ç”¨äºç‰¹æ®Šçš„åœºæ™¯ï¼Œä¾‹å¦‚ XAäº‹åŠ¡æˆ–è€…è§£å†³å¹¶å‘å’Œæ­»é”é—®é¢˜</p><p><strong>REAPEATABLE READ</strong></p><p>è¿™æ˜¯ InnoDBçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼›åŒä¸€äº‹åŠ¡ä¸­éƒ½è¯»å–ç”±ç¬¬ä¸€æ¬¡è¯»å–å»ºç«‹çš„å¿«ç…§ç‰ˆæœ¬ï¼Œè¿™æ„å‘³ç€å¦‚æœåœ¨åŒä¸€äº‹åŠ¡ä¸­å‘å‡ºå¤šä¸ªéé”å®šçš„SELECT è¯­å¥ï¼Œé‚£ä¹ˆè¿™äº› SELECT æ“ä½œæŸ¥è¯¢åˆ°çš„æ•°æ®é›†å½¼æ­¤æ˜¯ä¸€è‡´çš„ï¼›è¿™è¢«ç§°ä¸ºâ€œä¸€è‡´çš„éé”å®šè¯»å–â€ï¼ˆConsistent Nonlocking Readsï¼‰</p><p>å¯¹äºé”å®šè¯»å–ï¼ˆSELECT ... FOR UPDATE æˆ–è€… LOCK IN SHAREMODEï¼‰ã€UPDATEã€DELETE è¯­å¥ï¼Œä¼šæ ¹æ®ç´¢å¼•ç±»å‹å’ŒæŸ¥è¯¢èŒƒå›´è¿›è¡Œä¸Šé”ï¼š</p><ul><li>å¯¹äºå…·æœ‰å”¯ä¸€æœç´¢æ¡ä»¶çš„å”¯ä¸€ç´¢å¼•ï¼ŒInnoDBåªé”å®šæ‰¾åˆ°çš„ç´¢å¼•è®°å½•ï¼Œè€Œä¸é”å®šä¹‹å‰çš„é—´éš™</li><li>å¯¹äºå…¶ä»–æœç´¢æ¡ä»¶ï¼ŒInnoDBä¼šé”å®šæ‰«æçš„ç´¢å¼•èŒƒå›´ï¼Œä½¿ç”¨é—´éš™é”æˆ–ä¸´é”®é”æ¥é˜»æ­¢å…¶ä»–ä¼šè¯æ’å…¥åˆ°èŒƒå›´æ‰€è¦†ç›–çš„é—´éš™ä¸­</li></ul><p><strong>READ COMMITTED</strong></p><p>å³ä½¿åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œæ¯æ¬¡ä¸€è‡´è¯»å–éƒ½ä¼šè®¾ç½®æ–°çš„å¿«ç…§</p><p>å¯¹äºé”å®šè¯»å–ï¼ˆSELECT ... FOR UPDATE æˆ–è€… LOCK IN SHAREMODEï¼‰ã€UPDATEã€DELETE è¯­å¥ï¼ŒInnoDBåªé”å®šç´¢å¼•è®°å½•ï¼Œè€Œä¸é”å®šå®ƒä»¬çš„é—´éš™ï¼Œå› æ­¤å…è®¸åœ¨é”å®šè®°å½•é™„è¿‘æ’å…¥æ–°è®°å½•ï¼›é—´éš™é”å®šä»…ç”¨äºå¤–é”®çº¦æŸæ£€æŸ¥å’Œé‡å¤key æ£€æŸ¥</p><p>ç”±äºä¸é”å®šé—´éš™ï¼ˆé—´éš™é”è¢«ç¦ç”¨ï¼‰ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°å¹»è¯»é—®é¢˜ï¼Œå› ä¸ºå…¶ä»–ä¼šè¯å¯ä»¥å°†æ–°è¡Œæ’å…¥é—´éš™ä¸­</p><p>RC éš”ç¦»çº§åˆ«ä»…æ”¯æŒåŸºäºè¡Œçš„äºŒè¿›åˆ¶æ—¥å¿—è®°å½•ï¼›å¦‚æœå°† RC ä¸binlog_format=MIXED ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™æœåŠ¡å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨åŸºäºè¡Œçš„æ—¥å¿—è®°å½•</p><p>ä½¿ç”¨ RC éš”ç¦»çº§åˆ«å¯èƒ½å­˜åœ¨çš„å½±å“ï¼š</p><ul><li>å¯¹äº UPDATE æˆ– DELETE è¯­å¥ï¼ŒInnoDBåªä¸ºæ›´æ–°æˆ–åˆ é™¤çš„è¡Œä¿ç•™é”è®°å½•ï¼ŒMySQL ä¼šåœ¨è¯„ä¼° WHEREæ¡ä»¶åé‡Šæ”¾ä¸åŒ¹é…è¡Œçš„è®°å½•é”ï¼Œè¿™å¤§å¤§é™ä½äº†æ­»é”çš„æ¦‚ç‡ï¼Œä½†æ­»é”ä»ç„¶å¯èƒ½å‘ç”Ÿ</li><li>å¯¹äº UPDATE è¯­å¥ï¼Œå¦‚æœä¸€è¡Œå·²ç»è¢«é”å®šï¼ŒInnoDB ä¼šæ‰§è¡Œâ€œåŠä¸€è‡´â€ï¼ˆsemi-consistentï¼‰ è¯»å–ï¼Œå°†æœ€æ–°æäº¤çš„ç‰ˆæœ¬è¿”å›ç»™ MySQLï¼Œä»¥ä¾¿MySQL å¯ä»¥ç¡®å®šè¯¥è¡Œæ˜¯å¦ç¬¦åˆ UPDATE çš„ WHEREæ¡ä»¶ï¼Œå¦‚æœè¡ŒåŒ¹é…ï¼ˆå¿…é¡»æ›´æ–°ï¼‰MySQL å°†å†æ¬¡è¯»å–è¯¥è¡Œï¼Œè¿™ä¸€æ¬¡ InnoDBè¦ä¹ˆå°†å…¶é”å®šï¼Œè¦ä¹ˆç­‰å¾…é”å®š</li></ul><p><strong>READ UNCOMMITTED</strong></p><p>SELECTæ“ä½œä¼šä»¥æ— é”æ–¹å¼æ‰§è¡Œï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨è¡Œçš„å¯èƒ½çš„æ—©æœŸç‰ˆæœ¬ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§éš”ç¦»çº§åˆ«å¯èƒ½å¯¼è‡´è¯»å–æ˜¯ä¸ä¸€è‡´çš„ï¼Œè¢«ç§°ä¸ºè„è¯»</p><p><strong>SERIALIZABLE</strong></p><p>è¯¥çº§åˆ«ç±»ä¼¼ RRï¼Œä½†æ˜¯å¦‚æœç¦ç”¨äº†è‡ªåŠ¨æäº¤ InnoDB éšå¼åœ°å°† SELECT è½¬æ¢ä¸ºäº†SELECT ... LOCK IN SHARE MODEï¼›å¦‚æœè‡ªåŠ¨æäº¤æ˜¯å¯ç”¨çŠ¶æ€ï¼ŒSELECTæ˜¯å®ƒè‡ªå·±çš„äº‹åŠ¡</p><p>å› æ­¤å·²çŸ¥å®ƒæ˜¯åªè¯»çš„ï¼Œä¸€è‡´ï¼ˆéé”å®šï¼‰è¯»å–æ‰§è¡Œä¸²è¡ŒåŒ–ä¸ä¼šé˜»å¡å…¶ä»–çš„äº‹åŠ¡ï¼ˆè‹¥è¦åœ¨å…¶ä»–äº‹åŠ¡å·²ä¿®æ”¹æ‰€é€‰è¡Œçš„æƒ…å†µä¸‹è¿›è¡Œé”å®šè¯»å–ï¼Œéœ€è¦ç¦ç”¨è‡ªåŠ¨æäº¤ï¼‰</p><h3 id="è‡ªåŠ¨æäº¤æäº¤å’Œå›æ»š">è‡ªåŠ¨æäº¤ã€æäº¤å’Œå›æ»š</h3><p>InnoDB ä¸­æ‰€æœ‰çš„ç”¨æˆ·æ“ä½œéƒ½å‘ç”Ÿåœ¨äº‹åŠ¡ä¸­</p><p>å¦‚æœå¯ç”¨äº†è‡ªåŠ¨æäº¤æ¨¡å¼ï¼Œåˆ™æ¯æ¡ SQLè¯­å¥éƒ½ä¼šè‡ªå·±å½¢æˆä¸€ä¸ªäº‹åŠ¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ MySQL ä¼šä¸ºæ¯ä¸ªæ–°è¿æ¥çš„ Sessionå¼€å¯è‡ªåŠ¨æäº¤ï¼Œå› æ­¤ MySQL ä¼šåœ¨æ¯ä¸ªæ‰§è¡ŒæˆåŠŸçš„ SQLè¯­å¥åè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼›å¦‚æœæ‰§è¡Œå‘ç”Ÿäº†é”™è¯¯ï¼Œé‚£ä¹ˆæäº¤æˆ–è€…å›æ»šå–å†³äºé”™è¯¯ç±»å‹</p><p>å¯ç”¨äº†è‡ªåŠ¨æäº¤çš„ä¼šè¯ä¹Ÿå¯ä»¥æ‰§è¡Œå¤šè¯­å¥äº‹åŠ¡ï¼Œæ–¹æ³•æ˜¯ä»¥æ˜¾å¼ STARTtransaction æˆ– BEGIN è¯­å¥å¼€å§‹ï¼Œç„¶åä»¥ COMMIT æˆ– ROLLBACK è¯­å¥ç»“æŸ</p><p>å¦‚æœåœ¨ <code>SET autocommit=0</code>çš„ä¼šè¯ä¸­ç¦ç”¨äº†è‡ªåŠ¨æäº¤æ¨¡å¼ï¼Œåˆ™è¯¥ä¼šè¯å§‹ç»ˆæ‰“å¼€ä¸€ä¸ªäº‹åŠ¡ï¼›COMMIT æˆ– ROLLBACKè¯­å¥ä¼šç»“æŸå½“å‰äº‹åŠ¡ï¼Œå¹¶å¯åŠ¨æ–°äº‹åŠ¡</p><p>å¦‚æœäº‹åŠ¡ç¦ç”¨äº†è‡ªåŠ¨æäº¤ï¼Œå¹¶ä¸”ç»“æŸæ—¶ä¹Ÿæ²¡æœ‰é’ˆå¯¹è¯¥äº‹åŠ¡æ˜ç¡®çš„ COMMITæ“ä½œï¼Œé‚£ä¹ˆ MySQL ä¼šå›æ»šè¯¥äº‹åŠ¡</p><h3 id="ä¸€è‡´éé”å®šè¯»">ä¸€è‡´éé”å®šè¯»</h3><p>ä¸€è‡´è¯»å–æ„å‘³ç€ InnoDBä½¿ç”¨å¤šç‰ˆæœ¬æ§åˆ¶åœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼ˆtimepointï¼‰å‘æŸ¥è¯¢æ˜¾ç¤ºæ•°æ®åº“çš„å¿«ç…§ï¼ŒæŸ¥è¯¢ä¼šçœ‹åˆ°åœ¨æ­¤æ—¶é—´ç‚¹ä¹‹å‰æäº¤çš„äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹ï¼Œè€Œä¸ä¼šçœ‹åˆ°ä»¥åæˆ–æœªæäº¤çš„äº‹åŠ¡è¿›è¡Œçš„ä¿®æ”¹</p><p>æ‚¨å¯ä»¥é€šè¿‡æäº¤äº‹åŠ¡ï¼Œç„¶åä½¿ç”¨ä¸€è‡´å¿«ç…§æ‰§è¡Œå¦ä¸€ä¸ª SELECTæˆ–å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡æ¥æ¨è¿›æ—¶é—´ç‚¹</p><p>ä¸åŒéš”ç¦»çº§åˆ«çš„å¿«ç…§ç­–ç•¥ï¼š</p><ul><li>REPEATABLEREADï¼šç¬¬ä¸€æ¬¡è¯»å–è®¾ç½®å¿«ç…§ï¼›æäº¤äº‹åŠ¡åçš„è¯»å–åˆ™ä¼šä½¿ç”¨æœ€æ–°æ•°æ®</li><li>READ COMMITTEDï¼šäº‹åŠ¡ä¸­çš„æ¯ä¸ªä¸€è‡´è¯»å–éƒ½ä¼šè®¾ç½®å¹¶è¯»å–è‡ªå·±çš„æ–°å¿«ç…§</li></ul><p><strong>ä¸¾ä¸€ä¸ªä¾‹å­è¯´æ˜ä¸€è‡´æ€§è¯»</strong></p><p>äº‹åŠ¡ A åªæœ‰åœ¨ B æäº¤äº†äº‹åŠ¡ï¼Œå¹¶ä¸” A ä¹Ÿæäº¤äº†äº‹åŠ¡æ—¶æ‰çœ‹åˆ°ç”± Bæ’å…¥çš„è¡Œ</p><table><thead><tr class="header"><th>äº‹åŠ¡ A</th><th>äº‹åŠ¡ B</th></tr></thead><tbody><tr class="odd"><td>å¼€å¯äº‹åŠ¡</td><td>å¼€å¯äº‹åŠ¡</td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆempty setï¼‰</td><td></td></tr><tr class="odd"><td></td><td>INSERT INTO tVALUES (1, 2);</td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆempty setï¼‰</td><td></td></tr><tr class="odd"><td></td><td>COMMIT;</td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆempty setï¼‰</td><td></td></tr><tr class="odd"><td>COMMIT;</td><td></td></tr><tr class="even"><td>SELECT * FROM t;ï¼ˆ1,2ï¼‰</td><td></td></tr></tbody></table><p>å¦‚æœæ‚¨æƒ³æŸ¥çœ‹æ•°æ®åº“çš„â€œæœ€æ–°â€çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ READ COMMITTEDéš”ç¦»çº§åˆ«æˆ–ä½¿ç”¨é”å®šè¯»</p><p><strong>éœ€è¦æ³¨æ„ DML å¯¹æ•°æ®å¯è§çš„å½±å“</strong></p><p>æ•°æ®åº“çŠ¶æ€çš„å¿«ç…§åº”ç”¨äºäº‹åŠ¡ä¸­çš„ SELECT è¯­å¥ï¼Œè€Œä¸ä¸€å®šåº”ç”¨äº DMLè¯­å¥</p><p>å¦‚æœæ’å…¥æˆ–ä¿®æ”¹æŸäº›è¡Œï¼Œç„¶åæäº¤è¯¥äº‹åŠ¡ï¼Œåˆ™ä»å¦ä¸€ä¸ªå¹¶å‘çš„ REPEATABLEREAD äº‹åŠ¡å‘å‡ºçš„ DELETE æˆ– UPDATEè¯­å¥å¯èƒ½ä¼šå½±å“é‚£äº›åˆšåˆšæäº¤çš„è¡Œï¼Œå³ä½¿ä¼šè¯æ— æ³•æŸ¥è¯¢åˆ°è¿™äº›æ•°æ®ï¼ˆå› ä¸ºå¿«ç…§ï¼‰</p><p>å¦‚æœäº‹åŠ¡ç¡®å®æ›´æ–°æˆ–åˆ é™¤äº†ç”±å…¶ä»–äº‹åŠ¡æäº¤çš„è¡Œï¼Œåˆ™è¿™äº›æ›´æ”¹å¯¹å½“å‰äº‹åŠ¡å¯è§</p><p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(c1) <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c1 <span class="operator">=</span> <span class="string">&#x27;xyz&#x27;</span>;</span><br><span class="line"><span class="comment">-- 0 è¡Œ</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c1 <span class="operator">=</span> <span class="string">&#x27;xyz&#x27;</span>;</span><br><span class="line"><span class="comment">-- å¯èƒ½ä¼šåˆ é™¤æœ€è¿‘ç”±å…¶ä»–äº‹åŠ¡æäº¤çš„åŒ¹é…åˆ°çš„è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(c2) <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c2 <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"><span class="comment">-- 0 è¡Œ</span></span><br><span class="line"><span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> c2 <span class="operator">=</span> <span class="string">&#x27;cba&#x27;</span> <span class="keyword">WHERE</span> c2 <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"><span class="comment">-- å¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡åˆšåˆšæäº¤äº† abc å€¼çš„ 10 è¡Œ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(c2) <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> c2 <span class="operator">=</span> <span class="string">&#x27;cba&#x27;</span>;</span><br><span class="line"><span class="comment">-- 10 è¡Œï¼›è¿™ä¸ªäº‹åŠ¡ç°åœ¨å¯ä»¥çœ‹åˆ°å®ƒåˆšåˆšæ›´æ–°çš„è¡Œ</span></span><br></pre></td></tr></table></figure></p><h3 id="é”å®šè¯»">é”å®šè¯»</h3><p>å¦‚æœæŸ¥è¯¢æ•°æ®åå¸Œæœ›åœ¨åŒä¸€äº‹åŠ¡ä¸­æ’å…¥æˆ–æ›´æ–°ç›¸å…³æ•°æ®ï¼Œåˆ™å¸¸è§„ SELECTè¯­å¥æ— æ³•æä¾›è¶³å¤Ÿçš„ä¿æŠ¤ï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥æ›´æ–°æˆ–åˆ é™¤æ‚¨åˆšæ‰æŸ¥è¯¢çš„åŒä¸€è¡Œ</p><p>InnoDB å¼•æ“æä¾›äº†ä¸¤ç§é”å®šè¯»çš„æ–¹å¼æ¥æä¾›é¢å¤–çš„å®‰å…¨ä¿è¯ï¼š</p><ul><li><code>SELECT ... LOCK IN SHARE MODE</code>åœ¨è¯»å–åˆ°çš„æ‰€æœ‰è¡Œä¸Šè®¾ç½®å…±äº«é”ï¼ˆshared modelockï¼‰å…¶ä»–äº‹åŠ¡å¯ä»¥è¿›è¡Œè¯»å–ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡æäº¤ä¹‹å‰éƒ½ä¸èƒ½è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœæŸ¥è¯¢è¿‡ç¨‹ä¸­è¿™äº›è¡Œä¸­çš„ä»»æ„è¡Œè¢«å¦ä¸€ä¸ªå°šæœªæäº¤çš„äº‹åŠ¡ä¿®æ”¹ï¼Œåˆ™æŸ¥è¯¢å°†ç­‰å¾…è¯¥äº‹åŠ¡ç»“æŸï¼Œç„¶åä½¿ç”¨æ›´æ–°åçš„å€¼</li><li><code>SELECT ... FOR UPDATE</code>å¯¹äºæŸ¥è¯¢åˆ°çš„ç´¢å¼•è®°å½•ï¼Œé”å®šè¡Œå’Œä»»ä½•å…³è”çš„ç´¢å¼•æ¡ç›®ï¼Œå°±åƒä¸ºè¿™äº›è¡Œè¿›è¡ŒUPDATE è¯­å¥ä¸€æ ·å¯¹å…¶ä»–äº‹åŠ¡è¢«é˜»æ­¢æ›´æ–°è¿™äº›è¡Œã€è¿›è¡ŒæŸ¥è¯¢ã€åœ¨å…±äº«æ¨¡å¼ä¸‹é”å®šæˆ–è¯»å–ç‰¹å®šäº‹åŠ¡éš”ç¦»çº§åˆ«çš„æ•°æ®ä¸€è‡´è¯»ï¼ˆå¿«ç…§è¯»ï¼‰å°†å¿½ç•¥åœ¨è¯»å–è§†å›¾ä¸­å­˜åœ¨çš„è®°å½•ä¸Šè®¾ç½®çš„ä»»ä½•é”ï¼ˆè®°å½•çš„æ—§ç‰ˆæœ¬æ— æ³•é”å®šï¼Œå› ä¸ºå®ƒä»¬æ˜¯é€šè¿‡åœ¨è®°å½•çš„å†…å­˜å‰¯æœ¬ä¸Šåº”ç”¨undo log æ¥é‡å»ºçš„ï¼‰</li></ul><p>è¿™äº›å­å¥åœ¨å¤„ç†æ ‘ç»“æ„æˆ–å›¾ç»“æ„æ•°æ®æ—¶éå¸¸æœ‰ç”¨ï¼Œæ— è®ºæ˜¯åœ¨å•ä¸ªè¡¨ä¸­è¿˜æ˜¯åœ¨å¤šä¸ªè¡¨ä¸­æ‹†åˆ†ï¼›å¯ä»¥ä»ä¸€ä¸ªä½ç½®éå†è¾¹æˆ–æ ‘æåˆ°å¦ä¸€ä¸ªä½ç½®ï¼ŒåŒæ—¶ä¿ç•™è¿”å›å¹¶æ›´æ”¹ä»»ä½•è¿™äº›â€œæŒ‡é’ˆâ€å€¼çš„æƒåˆ©</p><p>å½“äº‹åŠ¡è¢«æäº¤æˆ–å›æ»šæ—¶ï¼Œç”± LOCK IN SHARE MODE å’Œ FOR UPDATEæŸ¥è¯¢è®¾ç½®çš„æ‰€æœ‰é”éƒ½ä¼šè¢«é‡Šæ”¾</p><p><strong>FOR UPDATE ä¸ä¼šä¼ é€’</strong></p><p>å¤–éƒ¨è¯­å¥ä¸­çš„é”å®šè¯»å–å­å¥ä¸ä¼šé”å®šåµŒå¥—å­æŸ¥è¯¢ä¸­è¡¨çš„è¡Œï¼Œé™¤éåœ¨å­æŸ¥è¯¢ä¸­ä¹ŸæŒ‡å®šäº†é”å®šè¯»å–å­å¥</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è¯­å¥ä¸ä¼šé”å®šè¡¨ t2 ä¸­çš„è¡Œ</p><p><code>SELECT * FROM t1 WHERE c1 = (SELECT c1 FROM t2) FOR UPDATE;</code></p><p>è¦é”å®šè¡¨ t2 ä¸­çš„è¡Œï¼Œè¯·å‘å­æŸ¥è¯¢æ·»åŠ ä¸€ä¸ªé”å®šè¯»å–å­å¥</p><p><code>SELECT * FROM t1 WHERE c1 = (SELECT c1 FROM t2 FOR UPDATE) FOR UPDATE;</code></p><blockquote><p>locking read</p><p>A <ahref="https://dev.mysql.com/doc/refman/5.7/en/select.html"><code>SELECT</code></a>statement that also performs a <strong>locking</strong> operation on an<code>InnoDB</code> table. Either <code>SELECT ... FOR UPDATE</code> or<code>SELECT ... LOCK IN SHARE MODE</code>. It has the potential toproduce a <strong>deadlock</strong>, depending on the <strong>isolationlevel</strong> of the transaction. The opposite of a <strong>non-lockingread</strong>*. Not allowed for global tables in a <strong>read-onlytransaction</strong>.</p><p><code>SELECT ... FOR SHARE</code> replaces<code>SELECT ... LOCK IN SHARE MODE</code> in MySQL 8.0.1, but<code>LOCK IN SHARE MODE</code> remains available for backwardcompatibility.</p><p>See <ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-reads.html">Section14.7.2.4, â€œLocking Readsâ€</a>.</p><p>See Also <ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_deadlock">deadlock</a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_isolation_level">isolationlevel</a>, <ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_locking">locking</a>,<ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_non_locking_read">non-lockingread</a>, <ahref="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_read_only_transaction">read-onlytransaction</a>.</p></blockquote><h2 id="innodb-ä¸­ä¸åŒè¯­å¥è®¾ç½®çš„é”">InnoDB ä¸­ä¸åŒè¯­å¥è®¾ç½®çš„é”</h2><p>å¦‚æœåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨äº†äºŒçº§ç´¢å¼•ï¼Œå¹¶ä¸”è¦è®¾ç½®çš„ç´¢å¼•è®°å½•é”ï¼ˆrecordlocksï¼‰æ˜¯æ’ä»–çš„ï¼Œé‚£ä¹ˆ InnoDB è¿˜ä¼šæ£€ç´¢ç›¸åº”çš„èšé›†ç´¢å¼•è®°å½•å¹¶å¯¹å…¶è®¾ç½®é”</p><p>å¦‚æœä½ çš„è¯­å¥æ²¡æœ‰åˆé€‚çš„ç´¢å¼•ï¼ŒMySQLå¿…é¡»æ‰«ææ•´ä¸ªè¡¨ï¼Œè¯¥è¡¨çš„æ¯ä¸€è¡Œéƒ½ä¼šè¢«é”ä½ï¼Œå°†ä¼šé˜»æ­¢å…¶ä»–ç”¨æˆ·å¯¹è¯¥è¡¨çš„æ‰€æœ‰æ’å…¥ï¼Œæ‰€ä»¥åˆ›å»ºè‰¯å¥½çš„ç´¢å¼•éå¸¸é‡è¦ï¼Œè¿™æ ·æŸ¥è¯¢æ“ä½œå°±ä¸ä¼šæ‰«æè¶…å‡ºéœ€æ±‚èŒƒå›´çš„è®°å½•è¡Œ</p><p>InnoDB è®¾ç½®ç‰¹å®šç±»å‹çš„é”ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li><p><code>SELECT ... FROM</code>ä¸€è‡´æ€§è¯»ï¼Œè¯»å–æ•°æ®åº“çš„å¿«ç…§ä¸ä¼šä¸Šé”ï¼Œé™¤ééš”ç¦»çº§åˆ«ä¸º SERIALIZABLEï¼›å¯¹äºSERIALIZABLEçº§åˆ«ï¼Œè¯¥æŸ¥è¯¢å°†ä¼šåœ¨é‡åˆ°çš„ç´¢å¼•è®°å½•ä¸Šè®¾ç½®å…±äº«çš„ä¸´é”®é”ï¼›ä½†æ˜¯å¯¹äºä½¿ç”¨å”¯ä¸€ç´¢å¼•é”å®šè¡Œæ¥æŸ¥è¯¢å”¯ä¸€è¡Œçš„è¯­å¥ï¼Œåªéœ€è¦ç´¢å¼•è®°å½•é”</p></li><li><p><code>SELECT ... FOR UPDATE</code> æˆ–<code>SELECT ... LOCK IN SHARE MODE</code>ä¸ºæ‰«æçš„è¡Œè·å–é”ï¼Œå¹¶å¯èƒ½ä¸ºä¸ç¬¦åˆç»“æœé›†ä¸­åŒ…å«æ¡ä»¶çš„è¡Œé‡Šæ”¾é”ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå®ƒä»¬ä¸ç¬¦åˆWHERE å­å¥ä¸­ç»™å®šçš„æ¡ä»¶ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸ä¼šç«‹å³è§£é”ï¼Œå› ä¸ºç»“æœè¡Œä¸å…¶åŸå§‹æºä¹‹é—´çš„å…³ç³»åœ¨æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œä¾‹å¦‚åœ¨UNIONä¸­ï¼Œåœ¨è¯„ä¼°è¡¨ä¸­æ‰«æï¼ˆå’Œé”å®šï¼‰çš„è¡Œæ˜¯å¦ç¬¦åˆç»“æœé›†ä¹‹å‰ï¼Œå¯èƒ½ä¼šå°†è¿™äº›è¡Œæ’å…¥åˆ°ä¸´æ—¶è¡¨ä¸­ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸´æ—¶è¡¨ä¸­çš„è¡Œä¸åŸå§‹è¡¨ä¸­çš„åˆ—ä¹‹é—´çš„å…³ç³»å°†ä¸¢å¤±ï¼Œè€Œåçš„è¡Œç›´åˆ°æŸ¥è¯¢æ‰§è¡Œç»“æŸæ‰è¢«è§£é”</p></li><li><p><code>SELECT ... LOCK IN SHARE MODE</code>åœ¨æŸ¥è¯¢é‡åˆ°çš„æ‰€æœ‰ç´¢å¼•è®°å½•ä¸Šè®¾ç½®å…±äº«çš„ä¸´é”®é”ï¼Œä½†æ˜¯å¯¹äºä½¿ç”¨å”¯ä¸€ç´¢å¼•é”å®šè¡Œæ¥æŸ¥è¯¢å”¯ä¸€è¡Œçš„è¯­å¥ï¼Œåªéœ€è¦ç´¢å¼•è®°å½•é”</p></li><li><p><code>SELECT ... FOR UPDATE</code>åœ¨æŸ¥è¯¢é‡åˆ°çš„æ‰€æœ‰ç´¢å¼•è®°å½•ä¸Šè®¾ç½®æ’ä»–çš„ä¸´é”®é”ï¼Œä½†æ˜¯å¯¹äºä½¿ç”¨å”¯ä¸€ç´¢å¼•é”å®šè¡Œæ¥æŸ¥è¯¢å”¯ä¸€è¡Œçš„è¯­å¥ï¼Œåªéœ€è¦ç´¢å¼•è®°å½•é”</p></li><li><p><code>UPDATE ... WHERE ...</code>åœ¨é‡åˆ°çš„æ¯ä¸€è¡Œç´¢å¼•è®°å½•ä¸Šè®¾ç½®æ’ä»–çš„ä¸´é”®é”ï¼›ä½†æ˜¯å¯¹äºä½¿ç”¨å”¯ä¸€ç´¢å¼•é”å®šè¡Œæ¥æŸ¥è¯¢å”¯ä¸€è¡Œçš„è¯­å¥ï¼Œåªéœ€è¦ç´¢å¼•è®°å½•é”</p></li><li><p><code>UPDATE</code>ä¿®æ”¹èšé›†ç´¢å¼•è®°å½•æ—¶ï¼Œä¼šå¯¹å—å½±å“çš„è¾…åŠ©ç´¢å¼•è®°å½•ä½¿ç”¨éšå¼é”ï¼Œåœ¨æŸ¥è¯¢æ–°çš„è¾…åŠ©ç´¢å¼•è®°å½•ä¹‹å‰æ‰§è¡Œé‡å¤æ£€æµ‹æ—¶ã€æˆ–è€…åœ¨æ’å…¥æ–°çš„è¾…åŠ©ç´¢å¼•è®°å½•æ—¶ï¼Œæ›´æ–°æ“ä½œè¿˜ä¼šå¯¹å—å½±å“çš„è¾…åŠ©ç´¢å¼•è®°å½•è·å–å…±äº«é”</p></li><li><p><code>DELETE FROM ... WHERE ...</code>å¯¹é‡åˆ°çš„ç´¢å¼•è®°å½•è®¾ç½®æ’ä»–ä¸´é”®é”ï¼›ä½†æ˜¯å¯¹äºä½¿ç”¨å”¯ä¸€ç´¢å¼•é”å®šè¡Œæ¥æŸ¥è¯¢å”¯ä¸€è¡Œçš„è¯­å¥ï¼Œåªéœ€è¦ç´¢å¼•è®°å½•é”</p></li><li><p><code>INSERT</code>å¯¹æ’å…¥çš„è¡Œè®¾ç½®æ’ä»–è®°å½•é”ï¼Œè€Œä¸æ˜¯ä¸´é”®é”ï¼ˆå³æ²¡æœ‰é—´éš™é”ï¼‰ï¼Œå¹¶ä¸”ä¸ä¼šé˜»æ­¢å…¶ä»–ä¼šè¯æ’å…¥æ’å…¥è¡Œä¹‹å‰çš„é—´éš™ä¸­</p><p>åœ¨æ’å…¥è¡Œä¹‹å‰ï¼Œè®¾ç½®ç±»å‹ä¸ºé—´éš™é”çš„æ’å…¥æ„å‘é”ï¼›è¯¥é”ç›¸å½“äºå‘å‡ºæ’å…¥æ„å‘çš„ä¿¡å·ï¼Œå³å¦‚æœæ’å…¥åˆ°åŒä¸€ç´¢å¼•é—´éš™ä¸­çš„å¤šä¸ªäº‹åŠ¡å¹¶ä¸åœ¨é—´éš™å†…çš„åŒä¸€ä½ç½®æ’å…¥ï¼Œåˆ™å®ƒä»¬ä¸éœ€è¦å½¼æ­¤ç­‰å¾…ï¼›å‡è®¾å­˜åœ¨å€¼ä¸º4 å’Œ 7 çš„ç´¢å¼•è®°å½•ï¼Œå½“å°è¯•æ’å…¥å€¼ä¸º 5 å’Œ 6çš„å•ç‹¬äº‹åŠ¡ï¼Œåœ¨è·å¾—æ’ä»–è®°å½•é”ä¹‹å‰ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä½¿ç”¨æ’å…¥æ„å‘é”æ¥é”å®š 4 å’Œ 7ä¹‹é—´çš„é—´éš™ï¼Œä½†ä¸ä¼šäº’ç›¸é˜»æ­¢ï¼Œå› ä¸ºæ’å…¥è¡Œä¸å†²çª</p><p>å¦‚æœå‡ºç°é‡å¤é”®é”™è¯¯ï¼Œåˆ™ä¼šå¯¹é‡å¤ç´¢å¼•è®°å½•è®¾ç½®å…±äº«é”ï¼Œå¦‚æœæœ‰å¤šä¸ªä¼šè¯è¯•å›¾æ’å…¥åŒä¸€è¡Œï¼Œè€Œå¦ä¸€ä¸ªä¼šè¯å·²ç»å…·æœ‰æ’ä»–é”ï¼Œåˆ™è¿™ç§å…±äº«é”çš„ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´æ­»é”ï¼Œå¦‚æœå¦ä¸€ä¸ªä¼šè¯åˆ é™¤è¯¥è¡Œï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿå¦‚ä¸‹æƒ…å†µï¼›å‡è®¾ä¸€ä¸ªInnoDB è¡¨ t1 å…·æœ‰ä»¥ä¸‹ç»“æ„ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (i <span class="type">INT</span>, <span class="keyword">PRIMARY</span> KEY (i)) ENGINE <span class="operator">=</span> InnoDB;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å‡è®¾ä¸‰ä¸ªäº‹åŠ¡æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol type="1"><li><p>äº‹åŠ¡ 1 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p></li><li><p>äº‹åŠ¡ 2 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p></li><li><p>äº‹åŠ¡ 3 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p></li><li><p>äº‹åŠ¡ 1 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROLLBACK</span>;</span><br></pre></td></tr></table></figure></p></li></ol><p><strong>æµç¨‹åˆ†æ</strong>ï¼šäº‹åŠ¡ 1 çš„ç¬¬ä¸€ä¸ªæ“ä½œä¼šè·å– <code>1</code>è®°å½•è¡Œçš„æ’ä»–é”ï¼Œè€Œåäº‹åŠ¡ 2 å’Œ äº‹åŠ¡ 3 ä¹Ÿä¼šæ’å…¥ <code>1</code>å¯¼è‡´é‡å¤é”®é”™è¯¯ï¼Œå„è‡ªè·å–é’ˆå¯¹ <code>1</code> çš„å…±äº«é”ï¼Œäº‹åŠ¡ 1è¿›è¡Œå›æ»šï¼Œæ­¤æ—¶äº‹åŠ¡ 2 å’Œäº‹åŠ¡ 3å‡ºç°æ­»é”ï¼šç”±äºå¦ä¸€æ–¹æŒæœ‰å…±äº«é”ï¼Œå› æ­¤ä¸¤æ–¹éƒ½æ— æ³•è·å–è¯¥è¡Œçš„æ’ä»–é”</p><p>å¦‚æœè¡¨ä¸­å·²ç»åŒ…å«é”®å€¼ä¸º <code>1</code>çš„è¡Œï¼Œå¹¶ä¸”ä¸‰ä¸ªäº‹åŠ¡æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œåˆ™ä¼šå‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼š</p><ol type="1"><li><p>äº‹åŠ¡ 1 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> i <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p></li><li><p>äº‹åŠ¡ 2 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p></li><li><p>äº‹åŠ¡ 3 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p></li><li><p>äº‹åŠ¡ 1 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></p></li></ol><p><strong>æµç¨‹åˆ†æ</strong>ï¼šäº‹åŠ¡ 1 çš„ç¬¬ä¸€ä¸ªæ“ä½œä¼šè·å– <code>1</code>è®°å½•è¡Œçš„æ’ä»–é”ï¼Œè€Œåäº‹åŠ¡ 2 å’Œ äº‹åŠ¡ 3 ä¹Ÿä¼šæ’å…¥ <code>1</code>å¯¼è‡´é‡å¤é”®é”™è¯¯ï¼Œå„è‡ªè·å–é’ˆå¯¹ <code>1</code> çš„å…±äº«é”ï¼Œå½“äº‹åŠ¡ 1æäº¤æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾å…¶åœ¨è¡Œä¸Šçš„æ’ä»–é”ï¼Œå¹¶æˆäºˆäº‹åŠ¡ 2 å’Œ 3çš„æ’é˜Ÿå…±äº«é”è¯·æ±‚ï¼›æ­¤äº‹åŠ¡ 2å’Œäº‹åŠ¡ 3å‡ºç°æ­»é”ï¼šç”±äºå¦ä¸€æ–¹æŒæœ‰å…±äº«é”ï¼Œå› æ­¤ä¸¤æ–¹éƒ½æ— æ³•è·å–è¯¥è¡Œçš„ç‹¬å é”</p></li><li><p><code>INSERT ... ON DUPLICATE KEY UPDATE</code> ä¸åŒäºç®€å•çš„INSERTæ“ä½œï¼Œå½“å‘ç”Ÿé‡å¤é”®é”™è¯¯æ—¶ï¼Œä¼šåœ¨éœ€è¦æ›´æ–°çš„è¡Œä¸Šè®¾ç½®æ’ä»–é”ï¼Œè€Œä¸æ˜¯å…±äº«é”ï¼›å¯¹é‡å¤çš„ä¸»é”®å€¼ä½¿ç”¨æ’ä»–è®°å½•é”ï¼Œå¯¹äºé‡å¤çš„å”¯ä¸€ç´¢å¼•å€¼ï¼Œå°†ä½¿ç”¨æ’ä»–ä¸´é”®é”</p></li><li><p><code>REPLACE</code> å¦‚æœå”¯ä¸€é”®æ²¡æœ‰å†²çªåˆ™å’Œä¸€ä¸ª INSERTæ“ä½œä¸€è‡´ï¼Œå¦åˆ™ä¼šåœ¨éœ€è¦ replace çš„è¡Œä¸ŠåŠ æ’ä»–ä¸´é”®é”</p></li><li><p><code>INSERT INTO T SELECT ... FROM S WHERE ...</code></p></li></ul><h2 id="å¹»å½±è¡Œ">å¹»å½±è¡Œ</h2><p>ä¹‹æ‰€ä»¥ç§°å‘¼ä¸º â€œå¹»å½±è¯»é—®é¢˜â€æ˜¯å› ä¸ºä¸€ä¸ªäº‹åŠ¡åœ¨<strong>ä¸åŒçš„æ—¶é—´</strong>è¿›è¡Œ<strong>ç›¸åŒçš„æŸ¥è¯¢è¯·æ±‚</strong>è¿”å›çš„ç»“æœé›†ä¸åŒï¼›ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸€ä¸ª<code>SELECT</code> æ“ä½œæ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢è¿”å›äº† 1è¡Œæ•°æ®ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢æ²¡æœ‰è¿”å›æ•°æ®ï¼Œé‚£ä¹ˆè¿™è¡Œæ•°æ®å°±è¢«ç§°ä¸º â€œå¹»å½±è¡Œâ€ï¼ˆphantomrowï¼‰</p><p>å‡è®¾å­è¡¨çš„ id åˆ—ä¸Šæœ‰ä¸€ä¸ªç´¢å¼•ï¼Œå¹¶ä¸”å¸Œæœ›è¯»å–å¹¶é”å®šè¡¨ä¸­æ ‡è¯†ç¬¦å€¼å¤§äº 100çš„æ‰€æœ‰è¡Œï¼Œä»¥ä¾¿ç¨åæ›´æ–°æ‰€é€‰è¡Œä¸­çš„æŸäº›åˆ—ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">100</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>è¯¥æŸ¥è¯¢ä¼šä» id å¤§äº 100çš„ç¬¬ä¸€æ¡è®°å½•å¼€å§‹æ‰«æç´¢å¼•ï¼›å‡è®¾è¿™ä¸ªè¡¨å­˜åœ¨ä¸€äº›æ•°æ®ï¼Œid çš„å€¼ä¸º 90 å’Œ102ï¼Œå¦‚æœåœ¨æ‰«æèŒƒå›´å†…çš„ç´¢å¼•è®°å½•ä¸Šè®¾ç½®çš„é”ä¸é”å®šåœ¨é—´éš™ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ 90å’Œ 102 ä¹‹é—´çš„é—´éš™ï¼‰ä¸­è¿›è¡Œçš„æ’å…¥ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªäº‹åŠ¡å°±å¯ä»¥æŸ¥è¯¢ä¸€ä¸ªæ–°è¡Œä¾‹å¦‚ idä¸º 101ï¼›å¦‚æœéšååŒä¸€ä¸ªäº‹åŠ¡å†…æ‰§è¡Œäº†ç›¸åŒçš„ <code>SELECT</code>æ“ä½œï¼Œå°†ä¼šçœ‹åˆ°æ–°æ’å…¥çš„æ•°æ®101ï¼ˆå¹»å½±ï¼‰ä¹Ÿåœ¨è¿”å›ç»“æœä¸­ï¼Œè¿™æ ·å…¶å®è¿åäº†äº‹åŠ¡çš„éš”ç¦»åŸåˆ™</p><p>ä¸ºäº†é˜²æ­¢å¹»å½±ï¼ŒInnoDB ä½¿ç”¨äº†ä¸€ç§è¢«ç§°ä¸º next-key lockingçš„ç®—æ³•ï¼Œå³ç»“åˆäº†è®°å½•é”å’Œé—´éš™é”çš„ä¸´é”®é”ï¼›å½“æŸ¥è¯¢è¿›è¡Œæ‰«æç´¢å¼•æ—¶ï¼ŒInnoDBæä¾›äº†è¿™æ ·çš„è¡Œçº§é”ï¼Œå°†ä¼šå¯¹éœ€è¦çš„è¡Œè®¾ç½®å…±äº«æˆ–è€…æ’ä»–é”</p><p>å› æ­¤è¡Œçº§é”å®é™…ä¸Šæ˜¯ç´¢å¼•è®°å½•é”ï¼Œæ­¤å¤–ç´¢å¼•è®°å½•ä¸Šçš„ä¸‹ä¸€ä¸ªé”®é”å®šä¹Ÿä¼šå½±å“ç´¢å¼•è®°å½•ä¹‹å‰çš„é—´éš”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹ä¸€ä¸ªé”®é”æ˜¯ç´¢å¼•è®°å½•é”åŠ ä¸Šç´¢å¼•è®°å½•ä¹‹å‰é—´éš™ä¸Šçš„é—´éš™ï¼Œå¦‚æœä¸€ä¸ªä¼šè¯å¯¹ç´¢å¼•ä¸­çš„è®°å½•R æŒæœ‰å…±äº«æˆ–ç‹¬å é”ï¼Œåˆ™å¦ä¸€ä¸ªä¼šè¯æ— æ³•åœ¨ç´¢å¼•é¡ºåºä¸­ Rä¹‹å‰çš„é—´éš™ä¸­æ’å…¥æ–°çš„ç´¢å¼•è®°å½•</p><p>å½“ InnoDBæ‰«æç´¢å¼•æ—¶ï¼Œå®ƒè¿˜å¯ä»¥é”å®šç´¢å¼•ä¸­æœ€åä¸€æ¡è®°å½•ä¹‹åçš„é—´éš™ã€‚æ­£å¦‚å‰é¢çš„ä¾‹å­æ‰€å‘ç”Ÿçš„é‚£æ ·ï¼šä¸ºäº†é˜²æ­¢åœ¨id å¤§äº 100 çš„è¡¨ä¸­æ’å…¥ä»»ä½•å†…å®¹ï¼ŒInnoDB è®¾ç½®çš„é”åŒ…æ‹¬ id å€¼ 102åé¢çš„é—´éš™ä¸Šçš„é”</p><p>å¯ä»¥ä½¿ç”¨ä¸´é”®é”åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°å”¯ä¸€æ€§æ£€æŸ¥ï¼šå¦‚æœåœ¨å…±äº«æ¨¡å¼ä¸‹è¯»å–æ•°æ®ï¼Œä½†æ²¡æœ‰çœ‹åˆ°è¦æ’å…¥çš„è¡Œçš„é‡å¤é¡¹ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥å®‰å…¨åœ°æ’å…¥è¡Œï¼Œå¹¶çŸ¥é“åœ¨è¯»å–æœŸé—´åœ¨è¡Œçš„åç»­è¡Œä¸Šè®¾ç½®çš„ä¸´é”®é”å¯ä»¥é˜²æ­¢å…¶ä»–äº‹åŠ¡åŒæ—¶æ’å…¥é‡å¤é¡¹ï¼Œä¸´é”®é”å¯ä»¥é”ä½è¡¨ä¸­ä¸å­˜åœ¨çš„æ•°æ®</p><p>é—´éš™é”å¯ä»¥è¢«ç¦ç”¨ï¼Œä½†è¿™å¯èƒ½ä¼šå¯¼è‡´å¹»è¯»é—®é¢˜çš„å‡ºç°</p><h2 id="innodb-ä¸­çš„æ­»é”">InnoDB ä¸­çš„æ­»é”</h2><h3 id="æ­»é”ç¤ºä¾‹">æ­»é”ç¤ºä¾‹</h3><p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†å½“é”å®šè¯·æ±‚å¯¼è‡´æ­»é”æ—¶ï¼Œé”™è¯¯æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Œè¯¥ç¤ºä¾‹æ¶‰åŠä¸¤ä¸ªå®¢æˆ·ç«¯ï¼ŒAå’Œ B</p><ol type="1"><li><p>é¦–å…ˆï¼Œå®¢æˆ·ç«¯ A åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸€è¡Œçš„è¡¨ï¼Œç„¶åå¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨äº‹åŠ¡ä¸­ Aé€šè¿‡åœ¨å…±äº«æ¨¡å¼ä¸‹é€‰æ‹©è¡Œæ¥è·å¾—è¯¥è¡Œçš„ S é”ï¼š <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t (i <span class="type">INT</span>) ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">1.07</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t (i) <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.09</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> i <span class="operator">=</span> <span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> i    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br></pre></td></tr></table></figure></p></li><li><p>ä¸‹ä¸€æ­¥ï¼Œå®¢æˆ·ç«¯ B å¼€å¯äº‹åŠ¡ï¼Œå°è¯•ä»è¡¨ä¸­åˆ é™¤è¯¥è¡Œ<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> i <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p></li><li><p>åˆ é™¤æ“ä½œéœ€è¦ X é”ï¼Œç°çŠ¶æ˜¯æ— æ³•æˆäºˆè¯¥é”ï¼Œå› ä¸ºå®ƒä¸å®¢æˆ·ç«¯ A æŒæœ‰çš„ Sé”äº’æ–¥ï¼Œå› æ­¤è¯¥è¯·æ±‚ä¼šå‡ºç°åœ¨è¡Œå’Œå®¢æˆ·ç«¯ B å—çš„é”è¯·æ±‚é˜Ÿåˆ—ä¸­</p></li><li><p>æœ€åå®¢æˆ·ç«¯ A ä¹Ÿè¯•å›¾åˆ é™¤è¯¥è¡Œæ•°æ® <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> i <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p></li></ol><p>æ­»é”ä¹‹æ‰€ä»¥ä¼šå‡ºç°æ˜¯å› ä¸ºå®¢æˆ·ç«¯ A éœ€è¦ Xé”æ¥åˆ é™¤è¯¥è¡Œï¼Œä¸è¿‡è¯¥é”ä¸ä¼šè¢«ç­¾å‘å› ä¸ºå®¢æˆ·ç«¯ B çš„ä¸€ä¸ªè¯·æ±‚å·²ç»å·²ç»è·å–äº† Xé”å¹¶ä¸”åœ¨ç­‰å¾…å®¢æˆ·ç«¯ A é‡Šæ”¾å®ƒçš„ S é”ï¼Œä¹Ÿæ— æ³•å°† A æŒæœ‰çš„ S é”å‡çº§ä¸º Xé”ï¼Œå› ä¸ºæ­¤æ—¶ B å·²ç»æŒæœ‰äº† X é”ï¼Œæ‰€ä»¥ InnoDBä¸ºå…¶ä¸­ä¸€ä¸ªå®¢æˆ·ç«¯è¿”å›é”™è¯¯å¹¶é‡Šæ”¾å…¶é”</p><p>å®¢æˆ·ç«¯è¿”å›æ­¤é”™è¯¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found <span class="keyword">when</span> trying <span class="keyword">to</span> <span class="keyword">get</span> lock;</span><br><span class="line">try restarting transaction</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±å¯ä»¥å°†é”ç­¾å‘ç»™å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œè®©å®ƒä»è¡¨ä¸­åˆ é™¤è¯¥è¡Œ</p><h3 id="æ­»é”æ£€æµ‹">æ­»é”æ£€æµ‹</h3><p>å½“å¯ç”¨æ­»é”æ£€æµ‹ï¼ˆé»˜è®¤å¯ç”¨ï¼‰æ—¶ï¼ŒInnoDBä¼šè‡ªåŠ¨æ£€æµ‹äº‹åŠ¡æ­»é”ï¼Œå¹¶å›æ»šä¸€ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡ä»¥æ‰“ç ´æ­»é”ï¼›InnoDBè¯•å›¾é€‰æ‹©è¦å›æ»šçš„å°äº‹åŠ¡ï¼Œå…¶ä¸­äº‹åŠ¡çš„å¤§å°ç”±æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤çš„è¡Œæ•°å†³å®š</p><p>å¦‚æœ <code>InnoDB_table_locks=1</code>ï¼ˆé»˜è®¤å€¼ï¼‰å’Œ<code>autocommit=0</code>ï¼Œåˆ™ InnoDB å¯ä»¥æ„ŸçŸ¥è¡¨é”ï¼Œå¹¶ä¸”å¼•æ“ä¸Šå±‚çš„ MySQLå±‚å¯ä»¥æ„ŸçŸ¥è¡Œçº§é”ï¼›å¦åˆ™å½“æ¶‰åŠ MySQL lock TABLES è¯­å¥è®¾ç½®çš„è¡¨é”æˆ– InnoDBä»¥å¤–çš„å­˜å‚¨å¼•æ“è®¾ç½®çš„é”æ—¶ï¼ŒInnoDB æ— æ³•æ£€æµ‹åˆ°æ­»é”ï¼›é€šè¿‡è®¾ç½®<code>innodb_lock_wait_timeout</code> ç³»ç»Ÿå˜é‡çš„å€¼æ¥è§£å†³è¿™äº›æƒ…å†µ</p><p>åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸Šï¼Œå½“å¤šä¸ªçº¿ç¨‹ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œæ­»é”æ£€æµ‹å¯èƒ½ä¼šå¯¼è‡´é€Ÿåº¦å‡æ…¢ï¼›æœ‰æ—¶å½“æ­»é”å‘ç”Ÿæ—¶ï¼Œç¦ç”¨æ­»é”æ£€æµ‹å¹¶ä¾é <code>innodb_lock_wait_timeout</code>è®¾ç½®è¿›è¡Œäº‹åŠ¡å›æ»šå¯èƒ½ä¼šæ›´æœ‰æ•ˆï¼›å¯ä»¥ä½¿ç”¨<code>innodb_Deadlock_detect</code> å˜é‡ç¦ç”¨æ­»é”æ£€æµ‹</p><h3 id="å¦‚ä½•å‡å°‘å’Œè§£å†³æ­»é”">å¦‚ä½•å‡å°‘å’Œè§£å†³æ­»é”</h3><p>æ­»é”æ˜¯äº‹åŠ¡æ•°æ®åº“ä¸­çš„ä¸€ä¸ªç»å…¸é—®é¢˜ï¼Œä½†é™¤éå®ƒä»¬éå¸¸é¢‘ç¹ä»¥è‡³äºæ ¹æœ¬æ— æ³•æˆåŠŸæ‰§è¡ŒæŸäº›äº‹åŠ¡ï¼Œå¦åˆ™å®ƒä»¬å¹¶ä¸å±é™©</p><p>é€šå¸¸å¿…é¡»ç¼–å†™é€»è¾‘ç”¨äºåœ¨äº‹åŠ¡å› æ­»é”è€Œå›æ»šæ—¶ï¼Œå¯ä»¥é‡æ–°æ‰§è¡Œäº‹åŠ¡</p><p>InnoDB ä½¿ç”¨è‡ªåŠ¨è¡Œçº§é”å®šï¼ˆautomatic row-levellockingï¼‰ï¼Œæ‰€ä»¥å³ä½¿åœ¨åªæ’å…¥æˆ–åˆ é™¤ä¸€è¡Œçš„äº‹åŠ¡çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯èƒ½å‡ºç°æ­»é”ï¼›è¿™æ˜¯å› ä¸ºè¿™äº›æ“ä½œå¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŸå­â€æ“ä½œï¼›å®ƒä»¬ä¼šè‡ªåŠ¨å¯¹æ’å…¥æˆ–åˆ é™¤çš„è¡Œçš„ï¼ˆå¯èƒ½æœ‰å‡ ä¸ªï¼‰ç´¢å¼•è®°å½•è®¾ç½®é”</p><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯æ¥å¤„ç†æ­»é”å¹¶é™ä½å…¶å‘ç”Ÿçš„å¯èƒ½æ€§ï¼š</p><ul><li><p>éšæ—¶ä½¿ç”¨ <code>SHOW ENGINE INNODB STATUS</code>æŒ‡ä»¤ä»¥ç¡®å®šæœ€è¿‘æ­»é”çš„åŸå› ï¼›è¿™å¯ä»¥å¸®åŠ©è°ƒæ•´åº”ç”¨ç¨‹åºä»¥é¿å…æ­»é”</p></li><li><p>å¦‚æœé¢‘ç¹çš„æ­»é”è­¦å‘Šå¼•èµ·é—®é¢˜ï¼Œè¯·é€šè¿‡å¯ç”¨<code>innodb_print_all_deadlocks</code>å˜é‡æ¥æ”¶é›†æ›´å¹¿æ³›çš„è°ƒè¯•ä¿¡æ¯ï¼›MySQLé”™è¯¯æ—¥å¿—ä¸­è®°å½•äº†æ¯ä¸ªæ­»é”çš„ä¿¡æ¯ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ€æ–°çš„æ­»é”ï¼›è°ƒè¯•å®Œæˆåç¦ç”¨æ­¤é€‰é¡¹</p></li><li><p>å¦‚æœäº‹åŠ¡ç”±äºæ­»é”è€Œå¤±è´¥ï¼Œè¯·å§‹ç»ˆåšå¥½é‡æ–°æ‰§è¡Œäº‹åŠ¡çš„å‡†å¤‡ï¼›æ­»é”å¹¶ä¸å±é™©ï¼Œåªéœ€è¦å†è¯•ä¸€æ¬¡</p></li><li><p>ä¿æŒäº‹åŠ¡çš„è§„æ¨¡å°ä¸”æŒç»­æ—¶é—´çŸ­ï¼Œä»¥å‡å°‘å®ƒä»¬å‘ç”Ÿå†²çªçš„å¯èƒ½æ€§ï¼›å³é¿å…å¤§äº‹åŠ¡</p></li><li><p>åœ¨è¿›è¡Œä¸€ç»„ç›¸å…³æ›´æ”¹åç«‹å³æäº¤äº‹åŠ¡ï¼Œä»¥å‡å°‘å®ƒä»¬å‘ç”Ÿå†²çªçš„å¯èƒ½æ€§ï¼›ç‰¹åˆ«æ˜¯ï¼Œä¸è¦è®©äº¤äº’å¼MySQL ä¼šè¯ä¸æœªæäº¤çš„äº‹åŠ¡é•¿æ—¶é—´å¼€å¯</p></li><li><p>å¦‚æœä½¿ç”¨é”å®šè¯»ï¼ˆ<code>SELECTâ€¦FOR UPDATE</code> æˆ–<code>SELECTâ€¦LOCK IN SHARE MODE</code>ï¼‰ï¼Œè¯·å°è¯•ä½¿ç”¨è¾ƒä½çš„éš”ç¦»çº§åˆ«ï¼Œä¾‹å¦‚READ COMMITTED</p></li><li><p>å½“ä¿®æ”¹äº‹åŠ¡ä¸­çš„å¤šä¸ªè¡¨æˆ–åŒä¸€è¡¨ä¸­çš„ä¸åŒè¡Œé›†æ—¶ï¼Œæ¯æ¬¡éƒ½è¦ä»¥ä¸€è‡´çš„é¡ºåºæ‰§è¡Œè¿™äº›æ“ä½œï¼Œå¯ä»¥è®©äº‹åŠ¡çš„æ‰§è¡Œå½¢æˆå®šä¹‰è‰¯å¥½çš„é˜Ÿåˆ—ï¼Œä»è€Œé¿å…æ­»é”ï¼›å³åº”ç”¨ä¸­çš„æŒ‰ç…§è¡¨é¡ºåºã€å­—æ®µå€¼é¡ºåºæ’åº</p></li><li><p>ç²¾å¿ƒè®¾ç½®ç´¢å¼•ï¼Œé¿å…è¿‡å¤šç´¢å¼•å¯¼è‡´çš„æ­»é”ï¼›ä½¿ç”¨<code>EXPLAIN SELECT</code> æ¥ç¡®å®š MySQLæœåŠ¡å™¨è®¤ä¸ºå“ªäº›ç´¢å¼•æœ€é€‚åˆæŸ¥è¯¢</p></li><li><p>ä¸ä½¿ç”¨é”ï¼›å¦‚æœä¸šåŠ¡å¯ä»¥å…è®¸æŸ¥è¯¢ä»æ—§å¿«ç…§è¿”å›æ•°æ®ï¼Œä¸è¦ä½¿ç”¨<code>FOR UPDATE</code> æˆ– <code>LOCK IN SHARE MODE</code>å­å¥ï¼Œå¹¶ä¸”æ¨èä½¿ç”¨ READ COMMITTEDéš”ç¦»çº§åˆ«ï¼Œå› ä¸ºåŒä¸€äº‹åŠ¡ä¸­çš„æ¯ä¸ªä¸€è‡´è¯»éƒ½ä»è‡ªå·±çš„æ–°å¿«ç…§ä¸­è¯»å–</p></li><li><p>å¦‚æœä¸Šè¿°å»ºè®®æ²¡æœ‰å¸®åŠ©ï¼Œå¯ä»¥ä½¿ç”¨è¡¨çº§é”åºåˆ—åŒ–äº‹åŠ¡ï¼Œå°†<code>LOCK TABLES</code> ä¸äº‹åŠ¡æ€§è¡¨ï¼ˆå¦‚ InnoDBè¡¨ï¼‰ä¸€èµ·ä½¿ç”¨çš„æ­£ç¡®æ–¹æ³•æ˜¯ä»¥ <code>SET autocommit=0</code>ï¼ˆè€Œä¸æ˜¯<code>START transaction</code>ï¼‰å¼€å¤´ï¼Œåè·Ÿ<code>LOCK TABLES</code>ï¼Œç„¶ååœ¨æ˜¾å¼æäº¤äº‹åŠ¡ä¹‹å‰ä¸è°ƒç”¨<code>UNLOCK TABLES</code> ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨éœ€è¦å†™å…¥è¡¨ t1 å¹¶ä»è¡¨ t2è¯»å–ï¼Œåˆ™å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">LOCK TABLES t1 WRITE, t2 READ, ...;</span><br><span class="line">... do something <span class="keyword">with</span> tables t1 <span class="keyword">and</span> t2 here ...</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure><p>è¡¨çº§é”é˜²æ­¢å¯¹è¡¨è¿›è¡Œå¹¶å‘æ›´æ–°ï¼Œä»è€Œé¿å…æ­»é”ï¼Œè€Œä»£ä»·æ˜¯å¹¶å‘å“åº”èƒ½åŠ›è¾ƒä½</p></li><li><p>åºåˆ—åŒ–äº‹åŠ¡çš„å¦ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªåªåŒ…å«ä¸€è¡Œçš„è¾…åŠ©â€œä¿¡å·é‡â€ï¼ˆsemaphoreï¼‰è¡¨ï¼›åœ¨è®¿é—®å…¶ä»–è¡¨ä¹‹å‰é¦–å…ˆè®©æ¯ä¸ªäº‹åŠ¡æ›´æ–°è¯¥è¡Œï¼›è¿™æ ·æ‰€æœ‰äº‹åŠ¡éƒ½ä»¥ä¸²è¡Œæ–¹å¼å‘ç”Ÿï¼›éœ€è¦æ³¨æ„InnoDB æ­»é”æ£€æµ‹ç®—æ³•ä¹Ÿé€‚ç”¨äºè¿™ç§æƒ…å†µï¼Œå› ä¸ºåºåˆ—åŒ–é”æ˜¯è¡Œçº§é”ï¼Œå¯¹äº MySQLè¡¨çº§é”åˆ™å¿…é¡»ä½¿ç”¨ timeout æ–¹æ³•æ¥è§£å†³æ­»é”</p></li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-transaction-model.html">MySQL:: MySQL 5.7 Reference Manual :: 14.7 InnoDB Locking and TransactionModel</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DB </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Mulled Wine</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Mulled%20Wine.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Mulled%20Wine.html</url>
      
        <content type="html"><![CDATA[<img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Mulled%20Wine/Mulled%20Wine%20Recipe-1.jpg" class="" title="Mulled Wine Recipe-1"><blockquote><p><em>This traditional homemade mulled wine recipe is incredibly easyto make and always SO cozy and delicious.</em></p><p>è¿™ç§ä¼ ç»Ÿçš„è‡ªåˆ¶çƒ­è‘¡è„é…’é…æ–¹éå¸¸å®¹æ˜“åˆ¶ä½œï¼Œè€Œä¸”éå¸¸èˆ’é€‚ç¾å‘³</p></blockquote><p>åœ£è¯èŠ‚æ¥å–çƒ­çº¢é…’å§~</p><h1 id="mulled-wine-çƒ­è‘¡è„é…’">Mulled Wine çƒ­è‘¡è„é…’</h1><p>ä¹Ÿè¢«ç§°ä¸º glÃ¼hweinã€vino-calienteã€glÃ¶ggã€vinbrulÃ©ã€bisschopswijnã€vin chaudã€candolaã€vinho quenteâ€¦æˆ–è€…å…¶ä»–ä¸Šç™¾ä¸ªåå­—ï¼Œè¿™å–å†³äºä½ åœ¨ä¸–ç•Œä¸Šçš„ä½ç½®</p><p>ä¸ç”¨è¯´ä¼¼ä¹ä¸–ç•Œä¸Šå‡ ä¹æ¯ä¸ªäººéƒ½å–œæ¬¢çƒ­è‘¡è„é…’ï¼Œå¾ˆæ˜æ˜¾ï¼Œæˆ‘å¯ä»¥ä¿è¯ä½ ä»¬ä¹Ÿä¸€æ ·</p><h2 id="åŸæ–™">åŸæ–™</h2><p>é¦–å…ˆæ¥å‡†å¤‡åŸæ–™ï¼Œå¯¹äºè¿™ä¸ªçƒ­è‘¡è„é…’é…æ–¹ï¼Œéœ€è¦</p><ul><li><strong>çº¢é…’ï¼ˆWineï¼‰</strong>ï¼šæ— éœ€æŒ¥éœä¸€ç“¶æ˜‚è´µçš„è‘¡è„é…’ï¼Œåªéœ€è¦ä¸€ç“¶ä¸­ç­‰ä»·ä½çš„å¹²çº¢æˆ–ç™½è‘¡è„é…’å°±å¯ä»¥äº†ï¼ˆå¦‚æœä½ éœ€è¦åˆ¶ä½œä¸€å¤§æ‰¹ï¼Œè¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ç›’è£…è‘¡è„é…’çš„å®Œç¾åœºæ™¯~ï¼‰ï¼›æœ€å¥½çš„é€‰æ‹©æ˜¯æœå‘³æµ“éƒã€é…’ä½“é¥±æ»¡çš„è‘¡è„é…’ï¼Œè¿™æ ·å®ƒæ‰èƒ½ç»å¾—èµ·é«˜æ¸©çš„è€ƒéªŒï¼Œä¸”ä¸ä¼šè¢«é¦™æ–™çš„é¦™æ°”å®Œå…¨æ·¹æ²¡</li><li><strong>ç™½å…°åœ°ï¼ˆBrandyï¼‰</strong>ï¼šä¸æ¡‘æ ¼åˆ©äºšæ±½é…’ï¼ˆSangriaï¼‰ç±»ä¼¼ï¼Œåœ¨çƒ­è‘¡è„é…’ä¸­å¤šåŠ ä¸€ç‚¹åˆ©å£é…’ä¹Ÿæ˜¯ä¸€ç§ä¼ ç»Ÿåšæ³•ï¼›ç™½å…°åœ°æ˜¯ä¼ ç»Ÿçš„é€‰æ‹©ï¼Œä½†å›åº¦é…’ï¼ˆCointreauæˆ–å…¶ä»–æ©™å‘³åˆ©å£é…’ï¼‰æˆ–èŒ¶è‰²æ³¢ç‰¹é…’ï¼ˆTawny Portï¼‰ä¹Ÿæ˜¯ç¾å‘³çš„æ›¿ä»£å“</li><li><strong>æ–°é²œçš„æ©™å­ï¼ˆFreshorangesï¼‰</strong>ï¼šä½¿ç”¨åˆ‡ç‰‡åœ¨è‘¡è„é…’ä¸­æ…¢ç…®ï¼Œå¦‚æœæ„¿æ„å¯ä»¥åˆ‡ç‰‡å¹¶ç”¨ä½œè£…é¥°ï¼ˆä¸ºäº†å°½é‡å‡å°‘è‹¦å‘³ï¼Œå»ºè®®åœ¨å°†æ©™å­æ”¾å…¥è‘¡è„é…’ä¸­æ…¢ç…®ä¹‹å‰å°†å…¶å»çš®ï¼‰</li><li><strong>è‚‰æ¡‚ï¼ˆCinnamonï¼‰</strong>ï¼šå¦‚æœä½ æ‰‹å¤´æœ‰è‚‰æ¡‚çš„è¯ï¼Œä½ å¯ä»¥åŠ å…¥ä¸€äº›è‚‰æ¡‚ç²‰</li><li><strong>é¦™æ–™ï¼ˆMullingspicesï¼‰</strong>ï¼šå› å›½å®¶è€Œå¼‚ï¼Œä¾‹å¦‚æ•´ç“£ä¸é¦™å’Œå…«è§’èŒ´é¦™ï¼Œä¹Ÿè®¸è¿˜æœ‰ä¸€äº›è±†è”»èš</li><li><strong>ç”œå‘³å‰‚ï¼ˆSweetenerï¼‰</strong>ï¼šéšæ„æ·»åŠ å–œæ¬¢çš„ç”œå‘³å‰‚ï¼Œç³–æ˜¯æœ€ç»å…¸çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ«ç³–æµ†æˆ–èœ‚èœœæ¥è‡ªç„¶å¢ç”œ</li></ul><h2 id="åˆ¶ä½œæ­¥éª¤">åˆ¶ä½œæ­¥éª¤</h2><p>æ¥ä¸‹æ¥å¼€å§‹åˆ¶ä½œçƒ­è‘¡è„é…’ï¼Œåªéœ€</p><ol type="1"><li><strong>å°†åŸæ–™æ··åˆ</strong>ï¼šå°†æ‰€æœ‰çš„ææ–™æ”¾åœ¨ç…®é”…ä¸­æ…æ‹Œå‡åŒ€</li><li><strong>æ…¢ç…®</strong>ï¼šç”¨ä¸­é«˜ç«åŠ çƒ­ï¼Œç›´åˆ°è‘¡è„é…’å‡ ä¹è¾¾åˆ°æ–‡ç«æ…¢ç…®çš„ç¨‹åº¦ï¼ˆé¿å…èµ·æ³¡ï¼›é…’ç²¾åœ¨172Â°F / 77.8Â°Cæ—¶å¼€å§‹è’¸å‘ï¼Œæ‰€ä»¥è¦å°å¿ƒç¡®ä¿è‘¡è„é…’ä¸ä¼šè’¸å‘ï¼‰å°†ç«è°ƒè‡³å°ç«ï¼Œå®Œå…¨ç›–ä¸Šç›–å­ï¼Œè®©è‘¡è„é…’æ…¢ç…®è‡³å°‘15 åˆ†é’Ÿæœ€å¤š 3 å°æ—¶</li><li><strong>è¿‡æ»¤å’Œè°ƒå‘³</strong>ï¼šç”¨ç»†ç½‘æ»¤å»å¹¶ä¸¢å¼ƒæ©™å­ç‰‡ã€ä¸é¦™ã€è‚‰æ¡‚æ£’ã€å…«è§’èŒ´é¦™å’Œç”Ÿå§œç­‰ææ–™ï¼›å“å°ä¸€ä¸‹çƒ­è‘¡è„é…’ï¼Œå¦‚æœéœ€è¦å¯ä»¥åŠ å…¥æƒ³è¦çš„é¢å¤–ç”œå‘³å‰‚</li><li><strong>å®Œæˆ</strong>ï¼šè£…åœ¨çƒ­çš„æ¯å­é‡Œï¼Œä¸Šé¢æ”¾ä¸Šå–œæ¬¢çš„è£…é¥°</li></ol><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Mulled%20Wine/Mulled%20Wine%20Recipe-2.jpg" class="" title="Mulled Wine Recipe-2"><h2 id="å®šåˆ¶å˜åŒ–">å®šåˆ¶å˜åŒ–</h2><p>æƒ³å®šåˆ¶ä¸€ä¸‹è¿™æ¬¾çƒ­è‘¡è„é…’å—ï¼Ÿè¯·éšæ„</p><ul><li><strong>ç™½è‘¡è„é…’</strong>ï¼šç”¨å¹²ç™½è‘¡è„é…’åˆ¶ä½œçš„çƒ­è‘¡è„ä¹Ÿéå¸¸ç¾å‘³</li><li><strong>å°åº¦èŒ¶åŒ…ï¼ˆChai TeaBagï¼‰</strong>ï¼šç”¨äºä»£æ›¿ä¸é¦™å’Œå…«è§’ï¼Œå¯ä»¥éšæ„å°† 1 åˆ° 2ä¸ªå°åº¦èŒ¶åŒ…æµ¸æ³¡åœ¨çƒ­è‘¡è„é…’ä¸­ï¼ˆå¦‚æœæ™šä¸Šæ¥å–ï¼Œæœ€å¥½ä½¿ç”¨ä¸å«å’–å•¡å› çš„ï¼‰</li><li><strong>ä¸åŒçš„é¦™æ–™</strong>ï¼šéšæ„æ·»åŠ ä»»ä½•å¬èµ·æ¥æœ‰è¶£çš„é¦™æ–™ï¼Œæ¯”å¦‚æ–°é²œçš„å§œç‰‡ã€è±†è”»èšã€è‚‰è±†è”»ã€ç™¾é¦™æœæˆ–æŸ æª¬çš®æ˜¯å…¶ä»–ä¸€äº›ä¸é”™çš„é¦™æ–™</li><li><strong>è£…é¥°</strong>ï¼šå¯ä»¥è¥é€ èŠ‚æ—¥æ°”æ°›ï¼Œå¯ä»¥åœ¨å‡ºé”…å‰å‡ åˆ†é’Ÿæ’’ä¸Šä¸€äº›æ–°é²œçš„è”“è¶Šè“</li><li><strong>æ…¢ç…®é”…ï¼ˆCrockPotï¼‰</strong>ï¼šä¹Ÿå¯ä»¥å°è¯•ä½¿ç”¨æ…¢ç…®é”…è®¾ç½®ä½æ¸©æ¥åˆ¶ä½œçƒ­è‘¡è„é…’ï¼Œä¸è¿‡éœ€è¦æ˜ç¡®åœ°æé†’å¤§å®¶ï¼Œå½“æ¶‰åŠåˆ°å‚å®¶è®¤ä¸ºçš„â€œä½â€æ¸©åº¦æ—¶ï¼Œæ…¢ç…®é”…çš„é…ç½®å¯ä»¥è¦†ç›–æ‰€æœ‰æ¸©åº¦èŒƒå›´ï¼ˆæ„æ€å°±æ˜¯ä½æ¸©æ ¹æœ¬ä¸ä½å‘—ï¼‰ï¼›å› æ­¤å¦‚æœä½¿ç”¨æ…¢ç…®é”…ï¼Œä¸€å®šè¦å¯†åˆ‡å…³æ³¨å®ƒçš„çŠ¶æ€ï¼Œç¡®ä¿è‘¡è„é…’ä¸ä¼šé­é‡é«˜æ¸©</li></ul><h1 id="æ„Ÿè°¢">æ„Ÿè°¢</h1><p><a href="https://www.gimmesomeoven.com/mulled-wine-recipe/">MulledWine Recipe | Gimme Some Oven</a></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LLM ä¿¡æ¯æå–ç»“æ„åŒ–è¾“å‡º</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LLM%20%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LLM%20%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>çœ‹äº†æ–°ä¸€æœŸçš„é˜®ä¸€å³°å‘¨åˆŠï¼Œå¼•ç”¨äº†ä¸€ç¯‡åšå®¢ <em>Information Extractionwith Large Language Models - Parsing Unstructured Data withGPT-3</em></p><p><ahref="https://marcotm.com/articles/information-extraction-with-large-language-models-parsing-unstructured-data-with-gpt/">InformationExtraction with Large Language Models - Parsing Unstructured Data withGPT-3 (marcotm.com)</a></p><blockquote><p>In the past months, ChatGPT has been dominating the news headlines,and people are both excited and scared by its quite sophisticatedability to generate texts. Besides short- and long-form text generation,there are quite a few other use cases which provide a lot of practicalvalue. With the current generation of these large language models(LLMs), many of the classic tasks in Natural Language Processing (NLP)such as text classification, sentiment analysis, or named entityrecognition, are almost trivial to solve.</p><p>åœ¨è¿‡å»çš„å‡ ä¸ªæœˆé‡Œï¼ŒChatGPTä¸€ç›´å æ®ç€æ–°é—»å¤´æ¡ï¼Œäººä»¬å¯¹å®ƒç›¸å½“å¤æ‚çš„æ–‡æœ¬ç”Ÿæˆèƒ½åŠ›æ—¢å…´å¥‹åˆå®³æ€•ï¼Œé™¤äº†ç”ŸæˆçŸ­æ ¼å¼å’Œé•¿æ ¼å¼æ–‡æœ¬å¤–ï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–ç”¨ä¾‹æä¾›äº†å¾ˆå¤§çš„å®ç”¨ä»·å€¼</p><p>éšç€è¿™äº›å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å‡ºç°ï¼Œè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ä¸­çš„è®¸å¤šç»å…¸ä»»åŠ¡ï¼Œå¦‚æ–‡æœ¬åˆ†ç±»ã€æƒ…æ„Ÿåˆ†ææˆ–å‘½åå®ä½“è¯†åˆ«ï¼Œå‡ ä¹éƒ½å¾ˆéš¾è§£å†³</p><p>In this article, I have documented some experimentation with how touse GPT-3 (<em>update: and 3.5</em>) to extract structured informationfrom unstructured texts and I hope the article can serve as a tutorialfor how to approach such a task with an LLM.</p><p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è®°å½•äº†ä¸€äº›å…³äºå¦‚ä½•ä½¿ç”¨ GPT-3ï¼ˆæ›´æ–°ï¼šå’Œ3.5ï¼‰ä»éç»“æ„åŒ–æ–‡æœ¬ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯çš„å®éªŒï¼Œæˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯ä»¥ä½œä¸ºå¦‚ä½•ä½¿ç”¨LLM å¤„ç†æ­¤ç±»ä»»åŠ¡çš„æ•™ç¨‹</p></blockquote><p>ä½œè€…ç»´æŠ¤äº†ä¸€ä¸ªæ‹›è˜ç½‘ç«™ï¼Œä½†æ˜¯æ‹›è˜ä¿¡æ¯æ˜¯ä»¥éç»“æ„åŒ–æ–‡æœ¬å½¢å¼è¿›è¡ŒæŠ•é€’ï¼Œä½œè€…å¸Œæœ›å°†å…¶é‡è¦ä¿¡æ¯æå–å‡ºæ¥ï¼Œç»´æŠ¤æ•°æ®åç”¨æˆ·å¯ä»¥é€šè¿‡ç›¸å…³æ€§è¿›è¡ŒæŸ¥è¯¢</p><blockquote><p>With about 500 job posts per month, some of them advertising multipleroles, we end up with over 1000 jobs per month. As you can see on the <ahref="https://www.hacker-jobs.com/">site</a>, there are several filterssuch as "remote", "part-time", etc. which allow you to narrow down thechoices based on some general characteristics.</p><p>æ¯æœˆçº¦æœ‰ 500ä¸ªæ‹›è˜ä¿¡æ¯ï¼Œå…¶ä¸­ä¸€äº›ä¿¡æ¯åŒ…å«å¤šä¸ªèŒä½çš„å†…å®¹ï¼Œå³æˆ‘ä»¬æœ€ç»ˆæ¯æœˆæœ‰ 1000å¤šä¸ªèŒä½</p><p>æ­£å¦‚ä½ åœ¨ç½‘ç«™ä¸Šçœ‹åˆ°çš„ï¼Œæœ‰å‡ ä¸ªè¿‡æ»¤å™¨ï¼Œå¦‚â€œè¿œç¨‹â€ã€â€œå…¼èŒâ€ç­‰ï¼Œå…è®¸ä½ æ ¹æ®ä¸€äº›ä¸€èˆ¬ç‰¹å¾ç¼©å°é€‰æ‹©èŒƒå›´</p><p>However, a job board usually also offers to select a certain jobcategory (e.g., "iOS developer"). Since the "Who is hiring" threads arenot limited to certain types of jobs and often there are interestingroles that might not fit into the usual categories, I tried a differentapproach for how to sort the jobs according to one's interests: For eachjob, a text embedding for the job description (including the companydescription) is created, which then can be used to sort by similarity toa selected job.</p><p>ç„¶è€Œï¼Œæ‹›è˜å§”å‘˜ä¼šé€šå¸¸ä¹Ÿä¼šæä¾›é€‰æ‹©ç‰¹å®šçš„å·¥ä½œç±»åˆ«ï¼ˆä¾‹å¦‚ï¼Œâ€œiOSå¼€å‘è€…â€ï¼‰</p><p>ç”±äºâ€œè°åœ¨æ‹›è˜â€ä¸»é¢˜å¹¶ä¸å±€é™äºæŸäº›ç±»å‹çš„å·¥ä½œï¼Œè€Œä¸”é€šå¸¸æœ‰ä¸€äº›æœ‰è¶£çš„è§’è‰²å¯èƒ½ä¸å±äºé€šå¸¸çš„ç±»åˆ«ï¼Œæˆ‘å°è¯•äº†ä¸€ç§ä¸åŒçš„æ–¹æ³•æ¥æ ¹æ®ä¸ªäººçš„å…´è¶£å¯¹å·¥ä½œè¿›è¡Œæ’åºï¼šå¯¹äºæ¯ä¸ªå·¥ä½œï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªembeddingå·¥ä½œæè¿°ï¼ˆåŒ…æ‹¬å…¬å¸æè¿°ï¼‰çš„æ–‡æœ¬ï¼Œå…¶ç„¶åå¯ä»¥ç”¨äºæ ¹æ®ä¸æ‰€é€‰ä½œä¸šçš„ç›¸ä¼¼æ€§è¿›è¡Œæ’åº</p></blockquote><p>è¿™é‡Œå°±æ¥ä½“éªŒä¸‹ä½œè€…å¯¹äº LLMï¼ˆGPT-3.5ï¼‰è§£ææ–‡æœ¬è¾“å‡ºç»“æ„åŒ–ä¿¡æ¯çš„promptï¼Œä»¥åŠå°è¯•ä½¿ç”¨ LangChain è¿›è¡Œå®ç°</p><h1 id="åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</h1><p>ä»¥ä¸‹æ˜¯ä½œè€…åˆ¶ä½œå‡ºè¿™ä¸€ Prompt çš„ä¸»è¦æƒ³æ³•å’Œè§‚å¯Ÿç»“æœï¼š</p><ul><li>æç¤ºé¦–å…ˆæè¿°åŸºæœ¬ä»»åŠ¡<code>turn unstructured job posting [..] into a JSON</code></li><li>æé†’ä¸€åˆ™æ‹›è˜ä¿¡æ¯å¯ä»¥åŒ…æ‹¬å¤šä¸ªè§’è‰²æˆ–èŒä½</li><li>è¯¦ç»†æè¿°äº†æ‰€éœ€çš„è¾“å‡ºæ ¼å¼ï¼›å¯¹äºæ¯ä¸ªå­—æ®µï¼ŒæŒ‡å®šå­—æ®µåç§°å’Œå­—æ®µç±»å‹</li><li>å¯¹äºæŸäº›å­—æ®µç»™å‡ºäº†é¢å¤–çš„æç¤ºï¼Œè¿™äº›æç¤ºå¤§å¤šæ¥è‡ªè§‚å¯Ÿåˆ°çš„é”™è¯¯æ¡ˆä¾‹æˆ–ä¸è‰¯è¡Œä¸ºï¼›ä¾‹å¦‚ï¼Œè§’è‰²æœ‰æ—¶ä»¥å•æ•°å½¢å¼ä¹¦å†™ï¼Œæœ‰æ—¶ä»¥å¤æ•°å½¢å¼ä¹¦å†™ï¼ŒåŸå§‹æç¤ºé€å­—å¤åˆ¶ï¼Œä½†å¸Œæœ›LLM å¯ä»¥å°†å…¶æ ‡å‡†åŒ–</li><li>è®© LLM æ¸…æ¥šå¦‚æœæ²¡æœ‰æ˜ç¡®ä¿¡æ¯ï¼Œå¯ä»¥å°†å­—æ®µè®¾ç½®ä¸º <code>null</code></li><li>åœ¨ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹èŒä½ä¼šè¢«åˆ—å‡ºä¸¤æ¬¡ï¼Œæ²¡æœ‰ä»»ä½•å·®å¼‚ï¼›åŸå› æ˜¯è¯¥æ‹›è˜ä¿¡æ¯å†…å®¹ä¸ºè¯¥å…¬å¸æ­£åœ¨å¯»æ‰¾ä¸¤åå¼€å‘ï¼Œå› æ­¤æ·»åŠ äº†æŒ‡ä»¤ï¼ŒåªåŒ…å«äº†ä¸€æ¬¡å®Œå…¨è§£å†³é—®é¢˜çš„éœ€æ±‚</li><li>åœ¨è¯´æ˜ä¹‹åï¼Œæ·»åŠ åŸå§‹çš„æ‹›è˜ä¿¡æ¯</li><li>ç„¶åå£°æ˜è¾“å‡ºä½¿ç”¨ JSON æ ¼å¼</li><li>åœ¨çœ‹åˆ°çš„ä¸€ä¸ªæŠ€å·§æ˜¯ç”¨```<code>json</code>ï¼Œè¿™æ˜¯ä¸€äº›æ ‡è®°è¯­è¨€åœ¨æ–‡æ¡£ä¸­åŒ…å«ä»£ç å’Œç±»ä¼¼æ–‡æœ¬çš„å…¸å‹æ–¹å¼</li><li>æœ€åè¿˜ç¼–å†™äº†åº”è¯¥å®Œæˆçš„å®é™… JSON çš„ç¬¬ä¸€éƒ¨åˆ†</li></ul><h1 id="å‚æ•°">å‚æ•°</h1><p>ä½œè€…è®¤ä¸ºå¯¹äºè¿™ç§ä»»åŠ¡ï¼Œä¸å¸Œæœ›æ¨¡å‹å˜å¾—æœ‰åˆ›é€ æ€§</p><p>å› æ­¤ä½¿ç”¨äº†ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>Temperatureï¼š0</li><li>Maximumï¼š4000 - <length_of_the_prompt></li><li>Stop sequencesï¼š```</li><li>Top Pï¼š0.1</li><li>Frequency penaltyï¼š0</li><li>Presence penaltyï¼š0</li></ul><h1 id="prompt">Prompt</h1><p>æ–‡ç« ä¸­ä½œè€…è¯´æ˜äº† GPT-3.5 æ˜¯åŸºäºèŠå¤©çš„æ¨¡å‹ï¼Œæ‰€ä»¥å¯¹ Promptè¿›è¡Œäº†ä¸€äº›å¾®è°ƒ</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Your task is to parse an unstructured job posting and turn it into a JSON containing the most important information. The job posting can describe one or more jobs at the same company. The JSON should consist of the following information:</span><br><span class="line"> - The company name (field name: &quot;companyName&quot;, field type: string)</span><br><span class="line"> - the location of the company (field name: &quot;companyLocation&quot;, field type: string); if not explictily stated, you can try to infer the company&#x27;s actual location from other clues, e.g., something like &quot;Remote (US)&quot; usually means that the company is located in the US; if the location cannot be inferred, set it to null</span><br><span class="line"> - a short description of what the company is doing or building (field name: &quot;companyDescription&quot;, field type: string); try to keep it short (max length: ca. 300 characters)</span><br><span class="line"> - a list of advertised jobs (field name: &quot;jobs&quot;, field type: array).</span><br><span class="line">Each element of the &quot;jobs&quot; array should contain the following fields:</span><br><span class="line"> - The job title (field name: &quot;jobTitle&quot;, field type: string); the job title should be given in the singular form (i.e., Frontend Developer instead of Frontend Developers)</span><br><span class="line"> - the salary range (field name: &quot;salary&quot;, field type: string); only include explictly stated salary amounts, otherwise set to null</span><br><span class="line"> - whether equity is part of the compensation (field name: &quot;equity&quot;, field type: boolean)</span><br><span class="line"> - the benefits (field name: &quot;benefits&quot;, field type: string); include things like 401k, insurance, equipment, child care, etc. if stated, otherwise set to null</span><br><span class="line"> - the location of the job (field name: &quot;location&quot;, field type: string)</span><br><span class="line"> - whether this is a job for senior/experienced candidates (field name: &quot;senior&quot;, field type: boolean); typically senior, staff, lead, principal, vp, cto, etc. positions are all regarded as senior level</span><br><span class="line"> - whether it is a remote opportunity (field name: &quot;remote&quot;, field type: boolean)</span><br><span class="line"> - whether it can be done onsite from an office (field name: &quot;onsite&quot;, field type: boolean)</span><br><span class="line"> - whether it can be done part-time (field name: &quot;partTime&quot;, field type: boolean)</span><br><span class="line"> - whether it can be done full-time (field name: &quot;fullTime&quot;, field type: boolean)</span><br><span class="line"> - the URL to the specific job description (field name: &quot;jobUrl&quot;, field type: string)</span><br><span class="line"> - and any specific requirements/skills that might be stated (field name: &quot;requirements&quot;, field type: string).</span><br><span class="line">In general, if certain information is not stated, set the respective field to null. If the company seeks more than one person for the same role, include the role only once. Please output only the pure JSON representation. Do not include any explanations, comments, thoughts, etc. The output has to be a valid JSON object which can be parsed as is.</span><br><span class="line"></span><br><span class="line">This is the job posting:</span><br><span class="line"></span><br><span class="line">%s</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ„Ÿè§‰ Azure å¯¹äºä¸­æ–‡çš„æ”¯æŒæ¯”è¾ƒå¥½ï¼Œè¿™é‡Œæˆ‘è°ƒæ•´æˆäº†ä¸­æ–‡ï¼Œå¹¶ä¸”ä½¿ç”¨LangChain å·¥å…·è¿›è¡Œ Prompt çš„ç»„è£…</p><p><strong>Prompt ç»„è£…</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;&quot;&quot;æ‚¨çš„ä»»åŠ¡æ˜¯è§£æä¸€ä¸ªéç»“æ„åŒ–çš„æ‹›è˜ä¿¡æ¯ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºåŒ…å«æœ€é‡è¦ä¿¡æ¯çš„ JSON</span></span><br><span class="line"><span class="string">èŒä½å‘å¸ƒå¯ä»¥æè¿°åŒä¸€å…¬å¸çš„ä¸€ä¸ªæˆ–å¤šä¸ªèŒä½ï¼›JSON åº”åŒ…å«ä»¥ä¸‹ä¿¡æ¯</span></span><br><span class="line"><span class="string">- å…¬å¸åç§°ï¼ˆå­—æ®µåç§°ï¼šcompanyNameï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line"><span class="string">- å…¬å¸çš„ä½ç½®ï¼ˆå­—æ®µåç§°ï¼šcompanyLocationï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰ï¼›å¦‚æœæ²¡æœ‰æ˜ç¡®è¯´æ˜ï¼Œä½ å¯ä»¥å°è¯•ä»å…¶ä»–çº¿ç´¢æ¨æ–­å…¬å¸çš„å®é™…ä½ç½®ï¼Œä¾‹å¦‚ï¼Œåƒâ€œè¿œç¨‹ï¼ˆç¾å›½ï¼‰â€è¿™æ ·çš„è¯é€šå¸¸æ„å‘³ç€å…¬å¸ä½äºç¾å›½ï¼›å¦‚æœæ— æ³•æ¨æ–­ä½ç½®ï¼Œè¯·å°†å…¶è®¾ç½®ä¸º null</span></span><br><span class="line"><span class="string">- å…¬å¸æ­£åœ¨åšä»€ä¹ˆæˆ–æ­£åœ¨å»ºè®¾ä»€ä¹ˆçš„ç®€çŸ­æè¿°ï¼ˆå­—æ®µåï¼šcompanyDescriptionï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰ï¼›å°½é‡ä¿æŒçŸ­ï¼ˆæœ€å¤§é•¿åº¦ï¼šçº¦ 300 ä¸ªå­—ç¬¦ï¼‰</span></span><br><span class="line"><span class="string">- æ‹›è˜å¹¿å‘Šçš„èŒä½æ¸…å•ï¼ˆå­—æ®µåï¼šjobsï¼Œå­—æ®µç±»å‹ï¼šæ•°ç»„ï¼‰</span></span><br><span class="line"><span class="string">jobs æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½åº”åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</span></span><br><span class="line"><span class="string">- èŒåŠ¡ï¼ˆå­—æ®µåç§°ï¼šjobTitleï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰ï¼›èŒä½åç§°åº”ä»¥å•æ•°å½¢å¼ç»™å‡ºï¼ˆå³ï¼Œå‰ç«¯å¼€å‘äººå‘˜è€Œéå‰ç«¯å¼€å‘äººå‘˜ï¼‰</span></span><br><span class="line"><span class="string">- è–ªèµ„èŒƒå›´ï¼ˆå­—æ®µåç§°ï¼šsalaryï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰ï¼›ä»…åŒ…æ‹¬æ˜ç¡®è¯´æ˜çš„å·¥èµ„é‡‘é¢ï¼Œå¦åˆ™è®¾ç½®ä¸º null</span></span><br><span class="line"><span class="string">- è‚¡æƒæ˜¯å¦æ˜¯è¡¥å¿çš„ä¸€éƒ¨åˆ†ï¼ˆå­—æ®µåç§°ï¼šequityï¼Œå­—æ®µç±»å‹ï¼šå¸ƒå°”å€¼ï¼‰</span></span><br><span class="line"><span class="string">- å…¬å¸ç¦åˆ©ï¼ˆå­—æ®µåç§°ï¼šbenefitsï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰ï¼›åŒ…æ‹¬å…»è€é‡‘ã€ä¿é™©ã€è®¾å¤‡ã€å„¿ç«¥ä¿è‚²ã€å¹´å‡ç­‰ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜åˆ™è®¾ç½®ä¸º null</span></span><br><span class="line"><span class="string">- å·¥ä½œåœ°ç‚¹ï¼ˆå­—æ®µåï¼šlocationï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line"><span class="string">- è¿™æ˜¯å¦æ˜¯ä¸€ä»½é€‚åˆèµ„æ·±/æœ‰ç»éªŒçš„å€™é€‰äººçš„å·¥ä½œï¼ˆå­—æ®µåç§°ï¼šseniorï¼Œå­—æ®µç±»å‹ï¼šå¸ƒå°”å€¼ï¼‰ï¼›é€šå¸¸ï¼Œé«˜çº§ã€èŒå‘˜ã€é¢†å¯¼ã€æ ¡é•¿ã€å‰¯æ€»è£ã€é¦–å¸­æŠ€æœ¯å®˜ç­‰èŒä½éƒ½è¢«è§†ä¸ºé«˜çº§èŒä½</span></span><br><span class="line"><span class="string">- æ˜¯å¦ä¸ºè¿œç¨‹åŠå…¬ï¼ˆå­—æ®µåç§°ï¼šremoteï¼Œå­—æ®µç±»å‹ï¼šå¸ƒå°”å€¼ï¼‰</span></span><br><span class="line"><span class="string">- æ˜¯å¦å¯ä»¥å…¼èŒï¼ˆå­—æ®µåï¼špartTimeï¼Œå­—æ®µç±»å‹ï¼šå¸ƒå°”å€¼ï¼‰</span></span><br><span class="line"><span class="string">- ç‰¹å®šä½œä¸šæè¿°çš„URLï¼ˆå­—æ®µåï¼šjobUrlï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line"><span class="string">- ä»¥åŠå¯èƒ½è¯´æ˜çš„ä»»ä½•ç‰¹å®šè¦æ±‚/æŠ€èƒ½ï¼ˆå­—æ®µåç§°ï¼šrequirementsï¼Œå­—æ®µç±»å‹ï¼šå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line"><span class="string">é€šå¸¸ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜æŸäº›ä¿¡æ¯ï¼Œè¯·å°†ç›¸åº”çš„å­—æ®µè®¾ç½®ä¸º null</span></span><br><span class="line"><span class="string">å¦‚æœå…¬å¸ä¸ºåŒä¸€èŒä½å¯»æ‰¾å¤šä¸ªäººï¼Œåˆ™åªåŒ…æ‹¬è¯¥èŒä½ä¸€æ¬¡</span></span><br><span class="line"><span class="string">è¯·ä»…è¾“å‡ºçº¯ JSON è¡¨ç¤º</span></span><br><span class="line"><span class="string">ä¸åŒ…æ‹¬ä»»ä½•è§£é‡Šã€è¯„è®ºã€æƒ³æ³•ç­‰</span></span><br><span class="line"><span class="string">è¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å¯¹è±¡ï¼Œå¯ä»¥æŒ‰åŸæ ·è§£æ</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line">human_template = <span class="string">&quot;è¿™æ˜¯æ‹›è˜ä¿¡æ¯ï¼š\n&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br></pre></td></tr></table></figure><p><strong>æ‹›è˜ä¿¡æ¯å­˜å‚¨åœ¨ txt æ–‡ä»¶</strong></p><p>è¿™é‡Œç›´æ¥ä½¿ç”¨äº†é˜®ä¸€å³°åšå®¢â€œè°åœ¨æ‹›äººâ€å¹¿å‘Šä¸­çš„æ‹›è˜ä¿¡æ¯ï¼›å…·ä½“å†…å®¹å¯ä»¥æŸ¥çœ‹</p><p><ahref="https://github.com/ruanyf/weekly/issues/3684">è°åœ¨æ‹›äººï¼Ÿï¼ˆ2023å¹´12æœˆï¼‰Â· Issue #3684 Â· ruanyf/weekly (github.com)</a></p><p>è¿™é‡Œéšä¾¿é€‰å–ä¸€ä¸ª</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ã€æ­å·ã€‘ç½‘æ˜“äº‘éŸ³ä¹</span><br><span class="line">æœ‰æ„å‘çš„åŒå­¦å¯è”ç³» semanwmj@gmail.com</span><br><span class="line"></span><br><span class="line">èµ„æ·±å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ</span><br><span class="line">èŒä½æè¿°</span><br><span class="line">è´Ÿè´£äº‘éŸ³ä¹ç¤¾äº¤ç›´æ’­çš„å‰ç«¯å¼€å‘å·¥ä½œã€‚</span><br><span class="line">å‚ä¸å„ç±»å‹é¡¹ç›®ï¼ˆWeb&amp;Webviewã€ä¸­åå°ç³»ç»Ÿã€æ··åˆåº”ç”¨ã€å°ç¨‹åºã€åˆ›æ„æ´»åŠ¨åŠæ¸¸æˆï¼‰çš„å‰ç«¯å¼€å‘å·¥ä½œï¼Œå®Œæˆç³»ç»Ÿè®¾è®¡ã€æŠ€æœ¯é€‰å‹ã€æ¨¡å—å¼€å‘å·¥ä½œã€‚</span><br><span class="line">ä»¥ä¸æ–­æå‡è´¨é‡ã€æ•ˆç‡ã€ä½“éªŒä¸ºç›®çš„ï¼Œå°è£…ç»„ä»¶ã€æ²‰æ·€æ–‡æ¡£ã€ç”Ÿäº§å·¥å…·ã€æ­å»ºç³»ç»Ÿ, äº«å—å·¥ç¨‹å¸ˆçš„æ—¥å¸¸ã€‚</span><br><span class="line">åˆ†äº«è‡ªå·±æ—¥å¸¸çš„æ‰€è§æ‰€æƒ³ï¼Œå¼•å¯¼åŒäº‹å…±åŒæˆé•¿ï¼Œè¥é€ ç§¯æå¥åº·çš„æŠ€æœ¯æ°›å›´ã€‚</span><br><span class="line">...</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»„è£… chain</span></span><br><span class="line">chain = LLMChain(</span><br><span class="line">    llm=chat_model,</span><br><span class="line">    prompt=chat_prompt</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–æ–‡ä»¶</span></span><br><span class="line">file_path = <span class="string">&quot;../content.txt&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    content = file.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œ</span></span><br><span class="line">result = chain.run(content)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong></p><p>LLM è¾“å‡ºçš„ JSON æ ¼å¼çš„ç»“æœ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ç½‘æ˜“äº‘éŸ³ä¹&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyLocation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ­å·&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyDescription&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ç½‘æ˜“äº‘éŸ³ä¹æ˜¯ä¸€å®¶ä½äºæ­å·çš„éŸ³ä¹å…¬å¸ï¼Œä¸“æ³¨äºç¤¾äº¤ç›´æ’­å’ŒéŸ³ä¹é¢†åŸŸçš„å‰ç«¯å¼€å‘å·¥ä½œã€‚&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;jobs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;jobTitle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;èµ„æ·±å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;equity&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;benefits&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ­å·&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;senior&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;remote&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;partTime&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;jobUrl&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requirements&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ç²¾é€šå„ç§ Web å‰ç«¯æŠ€æœ¯å’Œæ ‡å‡†(Javascriptã€HTMLã€CSS)ï¼Œç†Ÿæ‚‰é¡µé¢å¸ƒå±€å¸¸ç”¨è§£å†³æ–¹æ¡ˆï¼Œå¯¹è¡¨ç°ä¸æ•°æ®åˆ†ç¦»ã€Webè¯­ä¹‰åŒ–ç­‰æœ‰æ·±åˆ»ç†è§£ã€‚ç†Ÿç»ƒæŒæ¡ä¸€ä¸ªæ•°æ®é©±åŠ¨è§†å›¾çš„æ¡†æ¶ï¼ˆ Reactã€Sevlteã€Solidã€Vueï¼‰ã€‚ç†Ÿç»ƒæŒæ¡å¸¸ç”¨çš„å‰ç«¯æ„å»ºå·¥å…·ï¼ˆWebpackã€Vite ç­‰ï¼‰ï¼Œå¹¶å…·æœ‰æˆç†Ÿçš„æ¨¡å—åŒ–å¼€å‘æ€ç»´ã€‚ç†Ÿæ‚‰å¸¸ç”¨å‰ç«¯æ•°æ®ç®¡ç†çš„è§£å†³æ–¹æ¡ˆï¼ˆå¦‚ Reduxã€Zustandã€Jotai ç­‰ï¼‰ï¼Œå¹¶æ¸…æ¥šå®ƒä»¬çš„ä¼˜åŠ£å’Œåº”ç”¨åœºæ™¯ã€‚ç†Ÿæ‚‰ HTTP åè®®ï¼Œå¹¶æŒæ¡ç›¸å…³ç½‘ç»œè°ƒè¯•å·¥å…·ï¼Œæœ‰æœåŠ¡ç«¯å¼€å‘çš„èƒŒæ™¯å¸¸è¯†ã€‚å¯¹é‡å¤æ€§æˆ–ä¸è§„èŒƒçš„å·¥ä½œå®¹å¿åº¦ä½ï¼Œèƒ½è‡ªå‘é€š è¿‡æ²Ÿé€šæˆ–æŠ€æœ¯æ‰‹æ®µè§£å†³ã€‚&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="langchain-pydantic-è§£æå™¨">LangChain Pydantic è§£æå™¨</h1><p>ä¸Šé¢å·²ç»ä½¿ç”¨ LangChain ç®¡ç†äº† LLMã€Promptï¼Œä¸å¦‚ç›´æ¥åº”ç”¨ Pydanticè§£æå™¨æ¥ç›´æ¥è§£ææˆç»“æ„åŒ–çš„æ•°æ®</p><p>å¥½å¤„æ˜¯å®šä¹‰å¥½ç»“æ„åï¼ŒLangChainé»˜è®¤å¯ä»¥ç”Ÿæˆä¸€å¥—å¯¹äºç»“æ„åŒ–è¾“å‡ºçš„æç¤ºï¼Œå³<code>get_format_instructions</code> æ–¹æ³•</p><p><strong>ç»“æ„å®šä¹‰</strong></p><p>è¿™é‡Œä½¿ç”¨ Pydantic å®šä¹‰ç»“æ„ï¼Œå¯¹åº”ä¸Šé¢çš„ Prompt</p><ul><li>å­—æ®µåã€æ•°æ®ç±»å‹è¿›è¡Œå¯¹åº”ï¼Œå…¶ä¸­ <code>jobs</code> çš„ç±»å‹ä¸ºæ–°å®šä¹‰çš„<code>Job</code> ç»“æ„</li><li>æè¿°ä¸­æ‹†åˆ†å‡º title å’Œdescriptionï¼›å¯¹äºæ— æ³•å®šä¹‰å‡ºåŒºåˆ«çš„å­—æ®µï¼Œå°±ä½¿ç”¨åŒæ ·çš„å€¼ï¼ˆä¾‹å¦‚<code>è‚¡æƒæ˜¯å¦æ˜¯è¡¥å¿çš„ä¸€éƒ¨åˆ†</code>ï¼‰</li><li>ä¸ºäº†çœäº‹ï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½å£°æ˜äº†å…è®¸ä¸ºNoneï¼›å…¶å®è¿™ä¸ªå¯ä»¥ç»“åˆå®é™…éœ€æ±‚è¿›è¡Œå¼ºæ ¡éªŒï¼Œä¸é€šè¿‡å¾€å¾€è¯´æ˜æ‹›è˜ä¿¡æ¯å†…å®¹ç¡®å®ï¼ˆä¾‹å¦‚æ¢å…¬å¸åç§°ã€å…¬å¸ä½ç½®ç­‰åº”è¯¥æ˜¯å¿…å¡«é¡¹ï¼‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Job</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    jobTitle: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;èŒåŠ¡&quot;</span>, description=<span class="string">&quot;èŒä½åç§°åº”ä»¥å•æ•°å½¢å¼ç»™å‡ºï¼ˆå³ï¼Œå‰ç«¯å¼€å‘äººå‘˜è€Œéå‰ç«¯å¼€å‘äººå‘˜ï¼‰&quot;</span>)</span><br><span class="line">    salary: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;è–ªèµ„èŒƒå›´&quot;</span>, description=<span class="string">&quot;ä»…åŒ…æ‹¬æ˜ç¡®è¯´æ˜çš„å·¥èµ„é‡‘é¢ï¼Œå¦åˆ™è®¾ç½®ä¸º null&quot;</span>)</span><br><span class="line">    equity: <span class="built_in">bool</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;è‚¡æƒæ˜¯å¦æ˜¯è¡¥å¿çš„ä¸€éƒ¨åˆ†&quot;</span>, description=<span class="string">&quot;è‚¡æƒæ˜¯å¦æ˜¯è¡¥å¿çš„ä¸€éƒ¨åˆ†&quot;</span>)</span><br><span class="line">    benefits: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;å…¬å¸ç¦åˆ©&quot;</span>, description=<span class="string">&quot;åŒ…æ‹¬å…»è€é‡‘ã€ä¿é™©ã€è®¾å¤‡ã€å„¿ç«¥ä¿è‚²ã€å¹´å‡ç­‰ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜åˆ™è®¾ç½®ä¸º null&quot;</span>)</span><br><span class="line">    location: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;å·¥ä½œåœ°ç‚¹&quot;</span>, description=<span class="string">&quot;å·¥ä½œåœ°ç‚¹&quot;</span>, )</span><br><span class="line">    senior: <span class="built_in">bool</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;è¿™æ˜¯å¦æ˜¯ä¸€ä»½é€‚åˆèµ„æ·±/æœ‰ç»éªŒçš„å€™é€‰äººçš„å·¥ä½œ&quot;</span>, description=<span class="string">&quot;è¿™æ˜¯å¦æ˜¯ä¸€ä»½é€‚åˆèµ„æ·±/æœ‰ç»éªŒçš„å€™é€‰äººçš„å·¥ä½œ&quot;</span>)</span><br><span class="line">    remote: <span class="built_in">bool</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;æ˜¯å¦ä¸ºè¿œç¨‹åŠå…¬&quot;</span>, description=<span class="string">&quot;æ˜¯å¦ä¸ºè¿œç¨‹åŠå…¬&quot;</span>)</span><br><span class="line">    partTime: <span class="built_in">bool</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;æ˜¯å¦å¯ä»¥å…¼èŒ&quot;</span>, description=<span class="string">&quot;æ˜¯å¦å¯ä»¥å…¼èŒ&quot;</span>)</span><br><span class="line">    jobUrl: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;ç‰¹å®šä½œä¸šæè¿°çš„URL&quot;</span>, description=<span class="string">&quot;ç‰¹å®šä½œä¸šæè¿°çš„URL&quot;</span>, )</span><br><span class="line">    requirements: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;ç‰¹å®šè¦æ±‚&quot;</span>, description=<span class="string">&quot;ç‰¹å®šè¦æ±‚&quot;</span>, )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Info</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    companyName: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;å…¬å¸åç§°&quot;</span>, description=<span class="string">&quot;å…¬å¸åç§°&quot;</span>)</span><br><span class="line">    companyLocation: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;å…¬å¸ä½ç½®&quot;</span>, description=<span class="string">&quot;å¦‚æœæ²¡æœ‰æ˜ç¡®è¯´æ˜ï¼Œä½ å¯ä»¥å°è¯•ä»å…¶ä»–çº¿ç´¢æ¨æ–­å…¬å¸çš„å®é™…ä½ç½®ï¼Œä¾‹å¦‚ï¼Œåƒâ€œè¿œç¨‹ï¼ˆç¾å›½ï¼‰â€è¿™æ ·çš„è¯é€šå¸¸æ„å‘³ç€å…¬å¸ä½äºç¾å›½ï¼›å¦‚æœæ— æ³•æ¨æ–­ä½ç½®ï¼Œè¯·å°†å…¶è®¾ç½®ä¸º null&quot;</span>)</span><br><span class="line">    companyDescription: <span class="built_in">str</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;å…¬å¸æè¿°&quot;</span>, description=<span class="string">&quot;å…¬å¸æ­£åœ¨åšä»€ä¹ˆæˆ–æ­£åœ¨å»ºè®¾ä»€ä¹ˆçš„ç®€çŸ­æè¿°ï¼Œå°½é‡ä¿æŒçŸ­&quot;</span>)</span><br><span class="line">    jobs: <span class="type">List</span>[Job] = Field(<span class="literal">None</span>, title=<span class="string">&quot;èŒä½æ¸…å•&quot;</span>, description=<span class="string">&quot;æ‹›è˜å¹¿å‘Šçš„èŒä½æ¸…å•&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºè§£æå™¨å’Œ Prompt</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pydantic è§£æå™¨</span></span><br><span class="line">pydantic_parser = PydanticOutputParser(pydantic_object=Info)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get_format_instructions ç”¨äºè·å–ç”Ÿæˆçš„æç¤º</span></span><br><span class="line">format_instructions = pydantic_parser.get_format_instructions()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†é¢å¤–è¯´æ˜æ”¾åœ¨ Prompt ä¸­</span></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    template=<span class="string">&quot;å°½å¯èƒ½çš„å°†æ‹›è˜ä¿¡æ¯è§£æä¸º JSON æ ¼å¼\né€šå¸¸ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜æŸäº›ä¿¡æ¯ï¼Œè¯·å°†ç›¸åº”çš„å­—æ®µè®¾ç½®ä¸º nullï¼›å¦‚æœå…¬å¸ä¸ºåŒä¸€èŒä½å¯»æ‰¾å¤šä¸ªäººï¼Œåˆ™åªåŒ…æ‹¬è¯¥èŒä½ä¸€æ¬¡\nè¯·ä»…è¾“å‡ºçº¯ JSON è¡¨ç¤ºã€‚ä¸åŒ…æ‹¬ä»»ä½•è§£é‡Šã€è¯„è®ºã€æƒ³æ³•ç­‰ã€‚è¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å¯¹è±¡ï¼Œå¯ä»¥æŒ‰åŸæ ·è§£æ\n&#123;format_instructions&#125;\n&#123;text&#125;&quot;</span>,</span><br><span class="line">    input_variables=[<span class="string">&quot;text&quot;</span>],</span><br><span class="line">    partial_variables=&#123;<span class="string">&quot;format_instructions&quot;</span>: format_instructions&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œ</strong></p><p>æ‰§è¡ŒåŒä¸Šï¼Œä½†æ˜¯åœ¨ chain ä¸­å…¥å‚ç»“æœè§£æå™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># output_parser å‚æ•°æŒ‡å®šç»“æœè§£æå™¨</span></span><br><span class="line">chain = LLMChain(</span><br><span class="line">    llm=chat_model,</span><br><span class="line">    prompt=prompt,</span><br><span class="line">    output_parser=pydantic_parser</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;D:/WorkSpace_learn/langchain-test/text.txt&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    content = file.read()</span><br><span class="line"></span><br><span class="line">result = chain.run(content)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">companyName=<span class="string">&#x27;Apifox&#x27;</span> companyLocation=<span class="string">&#x27;å¤©æ²³ CBD&#x27;</span> companyDescription=<span class="string">&#x27;Apifox æ˜¯ API æ–‡æ¡£ã€API è°ƒè¯•ã€API Mockã€API è‡ªåŠ¨åŒ–æµ‹è¯•ä¸€ä½“åŒ–åä½œå¹³å°&#x27;</span> jobs=[Job(jobTitle=<span class="string">&#x27;åˆä¸­çº§å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ&#x27;</span>, salary=<span class="string">&#x27;12~25K&#x27;</span>, equity=<span class="literal">None</span>, benefits=<span class="literal">None</span>, location=<span class="literal">None</span>, senior=<span class="literal">False</span>, remote=<span class="literal">False</span>, partTime=<span class="literal">False</span>, jobUrl=<span class="literal">None</span>, requirements=<span class="string">&#x27;æœ¬ç§‘åŠä»¥ä¸Šå­¦å†ï¼Œè‡³å°‘ 1 å¹´ä»¥ä¸Š web å‰ç«¯å¼€å‘å·¥ä½œç»éªŒï¼› ç²¾é€šä½¿ç”¨å„ç§ web å‰ç«¯æŠ€æœ¯ï¼ŒåŒ…æ‹¬ HTML5/CSS/Javascript/TypeScript ç­‰ ï¼› ç†Ÿæ‚‰ä¸€ç§æˆ–å¤šç§å¸¸ç”¨å‰ç«¯æ¡†æ¶ï¼Œå¦‚ï¼ˆ React ã€Vue ã€Angular ç­‰ï¼‰ï¼› ç†Ÿæ‚‰ä½¿ç”¨ webpack ç­‰æ¨¡å—åŒ–ã€å·¥ç¨‹åŒ–å·¥å…·ï¼› æ‹¥ æœ‰å¼€å‘æµç¨‹ä¸­çš„ä»£ç è§„èŒƒæ„è¯†ã€é…ç½®ç®¡ç†è§„èŒƒæ„è¯†ã€æ–‡æ¡£æ’°å†™è§„èŒƒæ„è¯†ï¼›&#x27;</span>), Job(jobTitle=<span class="string">&#x27;é«˜çº§å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ&#x27;</span>, salary=<span class="string">&#x27;20~40K&#x27;</span>, equity=<span class="literal">None</span>, benefits=<span class="literal">None</span>, location=<span class="literal">None</span>, senior=<span class="literal">True</span>, remote=<span class="literal">False</span>, partTime=<span class="literal">False</span>, jobUrl=<span class="literal">None</span>, requirements=<span class="string">&#x27;æœ¬ç§‘åŠä»¥ä¸Šå­¦å†ï¼Œè‡³å°‘ 1 å¹´ä»¥ä¸Š web å‰ç«¯å¼€å‘å·¥ä½œç»éªŒï¼› ç²¾é€šä½¿ç”¨å„ç§ web å‰ç«¯æŠ€æœ¯ï¼ŒåŒ…æ‹¬ HTML5/CSS/Javascript/TypeScript ç­‰ï¼› ç†Ÿæ‚‰ä¸€ç§æˆ–å¤šç§å¸¸ç”¨å‰ç«¯æ¡†æ¶ï¼Œå¦‚ï¼ˆ React ã€Vue ã€Angular ç­‰ï¼‰ï¼› ç†Ÿæ‚‰ä½¿ç”¨ webpack ç­‰æ¨¡å—åŒ–ã€å·¥ç¨‹åŒ–å·¥å…·ï¼› æ‹¥æœ‰å¼€å‘æµç¨‹ä¸­çš„ä»£ç è§„èŒƒæ„è¯†ã€é…ç½®ç®¡ç†è§„èŒƒæ„è¯†ã€æ–‡æ¡£æ’°å†™è§„èŒƒæ„è¯†ï¼›&#x27;</span>), Job(jobTitle=<span class="string">&#x27;ä¸“å®¶å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ&#x27;</span>, salary=<span class="string">&#x27;35~60K&#x27;</span>, equity=<span class="literal">None</span>, benefits=<span class="literal">None</span>, location=<span class="literal">None</span>, senior=<span class="literal">True</span>, remote=<span class="literal">False</span>, partTime=<span class="literal">False</span>, jobUrl=<span class="literal">None</span>, requirements=<span class="string">&#x27;æœ¬ç§‘åŠä»¥ä¸Šå­¦å†ï¼Œè‡³å°‘ 1 å¹´ä»¥ä¸Š web å‰ç«¯å¼€å‘å·¥ä½œç»éªŒï¼› ç²¾é€šä½¿ç”¨å„ ç§ web å‰ç«¯æŠ€æœ¯ï¼ŒåŒ…æ‹¬ HTML5/CSS/Javascript/TypeScript ç­‰ï¼› ç†Ÿæ‚‰ä¸€ç§æˆ–å¤šç§å¸¸ç”¨å‰ç«¯æ¡†æ¶ï¼Œå¦‚ï¼ˆ React ã€Vue ã€Angular ç­‰ï¼‰ï¼› ç†Ÿæ‚‰ä½¿ç”¨ webpack ç­‰æ¨¡å—åŒ–ã€å·¥ç¨‹åŒ–å·¥å…·ï¼› æ‹¥æœ‰å¼€å‘æµç¨‹ä¸­çš„ä»£ç è§„èŒƒæ„è¯†ã€é…ç½®ç®¡ç†è§„èŒƒæ„è¯†ã€æ–‡æ¡£æ’° å†™è§„èŒƒæ„è¯†ï¼›&#x27;</span>)]</span><br></pre></td></tr></table></figure><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LLM%20%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA/%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA.png" class="" title="ç»“æ„åŒ–è¾“å‡º"><h1 id="æ€è€ƒ">æ€è€ƒ</h1><p>å°†æ–‡æœ¬è§£æä¸ºç»“æ„åŒ–æ•°æ®å¸¦æ¥çš„å¥½å¤„ï¼š</p><ul><li><strong>æ•ˆç‡å’Œæˆæœ¬</strong>ï¼šå‡å°‘äººå·¥å¤„ç†çš„å·¥ä½œé‡ï¼Œæé«˜æ•°æ®å¤„ç†çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®å¤„ç†çš„æˆæœ¬</li><li><strong>æ­£ç¡®æ€§</strong>ï¼šï¼ˆä¹Ÿè®¸ï¼Ÿï¼‰é¿å…äº†äººä¸ºé”™è¯¯çš„å¯èƒ½æ€§</li><li><strong>å¢å¼ºæ•°æ®å¯ç”¨æ€§</strong>ï¼šå°†æ–‡æœ¬è½¬åŒ–ä¸ºç»“æ„åŒ–æ•°æ®åï¼Œæ•°æ®å˜å¾—æ›´æ˜“äºç®¡ç†å’Œåˆ†æ</li><li><strong>æ”¯æŒå†³ç­–åˆ¶å®šï¼š</strong>ç»“æ„åŒ–æ•°æ®ä½¿å¾—ä¿¡æ¯æ›´å®¹æ˜“ç†è§£å’Œæ¯”è¾ƒï¼Œä¸ºå†³ç­–åˆ¶å®šæä¾›æ›´å¤šæ”¯æŒ</li></ul><p>æ–‡ä¸­çš„éœ€æ±‚ä¸€å¤§ç‰¹ç‚¹å°±æ˜¯ç”¨äºå¢å¼ºæ•°æ®çš„å¯ç”¨æ€§</p><p>å…¶æ¬¡æˆ‘è®¤ä¸ºæ˜¯ä¸æ˜¯å¯ä»¥ç”¨æ¥ä½œä¸ºè‡ªç„¶è¯­è¨€å’Œ AI æ²Ÿé€šçš„æ¡¥æ¢ï¼›æ¯”å¦‚ä¸€ä¸ª SQLéœ€æ±‚ï¼Œ â€œæŸ¥è¯¢å­¦ç”Ÿå§“åå’Œå¹´é¾„ï¼ŒæŒ‰ç…§æˆç»©æ’åºâ€</p><p>ç¬¬ä¸€æ­¥å…ˆä½¿ç”¨ç»“æ„å¼•å¯¼ LLM å¯¹éœ€æ±‚è¿›è¡Œæ‹†è§£ï¼Œå‡è®¾ä½¿ç”¨ JSON ç»“æ„</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å­¦ç”Ÿ&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;filed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;å§“å&quot;</span><span class="punctuation">,</span><span class="string">&quot;å¹´é¾„&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æˆç»©&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥å†ä»¥ç»“æ„åŒ–æ•°æ®é©±åŠ¨ LLM è½¬æ¢ä¸º SQL ç»“æ„ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ›´å¥½åœ°å¼•å¯¼LLM å¯¹éœ€æ±‚è¿›è¡Œç†è§£ï¼ˆæˆ‘èƒ¡ä¹±æƒ³çš„ï¼‰</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> Prompt </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡çº§ MacOS 14 å¯¼è‡´ embedded-redis ä¸å…¼å®¹</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%8D%87%E7%BA%A7%20MacOS%2014%20%E5%AF%BC%E8%87%B4%20embedded-redis%20%E4%B8%8D%E5%85%BC%E5%AE%B9.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%8D%87%E7%BA%A7%20MacOS%2014%20%E5%AF%BC%E8%87%B4%20embedded-redis%20%E4%B8%8D%E5%85%BC%E5%AE%B9.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>ä¸€ç›´éƒ½æ²¡æ›´æ–°æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼Œå¿ƒè¡€æ¥æ½®æ›´æ–°äº† MacOS çš„ 14ï¼ˆSonomaï¼‰</p><p><ahref="https://www.apple.com.cn/macos/sonoma/?ivk_sa=1024320u">macOSSonoma - Apple (ä¸­å›½å¤§é™†)</a></p><p>ç„¶åå‘ç°å•æµ‹ç«Ÿç„¶è·‘ä¸é€šäº†ï¼Œä½†æ˜¯ push ä¸Šå»çš„ä»£ç  CIä¾ç„¶å¯ä»¥é€šè¿‡ï¼Œæ‰€ä»¥å½“æ—¶åŸºæœ¬å°±ç¡®å®šæ˜¯ç‰ˆæœ¬å‡çº§å¸¦æ¥çš„å…¼å®¹æ€§é—®é¢˜äº†</p><p>çœ‹äº†ä¸‹æ—¥å¿—ï¼Œæ˜¯åµŒå…¥çš„ Redis è¿è¡Œä¸èµ·æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: Can<span class="string">&#x27;t start redis server. Check logs for details. Redis process log: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">at redis.embedded.AbstractRedisInstance.awaitRedisServerReady(AbstractRedisInstance.java:70)</span></span><br><span class="line"><span class="string">at redis.embedded.AbstractRedisInstance.start(AbstractRedisInstance.java:42)</span></span><br><span class="line"><span class="string">at redis.embedded.RedisServer.start(RedisServer.java:9)</span></span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåµŒå…¥çš„ Redis æ˜¯ç”¨æ¥ mock å•æµ‹å†…çš„ Redis æœåŠ¡ç«¯çš„</p><p>ä½¿ç”¨çš„å¼€æº <ahref="https://github.com/kstyrc/embedded-redis">kstyrc/embedded-redis:Redis embedded server for Java integration testing (github.com)</a></p><h1 id="æ’æŸ¥">æ’æŸ¥</h1><h2 id="æ£€æŸ¥ç«¯å£å ç”¨">æ£€æŸ¥ç«¯å£å ç”¨</h2><p>å½“ç„¶ç¬¬ä¸€æ—¶é—´æ£€æŸ¥ç«¯å£å ç”¨ï¼Œè¿™ç§ä»£ç å†…åµŒçš„æœåŠ¡ç»å¸¸ä¼šå‡ºç°å…³é—­å¤±è´¥çš„æƒ…å†µï¼Œå¯¼è‡´ä¸»çº¿ç¨‹å·²ç»ç»“æŸäº†å®é™…æœåŠ¡è¿˜åœ¨è¿è¡Œï¼Œå¯¼è‡´ç«¯å£å ç”¨ï¼›å½“ç„¶ä»å¼‚å¸¸æ ˆä¿¡æ¯æ¥çœ‹å¹¶ä¸æ˜¯ç«¯å£å ç”¨å¯¼è‡´çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -i :&lt;ç«¯å£å·&gt;</span><br></pre></td></tr></table></figure><h2 id="debug">debug</h2><p>å¼‚å¸¸ä¿¡æ¯ä¸Šè¡¨ç¤º <code>Check logs for details</code></p><p>äº‹å®ä¸Šä¹Ÿæ²¡æœ‰æ—¥å¿—å¯ä»¥æŸ¥çœ‹ï¼Œåªèƒ½ debug è¿›è¡ŒæŸ¥çœ‹äº†</p><p>å…·ä½“ä½ç½®åœ¨<code>org.apache.commons.io.IOUtils.AbstractRedisInstance.start()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> EmbeddedRedisException &#123;</span><br><span class="line">    <span class="keyword">if</span> (active) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EmbeddedRedisException</span>(<span class="string">&quot;This redis server instance is already running...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        redisProcess = createRedisProcessBuilder().start();</span><br><span class="line">        logErrors();</span><br><span class="line">      <span class="comment">// è¿™é‡Œåœ¨ç­‰å¾…æœåŠ¡ç«¯è¿”å›çš„æ•°æ®</span></span><br><span class="line">        awaitRedisServerReady();</span><br><span class="line">        active = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EmbeddedRedisException</span>(<span class="string">&quot;Failed to start Redis instance&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">awaitRedisServerReady</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(redisProcess.getInputStream()));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String outputLine;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            outputLine = reader.readLine();</span><br><span class="line">          <span class="comment">// è¿™é‡Œä¸º null æ‰€ä»¥æŠ›å‡ºäº†å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> (outputLine == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//Something goes wrong. Stream is ended before server was activated.</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Can&#x27;t start redis server. Check logs for details.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!outputLine.matches(redisReadyPattern()));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IOUtils.closeQuietly(reader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ debug ä¹Ÿæ²¡å‘ç°å“ªé‡Œæœ‰æ—¥å¿—</p><p>äº‹å®ä¸Šè¿˜æ‰¾åˆ°äº†ä¸€ä¸ª issue æ¥è¯¢é—®è¿™ä¸ªé—®é¢˜</p><p><a href="https://github.com/kstyrc/embedded-redis/issues/51">"Can'tstart redis server. Check logs for details" - which logs???? Â· Issue #51Â· kstyrc/embedded-redis (github.com)</a></p><p>çœ‹ä¸‹æ–¹çš„è¯„è®ºå¾ˆå¤šäººéƒ½æ˜¯å› ä¸º Windows çš„ä¸å…¼å®¹å¯¼è‡´</p><h2 id="å¯¹åº”çš„-issue">å¯¹åº”çš„ issue</h2><p>åªèƒ½ç»§ç»­æ‰¾ issueï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è§£å†³æ–¹æ¡ˆï¼Œè¿˜çœŸæ‰¾åˆ°äº†ä¸€æ ·çš„é—®é¢˜</p><p><a href="https://github.com/kstyrc/embedded-redis/issues/135">Unableto run on macOS Sonoma Â· Issue #135 Â· kstyrc/embedded-redis(github.com)</a></p><p>æœ‰è€å“¥ fork åè§£å†³äº†ä¸å…¼å®¹é—®é¢˜</p><p><ahref="https://github.com/codemonstur/embedded-redis">codemonstur/embedded-redis:Redis embedded server (github.com)</a></p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%8D%87%E7%BA%A7%20MacOS%2014%20%E5%AF%BC%E8%87%B4%20embedded-redis%20%E4%B8%8D%E5%85%BC%E5%AE%B9/%E6%88%AA%E5%9B%BE.png" class="" title="issue æˆªå›¾"><h1 id="è§£å†³">è§£å†³</h1><p>å› ä¸ºæ˜¯æœ¬åœ°å•æµ‹ç¯å¢ƒé—®é¢˜ï¼Œæ‰€ä»¥å¼•ç”¨å¼€æºçš„é£é™©ä¹Ÿä¸å¤§</p><p>å…¶æ¬¡å› ä¸ºä¹‹å‰çš„è¿™ä¸ªä¾èµ–åœ¨ parent åŒ…å†…ç®¡ç†ï¼Œå¾ˆéš¾å¿«é€Ÿè¿›è¡Œç‰ˆæœ¬å‡çº§</p><p>æ‰€ä»¥å†³å®š fork ä»£ç åä¿®æ”¹åæ ‡ï¼Œåœ¨æœ¬åœ°æ‰“ä¸€ä¸ªç›¸åŒåæ ‡çš„åŒ…è¿›è¡Œè¦†ç›–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.kstyrc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>embedded-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>çœŸ Â· è·‘èµ·æ¥å°±ä¸è¦å†åŠ¨äº†</p><p>ä¸è¦è½»æ˜“æ›´æ–°ç‰ˆæœ¬ : (</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%8D%87%E7%BA%A7%20MacOS%2014%20%E5%AF%BC%E8%87%B4%20embedded-redis%20%E4%B8%8D%E5%85%BC%E5%AE%B9/%E5%8F%88%E4%B8%8D%E6%98%AF%E4%B8%8D%E8%83%BD%E7%94%A8.jpg" class="" title="åˆä¸æ˜¯ä¸èƒ½ç”¨">]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç–‘éš¾æ‚ç—‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java ä»å¼±å¼•ç”¨çœ‹å¸¸é‡æ± </title>
      <link href="/%E5%BC%80%E5%8F%91/Java/Java%20%E4%BB%8E%E5%BC%B1%E5%BC%95%E7%94%A8%E7%9C%8B%E5%B8%B8%E9%87%8F%E6%B1%A0.html"/>
      <url>/%E5%BC%80%E5%8F%91/Java/Java%20%E4%BB%8E%E5%BC%B1%E5%BC%95%E7%94%A8%E7%9C%8B%E5%B8%B8%E9%87%8F%E6%B1%A0.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p>åœ¨çœ‹é˜¿é‡Œå¼€æºçš„ TransmittableThreadLocal Agentæ—¶å‘ç°äº†åœ¨å¯¹ç±»è¿›è¡Œå¢å¼ºçš„æµç¨‹ä¸­ä½¿ç”¨äº† <code>WeakHashMap</code></p><p>com.alibaba.ttl3.agent.TtlExtensionTransformletManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> use WeakHashMap as a Set collection, value is always null.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WeakHashMap&lt;ClassLoader, ?&gt; collectedClassLoaderHistory = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;(<span class="number">512</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Map: ExtensionTransformlet ClassLoader -&gt; ExtensionTransformlet ClassName -&gt; ExtensionTransformlet instance(not include from parent classloader)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WeakHashMap&lt;ClassLoader, Map&lt;String, TtlTransformlet&gt;&gt; classLoader2ExtensionTransformlets =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;(<span class="number">512</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Map: ExtensionTransformlet ClassLoader -&gt; ExtensionTransformlet ClassName -&gt; ExtensionTransformlet instance(include from parent classloader)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WeakHashMap&lt;ClassLoader, Map&lt;String, TtlTransformlet&gt;&gt; classLoader2ExtensionTransformletsIncludeParentCL =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;(<span class="number">512</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº†å¼±å¼•ç”¨å…ƒç´ çš„ HashMapï¼Œåº”è¯¥æ˜¯åªç”¨äº JVMå¯åŠ¨çš„ç±»åŠ è½½é˜¶æ®µï¼Œæ‰€ä»¥ä½¿ç”¨äº†ç‰¹æ®Šçš„å¼•ç”¨ç±»å‹</p><p>ä¹‹å‰æ²¡æ€ä¹ˆå…³æ³¨è¿‡å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥çœ‹äº†ä¸€ä¸‹ APIä½¿ç”¨äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰å¼•ç”¨ç±»å‹å¯ä»¥ç”¨æ¥éªŒè¯å¸¸é‡æ± ç­‰ç°è±¡ï¼ŒåŠ æ·±å¯¹å¼•ç”¨çš„ç†è§£</p><p>è™½ç„¶æ›´åƒæ˜¯å…«è‚¡æ–‡çš„å†…å®¹ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³è®°å½•ä¸‹æ¥</p><h1 id="å¼ºè½¯å¼±è™š">å¼ºè½¯å¼±è™š</h1><p><strong>åœ¨è¿™é‡Œé‡å¤ä¸€ä¸‹ Java ä¸­å››ç§å¼•ç”¨ç±»å‹çš„æ¦‚å¿µ</strong></p><p>åœ¨ Java ä¸­ï¼Œæœ‰å››ç§ç±»å‹çš„å¼•ç”¨ï¼šå¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰ã€è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ã€å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰å’Œè™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼›å®ƒä»¬åœ¨åƒåœ¾å›æ”¶æ–¹é¢å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œé€‚ç”¨äºä¸åŒçš„åœºæ™¯</p><ul><li>å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰<ul><li>å¼ºå¼•ç”¨æ˜¯æœ€å¸¸è§çš„å¼•ç”¨ç±»å‹ï¼Œå®ƒä¼šé˜»æ­¢è¢«å¼•ç”¨å¯¹è±¡è¢«åƒåœ¾å›æ”¶</li><li>å½“ä¸€ä¸ªå¯¹è±¡æœ‰å¼ºå¼•ç”¨ä¸ä¹‹å…³è”æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå›æ”¶è¯¥å¯¹è±¡ï¼Œå³ä½¿å†…å­˜ç©ºé—´ä¸è¶³</li></ul></li><li>è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰<ul><li>è½¯å¼•ç”¨æ˜¯ä¸€ç§ç›¸å¯¹å¼ºå¼•ç”¨è¾ƒå¼±çš„å¼•ç”¨ç±»å‹</li><li>å½“å†…å­˜ç©ºé—´è¶³å¤Ÿæ—¶ï¼Œè½¯å¼•ç”¨ä¸ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œä½†å½“å†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå°è¯•å›æ”¶è½¯å¼•ç”¨å¯¹è±¡</li></ul></li><li>å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰<ul><li>å¼±å¼•ç”¨æ¯”è½¯å¼•ç”¨æ›´å¼±ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ›´çŸ­</li><li>å½“åƒåœ¾å›æ”¶å™¨æ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¼±å¼•ç”¨éƒ½ä¼šè¢«å›æ”¶</li></ul></li><li>è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰<ul><li>è™šå¼•ç”¨æ˜¯æœ€å¼±çš„å¼•ç”¨ç±»å‹ï¼Œå‡ ä¹æ²¡æœ‰å®é™…çš„å¼•ç”¨ä½œç”¨</li><li>è™šå¼•ç”¨çš„ä¸»è¦ä½œç”¨æ˜¯è·Ÿè¸ªåƒåœ¾å›æ”¶å™¨çš„å›æ”¶è¿‡ç¨‹ï¼Œé€šè¿‡ä¸å¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨</li></ul></li></ul><p><br></p><p><strong>å¸¸è§çš„åº”ç”¨åœºæ™¯</strong></p><table><colgroup><col style="width: 9%" /><col style="width: 90%" /></colgroup><thead><tr class="header"><th style="text-align: center;">ç±»å‹</th><th style="text-align: center;">åœºæ™¯</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">å¼ºå¼•ç”¨</td><tdstyle="text-align: center;">é€‚ç”¨äºéœ€è¦ç¡®ä¿å¯¹è±¡ä¸€ç›´å­˜åœ¨çš„åœºæ™¯ï¼Œä¾‹å¦‚å…¨å±€å˜é‡ã€é™æ€å˜é‡ç­‰</td></tr><tr class="even"><td style="text-align: center;">è½¯å¼•ç”¨</td><tdstyle="text-align: center;">é€‚ç”¨äºå¯¹å†…å­˜æ•æ„Ÿçš„ç¼“å­˜åœºæ™¯ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸è¶³æ—¶é‡Šæ”¾ä¸€äº›ç¼“å­˜å¯¹è±¡</td></tr><tr class="odd"><td style="text-align: center;">å¼±å¼•ç”¨</td><tdstyle="text-align: center;">é€‚ç”¨äºä¸´æ—¶å¯¹è±¡çš„ç¼“å­˜ã€å¯¹è±¡å…³è”æ€§çš„è¾…åŠ©å¼•ç”¨ç­‰åœºæ™¯ï¼Œå¯ä»¥å¿«é€Ÿé‡Šæ”¾ä¸å†è¢«å¼•ç”¨çš„å¯¹è±¡</td></tr><tr class="even"><td style="text-align: center;">è™šå¼•ç”¨</td><tdstyle="text-align: center;">é€‚ç”¨äºéœ€è¦åœ¨å¯¹è±¡è¢«å›æ”¶æ—¶æ‰§è¡Œç‰¹å®šæ“ä½œçš„åœºæ™¯ï¼Œä¾‹å¦‚å¯¹è±¡é”€æ¯çš„æ¸…ç†æ“ä½œ</td></tr></tbody></table><h1 id="weakhashmap">WeakHashMap</h1><blockquote><p>å½“ WeakHashMap ä¸­çš„æŸä¸ª entry çš„ key ä¸å†è¢«æ—¥å¸¸ä½¿ç”¨æ—¶ï¼Œè¯¥ entryå°†è‡ªåŠ¨è¢«åˆ é™¤</p><p>æ›´å‡†ç¡®åœ°è¯´ï¼Œç»™å®š keyçš„æ˜ å°„çš„å­˜åœ¨ä¸ä¼šé˜»æ­¢è¯¥é”®è¢«åƒåœ¾æ”¶é›†å™¨ä¸¢å¼ƒï¼Œå³ä½¿å…¶å¯æœ€ç»ˆåŒ–ã€æœ€ç»ˆç¡®å®šï¼Œç„¶åå›æ”¶</p><p>å½“ä¸€ä¸ª key è¢«ä¸¢å¼ƒæ—¶ï¼Œå®ƒçš„ entryå®é™…ä¸Šä¼šä»æ˜ å°„ä¸­åˆ é™¤ï¼Œå› æ­¤æ­¤ç±»çš„è¡Œä¸ºä¸å…¶ä»– Map å®ç°æœ‰äº›ä¸åŒ</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="keyword">new</span> <span class="title class_">Object</span>(), <span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç­‰å¾… GC</span></span><br><span class="line">    System.gc();</span><br><span class="line">  TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(map.size()); <span class="comment">// 0</span></span><br><span class="line">    System.out.println(map.keySet()); <span class="comment">// []</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ <code>System.gc()</code> ä¸ä¸€å®šä¼šç¡®ä¿æ‰§è¡Œäº† GC æ“ä½œï¼Œå¹¶ä¸” GCæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥åç»­åˆè¿›è¡Œäº† 1s çš„ sleepï¼Œä¸è¿‡ä»ç»“æœä¸Šæ¥çœ‹æ˜¯è¿›è¡Œäº† GCæ“ä½œ</p><h2 id="entry">Entry</h2><p><code>WeakHashMap</code> å®ç°å¼±å¼•ç”¨å…ƒç´ çš„å…³é”®åœ¨äºå†…éƒ¨ç±»<code>Entry</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The entries in this hash table extend WeakReference, using its main ref</span></span><br><span class="line"><span class="comment"> * field as the key.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;Object&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">    V value;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates new entry.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Entry(Object key, V value,</span><br><span class="line">          ReferenceQueue&lt;Object&gt; queue,</span><br><span class="line">          <span class="type">int</span> hash, Entry&lt;K,V&gt; next) &#123;</span><br><span class="line">      <span class="comment">// key å’Œ queue</span></span><br><span class="line">        <span class="built_in">super</span>(key, queue);</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="built_in">this</span>.hash  = hash;</span><br><span class="line">        <span class="built_in">this</span>.next  = next;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>Entry</code> ç»§æ‰¿äº†<code>WeakReference</code>ï¼Œå¹¶ä¸”åœ¨æ„é€ å™¨ä¸­è°ƒç”¨äº†çˆ¶ç±»æ„é€ å™¨ï¼Œå°† keyåŒ…è£…ä¸ºäº†å¼±å¼•ç”¨ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªé˜Ÿåˆ—ç”¨äºå­˜æ”¾è¢«é©±é€çš„ <code>Entry</code>å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reference queue for cleared WeakEntries</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><h2 id="é©±é€å…ƒç´ ">é©±é€å…ƒç´ </h2><p>åœ¨è°ƒç”¨ <code>size</code>ã€<code>get</code>ç­‰æ–¹æ³•æ—¶ï¼Œ<code>WeakHashMap</code> é€šè¿‡ <code>expungeStaleEntries</code>æ–¹æ³•æ¥é©±é€å…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    expungeStaleEntries();</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¸…ç†è¡¨ä¸­çš„è¿‡æœŸï¼ˆæ— ç”¨ï¼‰æ¡ç›®ã€‚</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">expungeStaleEntries</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// éå†é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå¯¹è±¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">for</span> (Object x; (x = queue.poll()) != <span class="literal">null</span>; ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (queue) &#123;  <span class="comment">// ä½¿ç”¨ synchronized æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†ä»é˜Ÿåˆ—ä¸­è·å–çš„å¯¹è±¡å¼ºè½¬ä¸º Entry&lt;K,V&gt; ç±»å‹</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–è¯¥æ¡ç›®åœ¨è¡¨æ•°ç»„ä¸­çš„ç´¢å¼•</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(e.hash, table.length);</span><br><span class="line"></span><br><span class="line">            Entry&lt;K,V&gt; prev = table[i];</span><br><span class="line">            Entry&lt;K,V&gt; p = prev;</span><br><span class="line">            <span class="comment">// éå†åœ¨ table[i] ä¸­çš„é“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">while</span> (p != <span class="literal">null</span>) &#123;</span><br><span class="line">                Entry&lt;K,V&gt; next = p.next;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ç­‰äºè¿‡æœŸï¼ˆè¢«å›æ”¶ï¼‰çš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (p == e) &#123;</span><br><span class="line">                    <span class="comment">// ä»é“¾è¡¨ä¸­ç§»é™¤è¿‡æœŸï¼ˆè¢«å›æ”¶ï¼‰èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">if</span> (prev == e)</span><br><span class="line">                        table[i] = next;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        prev.next = next;</span><br><span class="line">                    <span class="comment">// å°† value è®¾ç½®ä¸º nullï¼Œä½¿è¯¥æ¡ç›®èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶</span></span><br><span class="line">                    e.value = <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// å‡å°‘å“ˆå¸Œè¡¨çš„å¤§å°</span></span><br><span class="line">                    size--;  </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¦‚æ‹¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>éå† <code>ReferenceQueue</code> å†…çš„å¯¹è±¡</li><li>æ‰¾åˆ°å“ˆå¸Œè¡¨ä¸­çš„ä½ç½®éå†é“¾è¡¨ä¸Šçš„å…ƒç´ </li><li>ä»é“¾è¡¨ä¸­ç§»é™¤è¿‡æœŸï¼ˆè¢«å›æ”¶ï¼‰èŠ‚ç‚¹</li><li>å°† value è®¾ç½®ä¸º nullï¼Œä½¿è¯¥æ¡ç›®èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶</li><li>å‡å°‘å“ˆå¸Œè¡¨ size</li></ol><p>æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„</p><ul><li>æ¸…ç†é€»è¾‘ä¸­ä¸èƒ½æ¸…ç©º <code>e.next</code>ï¼Œå› ä¸ºè¿‡æ—¶çš„ entry å¯èƒ½æ­£åœ¨è¢«<code>HashIterator</code> è¿­ä»£å™¨ä½¿ç”¨</li><li>åœ¨æ¸…ç†å¯¹è±¡æ—¶ä½¿ç”¨ synchronized ä¸Šé”ï¼Œlock å¯¹è±¡ä¸º<code>ReferenceQueue</code> å®ä¾‹</li></ul><h2 id="è¿­ä»£å™¨">è¿­ä»£å™¨</h2><p>ä¸Šé¢åœ¨æ³¨æ„ä¸­æåˆ°ï¼Œè¿­ä»£å™¨å¯èƒ½ä½¿ç”¨è¿‡æ—¶çš„ entry</p><p>é‚£è¯´æ˜è¿­ä»£å™¨é€»è¾‘ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨ <code>expungeStaleEntries</code>ç›¸å…³é€»è¾‘ï¼Œé‚£ä¹ˆè¿­ä»£å™¨æ˜¯å¦‚ä½•é©±é€è¿‡æœŸå¯¹è±¡å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HashIterator</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> index;                   <span class="comment">// å½“å‰éå†çš„ç´¢å¼•ä½ç½®</span></span><br><span class="line">    <span class="keyword">private</span> Entry&lt;K,V&gt; entry;            <span class="comment">// å½“å‰éå†åˆ°çš„ Entry</span></span><br><span class="line">    <span class="keyword">private</span> Entry&lt;K,V&gt; lastReturned;     <span class="comment">// æœ€åè¿”å›çš„ Entry</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">expectedModCount</span> <span class="operator">=</span> modCount;  <span class="comment">// é¢„æœŸä¿®æ”¹è®¡æ•°ï¼Œç”¨äºæ£€æŸ¥å¹¶å‘ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">private</span> Object nextKey;              <span class="comment">// ä¸‹ä¸€ä¸ªé”®ï¼Œéœ€è¦å¼ºå¼•ç”¨ä»¥é˜²æ­¢åœ¨ hasNext å’Œ next ä¹‹é—´çš„é”®æ¶ˆå¤±</span></span><br><span class="line">    <span class="keyword">private</span> Object currentKey;           <span class="comment">// å½“å‰é”®ï¼Œéœ€è¦å¼ºå¼•ç”¨ä»¥é˜²æ­¢åœ¨ nextEntry å’Œä»»ä½•ä½¿ç”¨ entry ä¹‹é—´çš„é”®æ¶ˆå¤±</span></span><br><span class="line"></span><br><span class="line">    HashIterator() &#123;</span><br><span class="line">        index = isEmpty() ? <span class="number">0</span> : table.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        Entry&lt;K,V&gt;[] t = table;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“ä¸‹ä¸€ä¸ªé”®ä¸ºç©ºæ—¶è¿›è¡Œå¾ªç¯</span></span><br><span class="line">        <span class="keyword">while</span> (nextKey == <span class="literal">null</span>) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = entry;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> index;</span><br><span class="line">            <span class="comment">// å½“entryä¸ºnullå¹¶ä¸”indexå¤§äº0æ—¶ï¼Œä»tableçš„index-1ä½ç½®å¼€å§‹ä¾æ¬¡å‘å‰æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°énullçš„entry</span></span><br><span class="line">            <span class="keyword">while</span> (e == <span class="literal">null</span> &amp;&amp; i &gt; <span class="number">0</span>)</span><br><span class="line">                e = t[--i];</span><br><span class="line">            entry = e;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="comment">// å¦‚æœentryä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (e == <span class="literal">null</span>) &#123;</span><br><span class="line">                currentKey = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é‡‡ç”¨å¼ºå¼•ç”¨ä¿æŒé”®ï¼Œé˜²æ­¢é”®åœ¨æ­¤æœŸé—´è¢«å›æ”¶</span></span><br><span class="line">            nextKey = e.get(); </span><br><span class="line">            <span class="comment">// å¦‚æœé”®ä¸ºnullï¼Œè¯´æ˜è¯¥Entryå·²ç»è¢«å›æ”¶ï¼Œæ­¤æ—¶è·³åˆ°ä¸‹ä¸€ä¸ªEntry</span></span><br><span class="line">            <span class="keyword">if</span> (nextKey == <span class="literal">null</span>)</span><br><span class="line">                entry = entry.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="string">String</h1><h2 id="å­—ç¬¦ä¸²å¸¸é‡æ± ">å­—ç¬¦ä¸²å¸¸é‡æ± </h2><p>å­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯ Javaä¸­çš„ä¸€ä¸ªç‰¹æ®ŠåŒºåŸŸï¼Œç”¨äºå­˜å‚¨å­—ç¬¦ä¸²å¸¸é‡çš„å”¯ä¸€å®ä¾‹ï¼›å®ƒæ˜¯åœ¨å †å†…å­˜ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä¸å †ä¸­çš„å…¶ä»–å¯¹è±¡åˆ†å¼€å­˜å‚¨</p><p><strong>ç‰¹ç‚¹ä¸ä½¿ç”¨ï¼š</strong></p><ul><li>å­—ç¬¦ä¸²ä¸å¯å˜</li><li>å¸¸é‡æ± ä¸­ç›¸åŒå­—é¢é‡å­—ç¬¦ä¸²å”¯ä¸€ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¼˜åŒ–</li><li>ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆå¦‚<code>String s = "Hello World"</code>ï¼‰åœ¨ç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± </li><li><code>String</code> ç±»çš„ <code>intern()</code>æ–¹æ³•æ‰‹åŠ¨å°†å­—ç¬¦ä¸²æ·»åŠ åˆ°å¸¸é‡æ± ä¸­</li><li>å¦‚æœä½¿ç”¨ <code>String</code>æ„é€ å™¨åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å’Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯ä¸åŒå¯¹è±¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s4</span> <span class="operator">=</span> s1.intern();</span><br><span class="line"></span><br><span class="line">System.out.println(s1 == s2); <span class="comment">// false</span></span><br><span class="line">System.out.println(s2 == s3); <span class="comment">// true</span></span><br><span class="line">System.out.println(s2 == s4); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h2 id="éªŒè¯">éªŒè¯</h2><p><code>WeakHashMap</code> çš„å¼±å¼•ç”¨æ˜¯æŒ‡ keyï¼Œå°† key åˆ†åˆ«è®¾ç½®ä¸ºä¸Šè¿°String çš„ä¸‰ç§åˆ›å»ºæ–¹å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; map1 = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line">map1.put(<span class="string">&quot;Hello World&quot;</span>, <span class="number">1</span>);</span><br><span class="line">map1.put(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;Hello World&quot;</span>), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line">map2.put(<span class="string">&quot;Hello World&quot;</span>, <span class="number">1</span>);</span><br><span class="line">map2.put(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;Hello World&quot;</span>).intern(), <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">System.gc();</span><br><span class="line"></span><br><span class="line">System.out.println(map1.entrySet()); <span class="comment">// [Hello World=2]</span></span><br><span class="line">System.out.println(map2.entrySet()); <span class="comment">// [Hello World=3]</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¯ä»¥çœ‹å‡º <code>new String("")</code> åˆ›å»ºå‡ºçš„å¯¹è±¡å·²ç»è¢«ç§»é™¤äº†</p><h1 id="integer">Integer</h1><h2 id="integer-çš„-valueof-å’Œç¼“å­˜">Integer çš„ valueOf å’Œç¼“å­˜</h2><p>åœ¨æˆ‘ä»¬å£°æ˜ä¸€ä¸ª Integer æ—¶ï¼Œå…¶å®å­—èŠ‚ç è°ƒç”¨çš„æ˜¯å…¶ <code>valueOf</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">i4</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">i5</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">i6</span> <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„å­—èŠ‚ç ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span> iconst_1</span><br><span class="line"> <span class="number">1</span> istore_1</span><br><span class="line"> <span class="number">2</span> iconst_2</span><br><span class="line"> <span class="number">3</span> istore_2</span><br><span class="line"> <span class="number">4</span> bipush <span class="number">6</span></span><br><span class="line"> <span class="number">6</span> istore_3</span><br><span class="line"> <span class="number">7</span> iconst_1</span><br><span class="line"> <span class="number">8</span> invokestatic #<span class="number">2</span> &lt;java/lang/Integer.valueOf&gt;</span><br><span class="line"><span class="number">11</span> astore <span class="number">4</span></span><br><span class="line"><span class="number">13</span> iconst_2</span><br><span class="line"><span class="number">14</span> invokestatic #<span class="number">2</span> &lt;java/lang/Integer.valueOf&gt;</span><br><span class="line"><span class="number">17</span> astore <span class="number">5</span></span><br><span class="line"><span class="number">19</span> bipush <span class="number">6</span></span><br><span class="line"><span class="number">21</span> invokestatic #<span class="number">2</span> &lt;java/lang/Integer.valueOf&gt;</span><br><span class="line"><span class="number">24</span> astore <span class="number">6</span></span><br><span class="line"><span class="number">26</span> <span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥åˆ†ä¸ºä¸¤ç±»æ¥çœ‹ï¼š</p><ul><li>int åŸºç¡€ç±»å‹<ul><li>å½“å­—é¢é‡ä¸º -1 ~ 5 æ—¶ï¼Œä½¿ç”¨çš„æ“ä½œç¬¦ä¸º<code>iconst_&lt;i&gt;</code>ï¼Œå…¶å®ç­‰æ•ˆäº <code>bipush &lt;i&gt;</code><ahref="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.iconst_i">Chapter6. The Java Virtual Machine Instruction Set (oracle.com)</a></li><li>å…¶ä»–å­—é¢é‡åˆ™ä½¿ç”¨ <code>bipush</code>ï¼Œå½“ç„¶éšç€å­—é¢é‡æ‰©å¤§è¿˜ä¼šä½¿ç”¨åˆ°<code>sipush</code> ç­‰</li></ul></li><li>Integer åŒ…è£…ç±»<ul><li>è°ƒç”¨ <code>Integer.valueOf</code> æ–¹æ³•</li></ul></li></ul><p>æ‰€ä»¥å¯¹äº <code>Integer</code>è€Œè¨€ï¼Œå®é™…ä¸Šçš„ç›´æ¥èµ‹å€¼è¢«å­—èŠ‚ç è½¬æ¢ä¸ºäº†æ–¹æ³•çš„è°ƒç”¨</p><p>è€Œ <code>valueOf</code> å°±å¸¦æœ‰äº†ä¸ºäººç†ŸçŸ¥çš„ç¼“å­˜å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">valueOf</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)</span><br><span class="line">        <span class="keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">IntegerCache</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">low</span> <span class="operator">=</span> -<span class="number">128</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> high;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Integer cache[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// high value may be configured by property</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">127</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">integerCacheHighPropValue</span> <span class="operator">=</span></span><br><span class="line">            sun.misc.VM.getSavedProperty(<span class="string">&quot;java.lang.Integer.IntegerCache.high&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (integerCacheHighPropValue != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> parseInt(integerCacheHighPropValue);</span><br><span class="line">                i = Math.max(i, <span class="number">127</span>);</span><br><span class="line">                <span class="comment">// Maximum array size is Integer.MAX_VALUE</span></span><br><span class="line">                h = Math.min(i, Integer.MAX_VALUE - (-low) -<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span>( NumberFormatException nfe) &#123;</span><br><span class="line">                <span class="comment">// If the property cannot be parsed into an int, ignore it.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        high = h;</span><br><span class="line"></span><br><span class="line">        cache = <span class="keyword">new</span> <span class="title class_">Integer</span>[(high - low) + <span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> low;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; cache.length; k++)</span><br><span class="line">            cache[k] = <span class="keyword">new</span> <span class="title class_">Integer</span>(j++);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span></span><br><span class="line">        <span class="keyword">assert</span> IntegerCache.high &gt;= <span class="number">127</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">IntegerCache</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯å…«è‚¡æ–‡ä¸­å¸¸è¯´çš„ -128 ~ 127</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">i1</span> <span class="operator">=</span> <span class="number">127</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">127</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">i3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">127</span>);</span><br><span class="line">System.out.println(i1 == i2); <span class="comment">// true</span></span><br><span class="line">System.out.println(i2 == i3); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="type">Integer</span> <span class="variable">i4</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">i5</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">i6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">128</span>);</span><br><span class="line">System.out.println(i4 == i5); <span class="comment">// false</span></span><br><span class="line">System.out.println(i5 == i6); <span class="comment">// false</span></span><br></pre></td></tr></table></figure><h2 id="éªŒè¯-1">éªŒè¯</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="number">127</span>, <span class="number">1</span>);</span><br><span class="line">map.put(<span class="number">128</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">System.gc();</span><br><span class="line"></span><br><span class="line">System.out.println(map.entrySet()); <span class="comment">// [127=1]</span></span><br></pre></td></tr></table></figure><p>å› ä¸º 128 åœ¨è°ƒç”¨ <code>valueOf</code> æ—¶å¹¶ä¸åœ¨ç¼“å­˜ä¸­ï¼Œæœ€åè¿”å›<code>new Integer(i)</code> å¯¼è‡´è¯¥å¯¹è±¡æ²¡æœ‰å¼ºå¼•ç”¨å­˜åœ¨ï¼Œè¢«å›æ”¶äº†</p><h1 id="map-ä½œä¸º-set-ä½¿ç”¨">Map ä½œä¸º Set ä½¿ç”¨</h1><p>åœ¨ TransmittableThreadLocal ä¸­å…¶å®æ˜¯å°† <code>WeekHashMap</code> å½“ä½œSet æ¥ä½¿ç”¨ï¼Œvalue æ’ä¸º nullï¼Œåœ¨å…¶æ³¨é‡Šä¹Ÿæœ‰è¯´æ˜</p><blockquote><p>NOTE: use WeakHashMap as a Set collection, value is always null.</p></blockquote><p>è¿™ç§åœºæ™¯æ¯”è¾ƒå¸¸è§ï¼ŒSpring ä¸­å°±æœ‰å°† <code>ConcurrentHashMap</code> ä½œä¸ºSet ä½¿ç”¨çš„ä¾‹å­ï¼Œè¿™æ ·å°±å¯ä»¥ç®€å•åœ°å®ç°ä¸€ä¸ªå…·æœ‰å’ŒæŸä¸ª Map åŒæ ·åŠŸèƒ½çš„ Setäº†</p><p>æ­¤å¤–ä» Java 6 å¼€å§‹ <code>java.util.Collections</code> ç±»æä¾›äº†ä¸€ä¸ª<code>newSetFromMap</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•èƒ½å¤ŸåŸºäºæŒ‡å®šçš„ Mapå¯¹è±¡åˆ›å»ºä¸€ä¸ªæ–°çš„ Set å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Integer&gt; set = Collections.newSetFromMap(<span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;());</span><br><span class="line">set.add(<span class="number">127</span>);</span><br><span class="line">set.add(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">System.gc();</span><br><span class="line"></span><br><span class="line">System.out.println(set); <span class="comment">// [127]</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - åºå·5</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20%E8%AD%A6%E5%8F%B75.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20%E8%AD%A6%E5%8F%B75.html</url>
      
        <content type="html"><![CDATA[<p><imgsrc="https://assets-prd.punchdrink.com/wp-content/uploads/2023/11/03143721/Vertical__5-500x688.jpg" /></p><h1 id="section">#5</h1><p><a href="https://punchdrink.com/recipes/number-5/">#5 BourbonCocktail Recipe | PUNCH (punchdrink.com)</a></p><p>ä½œä¸º 2015 å¹´ 1 æœˆå‘å¸ƒ Trick Dogçš„å”äººè¡—èœå•çš„çˆ†æ¬¾ï¼Œè¿™æ¬¾â€œè¾›è¾£æ³¢æœ¬æŸ‘æ©˜é¦™è‚ â€ï¼ˆæ­£å¦‚åº—ä¸» Josh Harrisæ‰€æè¿°çš„ï¼‰æ­£å¤„äºæ½®æµä¹‹ä¸­ï¼Œåœ¨èœå•å‘å¸ƒçš„ 6 ä¸ªæœˆé‡Œï¼Œè¿™å®¶é…’å§çš„é”€é‡è¶…è¿‡äº†11000 ä¸ª #5</p><p>è¿™ç§é¥®æ–™é€šå¸¸ç”¨ä¸€ä¸²æ·»åŠ äº†é¦™èœé£å‘³çš„èŠ’æœå—è£…é¥°ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨é£å¹²æ©™ç‰‡å’Œå§œç³–æ¥è·å¾—ç±»ä¼¼çš„æ³¥åœŸå‘³å’Œé…¸å‘³</p><h2 id="åŸæ–™">åŸæ–™</h2><ul><li>æ³¢æœ¬ï¼ˆæœ€å¥½æ˜¯ Old Grand-Dad Bondedï¼‰ - 1.5 ç›å¸ï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/7471/old-grand-dad-bonded-100-proof">OldGrand-Dad Bonded)</a>ï¼‰</li><li>èŠ’æœç³–æµ†ï¼ˆè§æ³¨é‡Šï¼‰ - 0.75 ç›å¸</li><li>æŸ æª¬æ± - 0.75 ç›å¸</li><li>Ancho Reyes chile åˆ©å£é…’ - 0.5 ç›å¸</li><li>å®‰é«˜å¤©å¨œè‹¦ç²¾ - 4 dashesï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/3505/angostura-orange-bitters">AngosturaOrange Bitters</a>ï¼‰</li></ul><p><strong>è£…é¥°ï¼š</strong>ä¸²æœ‰é¦™èœé£å‘³çš„èŠ’æœå—æˆ–é£å¹²æ©™ç‰‡å’Œå§œç³–</p><h2 id="æ­¥éª¤">æ­¥éª¤</h2><ol type="1"><li>å°†æ‰€æœ‰åŸæ–™åŠ å…¥åŠ æœ‰å†°å—çš„æ‘‡å£¶ä¸­ï¼Œæ‘‡è‡³å†·å´</li><li>æ»¤å…¥ä¸€ä¸ªåŠ å†°çš„åŒå±‚è€å¼ç»ç’ƒæ¯ä¸­</li><li>æ”¾ä¸Šè£…é¥°</li></ol><h2 id="æ³¨é‡Š">æ³¨é‡Š</h2><h3 id="èŠ’æœç³–æµ†mango-syrup">èŠ’æœç³–æµ†ï¼ˆMango Syrupï¼‰</h3><ul><li>ç™½ç ‚ç³– - 1.5 åƒå…‹</li><li>çº¯å‡€æ°´ - 1 å‡</li><li>èŠ’æœæ³¥ - 850 å…‹</li><li>å¢¨è¥¿å“¥å¯ä¹ - 2 ç“¶ 355 æ¯«å‡</li><li>å§œç‰‡ - 100 å…‹</li><li>çŠ¹å¤ªç›ï¼ˆkosher saltï¼‰ - 1.5 å‹º</li></ul><p>å°†æ‰€æœ‰ææ–™åŠ å…¥é”…ä¸­ï¼Œç”¨å°ç«æ…¢ç…®åŠ çƒ­</p><p>ä»ç«ä¸Šå–ä¸‹ï¼Œå€’å…¥ä¿æ¸©æ¡¶é™ç½® 4 åˆ° 6 ä¸ªå°æ—¶ï¼Œç”¨æ»¤ç½‘æ»¤å‡ºå†·è—</p><h3 id="èŠ’æœæ–¹å—mango-cubes">èŠ’æœæ–¹å—ï¼ˆ<strong>MangoCubes</strong>ï¼‰</h3><p>å‰¥å‡ ä¸ªåˆšæˆç†Ÿçš„èŠ’æœï¼ˆåº”è¯¥æœ‰ç‚¹è½¯ï¼Œä½†ä¸è¦è¿‡ç†Ÿå¯¼è‡´ç³ŠçŠ¶ï¼‰åˆ‡ä¸€ä¸ªæ¼‚äº®çš„é•¿æ–¹ä½“ï¼Œç„¶ååˆ‡0.5 å˜ç±³çš„æ–¹å—</p><p>ç„¶ååœ¨å¯†å°è¢‹ä¸­åŠ å…¥é¦™èœç³–æµ†ï¼ˆè§æ³¨é‡Šï¼‰å¯†å°ï¼Œå†·è— 2 åˆ° 3 å¤©</p><h3 id="é¦™èœç³–æµ†cilantro-syrup">é¦™èœç³–æµ†ï¼ˆCilantro Syrupï¼‰</h3><ul><li>ç™½ç ‚ç³– - 1 åƒå…‹</li><li>çº¯å‡€æ°´ - 1 å‡</li><li>ç„¯æ°´é¦™èœ - 30 å…‹</li><li>ç› - 1 å‹º</li></ul><p>å°†æ‰€æœ‰ææ–™åŠ å…¥é”…ä¸­ï¼Œç”¨å°ç«æ…¢ç…®åŠ çƒ­</p><p>ä»ç«ä¸Šå–ä¸‹ï¼Œå€’å…¥ä¿æ¸©æ¡¶é™ç½® 4 åˆ° 6 ä¸ªå°æ—¶ï¼Œç”¨æ»¤ç½‘æ»¤å‡ºå†·è—</p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.4 - è¾“å‡ºè§£æå™¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.4%20-%20%E8%BE%93%E5%87%BA%E8%A7%A3%E6%9E%90%E5%99%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.4%20-%20%E8%BE%93%E5%87%BA%E8%A7%A3%E6%9E%90%E5%99%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="åˆ—è¡¨è§£æå™¨">åˆ—è¡¨è§£æå™¨</h1><p>è¿”å›é€—å·åˆ†éš”çš„é¡¹ç›®åˆ—è¡¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤è¾“å‡ºè§£æå™¨</p><p><strong>è§£æå™¨å’Œ prompt</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—è¡¨è§£æå™¨</span></span><br><span class="line">output_parser = CommaSeparatedListOutputParser()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—è¡¨è§£æå™¨è‡ªå¸¦æ ¼å¼è¯´æ˜</span></span><br><span class="line">format_instructions = output_parser.get_format_instructions()</span><br><span class="line"><span class="comment"># prompt template</span></span><br><span class="line">prompt_template = PromptTemplate(</span><br><span class="line">    template=<span class="string">&quot;åˆ—ä¸¾å‡ºäº”ä¸ª&#123;subject&#125;.\n&#123;format_instructions&#125;&quot;</span>,</span><br><span class="line">    input_variables=[<span class="string">&quot;subject&quot;</span>],</span><br><span class="line">    partial_variables=&#123;<span class="string">&quot;format_instructions&quot;</span>: format_instructions&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AI æ¨¡å‹</span></span><br><span class="line">model = Azure.chat_model</span><br><span class="line">output = model.predict(prompt_template.<span class="built_in">format</span>(subject=<span class="string">&quot;æ£’æ£’ç³–å£å‘³&quot;</span>))</span><br><span class="line"><span class="comment"># è§£æ</span></span><br><span class="line"><span class="built_in">print</span>(output_parser.parse(output))</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; [&#x27;è‰è“å‘³&#x27;, &#x27;è‘¡è„å‘³&#x27;, &#x27;æ©™å­å‘³&#x27;, &#x27;è‹¹æœå‘³&#x27;, &#x27;è“è“å‘³&#x27;]</span></span><br></pre></td></tr></table></figure><h1 id="æ—¥æœŸè§£æå™¨">æ—¥æœŸè§£æå™¨</h1><p>è¾“å‡ºè§£æä¸ºæ—¥æœŸæ—¶é—´æ ¼å¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¥æœŸè§£æå™¨</span></span><br><span class="line">output_parser = DatetimeOutputParser()</span><br><span class="line">template = <span class="string">&quot;&quot;&quot;Answer the users question:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;question&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;format_instructions&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># prompt template</span></span><br><span class="line">prompt_template = PromptTemplate.from_template(</span><br><span class="line">    template,</span><br><span class="line">    partial_variables=&#123;<span class="string">&quot;format_instructions&quot;</span>: output_parser.get_format_instructions()&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AI æ¨¡å‹</span></span><br><span class="line">model = Azure.chat_model</span><br><span class="line">chain = LLMChain(prompt=prompt, llm=model)</span><br><span class="line">output = chain.run(<span class="string">&quot;around when was bitcoin founded?&quot;</span>)</span><br><span class="line"><span class="comment"># è§£æ</span></span><br><span class="line"><span class="built_in">print</span>(output_parser.parse(output))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½æ˜¯å› ä¸ºä½¿ç”¨äº†AzureOpenAIï¼Œæ²¡æ³•æŒ‰ç…§é™åˆ¶çš„æ ¼å¼è¾“å‡ºï¼Œä¸å¤ªç¨³å®š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValueError: time data <span class="string">&#x27;Bitcoin was founded on January 3, 2009. The corresponding datetime string would be &quot;2009-01-03T00:00:00.000000Z&quot;.&#x27;</span> does not match format <span class="string">&#x27;%Y-%m-%dT%H:%M:%S.%fZ&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="æšä¸¾è§£æå™¨">æšä¸¾è§£æå™¨</h1><p>æšä¸¾è§£æå™¨ç”¨æ¥è§£ææšä¸¾</p><p><strong>å®šä¹‰æšä¸¾</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Colors</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    WHITE = <span class="string">&quot;ç™½è‰²&quot;</span></span><br><span class="line">    RED = <span class="string">&quot;çº¢è‰²&quot;</span></span><br><span class="line">    GREEN = <span class="string">&quot;ç»¿è‰²&quot;</span></span><br><span class="line">    BLUE = <span class="string">&quot;è“è‰²&quot;</span></span><br><span class="line">    YELLOW = <span class="string">&quot;é»„è‰²&quot;</span></span><br></pre></td></tr></table></figure><p><strong>è§£æå™¨å’Œ prompt</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">parser = EnumOutputParser(enum=Colors)</span><br><span class="line">prompt_template = PromptTemplate.from_template(<span class="string">&quot;é€‰æ‹©ä¸€ä¸ªä½ æœ€å–œæ¬¢çš„é¢œè‰²\n&#123;format_instructions&#125;&quot;</span>)</span><br><span class="line">prompt = prompt_template.<span class="built_in">format</span>(format_instructions=parser.get_format_instructions())</span><br><span class="line"><span class="built_in">print</span>(prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; é€‰æ‹©ä¸€ä¸ªä½ æœ€å–œæ¬¢çš„é¢œè‰²\nSelect one of the following options: ç™½è‰², çº¢è‰², ç»¿è‰², è“è‰², é»„è‰²</span></span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">model = Azure.chat_model</span><br><span class="line">result = model.predict(prompt)</span><br><span class="line"><span class="built_in">print</span>(parser.parse(result))</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; Colors.BLUE</span></span><br></pre></td></tr></table></figure><h1 id="ç»“æ„åŒ–è§£æå™¨">ç»“æ„åŒ–è§£æå™¨</h1><p>å½“éœ€è¦è¿”å›å¤šä¸ªå­—æ®µæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§è¾“å‡ºè§£æå™¨ï¼ŒPydantic Â JSONè§£æå™¨ç›¸æ¯”ä¹‹ä¸‹æ›´å¼ºå¤§</p><p><strong>å®šä¹‰æˆ‘ä»¬æƒ³è¦æ¥æ”¶çš„å“åº”ç»“æ„</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»“æ„å®šä¹‰</span></span><br><span class="line">response_schemas = [</span><br><span class="line">    ResponseSchema(name=<span class="string">&quot;answer&quot;</span>, description=<span class="string">&quot;å›ç­”ç”¨æˆ·çš„é—®é¢˜&quot;</span>),</span><br><span class="line">    ResponseSchema(name=<span class="string">&quot;source&quot;</span>, description=<span class="string">&quot;ç”¨äºå›ç­”ç”¨æˆ·é—®é¢˜çš„æ¥æºï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªç½‘ç«™&quot;</span>),</span><br><span class="line">    ResponseSchema(name=<span class="string">&quot;score&quot;</span>, description=<span class="string">&quot;ç»™è‡ªå·±çš„å›ç­”æ‰“åˆ†ï¼Œæ»¡åˆ† 100&quot;</span>, <span class="built_in">type</span>=<span class="string">&quot;num&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè§£æå™¨</span></span><br><span class="line">output_parser = StructuredOutputParser.from_response_schemas(response_schemas)</span><br></pre></td></tr></table></figure><p><strong>æç¤ºæ¨¡æ¿</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆçš„æ ¼å¼è¯´æ˜</span></span><br><span class="line">format_instructions = output_parser.get_format_instructions()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æç¤ºæ¨¡æ¿</span></span><br><span class="line">prompt_template = PromptTemplate(</span><br><span class="line">    template=<span class="string">&quot;å°½å¯èƒ½å›ç­”ç”¨æˆ·çš„é—®é¢˜.\n&#123;format_instructions&#125;\n&#123;question&#125;&quot;</span>,</span><br><span class="line">    input_variables=[<span class="string">&quot;question&quot;</span>],</span><br><span class="line">    partial_variables=&#123;<span class="string">&quot;format_instructions&quot;</span>: format_instructions&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">model = Azure.chat_model</span><br><span class="line">prompt = prompt.<span class="built_in">format</span>(question=<span class="string">&quot;ä¸­å›½çš„é¦–éƒ½æ˜¯å“ªä¸ªåŸå¸‚ï¼Ÿ&quot;</span>)</span><br><span class="line">output = model.predict(prompt)</span><br><span class="line">result = output_parser.parse(output)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç±»å‹</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(result))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(result[<span class="string">&quot;answer&quot;</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(result[<span class="string">&quot;source&quot;</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(result[<span class="string">&quot;score&quot;</span>]))</span><br><span class="line"><span class="comment"># &gt;&gt; &lt;class &#x27;dict&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &gt;&gt; &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &gt;&gt; &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &gt;&gt; &lt;class &#x27;int&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­”æ¡ˆ</span></span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># &gt;&gt; &#123;&#x27;answer&#x27;: &#x27;ä¸­å›½çš„é¦–éƒ½æ˜¯åŒ—äº¬ã€‚&#x27;, &#x27;source&#x27;: &#x27;https://zh.wikipedia.org/wiki/%E5%8C%97%E4%BA%AC&#x27;, &#x27;score&#x27;: 100&#125;</span></span><br></pre></td></tr></table></figure><h1 id="pydantic-json-è§£æå™¨">Pydantic Â JSON è§£æå™¨</h1><p>è¯¥è¾“å‡ºè§£æå™¨å…è®¸ç”¨æˆ·æŒ‡å®šä»»æ„çš„ JSON æ¨¡å¼ï¼Œå¹¶æŸ¥è¯¢ç¬¦åˆè¯¥æ¨¡å¼çš„ JSONè¾“å‡º</p><blockquote><p>éœ€è¦æ³¨æ„</p><p>å¤§å‹è¯­è¨€æ¨¡å‹æ˜¯æœ‰æ¼æ´çš„ï¼Œå¿…é¡»ä½¿ç”¨å…·æœ‰è¶³å¤Ÿå®¹é‡çš„ LLM æ¥ç”Ÿæˆæ ¼å¼æ­£ç¡®çš„JSON åœ¨ OpenAI å®¶æ—ä¸­ï¼ŒDaVinci çš„èƒ½åŠ›å¯é ï¼Œä½† Curie çš„èƒ½åŠ›ä¸è¶³</p></blockquote><p>ä½¿ç”¨ Pydantic æ¥å£°æ˜æ•°æ®æ¨¡å‹ï¼›Pydantic çš„ã€‚BaseModel ç±»ä¼¼äº Pythonçš„æ•°æ®ç±»ï¼Œä½†å…·æœ‰çœŸæ­£çš„ç±»å‹æ£€æŸ¥å’Œå¼ºåˆ¶è½¬æ¢åŠŸèƒ½</p><p><strong>å®šä¹‰ç»“æ„</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define your desired data structure.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Joke</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    setup: <span class="built_in">str</span> = Field(description=<span class="string">&quot;question to set up a joke&quot;</span>)</span><br><span class="line">    punchline: <span class="built_in">str</span> = Field(description=<span class="string">&quot;answer to resolve the joke&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‚¨å¯ä»¥ä½¿ç”¨ Pydantic è½»æ¾æ·»åŠ è‡ªå®šä¹‰éªŒè¯é€»è¾‘</span></span><br><span class="line"><span class="meta">    @validator(<span class="params"><span class="string">&quot;setup&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">question_ends_with_question_mark</span>(<span class="params">cls, field</span>):</span><br><span class="line">        <span class="keyword">if</span> field[-<span class="number">1</span>] != <span class="string">&quot;?&quot;</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Badly formed question!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> field</span><br><span class="line">      </span><br><span class="line"><span class="comment"># PydanticOutputParser è§£æå™¨</span></span><br><span class="line">parser = PydanticOutputParser(pydantic_object=Joke)</span><br></pre></td></tr></table></figure><p><strong>å®šä¹‰æ¨¡æ¿</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># And a query intented to prompt a language model to populate the data structure.</span></span><br><span class="line">joke_query = <span class="string">&quot;Tell me a joke.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># prompt template</span></span><br><span class="line">prompt_template = PromptTemplate(</span><br><span class="line">    template=<span class="string">&quot;Answer the user query.\n&#123;format_instructions&#125;\n&#123;query&#125;\n&quot;</span>,</span><br><span class="line">    input_variables=[<span class="string">&quot;query&quot;</span>],</span><br><span class="line">    partial_variables=&#123;<span class="string">&quot;format_instructions&quot;</span>: parser.get_format_instructions()&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prompt = prompt_template.format_prompt(query=joke_query)</span><br><span class="line">output = model(_<span class="built_in">input</span>.to_string())</span><br><span class="line"><span class="built_in">print</span>(parser.parse(prompt))</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; Joke(setup=&#x27;Why did the chicken cross the road?&#x27;, punchline=&#x27;To get to the other side!&#x27;)</span></span><br></pre></td></tr></table></figure><p>å¤åˆç±»å‹å­—æ®µçš„ç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Here&#x27;s another example, but with a compound typed field.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Actor</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(description=<span class="string">&quot;name of an actor&quot;</span>)</span><br><span class="line">    film_names: <span class="type">List</span>[<span class="built_in">str</span>] = Field(description=<span class="string">&quot;list of names of films they starred in&quot;</span>)</span><br></pre></td></tr></table></figure><h1 id="è‡ªåŠ¨ä¿®å¤è§£æå™¨">è‡ªåŠ¨ä¿®å¤è§£æå™¨</h1><p>è‡ªåŠ¨ä¿®å¤è§£æå™¨åŒ…è£…å¦ä¸€ä¸ªè¾“å‡ºè§£æå™¨ï¼Œå¦‚æœç¬¬ä¸€ä¸ªè§£æå™¨å¤±è´¥ï¼Œå®ƒä¼šè°ƒç”¨å¦ä¸€ä¸ªLLM æ¥ä¿®å¤é”™è¯¯</p><p>ä½†é™¤äº†æŠ›å‡ºé”™è¯¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åšå…¶ä»–äº‹æƒ…ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å°†æ ¼å¼é”™è¯¯çš„è¾“å‡ºå’Œæ ¼å¼åŒ–çš„æŒ‡ä»¤ä¸€èµ·ä¼ é€’ç»™æ¨¡å‹ï¼Œå¹¶è¦æ±‚å®ƒè¿›è¡Œä¿®å¤</p><p><strong>å®šä¹‰ç»“æ„</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Actor</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(description=<span class="string">&quot;name of an actor&quot;</span>)</span><br><span class="line">    film_names: <span class="type">List</span>[<span class="built_in">str</span>] = Field(description=<span class="string">&quot;list of names of films they starred in&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Pydantic è§£æå™¨</span></span><br><span class="line">parser = PydanticOutputParser(pydantic_object=Actor)</span><br></pre></td></tr></table></figure><p><strong>é”™è¯¯è¯­å¥è§£æ</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mis_formatted = <span class="string">&quot;&#123;&#x27;name&#x27;: &#x27;æ±¤å§†æ±‰å…‹æ–¯&#x27;, &#x27;film_names&#x27;: [&#x27;é˜¿ç”˜æ­£ä¼ &#x27;]&#125;&quot;</span></span><br><span class="line">parser.parse(mis_formatted)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ JSON æ ¼å¼æ˜¯é”™è¯¯çš„ï¼ˆå•å¼•å·ï¼‰ï¼Œæ‰€ä»¥æŠ›å‡ºå¼‚å¸¸</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">langchain.schema.output_parser.OutputParserException: Failed to parse Actor from completion &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;æ±¤å§†æ±‰å…‹æ–¯&#x27;</span>, <span class="string">&#x27;film_names&#x27;</span>: [<span class="string">&#x27;é˜¿ç”˜æ­£ä¼ &#x27;</span>]&#125;. Got: Expecting property name enclosed <span class="keyword">in</span> double quotes: line 1 column 2 (char 1)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨è‡ªåŠ¨ä¿®å¤è§£æå™¨åŒ…è£…è§£æå™¨å’Œ LLM</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">new_parser = OutputFixingParser.from_llm(parser=parser, llm=Azure.chat_model, max_retries=<span class="number">2</span>)</span><br><span class="line">result = new_parser.parse(mis_formatted)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; name=&#x27;Tom Hanks&#x27; film_names=[&#x27;Forrest Gump&#x27;]</span></span><br><span class="line"><span class="comment"># å‘ƒï¼Œè¿™é‡Œè¢« AI ä¿®å¤æˆäº†è‹±æ–‡</span></span><br></pre></td></tr></table></figure><p>å®ç°åŸç†å°±æ˜¯è¿›è¡Œé‡è¯•ï¼Œå°†è§£æå™¨çš„æ ¼å¼è¯´æ˜å’Œé”™è¯¯å†…å®¹äº¤ç»™ AIé‡æ–°è¿›è¡Œå¤„ç†</p><h1 id="é‡è¯•è§£æå™¨">é‡è¯•è§£æå™¨</h1><p>æŸäº›æƒ…å†µä¸‹æŸ¥çœ‹è¾“å‡ºå°±å¯ä»¥ä¿®å¤è§£æé”™è¯¯</p><p>ä½†æ˜¯ä¾‹å¦‚è¾“å‡ºä¸ä»…æ ¼å¼ä¸æ­£ç¡®ï¼Œè€Œä¸”ä¸å®Œæ•´åˆ™å®Œå…¨æ— æ³•è§£æ</p><p><strong>å‡è®¾å®šä¹‰ç»“æ„å’Œé”™è¯¯è¿”å›</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Action</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    action: <span class="built_in">str</span> = Field(description=<span class="string">&quot;action to take&quot;</span>)</span><br><span class="line">    action_input: <span class="built_in">str</span> = Field(description=<span class="string">&quot;input to the action&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># é”™è¯¯è¿”å›å¹¶æ²¡æœ‰ action_input çš„ä¿¡æ¯</span></span><br><span class="line">bad_response = <span class="string">&#x27;&#123;&quot;action&quot;: &quot;search&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ <code>OutputFixingParser</code> ä¹Ÿæ— æ³•å®Œæ•´ä¿®å¤ï¼Œå› ä¸º AIå¹¶ä¸æ¸…æ¥šæ•°æ®æ˜¯ä»€ä¹ˆï¼ˆæ„Ÿè§‰å¯ä»¥ç†è§£ä¸ºä¿®å¤çš„æ›´å¤šæ˜¯æ ¼å¼é”™è¯¯ï¼Œæ— æ³•ä¿®å¤å†…å®¹çš„ä¸å®Œæ•´ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fix_parser = OutputFixingParser.from_llm(parser=parser, llm=Azure.chat_model)</span><br><span class="line"><span class="built_in">print</span>(fix_parser.parse(bad_response))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®å¤ç»“æœä¾ç„¶æ˜¯ä¸å®Œæ•´çš„</span></span><br><span class="line"><span class="comment"># &gt;&gt; Action(action=&#x27;search&#x27;, action_input=&#x27;&#x27;)</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±éœ€è¦é‡è¯•è¿›è¡Œè§£å†³</p><p><strong>ä½¿ç”¨ RetryOutputParser</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º RetryWithErrorOutputParser</span></span><br><span class="line">retry_parser = RetryWithErrorOutputParser.from_llm(</span><br><span class="line">    parser=parser, llm=Azure.chat_model</span><br><span class="line">)</span><br><span class="line">retry_parser.parse_with_prompt(bad_response, prompt_value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; Action(action=&#x27;search&#x27;, action_input=&#x27;who is leo di caprios gf?&#x27;)</span></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://python.langchain.com.cn/docs/modules/model_io/output_parsers/">è¾“å‡ºè§£æå™¨(Output Parsers) | ğŸ¦œï¸ğŸ”— Langchain</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.3 - ç¤ºä¾‹é€‰æ‹©å™¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.3%20-%20%E7%A4%BA%E4%BE%8B%E9%80%89%E6%8B%A9%E5%99%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.3%20-%20%E7%A4%BA%E4%BE%8B%E9%80%89%E6%8B%A9%E5%99%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="mmr">MMR</h1><p>MMRä¸ºæœ€å¤§è¾¹é™…ç›¸å…³æ€§ï¼Œ<code>MaxMarginalRelevanceExampleSelector</code>æ ¹æ®ç¤ºä¾‹ä¸è¾“å…¥ä¹‹é—´çš„ç›¸ä¼¼åº¦ä»¥åŠå¤šæ ·æ€§æ¥é€‰æ‹©ç¤ºä¾‹</p><p>é€šè¿‡å¯»æ‰¾ä¸è¾“å…¥å…·æœ‰æœ€å¤§ä½™å¼¦ç›¸ä¼¼åº¦çš„åµŒå…¥çš„ç¤ºä¾‹ï¼Œå¹¶åœ¨è¿­ä»£ä¸­è¿›è¡Œæ·»åŠ ï¼›åŒæ—¶å¯¹ä¸å·²é€‰æ‹©ç¤ºä¾‹çš„ç›¸ä¼¼åº¦è¿›è¡Œæƒ©ç½šæ¥è¿›è¡Œå®ç°</p><p><strong>import</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts.example_selector <span class="keyword">import</span> (</span><br><span class="line">    MaxMarginalRelevanceExampleSelector,</span><br><span class="line">    SemanticSimilarityExampleSelector,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> langchain.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain.embeddings <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> FewShotPromptTemplate, PromptTemplate</span><br></pre></td></tr></table></figure><p><strong>æ„é€ æç¤ºæ¨¡æ¿å’Œç¤ºä¾‹é›†åˆ</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">example_prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>, <span class="string">&quot;output&quot;</span>],</span><br><span class="line">    template=<span class="string">&quot;Input: &#123;input&#125;\nOutput: &#123;output&#125;&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åä¹‰è¯ç¤ºä¾‹é›†</span></span><br><span class="line">examples = [</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;happy&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;sad&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;tall&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;short&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;energetic&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;lethargic&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;sunny&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;gloomy&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;windy&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;calm&quot;</span>&#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º MaxMarginalRelevanceExampleSelector</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">example_selector = MaxMarginalRelevanceExampleSelector.from_examples(</span><br><span class="line">    <span class="comment"># å¯ä¾›é€‰æ‹©çš„ç¤ºä¾‹åˆ—è¡¨</span></span><br><span class="line">    examples,</span><br><span class="line">    <span class="comment"># ç”¨äºç”Ÿæˆç”¨äºæµ‹é‡è¯­ä¹‰ç›¸ä¼¼æ€§çš„åµŒå…¥çš„åµŒå…¥ç±»ï¼ˆLangChain å¯¹æ¥äº†å¾ˆå¤šä¸‰æ–¹ Embedding APIï¼‰</span></span><br><span class="line">    OpenAIEmbeddings(),</span><br><span class="line">    <span class="comment"># è¿™æ˜¯ VectorStore ç±»ï¼Œç”¨äºå­˜å‚¨åµŒå…¥å¹¶è¿›è¡Œç›¸ä¼¼æ€§æœç´¢</span></span><br><span class="line">    FAISS,</span><br><span class="line">    <span class="comment"># é€‰æ‹©çš„ç¤ºä¾‹æ•°</span></span><br><span class="line">    k=<span class="number">2</span>,</span><br><span class="line">)</span><br><span class="line">mmr_prompt = FewShotPromptTemplate(</span><br><span class="line">    <span class="comment"># æä¾›äº† ExampleSelector è€Œä¸æ˜¯ç¤ºä¾‹é›†</span></span><br><span class="line">    example_selector=example_selector,</span><br><span class="line">    example_prompt=example_prompt,</span><br><span class="line">    prefix=<span class="string">&quot;Give the antonym of every input&quot;</span>,</span><br><span class="line">    suffix=<span class="string">&quot;Input: &#123;adjective&#125;\nOutput:&quot;</span>,</span><br><span class="line">    input_variables=[<span class="string">&quot;adjective&quot;</span>],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>FewShotPromptTemplate fomat</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¾“å…¥çš„ worried æ˜¯ä¸€ç§æ„Ÿè§‰</span></span><br><span class="line"><span class="comment"># æ‰€ä»¥åº”è¯¥é€‰æ‹© happy/sad çš„ä¾‹å­ä½œä¸ºç¬¬ä¸€ä¸ª</span></span><br><span class="line"><span class="built_in">print</span>(mmr_prompt.<span class="built_in">format</span>(adjective=<span class="string">&quot;worried&quot;</span>))</span><br></pre></td></tr></table></figure><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Give the antonym of every <span class="keyword">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: happy</span><br><span class="line"><span class="keyword">Output</span>: sad</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: windy</span><br><span class="line"><span class="keyword">Output</span>: calm</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: worried</span><br><span class="line"><span class="keyword">Output</span>:</span><br></pre></td></tr></table></figure><h1 id="semanticsimilarity">SemanticSimilarity</h1><p>æ ¹æ®ä¸è¾“å…¥çš„ç›¸ä¼¼åº¦é€‰æ‹©ç¤ºä¾‹ï¼Œé€šè¿‡æ‰¾åˆ°ä¸è¾“å…¥å…·æœ‰æœ€å¤§ä½™å¼¦ç›¸ä¼¼åº¦çš„embedding ä¾‹å­æ¥å®ç°æ­¤ç›®çš„</p><h1 id="embedding">Embedding</h1><p><code>embedding</code> ä¸­æ–‡ç¿»è¯‘æ˜¯â€œåµŒå…¥â€</p><p>åœ¨â¾ƒç„¶è¯­â¾”å¤„ç†å’Œæœºå™¨å­¦ä¹ é¢†åŸŸï¼Œ<code>embedding</code>æ˜¯æŒ‡å°†å•è¯ã€çŸ­è¯­æˆ–â½‚æœ¬ç­‰ç¦»æ•£å˜é‡è½¬æ¢æˆè¿ç»­å‘é‡ç©ºé—´çš„è¿‡ç¨‹</p><p>å‘é‡ç©ºé—´é€šå¸¸è¢«ç§°ä¸ºåµŒâ¼Šç©ºé—´ <em>embeddingspace</em>ï¼Œâ½£æˆçš„å‘é‡åˆ™ç§°ä¸ºåµŒâ¼Šå‘é‡ <em>embedding vector</em>æˆ–å‘é‡åµŒâ¼Š<em>vector embedding</em></p><p><br></p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ embedding</strong></p><p>LLM æœ‰ä¸€äº›æ— æ³•è§£å†³çš„é—®é¢˜ï¼š</p><ul><li>LLM çš„è®­ç»ƒæ•°æ®æ˜¯æœ‰æ—¶é—´çº¦æŸçš„ï¼Œæ— æ³•è·å–åˆ°æœ€æ–°çš„ä¸€äº›ä¿¡æ¯</li><li>LLM ä¸çŸ¥é“ç­”æ¡ˆåå¼€å§‹æ”¾é£è‡ªæˆ‘ï¼Œå‡ºç° hallucination</li><li>åº”ç”¨åŒ–ï¼ˆä¾‹å¦‚å®¢æœï¼‰ï¼Œæ•°æ®éœ€è¦è‡ªä¸»æä¾›</li></ul><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼ŒLLMçš„ä¾›åº”å•†ä¸€èˆ¬æä¾›äº†å¦‚ä¸‹æœºåˆ¶ï¼šç»´æŠ¤è‡ªå·±çš„æ•°æ®é›†ï¼Œç”¨æˆ·è¾“å…¥ promptä¹‹åé¦–å…ˆåŒ¹é…è‡ªä¸»ç»´æŠ¤çš„æ•°æ®é›†ï¼Œæ‰¾åˆ°ç›¸å…³æ€§å¼ºçš„éƒ¨åˆ†ï¼Œå†ç»“åˆæˆæœ€ç»ˆçš„ promptäº¤ç»™ LLM</p><p>æ–°çš„é—®é¢˜å‡ºç°äº† <strong>æ€ä¹ˆåœ¨æˆ‘ä»¬çš„æ•°æ®é›†ä¸­æ£€ç´¢åˆ°å’Œ promptç›¸å…³çš„å†…å®¹</strong></p><p>æ•°æ®å‘é‡æ˜¯å°†æ•°æ®è¡¨ç¤ºä¸ºæ•°å€¼å‘é‡çš„å½¢å¼ï¼Œç”¨äºæ–¹ä¾¿åœ°è¿›è¡Œè®¡ç®—ã€åˆ†æå’Œå¤„ç†ï¼Œå¤„ç†ä¸ºå‘é‡åè®¡ç®—æœºæ‰å¯ä»¥æ›´å¥½çš„å¯¹å†…å®¹æœºè¿›è¡Œç›¸å…³æ€§çš„åˆ¤æ–­</p><p><br></p><p>LangChain è¿™é‡Œä½¿ç”¨äº† OpenAI çš„ embedding API ç”Ÿæˆå†…å®¹å¯¹åº”çš„ embeddingvectors</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">example_selector = MaxMarginalRelevanceExampleSelector.from_examples(</span><br><span class="line">    examples,</span><br><span class="line">    <span class="comment"># ç”¨äºç”Ÿæˆç”¨äºæµ‹é‡è¯­ä¹‰ç›¸ä¼¼æ€§çš„åµŒå…¥çš„åµŒå…¥ç±»ï¼ˆLangChain å¯¹æ¥äº†å¾ˆå¤šä¸‰æ–¹ Embedding APIï¼‰</span></span><br><span class="line">    OpenAIEmbeddings(),</span><br><span class="line">    FAISS,</span><br><span class="line">    k=<span class="number">2</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¹Ÿæä¾›äº†å¾ˆå¤š LLM çš„ APIï¼Œä¾‹å¦‚å¾®è½¯ Azure çš„æœ‰<code>AzureOpenAIEmbeddings</code></p><p>ä¸è¿‡éœ€è¦éƒ¨ç½²ç›¸åº”çš„æ¨¡å‹æ‰èƒ½ä½¿ç”¨ï¼Œæ¨¡å‹ä¸åŒ¹é…ä¼šæç¤º</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The embeddings operation <span class="keyword">does</span> <span class="keyword">not</span> work <span class="keyword">with</span> <span class="keyword">the</span> specified model, gpt<span class="number">-35</span>-turbo<span class="number">-16</span>k. Please choose different model <span class="keyword">and</span> <span class="keyword">try</span> again. </span><br></pre></td></tr></table></figure><h1 id="n-gram-overlap">N-gram overlap</h1><p><code>NGramOverlapExampleSelector</code> æ ¹æ®ç¤ºä¾‹ä¸è¾“å…¥ä¹‹é—´çš„ n-gramé‡å ç¨‹åº¦é€‰æ‹©å’Œæ’åºç¤ºä¾‹</p><p>N-gram é‡å å¾—åˆ†æ˜¯ä¸€ä¸ªåœ¨ 0.0 åˆ° 1.0 ä¹‹é—´ï¼ˆé—­åŒºé—´ï¼‰çš„æµ®ç‚¹æ•°</p><p>é€‰æ‹©å™¨å…è®¸è®¾ç½®é˜ˆå€¼åˆ†æ•°ï¼Œn-gramé‡å å¾—åˆ†å°äºæˆ–ç­‰äºé˜ˆå€¼çš„ç¤ºä¾‹å°†è¢«æ’é™¤åœ¨å¤–ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œé˜ˆå€¼è®¾ç½®ä¸º-1.0ï¼Œå› æ­¤ä¸ä¼šæ’é™¤ä»»ä½•ç¤ºä¾‹</p><p><strong>è®¾ç½®æç¤ºæ¨¡æ¿å’Œç¤ºä¾‹</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">example_prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>, <span class="string">&quot;output&quot;</span>],</span><br><span class="line">    template=<span class="string">&quot;Input: &#123;input&#125;\nOutput: &#123;output&#125;&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># These are examples of a fictional translation task.</span></span><br><span class="line">examples = [</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;See Spot run.&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;Ver correr a Spot.&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;My dog barks.&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;Mi perro ladra.&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;Spot can run.&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;Spot puede correr.&quot;</span>&#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º NGramOverlapExampleSelector é€‰æ‹©å™¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">example_selector = NGramOverlapExampleSelector(</span><br><span class="line">    examples=examples,</span><br><span class="line">    example_prompt=example_prompt,</span><br><span class="line">    <span class="comment"># è¿™æ˜¯é€‰æ‹©å™¨åœæ­¢çš„é˜ˆå€¼</span></span><br><span class="line">    <span class="comment"># é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒè®¾ç½®ä¸º-1.0</span></span><br><span class="line">    threshold=-<span class="number">1.0</span>,</span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  å¯¹äºè´Ÿé˜ˆå€¼ï¼š</span></span><br><span class="line"><span class="string">  Selector æŒ‰ ngram é‡å åˆ†æ•°å¯¹ç¤ºä¾‹è¿›è¡Œæ’åºï¼Œä¸æ’é™¤ä»»ä½•ç¤ºä¾‹</span></span><br><span class="line"><span class="string">  å¯¹äºå¤§äº 1.0 çš„é˜ˆå€¼ï¼š</span></span><br><span class="line"><span class="string">  é€‰æ‹©å™¨æ’é™¤æ‰€æœ‰ç¤ºä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨</span></span><br><span class="line"><span class="string">  å¯¹äºç­‰äº 0.0 çš„é˜ˆå€¼ï¼š</span></span><br><span class="line"><span class="string">  Selector æ ¹æ® ngram é‡å åˆ†æ•°å¯¹ç¤ºä¾‹è¿›è¡Œæ’åºï¼Œå¹¶ä¸”æ’é™¤ä¸è¾“å…¥æ²¡æœ‰ ngram é‡å çš„é‚£äº›</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">)</span><br><span class="line">dynamic_prompt = FewShotPromptTemplate(</span><br><span class="line">    example_selector=example_selector,</span><br><span class="line">    example_prompt=example_prompt,</span><br><span class="line">    prefix=<span class="string">&quot;Give the Spanish translation of every input&quot;</span>,</span><br><span class="line">    suffix=<span class="string">&quot;Input: &#123;sentence&#125;\nOutput:&quot;</span>,</span><br><span class="line">    input_variables=[<span class="string">&quot;sentence&quot;</span>],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>FewShotPromptTemplate fomat</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># An example input with large ngram overlap with &quot;Spot can run.&quot;</span></span><br><span class="line"><span class="comment"># and no overlap with &quot;My dog barks.&quot;</span></span><br><span class="line"><span class="built_in">print</span>(dynamic_prompt.<span class="built_in">format</span>(sentence=<span class="string">&quot;Spot can run fast.&quot;</span>))</span><br></pre></td></tr></table></figure><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Give the Spanish translation of every <span class="keyword">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: Spot can run.</span><br><span class="line"><span class="keyword">Output</span>: Spot puede correr.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: See Spot run.</span><br><span class="line"><span class="keyword">Output</span>: Ver correr a Spot.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: My dog barks.</span><br><span class="line"><span class="keyword">Output</span>: Mi perro ladra.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: Spot can run fast.</span><br><span class="line"><span class="keyword">Output</span>:</span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ æ–°çš„ç¤ºä¾‹åˆ°é€‰æ‹©å™¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‚¨ä¹Ÿå¯ä»¥å°†æ–°ç¤ºä¾‹æ·»åŠ åˆ° NGramOverlapExampleSelector ä¸­</span></span><br><span class="line">new_example = &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;Spot plays fetch.&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;Spot juega a buscar.&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">example_selector.add_example(new_example)</span><br><span class="line"><span class="built_in">print</span>(dynamic_prompt.<span class="built_in">format</span>(sentence=<span class="string">&quot;Spot can run fast.&quot;</span>))</span><br></pre></td></tr></table></figure><h1 id="n-gram-æ“ä½œ">N-gram æ“ä½œ</h1><p>N-gramï¼ˆnå…ƒè¯­æ³•ï¼‰æ˜¯è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„ä¸€ç§å¸¸ç”¨æŠ€æœ¯ï¼Œç”¨äºå°†æ–‡æœ¬åˆ†å‰²æˆè¿ç»­çš„ã€å›ºå®šé•¿åº¦çš„ç‰‡æ®µ</p><p>ä¸€ä¸ª N-gram æ˜¯ç”± N ä¸ªè¿ç»­çš„è¯æˆ–å­—ç¬¦ç»„æˆçš„åºåˆ—</p><p>åœ¨N-gramä¸­ï¼ŒNä»£è¡¨ç‰‡æ®µä¸­çš„è¯æˆ–å­—ç¬¦çš„æ•°é‡ã€‚ä¾‹å¦‚ï¼š</p><ul><li>2-gramï¼ˆä¹Ÿç§°ä¸º bigramï¼‰ç”±ä¸¤ä¸ªè¿ç»­çš„è¯ç»„æˆï¼Œä¾‹å¦‚<code>natural language</code>ã€<code>machine learning</code></li><li>3-gramï¼ˆä¹Ÿç§°ä¸º trigramï¼‰ç”±ä¸‰ä¸ªè¿ç»­çš„è¯ç»„æˆï¼Œä¾‹å¦‚<code>the quick brown</code>ã€<code>learn from data</code></li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¾ƒå°çš„ N å€¼å¯èƒ½æ— æ³•æ•æ‰åˆ°é•¿è·ç¦»çš„è¯­è¨€ä¾èµ–å…³ç³»ï¼Œè€Œè¾ƒå¤§çš„N å€¼å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç¨€ç–é—®é¢˜ï¼›å› æ­¤ï¼Œé€‰æ‹©åˆé€‚çš„ Nå€¼å¯¹äºå…·ä½“ä»»åŠ¡å’Œæ•°æ®é›†æ˜¯éœ€è¦ä»”ç»†è€ƒè™‘çš„</p><p>ç¤ºä¾‹ï¼Œå°† "Today is a good day" ä½¿ç”¨ 2-gram æ‹†åˆ†å¤šä¸ªå­—ç¬¦ä¸²ï¼š</p><ol type="1"><li>"Today is"</li><li>"is a"</li><li>"a good"</li><li>"good day"</li></ol><p><br></p><p>Elasticsearch ä¸­çš„æ¨¡ç³Šï¼ˆwildcardï¼‰æœç´¢ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨ N-gramåˆ†è¯å™¨æ¥å®ç°</p><p><strong>åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç´¢å¼•ï¼Œé…ç½® N-gram åˆ†è¯å™¨</strong></p><p>å…³äº N-gram åˆ†è¯å™¨æ”¯æŒçš„å‚æ•°å¯ä»¥å‚è€ƒ [<ahref="https://www.elastic.co/guide/en/elasticsearch/reference/8.10/analysis-ngram-tokenizer.html">N-gramtokenizer | Elasticsearch Guide [8.10] | Elastic]</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /test-ngram-index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;my_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_ngram_tokenizer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;my_ngram_tokenizer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngram&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;min_gram&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;max_gram&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;token_chars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;letter&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>åˆ†è¯</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_analyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ä»Šå¤©æ˜¯ä¸ªå¥½æ—¥å­ï¼&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ä»Šå¤©&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ä»Šå¤©æ˜¯&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¤©æ˜¯&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">      </span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="è‡ªå®šä¹‰ç¤ºä¾‹é€‰æ‹©å™¨">è‡ªå®šä¹‰ç¤ºä¾‹é€‰æ‹©å™¨</h1><p><code>ExampleSelector</code> å¿…é¡»å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>add_example</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªç¤ºä¾‹å¹¶å°†å…¶æ·»åŠ åˆ°<code>ExampleSelector</code> ä¸­</li><li><code>select_examples</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—è¾“å…¥å˜é‡ï¼ˆç”¨äºç”¨æˆ·è¾“å…¥ï¼‰å¹¶è¿”å›è¦åœ¨ few shotæç¤ºä¸­ä½¿ç”¨çš„ç¤ºä¾‹åˆ—è¡¨</li></ul><p>å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>ExampleSelector</code>ï¼Œæ•ˆæœæ˜¯åœ¨ç¤ºä¾‹ä¸­éšæœºé€‰æ‹©n ä¸ªï¼Œn ä½œä¸ºæ„é€ å‚æ•°ä¼ å…¥</p><p><strong>è‡ªå®šä¹‰é€‰æ‹©å™¨å®ç°</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts.example_selector.base <span class="keyword">import</span> BaseExampleSelector</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomExampleSelector</span>(<span class="title class_ inherited__">BaseExampleSelector</span>):</span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ„é€ å™¨é™¤äº† examplesï¼Œè¿˜éœ€è¦ä¼ å…¥ size ä½œä¸ºéšæœºé€‰æ‹©çš„æ•°é‡å‚æ•°</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, examples: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]], size: <span class="built_in">int</span></span>):</span><br><span class="line">        self.examples = examples</span><br><span class="line">        self.size = size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_example</span>(<span class="params">self, example: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ·»åŠ æ–°ç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        self.examples.append(example)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_examples</span>(<span class="params">self, input_variables: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®è¾“å…¥é€‰æ‹©è¦ä½¿ç”¨çš„ç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨äº† np çš„éšæœºå·¥å…·</span></span><br><span class="line">        <span class="keyword">return</span> np.random.choice(self.examples, size=self.size, replace=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">examples = [</span><br><span class="line">    &#123;<span class="string">&quot;é­&quot;</span>: <span class="string">&quot;æ›¹ä¸•&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;èœ€&quot;</span>: <span class="string">&quot;åˆ˜å¤‡&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;å´&quot;</span>: <span class="string">&quot;å­™æƒ&quot;</span>&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">example_selector = CustomExampleSelector(examples, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€‰æ‹©</span></span><br><span class="line"><span class="built_in">print</span>(example_selector.select_examples(&#123;<span class="string">&quot;unuseful&quot;</span>: <span class="string">&quot;unuseful&quot;</span>&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ æ–°ç¤ºä¾‹åé€‰æ‹©</span></span><br><span class="line">example_selector.add_example(&#123;<span class="string">&quot;æ™‹&quot;</span>: <span class="string">&quot;å¸é©¬ç¿&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(example_selector.select_examples(&#123;<span class="string">&quot;unuseful&quot;</span>: <span class="string">&quot;unuseful&quot;</span>&#125;))</span><br></pre></td></tr></table></figure><h1 id="é€‰æ‹©é•¿åº¦">é€‰æ‹©é•¿åº¦</h1><p>é€‰æ‹©å™¨å¯ä»¥æ ¹æ®é•¿åº¦å¯¹ç¤ºä¾‹è¿›è¡Œé€‰æ‹©æ¥é¿å…æ„å»ºçš„æç¤ºé•¿åº¦è¶…è¿‡ä¸Šä¸‹æ–‡çª—å£token çš„é™åˆ¶</p><p>å¯¹äºè¾ƒé•¿çš„è¾“å…¥ï¼Œå®ƒä¼šé€‰æ‹©è¾ƒå°‘çš„ç¤ºä¾‹ï¼Œè€Œå¯¹äºè¾ƒçŸ­çš„è¾“å…¥ï¼Œå®ƒä¼šé€‰æ‹©æ›´å¤šçš„ç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> FewShotPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain.prompts.example_selector <span class="keyword">import</span> LengthBasedExampleSelector</span><br><span class="line"></span><br><span class="line">examples = [</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;happy&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;sad&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;tall&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;short&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;energetic&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;lethargic&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;sunny&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;gloomy&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;windy&quot;</span>, <span class="string">&quot;output&quot;</span>: <span class="string">&quot;calm&quot;</span>&#125;,</span><br><span class="line"></span><br><span class="line">example_prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>, <span class="string">&quot;output&quot;</span>],</span><br><span class="line">    template=<span class="string">&quot;Input: &#123;input&#125;\nOutput: &#123;output&#125;&quot;</span>,</span><br><span class="line">)</span><br><span class="line">example_selector = LengthBasedExampleSelector(</span><br><span class="line">    examples=examples, </span><br><span class="line">    example_prompt=example_prompt, </span><br><span class="line">    <span class="comment"># è¿™æ˜¯æ ¼å¼åŒ–ç¤ºä¾‹çš„æœ€å¤§é•¿åº¦</span></span><br><span class="line">    <span class="comment"># é•¿åº¦ç”±ä¸‹é¢çš„ get_text_Length å‡½æ•°æµ‹é‡</span></span><br><span class="line">    max_length=<span class="number">25</span>,</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    è¿™æ˜¯ç”¨äºè·å–å­—ç¬¦ä¸²é•¿åº¦çš„å‡½æ•°ä»¥ç¡®å®šè¦åŒ…æ‹¬å“ªäº›ç¤ºä¾‹</span></span><br><span class="line"><span class="string">    å®ƒè¢«æ³¨é‡Šæ‰æ˜¯å› ä¸ºï¼Œå¦‚æœæœªæŒ‡å®šï¼Œåˆ™å°†å…¶ä½œä¸ºé»˜è®¤å€¼æä¾›</span></span><br><span class="line"><span class="string">    get_text_length: Callable [[str], int] = lambda x: len(re.split(&quot;\n| &quot;, x))</span></span><br><span class="line"><span class="string">    é»˜è®¤é€»è¾‘æ˜¯æŒ‰ç…§æ¢è¡Œç¬¦æˆ–ç©ºæ ¼è¿›è¡Œåˆ†å‰²æ¥åˆ¤æ–­é•¿åº¦</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">)</span><br><span class="line">dynamic_prompt = FewShotPromptTemplate(</span><br><span class="line">    example_selector=example_selector,</span><br><span class="line">    example_prompt=example_prompt,</span><br><span class="line">    prefix=<span class="string">&quot;Give the antonym of every input&quot;</span>,</span><br><span class="line">    suffix=<span class="string">&quot;Input: &#123;adjective&#125;\nOutput:&quot;</span>, </span><br><span class="line">    input_variables=[<span class="string">&quot;adjective&quot;</span>],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(dynamic_prompt.<span class="built_in">format</span>(adjective=<span class="string">&quot;big&quot;</span>))</span><br></pre></td></tr></table></figure><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Give the antonym of every <span class="keyword">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: happy</span><br><span class="line"><span class="keyword">Output</span>: sad</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: tall</span><br><span class="line"><span class="keyword">Output</span>: short</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: energetic</span><br><span class="line"><span class="keyword">Output</span>: lethargic</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: sunny</span><br><span class="line"><span class="keyword">Output</span>: gloomy</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: windy</span><br><span class="line"><span class="keyword">Output</span>: calm</span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>: big</span><br><span class="line"><span class="keyword">Output</span>:</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¾“å…¥çš„å†…å®¹å¾ˆçŸ­ï¼ˆbigï¼‰ï¼Œæ‰€ä»¥æ ¹æ®ç”Ÿäºé•¿åº¦ä¼šå–æ›´å¤šçš„ç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">long_string = <span class="string">&quot;big and huge and massive and large and gigantic and tall and much much much much much bigger than everything else&quot;</span></span><br><span class="line"><span class="built_in">print</span>(dynamic_prompt.<span class="built_in">format</span>(adjective=long_string))</span><br></pre></td></tr></table></figure><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Give the antonym of every input</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">Input:</span> happy</span><br><span class="line"><span class="symbol">Output:</span> sad</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">Input:</span> <span class="keyword">big </span><span class="keyword">and </span>huge <span class="keyword">and </span>massive <span class="keyword">and </span>large <span class="keyword">and </span>gigantic <span class="keyword">and </span>tall <span class="keyword">and </span>much much much much much <span class="keyword">bigger </span>than everything else</span><br><span class="line"><span class="symbol">Output:</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºè¾“å…¥çš„å†…å®¹å¾ˆé•¿ï¼ˆbig and huge and massive and large and giganticand tall and much much much much much bigger than everythingelseï¼‰ï¼Œæ‰€ä»¥é€‰æ‹©çš„ç¤ºä¾‹å°±æ¯”è¾ƒå°‘</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://python.langchain.com.cn/docs/modules/model_io/prompts/example_selectors/">ä¾‹å­é€‰æ‹©å™¨| ğŸ¦œï¸ğŸ”— Langchain</a></p><p><a href="https://zhuanlan.zhihu.com/p/634429713">OpenAIä½“éªŒ3 â€”â€”embeddingå’Œå‘é‡æ•°æ®åº“(pinecone) - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.2 - æç¤ºæ¨¡æ¿</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.2%20-%20%E6%8F%90%E7%A4%BA%E6%A8%A1%E6%9D%BF.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.2%20-%20%E6%8F%90%E7%A4%BA%E6%A8%A1%E6%9D%BF.html</url>
      
        <content type="html"><![CDATA[<h1 id="æ¨¡æ¿æ ¼å¼">æ¨¡æ¿æ ¼å¼</h1><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>PromptTemplate</code> ä¼šå°†æä¾›çš„æ¨¡æ¿è§†ä¸º Pythonf-string</p><p>æ‚¨å¯ä»¥é€šè¿‡ <code>template_format</code> å‚æ•°æŒ‡å®šå…¶ä»–æ¨¡æ¿æ ¼å¼ï¼Œå¦‚ä¸‹çš„<code>template_format="jinja2"</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¡®ä¿å®‰è£…äº† jinja2</span></span><br><span class="line"></span><br><span class="line">jinja2_template = <span class="string">&quot;å‘Šè¯‰æˆ‘ä¸€ä¸ªå…³äº&#123;&#123; content &#125;&#125;çš„ç¬‘è¯&quot;</span></span><br><span class="line">prompt_template = PromptTemplate.from_template(template=jinja2_template, template_format=<span class="string">&quot;jinja2&quot;</span>)</span><br><span class="line"></span><br><span class="line">prompt_template.<span class="built_in">format</span>(content=<span class="string">&quot;ç†ŠçŒ«&quot;</span>)</span><br><span class="line"><span class="comment"># -&gt; å‘Šè¯‰æˆ‘ä¸€ä¸ªå…³äºç†ŠçŒ«çš„ç¬‘è¯</span></span><br></pre></td></tr></table></figure><blockquote><p>Args:</p><p>â€‹ template: The template string.</p><p>â€‹ template_format: The template format. Should be one of "f-string" or"jinja2".</p></blockquote><p><br> f-string äº¦ç§°ä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²å¸¸é‡ï¼ˆformatted string literalsï¼‰ï¼Œæ˜¯Python3.6 æ–°å¼•å…¥çš„ä¸€ç§å­—ç¬¦ä¸²æ ¼å¼åŒ–æ–¹æ³• <ahref="https://cito.github.io/blog/f-strings/">The new f-strings inPython 3.6 | Seasoned &amp; Agile (cito.github.io)</a></p><h1 id="éªŒè¯æ¨¡æ¿">éªŒè¯æ¨¡æ¿</h1><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>PromptTemplate</code> ä¼šé€šè¿‡æ£€æŸ¥<code>input_variables</code> æ˜¯å¦ä¸ <code>template</code>ä¸­å®šä¹‰çš„å˜é‡åŒ¹é…æ¥éªŒè¯ <code>template</code> å­—ç¬¦ä¸²</p><p>å¯ä»¥å°† <code>validate_template</code> è®¾ç½®ä¸º <code>False</code>æ¥ç¦ç”¨æ­¤è¡Œä¸º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;æˆ‘å­¦ä¹ &#123;tool&#125;æ˜¯å› ä¸º&#123;reason&#125;&quot;</span></span><br><span class="line">prompt_template = PromptTemplate(template=template, input_variables=[<span class="string">&quot;reason&quot;</span>], validate_template=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; pydantic.v1.error_wrappers.ValidationError: 1 validation error for PromptTemplate\n__root__\nInvalid prompt schema; check for mismatched or missing input parameters. &#x27;tool&#x27; (type=value_error)</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥æ˜¯æ–‡æ¡£ç‰ˆæœ¬é—®é¢˜ï¼Ÿæˆ‘ä½¿ç”¨çš„ LangChain ç‰ˆæœ¬æ˜¯0.0.340ï¼ˆåº”è¯¥æ˜¯ç°åœ¨çš„æœ€æ–°ç‰ˆæœ¬ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Name: langchain</span><br><span class="line">Version: 0.0.340</span><br><span class="line">Summary: Building applications with LLMs through composability</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>validate_template</code> å‚æ•°çš„é»˜è®¤å€¼æ˜¯<code>FALSE</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validate_template: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Whether or not to try validating the template.&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p><br> å¦‚æœç›´æ¥ä½¿ç”¨ <code>from_template</code> åˆ™ä¼šè‡ªåŠ¨è¯†åˆ«å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;æˆ‘å­¦ä¹ &#123;tool&#125;æ˜¯å› ä¸º&#123;reason&#125;.&quot;</span></span><br><span class="line">prompt_template = PromptTemplate.from_template(template)</span><br><span class="line"><span class="built_in">print</span>(prompt_template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; input_variables=[&#x27;reason&#x27;, &#x27;tool&#x27;] template=&#x27;æˆ‘å­¦ä¹ &#123;tool&#125;æ˜¯å› ä¸º&#123;reason&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="æ ¼å¼æ¨¡æ¿è¾“å‡º">æ ¼å¼æ¨¡æ¿è¾“å‡º</h1><p>æ ¼å¼æ–¹æ³•çš„è¾“å‡ºå¯ä½œä¸ºå­—ç¬¦ä¸²ã€æ¶ˆæ¯åˆ—è¡¨å’Œ <code>ChatPromptValue</code>ä½¿ç”¨</p><p>ä»¥ä¸‹é¢ template ä¸ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># system message</span></span><br><span class="line">template = <span class="string">&quot;You are a helpful assistant that translates &#123;input_language&#125; to &#123;output_language&#125;.&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># human message</span></span><br><span class="line">human_template = <span class="string">&quot;&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br><span class="line"></span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])</span><br></pre></td></tr></table></figure><p><strong>å­—ç¬¦ä¸²</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># format</span></span><br><span class="line">result = chat_prompt.<span class="built_in">format</span>(input_language=<span class="string">&quot;English&quot;</span>, output_language=<span class="string">&quot;French&quot;</span>, text=<span class="string">&quot;I love programming.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€… format_prompt å to_string</span></span><br><span class="line">result = chat_prompt.format_prompt(input_language=<span class="string">&quot;English&quot;</span>, output_language=<span class="string">&quot;French&quot;</span>, text=<span class="string">&quot;I love programming.&quot;</span>).to_string()</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; System: You are a helpful assistant that translates English to French.\nHuman: I love programming.</span></span><br></pre></td></tr></table></figure><p><strong>æ¶ˆæ¯åˆ—è¡¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># format_messages</span></span><br><span class="line">result = chat_prompt.format_messages(input_language=<span class="string">&quot;English&quot;</span>, output_language=<span class="string">&quot;French&quot;</span>, text=<span class="string">&quot;I love programming.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># format_prompt å to_messages</span></span><br><span class="line">result = chat_prompt.format_prompt(input_language=<span class="string">&quot;English&quot;</span>, output_language=<span class="string">&quot;French&quot;</span>, text=<span class="string">&quot;I love programming.&quot;</span>).to_messages()</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt;  [SystemMessage(content=&#x27;You are a helpful assistant that translates English to French.&#x27;, additional_kwargs=&#123;&#125;),\nHumanMessage(content=&#x27;I love programming.&#x27;, additional_kwargs=&#123;&#125;)]</span></span><br></pre></td></tr></table></figure><p><strong>ChatPromptValue</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = chat_prompt.format_prompt(input_language=<span class="string">&quot;English&quot;</span>, output_language=<span class="string">&quot;French&quot;</span>, text=<span class="string">&quot;I love programming.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; ChatPromptValue(messages=[SystemMessage(content=&#x27;You are a helpful assistant that translates English to French.&#x27;, additional_kwargs=&#123;&#125;), HumanMessage(content=&#x27;I love programming.&#x27;, additional_kwargs=&#123;&#125;)])</span></span><br></pre></td></tr></table></figure><h1 id="éƒ¨åˆ†æ ¼å¼åŒ–">éƒ¨åˆ†æ ¼å¼åŒ–</h1><p>æ¨¡æ¿ä¸­çš„ <code>input_variables</code>ä¸ä¸€å®šéœ€è¦ä¸€æ¬¡å…¨éƒ¨æ ¼å¼åŒ–å®Œæˆï¼Œå¯ä»¥ä¼ å…¥æ‰€éœ€å€¼çš„å­é›†ï¼Œä»¥åˆ›å»ºä»…æœŸæœ›å‰©ä½™å­é›†å€¼çš„æ–°æç¤ºæ¨¡æ¿</p><p>LangChain æä¾›äº†ä¸¤ç§æ–¹å¼æ¥æ”¯æŒè¿™ç§æ“ä½œï¼š</p><ul><li>ä½¿ç”¨å­—ç¬¦ä¸²å€¼è¿›è¡Œéƒ¨åˆ†æ ¼å¼åŒ–</li><li>ä½¿ç”¨è¿”å›å­—ç¬¦ä¸²å€¼çš„å‡½æ•°è¿›è¡Œéƒ¨åˆ†æ ¼å¼åŒ–</li></ul><p><br></p><p><strong>ä½¿ç”¨å­—ç¬¦ä¸²å€¼</strong></p><p>å‡è®¾æœ‰ä¸€ä¸ªæ¨¡æ¿æ‹¥æœ‰ä¸¤ä¸ªè¾“å…¥å˜é‡ <code>a</code> å’Œ<code>b</code>ï¼Œå¦‚æœåœ¨é“¾ç»„ä»¶ä¸­æ—©æœŸè·å¾—äº† <code>a</code>çš„å€¼ï¼Œä½†ç¨åæ‰è·å¾— <code>b</code>çš„å€¼ï¼Œé‚£ä¹ˆç­‰åˆ°ä¸¤ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªä½ç½®æ—¶å°†å®ƒä»¬ä¼ é€’ç»™æç¤ºæ¨¡æ¿å¯èƒ½ä¼šå¾ˆéº»çƒ¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">prompt = PromptTemplate(template=<span class="string">&quot;&#123;a&#125;&#123;b&#125;&quot;</span>, input_variables=[<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>])</span><br><span class="line">partial_prompt = prompt.partial(a=<span class="string">&quot;[param-a]&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(partial_prompt)</span><br><span class="line"><span class="built_in">print</span>(partial_prompt.<span class="built_in">format</span>(b=<span class="string">&quot;[param-b]&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; input_variables=[&#x27;b&#x27;] partial_variables=&#123;&#x27;a&#x27;: &#x27;[param-a]&#x27;&#125; template=&#x27;&#123;a&#125;&#123;b&#125;&#x27;</span></span><br><span class="line"><span class="comment"># &gt;&gt; [param-a][param-b]</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>partial_variables</code> å˜é‡åˆå§‹åŒ–æç¤º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prompt = PromptTemplate(template=<span class="string">&quot;&#123;a&#125;&#123;b&#125;&quot;</span>,partial_variables=&#123;<span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;[param-a]&#x27;</span>&#125;,input_variables=[<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>])</span><br></pre></td></tr></table></figure><p><br></p><p><strong>ä½¿ç”¨å‡½æ•°</strong></p><p>å…¸å‹çš„ä¾‹å­æ˜¯æ—¥æœŸæˆ–æ—¶é—´ï¼Œä½¿ç”¨ä¸€ä¸ªå§‹ç»ˆè¿”å›å½“å‰æ—¥æœŸçš„å‡½æ•°æ¥éƒ¨åˆ†å¡«å……æç¤ºéå¸¸æ–¹ä¾¿</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_datetime</span>():</span><br><span class="line">    now = datetime.now()</span><br><span class="line">    <span class="keyword">return</span> now.strftime(<span class="string">&quot;ã€%Y/%m/%dã€‘&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">prompt = PromptTemplate(</span><br><span class="line">    template=<span class="string">&quot;å‘Šè¯‰æˆ‘ä¸€ä¸ª&#123;adjective&#125;å…³äº&#123;date&#125;æ—¥æœŸçš„ç¬‘è¯&quot;</span>, </span><br><span class="line">    input_variables=[<span class="string">&quot;adjective&quot;</span>, <span class="string">&quot;date&quot;</span>]</span><br><span class="line">)</span><br><span class="line">partial_prompt = prompt.partial(date=_get_datetime)</span><br><span class="line"><span class="built_in">print</span>(partial_prompt.<span class="built_in">format</span>(adjective=<span class="string">&quot;æœ‰è¶£çš„&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; å‘Šè¯‰æˆ‘ä¸€ä¸ªæœ‰è¶£çš„å…³äºã€2023/11/28ã€‘æ—¥æœŸçš„ç¬‘è¯</span></span><br></pre></td></tr></table></figure><h1 id="å°‘é‡ç¤ºä¾‹æç¤ºæ¨¡æ¿">å°‘é‡ç¤ºä¾‹æç¤ºæ¨¡æ¿</h1><p><strong>åˆ›å»ºä¸€ä¸ªç¤ºä¾‹é›†</strong></p><p>æ¯ä¸ªç¤ºä¾‹åº”è¯¥æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­é”®æ˜¯è¾“å…¥å˜é‡ï¼Œå€¼æ˜¯è¿™äº›è¾“å…¥å˜é‡çš„å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">examples = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;question&quot;</span>: <span class="string">&quot;Who lived longer, Muhammad Ali or Alan Turing?&quot;</span>,</span><br><span class="line">    <span class="string">&quot;answer&quot;</span>: </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Are follow up questions needed here: Yes.</span></span><br><span class="line"><span class="string">Follow up: How old was Muhammad Ali when he died?</span></span><br><span class="line"><span class="string">Intermediate answer: Muhammad Ali was 74 years old when he died.</span></span><br><span class="line"><span class="string">Follow up: How old was Alan Turing when he died?</span></span><br><span class="line"><span class="string">Intermediate answer: Alan Turing was 41 years old when he died.</span></span><br><span class="line"><span class="string">So the final answer is: Muhammad Ali</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;question&quot;</span>: <span class="string">&quot;When was the founder of craigslist born?&quot;</span>,</span><br><span class="line">    <span class="string">&quot;answer&quot;</span>: </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Are follow up questions needed here: Yes.</span></span><br><span class="line"><span class="string">Follow up: Who was the founder of craigslist?</span></span><br><span class="line"><span class="string">Intermediate answer: Craigslist was founded by Craig Newmark.</span></span><br><span class="line"><span class="string">Follow up: When was Craig Newmark born?</span></span><br><span class="line"><span class="string">Intermediate answer: Craig Newmark was born on December 6, 1952.</span></span><br><span class="line"><span class="string">So the final answer is: December 6, 1952</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;question&quot;</span>: <span class="string">&quot;Who was the maternal grandfather of George Washington?&quot;</span>,</span><br><span class="line">    <span class="string">&quot;answer&quot;</span>:</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Are follow up questions needed here: Yes.</span></span><br><span class="line"><span class="string">Follow up: Who was the mother of George Washington?</span></span><br><span class="line"><span class="string">Intermediate answer: The mother of George Washington was Mary Ball Washington.</span></span><br><span class="line"><span class="string">Follow up: Who was the father of Mary Ball Washington?</span></span><br><span class="line"><span class="string">Intermediate answer: The father of Mary Ball Washington was Joseph Ball.</span></span><br><span class="line"><span class="string">So the final answer is: Joseph Ball</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;question&quot;</span>: <span class="string">&quot;Are both the directors of Jaws and Casino Royale from the same country?&quot;</span>,</span><br><span class="line">    <span class="string">&quot;answer&quot;</span>:</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Are follow up questions needed here: Yes.</span></span><br><span class="line"><span class="string">Follow up: Who is the director of Jaws?</span></span><br><span class="line"><span class="string">Intermediate Answer: The director of Jaws is Steven Spielberg.</span></span><br><span class="line"><span class="string">Follow up: Where is Steven Spielberg from?</span></span><br><span class="line"><span class="string">Intermediate Answer: The United States.</span></span><br><span class="line"><span class="string">Follow up: Who is the director of Casino Royale?</span></span><br><span class="line"><span class="string">Intermediate Answer: The director of Casino Royale is Martin Campbell.</span></span><br><span class="line"><span class="string">Follow up: Where is Martin Campbell from?</span></span><br><span class="line"><span class="string">Intermediate Answer: New Zealand.</span></span><br><span class="line"><span class="string">So the final answer is: No</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºå°‘é‡ç¤ºä¾‹çš„æ ¼å¼åŒ–ç¨‹åº</strong></p><p>é…ç½®ä¸€ä¸ªå°†å°‘é‡ç¤ºä¾‹æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²çš„æ ¼å¼åŒ–ç¨‹åºï¼Œè¯¥ç¨‹åºæ˜¯ä¸€ä¸ª<code>PromptTemplate</code> å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">example_prompt = PromptTemplate(input_variables=[<span class="string">&quot;question&quot;</span>, <span class="string">&quot;answer&quot;</span>], template=<span class="string">&quot;Question: &#123;question&#125;\nAnswer: &#123;answer&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(example_prompt.<span class="built_in">format</span>(**examples[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Question: Who lived longer, Muhammad Ali <span class="keyword">or</span> Alan Turing?</span><br><span class="line">Answer:</span><br><span class="line">            <span class="keyword">Are</span> follow up questions needed here: Yes.</span><br><span class="line">            Follow up: How <span class="keyword">old</span> was Muhammad Ali <span class="keyword">when</span> he died?</span><br><span class="line">            Intermediate answer: Muhammad Ali was <span class="number">74</span> years <span class="keyword">old</span> <span class="keyword">when</span> he died.</span><br><span class="line">            Follow up: How <span class="keyword">old</span> was Alan Turing <span class="keyword">when</span> he died?</span><br><span class="line">            Intermediate answer: Alan Turing was <span class="number">41</span> years <span class="keyword">old</span> <span class="keyword">when</span> he died.</span><br><span class="line">            So the <span class="keyword">final</span> answer <span class="keyword">is</span>: Muhammad Ali</span><br></pre></td></tr></table></figure><p><strong>å°†ç¤ºä¾‹å’Œæ ¼å¼åŒ–ç¨‹åºæä¾›ç»™<code>FewShotPromptTemplate</code></strong></p><p>åˆ›å»ºä¸€ä¸ª <code>FewShotPromptTemplate</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ¥å—å°‘é‡ç¤ºä¾‹å’Œå°‘é‡ç¤ºä¾‹çš„æ ¼å¼åŒ–ç¨‹åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">prompt = FewShotPromptTemplate(</span><br><span class="line">    examples=examples, </span><br><span class="line">    example_prompt=example_prompt, </span><br><span class="line">    suffix=<span class="string">&quot;Question: &#123;input&#125;&quot;</span>, </span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(prompt.<span class="built_in">format</span>(<span class="built_in">input</span>=<span class="string">&quot;Who was the father of Mary Ball Washington?&quot;</span>))</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Question:</span> <span class="string">Who</span> <span class="string">lived</span> <span class="string">longer,</span> <span class="string">Muhammad</span> <span class="string">Ali</span> <span class="string">or</span> <span class="string">Alan</span> <span class="string">Turing?</span></span><br><span class="line"><span class="attr">Answer:</span></span><br><span class="line">            <span class="attr">Are follow up questions needed here:</span> <span class="string">Yes.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">How</span> <span class="string">old</span> <span class="string">was</span> <span class="string">Muhammad</span> <span class="string">Ali</span> <span class="string">when</span> <span class="string">he</span> <span class="string">died?</span></span><br><span class="line">            <span class="attr">Intermediate answer:</span> <span class="string">Muhammad</span> <span class="string">Ali</span> <span class="string">was</span> <span class="number">74</span> <span class="string">years</span> <span class="string">old</span> <span class="string">when</span> <span class="string">he</span> <span class="string">died.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">How</span> <span class="string">old</span> <span class="string">was</span> <span class="string">Alan</span> <span class="string">Turing</span> <span class="string">when</span> <span class="string">he</span> <span class="string">died?</span></span><br><span class="line">            <span class="attr">Intermediate answer:</span> <span class="string">Alan</span> <span class="string">Turing</span> <span class="string">was</span> <span class="number">41</span> <span class="string">years</span> <span class="string">old</span> <span class="string">when</span> <span class="string">he</span> <span class="string">died.</span></span><br><span class="line">            <span class="attr">So the final answer is:</span> <span class="string">Muhammad</span> <span class="string">Ali</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="attr">Question:</span> <span class="string">When</span> <span class="string">was</span> <span class="string">the</span> <span class="string">founder</span> <span class="string">of</span> <span class="string">craigslist</span> <span class="string">born?</span></span><br><span class="line"><span class="attr">Answer:</span></span><br><span class="line">            <span class="attr">Are follow up questions needed here:</span> <span class="string">Yes.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">Who</span> <span class="string">was</span> <span class="string">the</span> <span class="string">founder</span> <span class="string">of</span> <span class="string">craigslist?</span></span><br><span class="line">            <span class="attr">Intermediate answer:</span> <span class="string">Craigslist</span> <span class="string">was</span> <span class="string">founded</span> <span class="string">by</span> <span class="string">Craig</span> <span class="string">Newmark.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">When</span> <span class="string">was</span> <span class="string">Craig</span> <span class="string">Newmark</span> <span class="string">born?</span></span><br><span class="line">            <span class="attr">Intermediate answer:</span> <span class="string">Craig</span> <span class="string">Newmark</span> <span class="string">was</span> <span class="string">born</span> <span class="string">on</span> <span class="string">December</span> <span class="number">6</span><span class="string">,</span> <span class="number">1952</span><span class="string">.</span></span><br><span class="line">            <span class="attr">So the final answer is:</span> <span class="string">December</span> <span class="number">6</span><span class="string">,</span> <span class="number">1952</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="attr">Question:</span> <span class="string">Who</span> <span class="string">was</span> <span class="string">the</span> <span class="string">maternal</span> <span class="string">grandfather</span> <span class="string">of</span> <span class="string">George</span> <span class="string">Washington?</span></span><br><span class="line"><span class="attr">Answer:</span></span><br><span class="line">            <span class="attr">Are follow up questions needed here:</span> <span class="string">Yes.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">Who</span> <span class="string">was</span> <span class="string">the</span> <span class="string">mother</span> <span class="string">of</span> <span class="string">George</span> <span class="string">Washington?</span></span><br><span class="line">            <span class="attr">Intermediate answer:</span> <span class="string">The</span> <span class="string">mother</span> <span class="string">of</span> <span class="string">George</span> <span class="string">Washington</span> <span class="string">was</span> <span class="string">Mary</span> <span class="string">Ball</span> <span class="string">Washington.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">Who</span> <span class="string">was</span> <span class="string">the</span> <span class="string">father</span> <span class="string">of</span> <span class="string">Mary</span> <span class="string">Ball</span> <span class="string">Washington?</span></span><br><span class="line">            <span class="attr">Intermediate answer:</span> <span class="string">The</span> <span class="string">father</span> <span class="string">of</span> <span class="string">Mary</span> <span class="string">Ball</span> <span class="string">Washington</span> <span class="string">was</span> <span class="string">Joseph</span> <span class="string">Ball.</span></span><br><span class="line">            <span class="attr">So the final answer is:</span> <span class="string">Joseph</span> <span class="string">Ball</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="attr">Question:</span> <span class="string">Are</span> <span class="string">both</span> <span class="string">the</span> <span class="string">directors</span> <span class="string">of</span> <span class="string">Jaws</span> <span class="string">and</span> <span class="string">Casino</span> <span class="string">Royale</span> <span class="string">from</span> <span class="string">the</span> <span class="string">same</span> <span class="string">country?</span></span><br><span class="line"><span class="attr">Answer:</span></span><br><span class="line">            <span class="attr">Are follow up questions needed here:</span> <span class="string">Yes.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">Who</span> <span class="string">is</span> <span class="string">the</span> <span class="string">director</span> <span class="string">of</span> <span class="string">Jaws?</span></span><br><span class="line">            <span class="attr">Intermediate Answer:</span> <span class="string">The</span> <span class="string">director</span> <span class="string">of</span> <span class="string">Jaws</span> <span class="string">is</span> <span class="string">Steven</span> <span class="string">Spielberg.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">Where</span> <span class="string">is</span> <span class="string">Steven</span> <span class="string">Spielberg</span> <span class="string">from?</span></span><br><span class="line">            <span class="attr">Intermediate Answer:</span> <span class="string">The</span> <span class="string">United</span> <span class="string">States.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">Who</span> <span class="string">is</span> <span class="string">the</span> <span class="string">director</span> <span class="string">of</span> <span class="string">Casino</span> <span class="string">Royale?</span></span><br><span class="line">            <span class="attr">Intermediate Answer:</span> <span class="string">The</span> <span class="string">director</span> <span class="string">of</span> <span class="string">Casino</span> <span class="string">Royale</span> <span class="string">is</span> <span class="string">Martin</span> <span class="string">Campbell.</span></span><br><span class="line">            <span class="attr">Follow up:</span> <span class="string">Where</span> <span class="string">is</span> <span class="string">Martin</span> <span class="string">Campbell</span> <span class="string">from?</span></span><br><span class="line">            <span class="attr">Intermediate Answer:</span> <span class="string">New</span> <span class="string">Zealand.</span></span><br><span class="line">            <span class="attr">So the final answer is:</span> <span class="literal">No</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="attr">Question:</span> <span class="string">Who</span> <span class="string">was</span> <span class="string">the</span> <span class="string">father</span> <span class="string">of</span> <span class="string">Mary</span> <span class="string">Ball</span> <span class="string">Washington?</span></span><br></pre></td></tr></table></figure><h1 id="å°‘é‡ç¤ºä¾‹-chat-æç¤ºæ¨¡æ¿">å°‘é‡ç¤ºä¾‹ chat æç¤ºæ¨¡æ¿</h1><p>å…³äºå¦‚ä½•æœ€å¥½åœ°ä½¿ç”¨å°‘æ ·æœ¬æç¤ºï¼Œè¿˜æ²¡æœ‰ç¡®å®šçš„å…±è¯†ï¼Œè¿˜æ²¡æœ‰å¯¹æ­¤è¿›è¡Œä»»ä½•æŠ½è±¡çš„ç¡®å®šï¼ˆæˆ‘ç†è§£æ˜¯å¦‚ä½•åœ¨å¯¹è¯ç±»å‹ä¸‹è¡¨ç°æç¤ºè¿˜æ²¡æœ‰ç¡®å®šçš„æ¨¡å¼ï¼‰</p><p>æ–‡æ¡£æä¾›äº†ä¸¤ç§å½¢å¼ï¼š</p><ul><li>AI å’Œäººç±»æ¶ˆæ¯äº¤æ›¿</li><li>ç³»ç»Ÿæ¶ˆæ¯</li></ul><p><strong>AI å’Œäººç±»æ¶ˆæ¯äº¤æ›¿</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç³»ç»Ÿæ¶ˆæ¯</span></span><br><span class="line">template = <span class="string">&quot;ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ï¼Œèƒ½æŠŠæ±‰è¯­ç¿»è¯‘æˆçŒ«è¯­&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹å¯¹è¯</span></span><br><span class="line">example_human = HumanMessagePromptTemplate.from_template(<span class="string">&quot;ä½ å¥½&quot;</span>)</span><br><span class="line">example_ai = AIMessagePromptTemplate.from_template(<span class="string">&quot;å–µå–µ~&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># äººç±»è¾“å…¥å¯¹è¯</span></span><br><span class="line">human_template = <span class="string">&quot;&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»„åˆ ChatPromptTemplate</span></span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [system_message_prompt, example_human, example_ai, human_message_prompt]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># format</span></span><br><span class="line">chat_prompt.<span class="built_in">format</span>(text = <span class="string">&quot;æ™šä¸Šå¥½&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(chat_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; input_variables=[&#x27;text&#x27;] messages=[SystemMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], template=&#x27;ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ï¼Œèƒ½æŠŠæ±‰è¯­ç¿»è¯‘æˆçŒ«è¯­&#x27;)), HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], template=&#x27;ä½ å¥½&#x27;)), AIMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], template=&#x27;å–µå–µ~&#x27;)), HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=[&#x27;text&#x27;], template=&#x27;&#123;text&#125;&#x27;))]</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>ç³»ç»Ÿæ¶ˆæ¯</strong></p><p>OpenAI æä¾›äº†ä¸€ä¸ªå¯é€‰çš„ <code>name</code>å‚æ•°ï¼Œä»–ä»¬å»ºè®®ä¸ç³»ç»Ÿæ¶ˆæ¯ä¸€èµ·ä½¿ç”¨æ¥è¿›è¡Œå°‘æ ·æœ¬æç¤º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ï¼Œèƒ½æŠŠæ±‰è¯­ç¿»è¯‘æˆçŒ«è¯­&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒºåˆ«åœ¨è¿™é‡Œ</span></span><br><span class="line"><span class="comment"># ç›¸å½“äºä½¿ç”¨ç³»ç»Ÿæ¶ˆæ¯çš„ name åŒºåˆ†å‡ºç¤ºä¾‹å†…å®¹</span></span><br><span class="line">example_human = SystemMessagePromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;ä½ å¥½&quot;</span>, additional_kwargs=&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ç¤ºä¾‹-ç”¨æˆ·&quot;</span>&#125;</span><br><span class="line">)</span><br><span class="line">example_ai = SystemMessagePromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;å–µå–µ~&quot;</span>, additional_kwargs=&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ç¤ºä¾‹-AI&quot;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">human_template = <span class="string">&quot;&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [system_message_prompt, example_human, example_ai, human_message_prompt]</span><br><span class="line">)</span><br><span class="line">chat_prompt.<span class="built_in">format</span>(text = <span class="string">&quot;æ™šä¸Šå¥½&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(chat_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; input_variables=[&#x27;text&#x27;] messages=[SystemMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], template=&#x27;ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ï¼Œèƒ½æŠŠæ±‰è¯­ç¿»è¯‘æˆçŒ«è¯­&#x27;)), SystemMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], template=&#x27;ä½ å¥½&#x27;), additional_kwargs=&#123;&#x27;name&#x27;: &#x27;ç¤ºä¾‹-ç”¨æˆ·&#x27;&#125;), SystemMessagePromptTemplate(prompt=PromptTemplate(input_variables=[], template=&#x27;å–µå–µ~&#x27;), additional_kwargs=&#123;&#x27;name&#x27;: &#x27;ç¤ºä¾‹-AI&#x27;&#125;), HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=[&#x27;text&#x27;], template=&#x27;&#123;text&#125;&#x27;))]</span></span><br></pre></td></tr></table></figure><h1 id="æ¶ˆæ¯æç¤ºæ¨¡æ¿ç±»å‹">æ¶ˆæ¯æç¤ºæ¨¡æ¿ç±»å‹</h1><p>LangChain æä¾›äº†ä¸åŒç±»å‹çš„ <code>MessagePromptTemplate</code></p><p>æœ€å¸¸ç”¨çš„ï¼š</p><ul><li>AIMessagePromptTemplateï¼šAI æ¶ˆæ¯</li><li>SystemMessagePromptTemplateï¼šç³»ç»Ÿæ¶ˆæ¯</li><li>HumanMessagePromptTemplateï¼šäººå·¥æ¶ˆæ¯</li><li>ChatMessagePromptTemplateï¼šæŒ‡å®šè§’è‰²åæ¶ˆæ¯</li></ul><p><strong>ChatMessagePromptTemplate</strong></p><p>å¯¹è¯æ¨¡å‹æ”¯æŒä½¿ç”¨ä»»æ„è§’è‰²çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨<code>ChatMessagePromptTemplate</code>ï¼Œè¯¥æ¨¡æ¿å…è®¸ç”¨æˆ·æŒ‡å®šè§’è‰²å</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatMessagePromptTemplate</span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&quot;æ„Ÿå—è¿™è¢«å›šç¦äº†ä¸€ä¸‡å¹´çš„&#123;subject&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">chat_message_prompt = ChatMessagePromptTemplate.from_template(role=<span class="string">&quot;ä¼Šåˆ©ä¸¹&quot;</span>, template=prompt)</span><br><span class="line"><span class="built_in">print</span>(chat_message_prompt.<span class="built_in">format</span>(subject=<span class="string">&quot;æ€’ç«&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; content=&#x27;æ„Ÿå—è¿™è¢«å›šç¦äº†ä¸€ä¸‡å¹´çš„æ€’ç«&#x27; role=&#x27;ä¼Šåˆ©ä¸¹&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>MessagesPlaceholder</strong></p><p><code>MessagesPlaceholder</code>å¯ä»¥å®Œå…¨æ§åˆ¶æ ¼å¼åŒ–è¿‡ç¨‹ä¸­è¦å‘ˆç°çš„æ¶ˆæ¯</p><p>é€‚ç”¨äºåœ¨æ ¼å¼åŒ–è¿‡ç¨‹ä¸­æ’å…¥æ¶ˆæ¯åˆ—è¡¨æ—¶ï¼ˆç†è§£ä¸ºä¸€ç»„æ¶ˆæ¯çš„å ä½ç¬¦ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">human_prompt = <span class="string">&quot;ç”¨&#123;count&#125;ä¸ªè¯è¯­æ¦‚æ‹¬æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢çš„å¯¹è¯è´¨é‡&quot;</span></span><br><span class="line">human_message_template = HumanMessagePromptTemplate.from_template(human_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å ä½æ¶ˆæ¯ï¼Œname = conversation</span></span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages([MessagesPlaceholder(variable_name=<span class="string">&quot;conversation&quot;</span>), human_message_template])</span><br><span class="line"><span class="built_in">print</span>(chat_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; input_variables=[&#x27;conversation&#x27;, &#x27;count&#x27;] input_types=&#123;&#x27;conversation&#x27;: typing.List[typing.Union[langchain.schema.messages.AIMessage, langchain.schema.messages.HumanMessage, langchain.schema.messages.ChatMessage, langchain.schema.messages.SystemMessage, langchain.schema.messages.FunctionMessage, langchain.schema.messages.ToolMessage]]&#125; messages=[MessagesPlaceholder(variable_name=&#x27;conversation&#x27;), HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=[&#x27;count&#x27;], template=&#x27;ç”¨&#123;count&#125;ä¸ªè¯è¯­æ¦‚æ‹¬æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢çš„å¯¹è¯è´¨é‡&#x27;))]</span></span><br></pre></td></tr></table></figure><p>é’ˆå¯¹ <code>conversation</code> å ä½æ¶ˆæ¯å¡«å……çœŸæ­£çš„æ¶ˆæ¯å†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">human_message = HumanMessage(content=<span class="string">&quot;å­¦ä¹ ç¼–ç¨‹æœ€å¥½çš„æ–¹å¼æ˜¯ä»€ä¹ˆ&quot;</span>)</span><br><span class="line">ai_message = AIMessage(content=</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. é€‰æ‹©ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼šå†³å®šä½ æƒ³å­¦ä¹ çš„ç¼–ç¨‹è¯­è¨€</span></span><br><span class="line"><span class="string">2. ä»åŸºç¡€çŸ¥è¯†å¼€å§‹ï¼šç†Ÿæ‚‰å˜é‡ã€æ•°æ®ç±»å‹å’Œæ§åˆ¶ç»“æ„ç­‰åŸºæœ¬ç¼–ç¨‹æ¦‚å¿µ</span></span><br><span class="line"><span class="string">3. å®è·µï¼Œå®è·µï¼Œå®è·µï¼šå­¦ä¹ ç¼–ç¨‹çš„æœ€ä½³æ–¹å¼æ˜¯äº²èº«ä½“éªŒ</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">result = chat_prompt.format_prompt(conversation=[human_message, ai_message], count=<span class="string">&quot;3&quot;</span>).to_messages()</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; [HumanMessage(content=&#x27;å­¦ä¹ ç¼–ç¨‹æœ€å¥½çš„æ–¹å¼æ˜¯ä»€ä¹ˆ&#x27;), AIMessage(content=&#x27;\n1. é€‰æ‹©ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼šå†³å®šä½ æƒ³å­¦ä¹ çš„ç¼–ç¨‹è¯­è¨€\n2. ä»åŸºç¡€çŸ¥è¯†å¼€å§‹ï¼šç†Ÿæ‚‰å˜é‡ã€æ•°æ®ç±»å‹å’Œæ§åˆ¶ç»“æ„ç­‰åŸºæœ¬ç¼–ç¨‹æ¦‚å¿µ\n3. å®è·µï¼Œå®è·µï¼Œå®è·µï¼šå­¦ä¹ ç¼–ç¨‹çš„æœ€ä½³æ–¹å¼æ˜¯äº²èº«ä½“éªŒ\n&#x27;), HumanMessage(content=&#x27;ç”¨3ä¸ªè¯è¯­æ¦‚æ‹¬æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢çš„å¯¹è¯è´¨é‡&#x27;)]</span></span><br></pre></td></tr></table></figure><h1 id="åºåˆ—åŒ–">åºåˆ—åŒ–</h1><p>æç¤ºçš„åºåˆ—åŒ–å¯ä»¥æ–¹ä¾¿åœ°å…±äº«ã€å­˜å‚¨å’Œç‰ˆæœ¬åŒ–æç¤º</p><p>åœ¨é«˜å±‚æ¬¡ä¸Šï¼Œåºåˆ—åŒ–éµå¾ªä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š</p><ul><li>æ”¯æŒ JSON å’Œ YAMLï¼›å¸Œæœ›æ”¯æŒäººç±»åœ¨ç£ç›˜ä¸Šå¯è¯»çš„åºåˆ—åŒ–æ–¹æ³•</li><li>æ”¯æŒå°†æ‰€æœ‰å†…å®¹éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ–è€…å°†ä¸åŒçš„ç»„ä»¶ï¼ˆæ¨¡æ¿ã€ç¤ºä¾‹ç­‰ï¼‰å­˜å‚¨åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­å¹¶è¿›è¡Œå¼•ç”¨ï¼›è¿™ä¹Ÿåœºæ™¯å¯ä»¥è¿›è¡Œæ‹†åˆ†ï¼Œå¦‚é•¿æ¨¡æ¿ã€å¤§å‹ç¤ºä¾‹ã€å¯å¤ç”¨ç»„ä»¶ç­‰</li></ul><p>é€šè¿‡ä»¥ä¸‹å”¯ä¸€çš„ä¸€ä¸ªå…¥å£è¿›è¡ŒåŠ è½½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰€æœ‰çš„æç¤ºéƒ½é€šè¿‡ `load_prompt` å‡½æ•°åŠ è½½</span></span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> load_prompt</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">_type:</span> <span class="string">prompt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">input_variables:</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">&quot;adjective&quot;</span>, <span class="string">&quot;content&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">template:</span> </span><br><span class="line"></span><br><span class="line">    <span class="string">Tell</span> <span class="string">me</span> <span class="string">a</span> &#123;<span class="string">adjective</span>&#125; <span class="string">joke</span> <span class="string">about</span> &#123;<span class="string">content</span>&#125;<span class="string">.</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prompt = load_prompt(<span class="string">&quot;simple_prompt.yaml&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(prompt.<span class="built_in">format</span>(adjective=<span class="string">&quot;funny&quot;</span>, content=<span class="string">&quot;chickens&quot;</span>))</span><br></pre></td></tr></table></figure><p>æ›´å¤šçš„ä½¿ç”¨ç¤ºä¾‹å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ <ahref="https://python.langchain.com.cn/docs/modules/model_io/prompts/prompt_templates/prompt_serialization#prompttempalte-with-outputparser">åºåˆ—åŒ–ï¼ˆSerializationï¼‰ | ğŸ¦œï¸ğŸ”— Langchain</a></p><h1 id="ç®¡é“æç¤ºè¿›è¡Œç»„åˆ">ç®¡é“æç¤ºè¿›è¡Œç»„åˆ</h1><p>æƒ³è¦é‡ç”¨æç¤ºçš„éƒ¨åˆ†æ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>PipelinePrompt</code> æ¥å®ç°</p><p><code>PipelinePrompt</code> ç”±ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>æœ€ç»ˆæç¤ºï¼šè¿”å›çš„æœ€ç»ˆæç¤º</li><li>ç®¡é“æç¤ºï¼šç”±ä¸€ä¸ªå­—ç¬¦ä¸²åç§°å’Œä¸€ä¸ªæç¤ºæ¨¡æ¿ç»„æˆçš„å…ƒç»„åˆ—è¡¨ï¼›æ¯ä¸ªæç¤ºæ¨¡æ¿å°†è¢«æ ¼å¼åŒ–ï¼Œç„¶åä½œä¸ºç›¸åŒåç§°çš„å˜é‡ä¼ é€’ç»™æœªæ¥çš„æç¤ºæ¨¡æ¿</li></ul><p><strong>å®šä¹‰æœ€ç»ˆæç¤º</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">full_template = <span class="string">&quot;&quot;&quot;&#123;introduction&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;example&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;start&#125;&quot;&quot;&quot;</span></span><br><span class="line">full_prompt = PromptTemplate.from_template(full_template)</span><br></pre></td></tr></table></figure><p><strong>introduction æç¤º</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">introduction_template = <span class="string">&quot;&quot;&quot;ä½ åœ¨æ¨¡ä»¿&#123;person&#125;&quot;&quot;&quot;</span></span><br><span class="line">introduction_prompt = PromptTemplate.from_template(introduction_template)</span><br></pre></td></tr></table></figure><p><strong>example æç¤º</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">example_template = <span class="string">&quot;&quot;&quot;ä¸‹é¢æ˜¯ä¸€ä¸ªäº¤äº’çš„ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="string">Q: &#123;example_q&#125;</span></span><br><span class="line"><span class="string">A: &#123;example_a&#125;&quot;&quot;&quot;</span></span><br><span class="line">example_prompt = PromptTemplate.from_template(example_template)</span><br></pre></td></tr></table></figure><p><strong>start æç¤º</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">start_template = <span class="string">&quot;&quot;&quot;ç°åœ¨å¼€å§‹è¿™ä¹ˆåšï¼</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Q: &#123;question&#125;</span></span><br><span class="line"><span class="string">A:&quot;&quot;&quot;</span></span><br><span class="line">start_prompt = PromptTemplate.from_template(start_template)</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡ PipelinePrompt ç»„è£…</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">input_prompts = [</span><br><span class="line">    (<span class="string">&quot;introduction&quot;</span>, introduction_prompt),</span><br><span class="line">    (<span class="string">&quot;example&quot;</span>, example_prompt),</span><br><span class="line">    (<span class="string">&quot;start&quot;</span>, start_prompt)</span><br><span class="line">]</span><br><span class="line">pipeline_prompt = PipelinePromptTemplate(final_prompt=full_prompt, pipeline_prompts=input_prompts)</span><br></pre></td></tr></table></figure><p><strong>format PipelinePrompt</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(pipeline_prompt.<span class="built_in">format</span>(</span><br><span class="line">    person=<span class="string">&quot;é›·å†›&quot;</span>,</span><br><span class="line">    example_q=<span class="string">&quot;ä½ æœ€å–œæ¬¢çš„æ‰‹æœºå“ç‰Œæ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span>,</span><br><span class="line">    example_a=<span class="string">&quot;å°ç±³&quot;</span>,</span><br><span class="line">    question=<span class="string">&quot;ä½ æœ€å–œæ¬¢çš„æ€æ¯’è½¯ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span></span><br><span class="line">))</span><br></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">You are impersonating Elon Musk.</span><br><span class="line">Her<span class="string">e&#x27;s an example of an interaction: </span></span><br><span class="line"><span class="string">Q: What&#x27;</span>s your favorite car?</span><br><span class="line">A: Telsa</span><br><span class="line">Now, <span class="keyword">do</span> this <span class="keyword">for</span> <span class="type">real</span>!</span><br><span class="line"></span><br><span class="line">Q: What<span class="string">&#x27;s your favorite social media site?</span></span><br><span class="line"><span class="string">A:</span></span><br></pre></td></tr></table></figure><h1 id="è‡ªå®šä¹‰æç¤ºæ¨¡æ¿">è‡ªå®šä¹‰æç¤ºæ¨¡æ¿</h1><p>è‡ªå®šä¹‰æ¨¡æ¿ä¹Ÿåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p><ul><li>å­—ç¬¦ä¸²æç¤ºæ¨¡æ¿</li><li>èŠå¤©æç¤ºæ¨¡æ¿</li></ul><p>åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å­—ç¬¦ä¸²æç¤ºæ¨¡æ¿åˆ›å»ºè‡ªå®šä¹‰æç¤º</p><p>è¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„å­—ç¬¦ä¸²æç¤ºæ¨¡æ¿ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªè¦æ±‚ï¼š</p><ul><li>å®ƒå…·æœ‰ <code>input_variables</code>å±æ€§ï¼Œå…¬å¼€äº†æç¤ºæ¨¡æ¿é¢„æœŸçš„è¾“å…¥å˜é‡</li><li>å®ƒå…¬å¼€äº†ä¸€ä¸ª <code>format</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸é¢„æœŸçš„<code>input_variables</code>ç›¸å¯¹åº”çš„å…³é”®å­—å‚æ•°ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–åçš„æç¤º</li></ul><p><strong>ä¸‹é¢å®ç°äº†æ„é€ åˆ†æå‡½æ•°æºç çš„æç¤ºçš„æ¨¡æ¿</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> StringPromptTemplate</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> v1 <span class="keyword">as</span> pydantic_v1</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FunctionExplainerPromptTemplate</span>(StringPromptTemplate, BaseModel):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A custom prompt template that takes in the function name as input, and formats the prompt template to provide the source code of the function.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># input_variables</span></span><br><span class="line"><span class="meta">    @pydantic_v1.validator(<span class="params"><span class="string">&quot;input_variables&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_input_variables</span>(<span class="params">cls, v</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Validate that the input variables are correct.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(v) != <span class="number">1</span> <span class="keyword">or</span> <span class="string">&quot;function_name&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> v:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;function_name must be the only input_variable.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line">    <span class="comment"># format</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format</span>(<span class="params">self, **kwargs</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="comment"># Get the source code of the function</span></span><br><span class="line">        source_code = get_source_code(kwargs[<span class="string">&quot;function_name&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Generate the prompt to be sent to the language model</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç»™å®šå‡½æ•°åç§°å’Œæºç ï¼Œç”Ÿæˆå‡½æ•°çš„è‹±æ–‡è§£é‡Š</span></span><br><span class="line"><span class="string">        å‡½æ•°åç§°: <span class="subst">&#123;kwargs[<span class="string">&quot;function_name&quot;</span>].__name__&#125;</span></span></span><br><span class="line"><span class="string">        æºç :</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;source_code&#125;</span></span></span><br><span class="line"><span class="string">        è§£é‡Š:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> prompt</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_prompt_type</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;function-explainer&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æºç å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_source_code</span>(<span class="params">function_name</span>):</span><br><span class="line">    <span class="comment"># Get the source code of the function</span></span><br><span class="line">    <span class="keyword">return</span> inspect.getsource(function_name)</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fn_explainer = FunctionExplainerPromptTemplate(input_variables=[<span class="string">&quot;function_name&quot;</span>])</span><br><span class="line"><span class="comment"># Generate a prompt for the function &quot;get_source_code&quot;</span></span><br><span class="line">prompt = fn_explainer.<span class="built_in">format</span>(function_name=get_source_code)</span><br><span class="line"><span class="built_in">print</span>(prompt)</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„è¿™é‡Œå®˜æ–¹æ–‡æ¡£ç»™çš„ç¤ºä¾‹å¯èƒ½å­˜åœ¨é—®é¢˜ï¼ŒæŠ¥é”™ä¿¡æ¯</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> FunctionExplainerPromptTemplate(StringPromptTemplate, BaseModel):</span><br><span class="line">TypeError: metaclass <span class="keyword">conflict</span>: the metaclass <span class="keyword">of</span> a derived <span class="keyword">class</span> must be a (non-<span class="keyword">strict</span>) subclass <span class="keyword">of</span> the metaclasses <span class="keyword">of</span> <span class="keyword">all</span> its bases</span><br></pre></td></tr></table></figure><p>å’Œ pydantic åº“çš„ç‰ˆæœ¬æœ‰å…³ï¼Œv2ç‰ˆæœ¬ä¸‹å®˜æ–¹ä»£ç ä¼šå­˜åœ¨ä¸å…¼å®¹é—®é¢˜ï¼Œä¸Šé¢ä»£ç å—ä½¿ç”¨<code>from pydantic import v1 as pydantic_v1</code> æ¥æŒ‡å®šäº† v1 ç‰ˆæœ¬</p><p>Github ç›¸å…³ issueï¼š<ahref="https://github.com/langchain-ai/langchain/issues/9702">DOC: CustomTemplates issue with Pydantic v2 Â· Issue #9702 Â· langchain-ai/langchain(github.com)</a></p><h1 id="ç‰¹å¾å­˜å‚¨">ç‰¹å¾å­˜å‚¨</h1><p>ç‰¹å¾å­˜å‚¨æ˜¯ä¼ ç»Ÿæœºå™¨å­¦ä¹ ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œç¡®ä¿è¾“å…¥æ¨¡å‹çš„æ•°æ®æ˜¯æœ€æ–°çš„ä¸”ç›¸å…³çš„ï¼›æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ï¼š<ahref="https://www.tecton.ai/blog/what-is-a-feature-store/">What Is aFeature Store? | Tecton</a></p><p>LangChain æä¾›äº†ä¸€ç§å°†è¿™äº›æ•°æ®ä¸ LLMs ç»“åˆçš„ç®€å•æ–¹æ³•</p><p>æ–‡æ¡£ä¸­å±•ç¤ºå¦‚ä½•å°†æç¤ºæ¨¡æ¿ä¸ç‰¹å¾å­˜å‚¨è¿æ¥èµ·æ¥ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯åœ¨<strong>æç¤ºæ¨¡æ¿å†…éƒ¨è°ƒç”¨ç‰¹å¾å­˜å‚¨ä»¥æ£€ç´¢å€¼ï¼Œç„¶åå°†å…¶æ ¼å¼åŒ–ä¸ºæç¤º</strong></p><p>LangChain æ–‡æ¡£ä¸­å¯¹æ¥å¦‚ä¸‹ç‰¹å¾å­˜å‚¨å·¥å…·ï¼š</p><ul><li>Feastï¼šæµè¡Œçš„å¼€æºç‰¹å¾å­˜å‚¨æ¡†æ¶</li><li>Tectonï¼šå®Œå…¨æ‰˜ç®¡çš„ç‰¹å¾å¹³å°ï¼Œä¸“ä¸ºåè°ƒå®Œæ•´çš„ MLç‰¹å¾ç”Ÿå‘½å‘¨æœŸè€Œæ„å»ºï¼ŒåŒ…æ‹¬ä»è½¬æ¢åˆ°åœ¨çº¿æœåŠ¡çš„å…¨è¿‡ç¨‹ï¼Œå¹¶æä¾›ä¼ä¸šçº§çš„SLA</li><li>Featureformï¼šå¼€æºçš„ã€ä¼ä¸šçº§çš„ç‰¹å¾å­˜å‚¨</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://python.langchain.com.cn/docs/modules/model_io/prompts/">æç¤º(Prompts)| ğŸ¦œï¸ğŸ”— Langchain</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain æ–‡æ¡£å­¦ä¹  No.1 - å¿«é€Ÿå¼€å§‹</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.1%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LangChain/LangChain%20%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0%20No.1%20-%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»">ä»‹ç»</h1><p><strong>LangChain</strong>æ˜¯ä¸€ä¸ªåŸºäºè¯­è¨€æ¨¡å‹å¼€å‘åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚å®ƒå¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><strong>æ•°æ®æ„ŸçŸ¥</strong>ï¼šå°†è¯­è¨€æ¨¡å‹ä¸å…¶ä»–æ•°æ®æºè¿æ¥èµ·æ¥</li><li><strong>ä¸»ä½“æ€§</strong>ï¼šå…è®¸è¯­è¨€æ¨¡å‹ä¸å…¶ç¯å¢ƒè¿›è¡Œäº¤äº’</li></ul><p>LangChain çš„ä¸»è¦ä»·å€¼åŒ…æ‹¬ï¼š</p><ol type="1"><li><strong>ç»„ä»¶</strong>ï¼šç”¨äºå¤„ç†è¯­è¨€æ¨¡å‹çš„æŠ½è±¡ï¼Œä»¥åŠæ¯ä¸ªæŠ½è±¡çš„ä¸€ç³»åˆ—å®ç°ã€‚ç»„ä»¶æ˜¯æ¨¡å—åŒ–ä¸”æ˜“äºä½¿ç”¨çš„ï¼Œæ— è®ºæ‚¨æ˜¯å¦ä½¿ç”¨LangChain æ¡†æ¶çš„å…¶ä»–éƒ¨åˆ†ï¼Œéƒ½å¯ä»¥è½»æ¾ä½¿ç”¨</li><li><strong>ç°æˆçš„ç®¡é“</strong>ï¼šç”¨äºå®Œæˆç‰¹å®šé«˜çº§ä»»åŠ¡çš„ç»“æ„åŒ–ç»„ä»¶ç»„åˆ</li></ol><p>ç°æˆçš„ç®¡é“ä½¿å¾—å…¥é—¨å˜å¾—å®¹æ˜“ã€‚å¯¹äºæ›´å¤æ‚çš„åº”ç”¨ç¨‹åºå’Œç»†è‡´å…¥å¾®çš„ç”¨ä¾‹ï¼Œç»„ä»¶ä½¿å¾—è‡ªå®šä¹‰ç°æœ‰ç®¡é“æˆ–æ„å»ºæ–°ç®¡é“å˜å¾—å®¹æ˜“</p><p><br></p><p>å®è·µç¤ºä¾‹ï¼š</p><ul><li>èŠå¤©æœºå™¨äºº</li><li>ä½¿ç”¨æ•°æ®æºå›ç­”é—®é¢˜ï¼ˆçŸ¥è¯†åº“ï¼‰</li><li>åˆ†æç»“æ„åŒ–æ•°æ®</li></ul><h2 id="æ¨¡å—">æ¨¡å—</h2><p>LangChain ä¸ºä»¥ä¸‹æ¨¡å—æä¾›æ ‡å‡†ã€å¯æ‰©å±•çš„æ¥å£å’Œå¤–éƒ¨é›†æˆï¼ˆåŠŸèƒ½æ¨¡å—ï¼‰</p><ul><li><strong>æ¨¡å‹ I/O</strong>ï¼šä¸è¯­è¨€æ¨¡å‹è¿›è¡Œæ¥å£</li><li><strong>æ£€ç´¢</strong>ï¼šä¸ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„æ•°æ®è¿›è¡Œæ¥å£</li><li><strong>ç®¡é“</strong>ï¼šæ„å»ºè°ƒç”¨åºåˆ—</li><li><strong>ä»£ç†</strong>ï¼šè®©ç®¡é“æ ¹æ®é«˜çº§æŒ‡ä»¤é€‰æ‹©ä½¿ç”¨å“ªäº›å·¥å…·</li><li><strong>å†…å­˜</strong>ï¼šåœ¨ç®¡é“è¿è¡ŒæœŸé—´ä¿æŒåº”ç”¨ç¨‹åºçŠ¶æ€</li><li><strong>å›è°ƒ</strong>ï¼šè®°å½•å’Œæµå¼ä¼ è¾“ä»»ä½•ç®¡é“çš„ä¸­é—´æ­¥éª¤</li></ul><h1 id="ç¯å¢ƒ">ç¯å¢ƒ</h1><h2 id="langchain">LangChain</h2><p>LangChain Python ç‰ˆæœ¬çš„å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install langchain </span><br></pre></td></tr></table></figure><h2 id="openai">OpenAI</h2><p>ä½¿ç”¨ LangChainé€šå¸¸éœ€è¦ä¸ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å‹æä¾›è€…ã€æ•°æ®å­˜å‚¨ã€APIç­‰è¿›è¡Œé›†æˆ</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ OpenAI çš„æ¨¡å‹ API</p><p>æœ¬ç¤ºä¾‹ä½¿ç”¨å¾®è½¯ Azure çš„æ¨¡å‹ API</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install openai</span><br></pre></td></tr></table></figure><h1 id="å¼€å§‹">å¼€å§‹</h1><h2 id="æ„å»ºæ¨¡å—">æ„å»ºæ¨¡å—</h2><p>LangChain æä¾›äº†è®¸å¤šå¯ä»¥ç”¨æ¥æ„å»ºè¯­è¨€æ¨¡å‹åº”ç”¨ç¨‹åºçš„æ¨¡å—</p><p>è¿™äº›æ¨¡å—å¯ä»¥ä½œä¸ºç®€å•åº”ç”¨ç¨‹åºä¸­çš„ç‹¬ç«‹æ¨¡å—ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆåœ¨ä¸€èµ·ç”¨äºæ›´å¤æ‚çš„ç”¨ä¾‹</p><p>LangChain åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒæ„å»ºæ¨¡å—æ˜¯ LLMChainï¼Œå®ƒç»“åˆäº†ä¸‰ä¸ªæ–¹é¢ï¼š</p><ul><li><strong>LLM</strong>ï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰ï¼šè¯­è¨€æ¨¡å‹æ˜¯æ ¸å¿ƒæ¨ç†å¼•æ“ï¼›è¦ä½¿ç”¨LangChainï¼Œæ‚¨éœ€è¦äº†è§£ä¸åŒç±»å‹çš„è¯­è¨€æ¨¡å‹ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬</li><li><strong>PromptTemplates</strong>ï¼ˆæç¤ºè¯æ¨¡æ¿ï¼‰ï¼šæä¾›è¯­è¨€æ¨¡å‹çš„æŒ‡ä»¤ï¼›è¿™æ§åˆ¶äº†è¯­è¨€æ¨¡å‹çš„è¾“å‡ºï¼Œå› æ­¤äº†è§£å¦‚ä½•æ„å»ºæç¤ºå’Œä¸åŒçš„æç¤ºç­–ç•¥è‡³å…³é‡è¦</li><li><strong>Output Parsers</strong>ï¼ˆè¾“å‡ºè§£æå™¨ï¼‰ï¼šå°† LLMçš„åŸå§‹å“åº”è½¬æ¢ä¸ºæ›´æ˜“å¤„ç†çš„æ ¼å¼ï¼Œä½¿å¾—åœ¨ä¸‹æ¸¸ä½¿ç”¨è¾“å‡ºå˜å¾—å®¹æ˜“</li></ul><h2 id="llms">LLMs</h2><p>LangChain ä¸­æœ‰ä¸¤ç§ç±»å‹çš„è¯­è¨€æ¨¡å‹ï¼Œç§°ä¸ºï¼š</p><ul><li><strong>LLMs</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªä»¥å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥å¹¶è¿”å›å­—ç¬¦ä¸²çš„è¯­è¨€æ¨¡å‹</li><li><strong>ChatModels</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªä»¥æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥å¹¶è¿”å›æ¶ˆæ¯çš„è¯­è¨€æ¨¡å‹</li></ul><p>LLMs çš„è¾“å…¥/è¾“å‡ºç®€å•æ˜“æ‡‚ï¼Œæ˜¯å­—ç¬¦ä¸²</p><p>ä½†æ˜¯ ChatModels è¾“å…¥æ˜¯ä¸€ä¸ª <code>ChatMessage</code>åˆ—è¡¨ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªå•ç‹¬çš„ <code>ChatMessage</code>ï¼Œä¸€ä¸ª<code>ChatMessage</code> å…·æœ‰ä¸¤ä¸ªå¿…éœ€çš„ç»„ä»¶ï¼š</p><ul><li><code>content</code>ï¼šè¿™æ˜¯æ¶ˆæ¯çš„å†…å®¹</li><li><code>role</code>ï¼šè¿™æ˜¯ <code>ChatMessage</code>æ¥è‡ªçš„å®ä½“çš„è§’è‰²</li></ul><p>LangChain æä¾›äº†å‡ ä¸ªå¯¹è±¡ï¼Œç”¨äºæ–¹ä¾¿åœ°åŒºåˆ†ä¸åŒçš„è§’è‰²ï¼š</p><ul><li><code>HumanMessage</code>ï¼šæ¥è‡ªäººç±»/ç”¨æˆ·çš„<code>ChatMessage</code></li><li><code>AIMessage</code>ï¼šæ¥è‡ªAI/åŠ©æ‰‹çš„ <code>ChatMessage</code></li><li><code>SystemMessage</code>ï¼šæ¥è‡ªç³»ç»Ÿçš„ <code>ChatMessage</code></li><li><code>FunctionMessage</code>ï¼šæ¥è‡ªå‡½æ•°è°ƒç”¨çš„<code>ChatMessage</code></li></ul><p>å¦‚æœè¿™äº›è§’è‰²éƒ½ä¸åˆé€‚ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>ChatMessage</code>ç±»æ‰‹åŠ¨æŒ‡å®šè§’è‰²ï¼Œæœ‰å…³å¦‚ä½•æœ€æœ‰æ•ˆåœ°ä½¿ç”¨è¿™äº›ä¸åŒçš„æ¶ˆæ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æˆ‘ä»¬çš„æç¤ºæŒ‡å—</p><p>LangChainä¸ºä¸¤è€…æä¾›äº†ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œä½†äº†è§£è¿™ç§å·®å¼‚ä»¥ä¾¿ä¸ºç»™å®šçš„è¯­è¨€æ¨¡å‹æ„å»ºæç¤ºéå¸¸æœ‰ç”¨LangChain æä¾›çš„æ ‡å‡†æ¥å£æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li><code>predict</code>ï¼šæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</li><li><code>predict_messages</code>ï¼šæ¥å—ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨ï¼Œè¿”å›ä¸€ä¸ªæ¶ˆæ¯</li></ul><p><br></p><p>ä¸¤è€…çš„åŒºåˆ«ï¼Œé¦–å…ˆï¼Œè®©æˆ‘ä»¬å¯¼å…¥ LLM å’Œ ChatModel</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.llms <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">llm = OpenAI()</span><br><span class="line">chat_model = ChatOpenAI()</span><br><span class="line"></span><br><span class="line">llm.predict(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;Hi&quot;</span></span><br><span class="line"></span><br><span class="line">chat_model.predict(<span class="string">&quot;hi!&quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;Hi&quot;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>predict</code> æ–¹æ³•å¯¹å­—ç¬¦ä¸²è¾“å…¥è¿›è¡Œå¤„ç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;What would be a good company name for a company that makes colorful socks?&quot;</span></span><br><span class="line"></span><br><span class="line">llm.predict(text)</span><br><span class="line"><span class="comment"># &gt;&gt; Feetful of Fun</span></span><br><span class="line"></span><br><span class="line">chat_model.predict(text)</span><br><span class="line"><span class="comment"># &gt;&gt; Socks O&#x27;Color</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>predict_messages</code> æ–¹æ³•å¯¹æ¶ˆæ¯åˆ—è¡¨è¿›è¡Œå¤„ç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.schema <span class="keyword">import</span> HumanMessage</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;åˆ¶é€ å¤šå½©è¢œå­çš„å…¬å¸çš„å¥½åå­—æ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span></span><br><span class="line">messages = [HumanMessage(content=text)]</span><br><span class="line"></span><br><span class="line">llm.predict_messages(messages)</span><br><span class="line"><span class="comment"># &gt;&gt; Feetful of Fun</span></span><br><span class="line"></span><br><span class="line">chat_model.predict_messages(messages)</span><br><span class="line"><span class="comment"># &gt;&gt; Socks O&#x27;Color</span></span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸¤ç§æ–¹æ³•ï¼Œè¿˜å¯ä»¥å°†å‚æ•°ä½œä¸ºå…³é”®å­—å‚æ•°ä¼ é€’ï¼Œä¾‹å¦‚å¯ä»¥ä¼ å…¥<code>temperature=0</code> æ¥è°ƒæ•´ä½¿ç”¨çš„æ¸©åº¦ï¼Œè¯¥æ¸©åº¦å°†è¦†ç›–å¯¹è±¡çš„é…ç½®</p><p>éœ€è¦æ³¨æ„åœ¨è¿è¡Œæ—¶ä¼ å…¥çš„ä»»ä½•å€¼éƒ½å°†å§‹ç»ˆè¦†ç›–å¯¹è±¡çš„é…ç½®</p><h2 id="azureopenai-llm">AzureOpenAI LLM</h2><p>æœ¬ç¤ºä¾‹ä½¿ç”¨å¾®è½¯ Azure çš„æ¨¡å‹ API</p><p>å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ <ahref="https://learn.microsoft.com/zh-cn/azure/machine-learning/prompt-flow/how-to-integrate-with-langchain?view=azureml-api-2">åœ¨æç¤ºæµä¸­ä¸LangChain é›†æˆ - Azure Machine Learning | Microsoft Learn</a> æˆ–è€…LangChain çš„ LLM Integrations æ–‡æ¡£ <ahref="https://python.langchain.com.cn/docs/modules/model_io/models/llms/integrations/azure_openai_example">AzureOpenAI | ğŸ¦œï¸ğŸ”— Langchain</a> | <ahref="https://python.langchain.com.cn/docs/modules/model_io/models/chat/integrations/azure_chat_openai">Azure| ğŸ¦œï¸ğŸ”— Langchain</a></p><p>åˆ›å»º <code>LLM</code> å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.llms.openai <span class="keyword">import</span> AzureOpenAI</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_TYPE&quot;</span>] = <span class="string">&quot;azure&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_VERSION&quot;</span>] = <span class="string">&quot;2023-03-15-preview&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_KEY&quot;</span>] = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">llm = AzureOpenAI(</span><br><span class="line">    deployment_name=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    azure_endpoint=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    model_name=<span class="string">&quot;gpt-35-turbo-16k&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">result = llm.predict(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½ä¼šæ¥æ”¶åˆ°é”™è¯¯çš„è¿”å›</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;error&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;code&#x27;<span class="punctuation">:</span> &#x27;OperationNotSupported&#x27;<span class="punctuation">,</span> &#x27;message&#x27;<span class="punctuation">:</span> &#x27;The completion operation does not work with the specified model<span class="punctuation">,</span> gpt<span class="number">-35</span>-turbo<span class="number">-16</span>k. Please choose different model and try again. You can learn more about which models can be used with each operation here<span class="punctuation">:</span> https<span class="punctuation">:</span><span class="comment">//go.microsoft.com/fwlink/?linkid=2197993.&#x27;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯ <code>gpt-35-turbo-16k</code> æ¨¡å‹ä¸èƒ½ç”¨äº<code>AzureOpenAI</code> å¯¹è±¡ï¼Œåº”è¯¥ä½¿ç”¨<code>AzureChatOpenAI</code>ï¼›æˆ‘ç†è§£ Azure çš„ AIæœåŠ¡å¯¹æ–‡æœ¬å¤„ç†ï¼ˆLangChain ä¸­çš„ LLMsï¼‰å’Œé—®ç­”ã€èŠå¤©ï¼ˆLangChain ä¸­çš„ChatModelsï¼‰åšäº†åŒºåˆ†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ AzureChatOpenAI</span></span><br><span class="line">llm = AzureChatOpenAI(</span><br><span class="line">    deployment_name=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    azure_endpoint=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    model_name=<span class="string">&quot;gpt-35-turbo-16k&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="æç¤ºæ¨¡æ¿">æç¤ºæ¨¡æ¿</h2><p>æç¤ºæ¨¡æ¿å¯ä»¥å°†ç”¨æˆ·è¾“å…¥è½¬åŒ–ä¸ºå®Œå…¨æ ¼å¼åŒ–çš„æç¤ºçš„æ‰€æœ‰é€»è¾‘ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•åº”ç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prompt = PromptTemplate.from_template(<span class="string">&quot;please tell me in which country is &#123;city_name&#125; located?&quot;</span>)</span><br><span class="line">text = prompt.<span class="built_in">format</span>(city_name=<span class="string">&quot;BeiJing&quot;</span>)</span><br><span class="line"><span class="comment"># text = please tell me in which country is BeiJing located?</span></span><br><span class="line">result = llm.predict(text)</span><br><span class="line"><span class="comment"># &gt;&gt; Beijing is located in China. </span></span><br></pre></td></tr></table></figure><p>æç¤ºæ¨¡æ¿ä¸ä»…æ˜¯ç”¨äºå°†å­—ç¬¦ä¸²è¿›è¡Œæ ¼å¼åŒ–ï¼Œä¸»è¦çš„ä¼˜åŠ¿ï¼š</p><ul><li>å¤šæç¤ºä¸­æŠ½å‡ºå…±åŒå˜é‡ï¼Œåªæ ¼å¼åŒ–ä¸€æ¬¡</li><li>ç”Ÿæˆæ¶ˆæ¯åˆ—è¡¨ï¼Œç³»ç»Ÿæ¶ˆæ¯ã€è§’è‰²æ¶ˆæ¯ç­‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="string">&quot;You are a helpful assistant that translates &#123;input_language&#125; to &#123;output_language&#125;.&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line">human_template = <span class="string">&quot;&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])</span><br><span class="line">messages = chat_prompt.format_messages(input_language=<span class="string">&quot;English&quot;</span>, output_language=<span class="string">&quot;French&quot;</span>, text=<span class="string">&quot;I love programming.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(messages)</span><br><span class="line"><span class="comment"># &gt;&gt; [SystemMessage(content=&#x27;You are a helpful assistant that translates English to French.&#x27;), HumanMessage(content=&#x27;I love programming.&#x27;)]</span></span><br></pre></td></tr></table></figure><p>æ›´å¤šè¯¦è§åç»­æç¤ºè¯ç›¸å…³å†…å®¹</p><h2 id="è¾“å‡ºè§£æå™¨">è¾“å‡ºè§£æå™¨</h2><p><code>OutputParsers</code> å°† LLMçš„åŸå§‹è¾“å‡ºè½¬æ¢ä¸ºå¯ä»¥åœ¨ä¸‹æ¸¸ä½¿ç”¨çš„æ ¼å¼ è¾“å‡ºè§£æå™¨æœ‰å‡ ç§ä¸»è¦ç±»å‹ï¼š</p><ul><li>å°† LLM çš„æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„åŒ–ä¿¡æ¯ï¼ˆä¾‹å¦‚ JSONï¼‰</li><li>å°† ChatMessage è½¬æ¢ä¸ºå­—ç¬¦ä¸²</li><li>å°†é™¤æ¶ˆæ¯ä¹‹å¤–çš„å…¶ä»–ä¿¡æ¯ï¼ˆå¦‚ OpenAI å‡½æ•°è°ƒç”¨ï¼‰è½¬æ¢ä¸ºå­—ç¬¦ä¸²</li></ul><p>å®˜æ–¹ä¾‹å­ä¸­å®ç°äº†ä¸€ä¸ª<strong>å°†é€—å·åˆ†éš”çš„åˆ—è¡¨è½¬æ¢ä¸ºåˆ—è¡¨</strong>çš„è§£æå™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.schema <span class="keyword">import</span> BaseOutputParser</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommaSeparatedListOutputParser</span>(<span class="title class_ inherited__">BaseOutputParser</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parse the output of an LLM call to a comma-separated list.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, text: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Parse the output of an LLM call.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> text.strip().split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line"></span><br><span class="line">CommaSeparatedListOutputParser().parse(<span class="string">&quot;hi, bye&quot;</span>)</span><br><span class="line"><span class="comment"># &gt;&gt; [&#x27;hi&#x27;, &#x27;bye&#x27;]</span></span><br></pre></td></tr></table></figure><h2 id="llmchain">LLMChain</h2><p>ç°åœ¨å¯ä»¥å°†æ‰€æœ‰è¿™äº›ç»„åˆæˆä¸€ä¸ªé“¾ç»„ä»¶</p><p>è¿™ä¸ªé“¾ç»„ä»¶å°†æ¥æ”¶è¾“å…¥å˜é‡ï¼Œå°†å…¶ä¼ é€’ç»™æç¤ºæ¨¡æ¿ä»¥åˆ›å»ºæç¤ºï¼Œå°†æç¤ºä¼ é€’ç»™LLMï¼Œç„¶åé€šè¿‡ä¸€ä¸ªï¼ˆå¯é€‰çš„ï¼‰è¾“å‡ºè§£æå™¨å°†è¾“å‡ºè§£æåè¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> AzureChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.prompts.chat <span class="keyword">import</span> (</span><br><span class="line">    ChatPromptTemplate,</span><br><span class="line">    SystemMessagePromptTemplate,</span><br><span class="line">    HumanMessagePromptTemplate,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> langchain.schema <span class="keyword">import</span> BaseOutputParser</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommaSeparatedListOutputParser</span>(<span class="title class_ inherited__">BaseOutputParser</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parse the output of an LLM call to a comma-separated list.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, text: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Parse the output of an LLM call.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> text.strip().split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_TYPE&quot;</span>] = <span class="string">&quot;azure&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_VERSION&quot;</span>] = <span class="string">&quot;2023-03-15-preview&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_KEY&quot;</span>] = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">chat_model = AzureChatOpenAI(</span><br><span class="line">    deployment_name=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    azure_endpoint=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    model_name=<span class="string">&quot;gpt-35-turbo-16k&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;You are a helpful assistant who generates comma separated lists.</span></span><br><span class="line"><span class="string">A user will pass in a category, and you should generate 5 objects in that category in a comma separated list.</span></span><br><span class="line"><span class="string">ONLY return a comma separated list, and nothing more.&quot;&quot;&quot;</span></span><br><span class="line">system_message_prompt = SystemMessagePromptTemplate.from_template(template)</span><br><span class="line">human_template = <span class="string">&quot;&#123;text&#125;&quot;</span></span><br><span class="line">human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)</span><br><span class="line"></span><br><span class="line">chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])</span><br><span class="line">chain = LLMChain(</span><br><span class="line">    llm=chat_model,</span><br><span class="line">    prompt=chat_prompt,</span><br><span class="line">    output_parser=CommaSeparatedListOutputParser()</span><br><span class="line">)</span><br><span class="line">result = chain.run(<span class="string">&quot;DC super hero&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt; [&#x27;Superman&#x27;, &#x27;Batman&#x27;, &#x27;Wonder Woman&#x27;, &#x27;The Flash&#x27;, &#x27;Aquaman&#x27;]</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­è®© AI æˆä¸ºä¸€ä¸ªè¾“å‡º 5ä¸ªæŒ‡å®šåˆ†ç±»ä¸‹å¯¹è±¡ï¼Œå¹¶ä¸”ä½¿ç”¨é€—å·åˆ†éš”çš„åŠ©æ‰‹</p><h1 id="åç»­">åç»­</h1><p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åˆ›å»º LangChain åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒæ„å»ºå— - LLMChains</p><p>åœ¨æ‰€æœ‰è¿™äº›ç»„ä»¶ï¼ˆLLMsã€promptsã€è¾“å‡ºè§£æå™¨ï¼‰ä¸­è¿˜æœ‰å¾ˆå¤šå¾®å¦™ä¹‹å¤„ï¼Œä¼šåœ¨åé¢æŒç»­å­¦ä¹ </p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://python.langchain.com.cn/docs/get_started/quickstart">å¿«é€Ÿå…¥é—¨| ğŸ¦œï¸ğŸ”— Langchain</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LangChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> LangChain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Neon City</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Neon%20City.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Neon%20City.html</url>
      
        <content type="html"><![CDATA[<p><imgsrc="https://assets-prd.punchdrink.com/wp-content/uploads/2023/11/03141805/Vertical_NeonCity-500x688.jpg" /></p><h1 id="éœ“è™¹éƒ½å¸‚-neon-city">éœ“è™¹éƒ½å¸‚ Neon City</h1><p>åœ¨è¿™åœºæœ‰è¶£çš„ highball æ¯”èµ›ä¸­ï¼ŒNine Bar çš„è€æ¿ Lily Wang å’Œ JoeBriglioå±•ç¤ºäº†ä»–ä»¬æœ€å–œæ¬¢çš„å¤å­£ç¾é£Ÿä¹‹ä¸€çš„å‘³é“ï¼šæ„å¤§åˆ©å†°ï¼Œå°½ç®¡æœ‰ä¸€äº›æ„æƒ³ä¸åˆ°çš„æ·»åŠ </p><p>Lily Wang å’Œ Joe Briglio å°† Nine Bar æè¿°ä¸ºâ€œäºšæ´²é£æ ¼çš„é¸¡å°¾é…’é…’å§â€ï¼ŒNeon Cityä»¥çƒ§é…’ï¼ˆshochuï¼‰ä¸ºåŸºç¡€ï¼Œè¾…ä»¥æ¸…é…’ï¼ˆsakeï¼‰ã€å¯å°”å¿…æ€ï¼ˆCalpicoï¼‰å’Œç™½é…’ï¼ˆbaijiuï¼‰</p><p>æ‰€æœ‰è¿™äº›ç»“åˆåœ¨ä¸€èµ·å½¢æˆäº†å±‚æ¬¡åˆ†æ˜çš„åŸºç¡€ï¼Œå¼€èƒƒåˆ©å£é…’å’Œæ–°é²œæŸ æª¬æ±å¸¦æ¥äº†é¥®æ–™çµæ„Ÿä¸­é¢„æœŸçš„æµ“éƒæŸ‘æ©˜å‘³ã€‚LilyWang å½¢å®¹å®ƒ â€œè®©äººè€³ç›®ä¸€æ–°ï¼Œæœ‰ç‚¹æ—¶é«¦ï¼Œæ‹¥æœ‰ä»¤äººæ„‰å¿«çš„é…¸å‘³â€</p><h1 id="åŸæ–™">åŸæ–™</h1><p><em>Serving: 1</em></p><ul><li>çƒ§é…’ï¼ˆæœ€å¥½æ˜¯ Mizu Saga å¤§éº¦çƒ§é…’ï¼‰ - 1 ç›å¸</li><li>æ¸…é…’ï¼ˆæœ€å¥½æ˜¯ Joto æŸšå­æ¸…é…’ï¼‰ - 0.75 ç›å¸</li><li>å¯å°”å¿…æ€ - 0.75 ç›å¸</li><li>å¼€èƒƒåˆ©å£é…’ï¼ˆæœ€å¥½æ˜¯ St. Agrestis Paradisoï¼‰- 0.5 ç›å¸</li><li>ç™½é…’ï¼ˆæœ€å¥½æ˜¯ Ming Riverï¼‰ - 0.25 ç›å¸</li><li>æŸ æª¬æ± - 0.25 ç›å¸</li><li>Topo Chico - åŠ æ»¡</li></ul><p><strong>è£…é¥°</strong>ï¼šæ©™å­ç‰‡</p><h1 id="æ­¥éª¤">æ­¥éª¤</h1><ul><li>å°†é™¤ Topo Chico å¤–çš„æ‰€æœ‰åŸæ–™æ”¾å…¥åŠ å†°çš„æµ·æ³¢æ¯ä¸­æ··åˆ</li><li>åŠ æ»¡ Topo Chico</li><li>ç”¨ä¸€ç‰‡æ©™å­ç‰‡è£…é¥°</li></ul><h1 id="è¡¥å……">è¡¥å……</h1><h2 id="ming-river-baijiu">Ming River Baijiu</h2><p>æœ‰æ„æ€çš„æ˜¯è¿™ä¸ª â€ä¸œæ–¹é£æ ¼â€œ çš„é…æ–¹é‡Œç”¨åˆ°äº†çƒ§é…’ã€æ¸…é…’å’Œç™½é…’</p><p>ç™½é…’æåˆ°çš„ <em>MingRiver</em>ï¼Œä¸­æ–‡åä¸ºæ˜æ±Ÿç™½é…’ï¼Œæ˜¯æ³¸å·è€çª–å…¬å¸å‡ºå“çš„ä¸€æ¬¾æµ·å¤–äº§å“ï¼Œä¸“é—¨é’ˆå¯¹å›½å¤–å¸‚åœº</p><p><a href="https://shopmingriver.com/">Welcome - Shop MingRiver</a></p><p><ahref="https://zhuanlan.zhihu.com/p/71534144">é‚£äº›åœ¨insä¸Šçˆ†ç«çš„ç™½é…’ï¼å‡­ä»€ä¹ˆè®©å¤–å›½äººç–¯ç‹‚ï¼Ÿ</a></p><p>åŒ…è£…çœ‹èµ·æ¥ç¡®å®æ¯”å›½å†…å¸‚åœºç™½é…’æ›´é€‚åˆæµ·å¤–å®¡ç¾</p><figure><imgsrc="https://shopmingriver.com/wp-content/themes/shop-ming-river/images/header.jpg"alt="Ming River" /><figcaption aria-hidden="true">Ming River</figcaption></figure><h2 id="topo-chico">Topo Chico</h2><p>Topo Chicoæ˜¯ä¸€å®¶å¢¨è¥¿å“¥è½¯é¥®æ–™ç”Ÿäº§å•†ï¼Œä¸»è¦ç”Ÿäº§çŸ¿æ³‰æ°´ï¼Œè‹æ‰“é¥®æ–™ç­‰ï¼›è¢«å¯å£å¯ä¹æ”¶è´­</p><blockquote><p>Topo Chico æ°”æ³¡æ°´é•¿æœŸä»¥æ¥è¢«ç”¨äºè°ƒåˆ¶é…’ç²¾é¥®æ–™ï¼Œè¿™ç§å’Œé…’ç²¾çš„ â€œç¼˜åˆ†â€ä¹Ÿæˆä¸ºäº† Topo Chico ç¡¬è‹æ‰“æ°”æ³¡é…’çš„ç ”å‘çµæ„Ÿ</p><p>2020 å¹´ 10 æœˆï¼Œå¯å£å¯ä¹è®¡åˆ’ä¸å•¤é…’å·¨å¤´ Molson Coors åˆä½œï¼Œäº 2021ä¸ŠåŠå¹´åœ¨ç¾å›½æ¨å‡º Topo Chico ç¡¬è‹æ‰“æ°”æ³¡é…’</p></blockquote><p><imgsrc="https://image.9928.tv/UserFiles/tangjiuhui/20220414/20220414105716.jpg" /></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†ç‰‡ä¸ç­‰äºåˆ†å¸ƒå¼</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F.html</url>
      
        <content type="html"><![CDATA[<p>åˆ†ç‰‡ï¼ˆshardingï¼‰æ˜¯ä¸€ç§å°†æ•°æ®å’Œè´Ÿè½½åˆ†å¸ƒåœ¨å‡ ä¸ªç‹¬ç«‹æ•°æ®åº“å®ä¾‹ä¸­çš„æŠ€æœ¯</p><p>è¯¥æ–¹æ³•é€šè¿‡å°†åŸå§‹æ•°æ®é›†æ‹†åˆ†ä¸ºç¢ç‰‡ï¼ˆshardsï¼‰æ¥åˆ©ç”¨æ°´å¹³å¯ä¼¸ç¼©æ€§ï¼Œç„¶åå°†å…¶åˆ†å¸ƒåœ¨å¤šä¸ªæ•°æ®åº“å®ä¾‹ä¸­</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1yg3PV8O2RO4YegyiYeiItA.png" class="" title="img"><p>ä½†æ˜¯ï¼Œå³ä½¿åŠ¨è¯ <em>distributes</em>å‡ºç°åœ¨åˆ†ç‰‡çš„å®šä¹‰ä¸­ï¼Œåˆ†ç‰‡æ•°æ®åº“ä¹Ÿä¸æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“</p><h1 id="åˆ†ç‰‡è§£å†³æ–¹æ¡ˆ">åˆ†ç‰‡è§£å†³æ–¹æ¡ˆ</h1><p>æ¯ä¸ªåˆ†ç‰‡è§£å†³æ–¹æ¡ˆåœ¨å…¶æ¶æ„ä¸­éƒ½æœ‰ä¸€ä¸ªè‡³å…³é‡è¦çš„ç»„ä»¶</p><p>è¯¥ç»„ä»¶è¢«å®šä¹‰ä¸ºå„ç§å„æ ·çš„åå­—ï¼Œä¾‹å¦‚ï¼šåè°ƒè€…ï¼ˆcoordinatorï¼‰ã€è·¯ç”±å™¨ï¼ˆrouterï¼‰ã€ä»£ç†äººï¼ˆdirectorï¼‰</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1kp39_8mQ0E9bIO0Lw3PGFw.png" class="" title="img"><p>åè°ƒè€…æ˜¯å”¯ä¸€çŸ¥é“æ•°æ®åˆ†å¸ƒçš„ç»„ä»¶ï¼Œå®ƒæ˜ å°„å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°ç‰¹æ®Šçš„åˆ†ç‰‡ä¸Šï¼Œæ¥ç€æ˜ å°„åˆ°å¯¹åº”çš„æ•°æ®åº“å®ä¾‹</p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯å¿…é¡»é€šè¿‡åè°ƒè€…è·¯ç”±å®ƒä»¬çš„è¯·æ±‚</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼šå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯å¸Œæœ›æ’å…¥ä¸€æ¡æ•°æ®åˆ° <code>Car</code>è¿™å¼ è¡¨ï¼Œè¯¥è¯·æ±‚é¦–å…ˆä¼šæäº¤åˆ°åè°ƒè€…ï¼›åè°ƒè€…ä¼šæ˜ å°„è¯¥è®°å½•çš„ä¸»é”®ï¼ˆåŸæ–‡ä¸­æ˜¯<em>primarykey</em>ï¼Œè¿™é‡Œåº”è¯¥ä¸»è¦æŒ‡åˆ†è¡¨é”®ï¼‰åˆ°å…¶ä¸­ä¸€ä¸ªåˆ†ç‰‡ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™è´Ÿè´£è¯¥åˆ†ç‰‡çš„æ•°æ®åº“å®ä¾‹</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1YNUB6y8WJnp0CCVAXSjQ0g.png" class="" title="img"><p>åœ¨ä¸Šè¿°ç¤ºæ„å›¾ä¸­ï¼Œé¦–å…ˆåè°ƒè€…æ˜ å°„é”® <code>121</code> åˆ°åˆ†ç‰‡<code>10</code>ï¼Œæ¥ç€æ’å…¥æ•°æ®åˆ°æŒæœ‰åˆ†ç‰‡ <code>10</code>ï¼Œå³è¡¨<code>car_10</code> çš„æ•°æ®åº“å®ä¾‹ä¸Š</p><p>å¯æ˜¯äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆåœ¨åˆ†ç‰‡è§£å†³æ–¹æ¡ˆä¸­éœ€è¦ä¸€ä¸ªåè°ƒè€…çš„è§’è‰²ï¼Ÿç­”æ¡ˆæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼šåˆ†ç‰‡å­˜å‚¨åœ¨ä¸ºå•æœåŠ¡å™¨éƒ¨ç½²è®¾è®¡çš„æ•°æ®åº“å®ä¾‹ä¸Š</p><blockquote><p><em>These database instances do not communicate with each other, nordo they support any protocols that would facilitate such communication.Unaware of each other, they exist in their own isolated environments,oblivious to the fact that they are part of a larger system.</em></p><p>è¿™äº›æ•°æ®åº“å®ä¾‹ä¸ç›¸äº’é€šä¿¡ï¼Œä¹Ÿä¸æ”¯æŒä»»ä½•æœ‰åŠ©äºè¿™ç§é€šä¿¡çš„åè®®ã€‚å®ƒä»¬å½¼æ­¤ä¸çŸ¥æƒ…ï¼Œå­˜åœ¨äºè‡ªå·±å­¤ç«‹çš„ç¯å¢ƒä¸­ï¼Œå¿½ç•¥äº†å®ƒä»¬æ˜¯ä¸€ä¸ªæ›´å¤§ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†è¿™ä¸€äº‹å®</p></blockquote><p>å› æ­¤åœ¨åˆ†ç‰‡è§£å†³æ–¹æ¡ˆä¸­åè°ƒè€…æ˜¯ä¸å¯æˆ–ç¼ºçš„è§’è‰²ï¼›å¦‚æœä½ æœ‰å…´è¶£æ·±å…¥ç ”ç©¶ç¢ç‰‡æ•°æ®åº“æ¶æ„ï¼Œå¯ä»¥è€ƒè™‘æ¢ç´¢CitusData æˆ– Azure CosmosDB for PostgreSQLã€Vitess for MySQLã€Oracleåˆ†å¸ƒå¼è‡ªæ²»æ•°æ®åº“å’Œ MongoDB sharded Cluster</p><h1 id="åˆ†å¸ƒå¼æ•°æ®åº“">åˆ†å¸ƒå¼æ•°æ®åº“</h1><p>ä¸åˆ†ç‰‡æ•°æ®åº“è§£å†³æ–¹æ¡ˆéå¸¸ç›¸ä¼¼ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¹Ÿä½¿ç”¨ç±»ä¼¼çš„åˆ†ç‰‡æŠ€æœ¯åœ¨æ•°æ®åº“èŠ‚ç‚¹é›†ç¾¤ä¸­å­˜å‚¨å’Œè¯»å–æ•°æ®</p><p>ä¸åŒçš„æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸ä¾é åè°ƒè€…ç»„ä»¶</p><p><strong>åˆ†å¸ƒå¼æ•°æ®åº“å»ºç«‹åœ¨ä¸€ä¸ªæ— å…±äº«çš„ä½“ç³»ç»“æ„ä¸Š</strong>ï¼Œè¯¥ä½“ç³»ç»“æ„æ²¡æœ‰åƒåè°ƒè€…è¿™æ ·çš„å•ä¸€ç»„ä»¶ï¼Œæ‰¿æ‹…ç€è®¸å¤šå†³ç­–çš„è´Ÿæ‹…ï¼š</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1deOgcXccWs9lKUSgLPNOww.png" class="" title="img"><p><em>é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½çŸ¥é“å½¼æ­¤ï¼Œä»è€ŒçŸ¥é“æ•°æ®åˆ†å¸ƒï¼›é€šè¿‡ç›´æ¥é€šä¿¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å°†å®¢æˆ·ç«¯è¯·æ±‚è·¯ç”±åˆ°é€‚å½“çš„åˆ†ç‰‡æ‰€æœ‰è€…ï¼›æ­¤å¤–å®ƒä»¬è¿˜å¯ä»¥æ‰§è¡Œå’Œåè°ƒå¤šèŠ‚ç‚¹äº‹åŠ¡ï¼Œå½“ç¼©æ”¾åˆ°æ›´å¤šèŠ‚ç‚¹æ—¶ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨é‡æ–°å¹³è¡¡å’Œæ‹†åˆ†åˆ†ç‰‡ï¼›èŠ‚ç‚¹ç»´æŠ¤æ•°æ®çš„å†—ä½™å‰¯æœ¬ï¼ˆåŸºäºé…ç½®çš„å¤åˆ¶å› å­ï¼‰ï¼Œå³ä½¿æŸäº›èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹ç»§ç»­æ“ä½œ</em></p><p>æ‰€æœ‰è¿™äº›å¯¹å®¢æˆ·ç«¯æ¥è¯´éƒ½æ˜¯é€æ˜çš„ï¼Œå®¢æˆ·ç«¯åªéœ€ä¸ä»»ä½•èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå¹¶å…è®¸è¯¥èŠ‚ç‚¹ç®¡ç†åˆ†å¸ƒå¼æ–¹é¢</p><p>ä¸¾ä¸ªä¾‹å­ï¼šä¸€ä¸ªå®¢æˆ·ç«¯å¯èƒ½è¿æ¥åˆ° <code>node1</code> ç„¶åæ’å…¥äº†ä¸€æ¡<code>Car</code> çš„æ–°æ•°æ®ï¼Œid ä¸º <code>121</code>ï¼›å¦‚æœ<code>node1</code>æ˜¯åˆ†ç‰‡çš„æ‰€æœ‰è€…ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨æœ¬åœ°å­˜å‚¨è®°å½•ï¼Œå¹¶ä¸”é‡‡ç”¨ä¸€è‡´æ€§ç®—æ³•ï¼ˆconsensusalgorithmï¼‰å°†å˜æ›´å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹çš„å­é›†ï¼›å¦‚æœä¸æ˜¯æ‰€æœ‰è€…ï¼Œ<code>node1</code>ä¼šå°†è¯·æ±‚è½¬å‘ç»™åˆ†ç‰‡çš„æŒæœ‰è€…ï¼Œæ¯”å¦‚ <code>node4</code></p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/%E5%88%86%E7%89%87%E4%B8%8D%E7%AD%89%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F/1weEdq2BxIpf6GiLjipns5Q.png" class="" title="img"><p>å¦‚æœä½ æœ‰å…´è¶£æ¢ç´¢çœŸæ­£çš„åˆ†å¸ƒå¼æ•°æ®åº“çš„ä½“ç³»ç»“æ„ï¼Œå¯ä»¥è€ƒè™‘ç ”ç©¶ GoogleSpannerã€YugabyteDBã€CockratchDBã€Apache Cassandra æˆ– Apache Ignite</p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>åœ¨æ•°æ®åº“é¢†åŸŸï¼Œåˆ†ç‰‡å’Œåˆ†å‘ç»å¸¸è¢«æ··ä¸ºä¸€è°ˆï¼Œä½†å®ƒä»¬æœ‰ä¸åŒçš„ç”¨é€”</p><p>è™½ç„¶åˆ†ç‰‡æ¶‰åŠåœ¨å¤šä¸ªç‹¬ç«‹å®ä¾‹ä¹‹é—´æ‹†åˆ†æ•°æ®ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ç³»ç»Ÿæ˜¯åˆ†å¸ƒå¼çš„ï¼›åœ¨åˆ†ç‰‡è§£å†³æ–¹æ¡ˆä¸­å­˜åœ¨ä¸€ä¸ªåè°ƒè€…ï¼Œå®ƒå°†å®¢æˆ·ç«¯è¯·æ±‚å¼•å¯¼åˆ°é€‚å½“çš„åˆ†ç‰‡ï¼Œè¿™æ˜¯ä¸¤è€…ä¹‹é—´æ˜¾è‘—çš„åŒºåˆ«</p><p>å¦ä¸€æ–¹é¢ï¼Œå»ºç«‹åœ¨æ— å…±äº«ä½“ç³»ç»“æ„ä¸Šçš„åˆ†å¸ƒå¼æ•°æ®åº“ç¼ºå°‘è¿™ç§é›†ä¸­å¼åè°ƒè€…ï¼Œè¿™äº›ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹ç›¸äº’äº†è§£ï¼Œç®¡ç†æ•°æ®åˆ†å‘ï¼Œå¹¶æ— ç¼å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</p><p>è¿™ä¸¤ç§ä½“ç³»ç»“æ„éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹ï¼Œäº†è§£å®ƒä»¬çš„ç»†å¾®å·®åˆ«å¯¹äºæ˜æ™ºçš„æ•°æ®åº“è®¾è®¡å’Œé€‰æ‹©è‡³å…³é‡è¦</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://medium.com/@magda7817/sharded-does-not-imply-distributed-572fdafc4040">ShardedDoes Not Imply Distributed | by Denis Magda | Sep, 2023 | Medium</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LiteFlow - ç»„ä»¶çš„è¶…æ—¶æ—¶é—´</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20%E7%BB%84%E4%BB%B6%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20%E7%BB%84%E4%BB%B6%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p><ahref="https://gitee.com/dromara/liteFlow/issues/I7I3LL">å…è®¸å¯¹ELä¸­çš„æ¯â¼€ä¸ªç»„ä»¶è®¾ç½®è¶…æ—¶æ—¶é—´æ§åˆ¶Â· Issue #I7I3LL Â· dromara/liteFlow - Gitee.com</a></p><p>issue ä¸­éœ€æ±‚äº†æ›´ç»†ç²’åº¦çš„è¶…æ—¶æ—¶é—´è®¾ç½®ï¼Œå…è®¸ ELä¸­çš„æ¯â¼€ä¸ªç»„ä»¶è®¾ç½®è¶…æ—¶æ—¶é—´æ§åˆ¶</p><p>å¦‚ä½•ä½¿ç”¨å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£</p><p><a href="https://liteflow.cc/pages/fd5984/#ä½¿ç”¨æ–¹æ³•">â±ï¸è¶…æ—¶æ§åˆ¶ |LiteFlow</a></p><h1 id="å®ç°">å®ç°</h1><h2 id="el-å…³é”®å­—">EL å…³é”®å­—</h2><p>åœ¨ EL è§£æå™¨ä¸­æ³¨å†Œç›¸å…³çš„è¡¨è¾¾å¼å’Œ <code>BaseOperator</code> å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ELè§£æå¼•æ“</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ExpressRunner</span> <span class="variable">EXPRESS_RUNNER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressRunner</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–QLExpressçš„Runner</span></span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.THEN, <span class="keyword">new</span> <span class="title class_">ThenOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.WHEN, <span class="keyword">new</span> <span class="title class_">WhenOperator</span>());</span><br><span class="line">...</span><br><span class="line">   <span class="comment">// è¿™é‡Œ MAX_WAIT_SECONDS = maxWaitSeconds</span></span><br><span class="line">EXPRESS_RUNNER.addFunctionAndClassMethod(ChainConstant.MAX_WAIT_SECONDS, Object.class, <span class="keyword">new</span> <span class="title class_">MaxWaitSecondsOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunctionAndClassMethod(ChainConstant.PARALLEL, Object.class, <span class="keyword">new</span> <span class="title class_">ParallelOperator</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="maxwaitsecondsoperator">MaxWaitSecondsOperator</h2><p><code>MaxWaitSecondsOperator</code> å®ç°è‡ª<code>BaseOperator</code></p><blockquote><p><code>BaseOperator</code> ä¸ºäº†å¼ºåŒ– <code>executeInner</code>æ–¹æ³•ï¼Œä¼šæ•è·æŠ›å‡ºçš„ <code>QLException</code> é”™è¯¯ï¼Œè¾“å‡ºå‹å¥½çš„é”™è¯¯æç¤º</p></blockquote><p><code>build</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Condition <span class="title function_">build</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="comment">// æ ¡éªŒå‚æ•°æ•°é‡</span></span><br><span class="line">    OperatorHelper.checkObjectSizeEqTwo(objects);</span><br><span class="line">  <span class="comment">// è½¬æ¢å‚æ•° 1 ä¸ºæ‰§è¡Œå¯¹è±¡</span></span><br><span class="line">    <span class="type">Executable</span> <span class="variable">executable</span> <span class="operator">=</span> OperatorHelper.convert(objects[<span class="number">0</span>], Executable.class);</span><br><span class="line">    <span class="comment">// è·å–ä¼ å…¥çš„æ—¶é—´å‚æ•°</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">maxWaitSeconds</span> <span class="operator">=</span> OperatorHelper.convert(objects[<span class="number">1</span>], Integer.class);</span><br><span class="line">    <span class="keyword">if</span> (executable <span class="keyword">instanceof</span> WhenCondition) &#123;</span><br><span class="line">        <span class="comment">// WhenConditionï¼Œç›´æ¥è®¾ç½®ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        <span class="type">WhenCondition</span> <span class="variable">whenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, WhenCondition.class);</span><br><span class="line">        whenCondition.setMaxWaitTime(maxWaitSeconds);</span><br><span class="line">        whenCondition.setMaxWaitTimeUnit(TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> whenCondition;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (executable <span class="keyword">instanceof</span> FinallyCondition) &#123;</span><br><span class="line">        <span class="comment">// FINALLYï¼ŒæŠ¥é”™</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrFormatter.format(<span class="string">&quot;The caller [&#123;&#125;] cannot use the keyword \&quot;maxWaitSeconds&#x27;\&quot;&quot;</span>, executable.toString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QLException</span>(errorMsg);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (containsFinally(executable)) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç† THEN ä¸­çš„ FINALLY</span></span><br><span class="line">        <span class="type">ThenCondition</span> <span class="variable">thenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, ThenCondition.class);</span><br><span class="line">        <span class="keyword">return</span> handleFinally(thenCondition, maxWaitSeconds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…¶ä»–æƒ…å†µï¼Œè¢« WHEN åŒ…è£…</span></span><br><span class="line">        <span class="keyword">return</span> wrappedByTimeout(executable, maxWaitSeconds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p><ul><li>æ ¡éªŒ &amp; å‡†å¤‡å·¥ä½œ<ul><li>æ ¡éªŒå‚æ•°æ•°é‡ï¼›å‚æ•°æ•°é‡éœ€è¦ä¸º 2ï¼ˆæ‰§è¡Œå¯¹è±¡ã€è¶…æ—¶æ—¶é—´ï¼‰</li><li>è½¬æ¢ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ‰§è¡Œå¯¹è±¡ï¼›è°ƒç”¨<code>OperatorHelper.convert</code>ï¼Œé€»è¾‘ä¸­å¾ˆå¤šå¯¹è±¡éƒ½ç”¨<code>Object</code>å¼•ç”¨æ‰¿æ¥ï¼Œåœ¨è½¬æ¢æ–¹æ³•ä¸­è¿›è¡Œæ ¡éªŒï¼›ä¸ªäººç†è§£æ˜¯ç‰ºç‰²äº†ä¸€äº›å¯è¯»æ€§æ¢å–äº†å¼€å‘çš„çµæ´»æ€§</li><li>è·å–è¶…æ—¶æ—¶é—´å‚æ•°</li></ul></li><li>åŒ…è£… Condition<ul><li><code>WhenCondition</code> ç›´æ¥è®¾ç½®ç­‰å¾…æ—¶é—´</li><li><code>FinallyCondition</code> ä¸å…è®¸è®¾ç½®è¶…æ—¶æ—¶é—´</li><li><code>ThenCondition</code> ä¸­å¦‚æœåŒ…å«<code>FinallyCondition</code>ï¼Œä¼šåœ¨ <code>handleFinally</code>æ–¹æ³•ä¸­åŒ…è£…æˆä¸€ä¸ª <code>WhenCondition</code>ï¼Œå¤–å±‚å¥—ä¸€ä¸ª<code>ThenCondition</code>ï¼Œå°† <code>FinallyCondition</code>æ’é™¤å‡ºå»ï¼Œæ—¶é—´è®¾ç½®åœ¨é‡Œå±‚çš„ <code>WhenCondition</code> ä¸­</li><li>å…¶ä»–åˆ™è¢«åŒ…è£…æˆ<code>TimeoutCondition</code>ï¼›<code>TimeoutCondition</code> æ˜¯<code>WhenCondition</code> çš„å®ç°ï¼ŒåŒºåˆ«åœ¨äºå°†æ‰§è¡Œå¯¹è±¡æŠ›å‡ºçš„<code>WhenTimeoutException</code> è½¬æ¢ä¸º<code>TimeoutException</code></li></ul></li></ul><h2 id="whencondition">WhenCondition</h2><p><code>WhenCondition</code> åœ¨æ—©æœŸç‰ˆæœ¬å°±æ”¯æŒè¶…æ—¶è®¾ç½®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># å¼‚æ­¥çº¿ç¨‹æœ€â»“çš„ç­‰å¾…æ—¶é—´(åªâ½¤äºwhen)ï¼Œé»˜è®¤å€¼ä¸º15000</span><br><span class="line">liteflow.when-max-wait-time=15000</span><br><span class="line"></span><br><span class="line"># å¼‚æ­¥çº¿ç¨‹æœ€â»“çš„ç­‰å¾…æ—¶é—´å•ä½(åªâ½¤äºwhen)ï¼Œé»˜è®¤å€¼ä¸ºMILLISECONDSï¼Œæ¯«ç§’</span><br><span class="line">liteflow.when-max-wait-time-unit=MILLISECONDS</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯¹äº <code>WhenCondition</code>çš„å¤„ç†åªéœ€è¦è®¾ç½®åˆé€‚çš„å±æ€§å€¼å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (executable <span class="keyword">instanceof</span> WhenCondition) &#123;</span><br><span class="line">        <span class="comment">// WhenConditionï¼Œç›´æ¥è®¾ç½®ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        <span class="type">WhenCondition</span> <span class="variable">whenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, WhenCondition.class);</span><br><span class="line">        whenCondition.setMaxWaitTime(maxWaitSeconds);</span><br><span class="line">        whenCondition.setMaxWaitTimeUnit(TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> whenCondition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>WhenCondition</code> æ‰§è¡Œæ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ª<code>ScheduledThreadPoolExecutor</code> æ¥å®ç°è¶…æ—¶æ•ˆæœ</p><p>å…·ä½“æµç¨‹å¯ä»¥é˜…è¯» <ahref="https://www.kuga.fun/å¼€å‘/LiteFlow/LiteFlow%20WhenCondition%20å’Œå¼‚æ­¥è¶…æ—¶æœºåˆ¶.html">LiteFlow- WhenCondition å’Œå¼‚æ­¥è¶…æ—¶æœºåˆ¶ | è´«ç˜ ä¹‹åœ° (kuga.fun)</a></p><h2 id="finallycondition">FinallyCondition</h2><p><code>FinallyCondition</code> ä¸å…è®¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (executable <span class="keyword">instanceof</span> FinallyCondition) &#123;</span><br><span class="line">            <span class="comment">// FINALLYï¼ŒæŠ¥é”™</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrFormatter.format(<span class="string">&quot;The caller [&#123;&#125;] cannot use the keyword \&quot;maxWaitSeconds&#x27;\&quot;&quot;</span>, executable.toString());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QLException</span>(errorMsg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ <code>FinallyCondition</code> ä¸èƒ½è®¾ç½®è¶…æ—¶æ—¶é—´å‘¢</p><p>åœ¨ issue é‡Œå¯ä»¥çœ‹åˆ°è¿™æ ·çš„è¡¨è¾¾</p><blockquote><p>å¦‚æœä¸ä½¿ç”¨ <code>maxWaitSeconds</code> åˆ™è¡¨ç¤ºä¸ä½¿ç”¨è¶…æ—¶æ§åˆ¶ã€‚æ­¤å¤–ï¼Œ<code>FINALLY</code> ä¸èƒ½ä½¿ç”¨<code>maxWaitSeconds</code>ï¼Œå…¶ä¸€å®šä¼šè¢«æ‰§è¡Œ</p></blockquote><p>è¿™æ ·çš„å®ç°åº”è¯¥æ˜¯ä¸ºäº†é¿å…ä½œä¸ºå…œåº•çš„åç½®å¤„ç†ï¼Œå› ä¸ºè¶…æ—¶åè€Œæ— æ³•æ­£å¸¸æ‰§è¡Œäº†</p><h2 id="thencondition">ThenCondition</h2><p>è¿™ä¸ª case çš„å…¥å£æ˜¯ä¸€ä¸ªåˆ¤æ–­æ–¹æ³• <code>containsFinally</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­ THEN ä¸­æ˜¯å¦å«æœ‰ FINALLY ç»„ä»¶</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> executable åˆ¤æ–­å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å«æœ‰ FINALLY ç»„ä»¶è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsFinally</span><span class="params">(Executable executable)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> executable <span class="keyword">instanceof</span> ThenCondition</span><br><span class="line">            &amp;&amp; CollUtil.isNotEmpty(((ThenCondition) executable).getFinallyConditionList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®åˆ¤æ–­äº†ä¸¤éƒ¨åˆ†å†…å®¹ï¼š</p><ul><li><code>executable</code> å¯¹è±¡æ˜¯ä¸€ä¸ª <code>ThenCondition</code></li><li>è¿™ä¸ª <code>ThenCondition</code> åç½®å¤„ç†å™¨ä¸ä¸ºç©º</li></ul><p><br></p><p>æ»¡è¶³æ¡ä»¶åå°±ä¼šè¿›å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (containsFinally(executable)) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç† THEN ä¸­çš„ FINALLY</span></span><br><span class="line">        <span class="type">ThenCondition</span> <span class="variable">thenCondition</span> <span class="operator">=</span> OperatorHelper.convert(executable, ThenCondition.class);</span><br><span class="line">        <span class="keyword">return</span> handleFinally(thenCondition, maxWaitSeconds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œé¦–å…ˆæå–äº† <code>ThenCondition</code> å¯¹è±¡</p><p>ç„¶åè°ƒç”¨ <code>handleFinally</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°† FINALLY æ’é™¤åœ¨è¶…æ—¶æ§åˆ¶ä¹‹å¤–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> thenCondition  å¾…å¤„ç†çš„ ThenCondition</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxWaitSeconds æœ€å¤§ç­‰å¾…ç§’æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å¤„ç†åçš„ ThenCondition</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ThenCondition <span class="title function_">handleFinally</span><span class="params">(ThenCondition thenCondition, Integer maxWaitSeconds)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿›è¡Œå¦‚ä¸‹è½¬æ¢</span></span><br><span class="line">    <span class="comment">// THEN(PRE(a),b,FINALLY(c))</span></span><br><span class="line">    <span class="comment">// =&gt; THEN(</span></span><br><span class="line">    <span class="comment">//      WHEN(THEN(PRE(a),b)),</span></span><br><span class="line">    <span class="comment">//      FINALLY(c))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰å¤–å±‚ THEN</span></span><br><span class="line">    <span class="type">ThenCondition</span> <span class="variable">outerThenCondition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThenCondition</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠŠ FINALLY è½¬ç§»åˆ°å¤–å±‚ THEN</span></span><br><span class="line">    List&lt;Executable&gt; finallyList = thenCondition.getExecutableList(ConditionKey.FINALLY_KEY);</span><br><span class="line">    finallyList.forEach(executable</span><br><span class="line">            -&gt; outerThenCondition</span><br><span class="line">            .addFinallyCondition((FinallyCondition) executable));</span><br><span class="line">    finallyList.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ…è£…å†…éƒ¨ THEN</span></span><br><span class="line">    <span class="type">WhenCondition</span> <span class="variable">whenCondition</span> <span class="operator">=</span> wrappedByTimeout(thenCondition, maxWaitSeconds);</span><br><span class="line">    outerThenCondition.addExecutable(whenCondition);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outerThenCondition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸ºäº†å®ç°æ­£å¸¸æ‰§è¡Œ <code>THEN</code>æ“ä½œçš„è¶…æ—¶è€Œä¸å½±å“åˆ°åç½®ç»„ä»¶ï¼Œé€‰æ‹©å¯¹ <code>ThenCondition</code>è¿›äº†ä¸€å±‚åŒ…è£…</p><p>è¿™é‡ŒåŒ…è£…çš„ç›®çš„ï¼š</p><ul><li>å°† <code>ThenCondition</code> åŒ…è£…ä¸º <code>WhenCondition</code>ä½¿å…¶æ”¯æŒè¶…æ—¶ï¼ˆå› ä¸º <code>WHEN</code> åŸç”Ÿæ”¯æŒè¶…æ—¶ï¼‰</li><li>æœ€å¤–å±‚åŒ…è£…ä¸€å±‚ <code>ThenCondition</code> å°†<code>FinallyCondition</code> æ”¾åœ¨å¤–é¢é¿å…è¶…æ—¶å½±å“ï¼ˆå› ä¸º<code>WHEN</code> ä¹Ÿä¸æ”¯æŒåç½®å¤„ç†ï¼‰</li></ul><p>æœ€ç»ˆå°†åŒ…è£…å¥½çš„ <code>ThenCondition</code> è¿”å›ä¸Šæ¸¸ä¸šåŠ¡ä½¿ç”¨</p><h2 id="å…¶ä»–">å…¶ä»–</h2><p>å¯¹äºå…¶ä»–çš„ç±»å‹ï¼Œä¼šè¢«åŒ…è£…ä¸º <code>TimeoutCondition</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†ä¸€ä¸ª Executable åŒ…è£…ä¸ºå¸¦æœ‰å•ç‹¬è¶…æ—¶æ§åˆ¶çš„ TimeoutCondition</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> executable     å¾…åŒ…è£…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxWaitSeconds æœ€å¤§ç­‰å¾…ç§’æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> åŒ…è£…åçš„ TimeoutCondition</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> TimeoutCondition <span class="title function_">wrappedByTimeout</span><span class="params">(Executable executable, Integer maxWaitSeconds)</span> &#123;</span><br><span class="line">    <span class="type">TimeoutCondition</span> <span class="variable">timeoutCondition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeoutCondition</span>();</span><br><span class="line">    timeoutCondition.addExecutable(executable);</span><br><span class="line">    timeoutCondition.setMaxWaitTime(maxWaitSeconds);</span><br><span class="line">    timeoutCondition.setMaxWaitTimeUnit(TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> timeoutCondition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TimeoutCondition</code> æœ¬è´¨ä¸Šæ˜¯ <code>WhenCondition</code>çš„å­ç±»ï¼Œä¼˜åŒ–äº†è¶…æ—¶æ—¥å¿—</p><h1 id="æ—¥å¿—å¤„ç†">æ—¥å¿—å¤„ç†</h1><p>ä¸€å¼€å§‹å†™è¿™ä¸ªæ ‡é¢˜æ˜¯å› ä¸ºæ„Ÿè§‰ <code>ThenCondition</code>çš„åŒ…è£…ä¼šå½±å“åˆ°æ—¥å¿—çš„è¾“å‡ºï¼ˆæ¯•ç«ŸåŒ…è£…äº†ä¸€ä¸ª <code>WhenCondition</code>å’Œä¸€ä¸ª <code>ThenCondition</code>ï¼‰</p><p>ä½†æ˜¯åˆçœ‹äº†ä¸€ä¸‹ä»£ç å‘ç°æ—¥å¿—æ˜¯åªæœ‰ <code>Component</code>æ‰ä¼šè¾“å‡ºçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getExecuteStepStr</span><span class="params">(<span class="type">boolean</span> withTimeSpent)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    CmpStep cmpStep;</span><br><span class="line">    <span class="keyword">for</span> (Iterator&lt;CmpStep&gt; it = executeSteps.iterator(); it.hasNext();) &#123;</span><br><span class="line">        cmpStep = it.next();</span><br><span class="line">        <span class="keyword">if</span> (withTimeSpent) &#123;</span><br><span class="line">            str.append(cmpStep.buildStringWithTime());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            str.append(cmpStep.buildString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">            str.append(<span class="string">&quot;==&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.executeStepsStr = str.toString();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.executeStepsStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æƒ³åˆ°åˆçœ‹åˆ°çš„ä¸€ä¸ª issue</p><p><ahref="https://gitee.com/dromara/liteFlow/issues/I8B0MI">å¸Œæœ›æ¡†æ¶å¯¹å¹¶è¡Œæ—¥å¿—è¿›è¡Œä¼˜åŒ–Â· Issue #I8B0MI Â· dromara/liteFlow - Gitee.com</a></p><p>è¿™é‡Œä¼šä¸ä¼šäº§ç”Ÿå½±å“ï¼Ÿ</p><h1 id="æ€»ç»“">æ€»ç»“</h1><table><colgroup><col style="width: 21%" /><col style="width: 78%" /></colgroup><thead><tr class="header"><th style="text-align: center;">ç±»å‹</th><th style="text-align: center;">æ“ä½œ</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">WhenCondition</td><td style="text-align: center;">ç›´æ¥è®¾ç½®å±æ€§</td></tr><tr class="even"><td style="text-align: center;">FinallyCondition</td><td style="text-align: center;">ä¸å…è®¸</td></tr><tr class="odd"><td style="text-align: center;">ThenCondition</td><td style="text-align: center;">å†…éƒ¨é€»è¾‘åŒ…è£…ä¸º<code>WHEN</code>ï¼Œå¤–éƒ¨åŒ…è£…ä¸€ä¸ª<code>THEN</code>ï¼Œå°†åç½®å¤„ç†å™¨ç§»è‡³å¤–éƒ¨</td></tr><tr class="even"><td style="text-align: center;">å…¶ä»–</td><td style="text-align: center;">åŒ…è£…ä¸º <code>WhenCondition</code> çš„å­ç±»<code>TimeoutCondition</code></td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°éšç€è¿­ä»£å…³é”®å­—è¶Šæ¥è¶Šå¤š</p><p>åŠŸèƒ½å’ŒåŠŸèƒ½ä¹‹é—´äº’ç›¸å½±å“ä¹Ÿè¶Šæ¥è¶Šå¤§</p><p>ä¸€ä¸ªåŠŸèƒ½çš„æ·»åŠ éœ€è¦è€ƒè™‘å¯¹ä¸åŒå·²æœ‰åŠŸèƒ½çš„å½±å“ï¼Œéœ€è¦å¯¹åº”å‡ºä¸åŒçš„å®ç°æ–¹å¼</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> LiteFlow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata æ”¹è‰¯ç‰ˆé›ªèŠ±ç®—æ³•</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Seata%20%E6%94%B9%E8%89%AF%E7%89%88%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Seata%20%E6%94%B9%E8%89%AF%E7%89%88%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95.html</url>
      
        <content type="html"><![CDATA[<h1 id="é›ªèŠ±ç®—æ³•">é›ªèŠ±ç®—æ³•</h1><p>é›ªèŠ±ç®—æ³•ï¼ˆSnowflake Algorithmï¼‰æ˜¯ä¸€ç§ç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUniqueIdentifierï¼‰çš„ç®—æ³•</p><p>å®ƒæœ€åˆç”± Twitter å¼€å‘å¹¶å¼€æºï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”Ÿæˆå…¨å±€å”¯ä¸€ ID</p><p><br></p><p>é›ªèŠ±ç®—æ³•çš„åŸç†å°±æ˜¯ç”Ÿæˆä¸€ä¸ªçš„ 64 ä½æ¯”ç‰¹ä½çš„ long ç±»å‹çš„ ID</p><ul><li>ç¬¦å·ä½ï¼ˆ1 ä½ï¼‰ï¼šå›ºå®šå›ºå®šä¸º 1ï¼Œå› ä¸º ID éƒ½ä¸ºæ­£æ•°</li><li>æ—¶é—´æˆ³ï¼ˆ41 ä½ï¼‰ï¼šæ¯«ç§’çº§åˆ«çš„æ—¶é—´æˆ³ï¼Œå¤§çº¦å¯ä»¥ä½¿ç”¨ 69å¹´ï¼ˆäº‹å®ä¸Šå¾ˆå¤šå®ç°ä¼šå‡å»ä¸€ä¸ª offsetï¼‰</li><li>æœºå™¨ç ï¼ˆ10 ä½ï¼‰ï¼šåˆ†å¸ƒå¼æœåŠ¡ IDï¼Œ2 ^ 10 = 1024 å°æœºå™¨</li><li>åºåˆ—å·ï¼ˆ12 ä½ï¼‰ï¼šåŒä¸€æ—¶é—´æˆ³ã€åŒä¸€æœºå™¨ä¸‹ï¼Œé€šè¿‡åºåˆ—å·è‡ªå¢è¿›è¡Œ IDç”Ÿæˆï¼Œå³åŒä¸€æ¯«ç§’ä¸‹å¯ä»¥ç”Ÿæˆ 2 ^ 12 = 4096 ä¸ªä¸åŒçš„ ID</li></ul><p><br></p><p>64 ä½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><span style="color: green;">0</span> - <spanstyle="color: red;">00000000000000000000000000000000000000000</span> -<span style="color: blue;">0000000000</span> - <spanstyle="color: orange;">000000000000</span></p><ul><li><span style="color: green;">ç¬¦å·ä½ï¼ˆ1 ä½ï¼‰</span></li><li><span style="color: red;">æ—¶é—´æˆ³ï¼ˆ41 ä½ï¼‰</span></li><li><span style="color: blue;">æœºå™¨ç ï¼ˆ10 ä½ï¼‰</span></li><li><span style="color: orange;">åºåˆ—å·ï¼ˆ12 ä½ï¼‰</span></li></ul><h1 id="seata-æ”¹è‰¯">Seata æ”¹è‰¯</h1><p>åœ¨è€ç‰ˆ Seataï¼ˆ1.4 ä»¥å‰ï¼‰ï¼Œå†…ç½®çš„ UUIDç”Ÿæˆå™¨çš„å®ç°åŸºäºæ ‡å‡†ç‰ˆçš„é›ªèŠ±ç®—æ³•</p><p>åœ¨åç»­çš„æ›´æ–°ä¸­ Seata å¯¹æ ‡å‡†é›ªèŠ±ç®—æ³•è¿›è¡Œäº†æ”¹è‰¯</p><h2 id="é—®é¢˜">é—®é¢˜</h2><p>Seata è®¤ä¸ºæ ‡å‡†çš„é›ªèŠ±ç®—æ³•æœ‰ä»¥ä¸‹å‡ ä¸ªç¼ºç‚¹</p><ul><li><strong>æ—¶é’Ÿæ•æ„Ÿ</strong>ï¼šå› ä¸º IDç”Ÿæˆæ€»æ˜¯å’Œå½“å‰æ“ä½œç³»ç»Ÿçš„æ—¶é—´æˆ³ç»‘å®šçš„ï¼ˆåˆ©ç”¨äº†æ—¶é—´çš„å•è°ƒé€’å¢æ€§ï¼‰ï¼Œå¦‚æœæœåŠ¡å‘ç”Ÿäº†æ—¶é’Ÿå›æ‹¨ï¼Œç”Ÿæˆçš„ID å°±ä¼šé‡å¤ï¼›å½“ç„¶ä¸€äº›å®ç°ä¼šé¿å…è¯¥é—®é¢˜ï¼Œæ–¹æ¡ˆä¸€èˆ¬æ˜¯è®°å½•ä¸Šæ¬¡ç”Ÿæˆ IDæ—¶çš„æ—¶é—´æˆ³ï¼Œå¦‚æœå‘ç°å½“å‰æ—¶é—´å°äºè®°å½•æ—¶é—´ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†æ—¶é’Ÿå›æ‹¨ï¼Œåˆ™æ‹’ç»æœåŠ¡æ„å‘³ç€å‡ºç°æ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´æœåŠ¡åœ¨ä¸€å®šæ—¶é—´å†…ä¸å¯ç”¨</li><li><strong>çªå‘æ€§èƒ½æœ‰é™</strong>ï¼šåºåˆ—å·çš„ä½é•¿åº¦ä¸º 12ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ mså¹¶å‘éƒ½å¿…é¡»ä½äº4096ï¼›ä¸€äº›å®ç°ä¼šè‡ªæ—‹ç­‰å¾…ï¼Œå½“å·®è·è¾ƒå¤§æ—¶åˆ™æŠ›å‡ºé™æµå¼‚å¸¸ç­‰æ‹’ç»æœåŠ¡</li></ul><h2 id="æ”¹è¿›">æ”¹è¿›</h2><p>æ”¹è¿›çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>è§£é™¤ä¸æ“ä½œç³»ç»Ÿæ—¶é—´æˆ³çš„æ—¶åˆ»ç»‘å®š</strong></p><p>ç”Ÿæˆå™¨åªåœ¨åˆå§‹åŒ–æ—¶è·å–äº†ç³»ç»Ÿå½“å‰çš„æ—¶é—´æˆ³ï¼Œä½œä¸ºåˆå§‹æ—¶é—´æˆ³ï¼Œä½†ä¹‹åå°±ä¸å†ä¸ç³»ç»Ÿæ—¶é—´æˆ³ä¿æŒåŒæ­¥äº†ï¼›éšå IDçš„é€’å¢ï¼Œåªé€’å¢åºåˆ—å·ï¼›å½“åºåˆ—å·æº¢å‡ºæ—¶ï¼Œè¿›ä½åˆ°æ—¶é—´æˆ³ä½ï¼ˆä½ 12ä½æ»¡ï¼‰ï¼Œåºåˆ—å·é‡æ–°å½’é›¶</p><p>ä¸ºäº†æ–¹ä¾¿è¿™ç§æº¢å‡ºè¿›ä½ï¼ŒSeata è°ƒæ•´äº† 64 ä½ ID çš„ä½åˆ†é…ç­–ç•¥</p><p><span style="color: green;">0</span> - <spanstyle="color: blue;">0000000000</span> - <spanstyle="color: red;">00000000000000000000000000000000000000000</span> -<span style="color: orange;">000000000000</span></p><ul><li><span style="color: green;">ç¬¦å·ä½ï¼ˆ1 ä½ï¼‰</span></li><li><span style="color: blue;">æœºå™¨ç ï¼ˆ10 ä½ï¼‰</span></li><li><span style="color: red;">æ—¶é—´æˆ³ï¼ˆ41 ä½ï¼‰</span></li><li><span style="color: orange;">åºåˆ—å·ï¼ˆ12 ä½ï¼‰</span></li></ul><hr /><p>è¿™æ ·æ—¶é—´æˆ³å’Œåºåˆ—å·åœ¨å†…å­˜ä¸Šæ˜¯è¿åœ¨ä¸€å—çš„ï¼Œåœ¨å®ç°ä¸Šå°±å¾ˆå®¹æ˜“ç”¨ä¸€ä¸ª<code>AtomicLong</code> æ¥åŒæ—¶è®°å½•å—æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * timestamp and sequence mix in one Long</span></span><br><span class="line"><span class="comment"> * highest 11 bit: not used</span></span><br><span class="line"><span class="comment"> * middle  41 bit: timestamp</span></span><br><span class="line"><span class="comment"> * lowest  12 bit: sequence</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> AtomicLong timestampAndSequence;</span><br></pre></td></tr></table></figure><p>é«˜ 11 ä½ï¼ˆç¬¦å·ä½ +æœºå™¨ç ï¼‰åœ¨æœåŠ¡å¯åŠ¨æ—¶å°±å·²ç»ç¡®å®šï¼ŒæœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šå˜åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * business meaning: machine ID (0 ~ 1023)</span></span><br><span class="line"><span class="comment"> * actual layout in memory:</span></span><br><span class="line"><span class="comment"> * highest 1 bit: 0</span></span><br><span class="line"><span class="comment"> * middle 10 bit: workerId</span></span><br><span class="line"><span class="comment"> * lowest 53 bit: all 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> workerId;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ç”Ÿæˆ UUID çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// è·å¾—é€’å¢åçš„æ—¶é—´æˆ³å’Œåºåˆ—å·</span></span><br><span class="line">   <span class="type">long</span> <span class="variable">next</span> <span class="operator">=</span> timestampAndSequence.incrementAndGet();</span><br><span class="line">   <span class="comment">// æˆªå–ä½53ä½</span></span><br><span class="line">   <span class="type">long</span> <span class="variable">timestampWithSequence</span> <span class="operator">=</span> next &amp; timestampAndSequenceMask;</span><br><span class="line">   <span class="comment">// è·Ÿå…ˆå‰ä¿å­˜å¥½çš„é«˜11ä½è¿›è¡Œä¸€ä¸ªæˆ–çš„ä½è¿ç®—</span></span><br><span class="line">   <span class="keyword">return</span> workerId | timestampWithSequence;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ”¶ç›Š">æ”¶ç›Š</h2><p>ç”±ä¸Šå¯ä»¥å‘ç°ï¼Œé—®é¢˜å¾—åˆ°äº†æ”¹å–„ï¼š</p><ul><li>ç”Ÿæˆå™¨ä¸å†æœ‰ 4096/msçš„çªå‘æ€§èƒ½é™åˆ¶äº†ï¼›å¦‚æœæŸä¸ªæ—¶é—´æˆ³çš„åºåˆ—å·ç©ºé—´è€—å°½ï¼Œå®ƒä¼šç›´æ¥æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æˆ³</li><li>ç”Ÿæˆå™¨å¼±ä¾èµ–äºæ“ä½œç³»ç»Ÿæ—¶é’Ÿï¼›åœ¨è¿è¡ŒæœŸé—´ï¼Œç”Ÿæˆå™¨ä¸å—æ—¶é’Ÿå›æ‹¨çš„å½±å“æ— è®ºæ˜¯äººä¸ºå›æ‹¨è¿˜æ˜¯æœºå™¨çš„æ—¶é’Ÿæ¼‚ç§»ï¼Œå› ä¸ºç”Ÿæˆå™¨ä»…åœ¨å¯åŠ¨æ—¶è·å–äº†ä¸€éç³»ç»Ÿæ—¶é’Ÿï¼Œä¹‹åä¸¤è€…ä¸å†ä¿æŒåŒæ­¥ï¼›å¯èƒ½äº§ç”Ÿé‡å¤ ID çš„åªæœ‰åœ¨é‡å¯æ—¶çš„å¤§å¹…åº¦æ—¶é’Ÿå›æ‹¨</li><li>å¯¹äºæ¨è¿›åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æˆ³çš„ â€œè¶…å‰æ¶ˆè´¹â€é—®é¢˜ï¼Œå¦‚æœç”Ÿæˆå™¨å†…çš„æ—¶é—´æˆ³å¤§å¤§è¶…å‰äºç³»ç»Ÿçš„æ—¶é—´æˆ³ï¼Œ ä»è€Œåœ¨é‡å¯æ—¶é€ æˆ IDé‡å¤ï¼Ÿå®é™…ä¸Šä¸å¯èƒ½ï¼Œè¾¾åˆ°è¿™ç§æƒ…å†µéœ€è¦ç‰¹åˆ«å¤§çš„ QPS</li></ul><h1 id="è¡¥å……">è¡¥å……</h1><h2 id="work-id-ä¼˜åŒ–">Work ID ä¼˜åŒ–</h2><p>Work ID æ˜¯åˆ†å¸ƒå¼ä¸‹çš„æœºå™¨ç ï¼ŒåŸºæœ¬è¦æ±‚æ˜¯æ¯ä¸ªå®ä¾‹æ‹¥æœ‰å”¯ä¸€çš„æ ‡è¯†</p><p>å¸¸è§çš„ç¡®å®š Work ID çš„æ–¹å¼ï¼š</p><ul><li><strong>æ‰‹åŠ¨é…ç½®</strong></li><li><strong>åŸºäºç½‘ç»œä¿¡æ¯</strong>ï¼šå› ä¸ºç½‘ç»œä¿¡æ¯ä¸€èˆ¬å¸¦æœ‰å”¯ä¸€æ€§ï¼Œä¾‹å¦‚ä½¿ç”¨IP åœ°å€ã€MAC åœ°å€ã€ä¸»æœºåç­‰ä½œä¸º Work ID çš„ä¸€éƒ¨åˆ†</li><li><strong>è‡ªåŠ¨åŒ–ç”Ÿæˆ</strong>ï¼šä½¿ç”¨ä¸€äº›å·¥å…·è¿›è¡Œç”Ÿæˆï¼Œæ¯”å¦‚ä¾èµ– ZKèŠ‚ç‚¹æ¥è¿›è¡Œå”¯ä¸€çš„ä¿è¯</li></ul><p>æ— è®ºé€‰æ‹©å“ªç§æ–¹æ³•ï¼Œéƒ½éœ€è¦ç¡®ä¿æ¯ä¸ªæœºå™¨æˆ–èŠ‚ç‚¹çš„ Work IDæ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¿æŒç¨³å®šï¼›è¿™æ ·å¯ä»¥é¿å…ç”Ÿæˆé‡å¤çš„IDï¼Œç¡®ä¿æ•´ä¸ªç³»ç»Ÿçš„æ­£ç¡®è¿è¡Œ</p><p>Seata åŸºäºç½‘ç»œä¿¡æ¯è¿›è¡Œ Work ID çš„ç¡®å®šï¼Œæˆªå–æœ¬åœ° IPv4 åœ°å€çš„ä½ 10ä½ä½œä¸º Work IDï¼Œå¾ˆæ˜æ˜¾è¿™æ ·ä¼šé€ æˆ Work ID é‡å¤ï¼Œä¾‹å¦‚å¦‚ä¸‹ IP</p><ul><li>192.168.4.10</li><li>192.168.8.10</li></ul><p>ä¼˜åŒ–åå°†ä¼˜å…ˆä½¿ç”¨ç½‘å¡ MAC åœ°å€æˆªå–ï¼Œè‹¥æœ¬æœºæœªé…ç½®æœ‰æ•ˆçš„ç½‘å¡ï¼Œåˆ™åœ¨<code>[0, 1023]</code> ä¸­éšæœºæŒ‘ä¸€ä¸ªä½œä¸ºIDï¼ˆå…¶å®åº”è¯¥ä¾ç„¶å­˜åœ¨é‡å¤é—®é¢˜ï¼Œåªæ˜¯å‡å°‘äº†æ¦‚ç‡ï¼›æ„Ÿè§‰è¿˜æ˜¯ç¾å›¢çš„ leaf ç­‰ä½¿ç”¨ZK æ–¹å¼æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯ä¼šå¼•å…¥æ–°ä¸­é—´ä»¶ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ï¼‰</p><h2 id="å•è°ƒé€’å¢å’Œé¡µåˆ†è£‚">å•è°ƒé€’å¢å’Œé¡µåˆ†è£‚</h2><p>Seata æ”¹è‰¯åçš„é›ªèŠ±ç®—æ³•æ˜¯å¦æ˜¯å•è°ƒé€’å¢çš„ï¼Ÿ</p><p>åœ¨æ ‡å‡†é›ªèŠ±ç®—æ³•ä¸­ï¼Œæ—¶é—´æˆ³æ’åœ¨æœºå™¨ç ä¹‹å‰ï¼Œå³å¤šèŠ‚ç‚¹æœåŠ¡ï¼Œä¾ç„¶å¯ä»¥ä¿è¯ä¸€å®šç¨‹åº¦ä¸Šæœ‰åºï¼ˆåŒä¸€ms å†…ç”Ÿæˆçš„ ID å¯èƒ½æ— åºï¼Œä¸åŒ ms ä¹‹é—´å•è°ƒé€’å¢ï¼‰</p><p>åœ¨ Seataæ”¹è‰¯åçš„é›ªèŠ±ç®—æ³•ä¸­ï¼Œæœºå™¨ç åœ¨æ—¶é—´æˆ³ä¹‹å‰ï¼Œè¿›ä¸€æ­¥åŠ å¤§äº†è¿™ç§æ— åºæ€§</p><p><br></p><p>é‚£ä¹ˆè¿™ç§æ— åºæ€§æ˜¯å¦ä¼šé€ æˆé¡µåˆ†è£‚ï¼Ÿ</p><p>æŒ‰ç…§ Seataçš„è§£é‡Šæ˜¯çŸ­æ—¶æœŸå†…ä¼šé€ æˆï¼Œä½†åœ¨æœ‰é™æ¬¡åˆ†è£‚åï¼Œä¸ä¼šè¿›è¡Œæ–°çš„é¡µåˆ†è£‚ï¼Œå› ä¸º WorkID æ˜¯æœ‰é™çš„ï¼Œæœ€ç»ˆä¸€å®šä¼šå‡ºç°èƒ½å®¹çº³å›ºå®š Work ID çš„é¡µ</p><blockquote><p>åˆ°è¾¾ç»ˆæ€åï¼Œåç»­çš„IDåªä¼šåœ¨è¯¥IDæ‰€å±çš„å­åºåˆ—ä¸Šè¿›è¡Œé¡ºåºå¢é•¿ï¼Œè€Œä¸ä¼šé€ æˆé¡µåˆ†è£‚</p><p>è¯¥çŠ¶æ€ä¸‹çš„é¡ºåºå¢é•¿ä¸ auto_increment çš„é¡ºåºå¢é•¿çš„åŒºåˆ«æ˜¯ï¼Œå‰è€…æœ‰ 1024ä¸ªå¢é•¿ä½ç‚¹ï¼ˆå„ä¸ªå­åºåˆ—çš„å°¾éƒ¨ï¼‰ï¼Œåè€…åªæœ‰å°¾éƒ¨ä¸€ä¸ª</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥å›ç­”å¼€å¤´æ‰€æå‡ºçš„é—®é¢˜äº†ï¼šæ–°ç®—æ³•ä»å…¨å±€æ¥çœ‹çš„ç¡®ä¸æ˜¯å…¨å±€é€’å¢çš„ï¼Œä½†è¯¥ç®—æ³•æ˜¯<strong>æ”¶æ•›</strong>çš„ï¼Œè¾¾åˆ°ç¨³æ€åï¼Œæ–°ç®—æ³•åŒæ ·èƒ½è¾¾æˆåƒå…¨å±€é¡ºåºé€’å¢ä¸€æ ·çš„æ•ˆæœ</p></blockquote><h2 id="ç†è®ºä¸Šä¾ç„¶å­˜åœ¨çš„é—®é¢˜">ç†è®ºä¸Šä¾ç„¶å­˜åœ¨çš„é—®é¢˜</h2><p>è™½ç„¶ Seata ä¸€è‡´åœ¨è®ºè¯æ”¹è¿›å IDç”Ÿæˆæ–¹å¼çš„ä¼˜åŠ¿ï¼Œä½†æˆ‘è§‰å¾—ä»ç†è®ºä¸Šæ¥çœ‹ä¾ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼ˆè™½ç„¶å¾ˆå¤šé—®é¢˜ä»åº”ç”¨å±‚é¢è€ƒè™‘è®¤ä¸ºæ— æ³•å‡ºç°ï¼Œä½†å¹¶ä¸æ˜¯ä»ç†è®ºå±‚é¢è§£å†³ï¼‰</p><ul><li><strong>æ—¶é’Ÿå›æ‹¨åé‡å¯æœåŠ¡</strong>ï¼šè™½ç„¶ IDç”Ÿæˆè¿‡ç¨‹ä¸­ä¸ä¾èµ–æ—¶é—´æˆ³ï¼Œä½†å¦‚æœå›æ‹¨æ—¶é—´å¤ªé•¿ã€éƒ¨ç½²æ—¶é—´çŸ­ä¾ç„¶ä¼šå¯¼è‡´ IDé‡å¤çš„é—®é¢˜<ul><li>åº”ç”¨å±‚é¢ï¼šä¸ä¼šæœ‰å¤ªé•¿æ—¶é—´å›æ‹¨ï¼ŒæœåŠ¡éƒ¨ç½²éœ€è¦ä¸€å®šæ—¶é—´</li></ul></li><li><strong>è¶…å‰æ¶ˆè´¹</strong>ï¼šè™½ç„¶ QPS =400w/sï¼Œä½†ç†è®ºä¸Šä»ç„¶å­˜åœ¨è¶…å‰æ¶ˆè´¹ï¼Œé‡æ–°éƒ¨ç½²å ID é‡å¤é—®é¢˜<ul><li>åº”ç”¨å±‚é¢ï¼šå¯¹ QPS çš„è¦æ±‚åŸºæœ¬ä¸å¯èƒ½è¾¾åˆ°</li></ul></li><li><strong>Work ID é‡å¤</strong>ï¼šä¸Šè¿° Work IDç”Ÿæˆæ“ä½œä¾ç„¶ä¼šå­˜åœ¨é‡å¤é—®é¢˜ï¼Œåªä¸è¿‡æ¦‚ç‡è¾ƒå°</li><li><strong>é¡µåˆå¹¶å¯¼è‡´çš„é¡µåˆ†è£‚æ— æ³•æ”¶æ•›</strong>ï¼šè¯¦æƒ…è§ <ahref="http://seata.io/zh-cn/blog/seata-snowflake-explain">å…³äºæ–°ç‰ˆé›ªèŠ±ç®—æ³•çš„ç­”ç–‘| Seata</a></li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="http://seata.io/zh-cn/blog/seata-analysis-UUID-generator/">SeataåŸºäºæ”¹è‰¯ç‰ˆé›ªèŠ±ç®—æ³•çš„åˆ†å¸ƒå¼UUIDç”Ÿæˆå™¨åˆ†æ| Seata</a></p><p><ahref="http://seata.io/zh-cn/blog/seata-snowflake-explain">å…³äºæ–°ç‰ˆé›ªèŠ±ç®—æ³•çš„ç­”ç–‘| Seata</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ OpenAI API è¿›è¡Œ Prompt å·¥ç¨‹çš„æœ€ä½³å®è·µ</title>
      <link href="/%E5%BC%80%E5%8F%91/AI/%E4%BD%BF%E7%94%A8%20OpenAI%20API%20%E8%BF%9B%E8%A1%8C%20Prompt%20%E5%B7%A5%E7%A8%8B%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"/>
      <url>/%E5%BC%80%E5%8F%91/AI/%E4%BD%BF%E7%94%A8%20OpenAI%20API%20%E8%BF%9B%E8%A1%8C%20Prompt%20%E5%B7%A5%E7%A8%8B%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html</url>
      
        <content type="html"><![CDATA[<h1 id="prompt-å·¥ç¨‹çš„å·¥ä½œåŸç†">Prompt å·¥ç¨‹çš„å·¥ä½œåŸç†</h1><p>ç”±äºæŒ‡å¯¼éµå¾ªæ¨¡å‹çš„è®­ç»ƒæ–¹å¼æˆ–è®­ç»ƒæ•°æ®ï¼Œæœ‰ä¸€äº›ç‰¹å®šçš„æç¤ºæ ¼å¼æ•ˆæœç‰¹åˆ«å¥½ï¼Œä¸æ‰‹å¤´çš„ä»»åŠ¡æ›´ä¸ºä¸€è‡´</p><p>ä¸‹é¢æˆ‘ä»¬ä»‹ç»äº†ä¸€äº›æç¤ºæ ¼å¼ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™äº›æ ¼å¼è¿è¡Œå¯é ï¼Œä½†å¯ä»¥éšæ„æ¢ç´¢ä¸åŒçš„æ ¼å¼ï¼Œè¿™äº›æ ¼å¼å¯èƒ½æœ€é€‚åˆæ‚¨çš„ä»»åŠ¡</p><h1 id="ç»éªŒæ³•åˆ™å’Œç¤ºä¾‹">ç»éªŒæ³•åˆ™å’Œç¤ºä¾‹</h1><p><strong>æ³¨æ„ï¼š</strong> <code>&#123;text input here&#125;</code> æ˜¯å®é™…æ–‡æœ¬ /ä¸Šä¸‹æ–‡çš„å ä½ç¬¦</p><h2 id="ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬">ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬</h2><p>ä¸ºäº†æœ€å¥½çš„ç»“æœï¼Œæˆ‘ä»¬é€šå¸¸å»ºè®®ä½¿ç”¨æœ€æ–°ã€åŠŸèƒ½æœ€å¼ºçš„æ¨¡å‹</p><p>æˆªè‡³ 2022 å¹´ 11 æœˆï¼Œæœ€ä½³é€‰æ‹©æ˜¯ç”¨äºæ–‡æœ¬ç”Ÿæˆçš„<code>text-davinci-003</code> æ¨¡å‹å’Œç”¨äºä»£ç ç”Ÿæˆçš„<code>code-davinci-002</code> æ¨¡å‹</p><h2 id="æç¤ºæ”¾åœ¨å¼€å¤´å¹¶ä¸”ä½¿ç”¨-æˆ–è€…-åˆ†éš”æç¤ºå’Œå†…å®¹">æç¤ºæ”¾åœ¨å¼€å¤´å¹¶ä¸”ä½¿ç”¨### æˆ–è€… """ åˆ†éš”æç¤ºå’Œå†…å®¹</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Summarize the text below as a bullet point list of the most important points.</span><br><span class="line"></span><br><span class="line">&#123;text input here&#125;</span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Summarize the text below as a bullet point list of the most important points.</span><br><span class="line"></span><br><span class="line">Text: &quot;&quot;&quot;</span><br><span class="line">&#123;text input here&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure><h2id="å¯¹æ‰€éœ€çš„ä¸Šä¸‹æ–‡ç»“æœé•¿åº¦æ ¼å¼é£æ ¼ç­‰è¿›è¡Œå…·ä½“å’Œå°½å¯èƒ½è¯¦ç»†çš„æè¿°">å¯¹æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€ç»“æœã€é•¿åº¦ã€æ ¼å¼ã€é£æ ¼ç­‰è¿›è¡Œå…·ä½“å’Œå°½å¯èƒ½è¯¦ç»†çš„æè¿°</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Write a poem about OpenAI. </span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Write a short inspiring poem about OpenAI, focusing on the recent DALL-E product launch (DALL-E is a text to image ML model) in the style of a &#123;famous poet&#125;</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡ç¤ºä¾‹é˜æ˜æ‰€éœ€çš„è¾“å‡ºæ ¼å¼">é€šè¿‡ç¤ºä¾‹é˜æ˜æ‰€éœ€çš„è¾“å‡ºæ ¼å¼</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Extract the entities mentioned in the text below. Extract the following 4 entity types: company names, people names, specific topics and themes.</span><br><span class="line"></span><br><span class="line">Text: &#123;text&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºå’Œå‘ŠçŸ¥ï¼Œå½“æ˜¾ç¤ºç‰¹å®šçš„æ ¼å¼è¦æ±‚æ—¶ï¼Œæ¨¡å‹çš„å“åº”ä¼šæ›´å¥½</p><p>è¿™ä¹Ÿä½¿å¾—ä»¥ç¼–ç¨‹æ–¹å¼å¯é åœ°è§£æå¤šä¸ªè¾“å‡ºå˜å¾—æ›´åŠ å®¹æ˜“</p><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Extract the important entities mentioned in the text below. First extract all company names, then extract all people names, then extract specific topics which fit the content and finally extract general overarching themes</span><br><span class="line"></span><br><span class="line">Desired format:</span><br><span class="line">Company names: &lt;comma_separated_list_of_company_names&gt;</span><br><span class="line">People names: -||-</span><br><span class="line">Specific topics: -||-</span><br><span class="line">General themes: -||-</span><br><span class="line"></span><br><span class="line">Text: &#123;text&#125;</span><br></pre></td></tr></table></figure><h2id="ä»é›¶æ ·æœ¬å¼€å§‹ç„¶åæ˜¯å°‘é‡æ ·æœ¬å®ƒä»¬éƒ½ä¸èµ·ä½œç”¨åˆ™å¾®è°ƒ">ä»é›¶æ ·æœ¬å¼€å§‹ï¼Œç„¶åæ˜¯å°‘é‡æ ·æœ¬ï¼Œå®ƒä»¬éƒ½ä¸èµ·ä½œç”¨åˆ™å¾®è°ƒ</h2><p><strong>é›¶æ ·æœ¬ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Extract keywords from the below text.</span><br><span class="line"></span><br><span class="line">Text: &#123;text&#125;</span><br><span class="line"></span><br><span class="line">Keywords:</span><br></pre></td></tr></table></figure><p><strong>å°‘é‡æ ·æœ¬ - ä¸¾å‡ ä¸ªä¾‹å­</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Extract keywords from the corresponding texts below.</span><br><span class="line"></span><br><span class="line">Text 1: Stripe provides APIs that web developers can use to integrate payment processing into their websites and mobile applications.</span><br><span class="line">Keywords 1: Stripe, payment processing, APIs, web developers, websites, mobile applications</span><br><span class="line">##</span><br><span class="line">Text 2: OpenAI has trained cutting-edge language models that are very good at understanding and generating text. Our API provides access to these models and can be used to solve virtually any task that involves processing language.</span><br><span class="line">Keywords 2: OpenAI, language models, text processing, API.</span><br><span class="line">##</span><br><span class="line">Text 3: &#123;text&#125;</span><br><span class="line">Keywords 3:</span><br></pre></td></tr></table></figure><p><strong>å¾®è°ƒï¼šè¯·å‚é˜…æ­¤å¤„çš„å¾®è°ƒæœ€ä½³å®è·µ <ahref="https://docs.google.com/document/d/1h-GTjNDDKPKU_Rsd0t1lXCAnHltaXTAzQ8K2HRhQf9U/edit#">here</a></strong></p><h2 id="å‡å°‘æ¨¡ç³Šä¸å‡†ç¡®çš„æè¿°">å‡å°‘æ¨¡ç³Šã€ä¸å‡†ç¡®çš„æè¿°</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The description for this product should be fairly short, a few sentences only, and not too much more.</span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Use a 3 to 5 sentence paragraph to describe this product.</span><br></pre></td></tr></table></figure><h2id="ä¸å…¶è¯´ä¸è¯¥åšä»€ä¹ˆä¸å¦‚è¯´è¯¥åšä»€ä¹ˆ">ä¸å…¶è¯´ä¸è¯¥åšä»€ä¹ˆä¸å¦‚è¯´è¯¥åšä»€ä¹ˆ</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following is a conversation between an Agent and a Customer. DO NOT ASK USERNAME OR PASSWORD. DO NOT REPEAT.</span><br><span class="line"></span><br><span class="line">Customer: I canâ€™t log in to my account.</span><br><span class="line">Agent:</span><br></pre></td></tr></table></figure><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following is a conversation between an Agent and a Customer. The agent will attempt to diagnose the problem and suggest a solution, whilst refraining from asking any questions related to PII. Instead of asking for PII, such as username or password, refer the user to the help article www.samplewebsite.com/help/faq</span><br><span class="line"></span><br><span class="line">Customer: I canâ€™t log in to my account.</span><br><span class="line">Agent:</span><br></pre></td></tr></table></figure><h2 id="ä»£ç ç”Ÿæˆç‰¹æœ‰---ä½¿ç”¨å¼•å¯¼è¯å¼•å¯¼æ¨¡å‹">ä»£ç ç”Ÿæˆç‰¹æœ‰ -ä½¿ç”¨å¼•å¯¼è¯å¼•å¯¼æ¨¡å‹</h2><p><strong>æ•ˆæœè¾ƒå·®ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Write a simple python function that</span><br><span class="line"># 1. Ask me for a number in mile</span><br><span class="line"># 2. It converts miles to kilometers</span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹æ–¹çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæ·»åŠ  "import" å¯¹æ¨¡å‹è¿›è¡Œæç¤ºï¼Œå®ƒåº”è¯¥ä½¿ç”¨ Pythonè¿›è¡Œç¼–å†™ï¼ˆç±»ä¼¼åœ°ï¼Œ"SELECT" æ˜¯ä¸€ä¸ªé’ˆå¯¹ SQL è¯­å¥å¥½çš„æç¤ºï¼‰</p><p><strong>æ”¹è¿›ï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Write a simple python function that</span><br><span class="line"># 1. Ask me for a number in mile</span><br><span class="line"># 2. It converts miles to kilometers</span><br><span class="line"> </span><br><span class="line">import</span><br></pre></td></tr></table></figure><h1 id="å‚æ•°">å‚æ•°</h1><p>é€šå¸¸ï¼Œæˆ‘ä»¬å‘ç° <code>model</code> å’Œ <code>temperature</code>æ˜¯æ”¹å˜æ¨¡å‹è¾“å‡ºæœ€å¸¸ç”¨çš„å‚æ•°</p><ul><li><code>model</code> - æ›´é«˜æ€§èƒ½çš„æ¨¡å‹æˆæœ¬æ›´é«˜ï¼Œå»¶è¿Ÿä¹Ÿæ›´é«˜</li><li><code>temperature</code> - è¡¡é‡æ¨¡å‹è¾“å‡ºä¸å¤ªå¯èƒ½çš„ tokensçš„æŒ‡æ ‡ï¼›æ¸©åº¦è¶Šé«˜ï¼Œè¾“å‡ºå°±è¶Šéšæœºï¼ˆé€šå¸¸æ˜¯åˆ›é€ æ€§çš„ï¼‰ï¼›ç„¶è€Œè¿™å¹¶ä¸ç­‰åŒäºâ€œçœŸå®æ€§â€ï¼›å¯¹äºå¤§å¤šæ•°å®é™…ç”¨ä¾‹ï¼Œå¦‚æ•°æ®æå–å’ŒçœŸå®é—®ç­”ï¼Œ0çš„å‚æ•°æ˜¯æœ€å¥½çš„</li><li><code>max_tokens</code> - ä¸èƒ½æ§åˆ¶è¾“å‡ºçš„é•¿åº¦ï¼Œæ˜¯ä¸€ä¸ªé’ˆå¯¹ tokenç”Ÿæˆçš„ç¡¬æˆªæ­¢é™åˆ¶ï¼›ç†æƒ³æƒ…å†µä¸‹ä½ ä¸ä¼šç»å¸¸è¾¾åˆ°è¿™ä¸ªæé™ï¼Œå› ä¸ºå½“ä½ çš„æ¨¡å‹è®¤ä¸ºå®ƒå·²ç»å®Œæˆæ—¶ï¼Œæˆ–è€…å½“å®ƒè¾¾åˆ°ä½ å®šä¹‰çš„åœæ­¢åºåˆ—æ—¶ï¼Œå®ƒå°±ä¼šåœæ­¢</li><li><code>stop</code> - ä¸€ç»„å­—ç¬¦ï¼ˆæ ‡è®°ï¼‰ï¼Œç”Ÿæˆåå°†å¯¼è‡´æ–‡æœ¬ç”Ÿæˆåœæ­¢</li></ul><p>æ›´å¤šçš„å‚æ•°æè¿°å‚è€ƒ <ahref="https://beta.openai.com/docs/api-reference/completions/create">APIreference</a></p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://help.openai.com/en/articles/6654000-best-practices-for-prompt-engineering-with-openai-api">Bestpractices for prompt engineering with OpenAI API | OpenAI HelpCenter</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> Prompt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Guava EventBus</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Guava%20EventBus.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Guava%20EventBus.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»">ä»‹ç»</h1><p>EventBuså…è®¸ç»„ä»¶ä¹‹é—´é€šè¿‡å‘å¸ƒè®¢é˜…æ–¹å¼è¿›è¡Œäº¤äº’ï¼Œè€Œä¸éœ€è¦ç»„ä»¶ä¹‹é—´è¿›è¡Œæ˜¾å¼çš„æ³¨å†Œï¼ˆä¹Ÿæ„å‘³ç€äº’ç›¸äº†è§£å…¶å­˜åœ¨ï¼‰</p><p>å®ƒè¢«è®¾è®¡ä¸“é—¨ç”¨äºä½¿ç”¨æ˜¾å¼æ³¨å†Œæ¥æ›¿ä»£ä¼ ç»Ÿçš„ Java è¿›ç¨‹å†…äº‹ä»¶åˆ†å‘</p><p>å®ƒä¸æ˜¯é€šç”¨çš„å‘å¸ƒè®¢é˜…ç³»ç»Ÿï¼Œä¹Ÿä¸æ˜¯ç”¨äºè¿›ç¨‹é—´é€šä¿¡çš„ç³»ç»Ÿ</p><h1 id="æ–‡æ¡£">æ–‡æ¡£</h1><p>æ‘˜è‡ª Github Guava Document <ahref="https://github.com/google/guava/wiki/EventBusExplained">EventBusExplainedÂ· google/guava Wiki Â· GitHub</a></p><h2 id="ç¤ºä¾‹">ç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰å‡ºç±»å’Œè®¢é˜…çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventBusChangeRecorder</span> &#123;</span><br><span class="line">  <span class="meta">@Subscribe</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordCustomerChange</span><span class="params">(ChangeEvent e)</span> &#123;</span><br><span class="line">    recordChange(e.getChange());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ä»»æ„åœ°æ–¹è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">eventBus.register(<span class="keyword">new</span> <span class="title class_">EventBusChangeRecorder</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹‹åè¿›è¡Œæ¶ˆæ¯çš„å‘é€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeCustomer</span><span class="params">()</span></span><br><span class="line">  <span class="type">ChangeEvent</span> <span class="variable">event</span> <span class="operator">=</span> getChangeEvent();</span><br><span class="line">  eventBus.post(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸€åˆ†é’ŸæŒ‡å—">ä¸€åˆ†é’ŸæŒ‡å—</h2><p>è½¬æ¢ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ä»¥äº‹ä»¶è®¢é˜…ä¸ºåŸºç¡€çš„ç³»ç»Ÿæ¥ä½¿ç”¨ EventBus æ˜¯å®¹æ˜“çš„</p><h3 id="è®¢é˜…è€…for-listeners">è®¢é˜…è€…ï¼ˆFor Listenersï¼‰</h3><p>è®¢é˜…ç‰¹å®šç±»å‹çš„äº‹ä»¶ï¼ˆä¾‹å¦‚ <code>CustomerChangeEvent</code>ï¼‰</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šå®ç°ä¸€ä¸ªå’Œäº‹ä»¶ç›¸å…³çš„æ¥å£ï¼Œä¾‹å¦‚<code>CustomerChangeEventListener</code></li><li>EventBusï¼šåˆ›å»ºä¸€ä¸ªæ–¹æ³•ï¼Œ<code>CustomerChangeEvent</code>ä½œä¸ºè¿™ä¸ªæ–¹æ³•å”¯ä¸€çš„å‚æ•°ï¼Œç„¶ååœ¨æ–¹æ³•ä¸Šæ ‡è®° <code>@Subscribe</code>æ³¨è§£</li></ul><p>å‘äº‹ä»¶ç”Ÿäº§è€…æ³¨å†Œä½ çš„è®¢é˜…è€…æ–¹æ³•</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šå°†å¯¹è±¡ä¼ é€’ç»™æ¯ä¸ªç”Ÿäº§è€…çš„<code>registerCustomerChangeEventListener</code>æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¾ˆå°‘åœ¨å…¬å…±æ¥å£ä¸­å®šä¹‰ï¼Œå› æ­¤é™¤äº†äº†è§£æ¯ä¸ªå¯èƒ½çš„ç”Ÿäº§è€…ï¼Œè¿˜å¿…é¡»äº†è§£å…¶ç±»å‹</li><li>EventBusï¼šå°†æ–¹æ³•æ‰€åœ¨å¯¹è±¡é€šè¿‡ <code>EventBus.register(Object)</code>æ–¹æ³•æ³¨å†Œåœ¨ä¸€ä¸ª <code>EventBus</code> å¯¹è±¡ä¸Šï¼Œéœ€è¦ç¡®ä¿æ¶ˆæ¯ç”Ÿäº§è€…ä½¿ç”¨çš„<code>EventBus</code> å®ä¾‹å’Œè¿›è¡Œæ–¹æ³•æ³¨å†Œçš„æ˜¯åŒä¸€ä¸ª</li></ul><p>è®¢é˜…ä¸€ä¸ªæ™®é€šäº‹ä»¶çš„è¶…ç±»ï¼ˆsupertypeï¼›ä¾‹å¦‚ <code>EventObject</code> æˆ–è€…<code>Object</code>ï¼‰</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šä¸å®¹æ˜“å®ç°</li><li>EventBusï¼šäº‹ä»¶ä¼šè‡ªåŠ¨åˆ†é…ç»™è¶…ç±»çš„è®¢é˜…è€…ï¼Œå…è®¸é’ˆå¯¹æ¥å£ï¼ˆInterfaceï¼‰çš„è®¢é˜…è€…æˆ–è€…é’ˆå¯¹<code>Object</code> çš„ â€œé€šé…ç¬¦è®¢é˜…è€…â€</li></ul><p>è¦è®¢é˜…æˆ–æ£€æµ‹åœ¨æ²¡æœ‰åˆé€‚äº‹ä»¶è®¢é˜…è€…å­˜åœ¨çš„äº‹ä»¶</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šåœ¨æ¯ä¸ªäº‹ä»¶è°ƒåº¦æ–¹æ³•ä¸Šæ·»åŠ ä»£ç ï¼ˆå¯èƒ½ä½¿ç”¨ AOPï¼‰</li><li>EventBusï¼šè®¢é˜… <code>DeadEvent</code>ï¼Œéšå <code>EventBus</code>å°†ä¼šé€šçŸ¥ä½ ä»»ä½•å·²ç»å·²ç»ç”Ÿäº§ä½†æ˜¯æ²¡æœ‰æ¶ˆè´¹äº¤ä»˜çš„äº‹ä»¶ï¼ˆä¾¿ä¸è°ƒè¯•ï¼‰</li></ul><h3 id="ç”Ÿäº§è€…for-producers">ç”Ÿäº§è€…ï¼ˆFor Producersï¼‰</h3><p>è·Ÿè¸ªè®¢é˜…è€…å¤„ç†äº‹ä»¶</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šå†™ä»£ç ç®¡ç†è®¢é˜…è€…åˆ—è¡¨ï¼ŒåŒ…æ‹¬åŒæ­¥ï¼Œæˆ–è€…ä½¿ç”¨å…¬å…±ç±»ä¾‹å¦‚<code>EventListenerList</code></li><li>EventBusï¼š<code>EventBus</code> å·²ç»ä¸ºä½ å®ç°äº†</li></ul><p>æ´¾å‘äº‹ä»¶ç»™è®¢é˜…è€…</p><ul><li>ä¼ ç»Ÿçš„æ–¹å¼ï¼šæ˜¾å¼å®ç°ä¸€ä¸ªå‘å„ä¸ªäº‹ä»¶è®¢é˜…è€…åˆ†é…äº‹ä»¶çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬é”™è¯¯éš”ç¦»å’Œå¼‚æ­¥ï¼ˆå¦‚æœå¸Œæœ›å¦‚æ­¤ï¼‰</li><li>EventBusï¼šä¼ é€’æ¶ˆæ¯å¯¹è±¡ç»™ä¸€ä¸ª <code>EventBus</code> å®ä¾‹çš„<code>EventBus.post(Object)</code> æ–¹æ³•</li></ul><h2 id="æœ¯è¯­">æœ¯è¯­</h2><p>EventBus ç³»ç»Ÿå’Œä»£ç ä½¿ç”¨ä»¥ä¸‹æœ¯è¯­æ¥è®¨è®ºäº‹ä»¶åˆ†å‘</p><table><colgroup><col style="width: 21%" /><col style="width: 78%" /></colgroup><thead><tr class="header"><th style="text-align: center;">æœ¯è¯­</th><th style="text-align: center;">æè¿°</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Event</td><td style="text-align: center;">ä»»ä½•å¯èƒ½ä¼šè¢«ä¼ é€’ç»™ä¸€ä¸ªæ€»çº¿çš„å¯¹è±¡</td></tr><tr class="even"><td style="text-align: center;">Subcribing</td><td style="text-align: center;">æ³¨å†Œä¸€ä¸ª listener ç»™<code>EventBus</code> çš„è¡Œä¸ºï¼Œä»¥ä¾¿å…¶å¤„ç†æ–¹æ³•å°†ä¼šæ¥æ”¶äº‹ä»¶</td></tr><tr class="odd"><td style="text-align: center;">Listener</td><tdstyle="text-align: center;">ä¸€ä¸ªå¸Œæœ›æ¥æ”¶äº‹ä»¶çš„å¯¹è±¡ï¼Œæš´éœ²å¤„ç†æ–¹æ³•ï¼ˆhandlermethodï¼‰</td></tr><tr class="even"><td style="text-align: center;">Handler method</td><td style="text-align: center;">ä¸€ä¸ª public æ–¹æ³•ï¼Œ<code>EventBus</code>å¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•å¤„ç†äº‹ä»¶ï¼›ä½¿ç”¨ <code>@Subcribe</code> æ³¨è§£è¿›è¡Œæ ‡è®°</td></tr><tr class="odd"><td style="text-align: center;">Posting an event</td><td style="text-align: center;">ç¡®ä¿äº‹ä»¶é€šè¿‡ <code>EventBus</code>è¢«ä»»æ„è®¢é˜…è€…æ¥æ”¶</td></tr></tbody></table><h2 id="faq">FAQ</h2><p><strong>ä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åˆ›å»ºè‡ªå·±çš„ <code>EventBus</code>è€Œä¸æ˜¯ä½¿ç”¨å•ä¾‹</strong></p><p><code>EventBus</code>å¹¶æ²¡æœ‰æ˜ç¡®æŒ‡å‡ºä½ å¦‚ä½•ä½¿ç”¨å®ƒï¼›å¯¹äºé’ˆå¯¹æ¯ä¸ªç»„ä»¶çš„äº‹ä»¶æ€»çº¿å¹¶æ²¡æœ‰ç¦æ­¢ä½¿ç”¨å„è‡ªç‹¬ç«‹çš„å®ä¾‹ï¼Œä¹Ÿæ²¡æœ‰ç¦æ­¢é’ˆå¯¹ä¸åŒä¸Šä¸‹æ–‡ã€ä¸»é¢˜çš„æ—¶é—´ä½¿ç”¨ç‹¬ç«‹çš„å®ä¾‹ï¼›å¦‚æœè¿›è¡Œæ‹†åˆ†ï¼Œä¼šä½¿å¾—åœ¨æµ‹è¯•ä¸­åˆ›å»ºã€åˆ é™¤<code>EventBus</code> å¯¹è±¡æ›´åŠ å®¹æ˜“ã€</p><p>å½“ç„¶ï¼Œå¦‚æœä½ æƒ³æœ‰ä¸€ä¸ªå¤§è€Œå…¨é€»è¾‘çš„ <code>EventBus</code>å•ä¾‹ï¼Œå¹¶ä¸ä¼šé˜»æ­¢ä½ è¿™æ ·åšï¼Œåªéœ€è®©æ‚¨çš„å®¹å™¨ï¼ˆä¾‹å¦‚ Guiceï¼‰åœ¨å…¨å±€èŒƒå›´å†…å°†<code>EventBus</code>åˆ›å»ºä¸ºä¸€ä¸ªå•ä¾‹ï¼ˆæˆ–è€…å°†å…¶å­˜å‚¨ä¸ºä¸€ä¸ªé™æ€å˜é‡ï¼Œå¦‚æœæƒ³è¿™æ ·åšçš„è¯ï¼‰</p><p>æ€»è€Œè¨€ä¹‹ï¼Œ<code>EventBus</code>ä¸æ˜¯ä¸€ä¸ªå•ä¾‹æ˜¯å› ä¸ºæˆ‘ä»¬ä¸æƒ³åšå‡ºè¿™ç§å†³å®šï¼Œä½ å¯ä»¥æ ¹æ®å–œå¥½å†³å®šå¦‚ä½•ä½¿ç”¨</p><p><strong>æˆ‘å¯ä»¥å‘ <code>EventBus</code>å–æ¶ˆæ³¨å†ŒæŸä¸ªè®¢é˜…è€…å—</strong></p><p>å¯ä»¥ï¼Œä½¿ç”¨<code>EventBus.unregister</code>ï¼›åªä¸è¿‡æˆ‘ä»¬å‘ç°è¿™ç§éœ€æ±‚å¾ˆå°‘è§ï¼š</p><ul><li>å¤§éƒ¨åˆ†è®¢é˜…è€…éƒ½åœ¨å¯åŠ¨æ—¶è¿›è¡Œæ³¨å†Œæˆ–è€…æ‡’åŠ è½½ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­æŒç»­å­˜åœ¨</li><li>ç‰¹æ®ŠèŒƒå›´ï¼ˆscope-specificï¼‰çš„ <code>EventBus</code>å®ä¾‹å¯ä»¥å¤„ç†ä¸´æ—¶çš„äº‹ä»¶åˆ†å‘ï¼ˆä¾‹å¦‚åœ¨è¯·æ±‚èŒƒå›´çš„å¯¹è±¡ä¹‹é—´åˆ†å‘äº‹ä»¶ï¼‰</li><li>å¯¹äºæµ‹è¯•ï¼Œ<code>EventBus</code>å®ä¾‹å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ›å»ºæˆ–ä¸¢å¼ƒï¼Œä»è€Œæ— éœ€æ˜¾å¼æ³¨é”€</li></ul><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨æ³¨è§£æ¥æ ‡è®°è®¢é˜…æ–¹æ³•ï¼Œè€Œä¸æ˜¯è®¢é˜…è€…å®ç°æ¥å£</strong></p><p>æˆ‘ä»¬è®¤ä¸º <code>@Subscribe</code>æ³¨è§£å¯ä»¥ä¼ è¾¾çœŸå®çš„æ„å›¾ï¼Œå°±åƒå®ç°æ¥å£ä¸€æ ·æ˜ç¡®ï¼ˆæˆ–è€…æ›´æ˜ç¡®ï¼‰ï¼ŒåŒæ—¶è®©æ‚¨å¯ä»¥è‡ªç”±åœ°å°†äº‹ä»¶è®¢é˜…è€…æ–¹æ³•æ”¾ç½®åœ¨ä»»ä½•æ‚¨å¸Œæœ›çš„ä½ç½®ï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›éœ€è¦çš„åç§°</p><p>ä¼ ç»Ÿçš„ <code>JavaEvents</code>ä½¿ç”¨ä¾¦å¬å™¨æ¥å£ï¼Œè¯¥æ¥å£é€šå¸¸åªè¿è¡Œå°‘æ•°æ–¹æ³•â€”â€”é€šå¸¸æ˜¯ä¸€ä¸ªï¼Œè¿™æœ‰è®¸å¤šç¼ºç‚¹ï¼š</p><ul><li>ä»»ä½•ä¸€ä¸ªç±»éƒ½åªèƒ½å®ç°å¯¹ç»™å®šäº‹ä»¶çš„å•ä¸ªå“åº”</li><li>è®¢é˜…è€…æ¥å£æ–¹æ³•å¯èƒ½å‘ç”Ÿå†²çª</li><li>æ–¹æ³•å¿…é¡»ä»¥äº‹ä»¶å‘½åï¼ˆä¾‹å¦‚ <code>handleChangeEvent</code>ï¼‰ï¼Œè€Œä¸æ˜¯ä»¥å…¶ç›®çš„ï¼ˆä¾‹å¦‚ <code>recordChangeInJournal</code> ï¼‰å‘½å</li><li>æ¯ç§äº‹ä»¶éƒ½æœ‰ä»–ä»¬è‡ªå·±çš„æ¥å£ï¼Œæ²¡æœ‰ä¸€ä¸ªé’ˆå¯¹äº‹ä»¶æ—çš„é€šç”¨çˆ¶ç±»æ¥å£</li></ul><p>å¹²å‡€æ¸…æ™°åœ°å®ç°ä¼šå­˜åœ¨å›°éš¾ï¼Œè§£å†³å›°éš¾å¯¼è‡´äº†ä¸€ç§æ¨¡å¼ï¼Œå³ä½¿ç”¨ç®€å•çš„åŒ¿åç±»æ¥å®ç°è®¢é˜…å™¨æ¥å£</p><p>æ¯”è¾ƒå¦‚ä¸‹ä¸¤ä¸ª case</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ChangeRecorder</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setCustomer</span><span class="params">(Customer cust)</span> &#123;</span><br><span class="line">    cust.addChangeListener(<span class="keyword">new</span> <span class="title class_">ChangeListener</span>() &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customerChanged</span><span class="params">(ChangeEvent e)</span> &#123;</span><br><span class="line">        recordChange(e.getChange());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class is typically registered by the container.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventBusChangeRecorder</span> &#123;</span><br><span class="line">  <span class="meta">@Subscribe</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordCustomerChange</span><span class="params">(ChangeEvent e)</span> &#123;</span><br><span class="line">    recordChange(e.getChange());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œæ„å›¾æ›´æ¸…æ™°ï¼šå†—ä½™ä»£ç ï¼ˆnoisecodeï¼‰æ›´å°‘ï¼Œäº‹ä»¶è®¢é˜…è€…æœ‰ä¸€ä¸ªæ¸…æ™°è€Œæœ‰æ„ä¹‰çš„åç§°</p><p><strong>å¦‚æœæˆ‘æ³¨å†Œäº†ä¸€ä¸ªæ²¡æœ‰ä»»ä½•è®¢é˜…è€…æ–¹æ³•çš„ä¾¦å¬å™¨ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</strong></p><p>ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ</p><p>EventBusæ€»æ˜¯è®¾è®¡å’Œå®¹å™¨ã€æ¨¡å—ç³»ç»Ÿé›†æˆï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œè®©å®¹å™¨ã€å·¥å‚ã€ç¯å¢ƒå°†æ¯ä¸ªåˆ›å»ºçš„å¯¹è±¡ä¼ é€’ç»™EventBusçš„ <code>register</code> æ–¹æ³•æ˜¯å¾ˆæ–¹ä¾¿çš„</p><p>è¿™æ ·ï¼Œå®¹å™¨ã€å·¥å‚ã€ç¯å¢ƒåˆ›å»ºçš„ä»»ä½•å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡å…¬å¼€è®¢é˜…è€…æ–¹æ³•æŒ‚æ¥åˆ°ç³»ç»Ÿçš„äº‹ä»¶æ¨¡å‹ä¸­</p><p><strong>åœ¨ç¼–è¯‘æ—¶å¯ä»¥æ£€æµ‹åˆ°å“ªäº› Event Bus é—®é¢˜ï¼Ÿ</strong></p><p>Java çš„ç±»å‹ç³»ç»Ÿå¯ä»¥æ˜ç¡®æ£€æµ‹åˆ°çš„ä»»ä½•é—®é¢˜</p><p>ä¾‹å¦‚ä¸ºä¸å­˜åœ¨çš„äº‹ä»¶ç±»å‹å®šä¹‰è®¢é˜…è€…æ–¹æ³•</p><p><strong>å“ªäº› Event Bus é—®é¢˜å¯ä»¥åœ¨æ³¨å†Œæ—¶ç«‹å³æ£€æµ‹åˆ°ï¼Ÿ</strong></p><p>è°ƒç”¨ <code>register</code>åï¼Œå°†ç«‹å³æ£€æŸ¥æ­£åœ¨æ³¨å†Œçš„ä¾¦å¬å™¨çš„è®¢é˜…è€…æ–¹æ³•çš„æ ¼å¼æ˜¯å¦æ­£ç¡®</p><p>ç‰¹åˆ«æ˜¯ï¼Œä»»ä½•ç”¨ <code>@Subscribe</code>æ ‡è®°çš„æ–¹æ³•éƒ½å¿…é¡»åªæ¥å—ä¸€ä¸ªå‚æ•°</p><p>ä»»ä½•è¿åæ­¤è§„åˆ™çš„è¡Œä¸ºéƒ½å°†å¼•å‘<code>IllegalArgumentException</code>ï¼ˆè¿™ä¸ªæ£€æŸ¥å¯ä»¥è½¬ç§»åˆ°ä½¿ç”¨ APTçš„ç¼–è¯‘æ—¶é—´ï¼Œè¿™æ˜¯æˆ‘ä»¬æ­£åœ¨ç ”ç©¶çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼‰</p><p><strong>å“ªäº› Event Bus é—®é¢˜åªèƒ½åœ¨ç¨åçš„è¿è¡Œæ—¶æ£€æµ‹åˆ°ï¼Ÿ</strong></p><p>å¦‚æœç»„ä»¶ postäº†æ²¡æœ‰æ³¨å†Œä¾¦å¬å™¨çš„äº‹ä»¶ï¼Œåˆ™å¯èƒ½æŒ‡ç¤ºé”™è¯¯ï¼ˆé€šå¸¸æŒ‡ç¤ºæ‚¨é”™è¿‡äº†<code>@Subscribe</code> æ³¨é‡Šï¼Œæˆ–è€…ä¾¦å¬ç»„ä»¶æœªåŠ è½½ï¼‰</p><p>ï¼ˆè¯·æ³¨æ„ï¼Œè¿™å¹¶ä¸ä¸€å®šæ„å‘³ç€æœ‰é—®é¢˜ï¼›åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä¼šæ•…æ„å¿½ç•¥å‘å¸ƒçš„äº‹ä»¶ï¼Œå°¤å…¶æ˜¯å½“äº‹ä»¶æ¥è‡ªæ‚¨æ— æ³•æ§åˆ¶çš„ä»£ç æ—¶ï¼‰</p><p>è¦å¤„ç†æ­¤ç±»äº‹ä»¶ï¼Œè¯·ä¸º <code>DeadEvent</code>ç±»æ³¨å†Œä¸€ä¸ªè®¢é˜…è€…æ–¹æ³•ï¼Œæ¯å½“ <code>EventBus</code>æ¥æ”¶åˆ°æ²¡æœ‰æ³¨å†Œè®¢é˜…è€…çš„äº‹ä»¶æ—¶ï¼Œå®ƒéƒ½ä¼šå°†å…¶è½¬æ¢ä¸º <code>DeadEvent</code>å¹¶æŒ‰æ‚¨çš„æ–¹å¼ä¼ é€’ï¼Œä»è€Œå…è®¸æ‚¨è®°å½•å®ƒæˆ–ä»¥å…¶ä»–æ–¹å¼æ¢å¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ­»ä¿¡äº‹ä»¶ï¼šæ¥æ”¶æ²¡æœ‰è®¢é˜…è€…çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerDeadEvent</span><span class="params">(DeadEvent deadEvent)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;EventListener#listenerDeadEvent -&gt; &quot;</span> + deadEvent.getEvent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æˆ‘å¦‚ä½•æµ‹è¯•æ¶ˆæ¯è®¢é˜…è€…å’Œä»–ä»¬çš„è®¢é˜…æ–¹æ³•ï¼Ÿ</strong></p><p>å› ä¸ºä¾¦å¬å™¨ç±»ä¸Šçš„è®¢é˜…è€…æ–¹æ³•æ˜¯æ™®é€šæ–¹æ³•ï¼Œæ‰€ä»¥æ‚¨å¯ä»¥ç®€å•åœ°ä»æµ‹è¯•ä»£ç ä¸­è°ƒç”¨å®ƒä»¬æ¥æ¨¡æ‹Ÿ<code>EventBus</code></p><h1 id="æºç ">æºç </h1><h2 id="eventbus">EventBus</h2><p><code>EventBus</code> æ‰¿è½½äº†è®¢é˜…ä¿¡æ¯å’Œ postäº‹ä»¶çš„èƒ½åŠ›ï¼Œå®ä¾‹å’Œå®ä¾‹ä¹‹é—´çš„ä¿¡æ¯äº’ç›¸éš”ç¦»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">EventBus(</span><br><span class="line">    String identifier,</span><br><span class="line">    Executor executor,</span><br><span class="line">    Dispatcher dispatcher,</span><br><span class="line">    SubscriberExceptionHandler exceptionHandler) &#123;</span><br><span class="line">  <span class="built_in">this</span>.identifier = checkNotNull(identifier);</span><br><span class="line">  <span class="built_in">this</span>.executor = checkNotNull(executor);</span><br><span class="line">  <span class="built_in">this</span>.dispatcher = checkNotNull(dispatcher);</span><br><span class="line">  <span class="built_in">this</span>.exceptionHandler = checkNotNull(exceptionHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æ„é€ å™¨æ¥çœ‹ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸»è¦çš„åˆå§‹å±æ€§ï¼š</p><ul><li>identifierï¼šè¯¥ <code>EventBus</code> å®ä¾‹çš„ç®€ç§°æ ‡è¯†</li><li>executorï¼šæ‰§è¡Œå™¨ï¼›é»˜è®¤æ˜¯ä¸€ä¸ªç›´æ¥æ‰§è¡Œå™¨</li><li>dispatcherï¼šè°ƒåº¦å™¨ï¼›é»˜è®¤æ˜¯å•çº¿ç¨‹é˜Ÿåˆ—è°ƒåº¦</li><li>exceptionHandlerï¼šå¼‚å¸¸å¤„ç†å™¨</li></ul><p><code>EventBus</code> è¿˜æœ‰ä¸€ä¸ªå­ç±» <code>AsyncEventBus</code></p><p>åŒºåˆ«åœ¨äºå¯ä»¥è®¾ç½® <code>Executor</code>ï¼Œ<code>Dispatcher</code>é»˜è®¤ä¸º <code>LegacyAsyncDispatcher</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AsyncEventBus</span><span class="params">(Executor executor, SubscriberExceptionHandler subscriberExceptionHandler)</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>(<span class="string">&quot;default&quot;</span>, executor, Dispatcher.legacyAsync(), subscriberExceptionHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="register-æ³¨å†Œè®¢é˜…æ–¹æ³•">register æ³¨å†Œè®¢é˜…æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">EventBus</span> <span class="variable">eventBus</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventBus</span>();</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> <span class="title class_">EventListener</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ç”¨äºæ³¨å†Œè®¢é˜…æ–¹æ³•ï¼Œå³å¤„ç†äº‹ä»¶çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object listener)</span> &#123;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°æ‰€æœ‰åŒ…è£…çš„ Subscriber</span></span><br><span class="line">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; listenerMethods = findAllSubscribers(listener);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Entry&lt;Class&lt;?&gt;, Collection&lt;Subscriber&gt;&gt; entry : listenerMethods.asMap().entrySet()) &#123;</span><br><span class="line">    Class&lt;?&gt; eventType = entry.getKey();</span><br><span class="line">    Collection&lt;Subscriber&gt; eventMethodsInListener = entry.getValue();</span><br><span class="line"></span><br><span class="line">    CopyOnWriteArraySet&lt;Subscriber&gt; eventSubscribers = subscribers.get(eventType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜åˆ° eventSubscribers</span></span><br><span class="line">    <span class="keyword">if</span> (eventSubscribers == <span class="literal">null</span>) &#123;</span><br><span class="line">      CopyOnWriteArraySet&lt;Subscriber&gt; newSet = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;&gt;();</span><br><span class="line">      <span class="comment">// key æ˜¯ event type</span></span><br><span class="line">      eventSubscribers =</span><br><span class="line">          MoreObjects.firstNonNull(subscribers.putIfAbsent(eventType, newSet), newSet);</span><br><span class="line">    &#125;</span><br><span class="line">    eventSubscribers.addAll(eventMethodsInListener);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº† Guava åŒ…ä¸‹çš„ cache å·¥å…·</p><p>ç›´æ¥çœ‹æ‰«æè®¢é˜…æ–¹æ³•çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ImmutableList&lt;Method&gt; <span class="title function_">getAnnotatedMethodsNotCached</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    Set&lt;? <span class="keyword">extends</span> <span class="title class_">Class</span>&lt;?&gt;&gt; supertypes = TypeToken.of(clazz).getTypes().rawTypes();</span><br><span class="line">    Map&lt;MethodIdentifier, Method&gt; identifiers = Maps.newHashMap();</span><br><span class="line">  <span class="comment">// éå†ç±»å‹</span></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; supertype : supertypes) &#123;</span><br><span class="line">      <span class="comment">// éå†æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">for</span> (Method method : supertype.getDeclaredMethods()) &#123;</span><br><span class="line">        <span class="comment">// æ‰«ææ³¨è§£</span></span><br><span class="line">        <span class="keyword">if</span> (method.isAnnotationPresent(Subscribe.class) &amp;&amp; !method.isSynthetic()) &#123;</span><br><span class="line">          <span class="comment">// TODO(cgdecker): Should check for a generic parameter type and error out</span></span><br><span class="line">          Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">          <span class="comment">// check æ–¹æ³•å‚æ•°æ•°é‡</span></span><br><span class="line">          checkArgument(</span><br><span class="line">              parameterTypes.length == <span class="number">1</span>,</span><br><span class="line">              <span class="string">&quot;Method %s has @Subscribe annotation but has %s parameters. &quot;</span></span><br><span class="line">                  + <span class="string">&quot;Subscriber methods must have exactly 1 parameter.&quot;</span>,</span><br><span class="line">              method,</span><br><span class="line">              parameterTypes.length);</span><br><span class="line"><span class="comment">// check æ–¹æ³•å‚æ•°æ˜¯å¦æ˜¯åŸå§‹ç±»å‹</span></span><br><span class="line">          checkArgument(</span><br><span class="line">              !parameterTypes[<span class="number">0</span>].isPrimitive(),</span><br><span class="line">              <span class="string">&quot;@Subscribe method %s&#x27;s parameter is %s. &quot;</span></span><br><span class="line">                  + <span class="string">&quot;Subscriber methods cannot accept primitives. &quot;</span></span><br><span class="line">                  + <span class="string">&quot;Consider changing the parameter to %s.&quot;</span>,</span><br><span class="line">              method,</span><br><span class="line">              parameterTypes[<span class="number">0</span>].getName(),</span><br><span class="line">              Primitives.wrap(parameterTypes[<span class="number">0</span>]).getSimpleName());</span><br><span class="line"></span><br><span class="line">          <span class="comment">// åŒ…è£…åå°„å‡ºçš„æ–¹æ³•</span></span><br><span class="line">          <span class="type">MethodIdentifier</span> <span class="variable">ident</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodIdentifier</span>(method);</span><br><span class="line">          <span class="keyword">if</span> (!identifiers.containsKey(ident)) &#123;</span><br><span class="line">            <span class="comment">// ä¿å­˜</span></span><br><span class="line">            identifiers.put(ident, method);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ImmutableList.copyOf(identifiers.values());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹ï¼š</p><ul><li>è·å– <code>Object</code> å¯¹è±¡çš„ç±»å‹åˆ—è¡¨</li><li>éå†æ–¹æ³•</li><li>æ‰«æå‡º <code>Subscribe</code> æ–¹æ³•ï¼Œæ ¡éªŒå‚æ•°åˆ—è¡¨</li><li>åŒ…è£…ä¸º <code>MethodIdentifier</code> ä¿å­˜</li></ul><h2 id="post-å‘å¸ƒäº‹ä»¶">post å‘å¸ƒäº‹ä»¶</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">EventBus</span> <span class="variable">eventBus</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventBus</span>();</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> <span class="title class_">EventListener</span>());</span><br><span class="line">        eventBus.post(<span class="number">1</span>);</span><br><span class="line">        eventBus.post(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘å¸ƒäº‹ä»¶çš„æ“ä½œå…¶å®å°±åŒ…å«äº†å¯¹è®¢é˜…è€…çš„è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">post</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">  <span class="comment">// æ ¹æ® event type æŸ¥è¯¢è®¢é˜…è€…åˆ—è¡¨</span></span><br><span class="line">  Iterator&lt;Subscriber&gt; eventSubscribers = subscribers.getSubscribers(event);</span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰è®¢é˜…æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ dispatch</span></span><br><span class="line">  <span class="keyword">if</span> (eventSubscribers.hasNext()) &#123;</span><br><span class="line">    dispatcher.dispatch(event, eventSubscribers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(event <span class="keyword">instanceof</span> DeadEvent)) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹åº”äº‹ä»¶æ²¡æœ‰è®¢é˜…è€…ï¼Œåˆ™åŒ…è£…ä¸ºæ­»ä¿¡æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">// the event had no subscribers and was not itself a DeadEvent</span></span><br><span class="line">    post(<span class="keyword">new</span> <span class="title class_">DeadEvent</span>(<span class="built_in">this</span>, event));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸åŒçš„è°ƒåº¦å™¨æœ‰ä¸åŒçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">  checkNotNull(event);</span><br><span class="line">  checkNotNull(subscribers);</span><br><span class="line">  Queue&lt;Event&gt; queueForThread = queue.get();</span><br><span class="line">  queueForThread.offer(<span class="keyword">new</span> <span class="title class_">Event</span>(event, subscribers));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dispatching.get()) &#123;</span><br><span class="line">    dispatching.set(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Event nextEvent;</span><br><span class="line">      <span class="keyword">while</span> ((nextEvent = queueForThread.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (nextEvent.subscribers.hasNext()) &#123;</span><br><span class="line">          nextEvent.subscribers.next().dispatchEvent(nextEvent.event);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      dispatching.remove();</span><br><span class="line">      queue.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨ <code>Subscriber</code> çš„ <code>dispatchEvent</code>æ–¹æ³•ï¼Œé€šè¿‡åå°„è¿›è¡Œæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">dispatchEvent</span><span class="params">(<span class="keyword">final</span> Object event)</span> &#123;</span><br><span class="line">  executor.execute(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            invokeSubscriberMethod(event);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            bus.handleSubscriberException(e.getCause(), context(event));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="dispatcher-è°ƒåº¦å™¨">Dispatcher è°ƒåº¦å™¨</h2><p>è°ƒåº¦å™¨ç”¨æ¥æ”¹å˜äº‹ä»¶å‘å¸ƒåè°ƒç”¨è®¢é˜…æ–¹æ³•çš„é¡ºåº</p><p>æœ‰ä¸‰ç§å®ç°ï¼š</p><ul><li>PerThreadQueuedDispatcherï¼šæ¯ä¸ªçº¿ç¨‹å†…çš„äº‹ä»¶éƒ½æŒ‰ç…§å‘å¸ƒé¡ºåºè°ƒç”¨è®¢é˜…è€…ï¼›å¹¿åº¦ä¼˜å…ˆ</li><li>LegacyAsyncDispatcherï¼šå•ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­å‘å¸ƒçš„äº‹ä»¶è¿›è¡Œæ’é˜Ÿï¼›å¹¿åº¦ä¼˜å…ˆ</li><li>ImmediateDispatcherï¼šäº‹ä»¶å‘å¸ƒåç«‹å³å°†äº‹ä»¶è°ƒåº¦ç»™è®¢é˜…è€…ï¼Œè€Œä¸ä½¿ç”¨ä¸­é—´é˜Ÿåˆ—æ¥æ›´æ”¹è°ƒåº¦é¡ºåºï¼›æ·±åº¦ä¼˜å…ˆ</li></ul><h3 id="perthreadqueueddispatcher">PerThreadQueuedDispatcher</h3><p>æ¯ä¸ªçº¿ç¨‹å†…çš„äº‹ä»¶éƒ½æŒ‰ç…§å‘å¸ƒé¡ºåºè°ƒç”¨è®¢é˜…è€…ï¼›å¹¿åº¦ä¼˜å…ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">PerThreadQueuedDispatcher</span> <span class="keyword">extends</span> <span class="title class_">Dispatcher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This dispatcher matches the original dispatch behavior of EventBus.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Per-thread queue of events to dispatch. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt; queue =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Queue&lt;Event&gt;&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">protected</span> Queue&lt;Event&gt; <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Queues.newArrayDeque();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Per-thread dispatch state, used to avoid reentrant event dispatching. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; dispatching =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Boolean&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">protected</span> Boolean <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">      checkNotNull(event);</span><br><span class="line">      checkNotNull(subscribers);</span><br><span class="line">      <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ event é˜Ÿåˆ—</span></span><br><span class="line">      Queue&lt;Event&gt; queueForThread = queue.get();</span><br><span class="line">      <span class="comment">// å°†å½“å‰å‘å¸ƒçš„äº‹ä»¶ offer è¿›é˜Ÿåˆ—</span></span><br><span class="line">      queueForThread.offer(<span class="keyword">new</span> <span class="title class_">Event</span>(event, subscribers));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ¤æ–­è°ƒåº¦æ ‡è®°</span></span><br><span class="line">      <span class="keyword">if</span> (!dispatching.get()) &#123;</span><br><span class="line">        <span class="comment">// è°ƒåº¦æ ‡è®°ï¼Œè®¾ç½®ä¸º true</span></span><br><span class="line">        dispatching.set(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Event nextEvent;</span><br><span class="line">          <span class="keyword">while</span> ((nextEvent = queueForThread.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (nextEvent.subscribers.hasNext()) &#123;</span><br><span class="line">              <span class="comment">// è°ƒåº¦è®¢é˜…æ–¹æ³•</span></span><br><span class="line">              nextEvent.subscribers.next().dispatchEvent(nextEvent.event);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// æ¸…ç† ThreadLocal</span></span><br><span class="line">          dispatching.remove();</span><br><span class="line">          queue.remove();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PerThreadQueuedDispatcher</code>éš”ç¦»äº†çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹çš„äº‹ä»¶éƒ½åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸‹ä¿è¯è°ƒåº¦</p><p>åŒæ—¶ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹éš”ç¦»çš„æ ‡è®° <code>dispatching</code>å½“å‰çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨è°ƒåº¦ä¸­</p><p>è¿™æ ·å°±è¾¾åˆ°äº†å¹¿åº¦ä¼˜å…ˆçš„æ•ˆæœï¼Œäº‹ä»¶ A å’Œäº‹ä»¶ B =&gt;[a1,a2,a3,b1,b2,b3]</p><h3 id="legacyasyncdispatcher">LegacyAsyncDispatcher</h3><p>å•ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­å‘å¸ƒçš„äº‹ä»¶è¿›è¡Œæ’é˜Ÿï¼›å¹¿åº¦ä¼˜å…ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LegacyAsyncDispatcher</span> <span class="keyword">extends</span> <span class="title class_">Dispatcher</span> &#123;</span><br><span class="line">    <span class="comment">/** Global event queue. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentLinkedQueue&lt;EventWithSubscriber&gt; queue =</span><br><span class="line">        Queues.newConcurrentLinkedQueue();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">      checkNotNull(event);</span><br><span class="line">      <span class="keyword">while</span> (subscribers.hasNext()) &#123;</span><br><span class="line">        queue.add(<span class="keyword">new</span> <span class="title class_">EventWithSubscriber</span>(event, subscribers.next()));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      EventWithSubscriber e;</span><br><span class="line">      <span class="keyword">while</span> ((e = queue.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        e.subscriber.dispatchEvent(e.event);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†ä¸€ä¸ªå…¨å±€äº‹ä»¶é˜Ÿåˆ— <code>ConcurrentLinkedQueue</code>æ¥ä¿è¯é¡ºåº</p><p>ä»¥æ­¤åœ¨å¼‚æ­¥çš„è¿‡ç¨‹ä¸­åŒæ ·è¾¾åˆ°æ¶ˆæ¯è®¢é˜…å¹¿åº¦çš„æ•ˆæœ</p><p>äº‹ä»¶ A å’Œäº‹ä»¶ B =&gt; [a1,a2,a3,b1,b2,b3]</p><h3 id="immediatedispatcher">ImmediateDispatcher</h3><p>äº‹ä»¶å‘å¸ƒåç«‹å³å°†äº‹ä»¶è°ƒåº¦ç»™è®¢é˜…è€…ï¼Œè€Œä¸ä½¿ç”¨ä¸­é—´é˜Ÿåˆ—æ¥æ›´æ”¹è°ƒåº¦é¡ºåºï¼›æ·±åº¦ä¼˜å…ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ImmediateDispatcher</span> <span class="keyword">extends</span> <span class="title class_">Dispatcher</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ImmediateDispatcher</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImmediateDispatcher</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> &#123;</span><br><span class="line">    checkNotNull(event);</span><br><span class="line">    <span class="keyword">while</span> (subscribers.hasNext()) &#123;</span><br><span class="line">      subscribers.next().dispatchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯äº‹ä»¶å‘å¸ƒåæ‹¿åˆ°è®¢é˜…åˆ—è¡¨ç«‹å³è°ƒåº¦</p><p>åŒºåˆ«æ’é˜Ÿçš„æœºåˆ¶ï¼Œæ¶ˆæ¯å’Œæ¶ˆæ¯ä¹‹é—´ä¸ä¿è¯å…ˆåé¡ºåº</p><p>äº‹ä»¶ A å’Œäº‹ä»¶ B ä¹‹é—´æœ‰å¯èƒ½æ˜¯ [a1,a2,a3,b1,b2,b3]ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯[a1,a2,b1,b2,a3,b3]ï¼Œä¹Ÿå¯èƒ½æ˜¯ [a1,b1,b2,b3,a2,a3]</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://github.com/google/guava/wiki/EventBusExplained">EventBusExplainedÂ· google/guava Wiki Â· GitHub</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Guava </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Šç”µå‰ä»–ç³»ç»Ÿæ•™ç¨‹1.0ã€‹å­¦ä¹ ç¬”è®°</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%8D%8E%E5%8C%97%E6%97%A0%E6%B5%AA%E6%BC%AB/%E3%80%8A%E7%94%B5%E5%90%89%E4%BB%96%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B1.0%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%8D%8E%E5%8C%97%E6%97%A0%E6%B5%AA%E6%BC%AB/%E3%80%8A%E7%94%B5%E5%90%89%E4%BB%96%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B1.0%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p>ä¹°äº†äººç”Ÿç¬¬ä¸€æŠŠç”µå‰ä»–ï¼ˆå‹å·æ˜¯ <strong>Ibenez</strong> çš„<strong>GRG121SP</strong>ï¼‰</p><p>ä¸‹é¢æ˜¯å…¶å¸…ç…§~</p><img src="/%E4%BA%BA%E7%94%9F/%E5%8D%8E%E5%8C%97%E6%97%A0%E6%B5%AA%E6%BC%AB/%E3%80%8A%E7%94%B5%E5%90%89%E4%BB%96%E7%B3%BB%E7%BB%9F%E6%95%99%E7%A8%8B1.0%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%90%89%E4%BB%96%E5%B8%85%E7%85%A7.jpg" class="" title="å‰ä»–å¸…ç…§"><p>å°±ä» B ç«™çš„è§†é¢‘å¼€å§‹å§</p><p><ahref="https://www.bilibili.com/video/BV1FT411Z7iu/?spm_id_from=333.337.search-card.all.click&amp;vd_source=d71ed59532fe75ae6e76322af844c014">ã€å®Œæ•´ç‰ˆã€‘å…¨ç½‘æœ€ç®€å•çš„ã€Šç”µå‰ä»–ç³»ç»Ÿæ•™ç¨‹1.0ã€‹é€‚åˆé›¶åŸºç¡€è‡ªå­¦å…¥é—¨_å“”å“©å“”å“©_bilibili</a></p><p>è¿™é‡Œè®°å½•ä¸€äº›åŠ¨ä½œã€çŸ¥è¯†è¦ç‚¹</p><h1 id="w1-ex1---å³æ‰‹ç©ºå¼¦ä¸‹æ‹¨">W1 EX1 - å³æ‰‹ç©ºå¼¦ä¸‹æ‹¨</h1><p><strong>åŠ¨ä½œè¦ç‚¹</strong></p><ul><li>åå§¿<ul><li>èƒ³è†Šå¤¹ç´å€¾æ–œ</li><li>å¤§è…¿å’Œåœ°é¢å¹³è¡Œ</li><li>ç´å¤´ç•¥å¾®ä¸Šç¿˜</li></ul></li><li>æ‹¨ç‰‡<ul><li>æ­£æ­¥å§¿åŠ¿ï¼Œæ‹‡æŒ‡ã€é£ŸæŒ‡æä½æ‹¨ç‰‡</li><li>ç”¨åŠ›ï¼Œæ‹¨åŠ¨æ—¶æ‹¨ç‰‡ä¸è¦ä¸Šä¸‹æ‘‡æ™ƒ</li></ul></li><li>æŠ¤å¼¦<ul><li>å¤§å°é±¼é™…éƒ½é åœ¨å¼¦ä¸Š</li><li>æ‹¨å¼¦æ—¶æ‰‹ä¸è¦æ‚¬ç©ºï¼Œå¦åˆ™æ²¡æœ‰æŠ¤å¼¦çš„æ•ˆæœ</li></ul></li><li>æ‹¨å¼¦<ul><li>æ‹¨å¼¦ä½ç½®åº”è¯¥ä½äºä¸¤ä¸ªæ‹¾éŸ³å™¨ï¼ˆåŒåŒï¼‰ä¸­é—´</li><li>æ‹¨ç‰‡é¢ä¸ç´å¼¦å¹³è¡Œ</li><li>æ‹¨å¼¦ä½¿ç”¨æ‰‹è…•å‘åŠ›ï¼Œå¤§è‡‚å’Œå°è‡‚ä¸è¦å‘åŠ›ï¼Œå®Œå…¨æ”¾æ¾</li><li>æ‹¨å¼¦æ–¹å‘æ²¿æ‰‹è…•æ–¹å‘ï¼Œç±»ä¼¼é’Ÿæ‘†ä¸Šä¸‹è¿åŠ¨ï¼ˆä¸æ˜¯æ‰­é’¥åŒ™ï¼‰ï¼›å‘ä¸‹æ‹¨è€Œä¸æ˜¯å‘å¤–æ‹¨</li><li>ç»ƒä¹ æ‰‹è…•çš„å‘åŠ›ï¼Œæ‹¨ä¸‹äºŒå¼¦æ—¶ï¼Œæœ€ç»ˆæ‹¨ç‰‡åœåœ¨ä¸€å¼¦ä¸Š</li></ul></li></ul><p><strong>ç»ƒä¹ </strong></p><p>é€Ÿåº¦ 40ï¼Œç¬¬ä¸€æ‹å¼¹å¼¦ï¼Œç¬¬äºŒæ‹åœé¡¿ï¼Œç¬¬ä¸‰æ‹å¼¹å¼¦ï¼Œç¬¬å››æ‹åœé¡¿</p><h1 id="w1-ex2---12-å“éŸ³é«˜æ¨¡å”±">W1 EX2 - 12 å“éŸ³é«˜æ¨¡å”±</h1><p><strong>çŸ¥è¯†è¦ç‚¹</strong></p><ul><li>é’¢ç´ä¸­ç¬¬ä¸€ä¸ªå…«åº¦ç”¨ <code>C1</code>è¡¨ç¤ºï¼Œé‚£ä¹ˆä¸­éŸ³åŒºçš„å°å­—ä¸€ç»„å°±è¡¨ç¤ºä¸º <code>C4</code></li><li>ä¸€ä¸ªå…«åº¦ä¸­åŒ…å« 12 ä¸ªéŸ³ï¼Œdo</li><li>å¯¹åº”åœ¨å‰ä»–ä¸­ä¹Ÿä¸€æ ·ï¼Œæ¯ä¸ªå“çº§æ˜¯ä¸€ä¸ªåŠéŸ³ ä¾‹å¦‚ï¼šä¸€å¼¦ 12 å“æ˜¯ miï¼Œé‚£ä¹ˆ13 å“å°±æ˜¯ faï¼Œåè¿‡æ¥é—´éš”ä¸€ä¸ªå“æ˜¯ re</li><li>å‰ä»–ä¸­æ¯æ ¹å¼¦é—´éš”äº”å“ï¼Œæ˜¯ä¸€æ ·çš„éŸ³é«˜ï¼ˆ2ã€3 å¼¦åªé—´éš”å››å“ï¼‰ ä¾‹å¦‚ï¼šä¸€å¼¦ 8å“æ˜¯ doï¼Œé‚£ä¹ˆäºŒå¼¦çš„ 13 å“ä¹Ÿæ˜¯ do</li><li>å‰ä»–ç©ºå¼¦ 1 åˆ° 6 å¼¦åˆ†åˆ«æ˜¯ï¼Œ375263</li></ul><p><strong>åŠ¨ä½œè¦ç‚¹</strong></p><ul><li>æ¯æ¬¡å¼¹å‰éƒ½è¦è°ƒéŸ³</li><li>æŒ‰ä½ 12 å“ï¼Œ12 å“çš„éŸ³å’Œç©ºå¼¦éŸ³ä¸€æ ·ï¼Œä½†æ˜¯ä¼šé«˜å…«åº¦</li><li>æŒ‰å¼¦é è¿‘å“ä¸ï¼ŒæŠŠå¼¦å‹åœ¨å“ä¸ä¸Šï¼Œä¸ç”¨ç‰¹åˆ«ç”¨åŠ›</li><li>æŒ‰åŠ¨ä¸Šé¢å¼¦çš„æ—¶å€™ï¼Œæ‹‡æŒ‡ä½ç½®ä¸å˜ï¼Œæ‰‹è…•éœ€è¦ä¸€ä¸ªè½¬åŠ¨ï¼Œæ›´é«˜åœ°æŒ‰åˆ°ä¸Šæ–¹çš„ç´å¼¦</li><li>æŒ‰å¼¦æŠ¤å¼¦ï¼Œæ‰‹æŒ‡åœ¨æŒ‰åŠ¨ç´å¼¦çš„æ—¶å€™ï¼ŒæŠ¤ä½ä¸Šæ–¹ç´å¼¦ï¼Œä¾‹å¦‚æŒ‰åŠ¨ä¸€å¼¦çš„æ—¶å€™ï¼Œäº’ä½ä¸Šæ–¹çš„äºŒå¼¦ï¼›æ‰‹æŒ‡ä¾§ä¸€ç‚¹æ›´æ–¹ä¾¿æŠ¤å¼¦</li><li>æ‹¨å¼¦æ—¶å”±å‡ºå”±å</li></ul><p><strong>ç»ƒä¹ </strong></p><p>é€Ÿåº¦ 40ï¼ŒèŠ‚å¥å’Œä¸Šé¢ç»ƒä¹ ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯åŠ ä¸Šè¿™æ¬¡å­¦ä¹ å†…å®¹ï¼šæŒ‰å“ +å”±éŸ³</p><p>é¡ºåºæŒ‰ç…§ 1 -&gt; 6 å†å€’è¿‡æ¥ 6 -&gt; 1 å¼¦è¿›è¡Œ</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://www.bilibili.com/video/BV1FT411Z7iu/?spm_id_from=333.337.search-card.all.click&amp;vd_source=d71ed59532fe75ae6e76322af844c014">ã€å®Œæ•´ç‰ˆã€‘å…¨ç½‘æœ€ç®€å•çš„ã€Šç”µå‰ä»–ç³»ç»Ÿæ•™ç¨‹1.0ã€‹é€‚åˆé›¶åŸºç¡€è‡ªå­¦å…¥é—¨_å“”å“©å“”å“©_bilibili</a></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> ååŒ—æ— æµªæ¼« </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç”µå‰ä»– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP Server-Sent Events ç®€å•ä½¿ç”¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/HTTP%20Server-Sent%20Events%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/HTTP%20Server-Sent%20Events%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="sse">SSE</h1><h2 id="ä»‹ç»">ä»‹ç»</h2><p>Server-Sent Eventsï¼ˆSSEï¼‰æ˜¯ä¸€ç§åŸºäº HTTPçš„æœåŠ¡å™¨æ¨é€æŠ€æœ¯ï¼Œå®ƒå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å®æ—¶å‘é€æ•°æ®</p><p>é€šè¿‡SSEï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚</p><p>SSE å»ºç«‹åœ¨ HTTPåè®®ä¹‹ä¸Šï¼Œä½¿ç”¨äº†é•¿è¿æ¥ï¼ˆæŒä¹…è¿æ¥ï¼‰æ¥å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„å®æ—¶é€šä¿¡</p><p>ä¸ä¼ ç»Ÿçš„è¯·æ±‚-å“åº”æ¨¡å‹ä¸åŒï¼ŒSSEå…è®¸æœåŠ¡å™¨åœ¨äº‹ä»¶å‘ç”Ÿæ—¶ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚è¿™ä½¿å¾—æœåŠ¡å™¨å¯ä»¥å®æ—¶åœ°å‘å®¢æˆ·ç«¯æ¨é€æ›´æ–°çš„ä¿¡æ¯ã€é€šçŸ¥ã€çŠ¶æ€å˜åŒ–ç­‰</p><p>ä¾‹å¦‚ GPT ç­‰ AI çš„é—®ç­”çª—å£ï¼Œå¾€å¾€å°±æ˜¯ç”¨ SSEåè®®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç”¨æˆ·ç­‰å¾…å“åº”çš„æ—¶é—´ï¼›å…¶æ¬¡æ¨¡æ‹Ÿæ‰“å­—æœºç­‰æ•ˆæœä¹Ÿå¯ä»¥å¢å¼ºç”¨æˆ·ä½“éªŒ</p><h2 id="å¯¹æ¯”">å¯¹æ¯”</h2><h3 id="http">HTTP</h3><p>æ ‡å‡†çš„ HTTP åè®®ä¸­ï¼Œæ¯ä¸ª HTTP å“åº”éƒ½ä¼šåœ¨å‘é€å®Œæ¯•åå…³é—­è¿æ¥ï¼ŒHTTP/1.1åè®®é»˜è®¤é‡‡ç”¨çŸ­è¿æ¥ï¼ˆshort-lived connectionsï¼‰æ–¹å¼</p><p>HTTP å“åº”çš„å¤´éƒ¨ä¸­ä¼šåŒ…å«ä¸€ä¸ª <code>Connection</code>å­—æ®µï¼Œç”¨äºæŒ‡ç¤ºè¿æ¥çš„çŠ¶æ€ï¼Œå½“è¯¥å­—æ®µçš„å€¼ä¸º <code>close</code>æ—¶ï¼Œè¡¨ç¤ºæœåŠ¡å™¨ä¼šåœ¨å‘é€å®Œå“åº”åä¸»åŠ¨å…³é—­è¿æ¥</p><p>ä¹Ÿå¯ä»¥è®¾ç½®ä¸º<code>Keep-Alive</code>ï¼ŒæœåŠ¡å™¨å¯ä»¥è‡ªè¡Œå†³å®šæ˜¯å¦åœ¨æ¯ä¸ªå“åº”åå…³é—­è¿æ¥ï¼Œåœ¨å“åº”ä½“ä¸­åŒæ ·è®¾ç½®<code>Connection</code> ä¸º <code>Keep-Alive</code>å¯ä»¥è®©å®¢æˆ·ç«¯ä¿æŒè¿æ¥</p><p>åŸºäºè¿™ä¸ªæœºåˆ¶å°±å¯ä»¥å®ç°é•¿è½®è¯¢ã€SSE ç­‰æ•ˆæœ</p><h3 id="websocket">WebSocket</h3><p>WebSocket æ˜¯ä¸€ç§æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ï¼ŒåŒæ ·åŸºäºTCP</p><p>å®ƒæä¾›äº†ä¸€ç§å®æ—¶ã€é«˜æ•ˆçš„åŒå‘é€šä¿¡æœºåˆ¶ï¼Œå…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œè€Œä¸éœ€è¦å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ŒWebSocketåè®®ç›¸å¯¹äºä¼ ç»Ÿçš„ HTTP åè®®æ›´é€‚åˆå®æ—¶é€šä¿¡å’Œå®æ—¶æ›´æ–°çš„åº”ç”¨åœºæ™¯</p><p>WebSocket ä¸æ˜¯ HTTP åè®®ï¼Œä½†æ˜¯éœ€è¦å…ˆä½¿ç”¨ HTTP åè®®è¿›è¡Œåè®®å‡çº§</p><p><strong>å¯¹æ¯”è¡¨æ ¼</strong></p><table><thead><tr class="header"><th>åè®®</th><th>é€šä¿¡æ¨¡å¼</th><th>åœºæ™¯</th></tr></thead><tbody><tr class="odd"><td>HTTP</td><td>å•å‘çŸ­è¿æ¥</td><td>è¯·æ±‚-å“åº”</td></tr><tr class="even"><td>HTTP SSE</td><td>å•å‘é•¿è¿æ¥</td><td>æœåŠ¡å™¨æ¨é€</td></tr><tr class="odd"><td>WebSocket</td><td>åŒå‘é•¿è¿æ¥</td><td>åŒå‘é€šä¿¡</td></tr></tbody></table><h2 id="åè®®ç»†èŠ‚">åè®®ç»†èŠ‚</h2><p>è¦è®¢é˜…æœåŠ¡å™¨äº‹ä»¶ï¼Œå®¢æˆ·ç«¯å‘å‡º GET è¯·æ±‚å¸¦æœ‰æŒ‡å®šçš„ headerï¼š</p><ul><li><strong>Accept</strong>ï¼š<code>text/event-stream</code>è¡¨ç¤ºå¯æ¥æ”¶äº‹ä»¶æµç±»å‹</li><li><strong>Cache-Control</strong>ï¼š<code>no-cache</code>ç¦ç”¨ä»»ä½•çš„äº‹ä»¶ç¼“å­˜</li><li><strong>Connection</strong>ï¼š<code>keep-alive</code>è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨æŒä¹…è¿æ¥</li></ul><p>æœåŠ¡å™¨åº”è¯¥ä½¿ç”¨ç›¸åº”çš„å“åº”æ¥ç¡®è®¤è®¢é˜…ï¼š</p><ul><li><strong>Content-Type</strong>ï¼š<code>text/event-stream;charset=UTF-8</code>è¡¨ç¤ºæ ‡å‡†è¦æ±‚çš„äº‹ä»¶çš„åª’ä½“ç±»å‹å’Œç¼–ç </li><li><strong>Transfer-Encoding</strong>ï¼š<code>chunked</code>è¡¨ç¤ºæœåŠ¡å™¨æµå¼ä¼ è¾“åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ï¼Œå› æ­¤å†…å®¹å¤§å°äº‹å…ˆæœªçŸ¥</li><li><strong>Connection</strong>ï¼š<code>keep-alive</code>è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨æŒä¹…è¿æ¥ï¼Œ</li><li><strong>Keep-Alive</strong>ï¼šä¾‹å¦‚<code>timeout=60</code>ï¼ŒæœåŠ¡ç«¯å‘ŠçŸ¥å®¢æˆ·ç«¯ä¿æŒè¿æ¥çš„æ—¶é•¿</li></ul><hr /><p><strong>æ•°æ®å†…å®¹</strong></p><p>äº‹ä»¶ä¹‹é—´ç”±ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš” <code>\n\n</code></p><p>æ¯ä¸ªäº‹ä»¶ç”±ä¸€ä¸ªæˆ–å¤šä¸ª <code>åç§°:å€¼</code> å­—æ®µç»„æˆï¼Œç”±å•ä¸ªæ¢è¡Œç¬¦<code>\n</code> åˆ†éš”</p><p><code>comment</code> å±æ€§åˆ™åªä¼šæœ‰<code>:å€¼</code>ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®ç‰¹å¾åˆ¤æ–­</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">id:<span class="keyword">this</span> <span class="keyword">is</span> id</span><br><span class="line">event:<span class="keyword">this</span> <span class="keyword">is</span> event name</span><br><span class="line">:<span class="keyword">this</span> <span class="keyword">is</span> comment</span><br><span class="line"><span class="keyword">data</span>:<span class="keyword">this</span> <span class="keyword">is</span> <span class="keyword">data</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">id:<span class="keyword">this</span> <span class="keyword">is</span> id</span><br><span class="line">event:<span class="keyword">this</span> <span class="keyword">is</span> event name</span><br><span class="line">:<span class="keyword">this</span> <span class="keyword">is</span> comment</span><br><span class="line"><span class="keyword">data</span>:<span class="keyword">this</span> <span class="keyword">is</span> <span class="keyword">data</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><h1 id="ç®€å•å®ç°">ç®€å•å®ç°</h1><h2 id="controller">Controller</h2><p>ä½¿ç”¨ Spring å®ç°ä¸€ä¸ª SSE æ¥å£ï¼ŒSpring MVC å·²ç»æä¾›äº†å¯¹ SSE çš„æ”¯æŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSEController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SSEService sseService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sse&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">streamEvents</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> sseService.giveMeASentence();</span><br><span class="line">            Stream.of(sentence.split(<span class="string">&quot;&quot;</span>)).forEach(c -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emitter.send(SseEmitter.event().data(String.valueOf(c)));</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(RandomUtil.randomInt(<span class="number">30</span>, <span class="number">100</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    emitter.completeWithError(e);</span><br><span class="line">                    log.error(<span class="string">&quot;SSE error&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            emitter.complete();</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬æ­¥éª¤ï¼š</p><ol type="1"><li>ä½¿ç”¨ <code>@RestController</code> æ³¨è§£åˆ›å»ºä¸€ä¸ª Controller</li><li>REST æ–¹æ³•è¿”å›ä¸€ä¸ª <code>SseEmitter</code>ï¼Œå¤„ç† GETè¯·æ±‚å¹¶äº§ç”Ÿæ–‡æœ¬/äº‹ä»¶æµ <code>text/event-stream</code></li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>SseEmitter</code>ï¼Œä¿å­˜å®ƒå¹¶ä»æ–¹æ³•ä¸­è¿”å›</li><li>å¼‚æ­¥çº¿ç¨‹æ“ä½œ<code>SseEmitter</code>ï¼Œå®ç°æœåŠ¡ç«¯çš„å¤šæ¬¡å“åº”å’Œå¯¹è¿æ¥çš„å…³é—­</li></ol><p>è¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿæ‰“å­—æœºæ•ˆæœï¼Œæ“ä½œ <code>SseEmitter</code> æ—¶åšäº†ä¸€ä¸ª sleepæ“ä½œï¼Œè·å–æ–‡æ¡ˆåæ‹†åˆ†è°ƒç”¨ <code>SseEmitter</code>ï¼Œå“åº”å®Œæˆåå…³é—­è¿æ¥</p><h2 id="service">Service</h2><p><code>SSEService</code> ä¸»è¦æ˜¯æä¾›ä¸€æ®µæ–‡æ¡ˆï¼Œè¿™ä¸ªä¸é‡è¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSEService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; SENTENCES = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;æˆåŠŸä¸æ˜¯æœ€ç»ˆçš„ï¼Œå¤±è´¥ä¸æ˜¯è‡´å‘½çš„ï¼Œå‹‡æ°”ç»§ç»­å‰è¿›æ‰æ˜¯æœ€é‡è¦çš„ã€‚ â€”â€”â€”â€” ä¸˜å‰å°”&quot;</span>);</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;ç”Ÿæ´»å°±åƒéª‘è‡ªè¡Œè½¦ï¼Œä½ å¿…é¡»ä¿æŒå‰è¿›æ‰èƒ½ä¿æŒå¹³è¡¡ã€‚ â€”â€”â€”â€” çˆ±å› æ–¯å¦&quot;</span>);</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;æˆåŠŸçš„å…³é”®æ˜¯æŠŠæ¡æœºä¼šçš„èƒ½åŠ› â€”â€”â€”â€” çˆ±è¿ªç”Ÿ&quot;</span>);</span><br><span class="line">        SENTENCES.add(<span class="string">&quot;ä¸ç®¡ä½ èµ°äº†å¤šè¿œï¼Œå†³å®šè½¬èº«æ€»æ˜¯ä½ è‡ªå·± â€”â€”â€”â€” é©¬ä¸Â·è·¯å¾·Â·é‡‘&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">giveMeASentence</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SENTENCES.get(RandomUtil.randomInt(SENTENCES.size()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h2><p>æ¯”å¦‚å‰ç«¯ç­‰ï¼Œå¯ä»¥åˆ¶ä½œå‡ºæ‰“å­—æœºçš„æ•ˆæœ</p><p>è¿™é‡Œç®€å•ä½¿ç”¨ Java çš„ <code>print</code> æ“ä½œæ¥æ¨¡æ‹Ÿå‡ºè¿™ç§æ•ˆæœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSEClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// SSE æ¥å£çš„ URL</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sseUrl</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/sse&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º URL å¯¹è±¡</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(sseUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å¼€ HTTP è¿æ¥</span></span><br><span class="line">        <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º GET</span></span><br><span class="line">        connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">        connection.setRequestProperty(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€è¯·æ±‚</span></span><br><span class="line">        connection.connect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥å“åº”ç </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">responseCode</span> <span class="operator">=</span> connection.getResponseCode();</span><br><span class="line">        <span class="keyword">if</span> (responseCode == HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">            <span class="comment">// ä»è¿æ¥ä¸­è·å–è¾“å…¥æµ</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(connection.getInputStream()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯»å– SSE äº‹ä»¶æ•°æ®</span></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç† SSE äº‹ä»¶æ•°æ®</span></span><br><span class="line">                <span class="keyword">if</span> (line.length() &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">eventData</span> <span class="operator">=</span> line.substring(<span class="number">5</span>).trim();</span><br><span class="line">                System.out.print(eventData);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å…³é—­è¾“å…¥æµ</span></span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Failed to connect to SSE endpoint. Response code: &quot;</span> + responseCode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–­å¼€è¿æ¥</span></span><br><span class="line">        connection.disconnect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•ˆæœ">æ•ˆæœ</h2><img src="/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/HTTP%20Server-Sent%20Events%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/%E5%8A%A8%E7%94%BB.gif" class="" title="åŠ¨ç”»"><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://zhuanlan.zhihu.com/p/444011262?utm_id=0">SSEï¼ˆServer-SendEventsï¼‰å®æˆ˜ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è§„åˆ™å¼•æ“ç®€å•ä»‹ç»</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»">ä»‹ç»</h1><blockquote><p>å¦‚æœä½ ä¸€ç›´åœ¨å¼€å‘ä¸€ç§äº§å“æˆ–ä¸šåŠ¡ï¼Œé‚£ä¹ˆç»å¸¸å‘ç”Ÿçš„åœºæ™¯å°±æ˜¯ä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ï¼›å¼€å‘äººå‘˜åŸºäºä¸€ç»„æ¡ä»¶æ„å»ºè§£å†³æ–¹æ¡ˆï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™äº›é€»è¾‘æ¡ä»¶å¯èƒ½ä¼šå› ä¸šåŠ¡éœ€æ±‚æˆ–å…¶ä»–å¤–éƒ¨å¸‚åœºå› ç´ çš„å˜åŒ–è€Œå‘ç”Ÿæ”¹å˜</p><p>è§„åˆ™å¼•æ“æ˜¯è§£å†³æ­¤ç±»é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•</p><p><ahref="https://www.mohitkhare.com/blog/guide-to-rule-engines/">Guide toRule Engines â€“ Mohit Khare</a></p><p>ç¾å›¢å¤–å–çš„ CRMä¸šåŠ¡æ­¥å…¥æˆç†ŸæœŸï¼Œè§„åˆ™ç±»éœ€æ±‚å‡ ä¹æ’‘èµ·äº†è¿™ä¸ªä¸šåŠ¡æ‰€æœ‰éœ€æ±‚çš„åŠè¾¹å¤©ï¼›ä¸€æ–¹é¢è§„åˆ™å”¯ä¸€ä¸å˜çš„æ˜¯â€œå¤šå˜â€ï¼Œå¦ä¸€æ–¹é¢å¼€å‘å›¢é˜Ÿå¯¹ â€œè§„åˆ™å¼€å‘â€çš„æ„Ÿå—æ˜¯ä¹å‘³ã€ç–²æƒ«å’Œç¼ºä¹æŠ€æœ¯å«é‡</p><p>å¦‚ä½•è§£å†³è§„åˆ™å¼€å‘çš„æ•ˆç‡é—®é¢˜ï¼Œæœ€å¤§åŒ–è§£æ”¾å¼€å‘å›¢é˜Ÿæˆä¸ºç›®å‰çš„ä¸€ä¸ª KPI</p><p><ahref="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“- ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a></p></blockquote><h2 id="ä»€ä¹ˆæ˜¯è§„åˆ™å¼•æ“">ä»€ä¹ˆæ˜¯è§„åˆ™å¼•æ“</h2><p>ä¸šåŠ¡è§„åˆ™å¼•æ“æ˜¯åœ¨æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªä¸šåŠ¡è§„åˆ™çš„ç³»ç»Ÿï¼Œè¿™äº›è§„å®šå¯èƒ½æ¥è‡ªå„ç§ä¸šåŠ¡è§„åˆ™ï¼š</p><ul><li>å‘˜å·¥å¯ä»¥å› ä»»ä½•åŸå› æˆ–æ— åŸå› è¢«è§£é›‡ï¼Œä½†ä¸èƒ½å› éæ³•åŸå› </li><li>æ‰€æœ‰ä¸€æ¬¡æ€§æ¶ˆè´¹è¶…è¿‡ 100 ç¾å…ƒçš„å®¢æˆ·éƒ½å°†è·å¾— 10% çš„æŠ˜æ‰£</li></ul><p>ä¸šåŠ¡è§„åˆ™ç³»ç»Ÿä½¿è¿™äº›å€¾å‘äºè¿è¥å†³ç­–ã€å…¬å¸ç­–ç•¥çš„è§„åˆ™èƒ½å¤Ÿä¸åº”ç”¨ç¨‹åºä»£ç åˆ†å¼€å®šä¹‰ã€æµ‹è¯•ã€æ‰§è¡Œå’Œç»´æŠ¤ï¼›è§„åˆ™é›†ç”¨äºæ£€æŸ¥æ¡ä»¶å¹¶é€‰æ‹©åˆé€‚çš„ä¸šåŠ¡æ‰§è¡Œæ“ä½œ</p><p>è§„åˆ™å¯ä»¥ç®€å•æŠ½è±¡ä¸ºå¦‚ä¸‹ç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">When</span><br><span class="line">   &lt;Condition is <span class="literal">true</span>&gt;</span><br><span class="line">Then</span><br><span class="line">   &lt;Take desired Action&gt;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ä¸€ä¸ªæä¾›æŠ˜æ‰£ä¼˜æƒ çš„è§„åˆ™</p><p><strong>æ¡ä»¶ï¼š</strong>å½“ç”¨æˆ·æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶</p><ul><li>è‡³å°‘ä¸‹å•è¿‡ 10 ä¸ªè®¢å•</li><li>å¹³å‡è®¢å•ä»·æ ¼å¤§äº 150 å…ƒ</li><li>ç”¨æˆ·å¹´é¾„åœ¨ 20 ~ 30</li></ul><p><strong>è¡Œä¸ºï¼š</strong>æä¾› 20% çš„æŠ˜æ‰£</p><p>è§„åˆ™å¼•æ“åœ¨è§£å†³é¢å‘ä¸šåŠ¡çš„é€»è¾‘æ—¶æ¯”è¾ƒæœ‰æ•ˆï¼Œè¿™äº›é€»è¾‘ä½¿ç”¨è®¸å¤šä¸šåŠ¡å±æ€§æ¥äº§ç”ŸæŸç§å†³ç­–</p><p>éš¾é“æˆ‘ä»¬ä¸èƒ½æŠŠè¿™ä¸ªé€»è¾‘åµŒå…¥æˆ‘ä»¬çš„ä»£ç ä¸­å—ï¼Ÿå¯ä»¥è¿™æ ·åšï¼Œä½†è§„åˆ™åŒ–æä¾›äº†ä¿®æ”¹æ¡ä»¶å’Œæ·»åŠ æ›´å¤šé€»è¾‘çš„çµæ´»æ€§ï¼›è¿™äº›æ¡ä»¶ä¹Ÿè®¸æ›´å¤šæ¥ç”±äº§å“æˆ–ä¸šåŠ¡äº§å‡ºï¼Œè¿™ä¼šè®©å®ƒä»¬æ›´åŠ å®¹æ˜“å˜æ›´ï¼Œä¹Ÿè®¸ä¸éœ€è¦ç”±å¼€å‘äººå‘˜è¿›è¡Œä¿®æ”¹</p><h2 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h2><p><ahref="https://github.com/hyperjumptech/grule-rule-engine#advantages-of-a-rule-engine">grule-rule-engine:Rule engine implementation in Golang Advantages of a Rule Engine</a></p><ul><li><strong>å£°æ˜å¼ç¼–ç¨‹</strong>ï¼ˆDeclarativeProgrammingï¼‰ï¼šè§„åˆ™å¯ä»¥å¾ˆå®¹æ˜“åœ°è¡¨è¾¾éš¾é¢˜çš„è§£å†³æ–¹æ¡ˆå¹¶è¿›è¡ŒéªŒè¯ï¼›ä¸ä»£ç ä¸åŒï¼Œè§„åˆ™æ˜¯ç”¨ä¸é‚£ä¹ˆå¤æ‚çš„è¯­è¨€ç¼–å†™çš„ï¼›ä¸šåŠ¡åˆ†æå¸ˆå¯ä»¥å¾ˆå®¹æ˜“åœ°é˜…è¯»å’ŒéªŒè¯ä¸€å¥—è§„åˆ™</li><li><strong>é€»è¾‘å’Œæ•°æ®åˆ†ç¦»</strong>ï¼ˆLogic and DataSeparationï¼‰ï¼šæ•°æ®é©»ç•™åœ¨åŸŸå¯¹è±¡ä¸­ï¼ˆDomainObjectsï¼‰ï¼Œä¸šåŠ¡é€»è¾‘é©»ç•™åœ¨è§„åˆ™ä¸­ï¼ˆRulesï¼‰ï¼›æ ¹æ®é¡¹ç›®çš„ç±»å‹ï¼Œè¿™ç§åˆ†ç¦»å¯èƒ½éå¸¸æœ‰åˆ©</li><li><strong>çŸ¥è¯†é›†ä¸­åŒ–</strong>ï¼ˆCentralization ofKnowledgeï¼‰ï¼šé€šè¿‡ä½¿ç”¨è§„åˆ™ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œçš„çŸ¥è¯†åº“ï¼ˆa repository ofknowledge | a knowledgebaseï¼‰ï¼›è¿™æ˜¯å•†ä¸šæ”¿ç­–çš„å”¯ä¸€çœŸç†ï¼›ç†æƒ³æƒ…å†µä¸‹è§„åˆ™æ˜¯å¯è¯»çš„ï¼Œå› æ­¤å®ƒä»¬ä¹Ÿå¯ä»¥ä½œä¸ºæ–‡æ¡£</li><li><strong>æ”¹å˜çš„æ•æ·æ€§</strong>ï¼ˆAgility ToChangeï¼‰ï¼šç”±äºä¸šåŠ¡è§„åˆ™å®é™…ä¸Šè¢«è§†ä¸ºæ•°æ®ï¼Œæ ¹æ®ä¸šåŠ¡çš„åŠ¨æ€æ€§è´¨è°ƒæ•´è§„åˆ™å˜å¾—å¾®ä¸è¶³é“ï¼›ä¸éœ€è¦åƒæ­£å¸¸çš„è½¯ä»¶å¼€å‘é‚£æ ·é‡æ–°æ„å»ºä»£ç æˆ–éƒ¨ç½²ï¼Œåªéœ€è¦æ¨å‡ºè§„åˆ™é›†å¹¶å°†å…¶åº”ç”¨äºçŸ¥è¯†åº“å³å¯</li></ul><h2 id="ä½¿ç”¨æ¡ˆä¾‹">ä½¿ç”¨æ¡ˆä¾‹</h2><p><ahref="https://github.com/hyperjumptech/grule-rule-engine#use-cases">grule-rule-engine:Rule engine implementation in Golang use-cases</a></p><p>ä½¿ç”¨è§„åˆ™å¼•æ“å¯ä»¥æ›´å¥½åœ°è§£å†³ä»¥ä¸‹æƒ…å†µï¼š</p><ul><li><strong>ä¸“å®¶ç³»ç»Ÿ</strong>ï¼ˆExpertSystemï¼‰ï¼šå¿…é¡»è¯„ä¼°äº‹å®ä»¥æä¾›æŸç§ç°å®ä¸–ç•Œçš„ç»“è®ºï¼›å¦‚æœä¸ä½¿ç”¨ RETEé£æ ¼çš„è§„åˆ™å¼•æ“ï¼Œå°±ä¼šç¼–å†™ä¸€ç»„ If/elseè¯­å¥çš„çº§è”é›†ï¼Œè€Œå¦‚ä½•è¯„ä¼°è¿™äº›è¯­å¥çš„ç»„åˆçš„æ’åˆ—å°†å¾ˆå¿«å˜å¾—æ— æ³•ç®¡ç†</li><li><strong>è¯„çº§ç³»ç»Ÿ</strong>ï¼ˆRatingSystemï¼‰ï¼šä¾‹å¦‚é“¶è¡Œç³»ç»Ÿå¯èƒ½å¸Œæœ›æ ¹æ®å®¢æˆ·çš„äº¤æ˜“è®°å½•ï¼ˆäº‹å®ï¼‰ä¸ºæ¯ä¸ªå®¢æˆ·åˆ›å»ºä¸€ä¸ªâ€œåˆ†æ•°â€ï¼›æˆ‘ä»¬å¯ä»¥æ ¹æ®ä»–ä»¬ä¸é“¶è¡Œäº’åŠ¨çš„é¢‘ç‡ã€è¿›å‡ºèµ„é‡‘çš„å¤šå°‘ã€æ”¯ä»˜è´¦å•çš„é€Ÿåº¦ã€ç´¯è®¡åˆ©æ¯çš„å¤šå°‘ã€ä¸ºè‡ªå·±æˆ–é“¶è¡Œèµšäº†å¤šå°‘ç­‰ç­‰æ¥æŸ¥çœ‹ä»–ä»¬çš„åˆ†æ•°å˜åŒ–ï¼Œéšåé“¶è¡Œå®¢æˆ·åˆ†æéƒ¨é—¨çš„ä¸“å®¶å¯ä»¥æ¥æä¾›äº‹å®å’Œè§„åˆ™çš„è¯´æ˜</li><li><strong>ç”µè„‘æ¸¸æˆ</strong>ï¼šç©å®¶çŠ¶æ€ã€å¥–åŠ±ã€æƒ©ç½šã€ä¼¤å®³ã€åˆ†æ•°å’Œæ¦‚ç‡ç³»ç»Ÿæ˜¯è§„åˆ™åœ¨å¤§å¤šæ•°ç”µè„‘æ¸¸æˆä¸­å‘æŒ¥é‡è¦ä½œç”¨çš„è®¸å¤šä¸åŒä¾‹å­</li><li><strong>åˆ†ç±»ç³»ç»Ÿ</strong>ï¼ˆClassificationSystemsï¼‰ï¼šä½¿ç”¨è§„åˆ™å¼•æ“ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ä¿¡ç”¨èµ„æ ¼ã€ç”Ÿç‰©åŒ–å­¦è¯†åˆ«ã€ä¿é™©äº§å“é£é™©è¯„ä¼°ã€æ½œåœ¨å®‰å…¨å¨èƒç­‰è¿›è¡Œåˆ†ç±»</li><li><strong>å»ºè®®ç³»ç»Ÿ</strong>ï¼ˆSuggestion Systemï¼‰ï¼šâ€œè§„åˆ™â€åªæ˜¯å¦ä¸€ç§æ•°æ®ï¼Œè¿™ä½¿å®ƒå¯ä»¥æˆä¸ºå¦ä¸€ä¸ªç¨‹åºçš„äº§å‡ºï¼›è¿™ä¸ªç¨‹åºå¯ä»¥æ˜¯å¦ä¸€ä¸ªä¸“å®¶ç³»ç»Ÿæˆ–äººå·¥æ™ºèƒ½ï¼Œè§„åˆ™å¯ä»¥ç”±å…¶ä»–ç³»ç»Ÿæ“çºµä»¥ä¾¿å¤„ç†å…³äºè§„åˆ™é›†é’ˆå¯¹ä¸šåŠ¡åŸŸæ–°å»ºæ¨¡å‹æ¥å¤„ç†æ–°çš„äº‹å®</li></ul><p>è¿˜æœ‰è®¸å¤šå…¶ä»–ç”¨ä¾‹å°†å—ç›Šäºè§„åˆ™å¼•æ“çš„ä½¿ç”¨ï¼Œä¸Šè¿°æƒ…å†µåªæ˜¯æ½œåœ¨æƒ…å†µä¸­çš„ä¸€å°éƒ¨åˆ†</p><p>ä¸è¿‡è§„åˆ™å¼•æ“å½“ç„¶ä¸æ˜¯é“¶å¼¹ï¼Œå­˜åœ¨è®¸å¤šæ›¿ä»£æ–¹æ¡ˆæ¥è§£å†³è½¯ä»¶ä¸­çš„ â€œçŸ¥è¯†â€é—®é¢˜ï¼Œå¹¶ä¸”åº”è¯¥åœ¨æœ€åˆé€‚çš„åœ°æ–¹ä½¿ç”¨è¿™äº›æ›¿ä»£æ–¹æ¡ˆï¼›ä¾‹å¦‚å¦‚æœä¸€ä¸ªç®€å•çš„ if/elseåˆ†æ”¯å°±è¶³å¤Ÿäº†ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ä½¿ç”¨è§„åˆ™å¼•æ“</p><p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šä¸€äº›è§„åˆ™å¼•æ“å®ç°éå¸¸æ˜‚è´µï¼Œä½†è®¸å¤šä¼ä¸šä»ä¸­è·å¾—äº†å¦‚æ­¤å¤šçš„ä»·å€¼ï¼Œä»¥è‡³äºè¿è¡Œå®ƒä»¬çš„æˆæœ¬å¾ˆå®¹æ˜“è¢«è¿™äº›ä»·å€¼æ‰€æŠµæ¶ˆï¼›å¯¹äºå³ä½¿æ˜¯ä¸­ç­‰å¤æ‚çš„åœºæ™¯ï¼Œå¼ºå¤§çš„è§„åˆ™å¼•æ“å¯¹äºè§£è€¦å›¢é˜Ÿå¹¶è§£å†³ä¸šåŠ¡å¤æ‚æ€§ä¹Ÿæœ‰æ˜¾è‘—çš„ä¼˜åŠ¿</p><div style="page-break-after: always;"></div><h2 id="å¼€æºç”Ÿæ€">å¼€æºç”Ÿæ€</h2><h3 id="drools">Drools</h3><p><a href="https://www.drools.org/learn/documentation.html">Drools -Documentation</a> Droolsä½¿ç”¨åŸºäºè§„åˆ™çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå…è®¸å¼€å‘äººå‘˜é€šè¿‡ç¼–å†™è§„åˆ™æ¥æè¿°åº”ç”¨ç¨‹åºä¸­çš„ä¸šåŠ¡é€»è¾‘</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><strong>åŸºäºè§„åˆ™çš„ç¼–ç¨‹æ¨¡å‹</strong>ï¼šDroolsä½¿ç”¨è§„åˆ™å¼•æ“æ¥ç¼–å†™ä¸šåŠ¡è§„åˆ™ï¼Œå…è®¸å¼€å‘äººå‘˜å°†ä¸šåŠ¡é€»è¾‘ä»åº”ç”¨ç¨‹åºä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä½¿å…¶æ›´åŠ çµæ´»å’Œæ˜“äºç»´æŠ¤</li><li><strong>æ”¯æŒå¤šç§è§„åˆ™æ ¼å¼</strong>ï¼šåŒ…æ‹¬<strong>DRL</strong>ï¼ˆ<em>Drools è§„åˆ™è¯­æ³•</em> | Drools RuleLanguageï¼‰ã€<strong>DSL</strong>ï¼ˆ<em>é¢†åŸŸç‰¹å®šè¯­æ³•</em> | DomainSpecific Languageï¼‰ï¼Œæ”¯æŒ OMG<sup>1</sup> æ ‡å‡†ä¸‹çš„<strong>DMN</strong>ï¼ˆ<em>å†³ç­–æ¨¡å‹ä¸ç¬¦å·</em> | Decision Model andNotationï¼‰ ï¼Œç”šè‡³æ•°æ®é¢†åŸŸ DMG<sup>2</sup> æ ‡å‡†çš„<strong>PMML</strong>ï¼ˆ<em>é¢„æµ‹æ¨¡å‹æ ‡è®°è¯­è¨€</em> | Predictive ModelMarkup Languageï¼‰</li><li><strong>å¤šè¯­è¨€æ”¯æŒ</strong>ï¼šDrools ä¸ä»…æ”¯æŒ Javaè¯­è¨€ï¼Œè¿˜æ”¯æŒå…¶ä»–ç¼–ç¨‹è¯­è¨€å¦‚ Python ç­‰</li><li><strong>å®Œå–„çš„ç”Ÿæ€</strong>ï¼šDrools ä¸‹ç”Ÿæ€ä¸°å¯Œï¼Œæ¶‰åŠå¤šç§å·¥å…·<ul><li><strong>Drools Engine</strong>ï¼šæ ¸å¿ƒ Drools è§„åˆ™å¼•æ“</li><li><strong>Drools and jBPM integration</strong>ï¼šè§„åˆ™å¼•æ“ Droolså’Œå·¥ä½œæµ jBPM æ•´åˆ</li><li><strong>Business CentralWorkbench<sup>3</sup></strong>ï¼šå¯è§†åŒ–å·¥ä½œå°</li><li><strong>KIE Execution Server</strong>ï¼šå¯ç”¨äºä½¿ç”¨ RESTã€JMS æˆ– Javaæ¥å£è¿œç¨‹æ‰§è¡Œè§„åˆ™çš„ç‹¬ç«‹æ‰§è¡ŒæœåŠ¡å™¨</li></ul></li><li><strong>è§„åˆ™æ’ä»¶</strong>ï¼šDRL è§„åˆ™æ–‡ä»¶æ’ä»¶é«˜äº®</li></ul><hr /><p>ç¼ºç‚¹ï¼š</p><blockquote><p><em>å¼€æº Drools ä»å…¥é—¨åˆ°æ”¾å¼ƒ</em> â€”â€”ã€Š<ahref="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“- ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a>ã€‹</p></blockquote><ul><li>ä¸šåŠ¡åˆ†æå¸ˆæ— æ³•ç‹¬ç«‹å®Œæˆè§„åˆ™é…ç½®ï¼šç”±äºè§„åˆ™ä¸»ä½“ DSL æ˜¯ç¼–ç¨‹è¯­è¨€ï¼ˆæ”¯æŒJava, Groovy, Python ç­‰ï¼‰ï¼Œå› æ­¤ä»ç„¶éœ€è¦å¼€å‘å·¥ç¨‹å¸ˆç»´æŠ¤</li><li>è§„åˆ™è§„æ¨¡å˜å¤§ä»¥åä¹Ÿä¼šå˜å¾—ä¸å¥½ç»´æŠ¤ï¼Œç›¸å¯¹ç¡¬ç¼–ç çš„ä¼˜åŠ¿ä¾¿ä¸å¤å­˜åœ¨</li><li>è§„åˆ™çš„è¯­æ³•ä»…é€‚åˆæ‰å¹³çš„è§„åˆ™ï¼Œå¯¹äºåµŒå¥—æ¡ä»¶è¯­ä¹‰ï¼ˆ<code>then</code>ä¸­åµŒå¥— <code>whenthen</code>å­å¥ï¼‰çš„è§„åˆ™åªèƒ½å°†æ¡ä»¶è¿›è¡Œç¬›å¡å°”ç§¯ç»„åˆä»¥åè¿›è¡Œé…ç½®ï¼Œä¸åˆ©äºç»´æŠ¤</li></ul><p>å¤‡æ³¨</p><blockquote><ol type="1"><li><p>OMG æ˜¯Object ManagementGroupçš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªå›½é™…æ€§çš„æŠ€æœ¯æ ‡å‡†ç»„ç»‡ï¼Œæˆç«‹äº 1989å¹´ï¼Œæ€»éƒ¨ä½äºç¾å›½é©¬è¨è¯¸å¡å·çš„ Needhamã€‚OMGçš„æˆå‘˜åŒ…æ‹¬è½¯ä»¶å’Œç¡¬ä»¶ä¾›åº”å•†ã€å·¥å…·æä¾›å•†ã€æœåŠ¡æä¾›å•†ã€ä¼ä¸šå’Œæ”¿åºœæœºæ„ç­‰ï¼Œæ—¨åœ¨æ¨åŠ¨å’Œåˆ¶å®šé¢å‘å¯¹è±¡æŠ€æœ¯çš„æ ‡å‡†å’Œè§„èŒƒ<a href="https://www.omg.org/spec/DMN">About the Decision Model andNotation Specification Version 1.4 (omg.org)</a></p></li><li><p>Data Mining Groupï¼ˆDMGï¼‰æ˜¯ä¸€ä¸ªéè¥åˆ©æ€§ç»„ç»‡ï¼Œæˆç«‹äº 1994å¹´ï¼Œæ—¨åœ¨æ¨åŠ¨æ•°æ®æŒ–æ˜å’ŒçŸ¥è¯†å‘ç°æŠ€æœ¯çš„å‘å±•å’Œåº”ç”¨ã€‚DMGçš„æˆå‘˜åŒ…æ‹¬æ•°æ®æŒ–æ˜å’Œæœºå™¨å­¦ä¹ é¢†åŸŸçš„ä¸“å®¶ã€å­¦è€…å’Œå·¥ä¸šç•Œä»£è¡¨ï¼Œè‡´åŠ›äºåˆ¶å®šå’Œæ¨å¹¿æ•°æ®æŒ–æ˜æ ‡å‡†å’Œè§„èŒƒ</p></li><li><p>Business Central Workbench GUI</p></li></ol><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230625034858176.png" class="" title="image-20230625034858176"></blockquote><h3 id="liteflow">LiteFlow</h3><p><a href="https://liteflow.yomahub.com/">LiteFlow(yomahub.com)</a></p><p>å¯ä»¥å°†ç€‘å¸ƒæµå¼çš„ä»£ç ï¼Œè½¬å˜æˆä»¥ç»„ä»¶ä¸ºæ ¸å¿ƒæ¦‚å¿µçš„ä»£ç ç»“æ„ï¼Œè¿™ç§ç»“æ„çš„å¥½å¤„æ˜¯å¯ä»¥ä»»æ„ç¼–æ’ï¼Œç»„ä»¶ä¸ç»„ä»¶ä¹‹é—´æ˜¯è§£è€¦çš„ï¼Œç»„ä»¶å¯ä»¥ç”¨è„šæœ¬æ¥å®šä¹‰ï¼Œç»„ä»¶ä¹‹é—´çš„æµè½¬å…¨é è§„åˆ™æ¥é©±åŠ¨</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><strong>è¯­æ³•ç®€å•</strong>ï¼šç»„ä»¶ç”±Javaï¼ˆç¡¬ç¼–ç ï¼‰æˆ–æ”¯æŒçš„è„šæœ¬è¯­è¨€è¿›è¡Œå¼€å‘ï¼Œè§„åˆ™ DSL è¯­æ³•å®šä¹‰ç®€å•ï¼Œç¬¦åˆSpring ç­‰ IOC æ¡†æ¶çš„å®¹å™¨æ€æƒ³ï¼Œæ˜“äºç†è§£</li><li><strong>æµç¨‹å›¾å¼ç¼–æ’</strong>ï¼šè§„åˆ™æè¿°ä½¿ç”¨æµç¨‹å›¾æ¨¡å¼ï¼Œè€Œä¸æ˜¯ Droolsçš„ <code>when...then</code>æ¨¡å¼ï¼Œè®©ç‰¹å®šæµç¨‹çš„ä»»åŠ¡ç¼–æ’æ›´åŠ æ¸…æ™°ã€çµæ´»</li><li><strong>å¹¶å‘ç¼–æ’</strong>ï¼šè§„åˆ™é€»è¾‘å¯ä»¥å¿«é€Ÿç¼–æ’ç»„ä»¶ä¹‹é—´çš„åŒæ­¥ã€å¼‚æ­¥å…³ç³»ï¼Œå¯ä»¥è‡ªå®šä¹‰æ‰§è¡Œçº¿ç¨‹æ± </li><li><strong>ä¸°å¯Œçš„è„šæœ¬ç»„ä»¶æ”¯æŒ</strong>ï¼šæ”¯æŒå¤šç§è„šæœ¬è¯­è¨€ï¼ˆGroovyï¼ŒJavascriptï¼ŒQLExpressï¼ŒPythonï¼ŒLuaï¼ŒAviatorï¼‰ï¼›é‡‡ç”¨SPIæœºåˆ¶è¿›è¡Œé€‰æ‹©è„šæœ¬æ¡†æ¶æ¥åŠ¨æ€ç¼–è¯‘è„šæœ¬ï¼›åŒæ—¶æ”¯æŒè§„åˆ™æ–‡ä»¶å†…å¤šè„šæœ¬è¯­è¨€æ··åˆä½¿ç”¨</li><li><strong>å¤šæ•°æ®æºå’Œçƒ­åˆ·æ–°</strong>ï¼šELè§„åˆ™å’Œè„šæœ¬ç»„ä»¶éƒ½æ”¯æŒå¤šç§æ•°æ®æºï¼ˆé¡¹ç›®å†…æ–‡ä»¶ã€æœ¬åœ°æ–‡ä»¶ã€ZKã€SQLã€Nacosã€Apolloç­‰æ•°æ®æºï¼‰ï¼ŒåŒæ—¶æ”¯æŒè‡ªå®šä¹‰å®ç°ç›¸å…³è§„åˆ™è§£æç±»<code>ClassXmlFlowELParser</code> ç­‰ï¼›æ”¯æŒå¹³æ»‘çƒ­åˆ·æ–°</li><li><strong>è¡¥å……åŠŸèƒ½ä¸°å¯Œ</strong>ï¼šæœ‰ä¸°å¯Œçš„å°åŠŸèƒ½æ”¯æŒ<ul><li>å£°æ˜å¼ç»„ä»¶</li><li>å‰ç½®ã€åç½®ç»„ä»¶ã€ç»„ä»¶åˆ‡é¢</li><li>ç»„ä»¶é‡è¯•</li><li>å¼‚å¸¸ã€æ­¥éª¤ä¿¡æ¯æ±‡æ€»</li></ul></li><li><strong>è§„åˆ™æ’ä»¶</strong>ï¼šåŒæ ·æ‹¥æœ‰è§„åˆ™é«˜äº®æ’ä»¶æ”¯æŒï¼Œä¹Ÿæ”¯æŒè„šæœ¬è¯­æ³•é«˜äº®</li></ul><p>å®˜æ–¹ä»‹ç»ï¼š<a href="è§„åˆ™å¼•æ“.assets/LiteFlowPPT.pptx"title="LiteFLow ä»‹ç» PPT">LiteFLow ä»‹ç» PPT</a></p><hr /><p>ç¼ºç‚¹ï¼š</p><ul><li>ç¼ºä¹å¤§èŒƒå›´ç”Ÿäº§è€ƒéªŒï¼Œç¤¾åŒºè¿­ä»£é€Ÿåº¦å’Œæˆç†Ÿäº§å“ç›¸æ¯”è¾ƒæ…¢</li><li>æµç¨‹å›¾å¼ç¼–æ’ä½¿ç»„ä»¶è§„åˆ™è°ƒæ•´éœ€è¦è€ƒè™‘å‰åå…³ç³»</li><li>ç”Ÿæ€ä¸å®Œå…¨ï¼Œæ²¡æœ‰ç®¡ç†å¹³å°ã€å¯è§†åŒ–ç¼–æ’å·¥å…·</li></ul><h3 id="ice">Ice</h3><p><a href="http://waitmoon.com/zh/">å¼€æºæ¡†æ¶å­¦ä¹ ä¸åˆ†äº« | ice(waitmoon.com)</a></p><p>Iceä½¿ç”¨å…¨æ–°çš„è®¾è®¡æ€æƒ³ï¼Œå¥‘åˆè§£è€¦å’Œå¤ç”¨çš„å±æ€§ï¼Œæ»¡è¶³æœ€å¤§çš„ç¼–æ’è‡ªç”±åº¦</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><strong>ç‹¬ç‰¹çš„è§„åˆ™ç¼–æ’æ€æƒ³</strong>ï¼šå¼•å…¥å…³ç³»èŠ‚ç‚¹çš„ä¸æˆ–éæ§åˆ¶æµç¨‹ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹å¯ä»¥æ›´å¥½çš„å¯¹æµç¨‹è¿›è¡Œæ§åˆ¶ï¼Œé¿å…æµç¨‹å‰åçš„ç»„ä»¶å½±å“ï¼Œé™ä½å¿ƒæ™ºè´Ÿæ‹…</li><li><strong>ç»„ä»¶çš„æ—¶é—´å±æ€§</strong>ï¼šç»„ä»¶å¤©ç„¶å¸¦æœ‰æ—¶é—´å±æ€§ï¼Œå¯ä»¥æ§åˆ¶æ‰§è¡Œç»„ä»¶ç”Ÿæ•ˆçš„æ—¶é—´èŒƒå›´ï¼ˆå¯¹äºæ´»åŠ¨ç±»é…ç½®éå¸¸æœ‰ç”¨ï¼‰</li><li><strong>ç»„ä»¶å‚æ•°</strong>ï¼šç»„ä»¶å‚æ•°ç”± Jsonæ ¼å¼çš„æ•°æ®è¿›è¡Œé…ç½®ï¼Œå¯¹äºåŒæ ·çš„ç»„ä»¶ä¸åŒçš„å‚æ•°ä¸éœ€è¦ä»ä¸šåŠ¡å…¥å£æˆ–è¿›è¡Œä¸­çš„Context è¿›è¡Œæ§åˆ¶</li><li><strong>å¯è§†åŒ–åå°é…ç½®</strong>ï¼šæ‹¥æœ‰å¯è§†åŒ–åå°é…ç½®ï¼Œå¯¹è§„åˆ™å’ŒèŠ‚ç‚¹è¿›è¡Œé…ç½®<a href="http://eg.waitmoon.com/">iceé…ç½®åå° (waitmoon.com)</a></li></ul><p>å®˜æ–¹ä»‹ç»ï¼š<a href="http://waitmoon.com/ice-logic/zh/">iceç¼–æ’é€»è¾‘</a></p><hr /><p>ç¼ºç‚¹ï¼š</p><ul><li>æ–°é¡¹ç›®ï¼Œçƒ­åº¦ä½ï¼Œæ¡ˆä¾‹å°‘</li><li>æ–‡æ¡£ç®€é™‹</li></ul><h3 id="aviator">Aviator</h3><p><ahref="https://github.com/killme2008/aviatorscript">killme2008/aviatorscript:A high performance scripting language hosted on the JVM.(github.com)</a></p><p>ä¸¥æ ¼æ¥è¯´ AviatorScript å¹¶ä¸æ˜¯ä¸€ä¸ªè§„åˆ™å¼•æ“ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯ä»¥ç¼–è¯‘ä¸º Javaå­—èŠ‚ç çš„è¡¨è¾¾å¼å¼•æ“</p><p>åœ¨ç¾å›¢çš„æŠ€æœ¯æ–‡ç« ä¸­ä½¿ç”¨è¯¥è„šæœ¬è¯­è¨€ä½œä¸ºè§„åˆ™æ¡†æ¶ä½¿ç”¨ï¼ˆå…·ä½“æ€ä¹ˆå®ç°ä¹Ÿçœ‹ä¸æ‡‚ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ”¯æŒè‡ªå®šä¹‰å‡½æ•°ï¼‰</p><p>AviatorScript çš„ä¼˜åŠ¿</p><ul><li><p><strong>é«˜æ€§èƒ½</strong>ï¼šå°†è¡¨è¾¾å¼ç›´æ¥ç¿»è¯‘æˆå¯¹åº”çš„ Javaå­—èŠ‚ç æ‰§è¡Œï¼Œç¼–è¯‘ä¼˜å…ˆæ¨¡å¼åªæ‰«ä¸€éï¼Œä¿è¯äº†æ€§èƒ½è¶…è¶Šç»å¤§éƒ¨åˆ†è§£é‡Šæ€§çš„è¡¨è¾¾å¼å¼•æ“</p></li><li><p><strong>è½»é‡çº§</strong>ï¼šå…¶æ¬¡ï¼Œé™¤äº†ä¾èµ–<code>commons-beanutils</code>è¿™ä¸ªåº“ä¹‹å¤–ï¼ˆç”¨äºåšåå°„ï¼‰ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼Œå› æ­¤æ•´ä½“éå¸¸è½»é‡çº§ï¼Œæ•´ä¸ª jaråŒ…å¤§å°å“ªæ€•å‘å±•åˆ°ç°åœ¨ 5.0 è¿™ä¸ªå¤§ç‰ˆæœ¬ï¼Œä¹Ÿæ‰ 430K</p></li><li><p><strong>å¼€æ”¾èƒ½åŠ›</strong>ï¼šAviatorå†…ç½®çš„å‡½æ•°åº“éå¸¸èŠ‚åˆ¶ï¼Œé™¤äº†å¿…é¡»çš„å­—ç¬¦ä¸²å¤„ç†ã€æ•°å­¦å‡½æ•°å’Œé›†åˆå¤„ç†ä¹‹å¤–åªèƒ½è‡ªå®šä¹‰å‡½æ•°å®ç°ï¼Œä¿è¯äº†å®‰å…¨æ€§</p></li><li><p><strong>ç‰¹è‰²</strong>ï¼š</p><ul><li><p>æ”¯æŒè¿ç®—ç¬¦é‡è½½</p></li><li><p>åŸç”Ÿæ”¯æŒå¤§æ•´æ•°å’Œ <code>BigDecimal</code>ç±»å‹åŠè¿ç®—ï¼Œå¹¶ä¸”é€šè¿‡è¿ç®—ç¬¦é‡è½½å’Œä¸€èˆ¬æ•°å­—ç±»å‹ä¿æŒä¸€è‡´çš„è¿ç®—æ–¹å¼</p></li><li><p>åŸç”Ÿæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ç±»å‹åŠåŒ¹é…è¿ç®—ç¬¦ <code>=~</code></p></li><li><p>ç±» <code>clojure</code> çš„ <code>seq</code> åº“åŠ lambdaæ”¯æŒï¼Œå¯ä»¥çµæ´»åœ°å¤„ç†å„ç§é›†åˆ</p></li></ul></li></ul><p><strong>ç¾å›¢æ–‡ç« ä¸­ä½¿ç”¨ Aviator å¯¹å‡½æ•°çš„æ‰©å±•</strong></p><blockquote><p>è‡ªå®šä¹‰å‡½æ•°å¯ä»¥æ‰©å…… AviatoråŠŸèƒ½ï¼Œè§„åˆ™å¼•æ“å¯é€šè¿‡è‡ªå®šä¹‰å‡½æ•°æ‰§è¡Œå› å­åŠè§„åˆ™æ¡ä»¶</p><p>å¦‚è°ƒç”¨ç”¨æˆ·ç”»åƒç­‰ç¬¬ä¸‰æ–¹æœåŠ¡</p></blockquote><table><colgroup><col style="width: 12%" /><col style="width: 31%" /><col style="width: 56%" /></colgroup><thead><tr class="header"><th>åç§°</th><th>ç¤ºä¾‹</th><th>å«ä¹‰</th></tr></thead><tbody><tr class="odd"><td>equals</td><td>equals(message.orderType, 0)</td><td>åˆ¤æ–­è®¢å•ç±»å‹æ˜¯å¦ä¸º 0</td></tr><tr class="even"><td>filter</td><td>filter(browseList, 'source', 'dp')</td><td>è¿‡æ»¤ç‚¹è¯„ä¾§æµè§ˆåˆ—è¡¨æ•°æ®</td></tr><tr class="odd"><td>poiPortrait</td><td>poiPortrait(message.poiId)</td><td>æ ¹æ® poiId è·å–å•†æˆ·ç”»åƒæ•°æ®ï¼Œå¦‚å•†æˆ·æ˜Ÿçº§å±æ€§</td></tr><tr class="even"><td>userPortrait</td><td>userPortrait(message.userId)</td><td>æ ¹æ® userId è·å–ç”¨æˆ·ç”»åƒæ•°æ®ï¼Œå¦‚ç”¨æˆ·å¸¸ä½åœ°åŸå¸‚ã€ç”¨æˆ·æ–°è€å®¢å±æ€§</td></tr><tr class="odd"><td>userBlackList</td><td>userBlackList(message.userId)</td><td>æ ¹æ® userId åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸ºé»‘åå•ç”¨æˆ·</td></tr></tbody></table><h3 id="grule">Grule</h3><p><ahref="https://github.com/hyperjumptech/grule-rule-engine">hyperjumptech/grule-rule-engine:Rule engine implementation in Golang (github.com)</a></p><p>Grule æ˜¯ Goï¼ˆGolangï¼‰ç¼–ç¨‹è¯­è¨€çš„è§„åˆ™å¼•æ“åº“ï¼Œçµæ„Ÿæ¥è‡ªå¹¿å—å¥½è¯„çš„ JBOSSDroolsï¼Œå¹¶ä»¥æ›´ç®€å•çš„æ–¹å¼å®Œæˆ</p><p>ä¸ Drools ä¸€æ ·ï¼ŒGrule ä¹Ÿæœ‰è‡ªå·±çš„ DSL æˆ–é¢†åŸŸç‰¹å®šè¯­è¨€</p><h2 id="åº”ç”¨æƒ…å†µ">åº”ç”¨æƒ…å†µ</h2><ul><li>ç¾å›¢ <ahref="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“- ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a> <ahref="https://juejin.cn/post/6844903593326182414">å¤§æ•°æ®ï¼šç¾å›¢é…’æ—…å®æ—¶æ•°æ®è§„åˆ™å¼•æ“åº”ç”¨å®è·µ</a><ul><li>å¤–å–ä¸šåŠ¡ç»©æ•ˆæŒ‡æ ‡</li><li>ç¾å›¢ç‚¹è¯„é…’æ—…å®æ—¶è§¦è¾¾</li></ul></li><li>äº¬ä¸œ <ahref="https://juejin.cn/post/7216143702123987005">å±¥çº¦æ ¸å¿ƒå¼•æ“ä½ä»£ç åŒ–åŸç†ä¸å®è·µ- æ˜é‡‘</a><ul><li>è®¢å•ç”Ÿäº§å±¥çº¦</li></ul></li><li>è´§æ‹‰æ‹‰ <ahref="https://juejin.cn/post/7195452429154910263">è´§æ‹‰æ‹‰å¤§æ•°æ®åŸºäºè§„åˆ™å¼•æ“æ„å»ºè¿åŠ›èµ„æºä¾›éœ€è°ƒèŠ‚ç³»ç»Ÿ</a><ul><li>å¤§æ•°æ®ï¼Œè¿åŠ›ä¾›éœ€å¹³è¡¡</li></ul></li><li>é›ªçƒ <ahref="https://juejin.cn/post/7234763686475219003">è§„åˆ™å¼•æ“åœ¨å†…å®¹ç®¡ç†ä¸­çš„æ¢ç´¢ä¸åº”ç”¨</a><ul><li>å†…å®¹é£æ§</li></ul></li><li>é™Œé™Œ <ahref="https://github.com/momosecurity/aswan">momosecurity/aswan:é™Œé™Œé£æ§ç³»ç»Ÿé™æ€è§„åˆ™å¼•æ“ï¼Œé›¶åŸºç¡€ç®€æ˜“ä¾¿æ·çš„é…ç½®å¤šç§å¤æ‚è§„åˆ™ï¼Œå®æ—¶é«˜æ•ˆç®¡æ§ç”¨æˆ·å¼‚å¸¸è¡Œä¸ºã€‚(github.com)</a><ul><li>ç”¨æˆ·é£æ§</li></ul></li></ul><p>å„ç§å·¥å…·ã€äº‘æœåŠ¡å…¶å®ä¹Ÿç¦»ä¸å¼€å„ç§è§„åˆ™é…ç½®</p><p><strong>Octopus å‘Šè­¦è§„åˆ™</strong> <img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230627104922361.png" class="" title="image-20230627104922361"></p><p><strong>Sentry Alert Rule</strong> <img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230627105038925.png" class="" title="image-20230627105038925"></p><p><strong>é˜¿é‡Œäº‘ç‰©è”ç½‘å¹³å°</strong></p><p><ahref="https://help.aliyun.com/document_detail/42733.html?spm=a2c4g.42733.0.i3">é˜¿é‡Œäº‘ç‰©è”ç½‘å¹³å°- è®¾ç½®æ•°æ®æµè½¬è§„åˆ™ (aliyun.com)</a></p><p><strong>CDN</strong></p><p><ahref="https://help.aliyun.com/document_detail/424607.html?spm=5176.21213303.J_6704733920.7.1c1453c9rubSy5">é˜¿é‡Œäº‘CDN - è§„åˆ™å¼•æ“</a></p><h1 id="è§„åˆ™ç¼–æ’æ€æƒ³">è§„åˆ™ç¼–æ’æ€æƒ³</h1><p>è§„åˆ™å¼•æ“çš„æ ¸å¿ƒä¹‹ä¸€å°±åœ¨äºè§„åˆ™çš„ç¼–æ’æ–¹å¼ï¼Œä¸Šé¢çš„å¼€æºæ¡†æ¶ã€å·¥å…·éƒ½æœ‰å…¶ä¸åŒçš„è§„åˆ™ç¼–æ’æ€æƒ³</p><p>è¿™é‡Œå°±å•ç‹¬èŠä¸€èŠä¸åŒå·¥å…·çš„ä¸åŒè§„åˆ™è¡¨è¾¾</p><h2 id="when-...-then">when ... then</h2><p><em>ä»£è¡¨ï¼šDroolsã€Grule</em></p><p><code>when ... then</code>æ˜¯æœ€å…¸å‹çš„è§„åˆ™ç¼–æ’æ€æƒ³ï¼Œä¸€ç»„è§„åˆ™ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>LHSï¼ˆLeft Hand Sideï¼‰ï¼šæ¡ä»¶åˆ†æ”¯é€»è¾‘</li><li>RHSï¼ˆRight Hand Sideï¼‰ï¼šæ‰§è¡Œé€»è¾‘</li></ul><blockquote><p>The <code>when</code> part of a DRL rule (also known as the <em>LeftHand Side (LHS)</em> of the rule) contains the conditions that must bemet to execute an action.</p><p>The <code>then</code> part of the rule (also known as the <em>RightHand Side (RHS)</em> of the rule) contains the actions to be performedwhen the conditional part of the rule has been met.</p></blockquote><p>Drools è§„åˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;SpeedUp&quot;</span></span><br><span class="line">    salience <span class="number">10</span></span><br><span class="line">    when</span><br><span class="line">        $TestCar : TestCarClass( speedUp == <span class="literal">true</span> &amp;&amp; speed &lt; maxSpeed )</span><br><span class="line">        $DistanceRecord : DistanceRecordClass()</span><br><span class="line">    then</span><br><span class="line">        $TestCar.setSpeed($TestCar.Speed + $TestCar.SpeedIncrement);</span><br><span class="line">        update($TestCar);</span><br><span class="line">        $DistanceRecord.setTotalDistance($DistanceRecord.getTotalDistance() + $TestCar.Speed);</span><br><span class="line">        update($DistanceRecord);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>Grule è§„åˆ™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule SpeedUp <span class="string">&quot;When testcar is speeding up we keep increase the speed.&quot;</span> salience <span class="number">10</span>  &#123;</span><br><span class="line">    when</span><br><span class="line">        TestCar.SpeedUp == <span class="literal">true</span> &amp;&amp; TestCar.Speed &lt; TestCar.MaxSpeed</span><br><span class="line">    then</span><br><span class="line">        TestCar.Speed = TestCar.Speed + TestCar.SpeedIncrement;</span><br><span class="line">        DistanceRecord.TotalDistance = DistanceRecord.TotalDistance + TestCar.Speed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>when ... then</code>çš„å½¢å¼é€‚åˆå¤§é‡äº‹å®å¯¹è±¡è¿›å…¥ç„¶åè¿›è¡Œå¤§é‡è§„åˆ™çš„åŒ¹é…ã€æ‰§è¡Œæ“ä½œ</p><p>æ•´ä¸ªè§„åˆ™æ˜¯å¹³é“ºå¼çš„ï¼Œå¯ä»¥ä½¿ç”¨è¡¨æ ¼æ¥è¿›è¡Œå±•ç¤ºï¼ˆä¸‹é¢å°±è¦æåˆ° Droolsçš„å†³ç­–è¡¨æœºåˆ¶ï¼‰</p><p>ä¸é€‚åˆå¤„ç†å¸¦æœ‰æµç¨‹æ€§çš„è§„åˆ™</p><h2 id="å†³ç­–è¡¨-æ ‘">å†³ç­–è¡¨ Â æ ‘</h2><p><em>ä»£è¡¨ï¼šDrools</em></p><p>å†³ç­–è¡¨å…¶å®å°±æ˜¯å¦ä¸€ç§å½¢å¼çš„ <code>when ... then</code>è¡¨è¾¾ï¼Œä¹‹é—´å¯ä»¥äº’ç›¸è½¬æ¢ï¼›æ­¤å¤– Droolsè¿˜æ”¯æŒéå¸¸å¤šçš„è§„åˆ™å½¢å¼ï¼Œåœ¨è¿™é‡Œåˆ—ä¸¾ä¸€éƒ¨åˆ† <ahref="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/index.html#drools.AuthoringAssets">DroolsDocumentation#Authoring rule assets</a></p><figure><imgsrc="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/newItemMenu.png"alt="Authoring rule assets" /><figcaption aria-hidden="true">Authoring rule assets</figcaption></figure><h3 id="ç”µå­è¡¨æ ¼å†³ç­–è¡¨">ç”µå­è¡¨æ ¼å†³ç­–è¡¨</h3><p>Spreadsheet decision tables</p><p>ç”µå­è¡¨æ ¼å†³ç­–è¡¨æ˜¯åŒ…å«ä»¥è¡¨æ ¼æ ¼å¼å®šä¹‰çš„ä¸šåŠ¡è§„åˆ™çš„ XLS æˆ– XLSXç”µå­è¡¨æ ¼</p><p>å†³ç­–è¡¨ä¸­çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€æ¡è§„åˆ™ï¼Œæ¯ä¸€åˆ—éƒ½æ˜¯ä¸€ä¸ªæ¡ä»¶ã€ä¸€ä¸ªæ“ä½œæˆ–å¦ä¸€ä¸ªè§„åˆ™å±æ€§ï¼›åˆ›å»ºå¹¶ä¸Šä¼ ç”µå­è¡¨æ ¼å†³ç­–è¡¨åï¼Œå®šä¹‰çš„è§„åˆ™å°†ä¸æ‰€æœ‰å…¶ä»–è§„åˆ™èµ„äº§ä¸€æ ·è¢«ç¼–è¯‘ä¸ºDRL è§„åˆ™</p><p><imgsrc="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/decision-table-example-02.png" /></p><p><imgsrc="https://img-blog.csdnimg.cn/18216cde2ef74a6aa4fbed071c4aad89.png#pic_center" /></p><p>ä¸Šé¢çš„å†³ç­–è¡¨ä¾‹å­è½¬æ¢ä¸º DRL æ ¼å¼çš„è§„åˆ™æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rules.excels;</span><br><span class="line"><span class="comment">//generated from Decision Table</span></span><br><span class="line"><span class="keyword">import</span> com.ppl.demo.entity.Account;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line">global List&lt;String&gt; list;</span><br><span class="line"><span class="comment">// rule values at B11, header at B6</span></span><br><span class="line">rule <span class="string">&quot;ExcelTable_11&quot;</span></span><br><span class="line">salience <span class="number">65535</span></span><br><span class="line">agenda-group <span class="string">&quot;rule-group-001&quot;</span></span><br><span class="line">when</span><br><span class="line">$account: Account(sex != <span class="string">&quot;å¥³&quot;</span>)</span><br><span class="line">then</span><br><span class="line">list.add(<span class="string">&quot;æ€§åˆ«ä¸å¯¹&quot;</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">// rule values at B12, header at B6</span></span><br><span class="line">rule <span class="string">&quot;ExcelTable_12&quot;</span></span><br><span class="line">salience <span class="number">65534</span></span><br><span class="line">agenda-group <span class="string">&quot;rule-group-001&quot;</span></span><br><span class="line">when</span><br><span class="line">$account: Account(age &lt; <span class="number">22</span> || age&gt; <span class="number">28</span>)</span><br><span class="line">then</span><br><span class="line">list.add(<span class="string">&quot;å¹´é¾„ä¸åˆé€‚&quot;</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">// rule values at B13, header at B6</span></span><br><span class="line">rule <span class="string">&quot;ExcelTable_13&quot;</span></span><br><span class="line">salience <span class="number">65533</span></span><br><span class="line">agenda-group <span class="string">&quot;rule-group-002&quot;</span></span><br><span class="line">when</span><br><span class="line">$account: Account(balance &lt; <span class="number">1000</span>)</span><br><span class="line">then</span><br><span class="line">list.add(<span class="string">&quot;å·¥èµ„å¤ªä½&quot;</span>);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="å¼•å¯¼å¼å†³ç­–è¡¨">å¼•å¯¼å¼å†³ç­–è¡¨</h3><p>Guided decision tables</p><p>Drools æ”¯æŒä¸¤ç§ç±»å‹çš„å†³ç­–è¡¨ï¼šæ‰©å±•æ¡ç›®è¡¨ï¼ˆExtendedentryï¼‰å’Œæœ‰é™æ¡ç›®è¡¨ï¼ˆLimited entryï¼‰</p><ul><li><p><strong>æ‰©å±•æ¡ç›®è¡¨</strong>ï¼šæ‰©å±•æ¡ç›®å†³ç­–è¡¨æ˜¯åˆ—å®šä¹‰æŒ‡å®šPatternã€Field å’Œ Operatorä½†ä¸æŒ‡å®šå€¼çš„å†³ç­–è¡¨ã€‚å€¼æˆ–çŠ¶æ€æœ¬èº«ä¿å­˜åœ¨å†³ç­–è¡¨çš„ä¸»ä½“ä¸­ <imgsrc="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/dtable-extended-entry.png"alt="æ‰©å±•æ¡ç›®è¡¨" /></p></li><li><p><strong>æœ‰é™æ¡ç›®è¡¨</strong>ï¼šé™¤äº† Patternã€Field å’Œ Operatorä¹‹å¤–ï¼ŒLimited Entry å†³ç­–è¡¨çš„åˆ—å®šä¹‰è¿˜ä¸ºå…¶æŒ‡å®šå€¼å†³ç­–è¡¨çŠ¶æ€ä¿å­˜åœ¨è¡¨çš„ä¸»ä½“ä¸­ï¼Œæ˜¯å¸ƒå°”å€¼ï¼Œå…¶ä¸­ trueå…·æœ‰åº”ç”¨æˆ–åŒ¹é…åˆ—çš„æ•ˆæœï¼›false è¡¨ç¤ºè¯¥åˆ—ä¸é€‚ç”¨</p><figure><imgsrc="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/dtable-limited-entry.png"alt="æœ‰é™æ¡ç›®è¡¨" /><figcaption aria-hidden="true">æœ‰é™æ¡ç›®è¡¨</figcaption></figure></li></ul><h3 id="å¼•å¯¼å¼å†³ç­–å›¾">å¼•å¯¼å¼å†³ç­–å›¾</h3><p>è™½ç„¶å¯ä»¥ç¼–å†™å•ä¸ªå¼•å¯¼å†³ç­–è¡¨ï¼Œä½†ä¹Ÿå¯ä»¥ç¼–å†™ç›¸å…³è¡¨çš„å›¾ï¼Œå…¶ä¸­ä¸€ä¸ªè¡¨çš„åŠ¨ä½œå¯ä»¥æä¾›å¦ä¸€ä¸ªè¡¨æ¡ä»¶çš„æ½œåœ¨åŒ¹é…ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è¡¨è¢«è®¤ä¸ºæ˜¯ç›¸å…³çš„</p><p><imgsrc="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/dtable-graph-radar.png" /></p><h3 id="å¼•å¯¼å¼å†³ç­–æ ‘">å¼•å¯¼å¼å†³ç­–æ ‘</h3><p>Business Central æ”¯æŒç¼–å†™ç®€å•çš„å†³ç­–æ ‘</p><p><imgsrc="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/Workbench/AuthoringAssets/GuidedDecisionTreeEditorCollapse1.png" /></p><p>http://49.235.87.129:8080/business-central</p><h2 id="æµç¨‹å›¾">æµç¨‹å›¾</h2><p><em>ä»£è¡¨ï¼šLiteFlow</em></p><p>LiteFlowçš„è§„åˆ™è¯­æ³•ç›¸å½“äºæ„é€ å‡ºä¸€ä¸ªæµç¨‹å›¾ï¼Œç»„ä»¶ä½œä¸ºèŠ‚ç‚¹ï¼Œè§„åˆ™æè¿°ç»„ä»¶é—´æ‰§è¡Œå…³ç³»ï¼š</p><ul><li>ä¸²è¡Œ <code>THEN</code></li><li>å¹¶è¡Œ <code>WHEN</code></li><li>é€‰æ‹© <code>SWITCH</code></li><li>æ¡ä»¶ <code>IF</code></li><li>å¾ªç¯<ul><li>for å¾ªç¯ <code>FOR...DO</code></li><li>while å¾ªç¯ <code>WHILE...DO</code></li><li>è¿­ä»£å™¨å¾ªç¯ <code>ITERATOR...DO</code></li><li>è·³å‡º <code>BREAK</code></li></ul></li><li>å¼‚å¸¸æ•è· <code>CATCH</code></li><li>å¼‚æˆ–éè¡¨è¾¾ <code>AND</code>ã€<code>OR</code>ã€<code>NOT</code></li></ul><figure><img src="https://liteflow.yomahub.com/img/flow_example/e10.svg"alt="LiteFlow å¤æ‚æµç¨‹ç¼–æ’" /><figcaption aria-hidden="true">LiteFlow å¤æ‚æµç¨‹ç¼–æ’</figcaption></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">    THEN(</span><br><span class="line">        A,</span><br><span class="line">        WHEN(</span><br><span class="line">            THEN(B, C),</span><br><span class="line">            THEN(D, E, F),</span><br><span class="line">            THEN(</span><br><span class="line">                SWITCH(G).to(</span><br><span class="line">                    THEN(H, I, WHEN(J, K)).id(&quot;t1&quot;),</span><br><span class="line">                    THEN(L, M).id(&quot;t2&quot;)</span><br><span class="line">                ),</span><br><span class="line">                N</span><br><span class="line">            )</span><br><span class="line">        ),</span><br><span class="line">        Z</span><br><span class="line">    );</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å­å˜é‡ä¼˜åŒ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">    item1 = THEN(B, C);</span><br><span class="line">    item2 = THEN(D, E, F);</span><br><span class="line">    item3_1 = THEN(H, I, WHEN(J, K)).id(&quot;t1&quot;);</span><br><span class="line">    item3_2 = THEN(L, M).id(&quot;t2&quot;);</span><br><span class="line">    item3 = THEN(SWITCH(G).to(item3_1, item3_2), N);</span><br><span class="line">    </span><br><span class="line">    THEN(</span><br><span class="line">        A,</span><br><span class="line">        WHEN(item1, item2, item3),</span><br><span class="line">        Z</span><br><span class="line">    );</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å…³ç³»æ§åˆ¶">å…³ç³»æ§åˆ¶</h2><p><em>ä»£è¡¨ï¼šice</em></p><blockquote><p>æµç¨‹å›¾å¼å’Œæ‰§è¡Œæ ‘å¼å®ç°çš„ä¸»è¦ç¼ºç‚¹åœ¨äºï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œæ”¹åŠ¨ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦ç»å‰é¡¾åï¼Œå¦‚æœè€ƒè™‘ä¸åˆ°ä½ï¼Œå¾ˆå®¹æ˜“å¼„é”™ï¼Œè€Œä¸”è¿™è¿˜åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œç°å®çš„æ´»åŠ¨å†…å®¹è¦æ¯”è¿™å¤æ‚çš„å¤šçš„å¤šï¼Œæ—¶é—´çº¿ä¹Ÿæ˜¯å¾ˆå¤šæ¡</p><p>å¾€å¾€å¾—ä¸å¿å¤±ï¼Œåˆ°å¤´æ¥å‘ç°è¿˜ä¸å¦‚ç¡¬ç¼–ç </p><p><a href="http://waitmoon.com/zh/guide/#å˜åŠ¨">é¡¹ç›®ç®€ä»‹ | ice(waitmoon.com)</a></p></blockquote><p>Ice çš„è§„åˆ™ç¼–æ’å¼ºè°ƒç»„ä»¶ç”Ÿæ•ˆæ—¶é—´å’Œè§„åˆ™ä¹‹é—´çš„å…³ç³»</p><p>Ice ä¸­åˆ†ä¸ºä¸¤ç§è§„åˆ™èŠ‚ç‚¹ï¼š</p><ul><li><strong>å…³ç³»èŠ‚ç‚¹</strong>ï¼šå…³ç³»èŠ‚ç‚¹ä¸ºäº†æ§åˆ¶ä¸šåŠ¡æµè½¬<ul><li>ANDï¼š<code>&amp;&amp;</code>ï¼Œåœ¨æ‰§è¡Œåˆ° false çš„åœ°æ–¹ç»ˆæ­¢æ‰§è¡Œ</li><li>ANYï¼š<code>||</code>ï¼Œåœ¨æ‰§è¡Œåˆ° true çš„åœ°æ–¹ç»ˆæ­¢æ‰§è¡Œ</li><li>ALLï¼šæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œï¼Œæ ¹æ®èŠ‚ç‚¹è¿”å›å€¼è¿›è¡Œä¸åŒçš„è¿”å›</li><li>NONEï¼šæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œï¼Œæ— è®ºå­èŠ‚ç‚¹è¿”å›ä»€ä¹ˆéƒ½è¿”å› none</li><li>TRUEï¼šæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œï¼Œæ— è®ºå­èŠ‚ç‚¹è¿”å›ä»€ä¹ˆï¼Œéƒ½è¿”å› true</li></ul></li><li><strong>å¶å­èŠ‚ç‚¹</strong>ï¼šå¶å­èŠ‚ç‚¹ä¸ºçœŸæ­£å¤„ç†çš„èŠ‚ç‚¹<ul><li>Flowï¼šä¸€äº›æ¡ä»¶ä¸è§„åˆ™èŠ‚ç‚¹ï¼Œå¦‚ä¾‹å­ä¸­çš„ ScoreFlow</li><li>Resultï¼šä¸€äº›ç»“æœæ€§è´¨çš„èŠ‚ç‚¹ï¼Œå¦‚ä¾‹å­ä¸­çš„AmountResultï¼ŒPointResult</li><li>Noneï¼šä¸€äº›ä¸å¹²é¢„æµç¨‹çš„åŠ¨ä½œï¼Œå¦‚è£…é…å·¥ä½œç­‰</li></ul></li></ul><hr /><p>æ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªä¾‹å­æ¥ä½“ç°è¿™æ ·ç¼–æ’è§„åˆ™çš„ä¼˜åŠ¿ï¼š</p><p>Xå…¬å¸å°†åœ¨å›½åº†æ”¾å‡æœŸé—´ï¼Œå¼€å±•ä¸€ä¸ªä¸ºæœŸä¸ƒå¤©çš„å……å€¼å°æ´»åŠ¨ï¼Œæ´»åŠ¨å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>æ´»åŠ¨æ—¶é—´ï¼ˆ10.1 - 10.7ï¼‰</li><li>æ´»åŠ¨å†…å®¹<ul><li>å……å€¼ 100 å…ƒ é€ 5 å…ƒä½™é¢ ï¼ˆ10.1 - 10.7ï¼‰</li><li>å……å€¼ 50 å…ƒ é€ 10 ç§¯åˆ† ï¼ˆ10.5 - 10.7ï¼‰</li><li>ä¸å åŠ é€ï¼ˆå……å€¼ 100 å…ƒåªèƒ½è·å¾— 5 å…ƒä½™é¢ï¼Œä¸ä¼šå åŠ èµ é€ 10 ç§¯åˆ†ï¼‰</li></ul></li></ul><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/ice%E4%BF%AE%E6%94%B9%E5%89%8D.png" class="" title="iceä¿®æ”¹å‰"><p>éœ€è¦å¯¹è§„åˆ™è¿›è¡Œè°ƒæ•´ï¼š</p><ol type="1"><li><p>å……å€¼ 100 å…ƒæ”¹æˆ 80ï¼Œ10 ç§¯åˆ†å˜ 20 ç§¯åˆ†ï¼Œæ—¶é—´æ”¹æˆ 10.8å·ç»“æŸ</p></li><li><p>å»æ‰ä¸å åŠ é€</p></li><li><p>5 å…ƒä½™é¢ä¸èƒ½é€å¤ªå¤šï¼Œè®¾ç½®ä¸ªåº“å­˜ 100 ä¸ªï¼›åº“å­˜ä¸è¶³å…… 100 å…ƒè¿˜æ˜¯å¾—é€10 ç§¯åˆ†</p></li></ol><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/ice%E4%BF%AE%E6%94%B9%E5%90%8E.png" class="" title="iceä¿®æ”¹å"><p>ä¼˜åŠ¿ï¼š</p><ul><li>å¯¹äº 1çš„æ”¹åŠ¨ï¼Œåªéœ€è¦ä¿®æ”¹èŠ‚ç‚¹é€»è¾‘ï¼ˆ<code>ScoreFlow</code>ã€<code>PointResult</code>ï¼‰</li><li>å¯¹äº 2 çš„æ”¹åŠ¨å°†å…¥å£çš„å…³ç³»èŠ‚ç‚¹ ANY ä¿®æ”¹ä¸º ALL</li><li>å¯¹äº 3 ç”±äºåº“å­˜çš„ä¸è¶³ï¼Œç›¸å½“äºæ²¡æœ‰ç»™ç”¨æˆ·å‘æ”¾ï¼Œåˆ™<code>AmountResult</code> è¿”å›falseï¼Œæµç¨‹è¿˜ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä¸ç”¨åšä»»ä½•æ›´æ”¹</li><li>å¼•å…¥ ALL èŠ‚ç‚¹åŠ <code>TimeChangeNone</code>æ¥ä¿®æ”¹æ—¶é—´ï¼Œæ–¹ä¾¿æµ‹è¯•</li></ul><blockquote><p><em>æ€è€ƒï¼šè§„åˆ™å¼•æ“åˆ°åº•æ˜¯ä»€ä¹ˆå½¢å¼</em></p><p><em>Droolsæˆ–è€…ä¼ ç»Ÿçš„è§„åˆ™å¼•æ“å€¾å‘äºå¤§é‡ä¸šåŠ¡è§„åˆ™ä¸‹çš„åŒ¹é…ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºå†³ç­–ï¼ˆDecisionï¼‰å¼•æ“</em></p><p><em>è€Œ LiteFlow æ›´åƒæ˜¯è®¾è®¡æ¨¡å¼çš„å»¶ä¼¸ï¼Œç»„ä»¶çš„æ‰§è¡Œç¼–æ’ï¼Œä½†æ˜¯ä¹Ÿç§°ä¸ºâ€œè§„åˆ™å¼•æ“â€</em></p></blockquote><h1 id="ä¸€äº›æ¦‚å¿µ">ä¸€äº›æ¦‚å¿µ</h1><h2 id="dsl">DSL</h2><p>DSLï¼ˆDomain SpecificLanguageï¼Œé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºè§£å†³ç‰¹å®šé¢†åŸŸé—®é¢˜çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹å®šé¢†åŸŸçš„ä¸“ç”¨è¯­è¨€ï¼Œé€šå¸¸å…·æœ‰ç®€å•ã€æ˜“ç”¨ã€é«˜æ•ˆç­‰ç‰¹ç‚¹ï¼›DSLçš„è¯­æ³•å’Œè¯­ä¹‰é€šå¸¸ä¸ç‰¹å®šé¢†åŸŸçš„é—®é¢˜å¯†åˆ‡ç›¸å…³ï¼Œå¯ä»¥å¤§å¤§ç®€åŒ–é—®é¢˜çš„è¡¨è¾¾å’Œè§£å†³</p><p>è¿™é‡Œä»¥ Drools ä¸ºä¾‹ï¼ŒDrools å¯ä»¥æ ¹æ®å®šä¹‰çš„ DSL æ–‡ä»¶å’Œ DSLRæ–‡ä»¶ï¼Œå°†å…¶è½¬æ¢ä¸º DRL è¡¨è¾¾</p><p><strong>DSL</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[&lt;scope&gt;][&lt;type definition&gt;]&lt;dsl expression&gt;=&lt;replacement text&gt;</span><br><span class="line">[when] or [condition] å®šä¹‰çš„è¯­æ³•åº”ç”¨äºLHS</span><br><span class="line">[then] or [consequence] å®šä¹‰çš„è¯­æ³•åº”ç”¨äºRHS</span><br><span class="line">[*]  ä»¥ä¸Šä¸¤è€…éƒ½é€‚ç”¨</span><br><span class="line">[keyword] å…³é”®å­—ï¼Œæ¯”å¦‚ no-loop è¿™ä¸€ç±»å±æ€§</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[when] There is <span class="type">a</span> <span class="variable">person</span> <span class="operator">=</span> $p:Person()</span><br><span class="line">[when] - id greater than &#123;id:\d*&#125; = id &gt; &#123;id&#125;</span><br><span class="line">[then] print = System.out.println(<span class="string">&quot;I am fired!&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>DSLR</strong></p><p>è¿™æ ·æ•´ä¸ª DSLR æ–‡ä»¶è®²ä½¿ç”¨è¯­ä¹‰åŒ–çš„è¡¨è¾¾æ¥æè¿°å­˜åœ¨ DSLå®šä¹‰çš„ç‰¹å®šé¢†åŸŸå†…è§„åˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&#x27;test-dsl&#x27;</span></span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">    There is a person</span><br><span class="line">    - id greater than <span class="number">10</span></span><br><span class="line">then</span><br><span class="line">    print</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>è½¬æ¢åçš„ DRL è§„åˆ™</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&#x27;test-dsl&#x27;</span></span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">    $p:Person(id &gt; <span class="number">10</span>)</span><br><span class="line">then</span><br><span class="line">    System.out.println(<span class="string">&quot;I am fired!&quot;</span>)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="dmn">DMN</h2><p>DMN å…¨ç§° Decision Model andNotationï¼ˆå†³ç­–æ¨¡å‹ä¸ç¬¦å·ï¼‰,æ˜¯ä¸€ç§ç”¨äºè¡¨ç¤ºä¸šåŠ¡å†³ç­–å’Œè§„åˆ™çš„è§„èŒƒï¼Œæ—¨åœ¨å¸®åŠ©å‚ä¸å†³ç­–çš„äººéƒ½èƒ½ç®€å•å¿«é€Ÿç†è§£å†³ç­–è¿‡ç¨‹</p><p>DMN æ˜¯ç”± OMG ç®¡ç†çš„ä¸€ç§è§„èŒƒï¼Œè¯¥ç»„ç»‡ä¸‹æ¯”è¾ƒçŸ¥åçš„è¿˜æœ‰ UML ç­‰</p><p>Drools å¯¹ DMN æœ‰è‰¯å¥½çš„æ”¯æŒï¼Œæ”¯æŒ DMN 1.3ï¼ŒåŠŸèƒ½å®Œå–„</p><p><ahref="https://github.com/kiegroup/kogito-examples">kiegroup/kogito-examples:Kogito examples - Kogito is a cloud-native business automationtechnology for building cloud-ready business applications.(github.com)</a></p><p><ahref="https://learn-dmn-in-15-minutes.com/learn/introduction">Learn DMNin 15 minutes | Introduction (learn-dmn-in-15-minutes.com)</a></p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/image-20230625000439860.png" class="" title="image-20230625000439860"><p>DMN ä¸­æ”¯æŒ FEEL è§„åˆ™è¡¨è¾¾å¼</p><p>è¶³å¤Ÿå‹å¥½çš„è¡¨è¾¾è¯­è¨€ï¼ˆFriendly Enough Expression Language ï¼‰FEELè¡¨è¾¾å¼å®šä¹‰äº† DMN æ¨¡å‹ä¸­å†³ç­–çš„é€»è¾‘ï¼ŒFEELæ—¨åœ¨é€šè¿‡ä¸ºå†³ç­–æ¨¡å‹ç»“æ„åˆ†é…è¯­ä¹‰æ¥ä¿ƒè¿›å†³ç­–å»ºæ¨¡å’Œæ‰§è¡Œ</p><p><ahref="https://kiegroup.github.io/dmn-feel-handbook/#dmn-feel-handbook">DMNFEEL handbook â€“ Drools DMN FEEL handbook (kiegroup.github.io)</a></p><div style="page-break-after: always;"></div><h2 id="cep">CEP</h2><p>CEP æ˜¯å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆComplex event processingï¼‰çš„ç¼©å†™</p><p>äº‹ä»¶æ˜¯æŸä¸ªæ—¶é—´ç‚¹åº”ç”¨ç¨‹åºåŸŸä¸­çŠ¶æ€å‘ç”Ÿé‡å¤§å˜åŒ–çš„è®°å½•ï¼Œæ ¹æ®åŸŸçš„å»ºæ¨¡æ–¹å¼ï¼ŒçŠ¶æ€çš„å˜åŒ–å¯ä»¥ç”±å•ä¸ªäº‹ä»¶ã€å¤šä¸ªåŸå­äº‹ä»¶æˆ–ç›¸å…³äº‹ä»¶çš„å±‚æ¬¡ç»“æ„è¡¨ç¤º</p><p>ä»å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰çš„è§’åº¦æ¥çœ‹ï¼Œäº‹ä»¶æ˜¯å‘ç”Ÿåœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„ä¸€ç§äº‹å®æˆ–å¯¹è±¡ï¼Œè€Œä¸šåŠ¡è§„åˆ™æ˜¯å¦‚ä½•å¯¹æ¥è‡ªè¯¥äº‹å®æˆ–å¯¹è±¡çš„æ•°æ®åšå‡ºååº”çš„å®šä¹‰ï¼šä¾‹å¦‚åœ¨è‚¡ç¥¨ç»çºªäººåº”ç”¨ç¨‹åºä¸­ï¼Œè¯åˆ¸ä»·æ ¼çš„å˜åŒ–ã€æ‰€æœ‰æƒä»å–æ–¹åˆ°ä¹°æ–¹çš„å˜åŒ–æˆ–è´¦æˆ·æŒæœ‰äººä½™é¢çš„å˜åŒ–éƒ½è¢«è§†ä¸ºäº‹ä»¶ï¼Œå› ä¸ºåœ¨ç»™å®šæ—¶é—´åº”ç”¨ç¨‹åºåŸŸçš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–</p><p>Drools ä¸­çš„ Drools engineä½¿ç”¨å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰æ¥æ£€æµ‹å’Œå¤„ç†äº‹ä»¶é›†åˆä¸­çš„å¤šä¸ªäº‹ä»¶ï¼Œæ­ç¤ºäº‹ä»¶ä¹‹é—´å­˜åœ¨çš„å…³ç³»ï¼Œå¹¶ä»äº‹ä»¶åŠå…¶å…³ç³»ä¸­æ¨æ–­æ–°æ•°æ®</p><p>CEP åœºæ™¯å…·æœ‰ä»¥ä¸‹å…³é”®ç‰¹å¾ï¼š</p><ul><li>åœºæ™¯é€šå¸¸å¤„ç†å¤§é‡äº‹ä»¶ï¼Œä½†åªæœ‰ä¸€å°éƒ¨åˆ†äº‹ä»¶æ˜¯çœŸæ­£å…³å¿ƒçš„</li><li>äº‹ä»¶é€šå¸¸æ˜¯ä¸å¯å˜çš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯çŠ¶æ€æ”¹å˜çš„ä¸€æ¡è®°å½•ï¼ˆæ˜¯ä¸€ä¸ªå†å²çŠ¶æ€ï¼‰</li><li>è§„åˆ™å’ŒæŸ¥è¯¢é’ˆå¯¹äº‹ä»¶è¿è¡Œï¼Œå¹¶ä¸”å¿…é¡»å¯¹æ£€æµ‹åˆ°çš„äº‹ä»¶æ¨¡å¼ä½œå‡ºååº”</li><li>ç›¸å…³äº‹ä»¶é€šå¸¸å…·æœ‰å¾ˆå¼ºçš„æ—¶é—´å…³ç³»</li><li>ç‹¬ç«‹çš„äº‹ä»¶æ˜¯ä¸é‡è¦çš„ï¼›CEPç³»ç»Ÿä¼˜å…ˆè€ƒè™‘ç›¸å…³äº‹ä»¶çš„æ¨¡å¼åŠå…¶ä¹‹é—´çš„å…³ç³»</li><li>äº‹ä»¶é€šå¸¸éœ€è¦ç»„åˆå’Œèšåˆ</li></ul><p>é‰´äºè¿™äº›å¸¸è§çš„ CEP åœºæ™¯ç‰¹å¾ï¼ŒDrools ä¸­çš„ CEPç³»ç»Ÿæ”¯æŒä»¥ä¸‹ç‰¹æ€§å’ŒåŠŸèƒ½ï¼Œä»¥ä¼˜åŒ–äº‹ä»¶å¤„ç†ï¼š</p><ul><li>å…·æœ‰é€‚å½“è¯­ä¹‰çš„äº‹ä»¶å¤„ç†</li><li>äº‹ä»¶æ£€æµ‹ã€å…³è”ã€èšåˆå’Œåˆæˆ</li><li>äº‹ä»¶æµï¼ˆEvent streamï¼‰å¤„ç†</li><li>å¯¹äº‹ä»¶ä¹‹é—´çš„æ—¶é—´å…³ç³»å»ºæ¨¡çš„æ—¶é—´çº¦æŸ</li><li>äº‹ä»¶æ»‘åŠ¨çª—å£</li><li>ä¼šè¯èŒƒå›´çš„ç»Ÿä¸€æ—¶é’Ÿ</li><li>ååº”å¼è§„åˆ™</li><li>ç”¨äºäº‹ä»¶è¾“å…¥åˆ° Drools å¼•æ“çš„é€‚é…å™¨</li></ul><hr /><p><strong>å£°æ˜äº‹ä»¶</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">declare VoiceCall</span><br><span class="line">  <span class="meta">@role( event )</span></span><br><span class="line">  <span class="meta">@timestamp( callDateTime )</span></span><br><span class="line">  <span class="meta">@duration( callDuration )</span></span><br><span class="line">  <span class="meta">@expires( 1h35m )</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>Drools å¯¹äº CEP æœ‰ç€ä¸°å¯Œçš„æ—¶é—´è§„åˆ™æ”¯æŒ</strong></p><p>åœ¨æµæ¨¡å¼ä¸‹ï¼ŒDrools å¼•æ“å¯¹å·¥ä½œå†…å­˜çš„äº‹ä»¶æ”¯æŒä»¥ä¸‹æ—¶æ€è¿ç®—ç¬¦ï¼š</p><ul><li><code>after</code></li><li><code>before</code></li><li><code>meets</code></li><li><code>during</code></li><li>...</li></ul><p>ä»¥ <code>after</code> ä¸ºä¾‹</p><p><code>$eventA : EventA(this after[3m30s, 4m] $eventB)</code> æˆ–è€…<code>3m30s &lt;= $eventA.startTimestamp - $eventB.endTimeStamp &lt;= 4m</code></p><p>è¡¨ç¤ºï¼šå¦‚æœ <code>$eventA</code> åœ¨ <code>$eventB</code> ç»“æŸå 3 åˆ†30 ç§’åˆ° 4 åˆ†ä¹‹é—´å¼€å§‹ï¼Œåˆ™ä»¥ä¸‹æ¨¡å¼åŒ¹é…ï¼›å¦‚æœ <code>$eventA</code> åœ¨<code>$eventB</code> ç»“æŸå 3 åˆ† 30 ç§’ä¹‹å‰å¼€å§‹ï¼Œæˆ–åœ¨<code>$eventA</code> ç»“æŸå 4 åˆ†é’Ÿä¹‹åå¼€å§‹ï¼Œåˆ™ä¸åŒ¹é…</p><p><strong>æ—¶é—´ Â é•¿åº¦æ»‘åŠ¨çª—å£</strong></p><ul><li>å¤„ç†æœ€å 2 åˆ†é’Ÿçš„åº“å­˜ç‚¹ï¼ˆæ—¶é—´æ»‘åŠ¨çª—å£ï¼‰<code>StockPoint() over window:time(2m)</code></li><li>å¤„ç†æœ€å10ä¸ªåº“å­˜ç‚¹ï¼ˆé•¿åº¦æ»‘åŠ¨çª—å£ï¼‰<code>StockPoint() over window:length(10)</code></li></ul><p>ä¾‹å¦‚ä»¥ä¸‹ä¸¤ä¸ª DRLè§„åˆ™æ ¹æ®å¹³å‡æ¸©åº¦æ¿€æ´»ç«ç¾è­¦æŠ¥ï¼›ç¬¬ä¸€æ¡è§„åˆ™ä½¿ç”¨æ»‘åŠ¨æ—¶é—´çª—å£æ¥è®¡ç®—æœ€å 10åˆ†é’Ÿçš„å¹³å‡å€¼ï¼Œè€Œç¬¬äºŒæ¡è§„åˆ™ä½¿ç”¨æ»šåŠ¨é•¿åº¦çª—å£æ¥è®¡ç®—æœ€è¿‘ä¸€ç™¾ä¸ªæ¸©åº¦è¯»æ•°çš„å¹³å‡å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Sound the alarm if temperature rises above threshold&quot;</span></span><br><span class="line">when</span><br><span class="line">  <span class="title function_">TemperatureThreshold</span><span class="params">($max : max)</span></span><br><span class="line">  Number(doubleValue &gt; $max) from <span class="title function_">accumulate</span><span class="params">(</span></span><br><span class="line"><span class="params">    SensorReading($temp : temperature)</span> over window:time(10m),</span><br><span class="line">    average($temp))</span><br><span class="line">then</span><br><span class="line">  <span class="comment">// Sound the alarm.</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Sound the alarm if temperature rises above threshold&quot;</span></span><br><span class="line">when</span><br><span class="line">  <span class="title function_">TemperatureThreshold</span><span class="params">($max : max)</span></span><br><span class="line">  Number(doubleValue &gt; $max) from <span class="title function_">accumulate</span><span class="params">(</span></span><br><span class="line"><span class="params">    SensorReading($temp : temperature)</span> over window:length(<span class="number">100</span>),</span><br><span class="line">    average($temp))</span><br><span class="line">then</span><br><span class="line">  <span class="comment">// Sound the alarm.</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><div style="page-break-after: always;"></div><h2 id="è¡Œä¸ºå‹æ¨¡å¼">è¡Œä¸ºå‹æ¨¡å¼</h2><blockquote><p>Behavioral design patterns are concerned with algorithms and theassignment of responsibilities between objects.</p><p>è¡Œä¸ºæ¨¡å¼è´Ÿè´£å¯¹è±¡é—´çš„é«˜æ•ˆæ²Ÿé€šå’ŒèŒè´£å§”æ´¾</p></blockquote><p>å¯¹äºæµç¨‹å›¾å¼è§„åˆ™ï¼Œæˆ‘è®¤ä¸ºæ˜¯è¡Œä¸ºæ¨¡å¼çš„æ‰©å±•ï¼Œå°†åˆ†æ”¯ç»„ä»¶é€‰æ‹©åŒæ ·è¿›è¡Œäº†ç»„ä»¶åŒ–</p><h3 id="ç­–ç•¥">ç­–ç•¥</h3><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F.drawio.png" class="" title="ç­–ç•¥æ¨¡å¼.drawio"><p>ç­–ç•¥æ¨¡å¼ï¼ˆStrategyPatternï¼‰å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä»è€Œä½¿å¾—ç®—æ³•å¯ä»¥ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯è€Œå˜åŒ–</p><p>ç­–ç•¥æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>åœ¨äºå®ƒå¯ä»¥æé«˜ä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å®ƒå¯ä»¥ä½¿å¾—ç®—æ³•ä¸å®¢æˆ·ç«¯åˆ†ç¦»ï¼Œä»è€Œä½¿å¾—å®¢æˆ·ç«¯ä¸éœ€è¦äº†è§£ç®—æ³•çš„å…·ä½“å®ç°ç»†èŠ‚</li><li>ç­–ç•¥å¯¹è±¡å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°åˆ‡æ¢ï¼Œä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®ä¸åŒçš„æƒ…å†µé€‰æ‹©ä¸åŒçš„ç­–ç•¥å¯¹è±¡ï¼Œä»è€Œå®ç°æ›´åŠ çµæ´»çš„ç®—æ³•ç»„åˆå’Œé…ç½®</li><li>å°†ä¸åŒè¡Œä¸ºæŠ½å–åˆ°ä¸€ä¸ªç‹¬ç«‹ç±»å±‚æ¬¡ç»“æ„ä¸­ï¼Œ å¹¶å°†åŸå§‹ç±»ç»„åˆæˆåŒä¸€ä¸ªï¼Œä»è€Œå‡å°‘é‡å¤ä»£ç ï¼ˆä¾¿äºæ¨¡æ¿ï¼‰</li><li>ç»„åˆä»£æ›¿ç»§æ‰¿</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ— éœ€å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œä¿®æ”¹å°±èƒ½å¤Ÿå¼•å…¥æ–°çš„ç­–ç•¥</li></ul><h3 id="è´£ä»»é“¾">è´£ä»»é“¾</h3><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F.drawio.png" class="" title="è´£ä»»é“¾æ¨¡å¼.drawio"><p>è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of ResponsibilityPatternï¼‰é€šè¿‡å°†è¯·æ±‚å‘é€ç»™ä¸€ç³»åˆ—å¤„ç†å¯¹è±¡ï¼Œä½¿å¾—æ¯ä¸ªå¤„ç†å¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œå®ç°è¯·æ±‚çš„å¤„ç†ä¸å‘é€è€…çš„è§£è€¦</p><p>è´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>å°†å¤æ‚çš„å¤„ç†é€»è¾‘åˆ†è§£ä¸ºå¤šä¸ªç®€å•çš„å¤„ç†å¯¹è±¡ï¼Œä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°æ˜“æ‡‚</li><li>å¯ä»¥æ§åˆ¶è¯·æ±‚å¤„ç†çš„é¡ºåº</li><li>æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ï¼Œå¯å¯¹å‘èµ·æ“ä½œå’Œæ‰§è¡Œæ“ä½œçš„ç±»è¿›è¡Œè§£è€¦</li><li>ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œå¯ä»¥åœ¨ä¸æ›´æ”¹ç°æœ‰ä»£ç çš„æƒ…å†µä¸‹åœ¨ç¨‹åºä¸­æ–°å¢å¤„ç†è€…</li></ul><h3 id="æµæ°´çº¿">æµæ°´çº¿</h3><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%A8%A1%E5%BC%8F.drawio.png" class="" title="æµæ°´çº¿æ¨¡å¼.drawio"><p>ç®¡é“è®¾è®¡æ¨¡å¼ï¼ˆPipelinePatternï¼‰å°†ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªç‹¬ç«‹çš„é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µéƒ½ç”±ä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨æ¥å®Œæˆï¼Œå¹¶ä¸”å¤„ç†å™¨ä¹‹é—´é€šè¿‡ç®¡é“è¿›è¡Œè¿æ¥ï¼Œä»è€Œå½¢æˆä¸€ä¸ªå¤„ç†æµç¨‹</p><p>æµæ°´çº¿æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>å°†å¤æ‚çš„ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªç‹¬ç«‹çš„é˜¶æ®µ</li><li>æµç¨‹ç¼–æ’ï¼Œå¯ä»¥å¤ç”¨é€»è¾‘èŠ‚ç‚¹</li><li>æé«˜ä»£ç çš„å¯é‡ç”¨æ€§å’Œå¯æµ‹è¯•æ€§ï¼Œå› ä¸ºæ¯ä¸ªå¤„ç†å™¨éƒ½å¯ä»¥å•ç‹¬æµ‹è¯•å’Œè°ƒè¯•</li><li>å¯ä»¥åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ï¼Œæé«˜ä»£ç çš„å¹¶å‘æ€§èƒ½</li></ul><h1 id="æ ¸å¿ƒèƒ½åŠ›">æ ¸å¿ƒèƒ½åŠ›</h1><p>è¿™é‡Œåˆ—ä¸¾äº†ä¸€äº›è§„åˆ™å¼•æ“çš„æ ¸å¿ƒæœºåˆ¶</p><p>å¯¹äº Drools æ”¯æŒçš„èƒ½åŠ›ä¸»è¦ç»“åˆæ–‡æ¡£è¿›è¡Œç®€å•çš„ä»‹ç»ï¼Œå¯¹äº LiteFlowç­‰æ”¯æŒçš„èƒ½åŠ›ä¼šç»“åˆæºç </p><h2 id="è§„åˆ™ç¼–æ’">è§„åˆ™ç¼–æ’</h2><p>Drools ä½¿ç”¨äº† RETE ç®—æ³•çš„å˜ä½“ Phreak æ¥åšä¸ºè§„åˆ™ç®—æ³•</p><p>LiteFlow ä½¿ç”¨äº† alibaba å¼€æºçš„ QLExpressä½œä¸ºè§„åˆ™çš„è§£æå·¥å…·ï¼ˆQLExpress ä¹Ÿæ˜¯ä¸€æ¬¾è¡¨è¾¾å¼å¼•æ“ï¼Œæˆ–è€…è¯´æ˜¯è„šæœ¬è¯­è¨€ï¼‰</p><p><a href="https://github.com/alibaba/QLExpress">alibaba/QLExpress:QLExpress is a powerful, lightweight, dynamic language for the Javaplatform aimed at improving developersâ€™ productivity in differentbusiness scenes. (github.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExpressRunner</span> <span class="variable">runner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressRunner</span>();</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">DefaultContext</span>&lt;String, Object&gt;();</span><br><span class="line">context.put(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">context.put(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>);</span><br><span class="line">context.put(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">express</span> <span class="operator">=</span> <span class="string">&quot;a + b * c&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">r</span> <span class="operator">=</span> runner.execute(express, context, <span class="literal">null</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">System.out.println(r);</span><br></pre></td></tr></table></figure><p>å› ä¸º QLExpress è¿˜æ”¯æŒæ‰©å±•æ“ä½œç¬¦ï¼Œæ‰€ä»¥è¢« LiteFlow ç”¨æ¥è§£æå…¶ DSLå®šä¹‰çš„è§„åˆ™</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nodes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.ACmp&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;b&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.BCmp&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;c&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.CCmp&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;d&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.yomahub.liteflow.test.parser.cmp.DCmp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nodes</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            a, b, WHEN(c,d)</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">flow:</span></span><br><span class="line">  <span class="attr">nodes:</span></span><br><span class="line">    <span class="attr">node:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">a</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.ACmp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">b</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.BCmp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">c</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.CCmp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">d</span></span><br><span class="line">        <span class="attr">class:</span> <span class="string">com.yomahub.liteflow.test.parser.cmp.DCmp</span></span><br><span class="line">  <span class="attr">chain:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chain1</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;THEN(a, b, WHEN(c, d))&quot;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„ EL <code>THEN(a, b, WHEN(c, d))</code> éƒ½æ˜¯äº¤ç”± QLExpressè¿›è¡Œå¤„ç†</p><hr /><p>LiteFlowChainELBuilder#setEL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LiteFlowChainELBuilder <span class="title function_">setEL</span><span class="params">(String elStr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (StrUtil.isBlank(elStr)) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">errMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;no content in this chain[&#123;&#125;]&quot;</span>, chain.getChainId());</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowSystemException</span>(errMsg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; errorList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line">                </span><br><span class="line"><span class="comment">// è§£æ el æˆä¸ºä¸€ä¸ª Condition</span></span><br><span class="line"><span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> (Condition) EXPRESS_RUNNER.execute(elStr, context, errorList, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™æ€æˆå‘˜ <code>EXPRESS_RUNNER</code> å³ä¸º QLExpress æä¾›çš„<code>ExpressRunner</code> å®ä¾‹</p><p>åœ¨é™æ€ä»£ç å—ä¸­åˆå§‹åŒ–æ‰©å±•æ“ä½œç¬¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ELè§£æå¼•æ“</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ExpressRunner</span> <span class="variable">EXPRESS_RUNNER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressRunner</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–QLExpressçš„Runner</span></span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.THEN, <span class="keyword">new</span> <span class="title class_">ThenOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.WHEN, <span class="keyword">new</span> <span class="title class_">WhenOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.SWITCH, <span class="keyword">new</span> <span class="title class_">SwitchOperator</span>());</span><br><span class="line">EXPRESS_RUNNER.addFunction(ChainConstant.PRE, <span class="keyword">new</span> <span class="title class_">PreOperator</span>());</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ‰©å±•æ“ä½œç¬¦çš„å®ç°å°±æ˜¯æ„å»º LiteFlow æœ€ç»ˆçš„èŠ‚ç‚¹æŠ½è±¡<code>Executable</code> çš„æŠ½è±¡å®ç° <code>Condition</code></p><p><code>BaseOperator</code> ä¸ºäº†å¼ºåŒ– <code>executeInner</code>æ–¹æ³•ï¼Œä¼šæ•è·æŠ›å‡ºçš„ <code>QLException</code> å¼‚å¸¸ï¼Œè¾“å‡ºå‹å¥½çš„é”™è¯¯æç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThenOperator</span> <span class="keyword">extends</span> <span class="title class_">BaseOperator</span>&lt;ThenCondition&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ThenCondition <span class="title function_">build</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">OperatorHelper.checkObjectSizeGtZero(objects);</span><br><span class="line"></span><br><span class="line"><span class="type">ThenCondition</span> <span class="variable">thenCondition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThenCondition</span>();</span><br><span class="line"><span class="keyword">for</span> (Object obj : objects) &#123;</span><br><span class="line">thenCondition.addExecutable(OperatorHelper.convert(obj, Executable.class));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> thenCondition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°±åˆ°äº†è§„åˆ™å¯¹è±¡å°è£…çš„ä¸‰ä¸ªç±»å‹</p><ul><li>Executable<ul><li>Conditionï¼šæ¡ä»¶å¯¹è±¡ï¼Œæ ¸å¿ƒå±æ€§ <code>executableGroup</code>ï¼ŒæŒæœ‰<code>Executable</code> Map</li><li>Chainï¼šè§„åˆ™é“¾å¯¹è±¡ï¼Œæ ¸å¿ƒå±æ€§ <code>conditionList</code>ï¼ŒæŒæœ‰<code>Condition</code> é›†åˆ</li><li>Nodeï¼šNode èŠ‚ç‚¹ï¼Œæ ¸å¿ƒå±æ€§<code>NodeComponent</code>ï¼Œæ‰æ˜¯ç»„ä»¶æ‰§è¡Œçš„æ ¸å¿ƒ</li></ul></li></ul><p>æœ€ç»ˆåœ¨ <code>FlowExecutor</code> æ‰§è¡Œä¸­è·å– <code>Chain</code>ä¸ºå…¥å£ï¼Œè¿›è¡Œæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">chain = FlowBus.getChain(chainId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNull(chain)) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;[&#123;&#125;]:couldn&#x27;t find chain with the id[&#123;&#125;]&quot;</span>, slot.getRequestId(),</span><br><span class="line">chainId);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChainNotFoundException</span>(errorMsg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰§è¡Œchain</span></span><br><span class="line">chain.execute(slotIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¹¶å‘ç¼–æ’">å¹¶å‘ç¼–æ’</h2><p>LiteFlowä¸­çš„æµç¨‹å›¾å¼è§„åˆ™è¡¨è¾¾å¤©ç„¶æ”¯æŒçµæ´»åœ°å¯¹æ‰§è¡Œä»»åŠ¡è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œä½¿ç”¨å…³é”®è¯<code>WHEN</code> è¿›è¡Œè¡¨è¾¾</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">    THEN(</span><br><span class="line">        a,</span><br><span class="line">        WHEN(b, c, d),</span><br><span class="line">        e</span><br><span class="line">    );</span><br><span class="line"><span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¡¨ç¤ºä¸²è¡Œæ‰§è¡ŒèŠ‚ç‚¹ aï¼Œéšåå¹¶è¡Œæ‰§è¡ŒèŠ‚ç‚¹ bã€cã€dï¼Œæœ€åç»§ç»­ä¸²è¡Œæ‰§è¡ŒèŠ‚ç‚¹e</p><p>åŒæ—¶æ‹¥æœ‰ä¸€äº›æ‹“å±•åŠŸèƒ½ï¼š</p><ul><li>å¿½ç•¥é”™è¯¯ï¼š<code>WHEN(b, c, d).ignoreError(true)</code> å½“ bã€cã€dèŠ‚ç‚¹å‡ºç°å¼‚å¸¸æ—¶è¿›è¡Œå¿½ç•¥</li><li>ä»»æ„æ‰§è¡ŒæˆåŠŸï¼š<code>WHEN(b, THEN(c, d), e).any(true)</code> å½“bã€å¹¶è¡Œçš„ c å’Œ dã€e ä»»æ„æ‰§è¡ŒæˆåŠŸåˆ™ç»§ç»­å‘ä¸‹æ‰§è¡Œ</li><li>åˆ†ç»„ï¼š<code>THEN(WHEN(a, b),WHEN(c, d))</code> å…³é”®è¯<code>WHEN</code> å¤©ç„¶å…·æœ‰åˆ†ç»„æ¦‚å¿µ</li></ul><hr /><p>å¹¶å‘çš„ç¬¬ä¸€æ­¥ï¼Œæ•´ä¸ªè§„åˆ™è¢«åŒ…è£…ä¸º <code>WhenCondition</code> å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhenCondition</span> <span class="keyword">extends</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªåœ¨whenç±»å‹ä¸‹æœ‰æ•ˆï¼Œä»¥åŒºåˆ†å½“whenè°ƒç”¨é“¾è°ƒç”¨å¤±è´¥æ—¶æ˜¯å¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œ é»˜è®¤falseä¸ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">ignoreError</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªåœ¨whenç±»å‹ä¸‹æœ‰æ•ˆï¼Œä¸ºtrueçš„è¯è¯´æ˜åœ¨å¤šä¸ªå¹¶è¡ŒèŠ‚ç‚¹ä¸‹ï¼Œä»»æ„ä¸€ä¸ªæˆåŠŸï¼Œæ•´ä¸ªwhenå°±æˆåŠŸ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">any</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// when å•ç‹¬çš„çº¿ç¨‹æ± åç§°</span></span><br><span class="line"><span class="keyword">private</span> String threadExecutorClass;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeCondition</span><span class="params">(Integer slotIndex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">executeAsyncCondition(slotIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹è±¡ä¸­åŒ…æ‹¬ <code>WHEN</code> è§„åˆ™ç›¸å…³çš„å±æ€§ï¼Œä»¥åŠå…³é”®çš„<code>executeCondition</code> å®ç°</p><p>å®ç°ä¸­è°ƒç”¨äº† <code>executeAsyncCondition</code></p><p><code>executeAsyncCondition</code>ä»£ç æ¯”è¾ƒé•¿ï¼Œæ¦‚æ‹¬åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ol type="1"><li>æ‹¿åˆ° <code>Condition</code> ä¸‹çš„å¯æ‰§è¡Œå…ƒç´ çš„é›†åˆ<code>executableGroup</code>ï¼Œè¿‡æ»¤æ‰å‰åç½®ç»„ä»¶ï¼ˆ<code>PreCondition</code>å’Œ <code>FinallyCondition</code>ï¼‰ä»¥åŠ <code>Node</code> çš„<code>isAccess</code> ä¸º false çš„èŠ‚ç‚¹ï¼ˆè¿™é‡Œæ˜¯ä¸ºäº†å¤„ç†ä¸€ä¸ª bug issueï¼š<ahref="https://gitee.com/dromara/liteFlow/issues/I4XRBA">å…³äºwhenå’Œthenæ··åˆä½¿ç”¨æ—¶(æœ‰anyå’ŒisAccessçš„æƒ…å†µä¸‹)ï¼Œthençš„èŠ‚ç‚¹å…ˆæ‰§è¡Œçš„é—®é¢˜Â· Issue #I4XRBA Â· dromara/liteFlow - Gitee.com</a>ï¼‰</li><li>ä½¿ç”¨ <code>ScheduledThreadPoolExecutor</code> å®ç°<code>CompletableFuture</code> å¼‚æ­¥å¤„ç†è¶…æ—¶ï¼Œå°† <code>Executable</code>æ•°æ®åŒ…è£…ä¸º <code>ParallelSupplier</code>ï¼Œè°ƒç”¨<code>CompletableFuture.supplyAsync</code></li><li>æ ¹æ® <code>any</code> å‚æ•°ä½¿ç”¨ <code>CompletableFuture.anyOf</code>æˆ– <code>CompletableFuture.allOf</code>ï¼Œæ‹¿åˆ°å°è£…æµç¨‹åçš„<code>resultCompletableFuture</code></li><li>æ‰§è¡Œ <code>resultCompletableFuture.get</code> è¿›è¡Œé˜»å¡ï¼Œcatch<code>InterruptedException</code></li><li>æ‹¿åˆ°å·²ç»å®Œæˆçš„ç»“æœï¼Œå¯¹æœªå®Œæˆçš„ä»»åŠ¡è¿›è¡Œè¿‡æ»¤ï¼ˆå¦‚æœ <code>any</code> ä¸ºtrueï¼Œé‚£ä¹ˆè¿™é‡Œæ‹¿åˆ°çš„æ˜¯ç¬¬ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡ï¼‰</li><li>è¿‡æ»¤å‡ºè¶…æ—¶çš„ä»»åŠ¡ï¼Œè¾“å‡ºè¶…æ—¶æ—¥å¿—</li><li>æ ¹æ®å‚æ•° <code>isIgnoreError</code>ï¼Œå¤„ç†<code>InterruptedException</code>ï¼›éå† <code>CompletableFuture</code>çš„è¿”å›å€¼ï¼Œå¦‚æœå¼‚æ­¥æ‰§è¡Œå¤±è´¥ï¼Œåˆ™æŠ›å‡ºç›¸åº”çš„ä¸šåŠ¡å¼‚å¸¸</li></ol><h2 id="æ‰§è¡Œç»„ä»¶">æ‰§è¡Œç»„ä»¶</h2><p>Drools ä¸­æ²¡æœ‰ç»„ä»¶çš„æ¦‚å¿µï¼Œä½†æ˜¯æ¯ä¸ªè§„åˆ™è¡¨è¾¾ä¸­ <code>then</code>éƒ¨åˆ†ç›´æ¥è°ƒç”¨ Java ä»£ç æˆ–è€…ç”± MVEL æˆ– Java å®šä¹‰æ‰§è¡Œé€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.User;</span><br><span class="line"><span class="keyword">import</span> com.example.Product;</span><br><span class="line"><span class="keyword">import</span> com.example.ProductRecommendationService;</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Recommendation Rule&quot;</span></span><br><span class="line">when</span><br><span class="line">  <span class="comment">// ç»‘å®šäº‹å®å¯¹è±¡</span></span><br><span class="line">    $user : User( $userId : userId, $history : purchaseHistory, $prefs : preferences )</span><br><span class="line">    $product : Product( $productId : productId, $categories : categories, $price : price )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†…ç½®å‡½æ•°</span></span><br><span class="line">    exists( String( <span class="built_in">this</span> == $categories ) from $prefs ) <span class="comment">// å•†å“æ‰€å±çš„æŸä¸ªç±»åˆ«åœ¨ç”¨æˆ·åå¥½ä¸­å­˜åœ¨</span></span><br><span class="line">    not ( String( <span class="built_in">this</span> == $productId ) from $history ) <span class="comment">// ç”¨æˆ·æœªè´­ä¹°è¿‡è¯¥å•†å“</span></span><br><span class="line">then</span><br><span class="line">    <span class="comment">// æ‰§è¡Œé€»è¾‘</span></span><br><span class="line">    ProductRecommendationService.recommendProduct($userId, $productId);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>LiteFlow ä¸­çš„ç»„ä»¶ç”± Java ä»£ç ç¼–å†™ï¼ˆä¹Ÿå¯ä»¥è„šæœ¬ç»„ä»¶ï¼‰ï¼Œå¯ä»¥ä½œä¸º beanæ¥å…¥ Spring</p><p><code>FlowParse</code> åŠå…¶å®ç°</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/FlowParser.png" class="" title="FlowParser"><p><code>FlowExecutor</code> çš„ <code>init</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¥æ‰¾å¯¹åº”è§£æå™¨</span></span><br><span class="line">parser = FlowParserProvider.lookup(path);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FlowParserProvider.lookup</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> FlowParser <span class="title function_">lookup</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ç±»å¿…é¡»å®ç°ä»¥ä¸Šå®ç°ç±»ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line"><span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;can&#x27;t support the format &#123;&#125;&quot;</span>, path);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> (isLocalConfig(path)) &#123;</span><br><span class="line"><span class="comment">// éå†æšä¸¾ map æ‰¾åˆ°å¯¹åº” factory</span></span><br><span class="line">Predicate&lt;String&gt; dictKey = LOCAL_PARSER_DICT.keySet()</span><br><span class="line">.stream()</span><br><span class="line">.filter(key -&gt; key.test(path))</span><br><span class="line">.findFirst()</span><br><span class="line">.orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ErrorSupportPathException</span>(errorMsg));</span><br><span class="line"></span><br><span class="line">LOG.info(<span class="string">&quot;flow info loaded from local file,path=&#123;&#125;&quot;</span>, path);</span><br><span class="line"><span class="keyword">return</span> LOCAL_PARSER_DICT.get(dictKey).apply(path);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><code>NodeType</code> èŠ‚ç‚¹ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">NodeTypeEnum</span> &#123;</span><br><span class="line">COMMON(<span class="string">&quot;common&quot;</span>, <span class="string">&quot;æ™®é€š&quot;</span>, <span class="literal">false</span>, NodeComponent.class),</span><br><span class="line">SWITCH(<span class="string">&quot;switch&quot;</span>, <span class="string">&quot;é€‰æ‹©&quot;</span>, <span class="literal">false</span>, NodeSwitchComponent.class),</span><br><span class="line">IF(<span class="string">&quot;if&quot;</span>, <span class="string">&quot;æ¡ä»¶&quot;</span>, <span class="literal">false</span>, NodeIfComponent.class),</span><br><span class="line">FOR(<span class="string">&quot;for&quot;</span>, <span class="string">&quot;å¾ªç¯æ¬¡æ•°&quot;</span>, <span class="literal">false</span>, NodeForComponent.class),</span><br><span class="line">WHILE(<span class="string">&quot;while&quot;</span>, <span class="string">&quot;å¾ªç¯æ¡ä»¶&quot;</span>, <span class="literal">false</span>, NodeWhileComponent.class),</span><br><span class="line">BREAK(<span class="string">&quot;break&quot;</span>, <span class="string">&quot;å¾ªç¯è·³å‡º&quot;</span>, <span class="literal">false</span>, NodeBreakComponent.class),</span><br><span class="line">ITERATOR(<span class="string">&quot;iterator&quot;</span>, <span class="string">&quot;å¾ªç¯è¿­ä»£&quot;</span>, <span class="literal">false</span>, NodeIteratorComponent.class),</span><br><span class="line">SCRIPT(<span class="string">&quot;script&quot;</span>, <span class="string">&quot;è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptCommonComponent.class),</span><br><span class="line">SWITCH_SCRIPT(<span class="string">&quot;switch_script&quot;</span>, <span class="string">&quot;é€‰æ‹©è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptSwitchComponent.class),</span><br><span class="line">IF_SCRIPT(<span class="string">&quot;if_script&quot;</span>, <span class="string">&quot;æ¡ä»¶è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptIfComponent.class),</span><br><span class="line">FOR_SCRIPT(<span class="string">&quot;for_script&quot;</span>, <span class="string">&quot;å¾ªç¯æ¬¡æ•°è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptForComponent.class),</span><br><span class="line">WHILE_SCRIPT(<span class="string">&quot;while_script&quot;</span>, <span class="string">&quot;å¾ªç¯æ¡ä»¶è„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptWhileComponent.class),</span><br><span class="line">BREAK_SCRIPT(<span class="string">&quot;break_script&quot;</span>, <span class="string">&quot;å¾ªç¯è·³å‡ºè„šæœ¬&quot;</span>, <span class="literal">true</span>, ScriptBreakComponent.class);</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ•´ä½“æµç¨‹ï¼š</p><ol type="1"><li>æ–‡ä»¶è§£æï¼ˆXMLã€JSONï¼‰</li><li><code>NodePropBean</code> åŒ…è£…</li><li>buildNodeï¼ŒFlowBus æ·»åŠ èŠ‚ç‚¹å…ƒæ•°æ®<ul><li>å¦‚æœæ˜¯å£°æ˜å¼ç»„ä»¶ï¼ŒSpring ç¯å¢ƒä¸‹å·²ç»æ˜¯ä»£ç†å¯¹è±¡åˆ™ä¸å¤„ç†ï¼Œé Springç¯å¢ƒæ‰§è¡Œ <code>LiteFlowProxyUtil.proxy2NodeComponent</code></li><li>é…ç½®ç»„ä»¶ï¼Œnew Instance</li></ul></li><li>è„šæœ¬ç»„ä»¶ï¼ŒåŠ è½½ script è„šæœ¬</li></ol><h2 id="è„šæœ¬ç»„ä»¶">è„šæœ¬ç»„ä»¶</h2><p>åœ¨ Drools ä¸­æœ¬èº«çš„è§„åˆ™è¡¨è¾¾å°±æ˜¯ Drools å®šä¹‰çš„ç±» Java è¯­æ³•ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒDMN çš„ FEEL ç­‰è¯­æ³•ï¼Œç›¸å½“äºè„šæœ¬è¯­è¨€</p><p>åœ¨ LiteFlow ä¸­æ”¯æŒå¤šç§è„šæœ¬è¯­è¨€æ¥å®šä¹‰ç»„ä»¶ï¼š</p><ul><li>Groovy</li><li>Javascript</li><li>QLExpress</li><li>Python</li><li>Lua</li><li>Aviator</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nodes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">id</span>=<span class="string">&quot;s1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;æ™®é€šè„šæœ¬&quot;</span> <span class="attr">type</span>=<span class="string">&quot;script&quot;</span> <span class="attr">language</span>=<span class="string">&quot;groovy&quot;</span>&gt;</span></span><br><span class="line">            &lt;![CDATA[</span><br><span class="line">                def a=3;</span><br><span class="line">                def b=2;</span><br><span class="line">                defaultContext.setData(&quot;s1&quot;,a*b);</span><br><span class="line">            ]]&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nodes</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;chain1&quot;</span>&gt;</span></span><br><span class="line">        THEN(a);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>NodeComponent</code> å®ç°ç±» <code>loadScript</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScriptCommonComponent</span> <span class="keyword">extends</span> <span class="title class_">NodeComponent</span> <span class="keyword">implements</span> <span class="title class_">ScriptComponent</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="type">ScriptExecuteWrap</span> <span class="variable">wrap</span> <span class="operator">=</span> <span class="built_in">this</span>.buildWrap(<span class="built_in">this</span>);</span><br><span class="line">ScriptExecutorFactory.loadInstance().getScriptExecutor(<span class="built_in">this</span>.getRefNode().getLanguage()).execute(wrap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadScript</span><span class="params">(String script, String language)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;load script for component[&#123;&#125;]&quot;</span>, getDisplayName());</span><br><span class="line">ScriptExecutorFactory.loadInstance().getScriptExecutor(language).load(getNodeId(), script);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ScriptExecutorFactory.loadInstance().getScriptExecutor(language).load(getNodeId(), script)</code>ä¸»è¦è·å–äº† <code>ScriptExecutor</code> çš„å®ç°</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/ScriptExecutor.png" class="" title="ScriptExecutor"><p>groovy çš„ ScriptEngine ç”± groovy-jsr223 ä¾èµ–æä¾›<code>org.codehaus.groovy.jsr223GroovyScriptEngineImpl</code></p><p>æœ€ç»ˆç¼–è¯‘ä¸º <code>CompiledScript</code> å®ç°ï¼Œå­˜å‚¨è‡³<code>compiledScriptMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">JSR223ScriptExecutor</span> <span class="keyword">extends</span> <span class="title class_">ScriptExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ScriptEngine scriptEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CompiledScript&gt; compiledScriptMap = <span class="keyword">new</span> <span class="title class_">CopyOnWriteHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p>æ€è€ƒï¼š</p><ul><li>ä¸šåŠ¡ä¸­åº”è¯¥æœ‰å¤šå°‘è„šæœ¬ã€è¡¨è¾¾å¼å¼•æ“çš„åº”ç”¨ï¼Ÿ</li><li>ä»€ä¹ˆåœºæ™¯é€‚åˆ or ä¸é€‚åˆï¼Ÿ</li></ul><p>XXL-Job æ”¯æŒçš„ GLUE æ¨¡å¼</p><p><ahref="https://www.xuxueli.com/xxl-job/#3.3%20GLUE%E6%A8%A1%E5%BC%8F(Java)">XXL-JOB3.3-GLUEæ¨¡å¼(Java)</a></p></blockquote><h2 id="è§„åˆ™çƒ­æ›´æ–°">è§„åˆ™çƒ­æ›´æ–°</h2><p>è§„åˆ™é…ç½®çš„çƒ­æ›´æ–°æ˜¯è§„åˆ™åŒ–çš„é‡è¦ä¼˜åŠ¿ï¼Œç‰¹åˆ«æ˜¯å¾ˆå¤šæˆç†Ÿçš„è§„åˆ™å¼•æ“éƒ½æä¾›äº†GUI åå°</p><p>Drools æ”¯æŒçš„è§„åˆ™è¯»å–æ–¹å¼ï¼š</p><ul><li><code>KieClasspathContainer</code> é¡¹ç›® resource æ–‡ä»¶</li><li><code>KieBuilder</code> é¡¹ç›®å¤–æ–‡ä»¶</li><li><code>KieScanner</code> ä»“åº“ jar åŒ…ï¼ˆWorkbenchï¼‰</li></ul><p>Drools çš„æ›´æ–°æ–¹å¼ï¼š</p><ul><li>ä½¿ç”¨ <code>KieContainerImpl.updateToKieModule</code></li><li>åˆ›å»ºæ–°çš„ <code>KieContainer</code></li><li>ä½¿ç”¨ <code>InternalKnowledgeBase</code> çš„APIï¼›ç²’åº¦æ›´ç»†ï¼Œæ³¨æ„è§„åˆ™åˆ‡æ¢éåŸå­æ€§å¸¦æ¥çš„å½±å“</li></ul><p>LiteFlow çš„è§„åˆ™æœ¬è´¨æ˜¯ä¸€ä¸ªæ‰§è¡Œé“¾ï¼ˆ<code>Chain</code> å’Œ<code>Condition</code>ï¼‰ï¼Œåœ¨æ‰§è¡Œæ—¶ä¼š copyå‡ºä¸€ä»½æ–°çš„æ‰§è¡Œé“¾å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹äºè§„åˆ™çš„çƒ­æ›´æ–°åº”è¯¥æ˜¯å¤©ç„¶æ”¯æŒå¹³æ»‘çš„</p><blockquote><p>å³ä½ å¯ä»¥åœ¨ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œè§„åˆ™çš„é‡è½½</p><p>å¹¶ä¸”åœ¨é«˜å¹¶å‘ä¸‹åˆ·æ–°çš„æ—¶å€™ï¼Œæ­£åœ¨æ‰§è¡Œæµç¨‹çš„çº¿ç¨‹æ˜¯å®Œå…¨å¹³æ»‘çš„ï¼Œä¸ä¼šå› ä¸ºåˆ·æ–°çš„è¿‡ç¨‹è€Œå‡ºç°ä¸­æ–­çš„ç°è±¡</p><p>åœ¨åˆ·æ–°æ—¶ï¼Œæ­£åœ¨æ‰§è¡Œçš„æµç¨‹è¿˜æ˜¯èµ°çš„æ—§çš„æµç¨‹ï¼›åˆ·æ–°å¥½ï¼Œåç»­ requestä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°çš„æµç¨‹</p></blockquote><p>LiteFlow è§„åˆ™æ›´æ–°çš„æ–¹å¼ï¼š</p><ul><li><p>åœ¨ Spring å®¹å™¨ä¸­æ‹¿åˆ° <code>FlowExecutor</code> å¯¹è±¡è°ƒç”¨<code>flowExecutor.reloadRule()</code></p></li><li><p>æŒ‡å®šåˆ·æ–°æŸä¸€ä¸ª Chain çš„è§„åˆ™ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LiteFlowChainELBuilder.createChain().setChainName(<span class="string">&quot;chain2&quot;</span>).setEL(</span><br><span class="line">  <span class="string">&quot;THEN(a, b, WHEN(c, d))&quot;</span></span><br><span class="line">).build();</span><br></pre></td></tr></table></figure></p></li><li><p>é…ç½®æ”¾åœ¨ä¸­é—´ä»¶ï¼Œåˆ©ç”¨ä¸­é—´ä»¶çš„é…ç½®ç›‘å¬æœºåˆ¶è¿›è¡Œæ›´æ–°</p><ul><li>ZK</li><li>Etcd</li><li>SQLï¼ˆJava.sqlï¼‰</li><li>Nacos</li><li>Apollo</li></ul></li></ul><p>æ ¸å¿ƒåŸç†å°±æ˜¯å®šä¹‰å„è‡ªæ•°æ®æºçš„<code>Parse</code>ï¼Œåœ¨è§£ææ–¹æ³•ä¸­æ‰§è¡Œç›‘å¬æ“ä½œã€æŒ‚è½½ç›‘å¬ç›¸å…³çš„å›è°ƒ</p><p>ï¼ˆä¸è¿‡æˆ‘å‘ç°å¯¹äºè¿œç¨‹è§„åˆ™çš„é…ç½®éƒ½æ˜¯å…¨é‡åˆ·æ–°ï¼Œç›¸å½“äºæ¯æ¬¡å˜æ›´é‡æ–°åŠ è½½æ•´ä¸ªè§„åˆ™æ–‡ä»¶ï¼Œä¸åƒæœ¬åœ°è§„åˆ™æ–‡ä»¶ä¸€æ ·å¯ä»¥é…ç½®å¤šä¸ªï¼Ÿï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosXmlELParser</span> <span class="keyword">extends</span> <span class="title class_">ClassXmlFlowELParser</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NacosParserHelper helper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">NacosXmlELParser</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> LiteflowConfigGetter.get();</span><br><span class="line">    <span class="comment">// è·å–é…ç½®åˆå§‹åŒ–å®¢æˆ·ç«¯</span></span><br><span class="line">    ...</span><br><span class="line">    helper = <span class="keyword">new</span> <span class="title class_">NacosParserHelper</span>(nacosParserVO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">parseCustom</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é‡æ–° parse</span></span><br><span class="line">Consumer&lt;String&gt; parseConsumer = t -&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">parse(t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> helper.getContent();</span><br><span class="line">helper.checkContent(content);</span><br><span class="line">        <span class="comment">// ç›‘å¬</span></span><br><span class="line">helper.listener(parseConsumer);</span><br><span class="line"><span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NacosException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬åœ°æ–‡ä»¶ç›‘å¬ä½¿ç”¨äº† Apache <code>commons.io</code> çš„<code>FileAlterationMonitor</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">observer.addListener(<span class="keyword">new</span> <span class="title class_">FileAlterationListenerAdaptor</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileChange</span><span class="params">(File file)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;file modify,filePath=&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">        FlowExecutorHolder.loadInstance().reloadRule();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileDelete</span><span class="params">(File file)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;file delete,filePath=&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">        FlowExecutorHolder.loadInstance().reloadRule();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>reloadRule</code> æ“ä½œçš„æœ¬è´¨æ˜¯é‡æ–°è¿›è¡Œ<code>FlowExecutor</code> çš„ <code>init</code>æ“ä½œï¼Œçœ‹èµ·æ¥ä¹Ÿæ˜¯ç›´æ¥åˆ·æ–°æ‰€æœ‰æ–‡ä»¶è§„åˆ™ï¼Œç²’åº¦è¾ƒç²—</p><h2 id="å†³ç­–æ§åˆ¶">å†³ç­–æ§åˆ¶</h2><p>Droolsåœ¨é¢å¯¹å¤§é‡è§„åˆ™æ—¶æ›´å¥½çš„è§„åˆ’å‘½ä¸­çš„è§„åˆ™ï¼ˆè§„åˆ™å†²çªã€ä¼˜å…ˆçº§ã€å¾ªç¯ç­‰ï¼‰ï¼Œæ”¯æŒè§„åˆ™ä¸‹ä¸€äº›å‚æ•°æ§åˆ¶åŒ¹é…è§„åˆ™çš„è¡Œä¸ºExecution control in the Drools engine</p><p>åœ¨ Java åº”ç”¨ç¨‹åºä¸­ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>fireAllRules</code> åï¼ŒDroolså¼•æ“ä¼šåœ¨ä¸¤ä¸ªé˜¶æ®µé‡å¤å¾ªç¯ï¼š</p><ul><li><strong>äº‹é¡¹è¯„ä¼°</strong>ï¼ˆAgenda evaluationï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼ŒDroolså¼•æ“é€‰æ‹©æ‰€æœ‰å¯ä»¥æ‰§è¡Œçš„è§„åˆ™ï¼›å¦‚æœä¸å­˜åœ¨å¯æ‰§è¡Œè§„åˆ™ï¼Œåˆ™æ‰§è¡Œå‘¨æœŸç»“æŸï¼›å¦‚æœæ‰¾åˆ°äº†å¯æ‰§è¡Œè§„åˆ™ï¼ŒDroolså¼•æ“ä¼šåœ¨è®®ç¨‹ä¸­æ³¨å†Œæ¿€æ´»ï¼Œç„¶åè¿›å…¥å·¥ä½œå†…å­˜è¡Œä¸ºé˜¶æ®µï¼Œæ‰§è¡Œè§„åˆ™åæœæ“ä½œ</li><li><strong>å·¥ä½œå†…å­˜è¡Œä¸º</strong>ï¼ˆWorking memoryactionsï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼ŒDroolså¼•æ“ä¸ºä¹‹å‰åœ¨äº‹é¡¹ä¸­æ³¨å†Œçš„æ‰€æœ‰æ¿€æ´»è§„åˆ™æ‰§è¡Œè§„åˆ™åæœæ“ä½œï¼ˆæ¯ä¸ªè§„åˆ™çš„<code>then</code> è¡Œä¸ºéƒ¨åˆ†ï¼‰ï¼›åœ¨æ‰€æœ‰ç»“æœæ“ä½œå®Œæˆæˆ–ä¸» Javaåº”ç”¨ç¨‹åºè¿›ç¨‹å†æ¬¡è°ƒç”¨ <code>fireAllRules</code> åï¼ŒDroolså¼•æ“è¿”å›åˆ°è®®ç¨‹è¯„ä¼°é˜¶æ®µä»¥é‡æ–°è¯„ä¼°è§„åˆ™</li></ul><p><imgsrc="https://docs.drools.org/7.73.0.Final/drools-docs/html_single/HybridReasoning/Two_Phase.png" /></p><p>å½“äº‹é¡¹ï¼ˆagendaï¼‰ä¸Šå­˜åœ¨å¤šä¸ªè§„åˆ™æ—¶ï¼Œæ‰§è¡Œä¸€ä¸ªè§„åˆ™å¯èƒ½ä¼šå¯¼è‡´ä»è®®ç¨‹ä¸­åˆ é™¤å¦ä¸€ä¸ªè§„åˆ™ï¼›ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå¯ä»¥å®šä¹‰Drools å¼•æ“ä¸­æ‰§è¡Œè§„åˆ™çš„æ–¹å¼å’Œæ—¶é—´</p><p><strong>è§„åˆ™ä¼˜å…ˆçº§ Salience for rules</strong></p><p>æ¯ä¸ªè§„åˆ™éƒ½æœ‰ä¸€ä¸ªç¡®å®šæ‰§è¡Œé¡ºåºçš„æ•´æ•°ä¼˜å…ˆçº§å±æ€§ï¼›å½“åœ¨æ¿€æ´»é˜Ÿåˆ—ä¸­æ’åºæ—¶ï¼Œå…·æœ‰è¾ƒé«˜ä¼˜å…ˆçº§å€¼çš„è§„åˆ™è¢«èµ‹äºˆæ›´é«˜çš„æ‰§è¡Œä¼˜å…ˆçº§</p><p>è§„åˆ™çš„é»˜è®¤ä¼˜å…ˆçº§ä¸º 0ï¼Œä½†ä¼˜å…ˆçº§å¯ä»¥è®¾ç½®ä¸ºè´Ÿæ•°æˆ–æ­£æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;RuleA&quot;</span></span><br><span class="line">salience <span class="number">95</span> &lt;-- <span class="built_in">this</span></span><br><span class="line">when</span><br><span class="line">    $fact : MyFact( field1 == <span class="literal">true</span> )</span><br><span class="line">then</span><br><span class="line">    System.out.println(<span class="string">&quot;Rule2 : &quot;</span> + $fact);</span><br><span class="line">    update($fact);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;RuleB&quot;</span></span><br><span class="line">salience <span class="number">100</span></span><br><span class="line">when</span><br><span class="line">   $fact : MyFact( field1 == <span class="literal">false</span> )</span><br><span class="line">then</span><br><span class="line">   System.out.println(<span class="string">&quot;Rule1 : &quot;</span> + $fact);</span><br><span class="line">   $fact.setField1(<span class="literal">true</span>);</span><br><span class="line">   update($fact);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>RuleB è§„åˆ™åˆ—åœ¨ä¸‹é¢ï¼Œä½†å®ƒçš„ä¼˜å…ˆçº§å€¼é«˜äº RuleA è§„åˆ™ï¼Œå› æ­¤é¦–å…ˆæ‰§è¡Œ</p><p><strong>è§„åˆ™äº‹é¡¹ç»„ Agenda groups for rules</strong></p><p>äº‹é¡¹ç»„æ˜¯ç”±åŒä¸€äº‹é¡¹ç»„è§„åˆ™å±æ€§ç»‘å®šåœ¨ä¸€èµ·çš„ä¸€ç»„è§„åˆ™</p><p>åœ¨ä»»ä½•æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªç»„çš„ç„¦ç‚¹ä½¿è¯¥ç»„è§„åˆ™ä¼˜å…ˆäºå…¶ä»–äº‹é¡¹ç»„ä¸­çš„è§„åˆ™æ‰§è¡Œï¼›å¯ä»¥é€šè¿‡å¯¹è®®ç¨‹ç»„çš„<code>setFocus</code> è°ƒç”¨æ¥ç¡®å®šç„¦ç‚¹</p><p>è¿˜å¯ä»¥å®šä¹‰å…·æœ‰ <code>auto-focus</code>å±æ€§çš„è§„åˆ™ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ¿€æ´»è§„åˆ™æ—¶ï¼Œå°†ç„¦ç‚¹è‡ªåŠ¨åˆ†é…ç»™è§„åˆ™æ‰€åˆ†é…çš„æ•´ä¸ªè®®ç¨‹ç»„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Increase balance for credits&quot;</span></span><br><span class="line">  agenda-group <span class="string">&quot;calculation&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod()</span><br><span class="line">  acc : Account( $accountNo : accountNo )</span><br><span class="line">  CashFlow( type == CREDIT,</span><br><span class="line">            accountNo == $accountNo,</span><br><span class="line">            date &gt;= ap.start &amp;&amp; &lt;= ap.end,</span><br><span class="line">            $amount : amount )</span><br><span class="line">then</span><br><span class="line">  acc.balance  += $amount;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Print balance for AccountPeriod&quot;</span></span><br><span class="line">  agenda-group <span class="string">&quot;report&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod()</span><br><span class="line">  acc : Account()</span><br><span class="line">then</span><br><span class="line">  System.out.println( acc.accountNo +</span><br><span class="line">                      <span class="string">&quot; : &quot;</span> + acc.balance );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œ<code>report</code>äº‹é¡¹ç»„ä¸­çš„è§„åˆ™å¿…é¡»å§‹ç»ˆé¦–å…ˆæ‰§è¡Œï¼Œ<code>calculation</code>äº‹é¡¹ç»„çš„è§„åˆ™å¿…é¡»æ€»æ˜¯å…¶æ¬¡æ‰§è¡Œï¼›ç„¶åå¯ä»¥æ‰§è¡Œå…¶ä»–è®®ç¨‹ç»„ä¸­çš„ä»»ä½•å‰©ä½™è§„åˆ™</p><p>å› æ­¤ï¼Œåœ¨æ‰§è¡Œå…¶ä»–è§„åˆ™ä¹‹å‰ï¼Œ<code>report</code> å’Œ<code>caclulation</code> ç»„å¿…é¡»æŒ‰è¯¥é¡ºåºæ¥æ”¶è¦æ‰§è¡Œçš„ç„¦ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Agenda</span> <span class="variable">agenda</span> <span class="operator">=</span> ksession.getAgenda();</span><br><span class="line">agenda.getAgendaGroup( <span class="string">&quot;report&quot;</span> ).setFocus();</span><br><span class="line">agenda.getAgendaGroup( <span class="string">&quot;calculation&quot;</span> ).setFocus();</span><br><span class="line">ksession.fireAllRules();</span><br></pre></td></tr></table></figure><p><strong>è§„åˆ™æ¿€æ´»ç»„ Activation groups for rules</strong></p><p>æ¿€æ´»ç»„æ˜¯ç”±ç›¸åŒçš„æ¿€æ´»ç»„è§„åˆ™å±æ€§ç»‘å®šåœ¨ä¸€èµ·çš„ä¸€ç»„è§„åˆ™</p><p>åœ¨è¯¥ç»„ä¸­åªèƒ½æ‰§è¡Œä¸€ä¸ªè§„åˆ™ï¼›åœ¨æ»¡è¶³æ‰§è¡Œè¯¥ç»„ä¸­çš„è§„åˆ™çš„æ¡ä»¶åï¼Œå°†ä»äº‹é¡¹ä¸­åˆ é™¤è¯¥æ¿€æ´»ç»„ä¸­çš„æ‰€æœ‰å…¶ä»–æŒ‚èµ·çš„è§„åˆ™æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Print balance for AccountPeriod1&quot;</span></span><br><span class="line">  activation-group <span class="string">&quot;report&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod1()</span><br><span class="line">  acc : Account()</span><br><span class="line">then</span><br><span class="line">  System.out.println( acc.accountNo +</span><br><span class="line">                      <span class="string">&quot; : &quot;</span> + acc.balance );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Print balance for AccountPeriod2&quot;</span></span><br><span class="line">  activation-group <span class="string">&quot;report&quot;</span></span><br><span class="line">when</span><br><span class="line">  ap : AccountPeriod2()</span><br><span class="line">  acc : Account()</span><br><span class="line">then</span><br><span class="line">  System.out.println( acc.accountNo +</span><br><span class="line">                      <span class="string">&quot; : &quot;</span> + acc.balance );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>åœ¨ç¤ºä¾‹ä¸­æ‰§è¡Œäº† <code>report</code>æ¿€æ´»ç»„ä¸­çš„å…¶ä¸­ä¸€æ¡è§„åˆ™ï¼Œåˆ™ç¬¬äºŒæ¡è§„åˆ™ä¸ä¼šæ‰§è¡Œ</p><p><strong>æ‰§è¡Œæ¨¡å¼å’Œçº¿ç¨‹å®‰å…¨ Rule execution modes and thread safety inthe Drools engine</strong></p><ul><li><strong>è¢«åŠ¨æ¨¡å¼</strong>ï¼ˆPassive modeï¼‰ï¼šå½“ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºæ˜¾å¼è°ƒç”¨<code>fireAllRules</code> æ—¶ï¼ŒDrools å¼•æ“ä¼šè¯„ä¼°è§„åˆ™</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KieSessionConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> KieServices.Factory.get().newKieSessionConfiguration();</span><br><span class="line">config.setOption( ClockTypeOption.get(<span class="string">&quot;pseudo&quot;</span>) );</span><br><span class="line"><span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kbase.newKieSession( conf, <span class="literal">null</span> );</span><br><span class="line"><span class="type">SessionPseudoClock</span> <span class="variable">clock</span> <span class="operator">=</span> session.getSessionClock();</span><br><span class="line"></span><br><span class="line">session.insert( tick1 );</span><br><span class="line">session.fireAllRules();</span><br><span class="line"></span><br><span class="line">clock.advanceTime(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">session.insert( tick2 );</span><br><span class="line">session.fireAllRules();</span><br><span class="line"></span><br><span class="line">clock.advanceTime(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">session.insert( tick3 );</span><br><span class="line">session.fireAllRules();</span><br><span class="line"></span><br><span class="line">session.dispose();</span><br></pre></td></tr></table></figure><ul><li><strong>æ´»åŠ¨æ¨¡å¼</strong>ï¼ˆActive modeï¼‰ï¼šå¦‚æœç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºè°ƒç”¨<code>fireUntilHalt</code>ï¼ŒDroolså¼•æ“ä»¥æ´»åŠ¨æ¨¡å¼å¯åŠ¨å¹¶ä¸æ–­è¯„ä¼°è§„åˆ™ï¼Œç›´åˆ°ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºæ˜¾å¼è°ƒç”¨<code>halt</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KieSessionConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> KieServices.Factory.get().newKieSessionConfiguration();</span><br><span class="line">config.setOption( ClockTypeOption.get(<span class="string">&quot;realtime&quot;</span>) );</span><br><span class="line"><span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kbase.newKieSession( conf, <span class="literal">null</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>( <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      session.fireUntilHalt();</span><br><span class="line">  &#125;</span><br><span class="line">&#125; ).start();</span><br><span class="line"></span><br><span class="line">session.insert( tick1 );</span><br><span class="line"></span><br><span class="line">... Thread.sleep( <span class="number">1000L</span> ); ...</span><br><span class="line"></span><br><span class="line">session.insert( tick2 );</span><br><span class="line"></span><br><span class="line">... Thread.sleep( <span class="number">1000L</span> ); ...</span><br><span class="line"></span><br><span class="line">session.insert( tick3 );</span><br><span class="line"></span><br><span class="line">session.halt();</span><br><span class="line">session.dispose();</span><br></pre></td></tr></table></figure><p><strong>äº‹å®ä¼ æ’­æ¨¡å¼ Fact propagation modes in the Droolsengine</strong></p><p>Drools å¼•æ“æ”¯æŒä»¥ä¸‹äº‹å®ä¼ æ’­æ¨¡å¼ï¼Œè¿™äº›æ¨¡å¼å†³å®š Droolså¼•æ“å¦‚ä½•é€šè¿‡å¼•æ“ç½‘ç»œå¤„ç†æ’å…¥çš„äº‹å®ï¼Œä¸ºè§„åˆ™æ‰§è¡Œåšå‡†å¤‡ï¼š</p><ul><li><strong>æƒ°æ€§</strong>ï¼ˆLazyï¼‰ï¼šï¼ˆé»˜è®¤ï¼‰äº‹å®åœ¨è§„åˆ™æ‰§è¡Œæ—¶ä»¥æ‰¹å¤„ç†é›†åˆçš„å½¢å¼ä¼ æ’­ï¼Œè€Œä¸æ˜¯å®æ—¶ä¼ æ’­ï¼Œå› ä¸ºäº‹å®æ˜¯ç”±ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºç‹¬ç«‹è®¾ç½®çš„ï¼›å› æ­¤äº‹å®æœ€ç»ˆé€šè¿‡Drools å¼•æ“ä¼ æ’­çš„é¡ºåºå¯èƒ½ä¸å•ç‹¬æ’å…¥äº‹å®çš„é¡ºåºä¸åŒï¼ˆæ²¡æœ‰é¡ºåºæ€§ï¼‰</li><li><strong>ç«‹å³</strong>ï¼ˆImmediateï¼‰ï¼šäº‹å®ä¼šæŒ‰ç…§ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºæ’å…¥çš„é¡ºåºç«‹å³ä¼ æ’­</li><li><strong>è¿«åˆ‡</strong>ï¼ˆEagerï¼‰ï¼šäº‹å®æ˜¯å»¶è¿Ÿä¼ æ’­çš„ï¼ˆåœ¨æ‰¹å¤„ç†é›†åˆä¸­ï¼‰ï¼Œä½†åœ¨è§„åˆ™æ‰§è¡Œä¹‹å‰Drools å¼•æ“å°†è¿™ç§ä¼ æ’­è¡Œä¸ºç”¨äºæ´»åŠ¨å±æ€§ä¸Š <code>no-loop</code> æˆ–<code>lock-on-active</code> çš„è§„åˆ™</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrools å¼•æ“ä¸­çš„ Phreakè§„åˆ™ç®—æ³•ä½¿ç”¨æƒ°æ€§äº‹å®ä¼ æ’­æ¥æ”¹è¿›æ€»ä½“è§„åˆ™è¯„ä¼°ï¼›ä½†æ˜¯åœ¨å°‘æ•°æƒ…å†µä¸‹è¿™ç§æƒ°æ€§ä¼ æ’­è¡Œä¸ºå¯èƒ½ä¼šæ”¹å˜æŸäº›è§„åˆ™æ‰§è¡Œçš„é¢„æœŸç»“æœï¼Œè¿™äº›è§„åˆ™æ‰§è¡Œå¯èƒ½éœ€è¦Immediate æˆ– Eager ä¼ æ’­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query <span class="title function_">Q</span> <span class="params">(Integer i)</span></span><br><span class="line">    String( <span class="built_in">this</span> == i.toString() )</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Rule&quot;</span></span><br><span class="line">  when</span><br><span class="line">    $i : Integer()</span><br><span class="line">    ?Q( $i; )</span><br><span class="line">  then</span><br><span class="line">    System.out.println( $i );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KieSession</span> <span class="variable">ksession</span> <span class="operator">=</span> ...</span><br><span class="line">ksession.insert(<span class="number">1</span>);</span><br><span class="line">ksession.insert(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">ksession.fireAllRules();</span><br></pre></td></tr></table></figure><p>è¯¥è§„åˆ™ä»ç„¶ä¼šè¢«å‘½ä¸­ï¼Œå› ä¸ºé»˜è®¤çš„ Lazy ä¼ æ’­å¤±å»äº†é¡ºåº</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦æ›´æ”¹ Drools å¼•æ“ä¼ æ’­æ¨¡å¼ä»¥å®ç°é¢„æœŸçš„è§„åˆ™è¯„ä¼°ï¼Œå¯ä»¥å°†<code>@propagation(&lt;type&gt;)</code>æ ‡è®°æ·»åŠ åˆ°è§„åˆ™ä¸­ï¼Œå¹¶å°†<code>&lt;type&gt;</code> è®¾ç½®ä¸º LAZYã€IMMEDIATE æˆ– EAGER</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query <span class="title function_">Q</span> <span class="params">(Integer i)</span></span><br><span class="line">    String( <span class="built_in">this</span> == i.toString() )</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Rule&quot;</span> <span class="meta">@Propagation(IMMEDIATE)</span></span><br><span class="line">  when</span><br><span class="line">    $i : Integer()</span><br><span class="line">    ?Q( $i; )</span><br><span class="line">  then</span><br><span class="line">    System.out.println( $i );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>äº‹é¡¹è¯„ä¼°è¿‡æ»¤å™¨ Agenda evaluation filters</strong></p><p>Drools å¼•æ“æ”¯æŒè¿‡æ»¤å™¨æ¥å£ä¸­çš„ <code>AgentaFilter</code>å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡åœ¨äº‹é¡¹è¯„ä¼°æœŸé—´å…è®¸æˆ–æ‹’ç»å¯¹æŒ‡å®šè§„åˆ™çš„è¯„ä¼°</p><p>å¯ä»¥æŒ‡å®šä¸€ä¸ªè®®ç¨‹è¿‡æ»¤å™¨ä½œä¸º <code>fireAllRules</code> è°ƒç”¨çš„ä¸€éƒ¨åˆ†</p><p>ä»¥ä¸‹ç¤ºä¾‹ä»£ç åªå…è®¸è¯„ä¼°å’Œæ‰§è¡Œä»¥å­—ç¬¦ä¸² â€œTestâ€ç»“å°¾çš„è§„åˆ™ï¼›æ‰€æœ‰å…¶ä»–è§„åˆ™éƒ½ä¼šä» Drools å¼•æ“äº‹é¡¹ä¸­è¿‡æ»¤æ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ksession.fireAllRules( <span class="keyword">new</span> <span class="title class_">RuleNameEndsWithAgendaFilter</span>( <span class="string">&quot;Test&quot;</span> ) );</span><br></pre></td></tr></table></figure><hr /><p>LiteFlow ä¸­å¯¹äºç»„ä»¶çš„æµç¨‹ä¹Ÿæœ‰å…¶æ§åˆ¶æœºåˆ¶</p><p>è™½ç„¶æ•´ä¸ªç»„ä»¶æ˜¯é€šè¿‡ EL è¡¨è¾¾å¼ç¼–æ’èµ·æ¥ï¼Œä½†æ˜¯å¯ä»¥é‡å†™<code>Component</code> ç›¸å…³çš„æ–¹æ³•è¿›ä¸€æ­¥è¿›è¡Œæµç¨‹æ§åˆ¶</p><p><strong>isAccess</strong> æ¨èå®ç° <code>isAccess</code>æ–¹æ³•ï¼Œè¡¨ç¤ºæ˜¯å¦è¿›å…¥è¯¥èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨äºä¸šåŠ¡å‚æ•°çš„é¢„å…ˆåˆ¤æ–­</p><p>è¿™é‡Œå®˜æ–¹æ–‡æ¡£å†™çš„æ¯”è¾ƒç®€å•ï¼›ä¸Šé¢æè¿‡ <code>Executable</code> å…¶ä¸­æœ‰<code>Node</code> å’Œ <code>Component</code> çš„å®ç°</p><ul><li>å¯¹äº <code>Node</code> è€Œè¨€ï¼Œ<code>isAccess</code>æ§åˆ¶è¯¥ç»„ä»¶æ˜¯å¦æ‰§è¡Œï¼Œä½†æ˜¯ä¸ä¼šå½±å“åç»­ç»„ä»¶çš„æ‰§è¡Œ</li><li>å¯¹äº <code>Condition</code>ï¼Œå› ä¸ºåç»­æµç¨‹éœ€è¦ç”±<code>Condition</code> æ¥è¿›è¡Œæ§åˆ¶ï¼Œä¾‹å¦‚<code>SwitchCondition</code>ã€<code>IfCondition</code>ï¼Œæ‰€ä»¥å¯¹äº<code>Condition</code> ç›¸å…³çš„ç»„ä»¶ <code>isAccess</code> ä¸º falseåˆ™è¯¥è·¯çº¿ä¸ä¼šå‘ä¸‹æ‰§è¡Œäº†</li></ul><p><strong>isEnd</strong> å¦‚æœè¦†ç›–åï¼Œè¿”å›trueï¼Œåˆ™è¡¨ç¤ºåœ¨è¿™ä¸ªç»„ä»¶æ‰§è¡Œå®Œä¹‹åç«‹é©¬ç»ˆæ­¢æ•´ä¸ªæµç¨‹</p><p>å¯¹äºè¿™ç§æ–¹å¼ï¼Œç”±äºæ˜¯ç”¨æˆ·ä¸»åŠ¨ç»“æŸçš„æµç¨‹ï¼Œå±äºæ­£å¸¸ç»“æŸï¼Œæ‰€ä»¥æœ€ç»ˆçš„<code>isSuccess</code> ä¸º true</p><p><strong>beforeProcess &amp; afterProcess</strong></p><p>æµç¨‹çš„å‰ç½®å’Œåç½®å¤„ç†å™¨ï¼Œå…¶ä¸­å‰ç½®å¤„ç†å™¨ï¼Œåœ¨ <code>isAccess</code>ä¹‹åæ‰§è¡Œ</p><p>æ‰€æœ‰ç»„ä»¶é€šç”¨çš„å‰ååˆ‡é¢å¯ä»¥ä½¿ç”¨åˆ‡é¢ç»„ä»¶<code>ICmpAroundAspect</code>ï¼›Spring ç¯å¢ƒä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ Spring Aspect</p><p><strong>onSuccess &amp; onError</strong></p><p>æµç¨‹çš„æˆåŠŸå¤±è´¥äº‹ä»¶å›è°ƒ</p><h1 id="ç®€å•åº”ç”¨">ç®€å•åº”ç”¨</h1><h2 id="ä»·æ ¼è®¡ç®—">ä»·æ ¼è®¡ç®—</h2><p>LiteFlow æœ‰ä¸€ä¸ª Demo æ¡ˆä¾‹ï¼Œå¯ä»¥ç®€å•äº†è§£æ˜¯å¦‚ä½•ä½¿ç”¨çš„</p><p><a href="https://liteflow.yomahub.com/pages/0a8188/">LiteFlow DEMOæ¡ˆä¾‹ 2 ä»·æ ¼è®¡ç®—</a></p><h2 id="é€šçŸ¥æ–‡æ¡ˆ">é€šçŸ¥æ–‡æ¡ˆ</h2><p>tutor-student-notify å¯¹äºå‘é€é€»è¾‘çš„å¤„ç†</p><p>äº§å“æ›¾ç»æè¿‡ç†æƒ³ä¸­çš„äº§å“ä½¿ç”¨ï¼ŒGUIé…ç½®ã€æ–‡æ¡ˆç¼–è¾‘ï¼Œä¸éœ€è¦ç ”å‘å‚ä¸ä¿®æ”¹ï¼›ä¸è¿‡ç°å®è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œè¿™é‡Œä½¿ç”¨LiteFlow å®ç°ä¸€ä¸ª Demo</p><p>ï¼ˆå…·ä½“çš„ä»£ç å°±ä¸ç²˜è´´åœ¨è¿™é‡Œäº†ï¼‰</p><p>è®¾è®¡çš„ç»„ä»¶ï¼š</p><ul><li>initContextCmpï¼šåˆå§‹åŒ–ä¸Šä¸‹æ–‡</li><li>lessonInfoCmpï¼šLesson ä¿¡æ¯è·å–</li><li>userInfoCmpï¼šUser ä¿¡æ¯è·å–</li><li>teacherInfoCmpï¼šTeacher ä¿¡æ¯è·å–</li><li>lowGradeJudgeCmpï¼š<code>IF</code> èŠ‚ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ä½å¹´çº§</li><li>templateKeySelectCmpï¼šé€šç”¨æ¨¡æ¿ key é€‰æ‹©æ¨¡æ¿ï¼Œå°† key å†™å…¥Contextï¼Œéœ€è¦ç»„ä»¶å‚æ•°<ul><li>ç»„ä»¶å‚æ•°ï¼šæ¨¡æ¿ key</li></ul></li><li>customerHotlineCmpï¼šå®¢æœç”µè¯å‚æ•°<ul><li>ç»„ä»¶å‚æ•°ï¼šå®¢æœç”µè¯é…ç½®</li></ul></li><li>userNameParamCmpï¼šç”¨æˆ·æ˜µç§°å‚æ•°</li><li>lessonNameParamCmpï¼šç­è¯¾åç§°å‚æ•°<ul><li>ç»„ä»¶å‚æ•°ï¼šå ä½ç¬¦ name å’Œæ±‚å€¼è¡¨è¾¾å¼</li></ul></li><li>sendCmpï¼šå‘é€</li></ul><p>è§„åˆ™ EL</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;lessonDeliveredEvent&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            initContextCmp,</span><br><span class="line">            WHEN(</span><br><span class="line">                THEN(lessonInfoCmp,teacherInfoCmp),</span><br><span class="line">                userInfoCmp),</span><br><span class="line">            IF(</span><br><span class="line">                lowGradeJudgeCmp,</span><br><span class="line">                templateKeySelectCmp.data(&#x27;low-grade&#x27;),</span><br><span class="line">                THEN(templateKeySelectCmp.data(&#x27;high-grade&#x27;),customerHotlineCmp.data(&#x27;10086&#x27;))</span><br><span class="line">            ),</span><br><span class="line">            WHEN(userNameParamCmp,lessonNameParamCmp.data(&#x27;&#123;&quot;paramName&quot;:&quot;lessonName&quot;,&quot;qlExpress&quot;:&quot;ã€Š lessonName ã€‹&quot;&#125;&#x27;)),</span><br><span class="line">            sendCmp</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ç°æœ‰ä¸šåŠ¡---é€€è¯¾é€€æ¬¾">ç°æœ‰ä¸šåŠ¡ - é€€è¯¾é€€æ¬¾</h2><p>tutor-lesson-orderæœåŠ¡ä¸­å¯¹äºé€€æ¬¾æµç¨‹çš„å¤„ç†ï¼Œæ„Ÿè§‰å¾ˆæ¥è¿‘æµç¨‹å¼è§„åˆ™çš„æ€æƒ³</p><ul><li>Pipelineã€ç»„ä»¶åŒ–ã€ç»„ä»¶ç¼–æ’</li><li>å¹¶å‘ç¼–æ’</li><li>Context è®¾è®¡å’Œå·¥ä½œå°æ¨¡å¼</li></ul><h3 id="ä¸Šä¸‹æ–‡">ä¸Šä¸‹æ–‡</h3><p><code>RefundContext</code> æ˜¯å…¶é€€æ¬¾ä¸šåŠ¡ä¸Šä¸‹æ–‡çš„åŸºç±»</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/RefundContext.png" class="" title="RefundContext"><p>ä»¥å®ç‰©å•†å“é€€æ¬¾æµç¨‹ä¸Šä¸‹æ–‡<code>PhysicalCommodityRootRefundContext</code> ä¸ºä¾‹</p><ul><li>PhysicalCommodityRootRefundContextï¼šå®ç‰©å•†å“</li><li>UnboxedRootRefundContextï¼šéç›’å­<ul><li>OrderItemEO</li><li>LessonDigest</li><li>LessonOrderEO</li><li>partRefund</li><li>refundQuantity</li><li>code</li><li>extraMap</li></ul></li><li>StandardRootRefundContextï¼šåŸºç¡€é€€æ¬¾æ•°æ®<ul><li>baseParam</li><li>refundConfig</li><li>refundTs</li><li>bizRefundInfoMap</li><li>mergedRefundInfo</li></ul></li></ul><p>è®¡ç®—èŠ‚ç‚¹äº§å‡ºçš„æ–°å¯¹è±¡ä¸º <code>NestedContext</code> å®ç°ç±»ï¼Œä¾é <code>BaseNestedRefundContext</code> è¿›è¡Œè¿æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseNestedRefundContext</span> <span class="keyword">implements</span> <span class="title class_">NestedContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> NestedContext parent;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, NestedContext&gt; children;</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œé“¾">æ‰§è¡Œé“¾</h3><p>æ‰§è¡Œé“¾çš„æ ¸å¿ƒç±»æ˜¯ <code>RefundPipeline</code></p><p>ç»„é“¾æ“ä½œç”± <code>RefundPipelineService</code> æä¾›<code>RefundTask</code> å®ç°ç±»çš„ beanï¼Œ<code>RefundPipelines</code>ä½œä¸ºå·¥å…·ç±»ï¼Œæä¾› <code>RefundTaskGroupConfig</code> æ˜ å°„çœŸå®çš„ beanä»¥åŠæœ€åçš„ç»„è£…</p><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;RefundTask[]&gt; groupTasks(List&lt;RefundTask&gt; allTasks, RefundTaskGroupConfig groupConfig) &#123;</span><br><span class="line">    <span class="keyword">return</span> groupConfig.keySet().stream().sorted().map(groupId -&gt; &#123;</span><br><span class="line">        Collection&lt;String&gt; taskNames = groupConfig.get(groupId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> allTasks.stream()</span><br><span class="line">                .filter(task -&gt; taskNames.contains(task.getName()))</span><br><span class="line">                .collect(Collectors.toList())</span><br><span class="line">                .toArray(<span class="keyword">new</span> <span class="title class_">RefundTask</span>[]&#123;&#125;);</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="è®¡ç®—èŠ‚ç‚¹-æ‰§è¡ŒèŠ‚ç‚¹">è®¡ç®—èŠ‚ç‚¹ &amp; æ‰§è¡ŒèŠ‚ç‚¹</h3><p>unboxed ç­è¯¾é€€æ¬¾æµç¨‹</p><ul><li><strong>åŠ è½½èŠ‚ç‚¹ &amp; è®¡ç®—èŠ‚ç‚¹</strong> Pipeline<ul><li>ã€0ã€‘base info loader<ul><li>unboxed_base_ctx_loader</li></ul></li><li>ã€1ã€‘biz loader<ul><li>gift_order_loader</li><li>textbook_refund_loader</li><li>dual_coupon_loader</li><li>marketing_activity_refund_loader</li><li></li></ul></li><li>ã€100ã€‘biz calculator<ul><li>gift_order</li><li>dual_coupon</li><li>lesson_textbook</li><li>marketing_activity_refund_calc</li></ul></li><li>ã€101ã€‘<ul><li>lesson_agenda</li></ul></li><li>ã€1000ã€‘merge calculator<ul><li>merge_refund</li></ul></li></ul></li><li><strong>æ‰§è¡ŒèŠ‚ç‚¹</strong> Pipeline<ul><li>ã€0ã€‘<ul><li>refund_lesson_order</li></ul></li><li>ã€1ã€‘</li><li>ã€2ã€‘<ul><li>gift_order_post</li><li>lesson_order_delivery</li><li>record_refund</li><li>dual_coupon_post</li><li>marketing_activity_refund_post</li></ul></li></ul></li></ul><blockquote><p><em>æ€è€ƒï¼šç»„ä»¶åŒ–åå¦‚ä½•ä¿è¯ç¼–æ’çš„æ­£ç¡®æ€§</em></p><p><em>å¦‚ä¸Šï¼Œå¦‚æœæ‰§è¡ŒèŠ‚ç‚¹è¢«é…ç½®åˆ°äº†è®¡ç®—èŠ‚ç‚¹ä¹‹å‰ä¼šå‡ºç°é—®é¢˜ï¼›ä½œä¸ºå·¥ä½œå°æ¨¡å¼ï¼Œæ€»ä¹‹å…·æœ‰å‰åé¡ºåºçš„ç»„ä»¶é¡ºåºé”™è¯¯å°±ä¼šå¯¼è‡´æµç¨‹çš„é”™è¯¯</em></p><p><em>1. ç»„ä»¶é—´è§£è€¦ï¼Œä½†è¿˜æ˜¯éœ€è¦æ³¨æ„ç»„ä»¶ä¹‹é—´çš„æµç¨‹ç¼–æ’</em></p><p><em>2.å¦‚ä½•å¯¹ç»„ä»¶çš„ç¼–æ’è¿›è¡Œæ ¡éªŒ</em></p></blockquote><h3 id="ä»»åŠ¡-å¹¶å‘ç¼–æ’">ä»»åŠ¡ / å¹¶å‘ç¼–æ’</h3><p><code>RefundTaskGroupConfig</code> ç”¨æ¥æè¿°ä»»åŠ¡é…ç½®<code>private final Map&lt;Integer, Collection&lt;String&gt;&gt; configValue;</code></p><p>å…¶å±æ€§ <code>configValue</code> çš„ key ç”¨æ¥æè¿°å¹¶å‘åˆ†ç»„å³é¡ºåºï¼Œvalueä¸º <code>RefundTask</code> bean name çš„é›†åˆ</p><p><code>RefundTaskGroup</code> ç”¨æ¥å°è£…å¹¶å‘ç¼–æ’çš„ä»»åŠ¡</p><p>RefundTaskGroup</p><ul><li>tasksï¼š<code>RefundTask</code> é›†åˆï¼ŒåŒ…å«äº†å½“å‰ groupéœ€è¦å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡</li><li>pipelineï¼š<code>RefundPipeline</code> å’Œ<code>RefundTaskGroup</code> äº’ç›¸æŒæœ‰</li></ul><p>ä¸ºä»€ä¹ˆè¿™ä¸ªåœ°æ–¹ group éœ€è¦æŒæœ‰ pipeline èŠ‚ç‚¹ï¼Ÿå› ä¸º task è¢« groupæŒæœ‰ï¼Œcontext è¢« pipeline æŒæœ‰ï¼Œè€Œ task çš„è¿è¡Œéœ€è¦ context</p><p>æ•´ä¸ª pipeline æ¨¡å¼ä¸‹å¯¹è±¡ä¹‹é—´çš„å…³ç³»</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/%E8%AE%A2%E5%8D%95%E9%80%80%E6%AC%BE%E7%B1%BB%E7%BB%93%E6%9E%84.png" class="" title="è®¢å•é€€æ¬¾ç±»ç»“æ„"><h3 id="liteflow-dsl">LiteFlow DSL</h3><p>ä¸Šè¿°ä¸šåŠ¡å¯¹èŠ‚ç‚¹çš„ç¼–æ’ç›¸å½“äº LiteFlow ä¸­çš„ <code>WHEN</code> å’Œ<code>THEN</code></p><p>å¦‚æœè¡¨ç¤ºä¸ºæµç¨‹å›¾</p><img src="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/refund%20%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png" class="" title="refund æµç¨‹å›¾.drawio"><p>å¦‚æœä½¿ç”¨ LiteFLow çš„ EL è¡¨ç¤º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">flow</span> <span class="keyword">PUBLIC</span>  <span class="string">&quot;liteflow&quot;</span> <span class="string">&quot;liteflow.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;physical_commodity_calculation_task_group_config&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            unboxed_base_ctx_loader,</span><br><span class="line">            WHEN(</span><br><span class="line">                gift_order_loader,</span><br><span class="line">                textbook_refund_loader,</span><br><span class="line">                dual_coupon_loader,</span><br><span class="line">                marketing_activity_refund_loader,</span><br><span class="line">                lesson_extra_loader</span><br><span class="line">            ),</span><br><span class="line">            WHEN(</span><br><span class="line">                gift_order,</span><br><span class="line">                dual_coupon,</span><br><span class="line">                lesson_textbook,</span><br><span class="line">                marketing_activity_refund_calc</span><br><span class="line">            ),</span><br><span class="line">            lesson_agenda,</span><br><span class="line">            merge_refund</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;standard_refunding_task_group_config&quot;</span>&gt;</span></span><br><span class="line">        THEN(</span><br><span class="line">            refund_lesson_order,</span><br><span class="line">            WHEN(</span><br><span class="line">                gift_order_post,</span><br><span class="line">                lesson_order_delivery,</span><br><span class="line">                record_refund,</span><br><span class="line">                dual_coupon_post,</span><br><span class="line">                marketing_activity_refund_post</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">chain</span> <span class="attr">name</span>=<span class="string">&quot;physical_commodity_refund&quot;</span>&gt;</span></span><br><span class="line">        THEN(physical_commodity_calculation_task_group_config, standard_refunding_task_group_config);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">chain</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="ai-ç»“åˆæ€è€ƒ">AI ç»“åˆæ€è€ƒ</h1><p>è‡ªä»ä»Šå¹´ AI æˆä¸ºçƒ­é¢˜åï¼Œå„ç•Œéƒ½åœ¨è€ƒè™‘å¦‚ä½•ä½¿ç”¨ AIæä¾›æ–°äº§å“ã€æé«˜ç”Ÿäº§åŠ›</p><p>AIæŠ€æœ¯å¯ä»¥å¸®åŠ©ç¨‹åºå‘˜æ›´å¿«åœ°å®Œæˆä¸€äº›ç¹çã€é‡å¤æ€§çš„ä»»åŠ¡ï¼Œå¦‚ä»£ç å®¡æŸ¥ã€æµ‹è¯•ã€è°ƒè¯•ç­‰ï¼›æ­¤å¤–ï¼ŒAIè¿˜å¯ä»¥é€šè¿‡è‡ªåŠ¨åŒ–ä¸€äº›æµç¨‹å’Œå·¥ä½œæµç¨‹æ¥ç®€åŒ–å¼€å‘æµç¨‹ï¼Œä»è€Œæé«˜ç”Ÿäº§æ•ˆç‡</p><p>è€Œè§„åˆ™å¼•æ“çš„è§„åˆ™ç¼–æ’ã€ç”šè‡³æ˜¯è„šæœ¬è¯­æ³•ç›¸æ¯”é€»è¾‘ä»£ç ç”± AIè¾…åŠ©æˆ‘è®¤ä¸ºæ›´é€‚åˆï¼Œç”šè‡³å®ç°ä¸Šå¯èƒ½æ›´ç®€å•ï¼š</p><ul><li>è§„åˆ™ç¼–æ’æœ‰æ—¶ç”±ä¸šåŠ¡ã€äº§å“ã€æ•°æ®è¿›è¡Œç¼–å†™ï¼Œä¸èƒ½ä½¿ç”¨å¤æ‚çš„å¼€å‘è¯­è¨€ï¼›å¯ä»¥ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°AI è½¬æ¢è§„åˆ™</li><li>è§„åˆ™å¾€å¾€è¢«é™å®šåœ¨ä¸€ä¸ªè¾ƒå°çš„ä¸šåŠ¡èŒƒå›´å†…ï¼ŒAIæ‰€éœ€çš„ä¸Šä¸‹æ–‡è¾ƒå°‘ï¼Œç»“æœæ›´åŠ å‡†ç¡®</li><li>AI æ˜¯å¦å¯ä»¥é¿å…è§„åˆ™å†²çªã€æµç¨‹å®šä¹‰é”™è¯¯çš„äººå·¥é”™è¯¯</li></ul><h2 id="drools-drl-cep">Drools DRL &amp; CEP</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘å°†ä¼šç»™ä¸€æ®µè‡ªç„¶è¯­è¨€æè¿°ï¼Œå°†å…¶è½¬æ¢ä¸º Drools çš„ DRL è§„åˆ™</p><p>æ¯å½“ BuyOrder äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç­‰å¾…åŒ¹é…çš„ AckOrder äº‹ä»¶ 10sçš„æ—¶é—´ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œåˆ™å‘é€çŸ­ä¿¡ç»™ç”¨æˆ·</p><p><strong>ç­”ï¼š</strong></p><p>ä¸‹é¢æ˜¯å°†è‡ªç„¶è¯­è¨€æè¿°è½¬æ¢ä¸º Drools DRL è§„åˆ™çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">rule <span class="string">&quot;Match AckOrder and Send SMS&quot;</span></span><br><span class="line">when</span><br><span class="line">    <span class="comment">// å½“ BuyOrder äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç­‰å¾… 10s åŒ¹é… AckOrder äº‹ä»¶</span></span><br><span class="line">    $buyOrder: BuyOrder()</span><br><span class="line">    not <span class="title function_">AckOrder</span><span class="params">(<span class="built_in">this</span> after[0s, 10s] $buyOrder)</span></span><br><span class="line">then</span><br><span class="line">    <span class="comment">// åŒ¹é…æˆåŠŸï¼Œå‘é€çŸ­ä¿¡ç»™ç”¨æˆ·</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Your order has been acknowledged. Thank you for your purchase!&quot;</span>;</span><br><span class="line">    sendSMS($buyOrder.getPhoneNumber(), message);</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªè§„åˆ™ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¼å…¥äº† Java ä¸­çš„ TimeUnit ç±»ï¼Œç”¨äºæŒ‡å®šç­‰å¾… 10ç§’çš„æ—¶é—´</p><p>ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º "Match AckOrder and Send SMS"çš„è§„åˆ™ï¼Œå…¶ä¸­ï¼š</p><ul><li>å½“ BuyOrder äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä½¿ç”¨ not å…³é”®å­—ç­‰å¾… 10 ç§’æ¥åŒ¹é… AckOrderäº‹ä»¶</li><li>å¦‚æœåœ¨ 10 ç§’å†…æˆåŠŸåŒ¹é…åˆ° AckOrder äº‹ä»¶ï¼Œåˆ™å°†ä¼šæ‰§è¡Œ then è¯­å¥</li><li>åœ¨ then è¯­å¥ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ $buyOrder å¯¹è±¡çš„ getPhoneNumber()æ–¹æ³•è·å–ç”¨æˆ·çš„ç”µè¯å·ç ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€ç»™ç”¨æˆ·</li></ul><h2 id="é˜…è¯»-drl-è§„åˆ™">é˜…è¯» DRL è§„åˆ™</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘å°†ä¼šç»™ä½ ä¸€æ®µ Drools DRL è§„åˆ™ï¼Œè¯·ç”¨ä¸­æ–‡æè¿°è¿™æ®µè§„åˆ™çš„å«ä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&quot;Underage&quot;</span></span><br><span class="line">  salience <span class="number">15</span></span><br><span class="line">  agenda-group <span class="string">&quot;applicationGroup&quot;</span></span><br><span class="line">  when</span><br><span class="line">    $application : LoanApplication()</span><br><span class="line">    Applicant( age &lt; <span class="number">21</span> )</span><br><span class="line">  then</span><br><span class="line">    $application.setApproved( <span class="literal">false</span> );</span><br><span class="line">    $application.setExplanation( <span class="string">&quot;Underage&quot;</span> );</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><strong>ç­”ï¼š</strong></p><p>è¿™æ®µ Drools DRL è§„åˆ™çš„å«ä¹‰æ˜¯ï¼š</p><p>å½“è§„åˆ™å¼•æ“åŒ¹é…åˆ°ä¸€ä¸ªåä¸º LoanApplication çš„å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä¸­çš„ Applicantå¯¹è±¡çš„ age å±æ€§å°äº 21 å²æ—¶ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªè§„åˆ™</p><p>è¯¥è§„åˆ™çš„ä¼˜å…ˆçº§ä¸º 15ï¼Œå®ƒå±äº agenda-group "applicationGroup" ç»„</p><p>è§¦å‘è§„åˆ™åï¼Œè§„åˆ™å¼•æ“ä¼šå°† <code>$application</code> å¯¹è±¡çš„<code>approved</code> å±æ€§è®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºä¸æ‰¹å‡†è¯¥è´·æ¬¾ç”³è¯·ï¼›åŒæ—¶ï¼Œå®ƒä¼šå°† <code>$application</code>å¯¹è±¡çš„ <code>explanation</code> å±æ€§è®¾ç½®ä¸º<code>Underage</code>ï¼Œè¡¨ç¤ºä¸æ‰¹å‡†è¯¥è´·æ¬¾ç”³è¯·çš„åŸå› æ˜¯ç”³è¯·äººæœªè¾¾åˆ°æ³•å®šå¹´é¾„</p><h2 id="è‡ªç„¶è¯­è¨€è¾…åŠ©ç”Ÿæˆ-dsl-è§„åˆ™">è‡ªç„¶è¯­è¨€è¾…åŠ©ç”Ÿæˆ DSL è§„åˆ™</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘å°†ä¼šä½¿ç”¨è¯­è¨€æè¿°è§„åˆ™ï¼Œå¸®æˆ‘ç”Ÿæˆ Drools DSL æ–‡ä»¶</p><ul><li>å½“ç”¨æˆ·è´­ä¹°å•†å“ä¸ºä¿ƒé”€å•†å“ï¼Œå¹¶ä¸”ç”¨æˆ·ä¸ºæ™®é€šä¼šå‘˜ï¼Œåˆ™æ‰“å°æ—¥å¿—â€œå½“å‰ç”¨æˆ·ä¸ºæ™®é€šä¼šå‘˜â€ï¼Œè¡Œä¸ºæ˜¯å•†å“ä»·æ ¼æ‰“ 9 æŠ˜</li><li>å½“ç”¨æˆ·è´­ä¹°å•†å“ä¸ºä¿ƒé”€å•†å“ï¼Œå¹¶ä¸”ç”¨æˆ·ä¸ºé»„é‡‘ä¼šå‘˜ï¼Œåˆ™æ‰“å°æ—¥å¿—â€œå½“å‰ç”¨æˆ·ä¸ºæ™®é€šä¼šå‘˜â€ï¼Œè¡Œä¸ºä¸ºå•†å“ä»·æ ¼æ‰“ 8 æŠ˜</li></ul><p><strong>ç­”ï¼š</strong></p><p>æ ¹æ®ä½ çš„è¦æ±‚ï¼Œå°†ä¸Šè¿°åœºæ™¯è½¬æ¢ä¸ºå¸¦æœ‰è¡¨è¾¾å¼è½¬æ¢çš„å½¢å¼ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„Drools DSL æ–‡ä»¶ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[when]</span> There is <span class="selector-tag">a</span> purchase = <span class="variable">$p</span>:<span class="built_in">Purchase</span>()</span><br><span class="line"><span class="selector-attr">[when]</span> - purchase is promotional = <span class="variable">$p</span><span class="selector-class">.promotionalItem</span> == true</span><br><span class="line"><span class="selector-attr">[when]</span> - user is <span class="selector-tag">a</span> standard member = <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> == <span class="string">&quot;Standard&quot;</span></span><br><span class="line"><span class="selector-attr">[then]</span> print = System<span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">&quot;The current user is a&quot;</span> + <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> + <span class="string">&quot; member&quot;</span>)</span><br><span class="line"><span class="selector-attr">[then]</span> The product price is discounted by &#123;discount:\d*&#125;% = <span class="variable">$p</span><span class="selector-class">.productPrice</span> = <span class="variable">$p</span><span class="selector-class">.productPrice</span> * (<span class="number">100</span> - &#123;discount&#125;) / <span class="number">100</span></span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[when]</span> There is <span class="selector-tag">a</span> purchase = <span class="variable">$p</span>:<span class="built_in">Purchase</span>()</span><br><span class="line"><span class="selector-attr">[when]</span> - purchase is promotional = <span class="variable">$p</span><span class="selector-class">.promotionalItem</span> == true</span><br><span class="line"><span class="selector-attr">[when]</span> - user is <span class="selector-tag">a</span> gold member = <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> == <span class="string">&quot;Gold&quot;</span></span><br><span class="line"><span class="selector-attr">[then]</span> print = System<span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">&quot;The current user is a &quot;</span> + <span class="variable">$p</span><span class="selector-class">.user</span><span class="selector-class">.membershipLevel</span> + <span class="string">&quot; member&quot;</span>)</span><br><span class="line"><span class="selector-attr">[then]</span> The product price is discounted by &#123;discount:\d*&#125;% = <span class="variable">$p</span><span class="selector-class">.productPrice</span> = <span class="variable">$p</span><span class="selector-class">.productPrice</span> * (<span class="number">100</span> - &#123;discount&#125;) / <span class="number">100</span></span><br></pre></td></tr></table></figure><p>DSLR</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">&#x27;discount_standard_user&#x27;</span></span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">    There is a purchase</span><br><span class="line">    - purchase is promotional</span><br><span class="line">  - user is a standard member</span><br><span class="line">then</span><br><span class="line">    print</span><br><span class="line">  The product price is discounted by <span class="number">10</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="é˜…è¯»-liteflow-æµç¨‹å›¾å¼-el">é˜…è¯» LiteFlow æµç¨‹å›¾å¼ EL</h2><p><strong>é—®ï¼š</strong></p><p>æˆ‘è®¾è®¡å¦‚ä¸‹è¯­æ³•ï¼š</p><ul><li><code>THEN</code> è¡¨ç¤ºä¸²è¡Œï¼›å¦‚ <code>TEHN(A,B,C)</code> è¡¨ç¤ºæ‰§è¡Œ Aåæ‰§è¡Œ Bï¼Œæœ€åæ‰§è¡Œ C</li><li><code>WHEN</code> è¡¨ç¤ºå¹¶è¡Œï¼›å¦‚ <code>WHEN(A,B)</code> è¡¨ç¤º A å’Œ Bæ˜¯å¹¶è¡Œçš„ï¼› <code>WHEN(A,then(B,C))</code> è¡¨ç¤º A å’Œ Bã€Cä¹‹é—´çš„æ‰§è¡Œæ˜¯å¹¶è¡Œçš„ï¼ŒB å’Œ C çš„æ‰§è¡Œæ˜¯ä¸²è¡Œçš„</li><li><code>SWITCH</code>è¡¨ç¤ºé€‰æ‹©ï¼Œä¼šæ ¹æ®è¿”å›å€¼å¯¹ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ç»„ä»¶è¿›è¡Œé€‰æ‹©ï¼›å¦‚<code>SWITCH(A).to(B,C,D)</code>ï¼Œä¼šæ‰§è¡Œç»„ä»¶Aï¼Œæ ¹æ®è¿”å›å€¼å†³å®šåé¢çš„æµç¨‹æ˜¯æ‰§è¡Œ B æˆ–è€… C æˆ–è€… D</li><li><code>IF</code>è¡¨ç¤ºåˆ¤æ–­ï¼Œä¼šæ ¹æ®è¿”å›çš„å¸ƒå°”ç±»å‹é€‰æ‹©ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ç»„ä»¶ï¼›å¦‚<code>IF(A,B,C)</code>ï¼Œæ‰§è¡Œç»„ä»¶ Aï¼Œå¦‚æœè¿”å›å€¼æ˜¯ true åˆ™æ‰§è¡ŒBï¼Œå¦‚æœè¿”å›å€¼æ˜¯ false åˆ™æ‰§è¡Œ Cï¼›å¦‚æœæ˜¯ <code>IF(A,B)</code>ï¼Œåˆ™ falseæ—¶ä¸ä¼šæ‰§è¡Œ</li></ul><p>ä¸Šè¿°æ‰€æœ‰çš„å…³é”®è¯æ”¯æŒåµŒå¥—</p><p>ç°åœ¨æˆ‘å°†ä¼šç»™ä½ ä¸€æ®µç”±ä¸Šè¿°è¯­æ³•ç»„æˆçš„è¡¨è¾¾å¼ï¼Œå¸®æˆ‘ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‰€è¿›è¡Œçš„æ“ä½œ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">THEN(</span><br><span class="line">     unboxed_base_ctx_loader,</span><br><span class="line">     WHEN(</span><br><span class="line">         gift_order_loader,</span><br><span class="line">         textbook_refund_loader,</span><br><span class="line">         dual_coupon_loader,</span><br><span class="line">         marketing_activity_refund_loader,</span><br><span class="line">         lesson_extra_loader</span><br><span class="line">     ),</span><br><span class="line">     WHEN(</span><br><span class="line">         gift_order,</span><br><span class="line">         dual_coupon,</span><br><span class="line">         lesson_textbook,</span><br><span class="line">         marketing_activity_refund_calc</span><br><span class="line">     ),</span><br><span class="line">     lesson_agenda,</span><br><span class="line">     merge_refund</span><br><span class="line"> );</span><br></pre></td></tr></table></figure><p><strong>ç­”ï¼š</strong></p><p>è¿™ä¸ªè¡¨è¾¾å¼æè¿°äº†ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š</p><ol type="1"><li>é¦–å…ˆæ‰§è¡Œ <code>unboxed_base_ctx_loader</code> ç»„ä»¶</li><li>æ¥ç€æ‰§è¡Œä¸¤ä¸ªå¹¶è¡Œçš„ç»„ä»¶åºåˆ—ï¼Œç¬¬ä¸€ä¸ªå¹¶è¡Œåºåˆ—åŒ…æ‹¬<code>gift_order_loader</code>ã€<code>textbook_refund_loader</code>ã€<code>dual_coupon_loader</code>ã€<code>marketing_activity_refund_loader</code>å’Œ <code>lesson_extra_loader</code>è¿™äº›ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¼šåŒæ—¶æ‰§è¡Œï¼›ç¬¬äºŒä¸ªå¹¶è¡Œåºåˆ—åŒ…æ‹¬<code>gift_order</code>ã€<code>dual_coupon</code>ã€<code>lesson_textbook</code>å’Œ <code>marketing_activity_refund_calc</code>è¿™äº›ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¹Ÿä¼šåŒæ—¶æ‰§è¡Œ</li><li>æ‰§è¡Œ <code>lesson_agenda</code> ç»„ä»¶</li><li>æœ€åæ‰§è¡Œ <code>merge_refund</code> ç»„ä»¶</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬ä¸€ä¸ªå¹¶è¡Œåºåˆ—ä¸­çš„æ‰€æœ‰ç»„ä»¶éƒ½éœ€è¦åœ¨ç¬¬ä¸€ä¸ªæ­¥éª¤ä¸­æ‰§è¡Œå®Œæ¯•åæ‰èƒ½å¼€å§‹æ‰§è¡Œï¼Œè€Œç¬¬äºŒä¸ªå¹¶è¡Œåºåˆ—ä¸­çš„æ‰€æœ‰ç»„ä»¶éƒ½éœ€è¦åœ¨ç¬¬ä¸€ä¸ªå¹¶è¡Œåºåˆ—ä¸­çš„ç»„ä»¶å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åæ‰èƒ½å¼€å§‹æ‰§è¡Œï¼›å¦å¤–ï¼Œæ‰§è¡Œ<code>marketing_activity_refund_calc</code> ç»„ä»¶çš„å‰ææ˜¯æ‰§è¡Œ<code>dual_coupon</code> å’Œ <code>gift_order</code> ç»„ä»¶ï¼Œè€Œæ‰§è¡Œ<code>merge_refund</code> ç»„ä»¶çš„å‰ææ˜¯æ‰§è¡Œæ‰€æœ‰å…¶ä»–ç»„ä»¶</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><p>åšå®¢</p><ul><li><p><ahref="https://martinfowler.com/bliki/RulesEngine.html">RulesEngine(martinfowler.com)</a></p></li><li><p><a href="https://refactoring.guru/design-patterns/catalog">TheCatalog of Design Patterns (refactoring.guru)</a></p></li></ul></li><li><p>å®˜æ–¹æ–‡æ¡£</p><ul><li><a href="https://www.drools.org/learn/documentation.html">Drools -Documentation</a></li><li><a href="https://liteflow.yomahub.com/">LiteFlow(yomahub.com)</a></li><li><a href="http://waitmoon.com/zh/">å¼€æºæ¡†æ¶å­¦ä¹ ä¸åˆ†äº« | ice(waitmoon.com)</a></li><li><ahref="https://www.yuque.com/boyan-avfmj/aviatorscript/guhmrc">AviatorScriptæ–‡æ¡£ | ä»‹ç» (yuque.com)</a></li></ul></li><li><p>æŠ€æœ¯æ–‡ç« </p><ul><li><ahref="https://tech.meituan.com/2017/06/09/maze-framework.html">ä»0åˆ°1ï¼šæ„å»ºå¼ºå¤§ä¸”æ˜“ç”¨çš„è§„åˆ™å¼•æ“- ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a></li><li><ahref="https://juejin.cn/post/6844903593326182414">å¤§æ•°æ®ï¼šç¾å›¢é…’æ—…å®æ—¶æ•°æ®è§„åˆ™å¼•æ“åº”ç”¨å®è·µ- æ˜é‡‘ (juejin.cn)</a></li><li><ahref="https://juejin.cn/post/7234763686475219003">è§„åˆ™å¼•æ“åœ¨å†…å®¹ç®¡ç†ä¸­çš„æ¢ç´¢ä¸åº”ç”¨- æ˜é‡‘ (juejin.cn)</a></li><li><ahref="https://juejin.cn/post/7195452429154910263">è´§æ‹‰æ‹‰å¤§æ•°æ®åŸºäºè§„åˆ™å¼•æ“æ„å»ºè¿åŠ›èµ„æºä¾›éœ€è°ƒèŠ‚ç³»ç»Ÿ- æ˜é‡‘ (juejin.cn)</a></li><li><ahref="https://blog.csdn.net/zhuanzhuantech/article/details/127648871">è½¬è½¬å›¾ä¹¦å¯¹åŸºäºDroolså¼•æ“çš„DMNå®è·µ_dmnå¼•æ“_è½¬è½¬æŠ€æœ¯å›¢é˜Ÿçš„åšå®¢-CSDNåšå®¢</a></li><li><a href="http://www.uml.org.cn/modeler/201912044.asp">DMNå†³ç­–æ¨¡å‹æ ‡è®°ä»‹ç» (uml.org.cn)</a></li><li><a href="https://www.jianshu.com/p/650ecc341417">Droolsï¼šè§„åˆ™åŠ è½½&amp; åŠ¨æ€æ›´æ–°æ–¹æ¡ˆ</a></li></ul></li><li><p>å¼€æºè½¯ä»¶</p><ul><li><ahref="https://github.com/hyperjumptech/grule-rule-engine#use-cases">hyperjumptech/grule-rule-engine:Rule engine implementation in Golang (github.com)</a></li><li><a href="https://github.com/momosecurity/aswan">momosecurity/aswan:é™Œé™Œé£æ§ç³»ç»Ÿé™æ€è§„åˆ™å¼•æ“ï¼Œé›¶åŸºç¡€ç®€æ˜“ä¾¿æ·çš„é…ç½®å¤šç§å¤æ‚è§„åˆ™ï¼Œå®æ—¶é«˜æ•ˆç®¡æ§ç”¨æˆ·å¼‚å¸¸è¡Œä¸ºã€‚(github.com)</a></li></ul></li><li><p>å…¶ä»–</p><ul><li><ahref="https://www.drools.org/learn/DroolsMangaRuleDrivenDevelpment_EN.pdf">DroolsMangaRuleDrivenDevelpment_EN.pdf</a></li><li><ahref="https://learn-dmn-in-15-minutes.com/learn/introduction">Learn DMNin 15 minutes | Introduction (learn-dmn-in-15-minutes.com)</a></li><li><a href="https://sandbox.kie.org/#/">KIE Sandbox :: Home</a></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LiteFlow </tag>
            
            <tag> è§„åˆ™å¼•æ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redisson RateLimiter</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/Redis/Redisson%20RateLimiter.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/Redis/Redisson%20RateLimiter.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>å¯¹äºå•æœºé™æµï¼Œå¯ä»¥ä½¿ç”¨ Guava ç­‰å·¥å…·</p><p>å¦‚æœéœ€è¦å¯¹æ‰€æœ‰æœåŠ¡è¿›è¡Œé™æµï¼Œå°±éœ€è¦ä½¿ç”¨ä¾èµ–åŒä¸€ä¸ªæ•°æ®èµ„æº</p><p>ç®€å•çš„æ–¹æ¡ˆå¯ä»¥ä½¿ç”¨ Redis è®°å½•é™æµç›¸å…³ä¿¡æ¯è¿›è¡Œå®ç°ï¼ŒRedisson çš„<code>RRateLimiter</code> å°±æ˜¯åŸºäº Rediså®ç°çš„å…¨å±€é™æµå·¥å…·ï¼Œä½¿ç”¨äº†ä»¤ç‰Œæ¡¶çš„æ€æƒ³</p><h1 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h1><p><strong>åˆ›å»ºé™æµå™¨ï¼Œå°è¯•è®¾ç½®é™æµé…ç½®</strong></p><p>ç±»å‹ä¸º <code>RateType.OVERALL</code>ï¼Œä¸ºå…¨å±€é™æµï¼›permits æ•°é‡ä¸º 1s100 ä¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// Redisson å®¢æˆ·ç«¯è¿æ¥ Redis</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://***&quot;</span>).setPassword(<span class="string">&quot;***&quot;</span>);</span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// åˆ›å»º RRateLimiter</span></span><br><span class="line">        <span class="type">RRateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> redissonClient.getRateLimiter(<span class="string">&quot;test.limiter&quot;</span>);</span><br><span class="line">      <span class="comment">// é…ç½®</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> rateLimiter.trySetRate(RateType.OVERALL, <span class="number">100</span>, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;success:&#123;&#125;&quot;</span>, success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹é™æµé…ç½®</strong></p><p>ä½¿ç”¨ <code>rateLimiter.setRate</code> æ–¹æ³•é‡æ–°é…ç½®é™æµç›¸å…³å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://***&quot;</span>).setPassword(<span class="string">&quot;***&quot;</span>);</span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">      </span><br><span class="line">        <span class="type">RRateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> redissonClient.getRateLimiter(<span class="string">&quot;test.limiter&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é‡æ–°é…ç½®</span></span><br><span class="line">        rateLimiter.setRate(RateType.OVERALL, <span class="number">200</span>, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–ä»¤ç‰Œ</strong></p><p>ä½¿ç”¨ <code>rateLimiter.acquire</code> ç­‰æ–¹æ³•è·å–é™æµè®¸å¯</p><p><code>accquire</code> å’Œ <code>tryAccquire</code>çš„åŒºåˆ«å’Œå¤§éƒ¨åˆ†é™æµã€é”å·¥å…·ä¸€è‡´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://***&quot;</span>).setPassword(<span class="string">&quot;***&quot;</span>);</span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">      </span><br><span class="line">        <span class="type">RRateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> redissonClient.getRateLimiter(<span class="string">&quot;test.limiter&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// acquire</span></span><br><span class="line">        rateLimiter.acquire(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tryAcquire</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> rateLimiter.tryAcquire(<span class="number">2</span>);</span><br><span class="line">        log.info(<span class="string">&quot;success:&#123;&#125;&quot;</span>, success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æºç ">æºç </h1><h2 id="rratelimiter">RRateLimiter</h2><p>Redisson ä¸­ï¼Œæ“ä½œä»¤ç‰Œçš„å¯¹è±¡è¢«åŒ…è£…ä¸ºäº† <code>RRateLimiter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RRateLimiter</span> <span class="keyword">extends</span> <span class="title class_">RRateLimiterAsync</span>, RExpirable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">trySetRate</span><span class="params">(RateType mode, <span class="type">long</span> rate, <span class="type">long</span> rateInterval, RateIntervalUnit rateIntervalUnit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setRate</span><span class="params">(RateType mode, <span class="type">long</span> rate, <span class="type">long</span> rateInterval, RateIntervalUnit rateIntervalUnit)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> permits)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">long</span> permits)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> permits, <span class="type">long</span> timeout, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line">    RateLimiterConfig <span class="title function_">getConfig</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="title function_">availablePermits</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ç°ç±» <code>RedissonRateLimiter</code> ç»§æ‰¿äº†<code>RedissonExpirable</code></p><p>æä¾›äº†å¤šä¸ªæ–¹æ³•æ¥æ‹¼è£…ä¸šåŠ¡ä¸­éœ€è¦ç”¨åˆ°çš„ keyï¼Œåœ¨åç»­çš„ acquireç­‰æ–¹æ³•ä¸­å°†ä½œä¸º Lua è„šæœ¬å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonRateLimiter</span> <span class="keyword">extends</span> <span class="title class_">RedissonExpirable</span> <span class="keyword">implements</span> <span class="title class_">RRateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„é€ æ–¹æ³•ï¼Œä¸»è¦æ˜¯ super RedissonExpirable</span></span><br><span class="line">  <span class="comment">// RedissonRateLimiter æœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆæˆå‘˜å±æ€§</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedissonRateLimiter</span><span class="params">(CommandAsyncExecutor commandExecutor, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(commandExecutor, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¼è£…å…¨å±€ permits key</span></span><br><span class="line">    String <span class="title function_">getPermitsName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getRawName(), <span class="string">&quot;permits&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¼è£…å• Redis å®ä¾‹ permits key</span></span><br><span class="line">    String <span class="title function_">getClientPermitsName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getPermitsName(), getServiceManager().getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¼è£…å…¨å±€ value key</span></span><br><span class="line">    String <span class="title function_">getValueName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getRawName(), <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// æ‹¼è£…å• Redis å®ä¾‹ value key</span></span><br><span class="line">    String <span class="title function_">getClientValueName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffixName(getValueName(), getServiceManager().getId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªæµç¨‹ä¸­éœ€è¦ç”¨åˆ°ä»¥ä¸‹çš„ keyï¼š</p><ul><li>nameï¼šé™æµé…ç½®</li><li>suffixName(getRawName(), "permits")ï¼šè®¸å¯æˆæƒè®°å½•</li><li>suffixName(getRawName(), "value")ï¼šå¯ç”¨è®¸å¯æ•°é‡</li></ul><p><strong>åœ¨ä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»è¿™å‡ ä¸ª key çš„ä½œç”¨</strong></p><h2 id="é™æµé…ç½®">é™æµé…ç½®</h2><p>é…ç½®é™æµå‚æ•°æ—¶ï¼Œä¼šä½¿ç”¨è®¾å®šçš„ key name è®°å½•é™æµçš„é…ç½®ä¿¡æ¯</p><p><code>setRate</code> å’Œ <code>trySetRate</code> çš„åŒºåˆ«åœ¨äºä¸€ä¸ªä½¿ç”¨<code>setNx</code>ï¼Œä¸€ä¸ªä½¿ç”¨ <code>set</code> è¦†ç›–ï¼Œå¹¶ä¸”ä¼šåˆ é™¤ permitså’Œ value çš„è®°å½•</p><p>æœ¬è´¨ä¸Šå°±æ˜¯åœ¨æ“ä½œ key è®¾ç½®é™æµå±æ€§</p><hr /><p>å‡è®¾ <code>RRateLimiter</code> å¯¹è±¡è®¾ç½®çš„ name ä¸º<code>test.limiter</code></p><p>å…¶ä¸­å‚æ•° keysï¼š</p><ol type="1"><li>test.limiter</li><li>{test.limiter}:value</li><li>{test.limiter}:value:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li><li>{test.limiter}:permits</li><li>{test.limiter}:permits:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li></ol><p>å…¶ä¸­ 407cd24e-03e1-4745-9684-5aea2ffd4b5f æ˜¯ Redissonç”Ÿæˆçš„æ ‡è®°ï¼Œä¸ºäº†å®ç° Redisson å®ä¾‹çº§åˆ«çš„é™æµæ§åˆ¶</p><p>å‚æ•° argsï¼š</p><ol type="1"><li>rateï¼šäº§å‡ºçš„ä»¤ç‰Œæ•°é‡</li><li>rateIntervalï¼šæ—¶é—´é—´éš”çš„æ¯«ç§’å€¼</li><li>typeï¼šç±»å‹ï¼›0 æ˜¯ OVERALL å…¨å±€ï¼›1 æ˜¯ PER_CLIENT Redissonå®ä¾‹çº§åˆ«</li></ol><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> valueName = KEYS[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">local</span> permitsName = KEYS[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">if</span> ARGV[<span class="number">3</span>] == <span class="string">&#x27;1&#x27;</span> <span class="keyword">then</span></span><br><span class="line">valueName = KEYS[<span class="number">3</span>];</span><br><span class="line">permitsName = KEYS[<span class="number">5</span>];</span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line">redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;rate&#x27;</span>, ARGV[<span class="number">1</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;interval&#x27;</span>, ARGV[<span class="number">2</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;type&#x27;</span>, ARGV[<span class="number">3</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;del&#x27;</span>, valueName, permitsName);</span><br></pre></td></tr></table></figure><p>ä»è„šæœ¬æ¥çœ‹ï¼Œä¸»è¦è¿˜æ˜¯æ“ä½œ Hash keyï¼Œè®¾ç½®å…¶<code>rate</code>ã€<code>interval</code>ã€<code>type</code>æˆå‘˜ä¸ºå‚æ•°ä¸­çš„ä¸åŒå€¼</p><p>æœ€ååˆ é™¤ valueã€permits çš„ keyï¼ˆå› ä¸ºå˜æ›´äº†rateï¼Œè¿™ä¸¤ä¸ªè®°å½•å°±ä¸å‡†ç¡®äº†ï¼ŒGuava çš„ RateLimiter ä¸­ä¼šå¹³æ»‘å˜æ›´ï¼ŒRedissonçš„å®ç°ä¸­ç²—æš´ä¸€äº›ï¼Œé€‰æ‹©äº†ç›´æ¥åˆ é™¤ï¼‰</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;hsetnx&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;rate&#x27;</span>, ARGV[<span class="number">1</span>]);</span><br><span class="line">redis.call(<span class="string">&#x27;hsetnx&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;interval&#x27;</span>, ARGV[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#x27;hsetnx&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;type&#x27;</span>, ARGV[<span class="number">3</span>]);</span><br></pre></td></tr></table></figure><p>åœ¨ <code>trySetRate</code> ä¸­ç›´æ¥ä½¿ç”¨<code>hsetnx</code>ï¼Œå¹¶ä¸”æ²¡æœ‰åˆ é™¤ key çš„æ“ä½œï¼Œç”¨äºåˆå§‹åŒ–</p><h2 id="ä»¤ç‰Œè·å–">ä»¤ç‰Œè·å–</h2><p>æ ¸å¿ƒçš„ä»¤ç‰Œè·å–æ–¹æ³•åœ¨ <code>tryAcquireAsync</code> ä¸­</p><p><code>acquire</code> å’Œ <code>tryAcquire</code> åŒºåˆ«åœ¨äº<code>tryAcquire</code> å¤šäº† timeoutå‚æ•°å’Œè¿”å›å€¼ï¼Œç”¨äºç¡®å®šæ˜¯å¦ç­‰å¾…æ—¶é—´åœ¨æœŸæœ›å€¼ä»¥å†…ï¼Œ<code>acquire</code>åˆ™ä¼šé˜»å¡ï¼Œç›´åˆ°è·å–ç»“æœ</p><hr /><p>å…¶ä¸­å‚æ•° keysï¼š</p><ol type="1"><li>test.limiter</li><li>{test.limiter}:value</li><li>{test.limiter}:value:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li><li>{test.limiter}:permits</li><li>{test.limiter}:permits:407cd24e-03e1-4745-9684-5aea2ffd4b5f</li></ol><p>keys çš„å€¼å’Œé™æµé…ç½®éƒ¨åˆ†æ˜¯ä¸€æ ·çš„</p><p>å‚æ•° argsï¼š</p><ol type="1"><li>valueï¼šè·å–çš„ä»¤ç‰Œæ•°é‡</li><li>System.currentTimeMillisï¼šå½“å‰æ—¶é—´æˆ³</li><li>getServiceManager().generateIdArray()ï¼šç”Ÿæˆçš„éšæœºå­—èŠ‚æ•°ï¼Œå…¶ä¸­éšæœºç”Ÿæˆå™¨ä½¿ç”¨çš„æ˜¯<code>ThreadLocalRandom</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">-- è·å–é…ç½®ï¼Œæ ¡éªŒæ˜¯å¦å­˜åœ¨ RateLimiter é…ç½®</span><br><span class="line"><span class="type">local</span> <span class="variable">rate</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;hget&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;rate&#x27;</span>);</span><br><span class="line"><span class="type">local</span> <span class="variable">interval</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;hget&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;interval&#x27;</span>);</span><br><span class="line"><span class="type">local</span> <span class="variable">type</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;hget&#x27;</span>, KEYS[<span class="number">1</span>], <span class="string">&#x27;type&#x27;</span>);</span><br><span class="line"><span class="keyword">assert</span>(rate ~= <span class="literal">false</span> and interval ~= <span class="literal">false</span> and type ~= <span class="literal">false</span>, <span class="string">&#x27;RateLimiter is not initialized&#x27;</span>)</span><br><span class="line"></span><br><span class="line">-- æ ¹æ® type é€‰æ‹©ä¸åŒçš„ value å’Œ permits key</span><br><span class="line"><span class="type">local</span> <span class="variable">valueName</span> <span class="operator">=</span> KEYS[<span class="number">2</span>];<span class="string">&quot;</span></span><br><span class="line"><span class="string">local permitsName = KEYS[4];&quot;</span></span><br><span class="line">type == <span class="string">&#x27;1&#x27;</span> then <span class="string">&quot;</span></span><br><span class="line"><span class="string">  valueName = KEYS[3];</span></span><br><span class="line"><span class="string">permitsName = KEYS[5];</span></span><br><span class="line"><span class="string">end;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- åˆ¤æ–­è·å–çš„ä»¤ç‰Œæ•°é‡æ˜¯ä¸æ˜¯å·²ç»å¤§äºé™æµå™¨çš„é…ç½®</span></span><br><span class="line"><span class="string">assert(tonumber(rate) &gt;= tonumber(ARGV[1]), &#x27;Requested permits amount could not exceed defined rate&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">local currentValue = redis.call(&#x27;get&#x27;, valueName);</span></span><br><span class="line"><span class="string">local res;</span></span><br><span class="line"><span class="string">if currentValue ~= false then</span></span><br><span class="line"><span class="string">  -- æŸ¥è¯¢æ—¶é—´çª—å£ä»¥å¤–çš„è®¸å¯</span></span><br><span class="line"><span class="string">  -- permits çš„ç»“æ„ä¸º score æ˜¯å‘æ”¾æ—¶é—´æˆ³ï¼›value æ˜¯ 8 å­—èŠ‚éšæœºå€¼ + è®¸å¯æ•°é‡</span></span><br><span class="line"><span class="string">local expiredValues = redis.call(&#x27;zrangebyscore&#x27;, permitsName, 0, tonumber(ARGV[2]) - interval);</span></span><br><span class="line"><span class="string">local released = 0;</span></span><br><span class="line"><span class="string">for i, v in ipairs(expiredValues) do</span></span><br><span class="line"><span class="string">      -- äºŒè¿›åˆ¶æ•°æ®ï¼Œè§£åŒ…è§„åˆ™ä¸º Bc0I</span></span><br><span class="line"><span class="string">local random, permits = struct.unpack(&#x27;Bc0I&#x27;, v);&quot;</span></span><br><span class="line">      -- è®°å½•æ—¶é—´çª—å£è®¸å¯æ•°é‡</span><br><span class="line">released = released + permits;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">-- å­˜åœ¨å¯ä»¥é‡Šæ”¾çš„è®¸å¯</span><br><span class="line"><span class="keyword">if</span> released &gt; <span class="number">0</span> then</span><br><span class="line">      -- åˆ é™¤ permits è®°å½•</span><br><span class="line">    redis.call(<span class="string">&#x27;zremrangebyscore&#x27;</span>, permitsName, <span class="number">0</span>, tonumber(ARGV[<span class="number">2</span>]) - interval);</span><br><span class="line">-- é‡æ–°ç»´æŠ¤ä¸‹ value</span><br><span class="line"><span class="keyword">if</span> <span class="title function_">tonumber</span><span class="params">(currentValue)</span> + released &gt; tonumber(rate) <span class="type">then</span></span><br><span class="line"><span class="variable">currentValue</span> <span class="operator">=</span> tonumber(rate) - redis.call(<span class="string">&#x27;zcard&#x27;</span>, permitsName);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">           currentValue = tonumber(currentValue) + released;</span><br><span class="line">        end;</span><br><span class="line">-- æ›´æ–°</span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, valueName, currentValue);</span><br><span class="line">   end;</span><br><span class="line"></span><br><span class="line">-- æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œæ»¡è¶³è¿™æ¬¡è¯·æ±‚</span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">tonumber</span><span class="params">(currentValue)</span> &lt; tonumber(ARGV[<span class="number">1</span>]) then</span><br><span class="line">   <span class="type">local</span> <span class="variable">firstValue</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;zrange&#x27;</span>, permitsName, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&#x27;withscores&#x27;</span>);</span><br><span class="line">-- æ²¡æœ‰ï¼Œè¿”å›ç­‰å¾…æ—¶é—´</span><br><span class="line">        res = <span class="number">3</span> + interval - (tonumber(ARGV[<span class="number">2</span>]) - tonumber(firstValue[<span class="number">2</span>]));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      -- æ— éœ€ç­‰å¾…ï¼›æ›´æ–° permits å’Œ value</span><br><span class="line">        redis.call(<span class="string">&#x27;zadd&#x27;</span>, permitsName, ARGV[<span class="number">2</span>], struct.pack(<span class="string">&#x27;Bc0I&#x27;</span>, string.len(ARGV[<span class="number">3</span>]), ARGV[<span class="number">3</span>], ARGV[<span class="number">1</span>]));</span><br><span class="line">        redis.call(<span class="string">&#x27;decrby&#x27;</span>, valueName, ARGV[<span class="number">1</span>]);</span><br><span class="line">        res = nil;</span><br><span class="line">    end;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  -- value å€¼ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è·å–ä»¤ç‰Œ</span><br><span class="line">    redis.call(<span class="string">&#x27;set&#x27;</span>, valueName, rate);</span><br><span class="line">    redis.call(<span class="string">&#x27;zadd&#x27;</span>, permitsName, ARGV[<span class="number">2</span>], struct.pack(<span class="string">&#x27;Bc0I&#x27;</span>, string.len(ARGV[<span class="number">3</span>]), ARGV[<span class="number">3</span>], ARGV[<span class="number">1</span>]));</span><br><span class="line">    redis.call(<span class="string">&#x27;decrby&#x27;</span>, valueName, ARGV[<span class="number">1</span>]);</span><br><span class="line">    res = nil;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">-- æ ¹æ®é…ç½®æ›´æ–° value å’Œ permits çš„è¿‡æœŸæ—¶é—´</span><br><span class="line"><span class="type">local</span> <span class="variable">ttl</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;pttl&#x27;</span>, KEYS[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">if</span> ttl &gt; <span class="number">0</span> then</span><br><span class="line">redis.call(<span class="string">&#x27;pexpire&#x27;</span>, valueName, ttl);</span><br><span class="line">redis.call(<span class="string">&#x27;pexpire&#x27;</span>, permitsName, ttl);</span><br><span class="line">end;</span><br><span class="line"><span class="keyword">return</span> res;</span><br></pre></td></tr></table></figure><p>ç»“åˆ Lua è„šæœ¬ä¸­çš„æ³¨é‡Šï¼Œæµç¨‹å¯ä»¥ç®€ç•¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><ol type="1"><li>æ ¡éªŒ RateLimiter æ˜¯å¦å­˜åœ¨</li><li>æ ¡éªŒè·å–çš„ä»¤ç‰Œæ•°é‡æ˜¯ä¸æ˜¯å·²ç»è¶…è¿‡ RateLimiter çš„ rateé…ç½®ï¼›assert</li><li>è·å– currentValueï¼Œä¸ºç°æœ‰ä»¤ç‰Œæ•°é‡</li><li>currentValue å­˜åœ¨åˆ™æŸ¥è¯¢çª—å£æ—¶é—´å†…å‘æ”¾çš„è®°å½•ï¼Œè¿›è¡Œé‡Šæ”¾</li><li>åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿä»¤ç‰Œæ»¡è¶³è¿™æ¬¡è¯·æ±‚ï¼›æ»¡è¶³ç›´æ¥å‘æ”¾ï¼Œè¿”å›nilï¼›ä¸æ»¡è¶³åˆ™è¿”å›ç­‰å¾…æ—¶é—´ ç­‰å¾…æ—¶é—´çš„è®¡ç®—è§„åˆ™ï¼š3 + ä»¤ç‰Œäº§å‡ºé—´éš” -(å½“å‰æ—¶é—´ - æœ€æ—©ä¸€æ¬¡ ä»¤ç‰Œå‘æ”¾æ—¶é—´)</li><li>æ ¹æ®é…ç½®æ›´æ–° value å’Œ permitsçš„è¿‡æœŸæ—¶é—´ï¼›ç®€å•ç†è§£ï¼Œé…ç½®ä¸å­˜åœ¨äº†ï¼Œvalue å’Œ permitsè®°å½•ä¹Ÿæ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº†</li></ol><p><strong>æµç¨‹å›¾</strong></p><img src="/%E5%BC%80%E5%8F%91/DB/Redis/Redisson%20RateLimiter/Redisson%20RateLimiter%20%E6%B5%81%E7%A8%8B%E5%9B%BE.png" class="" title="Redisson RateLimiter æµç¨‹å›¾"><h2 id="delay-æ—¶é—´å¤„ç†">delay æ—¶é—´å¤„ç†</h2><p>Redis æ“ä½œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ª delayæ—¶é—´ï¼Œå¦‚æœä¸éœ€è¦ç­‰å¾…ï¼Œå³å·²ç»è·å–åˆ°ä»¤ç‰Œåˆ™è¿”å› nil</p><p>æ‰€ä»¥å½“å®¢æˆ·ç«¯æ‹¿åˆ°æœ€åçš„ delay å€¼åï¼Œå°†ä¼šè¿›è¡Œä¸€ç³»åˆ—çš„åˆ¤æ–­å’Œå¤„ç†</p><p>æ ¸å¿ƒä¸»è¦æ˜¯åœ¨ <code>tryAcquireAsync</code>æ–¹æ³•ï¼Œéå¼‚æ­¥æ–¹æ³•å°±æ˜¯ä¸Šæ¸¸æ–¹æ³•ä½¿ç”¨ get è¿›è¡Œé˜»å¡è·å–å®Œæˆç»“æœæ¥å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CompletableFuture&lt;Boolean&gt; <span class="title function_">tryAcquireAsync</span><span class="params">(<span class="type">long</span> permits, <span class="type">long</span> timeoutInMillis)</span> &#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">s</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">      RFuture&lt;Long&gt; future = tryAcquireAsync(RedisCommands.EVAL_LONG, permits);</span><br><span class="line">      <span class="keyword">return</span> future.thenCompose(delay -&gt; &#123;</span><br><span class="line">        <span class="comment">// Redis è¿”å› nilï¼Œè¯´æ˜ç«‹å³ç­¾å‘äº†ä»¤ç‰Œ</span></span><br><span class="line">          <span class="keyword">if</span> (delay == <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">        <span class="comment">// ä¸é™æ—¶</span></span><br><span class="line">          <span class="keyword">if</span> (timeoutInMillis == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›çš„ CompletableFuture</span></span><br><span class="line">              CompletableFuture&lt;Boolean&gt; f = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">              getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// é€’å½’è°ƒç”¨ tryAcquireAsync</span></span><br><span class="line">                  CompletableFuture&lt;Boolean&gt; r = tryAcquireAsync(permits, timeoutInMillis);</span><br><span class="line">                <span class="comment">// è½¬æ¢ CompletableFuture è¿”å›å€¼</span></span><br><span class="line">                  commandExecutor.transfer(r, f);</span><br><span class="line">              &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">              <span class="keyword">return</span> f;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">        <span class="comment">// ä¸Šé¢æ“ä½œçš„è€—æ—¶ï¼ˆå½“å‰æ—¶é—´ - å…¥å£å¼€å§‹æ—¶é—´ï¼‰</span></span><br><span class="line">          <span class="type">long</span> <span class="variable">el</span> <span class="operator">=</span> System.currentTimeMillis() - s;</span><br><span class="line">        <span class="comment">// å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´</span></span><br><span class="line">          <span class="type">long</span> <span class="variable">remains</span> <span class="operator">=</span> timeoutInMillis - el;</span><br><span class="line">        <span class="comment">// å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´å°äº 0ï¼Œè¿”å› false</span></span><br><span class="line">          <span class="keyword">if</span> (remains &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="literal">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          CompletableFuture&lt;Boolean&gt; f = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´æ¯”éœ€è¦ç­‰å¾…çš„æ—¶é—´è¦å°</span></span><br><span class="line">          <span class="keyword">if</span> (remains &lt; delay) &#123;</span><br><span class="line">            <span class="comment">// å®šæ—¶è¿”å› false</span></span><br><span class="line">              getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">                  f.complete(<span class="literal">false</span>);</span><br><span class="line">              &#125;, remains, TimeUnit.MILLISECONDS);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é‡æ–°ä¸€è½®è·å–</span></span><br><span class="line">              <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">              getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">                  <span class="type">long</span> <span class="variable">elapsed</span> <span class="operator">=</span> System.currentTimeMillis() - start;</span><br><span class="line">                <span class="comment">// è¿‡ç¨‹ä¸­è¶…æ—¶äº†</span></span><br><span class="line">                  <span class="keyword">if</span> (remains &lt;= elapsed) &#123;</span><br><span class="line">                      f.complete(<span class="literal">false</span>);</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  CompletableFuture&lt;Boolean&gt; r = tryAcquireAsync(permits, remains - elapsed);</span><br><span class="line">                  commandExecutor.transfer(r, f);</span><br><span class="line">              &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> f;</span><br><span class="line">      &#125;).toCompletableFuture();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨äº†<code>tryAcquireAsync(RedisCommands.EVAL_LONG, permits)</code>çš„é‡è½½æ–¹æ³•ï¼›è¿™ä¸ªæ–¹æ³•å¤„ç† delay ç»“æœï¼›é‡è½½çš„æ–¹æ³•åˆ™æ˜¯å’Œ Redisäº¤äº’ä»¤ç‰Œè·å–çš„é€»è¾‘</p><p>æ‹¿åˆ° Redis è¿”å›æ—¶åˆ†ä¸ºå‡ ç§æƒ…å†µï¼š</p><ul><li>ä¸º null è¯´æ˜ä¸éœ€è¦ç­‰å¾…ï¼Œå·²ç»è·å–äº†ä»¤ç‰Œ</li><li>æ²¡æœ‰æœŸæœ›ç­‰å¾…æ—¶é—´ï¼Œç”Ÿæˆä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œdelay ä¸º Redisè¿”å›çš„ç­‰å¾…æ—¶é—´</li><li>è®¡ç®—å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™ç›´æ¥è¿”å› false</li><li>å‰©ä½™æœŸæœ›ç­‰å¾…æ—¶é—´å°äº delayï¼Œå»¶è¿Ÿåè¿”å› false</li><li>æœ€åå¼€å§‹é€’å½’ä¸€è½®è·å–</li></ul><h1 id="è¡¥å……">è¡¥å……</h1><h2 id="å¼‚æ­¥ä»»åŠ¡çš„é€’å½’">å¼‚æ­¥ä»»åŠ¡çš„é€’å½’</h2><p>Redisson ä¸­çš„å¾ˆå¤šè®¾è®¡éƒ½æ˜¯æ„é€ ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œè¿”å›å€¼åŒ…è£…ä¸º<code>CompletableFuture</code>ï¼ŒåŒæ­¥æ¥å£å°±æ˜¯ç›´æ¥è°ƒç”¨å…¶ getæ–¹æ³•é˜»å¡ç­‰å¾…</p><p>å¯¹äºå¼‚æ­¥æ–¹æ³•å¦‚ä½•é€’å½’å‘¢ï¼Œå› ä¸ºæœ€ç»ˆæ¥å£éœ€è¦è¿”å›ä¸€ä¸ª<code>CompletableFuture</code>ï¼Œä¸èƒ½ <code>CompletableFuture</code> åµŒå¥—<code>CompletableFuture</code>ï¼Œå› ä¸ºä¸Šæ¸¸è°ƒç”¨æ–¹ä¹Ÿä¸çŸ¥é“é€’å½’äº†å‡ å±‚</p><p>Redisson çš„æ–¹æ³•æ˜¯åœ¨å¼‚æ­¥é€’å½’ä¹‹å‰å…ˆå®šä¹‰å‡ºä¸€ä¸ª<code>CompletableFuture</code> ä½œä¸ºè¿”å›å€¼ï¼Œå†æœ€åå¼‚æ­¥æ‰§è¡Œå®Œåä½¿ç”¨transfer æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (timeoutInMillis == -<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// è¿”å›çš„ CompletableFuture</span></span><br><span class="line">    CompletableFuture&lt;Boolean&gt; f = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">    getServiceManager().getGroup().schedule(() -&gt; &#123;</span><br><span class="line">        CompletableFuture&lt;Boolean&gt; r = tryAcquireAsync(permits, timeoutInMillis);</span><br><span class="line">      <span class="comment">// å¼‚æ­¥ä»»åŠ¡ä¸­è¿›è¡Œ transfer</span></span><br><span class="line">        commandExecutor.transfer(r, f);</span><br><span class="line">    &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>transfer çš„æ“ä½œæœ¬è´¨ä¸Šæ˜¯ä½¿ç”¨<code>whenComplete</code>ï¼Œå°†æ–°çš„æœ€ç»ˆé€’å½’å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼ï¼ˆå¼‚å¸¸ï¼‰ä¼ é€’ç»™è¿”å›å€¼å¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommandAsyncService</span> <span class="keyword">implements</span> <span class="title class_">CommandAsyncExecutor</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;V&gt; <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(CompletionStage&lt;V&gt; future1, CompletableFuture&lt;V&gt; future2)</span> &#123;</span><br><span class="line">        future1.whenComplete((res, e) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                future2.completeExceptionally(e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            future2.complete(res);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå®ç°å¼‚æ­¥ä»»åŠ¡çš„é€’å½’æ“ä½œ</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://juejin.cn/post/7198826344582676538?searchId=202308071543501DA8932282EC1F20B8C7">è¯¦è§£Redissonåˆ†å¸ƒå¼é™æµçš„å®ç°åŸç†- æ˜é‡‘ (juejin.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Redis è„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§‚å¯Ÿè€…æ¨¡å¼ - Observer</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%20-%20Observer.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%20-%20Observer.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserverPatternï¼‰ç”¨æ¥å¤„ç†æŸä¸ªå€¼å¾—å…³æ³¨çš„çŠ¶æ€çš„å¯¹è±¡çŠ¶æ€å˜æ›´ï¼Œè¿›è€Œæ‰§è¡Œç›¸åº”çš„æ“ä½œ</p><p>å°†è‡ªèº«çš„çŠ¶æ€æ”¹å˜é€šçŸ¥ç»™å…¶ä»–å¯¹è±¡ï¼Œ æˆ‘ä»¬ä¹Ÿå°†å…¶ç§°ä¸º <em>å‘å¸ƒè€…</em>ï¼ˆpublisherï¼‰</p><p>æ‰€æœ‰å¸Œæœ›å…³æ³¨å‘å¸ƒè€…çŠ¶æ€å˜åŒ–çš„å…¶ä»–å¯¹è±¡è¢«ç§°ä¸º <em>è®¢é˜…è€…</em>ï¼ˆsubscribersï¼‰</p><p>æ‰€æœ‰è®¢é˜…è€…éƒ½å¿…é¡»å®ç°åŒæ ·çš„æ¥å£ï¼Œ å‘å¸ƒè€…ä»…é€šè¿‡è¯¥æ¥å£ä¸è®¢é˜…è€…äº¤äº’ï¼Œæ¥å£ä¸­å¿…é¡»å£°æ˜é€šçŸ¥æ–¹æ³•åŠå…¶å‚æ•°ï¼Œè¿™æ ·å‘å¸ƒè€…åœ¨å‘å‡ºé€šçŸ¥æ—¶è¿˜èƒ½ä¼ é€’ä¸€äº›ä¸Šä¸‹æ–‡æ•°æ®</p><p><strong>ç›®çš„</strong></p><p>å®ç°ä¸€ç§è®¢é˜…æœºåˆ¶ï¼Œå¯åœ¨å¯¹è±¡äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å¤šä¸ª â€œè§‚å¯Ÿâ€è¯¥å¯¹è±¡çš„å…¶ä»–å¯¹è±¡ï¼›è®¢é˜…è€…èƒ½åœ¨ä¸ä¸å…·ä½“å‘å¸ƒè€…ç±»è€¦åˆçš„æƒ…å†µä¸‹é€šè¿‡æ¥å£è§‚å¯Ÿå‘å¸ƒè€…çš„çŠ¶æ€</p><p><strong>çœŸå®ä¸–ç•Œç±»æ¯”</strong></p><p>å•†åº—ç¼ºè´§æ—¶ï¼Œç”¨æˆ·å‘å•†åº—ç™»è®°è”ç³»ç”µè¯ï¼Œå½“è¡¥è´§åå•†åº—é€šè¿‡ç”µè¯é€šçŸ¥å¯¹è¯¥å•†å“ï¼ˆäº‹ä»¶ï¼‰æ„Ÿå…´è¶£çš„ç”¨æˆ·ï¼›è€Œä¸æ˜¯ï¼š</p><ul><li>ç”¨æˆ·é¢‘ç¹åˆ°è¾¾å•†åº—æŸ¥è¯¢æ˜¯å¦åˆ°è´§</li><li>å•†å“é€šçŸ¥æ‰€æœ‰ç”¨æˆ·ç¼ºè´§å•†å“åˆ°è´§</li></ul><h1 id="å®è·µ">å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œå®ç°ä¸€ä¸ªæ—¥å¿—è£…é¥°ï¼Œå½“æ—¥å¿—ä¿¡æ¯æ‰“å°å¼‚å¸¸æ—¶ï¼Œè¿›è¡Œç›¸åº”æ—¥å¿—ç­‰çº§çš„å¤„ç†ï¼š</p><ul><li>warn çº§åˆ«å‘é€é‚®ä»¶</li><li>error çº§åˆ«ç”µè¯é€šçŸ¥</li></ul><h2 id="é—®é¢˜">é—®é¢˜</h2><p>å¯ä»¥å¯¹æ—¥å¿—å®ç°è¿›è¡ŒåŒ…è£…ï¼Œåœ¨å¯¹åº”çš„æ—¥å¿—çº§åˆ«æ–¹æ³•è¿›è¡Œå¢å¼º</p><p>ä¾‹å¦‚ï¼Œå®ç°ä¸€ä¸ª <code>MyLogger</code>çš„è£…é¥°ç±»ï¼Œå°†å¢å¼ºçš„æ–¹æ³•å†™åœ¨ç›¸å…³è£…é¥°çš„æ–¹æ³•ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogger</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TinyLog</span> <span class="variable">log</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TinyLog</span>(<span class="string">&quot;MyLogger&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">info</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.info(format, arguments, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warn</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.warn(format, arguments, t);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.error(format, arguments, t);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”µè¯é€šçŸ¥ç®¡ç†å‘˜&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¼šå­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>å…³æ³¨æ—¥å¿—çš„é€»è¾‘éœ€è¦ç¡¬ç¼–ç åœ¨æ—¥å¿—æ‰“å°çš„æ ¸å¿ƒé€»è¾‘ä¸­ï¼Œç›‘å¬è¡Œä¸ºå’Œå‘å¸ƒè€…ã€ç”šè‡³å’ŒåŠŸèƒ½çš„ä¸»è¦å®ç°è€¦åˆ</li><li>æ— æ³•åŠ¨æ€å¢åŠ ã€ç§»é™¤è®¢é˜…è€…</li></ul><p>è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼è§£å†³ä»¥ä¸Šé—®é¢˜</p><h2 id="å®ç°">å®ç°</h2><h3 id="ç›‘å¬è€…æ¥å£">ç›‘å¬è€…æ¥å£</h3><p>æ‰€æœ‰çš„ç›‘å¬è€…å®ç°è¯¥æ¥å£ï¼Œå½“äº‹ä»¶è§¦å‘æ—¶é€šè¿‡è¯¥æ¥å£çš„å®ç°å‘Šè¯‰å‘å¸ƒè€…éœ€è¦æ‰§è¡Œçš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogEventListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Throwable t)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‘å¸ƒè€…">å‘å¸ƒè€…</h3><p>ç»´æŠ¤äº†ç›‘å¬è€…åˆ—è¡¨ï¼Œæä¾›äº†ä¾›äº‹ä»¶è§¦å‘çš„é€šçŸ¥è¡Œä¸ºä»¥åŠè®¢é˜…ã€ç§»é™¤è®¢é˜…ç­‰æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogEventManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Level, List&lt;LogEventListener&gt;&gt; listeners = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogEventManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Level level : Level.values()) &#123;</span><br><span class="line">            listeners.put(level, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Level level, LogEventListener listener)</span> &#123;</span><br><span class="line">        List&lt;LogEventListener&gt; listenerList = listeners.get(level);</span><br><span class="line">        listenerList.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(Level level, LogEventListener listener)</span> &#123;</span><br><span class="line">        List&lt;LogEventListener&gt; listenerList = listeners.get(level);</span><br><span class="line">        listenerList.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Level level, Throwable t)</span> &#123;</span><br><span class="line">        List&lt;LogEventListener&gt; listenerList = listeners.get(level);</span><br><span class="line">        <span class="keyword">for</span> (LogEventListener listener : listenerList) &#123;</span><br><span class="line">            listener.notify(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ—¥å¿—è£…é¥°æ¥å…¥">æ—¥å¿—è£…é¥°æ¥å…¥</h3><p>åªéœ€è¦åœ¨å…·ä½“çš„è¡Œä¸ºï¼ˆäº‹ä»¶ï¼‰è°ƒç”¨å‘å¸ƒè€…</p><p>è‡³äºå‘å¸ƒè€…çš„é€»è¾‘ã€å‘å¸ƒè€…ç»´æŠ¤çš„ç›‘å¬è€…ï¼Œä¸éœ€è¦æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…³æ³¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogger</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TinyLog</span> <span class="variable">log</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TinyLog</span>(<span class="string">&quot;MyLogger&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LogEventManager logEventManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyLogger</span><span class="params">(<span class="keyword">final</span> LogEventManager logEventManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.logEventManager = logEventManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">info</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.info(format, arguments, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warn</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.warn(format, arguments, t);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            logEventManager.call(Level.WARN, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String format, Throwable t, Object... arguments)</span> &#123;</span><br><span class="line">        log.error(format, arguments, t);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(t)) &#123;</span><br><span class="line">            logEventManager.call(Level.ERROR, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç›‘å¬è€…å®ç°">ç›‘å¬è€…å®ç°</h3><p><strong>é‚®ä»¶é€šçŸ¥å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailCallListener</span> <span class="keyword">implements</span> <span class="title class_">LogEventListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ &quot;</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç”µè¯é€šçŸ¥å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneCallListener</span> <span class="keyword">implements</span> <span class="title class_">LogEventListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”µè¯é€šçŸ¥ç®¡ç†å‘˜ &quot;</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨">ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å‘å¸ƒè€…ï¼ˆç®¡ç†ï¼‰</span></span><br><span class="line">        <span class="type">LogEventManager</span> <span class="variable">logEventManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogEventManager</span>();</span><br><span class="line">        logEventManager.subscribe(Level.WARN, <span class="keyword">new</span> <span class="title class_">EmailCallListener</span>());</span><br><span class="line">        logEventManager.subscribe(Level.ERROR, <span class="keyword">new</span> <span class="title class_">PhoneCallListener</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ—¥å¿—è£…é¥°ç±»</span></span><br><span class="line">        <span class="type">MyLogger</span> <span class="variable">myLogger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLogger</span>(logEventManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å°æ—¥å¿—</span></span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;an error occurred&quot;</span>);</span><br><span class="line">        myLogger.warn(<span class="string">&quot;get warn&quot;</span>, exception);</span><br><span class="line">        myLogger.error(<span class="string">&quot;get error&quot;</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ä¸ƒæœˆ <span class="number">27</span>, <span class="number">2023</span> <span class="number">12</span>:09:08 ä¸Šåˆ design.behavioral.observer.MyLogger warn</span><br><span class="line">è­¦å‘Š: get warn</span><br><span class="line">ä¸ƒæœˆ <span class="number">27</span>, <span class="number">2023</span> <span class="number">12</span>:09:08 ä¸Šåˆ design.behavioral.observer.MyLogger error</span><br><span class="line">ä¸¥é‡: get error</span><br><span class="line">é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ an error occurred</span><br><span class="line">ç”µè¯é€šçŸ¥ç®¡ç†å‘˜ an error occurred</span><br></pre></td></tr></table></figure><h3 id="å˜æ›´è®¢é˜…">å˜æ›´è®¢é˜…</h3><p>ä¸šåŠ¡è°ƒæ•´ï¼Œå¯¹äº erroræ—¥å¿—ä¹Ÿéœ€è¦è¿›è¡Œé‚®ä»¶é€šçŸ¥ï¼Œé‚£ä¹ˆåªéœ€è¦è°ƒæ•´è®¢é˜…å…³ç³»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">LogEventManager</span> <span class="variable">logEventManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogEventManager</span>();</span><br><span class="line">        logEventManager.subscribe(Level.WARN, <span class="keyword">new</span> <span class="title class_">EmailCallListener</span>());</span><br><span class="line">        logEventManager.subscribe(Level.ERROR, <span class="keyword">new</span> <span class="title class_">PhoneCallListener</span>());</span><br><span class="line">        <span class="comment">// å¯¹ error å¢åŠ å®ç°</span></span><br><span class="line">        logEventManager.subscribe(Level.ERROR, <span class="keyword">new</span> <span class="title class_">EmailCallListener</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">MyLogger</span> <span class="variable">myLogger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLogger</span>(logEventManager);</span><br><span class="line"></span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;an error occurred&quot;</span>);</span><br><span class="line">        myLogger.warn(<span class="string">&quot;get warn&quot;</span>, exception);</span><br><span class="line">        myLogger.error(<span class="string">&quot;get error&quot;</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨">å®é™…åº”ç”¨</h2><p>Apache çš„ commons.ioï¼Œå¯ä»¥æœ‰åŠŸèƒ½æ¥ç›‘å¬æœ¬åœ°æ–‡ä»¶çš„å˜æ›´</p><h3 id="è§‚å¯Ÿè€…-filealterationobserver">è§‚å¯Ÿè€…FileAlterationObserver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">FileAlterationObserver</span><span class="params">(<span class="keyword">final</span> FileEntry rootEntry, <span class="keyword">final</span> FileFilter fileFilter,</span></span><br><span class="line"><span class="params">                                 <span class="keyword">final</span> IOCase caseSensitivity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rootEntry == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Root entry is missing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rootEntry.getFile() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Root directory is missing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.rootEntry = rootEntry;</span><br><span class="line">    <span class="built_in">this</span>.fileFilter = fileFilter;</span><br><span class="line">    <span class="keyword">if</span> (caseSensitivity == <span class="literal">null</span> || caseSensitivity.equals(IOCase.SYSTEM)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = NameFileComparator.NAME_SYSTEM_COMPARATOR;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caseSensitivity.equals(IOCase.INSENSITIVE)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = NameFileComparator.NAME_INSENSITIVE_COMPARATOR;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = NameFileComparator.NAME_COMPARATOR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶ã€è¿‡æ»¤å™¨ç­‰å¯¹è±¡</p><h3 id="ç›‘å¬è€…-filealterationlistener">ç›‘å¬è€…FileAlterationListener</h3><p><code>FileAlterationListener</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå®ç°æ–‡ä»¶ç›¸å…³äº‹ä»¶çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileAlterationListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File system observer started checking event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer The file system observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Directory created Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory The directory created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryCreate</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Directory changed Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory The directory changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryChange</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Directory deleted Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory The directory deleted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryDelete</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File created Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file The file created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File changed Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file The file changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileChange</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File deleted Event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file The file deleted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File system observer finished checking event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer The file system observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨å†Œç›‘å¬è€…">æ³¨å†Œç›‘å¬è€…</h3><p>è°ƒç”¨ <code>FileAlterationObserver</code> çš„ <code>addListener</code>æ–¹æ³•æ·»åŠ ç›‘å¬è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a file system listener.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> listener The file system listener</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(<span class="keyword">final</span> FileAlterationListener listener)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">        listeners.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç›‘å¬è€…è¢«ä¿å­˜åœ¨<code>private final List&lt;FileAlterationListener&gt; listeners = new CopyOnWriteArrayList&lt;&gt;()</code>å±æ€§ä¸­</p><h3 id="ç›‘æ§å™¨-filealterationmonitor">ç›‘æ§å™¨ FileAlterationMonitor</h3><p>ç›‘æ§å™¨ <code>FileAlterationMonitor</code>åŒ…è£…äº†ä¸€ç³»åˆ—è§‚å¯Ÿè€…ï¼Œä»¥åŠç›‘æ§é—´éš”æ—¶é—´ç­‰å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FileAlterationMonitor</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> interval, <span class="keyword">final</span> FileAlterationObserver... observers)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(interval);</span><br><span class="line">    <span class="keyword">if</span> (observers != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> FileAlterationObserver observer : observers) &#123;</span><br><span class="line">            addObserver(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç›‘æ§">å¯åŠ¨ç›‘æ§</h3><p>è°ƒç”¨ <code>FileAlterationMonitor</code> çš„ <code>start</code>æ–¹æ³•å¼€å¯ç›‘æ§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (running) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Monitor is already running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> FileAlterationObserver observer : observers) &#123;</span><br><span class="line">        observer.initialize();</span><br><span class="line">    &#125;</span><br><span class="line">    running = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (threadFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">        thread = threadFactory.newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileAlterationMonitor</code> æœ¬èº«æ˜¯ä¸€ä¸ª <code>Runnable</code>å®ç°</p><p><code>run</code> æ–¹æ³•çš„å®ç°ï¼Œä½¿ç”¨ while å¾ªç¯åˆ¤æ–­ï¼Œè°ƒç”¨<code>FileAlterationObserver</code> çš„ <code>checkAndNotify</code>æ¥è§‚å¯Ÿå’Œé€šçŸ¥ç›‘å¬è€…</p><p><code>Thread.sleep(interval)</code> æ¥è¿›è¡Œæ—¶é—´é—´éš”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runs this monitor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> FileAlterationObserver observer : observers) &#123;</span><br><span class="line">            observer.checkAndNotify();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(interval);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException ignored) &#123;</span><br><span class="line">            <span class="comment">// ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileAlterationObserver</code> çš„ <code>checkAndNotify</code>å°±æ˜¯å‘å¸ƒè€…çš„æ ¸å¿ƒæ–¹æ³•ï¼Œæ¯”è¾ƒæ–‡ä»¶çš„å˜åŒ–ï¼Œè°ƒç”¨å·²æ³¨å†Œç›‘å¬è€…çš„ç›¸å…³å¤„ç†æ–¹æ³•</p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>è§‚å¯Ÿè€…æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>æ»¡è¶³äº†å¼€é—­åŸåˆ™ï¼›æ— éœ€ä¿®æ”¹å‘å¸ƒè€…ä»£ç å°±èƒ½å¼•å…¥æ–°çš„è®¢é˜…è€…ç±»ï¼ˆå¦‚æœæ˜¯å‘å¸ƒè€…æ¥å£åˆ™å¯è½»æ¾å¼•å…¥å‘å¸ƒè€…ç±»ï¼‰</li><li>å¯ä»¥åœ¨è¿è¡Œæ—¶å»ºç«‹å¯¹è±¡ä¹‹é—´çš„è”ç³»ï¼ˆåŠ¨æ€è®¢é˜…ã€è§£é™¤è®¢é˜…ï¼‰</li></ul><p>è´£ä»»é“¾ã€ å‘½ä»¤ã€ä¸­ä»‹è€…å’Œè§‚å¯Ÿè€…ç”¨äºå¤„ç†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„ä¸åŒè¿æ¥æ–¹å¼ï¼š</p><ul><li>è´£ä»»é“¾æŒ‰ç…§é¡ºåºå°†è¯·æ±‚åŠ¨æ€ä¼ é€’ç»™ä¸€ç³»åˆ—çš„æ½œåœ¨æ¥æ”¶è€…ï¼Œç›´è‡³å…¶ä¸­ä¸€åæ¥æ”¶è€…å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†</li><li>å‘½ä»¤åœ¨å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´å»ºç«‹å•å‘è¿æ¥</li><li>ä¸­ä»‹è€…æ¸…é™¤äº†å‘é€è€…å’Œè¯·æ±‚è€…ä¹‹é—´çš„ç›´æ¥è¿æ¥ï¼Œå¼ºåˆ¶å®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ä»‹å¯¹è±¡è¿›è¡Œé—´æ¥æ²Ÿé€š</li><li>è§‚å¯Ÿè€…å…è®¸æ¥æ”¶è€…åŠ¨æ€åœ°è®¢é˜…æˆ–å–æ¶ˆæ¥æ”¶è¯·æ±‚</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://refactoringguru.cn/design-patterns/observer">è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼(refactoringguru.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS è§£æå¯¼è‡´çš„ ssh connect to host github.com port 22 Connection refused</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/DNS%20%E8%A7%A3%E6%9E%90%E5%AF%BC%E8%87%B4%E7%9A%84%20ssh%20connect%20to%20host%20github.com%20port%2022%20Connection%20refused.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/DNS%20%E8%A7%A3%E6%9E%90%E5%AF%BC%E8%87%B4%E7%9A%84%20ssh%20connect%20to%20host%20github.com%20port%2022%20Connection%20refused.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>ä¸€æ®µæ—¶é—´æ²¡æœ‰ä½¿ç”¨ github SSH æ“ä½œï¼Œä»Šå¤©çªç„¶å‘ç° Hexo deploy æ— æ³•æ­£å¸¸push åˆ°ä»“åº“</p><p>æŠ¥é”™ä¿¡æ¯ä¸º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br><span class="line">fatal: Could not <span class="built_in">read</span> from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><p>å¼€å§‹ä»¥ä¸ºæ˜¯ SSHé…ç½®å­˜åœ¨é—®é¢˜ï¼Œä½†æ˜¯æ£€æŸ¥äº†é…ç½®ä»¥åŠä»“åº“æƒ…å†µå¹¶æ²¡æœ‰å‘ç°é—®é¢˜</p><p>æ­¤å¤–å°è¯•äº†ç›´æ¥ä½¿ç”¨ git è¿›è¡Œ pull å’Œ push çš„æ“ä½œï¼Œä¹Ÿæ— æ³•æˆåŠŸ</p><h1 id="dns-è§£æ">DNS è§£æ</h1><p>æŸ¥çœ‹äº†ä¸€äº›æ–‡ç« ï¼Œæ­¤ç±» access é—®é¢˜å¤§è‡´æœ‰ä»¥ä¸‹åŸå› ï¼š</p><ul><li>SSH é…ç½®é”™è¯¯</li><li>22 ç«¯å£è¢«ç¦æ­¢</li><li>DNS è§£æ</li></ul><p>æ’é™¤äº†ä¸€äº›å¯èƒ½ä¹‹åå°è¯•æ˜¯ DNS å­˜åœ¨é—®é¢˜</p><p>å°è¯•ä¿®æ”¹ IPv4 DNS é…ç½®åä¾ç„¶æ— æ³•è®¿é—®</p><p><strong>ç¬¬ä¸€æ­¥</strong></p><p>ä½¿ç”¨ <code>ssh git@github.com</code> éªŒè¯æ˜¯å¦å¯ä»¥é€šè¿‡ SSH è¿æ¥github</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br></pre></td></tr></table></figure><p>ç¡®å®æ— æ³•æ­£å¸¸è¿æ¥</p><p><strong>ç¬¬äºŒæ­¥</strong></p><p>ä½¿ç”¨ <code>ssh -v</code> å‘½ä»¤ï¼Œ<code>-v</code> è¡¨ç¤ºverboseï¼Œä¼šæ‰“å‡ºå»ºç«‹ SSH è¿æ¥è¿‡ç¨‹çš„è¯¦ç»†æ—¥å¿—</p><p><code>ssh -v git@github.com</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenSSH_for_Windows_8.1p1, LibreSSL 3.0.2</span><br><span class="line">debug1: Connecting to github.com [127.0.0.1] port 22.</span><br><span class="line">debug1: connect to address 127.0.0.1 port 22: Connection refused</span><br><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹ github.com çš„è®¿é—®ä¼šè¯·æ±‚åˆ° 127.0.0.1ï¼Œè®¿é—®æœ¬æœº IPæ˜æ˜¾æ˜¯ä¸æ­£ç¡®çš„</p><p>æ£€æŸ¥äº† hosts é…ç½®ä¹Ÿæ²¡å‘ç°å­˜åœ¨é’ˆå¯¹ github åŸŸåçš„ç›¸å…³é”™è¯¯é…ç½®</p><p><strong>ç¬¬ä¸‰æ­¥</strong></p><p>ä½¿ç”¨ <code>nslookup</code> å‘½ä»¤è·å– github çš„ IP åœ°å€ï¼›ä½¿ç”¨ Google çš„DNS 8.8.8.8</p><p><code>nslookup github.com 8.8.8.8</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Server:  dns.google</span><br><span class="line">Address:  8.8.8.8</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:    github.com</span><br><span class="line">Address:  20.205.243.166</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ° IP åœ°å€ 20.205.243.166</p><p><strong>ç¬¬å››æ­¥</strong></p><p>é…ç½® hostsï¼›hosts è·¯å¾„ä¸€èˆ¬ä¸º<code>C:\Windows\System32\drivers\etc\hosts</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># github</span></span><br><span class="line">20.205.243.166 github.com</span><br></pre></td></tr></table></figure><p>éšåç»§ç»­è¿›è¡Œ <code>ssh -T git@github.com</code> éªŒè¯åˆ™ accessæˆåŠŸï¼ŒIP ä¹ŸæˆåŠŸè®¿é—®äº†é…ç½®çš„ 20.205.243.166</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hi xxx! You<span class="string">&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debug1: Authentication succeeded (publickey).</span><br><span class="line">Authenticated to github.com ([20.205.243.166]:22).</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/578435111">å‘ï¼šssh: connect tohost github.com port 22: Connection refused - çŸ¥ä¹ (zhihu.com)</a></p><p><ahref="https://blog.csdn.net/MBuger/article/details/70226712">è§£å†³ssh:connect to host github.com port 22: Connectionrefused_Seven17000çš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
            <tag> ç–‘éš¾za&#39;zheng </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LiteFlow - WhenCondition å’Œå¼‚æ­¥è¶…æ—¶æœºåˆ¶</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20WhenCondition%20%E5%92%8C%E5%BC%82%E6%AD%A5%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20WhenCondition%20%E5%92%8C%E5%BC%82%E6%AD%A5%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6.html</url>
      
        <content type="html"><![CDATA[<h1 id="whencondition">WhenCondition</h1><p>å¯¹åº” EL è§„åˆ™ä¸­çš„ <code>WHEN</code> å…³é”®å­—ï¼Œä¼šè¢«åŒ…è£…ä¸º<code>WhenCondition</code> ç»„ä»¶</p><p>ä¸»è¦çš„å¹¶å‘ç¼–æ’é€»è¾‘ä¸»è¦ç”± <code>WhenCondition</code>çš„å®ç°æ–¹æ³•æ‰§è¡Œ</p><h2 id="å±æ€§">å±æ€§</h2><p><code>WHEN</code> å…³é”®å­—æ”¯æŒçš„å±æ€§ï¼š</p><ul><li><code>ignoreError</code>ï¼šè°ƒç”¨é“¾è°ƒç”¨å¤±è´¥æ—¶æ˜¯å¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li><li><code>group</code>ï¼šå¹¶å‘åˆ†ç»„ï¼›è¯¥å±æ€§å·²ç»å¼ƒç”¨ï¼Œå› ä¸ºå¯ä»¥ä½¿ç”¨ä¸åŒçš„<code>WHEN</code> è¿›è¡Œåˆ†ç»„æ§åˆ¶ï¼Œä¾‹å¦‚<code>THEN(WHEN(a,b),WHEN(c,d))</code></li><li><code>any</code>ï¼šä»»æ„èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸå°±ç»§ç»­å‘ä¸‹æ‰§è¡Œ</li><li><code>threadExecutorClass</code>ï¼šçº¿ç¨‹æ± åç§°ï¼›å®ä¾‹åŒ–åçš„çº¿ç¨‹æ± ä¼šè¢«æ”¾åœ¨<code>ExecutorHelper</code> çš„<code>Map&lt;String, ExecutorService&gt; executorServiceMap</code>å±æ€§</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhenCondition</span> <span class="keyword">extends</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">ignoreError</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> LocalDefaultFlowConstant.DEFAULT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">any</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String threadExecutorClass;</span><br></pre></td></tr></table></figure><h2 id="ä»»åŠ¡ç¼–æ’">ä»»åŠ¡ç¼–æ’</h2><p><code>WhenCondition</code> å®ç°çš„ <code>Condition</code> æŠ½è±¡æ–¹æ³•<code>executeCondition</code></p><p>æ ¸å¿ƒæ“ä½œå°±æ˜¯å°†ä»»åŠ¡åŒ…è£…ä¸º <code>CompletableFuture</code>ï¼š</p><ol type="1"><li>è¿‡æ»¤å‰åç½®ç»„ä»¶</li><li>è¿‡æ»¤ <code>isAccess</code>falseï¼›ä¸€æ˜¯è¿‡æ»¤æ‰ä¸éœ€è¦æ‰§è¡Œçš„ç»„ä»¶ï¼ŒäºŒæ˜¯ä¸æ‰§è¡Œçš„ç»„ä»¶ä¸€å®šæ˜¯æ‰§è¡Œå®Œæˆæœ€å¿«çš„ï¼Œä¼šé€ æˆ<code>any</code> å±æ€§ç»“æœçš„æ··ä¹±</li><li>å¯¹ <code>Condition</code> ä¸‹çš„<code>Map&lt;String, List&lt;Executable&gt;&gt; executableGroup</code>åŒ…è£…ä¸º <code>CompletableFuture</code>ï¼Œç¼–æ’å¼‚æ­¥ä»»åŠ¡</li><li>åœ¨åŒ…è£…ä¸º <code>CompletableFuture</code> è¿‡ç¨‹ä¸­ä½¿ç”¨äº†<code>CompletableFutureTimeout</code> å·¥å…·ï¼Œå¥—å…¥<code>CompletableFutureTimeout</code> æ–¹æ³•è¿›è¡Œè¶…æ—¶åˆ¤æ–­ï¼Œå¦‚æœè¶…æ—¶åˆ™ç”¨<code>WhenFutureObj.timeOut</code> è¿”å›è¶…æ—¶çš„å¯¹è±¡</li><li>æœ€ç»ˆå°†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ”¾è¿›é›†åˆ<code>List&lt;CompletableFuture&lt;WhenFutureObj&gt;&gt;</code></li></ol><p><strong>æ ¹æ® any å±æ€§å¯¹ä»»åŠ¡é›†åˆå†æ¬¡è¿›è¡Œç¼–æ’å°è£…</strong></p><p>å¦‚æœæ˜¯ <code>any</code> å±æ€§ï¼Œåˆ™ä½¿ç”¨<code>CompletableFuture.anyOf</code> è¿›è¡Œç¼–æ’ï¼Œå¦åˆ™ä½¿ç”¨<code>CompletableFuture.allOf</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.isAny()) &#123;</span><br><span class="line">    <span class="comment">// æŠŠè¿™äº› CompletableFuture é€šè¿‡ anyOf åˆæˆä¸€ä¸ª CompletableFuture</span></span><br><span class="line">    resultCompletableFuture = CompletableFuture</span><br><span class="line">        .anyOf(completableFutureList.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[] &#123;&#125;));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æŠŠè¿™äº› CompletableFuture é€šè¿‡ allOf åˆæˆä¸€ä¸ª CompletableFuture</span></span><br><span class="line">    resultCompletableFuture = CompletableFuture</span><br><span class="line">        .allOf(completableFutureList.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[] &#123;&#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¿›è¡Œæ‰§è¡Œï¼Œè¿™å¥æ‰§è¡Œå®Œåï¼Œå°±æ„å‘³ç€æ‰€æœ‰çš„ä»»åŠ¡è¦ä¹ˆæ‰§è¡Œå®Œæ¯•ï¼Œè¦ä¹ˆè¶…æ—¶è¿”å›</span></span><br><span class="line">    resultCompletableFuture.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¶…æ—¶å®ç°">è¶…æ—¶å®ç°</h2><p>Java 8 çš„ <code>CompletableFuture</code> å¹¶æ²¡æœ‰ timeoutæœºåˆ¶ï¼Œè™½ç„¶å¯ä»¥åœ¨ get çš„æ—¶å€™æŒ‡å®š timeoutï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ªåŒæ­¥å µå¡çš„æ“ä½œ</p><p>ä¸€èˆ¬çš„å®ç°æ–¹æ¡ˆæ˜¯å¯åŠ¨ä¸€ä¸ª <code>ScheduledThreadpoolExecutor</code>çº¿ç¨‹åœ¨ timeout * æ—¶é—´åç›´æ¥è°ƒç”¨<code>CompletableFuture.completeExceptionally(new TimeoutException())</code>* ç„¶åç”¨ <code>acceptEither()</code> æˆ–è€… <code>applyToEither</code>çœ‹æ˜¯æ‰§è¡Œå®Œæˆè¿˜æ˜¯è¶…æ—¶</p><p>Java 9 å¼•å…¥äº† <code>orTimeout</code> å’Œ<code>completeOnTimeOut</code> ä¸¤ä¸ªæ–¹æ³•æ”¯æŒ å¼‚æ­¥ timeoutæœºåˆ¶ï¼Œåº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨ <code>ScheduledThreadpoolExecutor</code>è¿›è¡Œå®ç°çš„</p><p>è¿™é‡Œ LiteFlow å°†ä»»åŠ¡å’Œæ‰§è¡Œå’Œè¶…æ—¶å°è£…æˆäº†ä¸€ä¸ª API å·¥å…·<code>CompletableFutureTimeout</code></p><p>åœ¨ä¸Šé¢ä»»åŠ¡åŒ…è£…è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨äº†<code>CompletableFutureTimeout.completeOnTimeout</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">completeOnTimeout</span><span class="params">(T t, CompletableFuture&lt;T&gt; future, <span class="type">long</span> timeout,</span></span><br><span class="line"><span class="params">        TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> CompletableFuture&lt;T&gt; timeoutFuture = timeoutAfter(timeout, unit);</span><br><span class="line">    <span class="keyword">return</span> future.applyToEither(timeoutFuture, Function.identity()).exceptionally((throwable) -&gt; t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ³›å‹ T ä¸‹çš„ <code>t</code>ï¼Œåœ¨ä»»åŠ¡ç¼–æ’ä¸­æ˜¯<code>WhenFutureObj</code> å¯¹è±¡</li><li><code>future</code> æ˜¯é€šè¿‡<code>CompletableFuture.supplyAsync(new ParallelSupplier(executable, currChainName, slotIndex), parallelExecutor)</code>ç¼–æ’çš„ä»»åŠ¡ <code>CompletableFuture</code> å¯¹è±¡ï¼Œè¿”å›ç»“æœä¾ç„¶æ˜¯<code>WhenFutureObj</code></li><li><code>timeout</code> æ˜¯è¶…æ—¶æ—¶é—´</li><li><code>unit</code> æ˜¯è¶…æ—¶æ—¶é—´å•ä½</li></ul><p><code>timeoutAfter</code> åˆ›å»ºå‡ºè¶…æ—¶å¼‚å¸¸ä»»åŠ¡åï¼Œç”±ä¸šåŠ¡ä»»åŠ¡<code>future</code> çš„ <code>applyToEither</code> ç¼–æ’ä¸¤ä¸ªä»»åŠ¡</p><p><strong>è¶…æ—¶å¼‚å¸¸ä»»åŠ¡</strong></p><p>è°ƒç”¨ <code>timeoutAfter</code> åŒ…è£…è¶…æ—¶ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">timeoutAfter</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;T&gt;();</span><br><span class="line">    <span class="comment">// timeout æ—¶é—´å æŠ›å‡ºTimeoutException ç±»ä¼¼äºsentinel / watcher</span></span><br><span class="line">    Delayer.delayer.schedule(() -&gt; result.completeExceptionally(<span class="keyword">new</span> <span class="title class_">TimeoutException</span>()),</span><br><span class="line">            timeout, unit);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>delayer</code> æ˜¯ä¸€ä¸ª<code>ScheduledThreadPoolExecutor</code></p><p>åˆ›å»ºå‡ºä¸€ä¸ª <code>CompletableFuture</code>ï¼Œå¦‚æœè¯¥ä»»åŠ¡åœ¨<code>get</code> æ—¶æœªå®Œæˆï¼Œåˆ™æŠ›å‡º <code>TimeoutException</code> å¼‚å¸¸</p><h2 id="whenfutureobj">WhenFutureObj</h2><p><code>WhenFutureObj</code> æ˜¯ä»»åŠ¡ç»“æœçš„åŒ…è£…å¯¹è±¡</p><p>å¯¹äºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆçš„çŠ¶æ€æœ‰ä¸‰ç§æƒ…å†µï¼š</p><ul><li>æˆåŠŸ</li><li>å¤±è´¥</li><li>è¶…æ—¶</li></ul><p>åœ¨ <code>ParallelSupplier</code>åŒ…è£…è¿‡ç¨‹ä¸­å¯¹åº”äº†æˆåŠŸã€å¤±è´¥ä¸¤ç§è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParallelSupplier</span> <span class="keyword">implements</span> <span class="title class_">Supplier</span>&lt;WhenFutureObj&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(ParallelSupplier.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Executable executableItem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String currChainId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Integer slotIndex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ParallelSupplier</span><span class="params">(Executable executableItem, String currChainId, Integer slotIndex)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.executableItem = executableItem;</span><br><span class="line"><span class="built_in">this</span>.currChainId = currChainId;</span><br><span class="line"><span class="built_in">this</span>.slotIndex = slotIndex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> WhenFutureObj <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">executableItem.setCurrChainId(currChainId);</span><br><span class="line">executableItem.execute(slotIndex);</span><br><span class="line">            <span class="comment">// æˆåŠŸ</span></span><br><span class="line"><span class="keyword">return</span> WhenFutureObj.success(executableItem.getId());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// å¤±è´¥</span></span><br><span class="line"><span class="keyword">return</span> WhenFutureObj.fail(executableItem.getId(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¶…æ—¶ä»»åŠ¡ä¸­å¯¹åº”äº†è¶…æ—¶çš„çŠ¶æ€è¿”å›<code>WhenFutureObj.timeOut(executable.getId())</code></p><p><strong>å¯¹è±¡ build æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhenFutureObj</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> timeout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String executorName;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Exception ex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WhenFutureObj <span class="title function_">success</span><span class="params">(String executorName)</span> &#123;</span><br><span class="line"><span class="type">WhenFutureObj</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WhenFutureObj</span>();</span><br><span class="line">result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">result.setTimeout(<span class="literal">false</span>);</span><br><span class="line">result.setExecutorName(executorName);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WhenFutureObj <span class="title function_">fail</span><span class="params">(String executorName, Exception ex)</span> &#123;</span><br><span class="line"><span class="type">WhenFutureObj</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WhenFutureObj</span>();</span><br><span class="line">result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">result.setTimeout(<span class="literal">false</span>);</span><br><span class="line">result.setExecutorName(executorName);</span><br><span class="line">result.setEx(ex);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WhenFutureObj <span class="title function_">timeOut</span><span class="params">(String executorName)</span> &#123;</span><br><span class="line"><span class="type">WhenFutureObj</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WhenFutureObj</span>();</span><br><span class="line">result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">result.setTimeout(<span class="literal">true</span>);</span><br><span class="line">result.setExecutorName(executorName);</span><br><span class="line">result.setEx(<span class="keyword">new</span> <span class="title class_">WhenTimeoutException</span>(</span><br><span class="line">StrUtil.format(<span class="string">&quot;Timed out when executing the component[&#123;&#125;],when-max-timeout-seconds config is:&#123;&#125;(s)&quot;</span>,</span><br><span class="line">executorName, LiteflowConfigGetter.get().getWhenMaxWaitSeconds())));</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯è®¾ç½®<code>success</code>ã€<code>timeout</code>ã€å¼‚å¸¸ä¿¡æ¯ç­‰å¼‚æ­¥æ‰§è¡Œç»“æœ</p><h2 id="ç»“æœè§£æ">ç»“æœè§£æ</h2><p>è¿‡æ»¤å‡ºå·²ç»å®Œæˆçš„ä»»åŠ¡ï¼Œæ”¾åˆ°é›†åˆä¸­</p><p>å¯¹äºæ²¡æœ‰å®Œæˆçš„ä»»åŠ¡å°±æ‰§è¡Œ <code>cancel</code> æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;WhenFutureObj&gt; allCompletableWhenFutureObjList = completableFutureList.stream().filter(f -&gt; &#123;</span><br><span class="line">    <span class="comment">// è¿‡æ»¤å‡ºå·²ç»å®Œæˆçš„ï¼Œæ²¡å®Œæˆçš„å°±ç›´æ¥ç»ˆæ­¢</span></span><br><span class="line">    <span class="keyword">if</span> (f.isDone()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        f.cancel(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).map(f -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">        interrupted[<span class="number">0</span>] = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p>é›†åˆä¸­çš„ä»»åŠ¡ <code>get</code> å‡ºä»»åŠ¡çš„äº§å‡ºï¼Œå³åŒ…è£…çš„<code>WhenFutureObj</code></p><p>æ ¹æ® <code>WhenFutureObj</code> ç»“æœå±æ€§åˆ¤æ–­åç»­æ“ä½œ</p><ul><li>è¾“å‡ºè¶…æ—¶ä¿¡æ¯</li><li>å¦‚æœé…ç½®ä¸­ <code>isIgnoreError</code> ä¸å¿½ç•¥å¼‚å¸¸<ul><li>æ ¹æ® <code>interrupted[0]</code> é›†åˆä¸­çš„ä¸­æ–­æƒ…å†µæŠ›å‡ºå¼‚å¸¸<code>throw new WhenExecuteException(StrUtil.format("requestId [&#123;&#125;] when execute interrupted. errorResume [false].", slot.getRequestId()))</code></li><li>å¾ªç¯åˆ¤æ–­ <code>CompletableFuture</code>çš„è¿”å›å€¼ï¼Œå¦‚æœå¼‚æ­¥æ‰§è¡Œå¤±è´¥ï¼Œåˆ™æŠ›å‡ºç›¸åº”çš„ä¸šåŠ¡å¼‚å¸¸ï¼›å¦‚æœæ˜¯è¶…æ—¶ï¼Œè¿™é‡Œå°±ä¼šæŠ›å‡ºåœ¨è¶…æ—¶ä»»åŠ¡ç¼–æ’æ—¶æŠ›å‡ºçš„<code>TimeoutException</code></li></ul></li><li>å¦‚æœå¿½ç•¥å¼‚å¸¸ï¼›åˆ™å¯¹ä¸­æ–­è¾“å‡º warn æ—¥å¿—</li></ul><h1 id="è¡¥å……">è¡¥å……</h1><h2 id="completablefuture-cancel">CompletableFuture cancel</h2><p>åœ¨ <code>WhenCondition</code> æ‰§è¡Œæµç¨‹ä¸­ï¼Œå¯¹äºåŒ…è£…çš„<code>anyOf</code> <code>CompletableFuture</code>æ‰§è¡Œå®Œæˆåï¼Œå­˜åœ¨æ²¡æœ‰ç»“æŸçš„ä»»åŠ¡ï¼Œåˆ™ä¼šè°ƒç”¨ <code>CompletableFuture</code>çš„ <code>cancel</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">cancelled</span> <span class="operator">=</span> (result == <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">        internalComplete(<span class="keyword">new</span> <span class="title class_">AltResult</span>(<span class="keyword">new</span> <span class="title class_">CancellationException</span>()));</span><br><span class="line">    postComplete();</span><br><span class="line">    <span class="keyword">return</span> cancelled || isCancelled();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•å‚æ•° <code>mayInterruptIfRunning</code>å®é™…å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ•´ä¸ª <code>CompletableFuture</code>çš„æ‰§è¡Œå¹¶ä¸ä¼šè¢«ä¸­æ–­</p><p>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿè¯´</p><blockquote><p><span class="citation" data-cites="param">@param</span>mayInterruptIfRunning this value has no effect in this implementationbecause interrupts are not used to control processing.</p><p>è¿™ä¸ªå€¼åœ¨è¿™ä¸ªå®ç°ä¸­æ²¡æœ‰ä½œç”¨ï¼Œå› ä¸ºä¸­æ–­ä¸ç”¨äºæ§åˆ¶å¤„ç†</p></blockquote><p>è¯¥æ–¹æ³•å®ç°è‡ª <code>Future</code>ï¼Œå…¶å®šä¹‰çš„<code>mayInterruptIfRunning</code> å¹¶æ²¡æœ‰ä½¿ç”¨</p><p>StackOverFlow ä¸­ä¹Ÿæœ‰äººæå‡ºäº†è¿™æ ·çš„é—®é¢˜ï¼Œè®¤ä¸ºè¿åäº†<code>Java.util.concurrent.Future</code> ä¸­å¯¹ <code>cancel</code>æ–¹æ³•å®šä¹‰çš„çº¦å®š</p><p>å…¶åŸå› åœ¨è¯„è®ºä¸­æœ‰æ‰€è®¨è®ºï¼š</p><blockquote><ul><li><p>As mentioned in my previous (edited) comment, the<code>CompletableFuture</code> does not hold a reference to either theactual work or the <code>Thread</code> processing it. This is at leastimplied in the class documentation: "<em>Since (unlike FutureTask) thisclass has no direct control over the computation that causes it to becompleted, cancellation is treated as just another form of exceptionalcompletion</em>"</p><p>ç”±äºä¸ <code>FutureTask</code> ä¸åŒï¼Œ<code>CompletableFuture</code>å¯¹æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ²¡æœ‰ç›´æ¥æ§åˆ¶ï¼Œå› æ­¤å–æ¶ˆè¢«è§†ä¸ºå¦ä¸€ç§å½¢å¼çš„å¼‚å¸¸å®Œæˆ</p></li><li><p><code>CompletableFuture</code> does not hold reference to thread,which I think it is also a problem, It is not consistency with<code>Future</code></p><p><code>CompletableFuture</code>æ²¡æœ‰å¼•ç”¨çº¿ç¨‹ï¼Œæˆ‘è®¤ä¸ºè¿™ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒä¸ <code>Future</code>ä¸ä¸€è‡´</p></li></ul></blockquote><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://stackoverflow.com/questions/55490668/why-does-completablefuture-implement-the-future-interface">java- Why does CompletableFuture implement the Future interface - StackOverflow</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> LiteFlow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€äº› 50/50 shots é…’å•</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä» Ferrari åˆ° Hard Startï¼Œè¿™é‡Œæœ‰ 9 æ¬¾æˆ‘ä»¬æœ€çˆ±çš„ 50/50 shots é…’å•</p></blockquote><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95/Article-50-50-Shots.jpg" class="" title="img"><p>50/50 shots è¯¸å¦‚ Ferrari å’Œ M&amp;Må¤šå¹´æ¥ä¸€è‡´æ˜¯ä¸šå†…å® å„¿ï¼›ä¸è¿‡éšç€è¶Šæ¥è¶Šå—æ¬¢è¿ï¼Œæ´¾å¯¹è€…ä»¬æ‰¾åˆ°äº†å°†é¸¡å°¾é…’ä½œä¸ºé…æ–™çš„æ–¹å¼ï¼Œè¿™ç§å½¢å¼å·²ç»æ‰©å±•ä¸ºä¸€ç§æ˜“äºå¤åˆ¶å¹¶åˆ›ä½œçš„æ¨¡å¼</p><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ï¼šå–ä¸€æ¯è‹¦æä»é…’ï¼ˆamaroï¼‰ï¼Œå°†å…¶ä¸å¦ä¸€ç§åˆ©å£é…’æˆ–æ›´é«˜åº¦çƒˆé…’ç­‰åˆ†</p><p>å„ç§å„æ ·çš„å˜åŒ–ï¼Œæ— è®ºä½ æ˜¯åœ¨å¯»æ‰¾ä¸€ç§ä»¤äººå¤§å¼€çœ¼ç•Œçš„å®¿é†‰æ–¹å¼ï¼šä¾‹å¦‚ HardStartï¼Œæˆ–è€…æ˜¯ä¸€æ¯å¤æ‚æ€§å ªæ¯”é¸¡å°¾é…’çš„ shotï¼šä¾‹å¦‚ Mezcaletti</p><p>è®©æˆ‘ä»¬å¼€å§‹å§ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬æœ€å–œæ¬¢çš„å…³äº 50/50 çš„ä¸€äº› shots</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E4%B8%80%E4%BA%9B%2050-50%20shots%20%E9%85%92%E5%8D%95/Inline-50-50-Shot.jpg" class="" title="50 50 shot"><h1 id="åŸæ–™">åŸæ–™</h1><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/323/fernet-branca">FernetBranca</a></strong>è²å¥ˆç‰¹Â·å¸ƒå…°å¡ï¼›è‘—åçš„æ„å¤§åˆ©è‹¦å‘³é…’ï¼Œé¾™èƒ†ã€ç”˜èŠã€è—çº¢èŠ±ç­‰è‰æœ¬ï¼Œåœ¨Slovenian æ©¡æœ¨æ¡¶é™ˆé…¿</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/190/campari-bitter">Campari</a></strong>é‡‘å·´åˆ©è‹¦é…’</p><p><strong><ahref="https://www.diffordsguide.com/encyclopedia/363/bws/mezcal-what-it-is-and-how-its-made">Mezcal</a></strong>æ¢…æ–¯å¡å°”é…’ï¼›é¾™èˆŒå…°é…’çš„ä¸€ç§ï¼Œå¢¨è¥¿å“¥äº§</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/1819/ramazzotti-amaro">Ramazzotti</a></strong>é›·ç›ä½è’‚è‹¦å‘³é…’ï¼›ç”±å¤šç§è‰æœ¬ã€é¦™æ–™åŒ…æ‹¬é¾™èƒ†å’Œæ©™çš®åˆ¶ä½œçš„è‹¦é…’</p><p><strong>Rye Whiskey</strong> é»‘éº¦å¨å£«å¿Œï¼›ç¾å›½å¨å£«å¿Œï¼Œå¿…é¡»ä»è‡³å°‘ 51ï¼…çš„é»‘éº¦è°·ç‰©ä¸­è’¸é¦ï¼Œä½¿ç”¨æ–°æ©¡æœ¨æ¡¶</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/859/cynar">Cynar</a></strong>è¥¿çº³å°”é…’ï¼›æ„å¤§åˆ©å¼€èƒƒé…’ï¼Œèƒå–æ´‹è“Ÿå¶ï¼ˆCynarascolymusï¼‰é¦™å‘³ï¼Œåå­—æ¥æºäºæ´‹è“Ÿå¶å’Œå…¶ä»–æ·»åŠ çš„æ¤ç‰©</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/1818/montenegro-amaro">Montenegro</a></strong>è’™ç‰¹å†…ç½—ï¼›æ„å¤§åˆ©è‹¦é…’ï¼Œç”± 40ç§æ¤ç‰©ï¼ˆåŒ…æ‹¬ç”˜è‰æ ¹ã€è‚‰è±†è”»ã€ç”œæ©™å’Œè‹¦æ©™ï¼‰è°ƒå‘³</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/2034/nardini-amaro">Nardini</a></strong>çº³å°”è¿ªå°¼ï¼›ä¼ ç»Ÿçš„è‹¦å‘³æ„å¤§åˆ©å¼€èƒƒé…’ï¼Œä¸»è¦ç”¨è‹¦æ©™ã€è–„è·å’Œé¾™èƒ†è°ƒå‘³</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/6733/amaro-meletti">AmaroMeletti</a></strong> æ¢…ä¹æï¼›æ„å¤§åˆ©è‹¦é…’ï¼Œç”¨æ°´æœå’Œé¦™è‰è°ƒå‘³</p><p><strong>Rum</strong> æœ—å§†ï¼›å…­å¤§åŸºé…’ä¹‹ä¸€ï¼ŒåŸæ–™ä¸ºç”˜è”—ç³–èœœ</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/6903/cappelletti">Cappelletti</a></strong>ä¸»è¦ç”¨äºç”¨ç™½è‘¡è„é…’å’Œè‹æ‰“æ°´åˆ¶ä½œ Spritz</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/6483/strega-amaro-liqueur">Strega</a></strong>ä¸€ç§æ„å¤§åˆ©è‹¦é…’</p><p><strong><ahref="https://www.diffordsguide.com/beer-wine-spirits/324/brancamenta">BrancaMenta</a></strong> å¸ƒå…°å¡ Â· è–„è·ï¼›æ„å¤§åˆ©åˆ©å£é…’ï¼Œå¤å­£ç‰ˆæœ¬çš„ FernetBrancaï¼Œæ·»åŠ äº†è–„è·</p><h1 id="é˜¿é©¬ç½—-amaro">é˜¿é©¬ç½— Amaro</h1><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å¾ˆå¤šé…’éƒ½äº§è‡ªæ„å¤§åˆ©ï¼Œå¹¶ä¸”éƒ½æ˜¯â€œAmaroâ€çš„ä¸€ç§ï¼Œç¿»è¯‘ä¸ºäº†â€œè‹¦å‘³é…’â€</p><p>Amaroæ—¢æ˜¯æ„å¤§åˆ©è¯­ä¸­è‹¦çš„æ„æ€ï¼Œä¹Ÿæ˜¯ä¼ ç»Ÿä¸Šæ¥è‡ªæ„å¤§åˆ©çš„è‹¦ä¸­å¸¦ç”œï¼ˆbittersweetï¼‰åˆ©å£é…’çš„åå­—</p><p>Amariï¼ˆAmaroçš„å¤æ•°ï¼‰é€šå¸¸å‘ˆæ·±é»„è¤è‰²ï¼Œä»¥ç™½å…°åœ°ä¸ºåŸºç¡€ï¼Œå¹¶ç”¨é¦™è‰ã€é¦™æ–™å’Œå…¶ä»–æ¤ç‰©è°ƒå‘³</p><p><strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬å¦‚æ­¤å–œçˆ± Amaro</strong></p><p>å¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½å–œæ¬¢è¿™ç§ä»¤äººæŒ¯å¥‹ã€å‘³é“å¼ºçƒˆçš„è‹¦é…’</p><p>ä½†æ˜¯ Amaro å¾ˆå¿«å°±æˆäº† bartenderæœ€å¥½çš„æœ‹å‹ï¼›ä¸ºæ¸…æ·¡ç»†è…»çš„é¸¡å°¾é…’å°‘é‡åŠ å…¥å¯ä»¥å¢åŠ å‘³é“çš„å¤æ‚æ€§ï¼Œå¾ˆå®¹æ˜“ç†è§£ä¸ºä»€ä¹ˆåçˆ±æµ“éƒå£å‘³çš„çˆ±å¥½è€…ä¼šå¦‚æ­¤ç€è¿·</p><p><ahref="https://www.diffordsguide.com/beer-wine-spirits/category/1202/amari">Amari(diffordsguide.com)</a></p><blockquote><p><strong>é˜¿é©¬ç½—ï¼ˆAmaroï¼‰ å’Œæ¯”ç‰¹é…’ï¼ˆBitterï¼‰ çš„åŒºåˆ«</strong></p><p>é˜¿é©¬ç½—å’Œè‹¦ç²¾çš„ä¸åŒä¹‹å¤„åœ¨äºå®ƒæ›´é€‚åˆçº¯é¥®ï¼Œè€Œä¸æ˜¯ç”¨æ¥è°ƒå‘³</p><p>é˜¿é©¬ç½—è¢«å½’ä¸ºå¯çº¯é¥®çš„è‹¦é…’ï¼Œè€Œä¸åƒ Angosturaç­‰æ¯”ç‰¹é…’ä½œä¸ºé¸¡å°¾é…’çš„ç‚¹ç¼€</p><p>é©¬å…‹Â·å½¼å¾—æ›¼åœ¨ã€Šå½¼å¾—æ›¼çš„è‹¦é…’ä¸é˜¿é©¬ç½—æŒ‡å¯¼æ‰‹å†Œã€‹ä¸­è¿™ä¹ˆå†™é“ï¼šä¸€äº›é˜¿é©¬ç½—éœ€è¦ä½ ç»†ç»†å“é‰´ï¼Œè€Œå¦ä¸€äº›åˆ™çœŸçš„éš¾ä»¥ä¸‹å’½</p><p><ahref="https://zhuanlan.zhihu.com/p/36368828">ä»€ä¹ˆæ˜¯é˜¿é©¬ç½—ï¼Ÿæ„å¤§åˆ©è‹¦é…’æ‰‹è®°- çŸ¥ä¹ (zhihu.com)</a></p></blockquote><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://punchdrink.com/articles/best-shots-amaro-whiskey-mezcal/">The9 Best Bartenderâ€™s Handshake Shots, Beyond the Ferrari | PUNCH(punchdrink.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TransmittableThreadLocal æºç  &amp; ç®€å•ä½¿ç”¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&amp;%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&amp;%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="å¯ç»§æ‰¿-inheritable">å¯ç»§æ‰¿ Inheritable</h1><p><code>InheritableThreadLocal</code> æ˜¯å®˜æ–¹æä¾›çš„ç±»ï¼ŒåŒºåˆ«äº<code>ThreadLocal</code> çš„åŠŸèƒ½å°±æ˜¯ä½¿å­çº¿ç¨‹åˆ›å»ºæ—¶ä¼šèµ‹å€¼çˆ¶çº¿ç¨‹å½“æ—¶çš„<code>ThreadLocal</code>å€¼ï¼ˆå¼•ç”¨ï¼‰ï¼Œå®ç°å¼€å¯çº¿ç¨‹åå°†çº¿ç¨‹æœ¬åœ°å˜é‡ä¼ é€’</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡Œå¦‚æœå°† ThreadLocal å®ç°æ¢ä¸º ThreadLocalï¼Œåˆ™å­çº¿ç¨‹å†…è·å–ä¸º null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[Thread-<span class="number">0</span>,<span class="number">5</span>,main] Hello World</span><br></pre></td></tr></table></figure><h2 id="å®ç°">å®ç°</h2><p><code>ThreadLocal</code> å¯¹è±¡æœ¬è´¨æ˜¯ <code>Thread</code> å†…<code>threadLocalMap</code> çš„ key</p><p><code>InheritableThreadLocal</code> åŠŸèƒ½çš„å®ç°éœ€è¦ä¸¤æ–¹æ”¯æŒï¼š</p><ul><li><code>InheritableThreadLocal</code> å°†çˆ¶ç±» <code>ThreadLocal</code>å…³äº map çš„å®ç°é‡å†™ä¸ºæ”¯æŒæ–°çš„ mapï¼ˆinheritableThreadLocalsï¼‰</li><li><code>Thread</code> å†…æä¾› <code>InheritableThreadLocal</code>ä½¿ç”¨çš„ mapï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹åˆ›å»ºæœŸé—´å°†çˆ¶çº¿ç¨‹çš„ map å€¼ä¼ é€’ç»™å­çº¿ç¨‹</li></ul><p><strong>InheritableThreadLocal é‡å†™æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Computes the child&#x27;s initial value for this inheritable thread-local</span></span><br><span class="line"><span class="comment">     * variable as a function of the parent&#x27;s value at the time the child</span></span><br><span class="line"><span class="comment">     * thread is created.  This method is called from within the parent</span></span><br><span class="line"><span class="comment">     * thread before the child is started.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method merely returns its input argument, and should be overridden</span></span><br><span class="line"><span class="comment">     * if a different behavior is desired.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parentValue the parent thread&#x27;s value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the child thread&#x27;s initial value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">childValue</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the map associated with a ThreadLocal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the current thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> t.inheritableThreadLocals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create the map associated with a ThreadLocal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the current thread</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstValue value for the initial entry of the table.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.inheritableThreadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Thread init èµ‹å€¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span><br><span class="line"><span class="params">                      <span class="type">long</span> stackSize, AccessControlContext acc,</span></span><br><span class="line"><span class="params">                      <span class="type">boolean</span> inheritThreadLocals)</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="comment">// å¦‚æœå‚æ•°å¼€å…³å¼€å¯ï¼Œçˆ¶çº¿ç¨‹å­˜åœ¨ inheritableThreadLocalsï¼Œåˆ™è¿›è¡Œ createInheritedMap å¹¶èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>)</span><br><span class="line">            <span class="built_in">this</span>.inheritableThreadLocals =</span><br><span class="line">                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">/* Stash the specified stack size in case the VM cares */</span></span><br><span class="line">        <span class="built_in">this</span>.stackSize = stackSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set thread ID */</span></span><br><span class="line">        tid = nextThreadID();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å±€é™">å±€é™</h2><p><code>InheritableThreadLocal</code> åœ¨éƒ¨åˆ†åœºæ™¯æœ‰å…¶å±€é™æ€§ï¼š</p><ul><li><p>åªèƒ½åœ¨çº¿ç¨‹åˆ›å»ºåˆå§‹åŒ–æ—¶æœŸèµ‹å€¼ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸€èˆ¬æ˜¯å¤ç”¨çš„ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨çº¿ç¨‹æ± åˆ™æ— æ³•ä¼ é€’</p><p>å½“ç„¶è¿™ç§è¡Œä¸ºç¬¦åˆé¢„æœŸçš„ï¼Œå› ä¸º Inheritableå¼ºè°ƒçš„å°±æ˜¯<strong>ç»§æ‰¿æ€§</strong>ï¼Œçº¿ç¨‹æ± çš„åœºæ™¯å¼ºè°ƒçš„æ˜¯<strong>ä¼ é€’æ€§</strong></p><blockquote><p>ä½†å¯¹äºä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶çš„æƒ…å†µï¼Œçº¿ç¨‹ç”±çº¿ç¨‹æ± åˆ›å»ºå¥½ï¼Œå¹¶ä¸”çº¿ç¨‹æ˜¯æ± åŒ–èµ·æ¥åå¤ä½¿ç”¨çš„ï¼›è¿™æ—¶çˆ¶å­çº¿ç¨‹å…³ç³»çš„<code>ThreadLocal</code>å€¼ä¼ é€’å·²ç»æ²¡æœ‰æ„ä¹‰ï¼Œåº”ç”¨éœ€è¦çš„å®é™…ä¸Šæ˜¯æŠŠ<strong>ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ—¶</strong>çš„<code>ThreadLocal</code>å€¼ä¼ é€’åˆ°<strong>ä»»åŠ¡æ‰§è¡Œæ—¶</strong></p><p><ahref="https://github.com/alibaba/transmittable-thread-local#-åŠŸèƒ½">alibaba/transmittable-thread-local:transmittable-thread-local-åŠŸèƒ½</a></p></blockquote></li><li><p>ä¼ é€’çš„æ˜¯å¼•ç”¨è€Œä¸æ˜¯æ‹·è´ï¼Œä½¿ç”¨ä¸­éœ€è¦æ³¨æ„å¼•ç”¨æ•°æ®ä¿®æ”¹çš„å½±å“ï¼›ä¹Ÿæ²¡æœ‰æä¾›æ‹·è´ç›¸å…³çš„èƒ½åŠ›å®ç°</p></li></ul><p><strong>çº¿ç¨‹æ± å¤ç”¨åˆ™æ— æ³•ä¼ é€’</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å•çº¿ç¨‹çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// ä¸ºäº†è®©çº¿ç¨‹æ±  init ä¸€ä¸ªæ–°çº¿ç¨‹</span></span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(<span class="string">&quot;init&quot;</span>));</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤ç”¨çº¿ç¨‹</span></span><br><span class="line">        EXECUTOR.execute(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main] <span class="literal">null</span></span><br></pre></td></tr></table></figure><h1 id="å¯ä¼ é€’-transmittable">å¯ä¼ é€’ Transmittable</h1><p>alibaba å¼€æºçš„ <ahref="https://github.com/alibaba/transmittable-thread-local">transmittable-thread-local</a>å¯ä»¥è§£å†³æ»¡è¶³éœ€è¦</p><p><code>ThreadLocal</code>çš„éœ€æ±‚åœºæ™¯å³<code>TransmittableThreadLocal</code>çš„æ½œåœ¨éœ€æ±‚åœºæ™¯ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡éœ€è¦<em>åœ¨ä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶æƒ…å†µä¸‹ä¼ é€’<code>ThreadLocal</code> å€¼</em> åˆ™æ˜¯<code>TransmittableThreadLocal</code> ç›®æ ‡åœºæ™¯</p><p>ä¸‹é¢æ˜¯å‡ ä¸ªå…¸å‹åœºæ™¯ä¾‹å­ï¼š</p><ol type="1"><li>åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ æˆ– å…¨é“¾è·¯å‹æµ‹ï¼ˆå³é“¾è·¯æ‰“æ ‡ï¼‰</li><li>æ—¥å¿—æ”¶é›†è®°å½•ç³»ç»Ÿä¸Šä¸‹æ–‡</li><li><code>Session</code> çº§ <code>Cache</code></li><li>åº”ç”¨å®¹å™¨æˆ–ä¸Šå±‚æ¡†æ¶è·¨åº”ç”¨ä»£ç ç»™ä¸‹å±‚<code>SDK</code>ä¼ é€’ä¿¡æ¯</li></ol><p>å®˜æ–¹æ–‡æ¡£å†™çš„éå¸¸è¯¦ç»†ï¼Œæˆ‘å°±ä¸èµ˜è¿°äº†ï¼Œå…·ä½“å¯ä»¥å»æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï½</p><h2 id="ç®€å•ä½¿ç”¨">ç®€å•ä½¿ç”¨</h2><p>å…³äºä½¿ç”¨å®˜æ–¹æ–‡æ¡£ä¹Ÿæè¿°çš„éå¸¸è¯¦ç»†ï¼Œè¿™é‡Œå°±ç®€å•åˆ—ä¸¾ä¸€ä¸‹ Java ä»£ç </p><p>ä¾èµ–ä¸º 2.12.6 ç‰ˆæœ¬</p><blockquote><p>ä»<code>TTL v2.13+</code>å¼€å§‹ï¼Œå‡çº§åˆ°<code>Java 8</code>ã€‚å¦‚æœéœ€è¦<code>Java 6</code>çš„æ”¯æŒï¼Œä½¿ç”¨ç‰ˆæœ¬<code>2.12.x</code></p><p><ahref="https://search.maven.org/artifact/com.alibaba/transmittable-thread-local"><imgsrc="https://camo.githubusercontent.com/bc33d0e5608d42d034de759fc7e6a2c4a65bbd3b9231c0d3f4f7bb815e5d08c0/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f636f6d2e616c69626162612f7472616e736d69747461626c652d7468726561642d6c6f63616c3f76657273696f6e5072656669783d322e31322e26636f6c6f723d6c6967687467726579266c6f676f3d6170616368652d6d6176656e266c6f676f436f6c6f723d7768697465"alt="Maven Central" /></a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;transmittable-thread-local&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.12</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="è£…é¥°-runnable">è£…é¥° Runnable</h3><p>ä½¿ç”¨ <code>TtlRunnable</code> å’Œ <code>TtlCallable</code>æ¥ä¿®é¥°ä¼ å…¥çº¿ç¨‹æ± çš„ <code>Runnable</code> å’Œ <code>Callable</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ TransmittableThreadLocal</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(<span class="string">&quot;init&quot;</span>));</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è£…é¥° Runnable ä¸º TtlRunnable</span></span><br><span class="line">        <span class="type">TtlRunnable</span> <span class="variable">ttlRunnable</span> <span class="operator">=</span> TtlRunnable.get(() -&gt; System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get()));</span><br><span class="line">        EXECUTOR.execute(ttlRunnable);</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main] Hello World</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„ï¼š</strong>å³ä½¿æäº¤åŒä¸€ä¸ª <code>Runnable</code>ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œæ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œè£…é¥°æ“ä½œï¼Œå¦åˆ™æŠ“å–çš„ä»æ˜¯ä¸Šä¸€æ¬¡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p><h3 id="è£…é¥°çº¿ç¨‹æ± ">è£…é¥°çº¿ç¨‹æ± </h3><p>çœå»æ¯æ¬¡ <code>Runnable</code> å’Œ <code>Callable</code>ä¼ å…¥çº¿ç¨‹æ± æ—¶çš„ä¿®é¥°ï¼Œè¿™ä¸ªé€»è¾‘å¯ä»¥åœ¨çº¿ç¨‹æ± ä¸­å®Œæˆ</p><p>é€šè¿‡å·¥å…·ç±» <code>TtlExecutors</code> å®Œæˆï¼Œæœ‰ä¸‹é¢çš„æ–¹æ³•ï¼š</p><ul><li><code>getTtlExecutor</code>ï¼šä¿®é¥°æ¥å£ <code>Executor</code></li><li><code>getTtlExecutorService</code>ï¼šä¿®é¥°æ¥å£<code>ExecutorService</code></li><li><code>getTtlScheduledExecutorService</code>ï¼šä¿®é¥°æ¥å£<code>ScheduledExecutorService</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è£…é¥°çº¿ç¨‹æ±  ExecutorService</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span> TtlExecutors.getTtlExecutorService(Executors.newSingleThreadExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(<span class="string">&quot;init&quot;</span>));</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä¸éœ€è¦å†è£…é¥° Runnable</span></span><br><span class="line">        EXECUTOR.execute(() -&gt; System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get()));</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot; &quot;</span> + THREAD_LOCAL.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">Thread[main,<span class="number">5</span>,main] Hello World</span><br><span class="line">Thread[pool-<span class="number">1</span>-thread-<span class="number">1</span>,<span class="number">5</span>,main] Hello World</span><br></pre></td></tr></table></figure><h2 id="æºç åŠæ€æƒ³">æºç åŠæ€æƒ³</h2><h3 id="transmittablethreadlocal">TransmittableThreadLocal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">TtlCopier</span>&lt;T&gt;</span><br></pre></td></tr></table></figure><p>ç»§æ‰¿äº† <code>InheritableThreadLocal</code>ï¼Œå®ç°äº†<code>TtlCopier</code></p><p>é‡ç‚¹å…³æ³¨ <code>set</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!disableIgnoreNullValueSemantics &amp;&amp; <span class="literal">null</span> == value) &#123;</span><br><span class="line">        <span class="comment">// may set null to remove value</span></span><br><span class="line">        remove();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.set(value);</span><br><span class="line">        addThisToHolder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä½¿ç”¨çˆ¶ç±» <code>InheritableThreadLocal</code> çš„ <code>set</code>æ–¹æ³•ä¹‹åï¼Œè°ƒç”¨äº† <code>addThisToHolder</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addThisToHolder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!holder.get().containsKey(<span class="built_in">this</span>)) &#123;</span><br><span class="line">        holder.get().put((TransmittableThreadLocal&lt;Object&gt;) <span class="built_in">this</span>, <span class="literal">null</span>); <span class="comment">// WeakHashMap supports null value.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°† <code>this</code> å¯¹è±¡ï¼Œå³ <code>TransmittableThreadLocal</code>å¯¹è±¡ä½œä¸º key æ”¾è¿› <code>holder</code> ä¸­ï¼Œè¿™é‡Œçš„ <code>holder</code>æ˜¯ä¸€ä¸ªæ³›å½¢ä¸º Map çš„<code>InheritableThreadLocal</code>ï¼Œä¸‹é¢ä¼šè¿›è¡Œåˆ†æ</p><p>è¿™é‡Œçš„ Map åªç”¨æ¥ä½œä¸º Setï¼Œ<strong>WeakHashMap supports nullvalue.</strong>ï¼›ç±»ä¼¼çš„æ€æƒ³è¿˜æœ‰ä½¿ç”¨ <code>ConcurrentHashMap</code>å®ç°å¹¶å‘å®‰å…¨çš„ Set</p><h3 id="holder">holder</h3><p><code>holder</code> æ˜¯ <code>TransmittableThreadLocal</code>è¿›è¡Œæ‰©å±•çš„å…³é”®ä¸€ç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InheritableThreadLocal&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt; holder =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; initialValue() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; childValue(WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; parentValue) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;(parentValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œé‡å†™äº† <code>InheritableThreadLocal</code> çš„<code>initialValue</code> å’Œ <code>childValue</code> æ–¹æ³•</p><ul><li>initialValueï¼šç›´æ¥åˆ›å»º Map</li><li>childValueï¼š<code>ThreadLocal.createInheritedMap</code>ä¸­å¤åˆ¶å€¼æ—¶è°ƒç”¨ï¼Œé‡å†™å®ç°ä¸ºåŒ…è£…ä¸€ä¸ªæ–° Map</li></ul><p>åœ¨ä¸Šä¸€æ­¥çš„ <code>addThisToHolder</code> æ“ä½œä¸­ï¼Œä¼šå°†<code>TransmittableThreadLocal</code> çš„ <code>this</code> å¯¹è±¡æ”¾è¿›<code>holder</code> çš„ Map ä¸­</p><h3 id="ttlrunnable">TtlRunnable</h3><p>ä½¿ç”¨ <code>TtlRunnable</code> çš„é™æ€æ–¹æ³• <code>get</code> å¯¹æ™®é€šçš„<code>Runnable</code> è¿›è¡Œè£…é¥°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> TtlRunnable <span class="title function_">get</span><span class="params">(<span class="meta">@Nullable</span> Runnable runnable, <span class="type">boolean</span> releaseTtlValueReferenceAfterRun, <span class="type">boolean</span> idempotent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == runnable) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡Œé¿å…è¿‡åº¦è£…é¥°ï¼Œåªè£…é¥°ä¸€å±‚</span></span><br><span class="line">    <span class="keyword">if</span> (runnable <span class="keyword">instanceof</span> TtlEnhanced) &#123;</span><br><span class="line">        <span class="comment">// avoid redundant decoration, and ensure idempotency</span></span><br><span class="line">        <span class="keyword">if</span> (idempotent) <span class="keyword">return</span> (TtlRunnable) runnable;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Already TtlRunnable!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åŒ…è£…æˆ TtlRunnable å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TtlRunnable</span>(runnable, releaseTtlValueReferenceAfterRun);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡ <code>TtlRunnable</code> çš„æ„é€ å™¨åŒ…è£…æˆ<code>TtlRunnable</code> å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">TtlRunnable</span><span class="params">(<span class="meta">@NonNull</span> Runnable runnable, <span class="type">boolean</span> releaseTtlValueReferenceAfterRun)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.capturedRef = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;Object&gt;(capture());</span><br><span class="line">    <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">    <span class="built_in">this</span>.releaseTtlValueReferenceAfterRun = releaseTtlValueReferenceAfterRun;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ª <code>ThreadLocal</code> ä¼ é€’çš„å…³é”®éƒ½åœ¨ <code>capturedRef</code>å¯¹è±¡ï¼Œèµ‹å€¼çš„å…³é”®é€»è¾‘åœ¨ <code>Transmitter.capture</code> æ–¹æ³•</p><h3 id="transmitter">Transmitter</h3><p><code>Transmitter</code> æ‰®æ¼”ä¼ é€’è€…çš„è§’è‰²ï¼Œæ˜¯<code>TransmittableThreadLocal</code> çš„å…¬æœ‰é™æ€å†…éƒ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Transmitter</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Capture all &#123;<span class="doctag">@link</span> TransmittableThreadLocal&#125; and registered &#123;<span class="doctag">@link</span> ThreadLocal&#125; values in the current thread.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the captured &#123;<span class="doctag">@link</span> TransmittableThreadLocal&#125; values</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@since</span> 2.3.0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">capture</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Snapshot</span>(captureTtlValues(), captureThreadLocalValues());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; <span class="title function_">captureTtlValues</span><span class="params">()</span> &#123;</span><br><span class="line">            HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; ttl2Value = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">            <span class="keyword">for</span> (TransmittableThreadLocal&lt;Object&gt; threadLocal : holder.get().keySet()) &#123;</span><br><span class="line">                ttl2Value.put(threadLocal, threadLocal.copyValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ttl2Value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª <code>Snapshot</code> çš„å¯¹è±¡ï¼Œå°† <code>holder</code> ä¸­çš„keysï¼ˆä¹Ÿå°±æ˜¯å°† <code>WeakHashMap</code> å½“ä½œ Set æ¥ä½¿ç”¨ï¼Œkey ä¸º<code>TransmittableThreadLocal</code> å¯¹è±¡ï¼‰éå†å–å‡ºï¼ŒåŒæ—¶è°ƒç”¨<code>copyValue</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T <span class="title function_">copyValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> copy(get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">copy</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parentValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºç¡€çš„ <code>TransmittableThreadLocal</code> å®ç°å°±æ˜¯å°† value getå‡ºæ¥ï¼Œä¸æ¶‰åŠ copy ç­‰æ“ä½œ</p><p>å®Œæˆè¿™äº›åï¼Œ<code>TtlRunnable</code> å°±å®ä¾‹åŒ–å®Œæˆï¼Œå¹¶ä¸”ä¿å­˜äº†<code>Snapshot</code> ç»“æ„ï¼Œä¿å­˜å½“å‰æ—¶é—´ç‚¹ã€å½“å‰çº¿ç¨‹ä¸‹çš„<code>TransmittableThreadLocal</code> å¯¹è±¡åŠå…¶ value</p><h3 id="run">run</h3><p>æœ€ç»ˆæ”¾å…¥çº¿ç¨‹æ± çš„ <code>Runnable</code> æ˜¯è¢«è£…é¥°çš„<code>TtlRunnable</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// è·å–å½“æ—¶ä¿å­˜çš„ çˆ¶çº¿ç¨‹ + è£…é¥°é‚£ä¸€åˆ»çš„ Snapshot</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">captured</span> <span class="operator">=</span> capturedRef.get();</span><br><span class="line">  <span class="comment">// captured == null è¯´æ˜è¯¥ Runnable å·²ç»è¢« run äº†</span></span><br><span class="line">  <span class="comment">// capturedRef.compareAndSet(captured, null) ä½¿ç”¨åŸå­ç±»ä¿è¯äº‰æŠ¢æ‰§è¡Œèµ„æ ¼</span></span><br><span class="line">    <span class="keyword">if</span> (captured == <span class="literal">null</span> || releaseTtlValueReferenceAfterRun &amp;&amp; !capturedRef.compareAndSet(captured, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;TTL value reference is released after run!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// replay é‡æ”¾</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">backup</span> <span class="operator">=</span> replay(captured);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æ‰§è¡Œè¢«è£…é¥°çš„çœŸæ­£çš„ Runnable</span></span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// restore æ¢å¤</span></span><br><span class="line">        restore(backup);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="replay">replay</h3><p>ä¿å­˜å½“å‰æ—¶é—´çš„å‰¯æœ¬ï¼Œä¾é ä¼ å‚è¿›å…¥çš„å¿«ç…§ <code>captured</code>å°†è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">replay</span><span class="params">(<span class="meta">@NonNull</span> Object captured)</span> &#123;</span><br><span class="line"><span class="comment">// å–å‡ºå¿«ç…§</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Snapshot</span> <span class="variable">capturedSnapshot</span> <span class="operator">=</span> (Snapshot) captured;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Snapshot</span>(replayTtlValues(capturedSnapshot.ttl2Value), replayThreadLocalValues(capturedSnapshot.threadLocal2Value));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; <span class="title function_">replayTtlValues</span><span class="params">(<span class="meta">@NonNull</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; captured)</span> &#123;</span><br><span class="line">            HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; backup = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æ³¨æ„è¿™é‡Œçš„ holderï¼Œæ­¤æ—¶å·²ç»åœ¨å­çº¿ç¨‹å†…äº†</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Iterator&lt;TransmittableThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); iterator.hasNext(); ) &#123;</span><br><span class="line">                TransmittableThreadLocal&lt;Object&gt; threadLocal = iterator.next();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// backup</span></span><br><span class="line">                backup.put(threadLocal, threadLocal.get());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// clear the TTL values that is not in captured</span></span><br><span class="line">                <span class="comment">// avoid the extra TTL values after replay when run task</span></span><br><span class="line">                <span class="keyword">if</span> (!captured.containsKey(threadLocal)) &#123;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    threadLocal.superRemove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// set TTL values to captured</span></span><br><span class="line">            setTtlValuesTo(captured);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// call beforeExecute callback</span></span><br><span class="line">            doExecuteCallback(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> backup;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯ä¸ºäº†æ‹¿åˆ°å‰¯æœ¬ï¼Œ<strong>ä¸ºä»€ä¹ˆéœ€è¦æ‹¿åˆ°å‰¯æœ¬è€Œä¸æ˜¯ç›´æ¥æ ¹æ®å¿«ç…§è®¾ç½®å€¼å¹¶æ¢å¤å‘¢</strong></p><blockquote><p>å½“æˆ‘ä»¬æäº¤çš„ä»»åŠ¡è¢«åˆ’åˆ†çš„çº¿ç¨‹æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ˆä»»åŠ¡çš„æäº¤å’Œå®é™…æ‰§è¡Œä¸­é—´å­˜åœ¨æ—¶é—´å·®ï¼Œå¦‚æœè¿™ä¸ªæ—¶é—´æ®µå‡ºç°äº†ä¸Šä¸‹æ–‡çš„æ›´æ–°ï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–å°†å¯¼è‡´æœ¬æ¬¡æ›´æ–°ä¸¢å¤±ï¼‰ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿è¯åœ¨ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™æ˜¯å½“æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œå®Œæ¯•åéœ€è¦è¿˜åŸ</p></blockquote><ol type="1"><li>è·å–å½“å‰çº¿ç¨‹ï¼Œä¸Šçº¿æ–‡å¿«ç…§</li><li>å¦‚æœå½“å‰çº¿ç¨‹æœ‰å¿«ç…§é‡Œé¢ä¸å­˜åœ¨çš„ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆå…ˆæ¸…é™¤æ‰</li><li>å°†åˆ›å»ºTtlRunnableæ—¶ä¿å­˜çš„å¿«ç…§è®¾ç½®åˆ°å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼ˆå®ç°<code>ThreadLocal</code> ä¼ é€’çš„æ ¸å¿ƒï¼‰</li><li><code>doExecuteCallback</code> æ‰§è¡Œé’©å­æ–¹æ³•</li><li>è¿”å›ä¿å­˜çš„å‰¯æœ¬</li></ol><h3 id="restore">restore</h3><p>æ ¹æ® replay æ—¶ç”Ÿæˆçš„å‰¯æœ¬å¯¹ä¸Šä¸‹æ–‡ç¯å¢ƒè¿›è¡Œæ¢å¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">restore</span><span class="params">(<span class="meta">@NonNull</span> Object backup)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Snapshot</span> <span class="variable">backupSnapshot</span> <span class="operator">=</span> (Snapshot) backup;</span><br><span class="line">    restoreTtlValues(backupSnapshot.ttl2Value);</span><br><span class="line">    restoreThreadLocalValues(backupSnapshot.threadLocal2Value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">restoreTtlValues</span><span class="params">(<span class="meta">@NonNull</span> HashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; backup)</span> &#123;</span><br><span class="line">    <span class="comment">// call afterExecute callback</span></span><br><span class="line">    doExecuteCallback(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> Iterator&lt;TransmittableThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); iterator.hasNext(); ) &#123;</span><br><span class="line">        TransmittableThreadLocal&lt;Object&gt; threadLocal = iterator.next();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clear the TTL values that is not in backup</span></span><br><span class="line">        <span class="comment">// avoid the extra TTL values after restore</span></span><br><span class="line">        <span class="keyword">if</span> (!backup.containsKey(threadLocal)) &#123;</span><br><span class="line">            iterator.remove();</span><br><span class="line">            threadLocal.superRemove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// restore TTL values</span></span><br><span class="line">    setTtlValuesTo(backup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‰¯æœ¬æ¢å¤å½“å‰çº¿ç¨‹çš„ <code>ThreadLocal</code></p><h3 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h3><p>å¯¹çº¿ç¨‹æ± çš„è£…é¥°å®ç°å’Œ <code>Runnable</code> ä¸€è‡´ï¼Œå°†çœŸæ­£çš„çº¿ç¨‹æ± åŒ…è£…åœ¨Wrapper å¯¹è±¡ä¸­</p><p>æ ¹æ®çº¿ç¨‹æ± å®ç°çš„ä¸åŒï¼Œæœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>getTtlExecutorï¼šè¿”å› <code>Executor</code></li><li>getTtlExecutorServiceï¼šè¿”å› <code>ExecutorService</code></li><li>getTtlScheduledExecutorServiceï¼šè¿”å›<code>ScheduledExecutorService</code></li></ul><p>ä»¥ <code>getTtlExecutor</code> ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title function_">getTtlExecutor</span><span class="params">(<span class="meta">@Nullable</span> Executor executor)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ TtlAgent åŠ è½½ã€æˆ–è€…æ˜¯ TtlEnhancedï¼Œé¿å…é‡å¤è£…é¥°</span></span><br><span class="line">    <span class="keyword">if</span> (TtlAgent.isTtlAgentLoaded() || executor == <span class="literal">null</span> || executor <span class="keyword">instanceof</span> TtlEnhanced) &#123;</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ExecutorTtlWrapper</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExecutorTtlWrapper</span>(executor, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutorTtlWrapper</span> <span class="keyword">implements</span> <span class="title class_">Executor</span>, TtlWrapper&lt;Executor&gt;, TtlEnhanced &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor executor;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> idempotent;</span><br><span class="line"></span><br><span class="line">    ExecutorTtlWrapper(<span class="meta">@NonNull</span> Executor executor, <span class="type">boolean</span> idempotent) &#123;</span><br><span class="line">        <span class="built_in">this</span>.executor = executor;</span><br><span class="line">        <span class="built_in">this</span>.idempotent = idempotent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸®å¿™è°ƒç”¨äº† TtlRunnable.get</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(<span class="meta">@NonNull</span> Runnable command)</span> &#123;</span><br><span class="line">        executor.execute(TtlRunnable.get(command, <span class="literal">false</span>, idempotent));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ¬è´¨ä¸Šå°±æ˜¯åŒ…è£…ä¸º <code>ExecutorTtlWrapper</code>åé‡å†™äº†æäº¤ä»»åŠ¡ç­‰æ–¹æ³•ï¼Œå®ç°å†…ä¸»åŠ¨å»è°ƒç”¨äº†è£…é¥°æ–¹æ³•</p><h2 id="å›¾ç¤º">å›¾ç¤º</h2><p>ä¸ªäººè®¤ä¸º <code>Transmittable</code> æ ¸å¿ƒçš„æ€æƒ³ï¼š</p><ul><li>ä¸åŒ <code>ThreadLocal</code>ä¹‹é—´çš„å…³ç³»ï¼Œä¿å­˜ã€èµ‹å€¼ã€æ¢å¤ç­‰æ“ä½œçš„æµç¨‹</li><li>å¹¶å‘åœºæ™¯ä¸‹çš„å®ç°ï¼Œä½¿ç”¨åŸå­ç±»ã€å‰¯æœ¬çš„ä¿å­˜å’Œæ¢å¤ç­‰</li></ul><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/%E6%97%B6%E5%BA%8F%E5%9B%BE.png" class="" title="æ—¶åºå›¾"><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/TransmittableThreadLocal%20%E6%BA%90%E7%A0%81%20&%20%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/ThrealLocal%20%E6%93%8D%E4%BD%9C.webp" class="" title="ThrealLocal æ“ä½œ"><h2 id="æ‰©å±•-ttl">æ‰©å±• TTL</h2><p>ä¸Šé¢æåˆ° <code>InheritableThreadLocal</code>æ²¡æœ‰æä¾›æ‹·è´ç›¸å…³çš„èƒ½åŠ›ï¼ŒTTL ä¹Ÿè¿›è¡Œäº†æ”¯æŒ</p><p><code>SuppliedTransmittableThreadLocal</code> ç»§æ‰¿äº†<code>TransmittableThreadLocal</code>ï¼Œæä¾›äº†ä¼ å‚ <code>Supplier</code>å’Œ <code>TtlCopier</code> æ¥è¿›è¡Œåˆå§‹å€¼ã€ç»§æ‰¿å€¼æ‹·è´ã€ä¼ é€’å€¼æ‹·è´çš„è®¾ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SuppliedTransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// initialValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Supplier&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; supplier;</span><br><span class="line">    <span class="comment">// childValue InheritableThreadLocal</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TtlCopier&lt;T&gt; copierForChildValue;</span><br><span class="line">    <span class="comment">// copy</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TtlCopier&lt;T&gt; copierForCopy;</span><br><span class="line"></span><br><span class="line">    SuppliedTransmittableThreadLocal(Supplier&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; supplier, TtlCopier&lt;T&gt; copierForChildValue, TtlCopier&lt;T&gt; copierForCopy) &#123;</span><br><span class="line">        <span class="keyword">if</span> (supplier == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;supplier is null&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.supplier = supplier;</span><br><span class="line">        <span class="built_in">this</span>.copierForChildValue = copierForChildValue;</span><br><span class="line">        <span class="built_in">this</span>.copierForCopy = copierForCopy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> supplier.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">childValue</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (copierForChildValue != <span class="literal">null</span>) <span class="keyword">return</span> copierForChildValue.copy(parentValue);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="built_in">super</span>.childValue(parentValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">copy</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (copierForCopy != <span class="literal">null</span>) <span class="keyword">return</span> copierForCopy.copy(parentValue);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="built_in">super</span>.copy(parentValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡é™æ€æ–¹æ³•<code>withInitial</code>ã€<code>withInitialAndCopier</code> è¿›è¡Œåˆ›å»º</p><p><strong>ç®€å•ä½¿ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Student&gt; THREAD_LOCAL = </span><br><span class="line">        TransmittableThreadLocal.withInitialAndCopier(</span><br><span class="line">        () -&gt; <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;é»˜è®¤&quot;</span>, <span class="number">0</span>), </span><br><span class="line">        value -&gt; <span class="keyword">new</span> <span class="title class_">Student</span>(value.name + <span class="string">&quot; Inherit&quot;</span>, value.age),</span><br><span class="line">        value -&gt; <span class="keyword">new</span> <span class="title class_">Student</span>(value.name + <span class="string">&quot; Transmit&quot;</span>, value.age)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è£…é¥°çº¿ç¨‹æ±  ExecutorService</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">EXECUTOR</span> <span class="operator">=</span></span><br><span class="line">        TtlExecutors.getTtlExecutorService(Executors.newSingleThreadExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è®¾ç½®å‰ï¼š&quot;</span> + THREAD_LOCAL.get());</span><br><span class="line"></span><br><span class="line">        THREAD_LOCAL.set(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è®¾ç½®åï¼š&quot;</span> + THREAD_LOCAL.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–°çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> THREAD_LOCAL.get();</span><br><span class="line">            System.out.println(<span class="string">&quot;æ–°çº¿ç¨‹ï¼š&quot;</span> + student);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°</span></span><br><span class="line">        THREAD_LOCAL.set(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰2&quot;</span>, <span class="number">21</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹ä¿®æ”¹ï¼š&quot;</span> + THREAD_LOCAL.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± </span></span><br><span class="line">        EXECUTOR.execute(() -&gt; &#123;</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> THREAD_LOCAL.get();</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹æ± ï¼š&quot;</span> + student);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä¸»çº¿ç¨‹è®¾ç½®å‰ï¼šThreadLocalTest.Student(name=é»˜è®¤, age=<span class="number">0</span>)</span><br><span class="line">ä¸»çº¿ç¨‹è®¾ç½®åï¼šThreadLocalTest.Student(name=å¼ ä¸‰, age=<span class="number">20</span>)</span><br><span class="line">ä¸»çº¿ç¨‹ä¿®æ”¹ï¼šThreadLocalTest.Student(name=å¼ ä¸‰<span class="number">2</span>, age=<span class="number">21</span>)</span><br><span class="line">æ–°çº¿ç¨‹ï¼šThreadLocalTest.Student(name=å¼ ä¸‰ Inherit, age=<span class="number">20</span>)</span><br><span class="line">çº¿ç¨‹æ± ï¼šThreadLocalTest.Student(name=å¼ ä¸‰<span class="number">2</span> Transmit, age=<span class="number">21</span>)</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://github.com/alibaba/transmittable-thread-local/tree/2.x">alibaba/transmittable-thread-localat 2.x (github.com)</a></p><p><ahref="https://www.jianshu.com/p/f92721fb0e29">TransmittableThreadLocalæºç åˆ†æ- ç®€ä¹¦ (jianshu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>REST VS gRPC</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/REST%20VS%20gRPC.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/REST%20VS%20gRPC.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´ï¼ŒREST éƒ½æ˜¯ä¸€ç§ä¸”å”¯ä¸€ä¸€ç§æ„å»º API çš„â€œæ ‡å‡†â€ï¼›å®ƒåœ¨æŸç§ç¨‹åº¦ä¸Šå–ä»£äº† SOAPï¼Œåè€…æ˜¯ä¸€ä¸ª â€œå¤ªå¤š XMLâ€çš„ä¸‘é™‹çƒ‚æ‘Šå­</p><p>ä½†æ˜¯è¿‘äº›å¹´æ–°çš„é€‰æ‹©å‡ºç°äº†ï¼Œ2015 å¹´ï¼ŒFacebook å‘å…¬ä¼—å‘å¸ƒäº†GraphQLï¼Œ2016 å¹´è°·æ­Œç´§éšå…¶åå‘å¸ƒäº† gRPC</p><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨ä»ç„¶è¢«å¹¿æ³›ä½¿ç”¨çš„åè€…ï¼Œå¹¶å°†å…¶ä¸ REST è¿›è¡Œæ¯”è¾ƒ</p><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>ä¸‹è¡¨å°†æ¦‚è¿°æ‰€è®¨è®ºçš„è¦ç‚¹ï¼Œå¹¶æ˜¾ç¤º REST å’Œ gRPC çš„äº®ç‚¹</p><table><colgroup><col style="width: 21%" /><col style="width: 23%" /><col style="width: 55%" /></colgroup><thead><tr class="header"><th style="text-align: center;">Toic</th><th style="text-align: center;">REST</th><th style="text-align: center;">gRPC</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><strong>Standardization</strong></td><td style="text-align: center;">æ— æ ‡å‡†</td><td style="text-align: center;">å®šä¹‰å®Œå–„</td></tr><tr class="even"><td style="text-align: center;"><strong>Paradigm</strong></td><td style="text-align: center;">åŸºäºèµ„æº</td><td style="text-align: center;">RPC</td></tr><tr class="odd"><td style="text-align: center;"><strong>Service modes</strong></td><td style="text-align: center;">åªæœ‰ unary</td><td style="text-align: center;">Unary, client streaming, serverstreaming å’Œ bidirectional streaming</td></tr><tr class="even"><td style="text-align: center;"><strong>Requirements</strong></td><td style="text-align: center;">å„ç§ HTTP ç‰ˆæœ¬ï¼ŒJSON è§£æ</td><td style="text-align: center;">HTTP/2, ä¾èµ–è¯­è¨€å®ç°</td></tr><tr class="odd"><td style="text-align: center;"><strong>API design</strong></td><td style="text-align: center;">ä»£ç ç¬¬ä¸€</td><td style="text-align: center;">è®¾è®¡ç¬¬ä¸€</td></tr><tr class="even"><td style="text-align: center;"><strong>Default dataformat</strong></td><td style="text-align: center;">JSON</td><td style="text-align: center;">Protobuf</td></tr><tr class="odd"><td style="text-align: center;"><strong>Web browsersupport</strong></td><td style="text-align: center;">åŸç”Ÿ</td><td style="text-align: center;">gRPC web, via workarounds</td></tr><tr class="even"><td style="text-align: center;"><strong>Tools</strong></td><td style="text-align: center;">æ›´æˆç†Ÿ</td><tdstyle="text-align: center;">è¯­è¨€æ”¯æŒå„ä¸ç›¸åŒï¼Œæœ‰äº›å…·æœ‰å‡ºè‰²çš„å®ç°</td></tr></tbody></table><h1 id="æ ‡å‡†åŒ–">æ ‡å‡†åŒ–</h1><p>REST å…¶ä¸­ä¹‹ä¸€çš„ç¼ºç‚¹å°±æ˜¯ç¼ºä¹æ ‡å‡†åŒ–ï¼Œå› ä¸º REST ä¸å…¶è¯´æ˜¯ APIæ ‡å‡†ï¼ˆstandardï¼‰ï¼Œä¸å¦‚è¯´æ˜¯ä¸€ç§èŒƒå¼ï¼ˆparadigmï¼‰ï¼Œè®¸å¤šäººåœ¨è°ˆè®ºå®ƒæ—¶éƒ½æœ‰ä¸åŒçš„å«ä¹‰</p><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‰€è°“çš„ â€œREST APIâ€ æ›´å€¾å‘äºåŸºäº HTTP åè®®å’Œ JSON æ ¼å¼çš„APIï¼Œä½†æ˜¯ä½¿ç”¨ XML ä»£æ›¿ JSON ä»ç„¶ä¼šä½¿ API ç¬¦åˆ RESTfulè§„èŒƒï¼Œå°½ç®¡è¿™ç§æ–¹å¼æ²¡æœ‰è¢«å¹¿æ³›ä½¿ç”¨ï¼›REST è¿™ä¸ªæœ¯è¯­ç”šè‡³ä¸ HTTP æ— å…³ï¼Œåœ¨ä½¿ç”¨REST API æ—¶ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å¾ˆå¤šæ··ä¹±ï¼Œä¾‹å¦‚ä½¿ç”¨è€…å¯èƒ½ä¼šè‡ªåŠ¨æœŸæœ›æŸäº› REST APIç«¯ç‚¹çš„å¹‚ç­‰æ€§æˆ–ç¼“å­˜æ€§ï¼Œå³ä½¿æ²¡æœ‰æ˜ç¡®å®šä¹‰</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼ŒgRPC å®šä¹‰å®Œå–„ï¼›ä¾‹å¦‚ï¼Œ <ahref="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md">gRPCimplementation over HTTP/2</a> éå¸¸è¯¦ç»†</p><h1 id="åŸºæœ¬åŒºåˆ«">åŸºæœ¬åŒºåˆ«</h1><p>REST å’Œ gRPC çš„è§„èŒƒæ˜¯ä¸åŒçš„</p><p>RESTä¸­ä¸€åˆ‡éƒ½ä»¥èµ„æºä¸ºä¸­å¿ƒï¼Œè¿™äº›èµ„æºå¯ä»¥è¢«æ£€ç´¢å’Œæ“ä½œï¼›å¦‚æœæˆ‘ä»¬ä»¥ä¸€æœ¬ä¹¦ä½œä¸ºç¤ºä¾‹èµ„æºï¼ŒRESTAPI é€šå¸¸ä¼šæä¾›ä»¥ä¸‹æ¥å£ï¼š</p><ul><li><code>GET /books</code>è·å–æ‰€æœ‰ä¹¦ç±ï¼Œå¯èƒ½å¸¦æœ‰ç”¨äºç­›é€‰é¡¹å’Œåˆ†é¡µç›¸å…³å‚æ•°</li><li><code>GET /books/&#123;id&#125;</code> è·å–ç‰¹å®šçš„ä¹¦</li><li><code>POST /books</code> åˆ›å»ºä¸€æœ¬ä¹¦</li><li><code>DELETE /books/&#123;id&#125;</code> åˆ é™¤ä¸€æœ¬ä¹¦</li></ul><p>å¤§å¤šæ•°åŸºäº HTTP çš„ REST APIéƒ½éµå¾ªè¿™ç§æ¨¡å¼ï¼Œè™½ç„¶æ•ˆæœä¸é”™ï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨éš¾ä»¥ç”¨è¿™æ ·çš„è§„èŒƒè¡¨è¾¾çš„æƒ…å†µ</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘æƒ³åˆ›å»ºå¤šæœ¬ä¹¦ï¼Œè€Œä¸æƒ³ä¸ºæ¯æœ¬ä¹¦é‡å¤è°ƒç”¨<code>POST/books</code>ï¼ˆå‡ºäºæ€§èƒ½ã€å¹‚ç­‰æ€§æˆ–å…¶ä»–åŸå› ï¼‰ï¼Œè¯¥å¦‚ä½•å¤„ç†ï¼›æˆ‘æ˜¯å¦åº”è¯¥å®šä¹‰<code>POST/books/batch</code> æ¥å£ï¼Œè¿™ä»ç„¶ç¬¦åˆ RESTfulå—ï¼Ÿè™½ç„¶åœ¨æŠ€æœ¯ä¸Šå¾ˆå®¹æ˜“è§£å†³ï¼Œä½†å¼€å‘äººå‘˜ä¹‹é—´ç»å¸¸ä¼šå› ä¸ºå­˜åœ¨äº‰è®®è€Œè¿›è¡Œè®¨è®º</p><p>è€Œ gRPC æ˜¯ä¸€ä¸ªRPCæ¡†æ¶ã€‚å®ƒä»¥æœåŠ¡æ–¹æ³•ä¸ºä¸­å¿ƒï¼›å¦‚æœæˆ‘ä»¬ä»¥å›¾ä¹¦ APIä¸ºä¾‹ï¼Œä½¿ç”¨ gRPCï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»º <code>BookService</code></p><ul><li><code>GetBooks()</code></li><li><code>GetBook()</code></li><li><code>CreateBook()</code></li><li><code>DeleteBook()</code></li></ul><p>å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°å‘½åè¿™äº›æ–¹æ³•ï¼Œå¹¶éœ€è¦æˆ‘ä»¬éœ€è¦çš„ä»»ä½•å‚æ•°ï¼›å¦‚æœæˆ‘ä»¬ç°åœ¨æƒ³æ·»åŠ ä¸€ä¸ªæ–¹æ³•æ¥åˆ›å»ºå¤šæœ¬ä¹¦ï¼Œæ²¡æœ‰ä»€ä¹ˆèƒ½é˜»æ­¢æˆ‘ä»¬æ·»åŠ <code>CreateBooks()</code> æ–¹æ³•</p><p>gRPC åœ¨è®¾è®¡ API æ—¶æä¾›äº†æ›´å¤šçš„â€œè‡ªç”±â€ï¼Œå› ä¸ºæœ‰æ›´å°‘çš„ï¼ˆè‡ªæˆ‘å¼ºåŠ çš„ï¼‰é™åˆ¶</p><h2 id="æœåŠ¡æ¨¡å¼">æœåŠ¡æ¨¡å¼</h2><p>gRPC æ”¯æŒå››ç§æœåŠ¡æ–¹å¼ï¼š</p><ul><li><strong>Unaryï¼š</strong>å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œæ¥å—ä¸€ä¸ªå“åº”</li><li><strong>Server steamingï¼š</strong>å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œæ¥æ”¶å¤šä¸ªå“åº”</li><li><strong>Client streamingï¼š</strong>å‘é€å¤šä¸ªè¯·æ±‚ï¼Œæ¥æ”¶ä¸€ä¸ªå“åº”</li><li><strong>Bidirectionalstreamingï¼š</strong>å‘é€å¤šä¸ªè¯·æ±‚ï¼Œæ¥æ”¶å¤šä¸ªå“åº”</li></ul><p>è¿™æ˜¯ gRPC ç›¸æ¯”åªæ”¯æŒ Unary æ–¹å¼çš„ REST éå¸¸å¥½çš„ä¼˜åŠ¿ï¼Œåœ¨ REST APIä¸­æ”¯æŒå…¶ä»–æœåŠ¡æ¨¡å¼éœ€è¦ä½¿ç”¨ä¸åŒçš„åè®®ï¼Œä¾‹å¦‚ server-sent events æˆ–websocketï¼Œè¿™å¹¶ä¸æ˜¯éå¸¸ â€œRESTfulâ€</p><h2 id="ä¾èµ–">ä¾èµ–</h2><p>REST API ç»å¸¸åªå·¥ä½œåœ¨å„ç§ HTTP ç‰ˆæœ¬ä¹‹ä¸Šï¼Œåªè¦ç¼–ç¨‹è¯­è¨€æœ‰ HTTP å®¢æˆ·ç«¯å’ŒJSON è§£æå™¨ï¼Œå¤„ç† REST çš„ API æ˜¯è½»è€Œæ˜“ä¸¾çš„</p><p>gRPC æ˜ç¡®éœ€è¦ HTTP/2åè®®çš„æ”¯æŒï¼›è¿‘äº›å¹´è¿™ç§é—®é¢˜è¶Šæ¥è¶Šå°‘ï¼Œå› ä¸ºå¤§å¤šæ•°ä»£ç†å’Œæ¡†æ¶éƒ½å¢åŠ äº†å¯¹HTTP/2 çš„æ”¯æŒï¼›ä¸è¿‡éœ€è¦æ³¨æ„ï¼Œç”±äº gRPCéœ€è¦ç”Ÿæˆä»£ç ï¼ˆç”¨äºåˆ›å»ºå®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å­˜æ ¹ï¼‰ï¼Œå› æ­¤å¹¶ä¸æ˜¯æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½æ”¯æŒ</p><h1 id="api-è®¾è®¡">API è®¾è®¡</h1><p>REST API é€šå¸¸æ˜¯å…¶å®ç°çš„ç»“æœï¼Œç§°ä¸ºâ€œä»£ç ä¼˜å…ˆï¼ˆcode-firstï¼‰â€ï¼›è™½ç„¶å¯ä»¥å…ˆç”¨ OpenAPIè¿›è¡Œè®¾è®¡ï¼Œç„¶åç”ŸæˆæœåŠ¡å™¨å­˜æ ¹ï¼Œä½†è¿™å¹¶ä¸æ˜¯è®¸å¤šå¼€å‘äººå‘˜é‡‡ç”¨çš„æ–¹æ³•ï¼›å¦‚æœæœ‰ä¸€ä¸ªOpenAPI å®šä¹‰ï¼Œé‚£ä¹ˆ OpenAPI å®šä¹‰å¾ˆå¯èƒ½æ˜¯ä» API å®ç°ç”Ÿæˆçš„ï¼›å› æ­¤ APIå®šä¹‰ä¸å®ç°ç´§å¯†è€¦åˆï¼Œé”™è¯¯åœ°æ›´æ”¹æ¨¡å‹å¯èƒ½ä¼šå¯¼è‡´æ— æ„ä¸­ç ´å API</p><p>gRPC ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ï¼Œåœ¨å®ç° API ä¹‹å‰å¿…é¡»å®šä¹‰ APIï¼Œç§°ä¸ºâ€œè®¾è®¡ä¼˜å…ˆï¼ˆdesign-firstï¼‰â€ï¼Œç„¶åæ ¹æ®è¿™ä¸ª APIå®šä¹‰ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å­˜æ ¹ï¼Œè¿™éœ€è¦æå‰è¿›è¡Œï¼Œå› ä¸ºä¸èƒ½ç›´æ¥å®ç° API</p><p>è¿™ä¸¤ç§æ–¹æ³•å„æœ‰åˆ©å¼Šã€‚é€šå¸¸çš„ REST APIæ–¹æ³•å…è®¸æ›´å¿«çš„è¿­ä»£ï¼Œå› ä¸ºæœåŠ¡å™¨å§‹ç»ˆæ˜¯çœŸå®æ¥å£çš„æ¥æºï¼›è€Œä½¿ç”¨gRPCï¼Œéœ€è¦åœ¨è°ƒæ•´å®ç°ä¹‹å‰é¦–å…ˆæ›´æ”¹ APIçš„å®šä¹‰å¯èƒ½ä¼šæ¯”è¾ƒçƒ¦äººï¼Œä½†æ˜¯å®ƒé€šè¿‡æ˜¾å¼å®šä¹‰ API å¸¦æ¥äº†ä¸€äº›å®‰å…¨ä¼˜ç‚¹</p><h1 id="æ•°æ®æ ¼å¼">æ•°æ®æ ¼å¼</h1><p>REST å’Œ gRPC éƒ½ä¼šä½¿ç”¨ä¸åŒçš„æ ¼å¼æ¥è¿›è¡Œæ•°æ®ä¼ è¾“ï¼›å¤§éƒ¨åˆ† REST API ä½¿ç”¨JSONï¼ŒgRPC åˆ™ä¼šé»˜è®¤ä½¿ç”¨ <a href="https://protobuf.dev/">ProtocolBuffers</a>ï¼ˆProtobufï¼‰ï¼Œè®©æˆ‘ä»¬æ¥æ¯”è¾ƒè¿™ä¸¤è€…</p><p>JSONå¯¹æ•°æ®ç±»å‹çš„æ”¯æŒæœ‰é™ï¼Œä¹Ÿæœ‰ä¸€äº›æ€ªç™–ï¼ˆä¾‹å¦‚å¤§æ•°å­—éœ€è¦è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²ï¼‰ï¼›å®ƒæ˜¯ä¸€ç§æ–‡æœ¬æ ¼å¼ï¼Œä¾¿äºé˜…è¯»ï¼›å­—æ®µåæ˜¯åºåˆ—åŒ–çš„ï¼Œè¿™ä¼šå ç”¨ä¸€äº›ç©ºé—´ï¼Œåœ¨ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­éœ€è¦ä½¿ç”¨åå°„æ¥ååºåˆ—åŒ–JSON æ ¼å¼çš„æ•°æ®ï¼Œä¼šæ¯”è¾ƒæ…¢</p><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒgRPC API çš„æ¶ˆæ¯ç±»å‹é¦–å…ˆè¢«å®šä¹‰ä¸º ProtocolBuffersï¼›å¯¹äºå—æ”¯æŒçš„ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼ˆåï¼‰åºåˆ—åŒ–æ¶ˆæ¯çš„ä»£ç ï¼›å¹¶ä¸”ç”±äºå®ƒæ˜¯ä¸€ç§äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¸éœ€è¦åºåˆ—åŒ–å­—æ®µåï¼Œå› æ­¤å®ƒä½¿ç”¨çš„ç©ºé—´æ¯”ç­‰æ•ˆçš„JSON æ¶ˆæ¯æ›´å°‘ï¼›å½“ç„¶ç¼ºç‚¹æ˜¯ä¸å†å…·å¤‡äººç±»å¯è¯»æ€§ï¼Œéœ€è¦ Protobufå®šä¹‰æ¥ååºåˆ—åŒ–æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šå¯¹å¼€å‘äººå‘˜é€ æˆä¸€äº›é˜»ç¢</p><p>ä¸‹é¢çš„ JSON ç¤ºä¾‹å°†å ç”¨å¤§çº¦ 66 ä¸ªå­—èŠ‚ï¼ˆå»æ‰ç©ºæ ¼ï¼‰</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persons&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Max&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">23</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mike&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">52</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç­‰æ•ˆçš„åºåˆ—åŒ– protobuf ä¿¡æ¯ä»…ä½¿ç”¨ 19 ä¸ªå­—èŠ‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>x0A070A034D617810170A080A04486<span class="number">16E731034</span></span><br></pre></td></tr></table></figure><h2 id="å¤§å‹æ•°æ®">å¤§å‹æ•°æ®</h2><p>Protobuf è®¾è®¡ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–å†…å­˜ä¸­çš„æ•°æ®ï¼Œå› æ­¤ä¸å»ºè®®ä½¿ç”¨Protobuf / gRPC ä¼ è¾“å¤§å‹æ•°æ®ï¼›å¤§å¤šæ•° gRPC å®ç°å¯¹å•ä¸ªæ¶ˆæ¯çš„é»˜è®¤é™åˆ¶ä¸º4MB</p><p>ä½¿ç”¨ REST APIå¤„ç†å¤§æ•°æ®é‡ï¼ˆä¾‹å¦‚æ–‡ä»¶ä¸Šä¼ ï¼‰æ˜¯ç›¸å½“ç›´æ¥çš„ï¼Œæ¥æ”¶åˆ°çš„æ–‡ä»¶å¯ä»¥è¢«è§†ä¸ºæµï¼Œåªéœ€ä½¿ç”¨å¾ˆå°‘çš„å†…å­˜</p><p>è¿™åœ¨ gRPCä¸­å¹¶éä¸å¯èƒ½ï¼Œä½†éœ€è¦æ›´å¤šçš„æ‰‹åŠ¨æ“ä½œï¼šæ–‡ä»¶å¿…é¡»åœ¨å‘é€æ–¹åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œç„¶åæ¯ä¸ªå—å°†ä½œä¸ºå•ç‹¬çš„æ•°æ®é€šè¿‡å®¢æˆ·ç«¯æµä¼ è¾“æ–¹æ³•å‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ¥æ”¶æ¯ä¸ªå—ï¼Œå¹¶å¯ä»¥ä»ä¸­æ„é€ æ•°æ®æµï¼Œä»è€Œäº§ç”Ÿä¸REST API ç±»ä¼¼çš„è¡Œä¸ºï¼Œå°½ç®¡éœ€è¦ä»˜å‡ºæ›´å¤šåŠªåŠ›</p><h1 id="æµè§ˆå™¨å…¼å®¹æ€§">æµè§ˆå™¨å…¼å®¹æ€§</h1><p>è¿™å°±æ˜¯ REST çœŸæ­£çš„é—ªå…‰ç‚¹ï¼Œå®ƒç”± Web æµè§ˆå™¨å¤©ç„¶æ”¯æŒï¼Œå› æ­¤å¯ä»¥è½»æ¾åœ°ä½¿ç”¨Web åº”ç”¨ç¨‹åºä¸­çš„ REST API</p><p>gRPC ä¸ç›´æ¥ç”±æµè§ˆå™¨æ”¯æŒï¼Œå› ä¸ºå®ƒéœ€è¦æ˜ç¡®çš„ HTTP/2 æ”¯æŒå’Œè®¿é—®æŸäº›HTTP/2 åŠŸèƒ½ï¼Œè€Œ web æµè§ˆå™¨ä¸æä¾›è¿™äº›åŠŸèƒ½</p><p>gRPC Web å¯ä»¥ä½œä¸ºä¸€ç§å˜é€šæ–¹å¼ï¼›è¿™æ˜¯ gRPC åè®®çš„ä¸€ä¸ªå¾®å°å˜åŒ–ï¼Œä½¿å…¶å¯ä¾›web æµè§ˆå™¨ä½¿ç”¨</p><p>å¯¹äºæŸäº›ç¼–ç¨‹è¯­è¨€ï¼Œæ¡†æ¶ä¸­å·²ç»åŒ…å«äº† gRPC Webæ”¯æŒï¼›è€Œå¯¹äºä¸æ”¯æŒçš„è¯­è¨€ï¼Œéœ€è¦ä¸€ä¸ªä»£ç†æ¥å°† gRPC è¯·æ±‚è½¬æ¢ä¸º gRPC Webè¯·æ±‚ï¼Œåä¹‹äº¦ç„¶</p><p>ä¸ä¸éœ€è¦ç‰¹æ®Šä¾èµ–çš„ REST API ç›¸æ¯”ï¼ŒgRPC API åœ¨ä» Webä¸Šä½¿ç”¨æ—¶æ›´éº»çƒ¦</p><h1 id="å·¥å…·">å·¥å…·</h1><p>gRPC å’Œ REST å·¥å…·åœ¨ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ä¹‹é—´å·®å¼‚å¾ˆå¤§ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒgRPCæ„Ÿè§‰æ›´ â€œåŸç”Ÿï¼ˆnativeï¼‰â€ï¼Œè€Œåœ¨å¦ä¸€äº›æƒ…å†µä¸‹ï¼ŒREST å·¥å…·åˆ™æ›´é«˜çº§</p><p>å¯¹ gRPCè€Œè¨€é€‚å½“è¯­è¨€æ”¯æŒæ›´ä¸ºé‡è¦ï¼Œå› ä¸ºå®ƒéœ€è¦å·¥å…·æ¥ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å­˜æ ¹ï¼ˆstubsï¼‰ï¼›å¯¹äºä¸å—æ”¯æŒçš„ç¼–ç¨‹è¯­è¨€åˆ™å°±ä¸é‚£ä¹ˆå¹¸è¿äº†</p><p>REST API çš„å®¢æˆ·ç«¯æ€»æ˜¯å¯ä»¥æ‰‹åŠ¨åˆ›å»ºçš„ï¼Œè™½ç„¶å¯èƒ½éœ€è¦ä¸€äº›åŠªåŠ›ï¼›å­˜åœ¨ä»Open API å®šä¹‰åˆ›å»º REST å®¢æˆ·ç«¯çš„å·¥å…·ï¼Œä½†ä¸ gRPCç›¸æ¯”ï¼Œå¯¹å¼€å‘äººå‘˜çš„ç»éªŒè¦æ±‚æ›´å°‘</p><p>ç”±äº REST API å­˜åœ¨çš„æ—¶é—´è¦é•¿å¾—å¤šï¼Œå› æ­¤å­˜åœ¨æ›´å¤šæœ‰åŠ©äºæ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²REST API çš„å·¥å…·ï¼›å®ƒä»¬çš„åŠŸèƒ½é€šå¸¸æ¯” gRPC å·¥å…·æ›´é«˜çº§</p><p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ„å»º Kreya çš„ä¸»è¦åŸå› ä¹‹ä¸€ï¼Œå®ƒè¯•å›¾æˆä¸ºæœ€å¥½çš„ gRPC GUIå®¢æˆ·ç«¯ï¼ˆåŒæ—¶ä¹Ÿæ”¯æŒ RESTï¼‰</p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>REST å’Œ gRPC éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹å’Œç¼ºç‚¹</p><p>ä» Web åº”ç”¨ä¸­å¤„ç† REST API é€šå¸¸æ¥è¯´æ›´ç®€å•ï¼›æ­¤å¤– REST APIä½¿ç”¨æ›´å¹¿æ³›ï¼Œè¿™ä½¿å¾—ä¸€äº›å¼€å‘äººå‘˜ä½¿ç”¨å®ƒæ›´å®¹æ˜“ï¼Œå› ä¸ºä»–ä»¬å¯èƒ½ä¸äº†è§£ gRPC</p><p>åœ¨æˆ‘çœ‹æ¥ï¼ŒgRPCåœ¨æœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„é€šä¿¡ï¼ˆä¾‹å¦‚å¾®æœåŠ¡ä¹‹é—´ï¼‰æ–¹é¢æ— ç–‘å…·æœ‰ä¼˜åŠ¿ï¼Œèƒ½å¤Ÿå…±äº«å‡†ç¡®çš„API å®šä¹‰å¹¶ç”¨å¤šç§ç¼–ç¨‹è¯­è¨€åˆ›å»º API å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„èƒœåˆ©</p><p>å¯¹äº â€œæˆ‘åº”è¯¥ä½¿ç”¨ REST è¿˜æ˜¯ gRPCâ€ çš„é—®é¢˜æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œæœ‰äº› APIå¯èƒ½å…·æœ‰ç‹¬ç‰¹çš„æƒ…å†µï¼ŒgRPC æˆ– RESTå…¶ä¸­ä¸€ä¸ªå¯èƒ½æ›´é€‚åˆï¼Œæˆ–è€…ç¨‹åºå‘˜å¯¹å…¶ä¸­ä¸€è€…çš„ä½¿ç”¨æ›´é¡ºæ‰‹ã€æ›´ç†Ÿç»ƒ</p><p>æ‰€æœ‰è¿™äº›éƒ½æ˜¯ç†ç”±ï¼Œæ‰€ä»¥æ¯ä¸ªäººéƒ½åº”è¯¥è‡ªå·±å†³å®šä½¿ç”¨å“ªç§æŠ€æœ¯</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p>https://kreya.app/blog/rest-vs-grpc/</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ThreadLocal &amp; Memory Leak</title>
      <link href="/%E5%BC%80%E5%8F%91/Java/ThreadLocal%20&amp;%20Memory%20Leak.html"/>
      <url>/%E5%BC%80%E5%8F%91/Java/ThreadLocal%20&amp;%20Memory%20Leak.html</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h1><p>åœ¨é¡¹ç›®ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>ThreadLocal</code> æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯</p><p>å…¶ä¸­ä¸€èˆ¬ä¼šåœ¨è¿‡æ»¤å™¨/æ‹¦æˆªå™¨çš„å…¥å£å¤„åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶åœ¨æ‰§è¡Œç»“æŸåå¯¹å…¶è¿›è¡Œæ¸…ç†</p><p>è¿™æ ·ä»è¯·æ±‚è¿›æ¥ä¸€ç›´åˆ°è¿”å›ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡çº¿ç¨‹å˜é‡<code>ThreadLocal</code>è·å–ç”¨æˆ·ä¿¡æ¯å³å¯ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½ä»æ•°æ®åº“æŸ¥å‡ºæ¥</p><p>å› ä¸º <code>ThreadLocal</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ<strong>æ‰€ä»¥é€šå¸¸å£°æ˜ä¸ºä¸€ä¸ªé™æ€å•ä¾‹å˜é‡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHolder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadLocal&lt;UserInfo&gt; CURRENT_USER = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserInfo <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CURRENT_USER.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(UserInfo userInfo)</span> &#123;</span><br><span class="line">        CURRENT_USER.set(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        CURRENT_USER.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥åœ¨æ‹¦æˆªå™¨ä¸­é€šè¿‡ <code>set()</code>æ–¹æ³•å­˜å‚¨é‰´æƒæˆåŠŸçš„ç”¨æˆ·æ•°æ®ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘ä¸­é€šè¿‡ <code>get()</code>è·å–ç”¨æˆ·æ•°æ®äº†</p><h1 id="å®ç°åŸç†">å®ç°åŸç†</h1><blockquote><p>This class provides thread-local variables. These variables differfrom their normal counterparts in that each thread that accesses one(via its {<span class="citation" data-cites="code">@code</span> get} or{<span class="citation" data-cites="code">@code</span> set} method) hasits own,independently initialized copy of the variable</p></blockquote><h2 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h2><p><strong>æ„é€ æ–¹æ³•</strong></p><p><code>ThreadLocal</code> ä»…å­˜åœ¨ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadLocal</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¾ç½®å€¼">è®¾ç½®å€¼</h2><p><strong>set()</strong></p><p>ä½¿ç”¨ <code>set()</code> æ–¹æ³•å‘å…¶èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨ <code>Thread.currentThread()</code>è·å–å½“å‰çº¿ç¨‹ï¼›<code>Thread.currentThread()</code> æ˜¯ä¸€ä¸ª native æ–¹æ³•</p><p><strong>ThreadLocalMap</strong></p><p>æ¥ä¸‹æ¥è°ƒç”¨äº† <code>getMap(Thread t)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Get the map associated with a ThreadLocal. Overridden in InheritableThreadLocal.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  t the current thread</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the map</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„æ˜¯çº¿ç¨‹å¯¹è±¡çš„ä¸€ä¸ªçº¿ç¨‹å˜é‡<code>ThreadLocal.ThreadLocalMap threadLocals = null</code>ï¼Œåˆå§‹çš„é»˜è®¤å€¼æ˜¯nullï¼Œè¿”å›åå›åˆ° <code>set()</code></p><p>å½“æ‹¿åˆ°çš„é»˜è®¤å€¼æ˜¯ null æ—¶ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ª map å°†å€¼æ”¾å…¥ map ä¸­ï¼›ä¸ä¸º nullæ—¶å°†å€¼ç›´æ¥æ”¾å…¥ map</p><p><code>ThreadLocalMap</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé™¤æ­¤ä¹‹å¤–åœ¨è¿™é‡Œå¯ä»¥å…ˆè§†ä½œ<code>HashMap</code>ï¼Œä¹Ÿæ˜¯åŸºäºæ•£åˆ—å­˜å‚¨çš„ Map</p><p><strong>createMap()</strong></p><p>å½“ç¬¬ä¸€æ¬¡ä½¿ç”¨ <code>ThreadLocalMap</code> æ—¶ï¼Œéœ€è¦è°ƒç”¨<code>createMap()</code> è¿›è¡Œåˆ›å»º</p><p><code>createMap()</code> å†…è°ƒç”¨äº† <code>ThreadLocalMap</code>çš„æ„é€ æ–¹æ³•ï¼ŒæŠŠè‡ªå·±çº¿ç¨‹å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ äº†è¿›å»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤å»åˆ›å»º <code>Entry</code> æ•°ç»„å¯¹è±¡å’Œé‡ç½®è´Ÿè½½å› å­çš„æ“ä½œï¼Œæœ¬è´¨ä¸Šå°† KVæ ¹æ®çº¿ç¨‹å¯¹è±¡çš„ <code>threadLocalHashCode</code>æ”¾åˆ°äº†ç›¸åº”çš„æ•°ç»„ä½ç½®ä¸Šï¼ŒK å°±æ˜¯çº¿ç¨‹å¯¹è±¡ï¼ŒV æ˜¯ <code>ThreadLocal</code>è¦å­˜å‚¨çš„å€¼</p><p>æ‰€ä»¥éœ€è¦æ³¨æ„ï¼š</p><ul><li><code>ThreadLocalMap</code> ä¸­çš„ K æ˜¯çº¿ç¨‹å¯¹è±¡ï¼ŒV æ˜¯è¦å­˜å‚¨çš„å€¼</li><li>æ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ä½¿ç”¨åŒä¸€ä¸ª <code>ThreadLocalMap</code> å¯¹è±¡ï¼ŒKæ˜¯å„è‡ªçš„çº¿ç¨‹å¯¹è±¡</li></ul><h2 id="å¼±å¼•ç”¨">å¼±å¼•ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">    Object value;</span><br><span class="line"></span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="built_in">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ThreadLocal.ThreadLocalMap</code> å†…å­˜å‚¨çš„æ˜¯<code>Entry[]</code></p><p><code>Entry</code> çš„ key æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œè€Œ value ä¸ºå¼ºå¼•ç”¨</p><h2 id="å–å€¼">å–å€¼</h2><p><strong>get()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> T <span class="title function_">setInitialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> initialValue();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–çš„æ–¹æ³•ï¼Œé¦–å…ˆè·å–å½“å‰çº¿ç¨‹æ‹¥æœ‰çš„<code>ThreadLocalMap</code>ï¼Œç„¶åå°†è‡ªå·±å¯¹è±¡ä½œä¸º K è¿›è¡Œå–å€¼</p><p>å¦‚æœ <code>ThreadLocalMap</code> ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–<code>setInitialValue()</code>ï¼Œåˆå§‹åŒ–ç»“æŸåè¿”å› null</p><p>æ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿ <code>ThreadLocal</code> åé‡å†™<code>initialValue()</code> æ¥è®¾ç½®é»˜è®¤çš„è¿”å›å€¼</p><h2 id="åˆ é™¤å€¼">åˆ é™¤å€¼</h2><p><strong>remove()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">m</span> <span class="operator">=</span> getMap(Thread.currentThread());</span><br><span class="line">    <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">        m.remove(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè·å–çº¿ç¨‹å¯¹è±¡ä¸­ä¿å­˜çš„ <code>ThreadLocalMap</code>ï¼Œå¦‚æœä¸ä¸º nullåˆ™è°ƒç”¨ <code>remove()</code></p><p><strong>ThreadLocalMap çš„ remove()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">         e != <span class="literal">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.get() == key) &#123;</span><br><span class="line">            e.clear();</span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯ä»¥çº¿ç¨‹å¯¹è±¡ä½œä¸º K å¯¹ V è¿›è¡Œåˆ é™¤</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>æ¯”è¾ƒåç›´è§‰çš„æ˜¯ï¼Œæ“ä½œ <code>ThreadLocal</code> å¯¹è±¡ï¼Œä½†æ•°æ®å¹¶ä¸å­˜å‚¨åœ¨<code>ThrealLocal</code>ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨çº¿ç¨‹å¯¹è±¡çš„<code>ThreadLocal.ThreadLocalMap</code> ä¸­</p><ul><li><code>ThreadLocal</code> æ›´åƒæ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨æ¥æ“ä½œ<code>ThreadLocal.ThreadLocalMap</code></li><li><code>ThreadLocal.ThreadLocalMap</code> å†…å­˜å‚¨<code>Entry[]</code>ï¼Œå› ä¸ºä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä½¿ç”¨äº†å¤šä¸ª<code>ThreadLocal</code></li><li><code>ThreadLocal</code> å¯¹è±¡è¢«ä½œä¸º key è¿›è¡Œä½¿ç”¨</li><li><code>ThreadLocal.ThreadLocalMap</code> çš„ keyæ˜¯å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨çš„ç›®çš„æ˜¯ä¸ºäº†ä¾¿äºå¯¹ <code>ThreadLocal</code>å¯¹è±¡æœ¬èº«è¿›è¡Œå›æ”¶</li></ul><h1 id="å†…å­˜æ³„æ¼">å†…å­˜æ³„æ¼</h1><p><code>ThreadLocal</code> æ•´ä¸ªä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºå‡ºå“ªäº›å¯¹è±¡ï¼š</p><ul><li><code>ThreadLocal</code> å¯¹è±¡</li><li><code>ThreadLocal.ThreadLocalMap</code> å¯¹è±¡ï¼Œåœ¨ <code>Thread</code>å¯¹è±¡ä¸­è¢«æŒæœ‰</li><li><code>ThreadLocal.ThreadLocalMap</code> ä¸­çš„ <code>Entry</code>å¯¹è±¡</li><li><code>ThreadLocal.ThreadLocalMap</code> ä¸­çš„ <code>Entry</code>å¯¹è±¡ä¸­çš„ K å’Œ V</li></ul><h2 id="threadlocal">ThreadLocal</h2><p><code>ThreadLocal</code> å¯¹è±¡ä¸€èˆ¬ä¸å­˜åœ¨æ³„æ¼é—®é¢˜ï¼š</p><ul><li><code>ThreadLocal</code> æ˜¯æ“ä½œ<code>ThreadLocal.ThreadLocalMap</code> çš„ keyï¼Œå®ä¾‹åŒ–æ•°é‡ä¸å¤š</li><li><code>Entry</code> å¼±å¼•ç”¨çš„è®¾è®¡å°±æ˜¯ä¸ºäº†åŠæ—¶å›æ”¶<code>ThreadLocal</code> å¯¹è±¡</li></ul><h2 id="threadlocal.threadlocalmap">ThreadLocal.ThreadLocalMap</h2><p>åŸºæœ¬ä¹Ÿä¸ä¼šå­˜åœ¨æ³„æ¼é—®é¢˜ï¼Œè¯¥å¯¹è±¡è¢« <code>Thread</code>å¯¹è±¡æŒæœ‰ï¼Œå¹¶ä¸”åªæ˜¯ä¸€ä¸ª Map ç»“æ„çš„å¼•ç”¨</p><h2 id="entry">Entry</h2><p><code>Entry</code> æœ¬èº«æ˜¯ä¸€ä¸ªå¼•ç”¨å¯¹è±¡ï¼Œå…¶é€šè¿‡<code>ThreadLocal.ThreadLocalMap</code> çš„æ“ä½œæ–¹æ³•è¿›è¡Œé‡Šæ”¾ï¼Œä¾‹å¦‚<code>set</code>ã€<code>remove</code> ä¸­çš„<code>replaceStaleEntry</code>ã€<code>expungeStaleEntry</code> æ–¹æ³•</p><p><code>Entry</code> å¯¹è±¡çš„ key å³ä¸º <code>ThreadLocal</code>å¯¹è±¡ï¼Œä¸Šé¢å·²ç»æåˆ°äº†å› ä¸ºå¼±å¼•ç”¨çš„è®¾è®¡ä¸€èˆ¬ä¼šè¢«åŠæ—¶å›æ”¶</p><p><code>Entry</code> å¯¹è±¡çš„ value ä¸ºå¼ºå¼•ç”¨ï¼Œå®ƒåªä¼šå› ä¸º<code>Entry</code>å¯¹è±¡çš„å›æ”¶è€Œè¢«å›æ”¶ï¼Œè¿™æ˜¯æœ€æœ‰å¯èƒ½å‘ç”Ÿå†…å­˜æ³„æ¼çš„åœ°æ–¹ï¼Œå¯èƒ½å­˜åœ¨ä½œä¸º key çš„<code>ThreadLocal</code> å¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œä½†æ˜¯ value æ— æ³•å›æ”¶çš„æƒ…å†µ</p><p>å½“ç„¶åœ¨è®¾è®¡ä¸­ï¼Œ<code>ThreadLocal.ThreadLocalMap</code>çš„ä¸€äº›æ“ä½œä¼šæ£€æŸ¥æ•´ä¸ªMapï¼ˆ<code>replaceStaleEntry</code>ã€<code>expungeStaleEntry</code>ï¼‰ï¼Œä»è€Œå¯¹key å·²ç»å›æ”¶çš„ <code>Entry</code> è¿›è¡Œé‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼</p><h2 id="æ€»ç»“-1">æ€»ç»“</h2><p>ä¸Šè¿°å¯è§ï¼Œ<code>Entry</code> æ—¶æœ€æœ‰å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼çš„åœ°æ–¹</p><ul><li>æ²¡æœ‰æ‰‹åŠ¨è°ƒç”¨ <code>remove</code> æ–¹æ³•ï¼ŒåŒæ—¶ <code>ThreadLocal</code>æ— è®ºæ˜¯å¦å›æ”¶ï¼Œvalue éƒ½å¯èƒ½åœ¨ä¸€å®šæ—¶é—´å†…ã€æˆ–è€…ä¸€ç›´æ— æ³•è¢«å›æ”¶</li><li>é”™è¯¯åœ°åˆ›å»º <code>Thread</code>å¯¹è±¡ï¼Œè€Œæ²¡æœ‰å¯¹æ—§çš„çº¿ç¨‹å¯¹è±¡è¿›è¡Œå›æ”¶</li><li>è¿™é‡Œæœ‰ä¸€ä¸ª Tomcat æœºåˆ¶ç›¸å…³çš„é—®é¢˜ä»è€Œå¯¼è‡´æ³„æ¼ï¼Œæˆ‘å¹¶æ²¡çœ‹æ‡‚... <ahref="https://stackoverflow.com/questions/17968803/threadlocal-memory-leak">java- ThreadLocal &amp; Memory Leak - Stack Overflow</a></li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://juejin.cn/post/7083332935096467463">ä¸ºä»€ä¹ˆThreadLocalæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ- æ˜é‡‘ (juejin.cn)</a></p><p><ahref="https://blog.csdn.net/weixin_39970883/article/details/126010873">Tomcatçº¿ç¨‹å¤ç”¨ä¸Threadlocalå¼•å‘çš„æƒ¨æ¡ˆ_çº¿ç¨‹å¤ç”¨threadlocal_å°æ²ˆåŒå­¦å‘€çš„åšå®¢-CSDNåšå®¢</a></p><p><ahref="https://stackoverflow.com/questions/17968803/threadlocal-memory-leak">java- ThreadLocal &amp; Memory Leak - Stack Overflow</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java æ³›å‹</title>
      <link href="/%E5%BC%80%E5%8F%91/Java/Java%20%E6%B3%9B%E5%9E%8B.html"/>
      <url>/%E5%BC%80%E5%8F%91/Java/Java%20%E6%B3%9B%E5%9E%8B.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä»‹ç»">ä»‹ç»</h1><h2 id="ä»€ä¹ˆæ˜¯æ³›å‹">ä»€ä¹ˆæ˜¯æ³›å‹</h2><p>æ³›å‹ï¼Œå³<strong>å‚æ•°åŒ–ç±»å‹</strong></p><p>ä¸€æåˆ°å‚æ•°ï¼Œæœ€ç†Ÿæ‚‰çš„å°±æ˜¯å®šä¹‰æ–¹æ³•æ—¶æœ‰å½¢å‚ï¼Œç„¶åè°ƒç”¨æ­¤æ–¹æ³•æ—¶ä¼ é€’å®å‚ã€‚é‚£ä¹ˆå‚æ•°åŒ–ç±»å‹æ€ä¹ˆç†è§£å‘¢ï¼Ÿé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†ç±»å‹ç”±åŸæ¥çš„å…·ä½“çš„ç±»å‹å‚æ•°åŒ–ï¼Œç±»ä¼¼äºæ–¹æ³•ä¸­çš„å˜é‡å‚æ•°ï¼Œæ­¤æ—¶ç±»å‹ä¹Ÿå®šä¹‰æˆå‚æ•°å½¢å¼ï¼ˆå¯ä»¥ç§°ä¹‹ä¸ºç±»å‹å½¢å‚ï¼‰ï¼Œç„¶ååœ¨è°ƒç”¨æ—¶ä¼ å…¥å…·ä½“çš„ç±»å‹ï¼ˆç±»å‹å®å‚ï¼‰</p><h2 id="ä¸ºä»€ä¹ˆè¦å¼•å…¥æ³›å‹">ä¸ºä»€ä¹ˆè¦å¼•å…¥æ³›å‹</h2><p>ä½¿ç”¨æ³›å‹è¿›è¡Œå£°æ˜å¯ä»¥è®©ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µå°±èƒ½å¤Ÿå¸®æˆ‘ä»¬å‘ç°é”™è¯¯ç±»å‹å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">list.add(<span class="string">&quot;string&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹è½¬æ¢å¼‚å¸¸ ClassCastException</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> (Student)list.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h2 id="æ³›å‹æ“¦é™¤">æ³›å‹æ“¦é™¤</h2><p>æ³›å‹æ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±ä¼šè¿›è¡Œæ³›å‹æ“¦é™¤ï¼Œæ³›å‹ä¿¡æ¯ä¸ä¼šè¿›å…¥åˆ°è¿è¡Œæ—¶é˜¶æ®µï¼ˆäº‹å®ä¸Šæœ‰äº›æ³›å‹ä¿¡æ¯ä¼šè¢«ä¿ç•™ï¼Œè§ä¸‹æ–‡çš„API ä»‹ç»ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringArrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">List&lt;Integer&gt; integerArrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">classStringArrayList</span> <span class="operator">=</span> stringArrayList.getClass();</span><br><span class="line"><span class="type">Class</span> <span class="variable">classIntegerArrayList</span> <span class="operator">=</span> integerArrayList.getClass();</span><br><span class="line"></span><br><span class="line"><span class="comment">// equals = true è¯´æ˜æœ€åçš„ Class ä¿¡æ¯ä¸åŒ…å«æ³›å‹ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">equals</span> <span class="operator">=</span> Objects.equals(classStringArrayList, classIntegerArrayList);</span><br></pre></td></tr></table></figure><h1 id="ç±»å‹">ç±»å‹</h1><p>æ³›å‹çš„ä½¿ç”¨åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼šæ³›å‹ç±»ã€æ³›å‹æ¥å£ã€æ³›å‹æ–¹æ³•</p><h2 id="æ³›å‹ç±»">æ³›å‹ç±»</h2><p>æ³›å‹ç±»å‹ç”¨äºç±»çš„å®šä¹‰ä¸­ï¼Œè¢«ç§°ä¸ºæ³›å‹ç±»ã€‚é€šè¿‡æ³›å‹å¯ä»¥å®Œæˆå¯¹ä¸€ç»„ç±»çš„æ“ä½œå¯¹å¤–å¼€æ”¾ç›¸åŒçš„æ¥å£</p><p>æœ€å…¸å‹çš„å°±æ˜¯å„ç§é›†åˆç±»ï¼Œå¦‚ï¼šListã€Setã€Map</p><p><strong>ç®€å•çš„æ³›å‹ç±»</strong></p><p>æ³›å‹ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsClass</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">//keyè¿™ä¸ªæˆå‘˜å˜é‡çš„ç±»å‹ä¸ºT,Tçš„ç±»å‹ç”±å¤–éƒ¨æŒ‡å®š</span></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GenericsClass</span><span class="params">(T key)</span> &#123; <span class="comment">//æ³›å‹æ„é€ æ–¹æ³•å½¢å‚keyçš„ç±»å‹ä¹Ÿä¸ºTï¼ŒTçš„ç±»å‹ç”±å¤–éƒ¨æŒ‡å®š</span></span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span> &#123; <span class="comment">//æ³›å‹æ–¹æ³•getKeyçš„è¿”å›å€¼ç±»å‹ä¸ºTï¼ŒTçš„ç±»å‹ç”±å¤–éƒ¨æŒ‡å®š</span></span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜è¯¥ç±»æ³›å‹ä¸º String</span></span><br><span class="line"><span class="keyword">final</span> GenericsClass&lt;String&gt; genericsClass = <span class="keyword">new</span> <span class="title class_">GenericsClass</span>&lt;&gt;(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼è¿”å›çš„å°±æ˜¯å£°æ˜çš„ç±»å‹</span></span><br><span class="line"><span class="comment">// key = â€å¼ ä¸‰â€œ</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> genericsClass.getKey();</span><br></pre></td></tr></table></figure><p><strong>ä¸æŒ‡æ˜æ³›å‹åˆ™æ²¡æœ‰é™å®š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">GenericsClass</span> <span class="variable">genericsClass1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsClass</span>&lt;&gt;(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">GenericsClass</span> <span class="variable">genericsClass2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsClass</span>&lt;&gt;(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// key1 æ˜¯ String</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">key1</span> <span class="operator">=</span> genericsClass1.getKey();</span><br><span class="line"><span class="comment">// key2 æ˜¯ Integer</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">key2</span> <span class="operator">=</span> genericsClass2.getKey();</span><br></pre></td></tr></table></figure><p><strong>æ³›å‹ä¸èƒ½ä½¿ç”¨ instanceof æ“ä½œ</strong></p><p>ç¼–è¯‘é”™è¯¯ Expression expected</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span> &#123; </span><br><span class="line">    <span class="comment">// ä¸èƒ½ä½¿ç”¨ instanceof æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (T <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ³›å‹æ¥å£">æ³›å‹æ¥å£</h2><p>æ³›å‹æ¥å£ä¸æ³›å‹ç±»çš„å®šä¹‰åŠä½¿ç”¨åŸºæœ¬ç›¸åŒã€‚æ³›å‹æ¥å£å¸¸è¢«ç”¨åœ¨å„ç§ç±»çš„ç”Ÿäº§å™¨ä¸­</p><p><strong>ç®€å•çš„æ³›å‹æ¥å£</strong></p><p>æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GenericsIntf</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ç±»ï¼Œæœªå£°æ˜æ³›å‹å®å‚ï¼Œä¾èµ–åˆ›å»ºå¯¹è±¡æ—¶å£°æ˜çš„æ³›å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœªä¼ å…¥æ³›å‹å®å‚æ—¶ï¼Œä¸æ³›å‹ç±»çš„å®šä¹‰ç›¸åŒï¼Œåœ¨å£°æ˜ç±»çš„æ—¶å€™ï¼Œéœ€å°†æ³›å‹çš„å£°æ˜ä¹Ÿä¸€èµ·åŠ åˆ°ç±»ä¸­</span></span><br><span class="line"><span class="comment"> * å³ï¼šclass GenericsIntfImpl&lt;T&gt; implements GenericsIntf&lt;T&gt;&#123;</span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸å£°æ˜æ³›å‹ï¼Œå¦‚ï¼šclass GenericsIntfImpl implements GenericsIntf&lt;T&gt;ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼š&quot;Unknown class&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsIntfImpl</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">GenericsIntf</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T t;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GenericsIntfImpl</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.t = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> GenericsIntfImpl&lt;String&gt; impl = <span class="keyword">new</span> <span class="title class_">GenericsIntfImpl</span>&lt;String&gt;(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> impl.get();</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åœ¨å®ç°ç±»ä¸­å‘æ³›å‹æ¥å£å£°æ˜å›ºå®šçš„æ³›å‹å®å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ å…¥æ³›å‹å®å‚æ—¶ï¼š</span></span><br><span class="line"><span class="comment"> * å®šä¹‰ä¸€ä¸ªç”Ÿäº§å™¨å®ç°è¿™ä¸ªæ¥å£,è™½ç„¶æˆ‘ä»¬åªåˆ›å»ºäº†ä¸€ä¸ªæ³›å‹æ¥å£ GenericsIntf&lt;T&gt;</span></span><br><span class="line"><span class="comment"> * ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¸ºTä¼ å…¥æ— æ•°ä¸ªå®å‚ï¼Œå½¢æˆæ— æ•°ç§ç±»å‹çš„ GenericsIntf æ¥å£ã€‚</span></span><br><span class="line"><span class="comment"> * åœ¨å®ç°ç±»å®ç°æ³›å‹æ¥å£æ—¶ï¼Œå¦‚å·²å°†æ³›å‹ç±»å‹ä¼ å…¥å®å‚ç±»å‹ï¼Œåˆ™æ‰€æœ‰ä½¿ç”¨æ³›å‹çš„åœ°æ–¹éƒ½è¦æ›¿æ¢æˆä¼ å…¥çš„å®å‚ç±»å‹</span></span><br><span class="line"><span class="comment"> * å³ï¼šGenericsIntf&lt;T&gt;ï¼Œpublic T get();ä¸­çš„çš„Téƒ½è¦æ›¿æ¢æˆä¼ å…¥çš„ String ç±»å‹ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsIntfImpl2</span> <span class="keyword">implements</span> <span class="title class_">GenericsIntf</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">GenericsIntfImpl2</span> <span class="variable">impl2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsIntfImpl2</span>();</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> impl2.get();</span><br><span class="line">Assert.assertEquals(s, <span class="string">&quot;Hello World&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="æ³›å‹æ–¹æ³•">æ³›å‹æ–¹æ³•</h2><p>æ³›å‹ç±»ï¼Œæ˜¯åœ¨å®ä¾‹åŒ–ç±»çš„æ—¶å€™æŒ‡æ˜æ³›å‹çš„å…·ä½“ç±»å‹</p><p><strong>è€Œæ³›å‹æ–¹æ³•ï¼Œæ˜¯åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™æŒ‡æ˜æ³›å‹çš„å…·ä½“ç±»å‹</strong></p><h3 id="ç®€å•ä½¿ç”¨">ç®€å•ä½¿ç”¨</h3><p>æ³›å‹æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsMethod</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³›å‹æ–¹æ³•çš„åŸºæœ¬ä»‹ç»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tClass ä¼ å…¥çš„æ³›å‹å®å‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> T è¿”å›å€¼ä¸ºTç±»å‹</span></span><br><span class="line"><span class="comment">     * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">     * 1ï¼‰public ä¸ è¿”å›å€¼ä¸­é—´&lt;T&gt;éå¸¸é‡è¦ï¼Œå¯ä»¥ç†è§£ä¸ºå£°æ˜æ­¤æ–¹æ³•ä¸ºæ³›å‹æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     * 2ï¼‰åªæœ‰å£°æ˜äº†&lt;T&gt;çš„æ–¹æ³•æ‰æ˜¯æ³›å‹æ–¹æ³•ï¼Œæ³›å‹ç±»ä¸­çš„ä½¿ç”¨äº†æ³›å‹çš„æˆå‘˜æ–¹æ³•å¹¶ä¸æ˜¯æ³›å‹æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     * 3ï¼‰&lt;T&gt;è¡¨æ˜è¯¥æ–¹æ³•å°†ä½¿ç”¨æ³›å‹ç±»å‹Tï¼Œæ­¤æ—¶æ‰å¯ä»¥åœ¨æ–¹æ³•ä¸­ä½¿ç”¨æ³›å‹ç±»å‹Tã€‚</span></span><br><span class="line"><span class="comment">     * 4ï¼‰ä¸æ³›å‹ç±»çš„å®šä¹‰ä¸€æ ·ï¼Œæ­¤å¤„Tå¯ä»¥éšä¾¿å†™ä¸ºä»»æ„æ ‡è¯†ï¼Œå¸¸è§çš„å¦‚Tã€Eã€Kã€Vç­‰å½¢å¼çš„å‚æ•°å¸¸ç”¨äºè¡¨ç¤ºæ³›å‹ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">genericsMethod</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; tClass)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">return</span> tClass.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">GenericsMethod</span> <span class="variable">genericsMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericsMethod</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸åŒçš„å…¥å‚æœ‰ä¸åŒçš„è¿”å›å€¼</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> genericsMethod.genericsMethod(Student.class);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> genericsMethod.genericsMethod(Dog.class);</span><br></pre></td></tr></table></figure><p>æ³›å‹æ–¹æ³•çš„ç‰¹å¾å¾ˆå®¹æ˜“æ··æ·†ï¼Œå®šä¹‰ä¸€ä¸ªå¤æ‚äº›çš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsComplex</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GenericsComplex</span><span class="params">(<span class="keyword">final</span> T key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * æ­¤å¤„å¹¶ä¸æ˜¯æ³›å‹æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * åªæ˜¯å› ä¸ºè¿”å›å€¼çš„æ³›å‹æ˜¯ç±»ä¸­å·²ç»å£°æ˜è¿‡çš„æ³›å‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è¿™æ‰æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ³›å‹æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     * é¦–å…ˆåœ¨ public ä¸è¿”å›å€¼ä¹‹é—´çš„ &lt;T&gt; å¿…ä¸å¯å°‘ï¼Œè¿™è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œå¹¶ä¸”å£°æ˜äº†ä¸€ä¸ªæ³›å‹ T</span></span><br><span class="line"><span class="comment">     * è¿™ä¸ª T å¯ä»¥å‡ºç°åœ¨è¿™ä¸ªæ³›å‹æ–¹æ³•çš„ä»»æ„ä½ç½®.</span></span><br><span class="line"><span class="comment">     * æ³›å‹çš„æ•°é‡ä¹Ÿå¯ä»¥ä¸ºä»»æ„å¤šä¸ª </span></span><br><span class="line"><span class="comment">     * å¦‚ï¼špublic &lt;T,K&gt; K showKeyName(Generic&lt;T&gt; container)&#123;...&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getKeyName</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;T&gt; generics)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;container key :&quot;</span> + generics.getKey());</span><br><span class="line">        <span class="comment">//å½“ç„¶è¿™ä¸ªä¾‹å­ä¸¾çš„ä¸å¤ªåˆé€‚ï¼Œåªæ˜¯ä¸ºäº†è¯´æ˜æ³›å‹æ–¹æ³•çš„ç‰¹æ€§</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">T</span> <span class="variable">test</span> <span class="operator">=</span> generics.getKey();</span><br><span class="line">        <span class="keyword">return</span> test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è¿™ä¸æ˜¯ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * åªæ˜¯ä½¿ç”¨äº† Generic&lt;Number&gt; è¿™ä¸ªæ³›å‹ç±»åšå½¢å‚è€Œå·²</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;Number&gt; obj)</span> &#123;</span><br><span class="line">        System.out.println(obj.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç±»ä¸­æ³›å‹æ–¹æ³•">ç±»ä¸­æ³›å‹æ–¹æ³•</h3><p>å®šä¹‰ä¸€ä¸ªæ³›å‹ç±»ï¼Œå…¶ä¸­åŒ…å«<strong>æ™®é€šæ–¹æ³•ä½¿ç”¨æ³›å‹ç±»å£°æ˜çš„æ³›å‹</strong>å’Œ<strong>æ³›å‹æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericsMethod2</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show1</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">        System.out.println(t.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ³›å‹ç±»ä¸­å£°æ˜äº†ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œä½¿ç”¨æ³›å‹Eï¼Œè¿™ç§æ³›å‹Eå¯ä»¥ä¸ºä»»æ„ç±»å‹ã€‚å¯ä»¥ç±»å‹ä¸Tç›¸åŒï¼Œä¹Ÿå¯ä»¥ä¸åŒã€‚</span></span><br><span class="line">    <span class="comment">// ç”±äºæ³›å‹æ–¹æ³•åœ¨å£°æ˜çš„æ—¶å€™ä¼šå£°æ˜æ³›å‹&lt;E&gt;ï¼Œå› æ­¤å³ä½¿åœ¨æ³›å‹ç±»ä¸­å¹¶æœªå£°æ˜æ³›å‹ï¼Œç¼–è¯‘å™¨ä¹Ÿèƒ½å¤Ÿæ­£ç¡®è¯†åˆ«æ³›å‹æ–¹æ³•ä¸­è¯†åˆ«çš„æ³›å‹ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; <span class="keyword">void</span> <span class="title function_">show2</span><span class="params">(<span class="keyword">final</span> E t)</span> &#123;</span><br><span class="line">        System.out.println(t.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ³›å‹ç±»ä¸­å£°æ˜äº†ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œä½¿ç”¨æ³›å‹T</span></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™ä¸ªTæ˜¯ä¸€ç§å…¨æ–°çš„ç±»å‹ï¼Œå¯ä»¥ä¸æ³›å‹ç±»ä¸­å£°æ˜çš„Tä¸æ˜¯åŒä¸€ç§ç±»å‹ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">show3</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">        System.out.println(t.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå£°æ˜æ³›å‹ä¸º String</span></span><br><span class="line"><span class="keyword">final</span> GenericsMethod2&lt;String&gt; method2 = <span class="keyword">new</span> <span class="title class_">GenericsMethod2</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// show1() ä¸æ˜¯æ³›å‹æ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯æ³›å‹ç±»çš„æ³›å‹å£°æ˜ï¼Œæ‰€ä»¥åªèƒ½ä¼  String ç±»å‹çš„å‚æ•°</span></span><br><span class="line">method2.show1(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// show2() æ˜¯æ³›å‹æ–¹æ³•ï¼Œæ³›å‹å’Œç±»ä¸­å£°æ˜çš„æ³›å‹æ— å…³</span></span><br><span class="line">method2.show2(<span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;æ—ºè´¢&quot;</span>, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// show3() ä¹Ÿæ˜¯æ³›å‹æ–¹æ³•ï¼Œè™½ç„¶ä¹Ÿä½¿ç”¨ &lt;T&gt; ä½œä¸ºæ³›å‹å‚æ•°ï¼Œä½†å’Œç±»ä¸­çš„ T æ²¡æœ‰å…³ç³»ï¼Œåªå’Œå‚æ•°çš„ç±»å‹you</span></span><br><span class="line">method2.show3(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;æå››&quot;</span>, <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h3 id="å¯å˜å‚æ•°">å¯å˜å‚æ•°</h3><p>æ³›å‹æ–¹æ³•å¯ä»¥ä½¿ç”¨åœ¨å¯å˜å‚æ•°ä¸Š</p><p>å®šä¹‰æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">printMsg</span><span class="params">(<span class="keyword">final</span> T... args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> T t : args) &#123;</span><br><span class="line">        System.out.print(t + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼ ä¸‰ 200 4 æå›› </span></span><br><span class="line"><span class="built_in">this</span>.printMsg(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">200</span>, <span class="number">4L</span>, <span class="string">&quot;æå››&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="é™æ€æ–¹æ³•">é™æ€æ–¹æ³•</h3><p>é™æ€æ–¹æ³•æ— æ³•ç›´æ¥ä½¿ç”¨å®šä¹‰åœ¨ç±»ä¸Šçš„æ³›å‹ï¼Œå› ä¸ºæ³›å‹åœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶ä¼ å…¥ï¼Œé™æ€æ–¹æ³•æ— æ³•è·å–ç±»ä¸Šçš„æ³›å‹ä¿¡æ¯</p><p>æ‰€ä»¥<strong>å¦‚æœé™æ€æ–¹æ³•æƒ³ä½¿ç”¨æ³›å‹ï¼Œå°±å¿…é¡»å®šä¹‰æˆæ³›å‹æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticGenericsMethod</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Animal</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒç†ï¼Œè¿™é‡Œçš„ T åªé’ˆå¯¹è¯¥æ–¹æ³•ï¼Œå’Œç±»ä¸Šçš„ T ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Animal</span>&gt; <span class="keyword">void</span> <span class="title function_">staticShow</span><span class="params">(<span class="keyword">final</span> T obj)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;static&quot;</span>);</span><br><span class="line">        System.out.println(obj.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">(<span class="keyword">final</span> T obj)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">        System.out.println(obj.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;æ—ºè´¢&quot;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°è¦æ±‚ä¼ å…¥ Animal çš„å­ç±»</span></span><br><span class="line">StaticGenericsMethod.staticShow(dog);</span><br><span class="line"><span class="comment">// æˆå‘˜æ–¹æ³•ï¼Œå®ä¾‹å¯¹è±¡æ³›å‹è¦æ±‚ä¼ å…¥ Animal çš„å­ç±»</span></span><br><span class="line"><span class="keyword">final</span> StaticGenericsMethod&lt;Dog&gt; method = <span class="keyword">new</span> <span class="title class_">StaticGenericsMethod</span>&lt;&gt;();</span><br><span class="line">method.show(dog);</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„ï¼Œé™æ€æ³›å‹æ–¹æ³•ä¼šå¯¼è‡´ç±»å‹è½¬æ¢å¼‚å¸¸</strong></p><p>æ­£å¸¸çš„ç±»å‹è½¬æ¢ï¼Œéƒ½ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæç¤ºé”™è¯¯</p><p><code>Inconvertible types; cannot cast 'java.lang.Integer' to 'java.lang.String'</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† Integer ç±»å‹è½¬æ¢ä¸º String ç±»å‹ï¼Œæ˜æ˜¾æ˜¯é”™è¯¯çš„</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)integer;</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªé™æ€æ³›å‹æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">convert</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T)obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ–¹æ³•åå†è¿›è¡Œè½¬æ¢ï¼Œåˆ™åªä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡º<code>java.lang.ClassCastException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">convert</span> <span class="operator">=</span> convert(integer);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)convert;</span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯å› ä¸º Javaçš„æ³›å‹æ–¹æ³•å±äºä¼ªæ³›å‹ï¼Œ<strong>åœ¨ç¼–è¯‘çš„æ—¶å€™å°†è¿›è¡Œç±»å‹æ“¦é™¤</strong></p><p>æ™®é€šçš„æ³›å‹æ–¹æ³•åœ¨ç±»æ„å»ºæ—¶å·²ç»æ˜ç¡®åˆ¶å®šäº†å¯¹åº”çš„ç±»å‹ï¼Œè€Œåœ¨é™æ€æ³›å‹æ–¹æ³•ä¸­ï¼Œç±»å‹æ˜¯æ— æ³•ç›´æ¥æ¨æµ‹çš„ï¼Œç¼ºå°‘äº†æ˜ç¡®çš„ç±»å‹ï¼Œæœ€ç»ˆé€ æˆç±»å‹è½¬åŒ–å¼‚å¸¸</p><p>ç¼–è¯‘åçš„ convert æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">String</span>&gt; T <span class="title function_">convert</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T)obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h1><h2 id="æ³›å‹é€šé…ç¬¦">æ³›å‹é€šé…ç¬¦</h2><p>å­ç±»å’Œçˆ¶ç±»çš„æ³›å‹ä¸èƒ½è¢«è®¤ä¸ºæ˜¯çˆ¶ç±»çš„åŒä¸€ç§æ³›å‹</p><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œå‚æ•°è¦æ±‚ GenericsClass å¯¹è±¡ä¸”æ³›å‹ä¸º Number</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;Number&gt; num)</span> &#123;</span><br><span class="line">    System.out.println(num.getKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªæ³›å‹ä¸º Integer ç±»å‹çš„å¯¹è±¡ï¼Œåˆ™æ— æ³•è°ƒç”¨è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> GenericsClass&lt;Integer&gt; genericsClass = <span class="keyword">new</span> <span class="title class_">GenericsClass</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">// Required type: GenericsClass &lt;Number&gt;</span></span><br><span class="line"><span class="comment">// Provided: GenericsClass &lt;Integer&gt;</span></span><br><span class="line"><span class="built_in">this</span>.get(genericsClass);</span><br></pre></td></tr></table></figure><p>è™½ç„¶ <code>Integer</code> æ˜¯ <code>Number</code> çš„å­ç±»ï¼Œä½†æ˜æ˜¾<code>GenericsClass &lt;Integer&gt;</code> ä¸èƒ½è¢«çœ‹ä½œ<code>GenericsClass&lt;Number&gt;</code></p><p><strong>åŒä¸€ç§æ³›å‹å¯ä»¥å¯¹åº”å¤šä¸ªç‰ˆæœ¬ï¼ˆå› ä¸ºå‚æ•°ç±»å‹æ˜¯ä¸ç¡®å®šçš„ï¼‰ï¼Œä¸åŒç‰ˆæœ¬çš„æ³›å‹ç±»å®ä¾‹æ˜¯ä¸å…¼å®¹çš„</strong></p><p>å¯ä»¥ä½¿ç”¨æ³›å‹é€šé…ç¬¦ <code>?</code> åŠ <code>extends</code> å’Œ<code>super</code> è§£å†³æ­¤ç±»é—®é¢˜</p><p><strong>æ³¨æ„ï¼š<code>?</code> æ˜¯å®å‚ï¼Œå¹¶ä¸æ˜¯å½¢å‚ï¼Œå®ƒä»£è¡¨æ‰€æœ‰ Objectç±»</strong></p><p>ä¿®æ”¹ä¸Šé¢çš„ä»£ç ï¼Œ<code>GenericsClass&lt;? extends Number&gt;</code>è¡¨ç¤ºå¯¹è±¡çš„æ³›å‹å¯ä»¥æ˜¯ç»§æ‰¿ <code>Number</code> çš„ä»»ä½•ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> GenericsClass&lt;? extends Number&gt; num)</span> &#123;</span><br><span class="line">    System.out.println(num.getKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>extends</code> å’Œ <code>super</code> åŒºåˆ«ï¼š</p><ul><li>extendsè§„å®šäº†ä¸Šç•Œï¼Œå³è§„å®šäº†æ³›å‹å®å‚çš„<strong>æœ€åº•å±‚çˆ¶ç±»</strong></li><li>superè§„å®šäº†ä¸‹ç•Œï¼Œå³è§„å®šäº†æ³›å‹å®å‚<strong>æœ€ä¸Šå±‚çš„å­ç±»ï¼ˆå®ç°ç±»ï¼‰</strong></li></ul><h1 id="java-api">Java API</h1><h2 id="parameterizedtype">ParameterizedType</h2><p>å½“æ³›å‹ä¸ºç±»ä¸Šæ³›å‹æ—¶ï¼Œé€šè¿‡ Class å¯¹è±¡çš„<code>getGenericSuperclass</code> æ–¹æ³•å°†ä¼šè·å–åˆ°<code>ParameterizedType</code> çš„ <code>Type</code>æ¥å£å¯¹è±¡ï¼Œå³ä¸ºç±»ä¸Šå®šä¹‰çš„æ³›å‹ä¿¡æ¯</p><p>å¯ä»¥ä½¿ç”¨ <code>getActualTypeArguments</code>è·å–çœŸå®çš„æ³›å‹ç±»å‹å‚æ•°</p><p><strong>å®šä¹‰æ³›å‹ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericClass</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(T obj)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showGenericInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getGenericSuperclass();</span><br><span class="line">        System.out.println(genericSuperclass.getClass());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// real type</span></span><br><span class="line">        <span class="type">Type</span> <span class="variable">type</span> <span class="operator">=</span> ((ParameterizedType)genericSuperclass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">        System.out.println(type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> <span class="keyword">extends</span> <span class="title class_">GenericClass</span>&lt;Student&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Run</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Run</span>();</span><br><span class="line">        run.showGenericInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sun</span>.reflect.generics.reflectiveObjects.ParameterizedTypeImpl</span><br><span class="line">java.util.List&lt;generic.Student&gt;</span><br></pre></td></tr></table></figure><p>ä» <code>getGenericSuperclass</code> è·å–åˆ°çš„å¯¹è±¡æ˜¯<code>ParameterizedTypeImpl</code>ï¼Œå³ <code>ParameterizedType</code>çš„å®ç°ç±»</p><p>ä»ä¸­è¿˜å¯ä»¥è·å–åˆ°çœŸå®çš„æ³›å‹ä¿¡æ¯ <code>Student</code></p><p>å¦‚æœæ˜¯ä¸€ä¸ªåµŒå¥—çš„æ³›å‹ç»“æ„å‘¢</p><p>ä¿®æ”¹ä¸‹ <code>showGenericInfo</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showGenericInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Type</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getGenericSuperclass();</span><br><span class="line">    System.out.println(genericSuperclass.getClass());</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">    <span class="comment">// real type</span></span><br><span class="line">    <span class="keyword">while</span> (genericSuperclass <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">actualTypeArgument</span> <span class="operator">=</span> ((ParameterizedType)genericSuperclass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">        System.out.println(actualTypeArgument);</span><br><span class="line">        genericSuperclass = actualTypeArgument;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> <span class="keyword">extends</span> <span class="title class_">GenericClass</span>&lt;List&lt;Student&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Run</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Run</span>();</span><br><span class="line">        run.showGenericInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sun</span>.reflect.generics.reflectiveObjects.ParameterizedTypeImpl</span><br><span class="line">--------------------------</span><br><span class="line">java.util.List&lt;generic.Student&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">generic</span>.Student</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ³›å‹ <code>List&lt;Student&gt;</code>ï¼Œç¬¬ä¸€æ¬¡è·å–åˆ°çš„<code>ParameterizedType</code> æ˜¯ <code>List</code> ä¿¡æ¯ï¼Œå®ƒä¾ç„¶æ˜¯ä¸€ä¸ª<code>ParameterizedType</code> å¯¹è±¡ï¼Œè€Œåè¿˜å¯ä»¥è·å–åˆ°ä¸‹é¢å®šä¹‰çš„<code>Student</code></p><h2 id="getgenericinterfaces">getGenericInterfaces</h2><p>æ³›å‹æ¥å£åŒç†ï¼Œä¸è¿‡éœ€è¦é€šè¿‡ <code>getGenericInterfaces</code>æ–¹æ³•è¿›è¡Œè·å–</p><p><code>public Type[] getGenericInterfaces()</code>å› ä¸ºæ¥å£æ˜¯ä¸€å¯¹å¤šï¼Œæ‰€ä»¥è¿™é‡Œè·å–åˆ°çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿæ˜¯<code>ParameterizedType</code></p><p><strong>å®šä¹‰æ³›å‹æ¥å£</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GenericInterface</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">showGenericInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getGenericInterfaces()[<span class="number">0</span>];</span><br><span class="line">        System.out.println(genericSuperclass.getClass());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="comment">// real type</span></span><br><span class="line">        <span class="keyword">while</span> (genericSuperclass <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            <span class="type">Type</span> <span class="variable">actualTypeArgument</span> <span class="operator">=</span> ((ParameterizedType)genericSuperclass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">            System.out.println(actualTypeArgument);</span><br><span class="line">            genericSuperclass = actualTypeArgument;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> <span class="keyword">implements</span> <span class="title class_">GenericInterface</span>&lt;List&lt;Student&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Run</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Run</span>();</span><br><span class="line">        run.showGenericInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sun</span>.reflect.generics.reflectiveObjects.ParameterizedTypeImpl</span><br><span class="line">--------------------------</span><br><span class="line">java.util.List&lt;generic.Student&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">generic</span>.Student</span><br></pre></td></tr></table></figure><h2 id="typevariable">TypeVariable</h2><p>å½“ä½¿ç”¨æ³›å‹æ–¹æ³•æ—¶ï¼Œå…¶å‚æ•°æˆ–è€…è¿”å›å€¼æ‹¿åˆ°çš„æ³›å‹ä¿¡æ¯ä¸º<code>TypeVariable</code></p><p>è¿™æ—¶åªèƒ½æ‹¿åˆ°æ³›å‹å®šä¹‰æ—¶çš„è¾¹ç•Œä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰è¾¹ç•Œä¿¡æ¯åˆ™ä¼šæ“¦é™¤ä¸º<code>Object</code></p><p><strong>å®šä¹‰æ³›å‹æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericMethod</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(T obj)</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getMethods()[<span class="number">0</span>];</span><br><span class="line">        <span class="type">Type</span> <span class="variable">genericParameterType</span> <span class="operator">=</span> method.getGenericParameterTypes()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">TypeVariable</span> <span class="variable">typeVariable</span> <span class="operator">=</span> (TypeVariable)genericParameterType;</span><br><span class="line">        System.out.println(typeVariable.getName());</span><br><span class="line">        System.out.println(Arrays.toString(typeVariable.getBounds()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è°ƒç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericMethod</span> <span class="variable">genericMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericMethod</span>();</span><br><span class="line">        genericMethod.method(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Student&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">T</span><br><span class="line">[<span class="keyword">class</span> <span class="title class_">java</span>.lang.Object]</span><br></pre></td></tr></table></figure><p>å¦‚æœè§„å®šäº†è¾¹ç•Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">String</span>&gt; <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(T obj)</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">T</span><br><span class="line">[<span class="keyword">class</span> <span class="title class_">java</span>.lang.String]</span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨">åº”ç”¨</h2><p>å¾ˆå¤š JSON å·¥å…·éƒ½å®šä¹‰äº†ç±»ä¼¼åä¸º <code>TypeReference</code>çš„ç±»ï¼Œå…¶ä½œç”¨å°±æ˜¯é€šè¿‡æ³›å‹ç±»æ¥ä¼ é€’éœ€è¦ååºåˆ—åŒ–çš„æ³›å‹ä¿¡æ¯ï¼Œé¿å…æ³›å‹æ“¦é™¤</p><p>å¦‚ fastjson ä¸­çš„å®šä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypeReference</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">static</span> ConcurrentMap&lt;Type, Type&gt; classTypeCache</span><br><span class="line">            = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;Type, Type&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Type type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new type literal. Derives represented class from type</span></span><br><span class="line"><span class="comment">     * parameter.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Clients create an empty anonymous subclass. Doing so embeds the type</span></span><br><span class="line"><span class="comment">     * parameter in the anonymous class&#x27;s type hierarchy so we can reconstitute it</span></span><br><span class="line"><span class="comment">     * at runtime despite erasure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">TypeReference</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">superClass</span> <span class="operator">=</span> getClass().getGenericSuperclass();</span><br><span class="line"></span><br><span class="line">        <span class="type">Type</span> <span class="variable">type</span> <span class="operator">=</span> ((ParameterizedType) superClass).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">Type</span> <span class="variable">cachedType</span> <span class="operator">=</span> classTypeCache.get(type);</span><br><span class="line">        <span class="keyword">if</span> (cachedType == <span class="literal">null</span>) &#123;</span><br><span class="line">            classTypeCache.putIfAbsent(type, type);</span><br><span class="line">            cachedType = classTypeCache.get(type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.type = cachedType;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>TypeReference</code>å¯¹è±¡ä¿å­˜éœ€è¦ååºåˆ—åŒ–çš„æ³›å‹ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;æå››&quot;</span>, <span class="number">21</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSON.toJSONString(Arrays.asList(student1, student2));</span><br><span class="line"></span><br><span class="line">        List&lt;Student&gt; list = JSON.parseObject(jsonStr, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;Student&gt;&gt;() &#123;&#125;);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Student(name=å¼ ä¸‰, age=<span class="number">20</span>), Student(name=æå››, age=<span class="number">21</span>)]</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://blog.csdn.net/s10461/article/details/53941091">javaæ³›å‹è¯¦è§£-ç»å¯¹æ˜¯å¯¹æ³›å‹æ–¹æ³•è®²è§£æœ€è¯¦ç»†çš„ï¼Œæ²¡æœ‰ä¹‹ä¸€_VieLeiçš„åšå®¢-CSDNåšå®¢_javaæ³›å‹</a></p><p><a href="https://zhuanlan.zhihu.com/p/262271430">Javaæ³›å‹ | JacksonTypeReferenceè·å–æ³›å‹ç±»å‹ä¿¡æ¯ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çŠ¶æ€æ¨¡å¼ - State</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F%20-%20State.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F%20-%20State.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>çŠ¶æ€æ¨¡å¼åŸºäº<strong>æœ‰é™çŠ¶æ€æœº</strong>ï¼ˆFSM finite statemachineï¼‰çš„æ¦‚å¿µï¼Œä¸»è¦æ€æƒ³æ˜¯ç¨‹åºåœ¨ä»»æ„æ—¶åˆ»ä¸€å®šå¤„äº Nç§æœ‰é™æ•°é‡çš„çŠ¶æ€ä¸­ï¼Œå¹¶ä¸”åœ¨ç‰¹å®šçŠ¶æ€ä¸­æ‰§è¡Œç‰¹å®šçŠ¶æ€çš„æ“ä½œå¹¶å¯ä»¥æµè½¬è‡³ä¸‹ä¸€çŠ¶æ€ï¼ˆä¹Ÿå¯ä¸å˜ï¼‰</p><p>è¿™äº›æ•°é‡æœ‰é™ä¸”é¢„å…ˆå®šä¹‰çš„çŠ¶æ€åˆ‡æ¢è§„åˆ™è¢«ç§°ä¸º <em>çŠ¶æ€æµè½¬</em></p><p><strong>ç›®çš„</strong>å°†çŠ¶æ€ä»¥åŠçŠ¶æ€è¡Œä¸ºç­‰å±æ€§å’Œä¸šåŠ¡å¯¹è±¡è§£è€¦ï¼Œæ˜¯ä¸€ç§åŸºäºç»„åˆæ¨¡å¼è¿›è¡Œé€»è¾‘å§”æ‰˜çš„è¡Œä¸ºæ¨¡å¼</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong>åœ°é“ç”µåŠ¨é—¸é—¨ä¼šæ ¹æ®å½“å‰çŠ¶æ€å’Œç”¨æˆ·è¡Œä¸ºè¿›è¡Œä¸åŒçš„æ“ä½œå¹¶ä¸”æµè½¬ä¸ºä¸‹ä¸€çŠ¶æ€ï¼š</p><ul><li>å…³é—­çŠ¶æ€<ul><li>ç”¨æˆ·åˆ·å¡æˆåŠŸ -&gt; å¼€é—¨ &amp; æµè½¬è‡³å¼€å¯çŠ¶æ€</li><li>ç”¨æˆ·åˆ·å¡å¤±è´¥ -&gt; æç¤ºåˆ·å¡å¤±è´¥</li></ul></li><li>å¼€å¯çŠ¶æ€<ul><li>ç”¨æˆ·åˆ·å¡ -&gt; æç¤ºåˆ·å¡æ— æ•ˆ</li><li>ç­‰å¾… -&gt; æµè½¬è‡³å¼€å¯å…³é—­çŠ¶æ€</li></ul></li></ul><h1 id="å®è·µ">å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œéœ€è¦å¯¹å®¡æ‰¹å·¥å•è¿›è¡Œç›¸åº”æ“ä½œ</p><h2 id="é—®é¢˜">é—®é¢˜</h2><p>ä¸€å¼€å§‹å¯¹äºå·¥å•å®¡æ‰¹çš„çŠ¶æ€å®šä¹‰æ¯”è¾ƒç®€å•</p><ol type="1"><li>ç”¨æˆ·å¡«å†™å·¥å•ï¼ŒçŠ¶æ€åˆå§‹ä¸º [è‰ç¨¿]</li><li>ç”¨æˆ·æäº¤å·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [å¾…å®¡æ ¸]ï¼Œå‘ç®¡ç†å‘˜å‘é€é‚®ä»¶é€šçŸ¥</li><li>ç®¡ç†å‘˜å®¡æ ¸å·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [é€šè¿‡]ï¼Œå‘ç”¨æˆ·å‘é€é‚®ä»¶é€šçŸ¥</li><li>ç®¡ç†å‘˜é©³å›å·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [é©³å›]ï¼Œå‘ç”¨æˆ·å‘é€é‚®ä»¶é€šçŸ¥</li><li>[é©³å›] çš„å·¥å•ç”¨æˆ·å¯ä»¥å†æ¬¡æäº¤ï¼Œè¿›å…¥[å¾…å®¡æ ¸]ï¼Œå‘ç®¡ç†å‘˜å‘é€é‚®ä»¶é€šçŸ¥</li><li>ç”¨æˆ·æ‰§è¡Œå·¥å•ï¼Œå·¥å•çŠ¶æ€è¿›å…¥ [å·²æ‰§è¡Œ]</li></ol><p>åç»­éšç€å¯¹äºå·¥å•å®¡æ ¸æµç¨‹çš„è¿­ä»£ï¼Œéœ€è¦å®šä¹‰æ›´å¤šçš„çŠ¶æ€ä»¥åŠè¡Œä¸º</p><p>ä¾‹å¦‚éœ€è¦å°†å·¥å•çŠ¶æ€çš„ [å·²æ‰§è¡Œ] æ‹†åˆ†ä¸º [æ‰§è¡ŒæˆåŠŸ] å’Œ[æ‰§è¡Œå¤±è´¥]ï¼Œæ‰§è¡Œå¤±è´¥ä¼šå‘ç”¨æˆ·å’Œç®¡ç†å‘˜å‘é€æ‰§è¡Œå¤±è´¥çš„ç»“æœé‚®ä»¶é€šçŸ¥ï¼Œå¹¶ä¸”å¤±è´¥çš„å·¥å•å¯ä»¥è¿›è¡Œå†æ¬¡æ‰§è¡Œ</p><p>æ•´ä¸ªçŠ¶æ€çš„æµè½¬è§„åˆ™åœ¨æ ¸å¿ƒä¸šåŠ¡ä»£ç ä¸­å¾€å¾€ä½¿ç”¨ <code>if...else</code>è¯­å¥å®ç°ï¼Œå†åŠ ä¸Šè¿­ä»£è¶Šæ¥è¶Šå¤šçš„çŠ¶æ€ä»¥åŠè¡Œä¸ºï¼Œä¼šå¯¼è‡´åˆ¤æ–­è¯­å¥æ„ˆå‘è‡ƒè‚¿</p><h2 id="å®ç°">å®ç°</h2><p>é¦–å…ˆå¯ä»¥å®šä¹‰å‡ºä¸€ä¸ªè¡Œä¸ºç›®å½•ï¼š</p><ul><li>æäº¤</li><li>é€šè¿‡</li><li>é©³å›</li><li>æ‰§è¡Œ</li></ul><p>æ¥ä¸‹æ¥ç»“åˆè¡Œä¸ºå’ŒçŠ¶æ€å°±å¯ä»¥å®šä¹‰å‡ºå¦‚ä¸‹çš„çŠ¶æ€è¡¨</p><table><thead><tr class="header"><th style="text-align: center;">å½“å‰çŠ¶æ€ | æµè½¬çŠ¶æ€</th><th style="text-align: center;">è‰ç¨¿</th><th style="text-align: center;">å¾…å®¡æ ¸</th><th style="text-align: center;">é©³å›</th><th style="text-align: center;">é€šè¿‡</th><th style="text-align: center;">å·²æ‰§è¡Œ</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><strong>è‰ç¨¿</strong></td><td style="text-align: center;">/</td><td style="text-align: center;">æäº¤</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td></tr><tr class="even"><td style="text-align: center;"><strong>å¾…å®¡æ ¸</strong></td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">é©³å›</td><td style="text-align: center;">å®¡æ ¸</td><td style="text-align: center;">/</td></tr><tr class="odd"><td style="text-align: center;"><strong>é©³å›</strong></td><td style="text-align: center;">/</td><td style="text-align: center;">æäº¤</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td></tr><tr class="even"><td style="text-align: center;"><strong>é€šè¿‡</strong></td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">æ‰§è¡Œ</td></tr><tr class="odd"><td style="text-align: center;"><strong>å·²æ‰§è¡Œ</strong></td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td><td style="text-align: center;">/</td></tr></tbody></table><h3 id="çŠ¶æ€æšä¸¾">çŠ¶æ€æšä¸¾</h3><p>å®šä¹‰å‡ºå·¥å•çš„å„ç§çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">WorkOrderState</span> &#123;</span><br><span class="line"></span><br><span class="line">    DRAFT(<span class="number">0</span>, <span class="string">&quot;è‰ç¨¿&quot;</span>),</span><br><span class="line">    WAIT_REVIEW(<span class="number">0</span>, <span class="string">&quot;å¾…å®¡æ ¸&quot;</span>),</span><br><span class="line">    REVIEWED(<span class="number">0</span>, <span class="string">&quot;é€šè¿‡&quot;</span>),</span><br><span class="line">    REJECTED(<span class="number">0</span>, <span class="string">&quot;é©³å›&quot;</span>),</span><br><span class="line">    DONE(<span class="number">0</span>, <span class="string">&quot;å·²æ‰§è¡Œ&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    WorkOrderState(<span class="keyword">final</span> <span class="type">int</span> code, <span class="keyword">final</span> String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å·¥å•ä¸šåŠ¡å®ä½“">å·¥å•ä¸šåŠ¡å®ä½“</h3><p>å·¥å•ä¿¡æ¯çš„ä¸šåŠ¡å®ä½“ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkOrder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String optionContent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WorkOrderState state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æŠ½è±¡çŠ¶æ€å¤„ç†å™¨">æŠ½è±¡çŠ¶æ€å¤„ç†å™¨</h3><p>æŠ½è±¡çš„çŠ¶æ€å¤„ç†å™¨ï¼Œé»˜è®¤å®ç°ä¸ºä¸æ”¯æŒç›¸åº”æ“ä½œï¼ŒæŠ›å‡º<code>IllegalStateException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;submit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">pass</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;pass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;reject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.IllegalState(workOrder, <span class="string">&quot;run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">IllegalState</span><span class="params">(WorkOrder workOrder, String option)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String</span><br><span class="line">            .format(<span class="string">&quot;ä¸æ”¯æŒçš„æ“ä½œ ID:[%s] å½“å‰çŠ¶æ€:[%s] æ“ä½œ:[%s]&quot;</span>, workOrder.getId(), workOrder.getState().getDesc(), option));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="çŠ¶æ€å¤„ç†å™¨å®ç°">çŠ¶æ€å¤„ç†å™¨å®ç°</h3><p>å¯¹æŠ½è±¡å¤„ç†å™¨ç›¸åº”çš„æ–¹æ³•è¿›è¡Œå®ç°</p><p><strong>è‰ç¨¿çŠ¶æ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DraftStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.WAIT_REVIEW.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¾…å®¡æ ¸çŠ¶æ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WaitReviewStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">pass</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.REVIEWED.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç”¨æˆ·å‘é€å®¡æ ¸é€šè¿‡é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.REJECTED.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç”¨æˆ·å‘é€å®¡æ ¸é©³å›é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡çŠ¶æ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReviewedStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out</span><br><span class="line">            .println(String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.DONE.getDesc()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–çš„å®ç°ç±»æ¯”å³å¯</p><h3 id="çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜">çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜</h3><p>ä¸ºä»€ä¹ˆä¼šæœ‰ â€œçŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜â€ çš„è§’è‰²</p><p>äº‹å®ä¸Šå¦‚æœæ˜¯é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œä¼šæœ‰æ‰€åŒºåˆ«ï¼š</p><ul><li>çŠ¶æ€å’ŒçŠ¶æ€çš„è¡Œä¸ºåº”è¯¥æ˜¯ä¸€ä½“çš„ï¼Œåœ¨æœ¬ä¾‹ä¸­æ‹†åˆ†æˆäº†æšä¸¾ç±»å’ŒçŠ¶æ€å¤„ç†å™¨</li><li>çŠ¶æ€æµè½¬åœ¨æŸäº›ç¨‹åºä¸­åº”è¯¥æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯åœ¨ Webå¼€å‘ä¸­æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥éœ€è¦ç®¡ç†å‘˜çš„è§’è‰²æ ¹æ®å½“å‰ä¸šåŠ¡çŠ¶æ€é€‰æ‹©åˆé€‚çš„å¤„ç†å™¨è¿›è¡Œå¤„ç†</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StateHandlerHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;WorkOrderState, AbstreactStateHandler&gt; HANDLERS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        HANDLERS = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        HANDLERS.put(WorkOrderState.DRAFT, <span class="keyword">new</span> <span class="title class_">DraftStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.WAIT_REVIEW, <span class="keyword">new</span> <span class="title class_">WaitReviewStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.REVIEWED, <span class="keyword">new</span> <span class="title class_">ReviewedStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.REJECTED, <span class="keyword">new</span> <span class="title class_">RejectedStateHandler</span>());</span><br><span class="line">        HANDLERS.put(WorkOrderState.DONE, <span class="keyword">new</span> <span class="title class_">DoneStateHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).submit(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pass</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).pass(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).reject(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        HANDLERS.get(workOrder.getState()).run(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œ">æ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WorkOrder</span> <span class="variable">workOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WorkOrder</span>();</span><br><span class="line">        workOrder.setId(<span class="number">1</span>);</span><br><span class="line">        workOrder.setState(WorkOrderState.DRAFT);</span><br><span class="line"></span><br><span class="line">        <span class="type">StateHandlerHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StateHandlerHolder</span>();</span><br><span class="line">        holder.submit(workOrder);</span><br><span class="line"></span><br><span class="line">        workOrder.setState(WorkOrderState.WAIT_REVIEW);</span><br><span class="line">        holder.pass(workOrder);</span><br><span class="line"></span><br><span class="line">        holder.submit(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å·¥å•çŠ¶æ€ [è‰ç¨¿] -&gt; [å¾…å®¡æ ¸]</span><br><span class="line">å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥</span><br><span class="line">    </span><br><span class="line">å·¥å•çŠ¶æ€ [å¾…å®¡æ ¸] -&gt; [é€šè¿‡]</span><br><span class="line">å‘ç”¨æˆ·å‘é€å®¡æ ¸é€šè¿‡é‚®ä»¶é€šçŸ¥</span><br><span class="line">    </span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalStateException: ä¸æ”¯æŒçš„æ“ä½œ ID:[<span class="number">1</span>] å½“å‰çŠ¶æ€:[å¾…å®¡æ ¸] æ“ä½œ:[submit]</span><br></pre></td></tr></table></figure><h3 id="æ‰©å±•æ–°çŠ¶æ€">æ‰©å±•æ–°çŠ¶æ€</h3><p>å°†å·¥å•çŠ¶æ€çš„ [å·²æ‰§è¡Œ] æ‹†åˆ†ä¸º [æ‰§è¡ŒæˆåŠŸ] å’Œ[æ‰§è¡Œå¤±è´¥]ï¼Œæ‰§è¡Œå¤±è´¥ä¼šå‘ç”¨æˆ·å’Œç®¡ç†å‘˜å‘é€æ‰§è¡Œå¤±è´¥çš„ç»“æœé‚®ä»¶é€šçŸ¥ï¼Œå¹¶ä¸”å¤±è´¥çš„å·¥å•å¯ä»¥è¿›è¡Œå†æ¬¡æ‰§è¡Œ</p><p>å¯ä»¥çœ‹å‡ºæ‰©å±•äº†çŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰æ‰©å±•è¡Œä¸ºï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå®ç°ï¼š</p><ol type="1"><li>å¢åŠ æ–°çš„çŠ¶æ€æšä¸¾å¯¹è±¡</li><li>ä¿®æ”¹å·²å®¡æ ¸çŠ¶æ€ä¸‹æ‰§è¡Œæ“ä½œçš„å®ç°</li><li>è¿›è¡Œæ–°çŠ¶æ€å¤„ç†å™¨å®ç°</li><li>æ³¨å†Œè‡³çŠ¶æ€å¤„ç†å™¨ç®¡ç†å‘˜ä¸­</li></ol><p><strong>å·²å®¡æ ¸çŠ¶æ€å¤„ç†å™¨å®ç°ä¿®æ”¹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReviewedStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(WorkOrder workOrder)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> RandomUtil.randomInt(<span class="number">0</span>, <span class="number">100</span>) &gt; <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.SUCCESS.getDesc()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.FAILED.getDesc()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ–°çš„çŠ¶æ€å¤„ç†å™¨å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SuccessStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FailedStateHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstreactStateHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(<span class="keyword">final</span> WorkOrder workOrder)</span> &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            String.format(<span class="string">&quot;å·¥å•çŠ¶æ€ [%s] -&gt; [%s]&quot;</span>, workOrder.getState().getDesc(), WorkOrderState.WAIT_REVIEW.getDesc()));</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WorkOrder</span> <span class="variable">workOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WorkOrder</span>();</span><br><span class="line">        workOrder.setId(<span class="number">1</span>);</span><br><span class="line">        workOrder.setState(WorkOrderState.FAILED);</span><br><span class="line"></span><br><span class="line">        <span class="type">StateHandlerHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StateHandlerHolder</span>();</span><br><span class="line">        holder.submit(workOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å·¥å•çŠ¶æ€ [æ‰§è¡Œå¤±è´¥] -&gt; [å¾…å®¡æ ¸]</span><br><span class="line">å‘ç®¡ç†å‘˜å‘é€éœ€è¦å®¡æ ¸é‚®ä»¶é€šçŸ¥</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>çŠ¶æ€æ¨¡å¼æ˜¯è¡Œä¸ºæ¨¡å¼çš„ä¸€ç§</p><ul><li>ä¼˜ç‚¹<ul><li>å¯ä»¥åœ¨ç‹¬ç«‹äºå…¶ä»–çŠ¶æ€çš„æƒ…å†µä¸‹æ·»åŠ æ–°çŠ¶æ€æˆ–ä¿®æ”¹å·²æœ‰çŠ¶æ€ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬</li><li>æ¸…ç†æ‰æ ¸å¿ƒä»£ç ä¸­å¤§é‡çš„åˆ†æ”¯åˆ¤æ–­</li><li>çŠ¶æ€å¤„ç†çš„å®ç°å¯ä»¥ç»“æ„åŒ–ï¼Œå¯ä»¥å®ç°æ¨¡æ¿æ–¹æ³•ã€å¤ç”¨å…¬å…±ä»£ç </li></ul></li><li>ç¼ºç‚¹<ul><li>çŠ¶æ€ä¸å¤æ‚çš„ä¸šåŠ¡æ²¡å¿…è¦è¿‡åº¦è®¾è®¡</li><li>éœ€è¦åœ¨ç­–ç•¥ä¸­å®šä¹‰æ‰€æœ‰è¡Œä¸ºï¼ˆè™½ç„¶å¯ä»¥ä½¿ç”¨åŸºç±»è¿›è¡Œé»˜è®¤å®ç°ï¼‰ï¼Œå³å®šä¹‰å‡ºä¸€ä¸ªè§„åˆ™è¡¨</li></ul></li></ul><p><strong>çŠ¶æ€æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼</strong></p><p>çŠ¶æ€æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼éƒ½åŸºäºç»„åˆæ¥è¿›è¡Œå®ç°ï¼Œéƒ½æ˜¯å§”æ´¾ä¸šåŠ¡é€»è¾‘ç»™å…¶ä»–å®ç°ç±»æ¥è¾¾åˆ°è§£è€¦çš„ç›®çš„</p><p>ç­–ç•¥æ¨¡å¼ä½¿å¾—è¿™äº›å®ç°ç±»å¯¹è±¡ç›¸äº’ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œå®ƒä»¬ä¸çŸ¥é“å…¶ä»–å¯¹è±¡çš„å­˜åœ¨</p><p>ä½†çŠ¶æ€æ¨¡å¼æ²¡æœ‰é™åˆ¶å…·ä½“çŠ¶æ€ä¹‹é—´çš„ä¾èµ–ï¼Œä¸”å…è®¸å®ƒä»¬è‡ªè¡Œæ”¹å˜åœ¨ä¸åŒæƒ…æ™¯ä¸‹çš„çŠ¶æ€</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://refactoringguru.cn/design-patterns/state">çŠ¶æ€è®¾è®¡æ¨¡å¼(refactoringguru.cn)</a>https://www.kancloud.cn/digest/xing-designpattern/143730)</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo éƒ¨ç½² Github Pages 404 é—®é¢˜</title>
      <link href="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Hexo%20%E9%83%A8%E7%BD%B2%20Github%20Pages%20404%20%E9%97%AE%E9%A2%98.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Hexo%20%E9%83%A8%E7%BD%B2%20Github%20Pages%20404%20%E9%97%AE%E9%A2%98.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>çªç„¶å‘ç° Hexo ä¸­çš„æœ‰äº›æ–‡ç« çªç„¶æ‰“ä¸å¼€äº†</p><p>è¡¨ç°æ˜¯ç‚¹å‡»æ— ååº”ï¼Œæ— è®ºæ˜¯ç‚¹å‡» â€œé˜…è¯»åŸæ–‡â€è¿˜æ˜¯åœ¨å½’æ¡£ç­‰é¡µé¢ä¸­ç‚¹å‡»æ–‡ç« æ ‡é¢˜éƒ½æ— æ³•æ­£å¸¸æ‰“å¼€</p><p>æŸ¥çœ‹æ§åˆ¶å°å‘ç°å¯¹é¡µé¢çš„è¯·æ±‚ 404 äº†</p><h1 id="æ’æŸ¥">æ’æŸ¥</h1><p><strong>Github çš„ Actions æ­£å¸¸</strong></p><p>ä¹Ÿæ²¡å‡ºç°éƒ¨ç½²å¤±è´¥çš„æƒ…å†µ</p><img src="/%E5%BC%80%E5%8F%91/%E6%9D%82%E9%A1%B9/Hexo%20%E9%83%A8%E7%BD%B2%20Github%20Pages%20404%20%E9%97%AE%E9%A2%98/image-20230427231601450.png" class="" title="image-20230427231601450"><p>æŸ¥çœ‹ push ä¸Šæ¥çš„æºæ–‡ä»¶ï¼Œå‘ç°å¯èƒ½æ˜¯å› ä¸ºå¤§å°å†™é—®é¢˜</p><p>æ–‡ä»¶è·¯å¾„ä¸º <code>...bridge</code> ï¼Œè€Œè¯·æ±‚çš„è·¯å¾„ä¸º<code>...Bridge</code>ï¼Œå°è¯•å°†è·¯å¾„æ‰‹åŠ¨ä¿®æ”¹ä¸ºå°å†™ï¼Œå‘ç°æ­£å¸¸è·³è½¬</p><h1 id="è§£å†³">è§£å†³</h1><p>æŸ¥è¯¢äº†ä¸€ä¸‹ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šåŸå› ä¸º git é»˜è®¤å¿½ç•¥å¤§å°å†™</p><ol type="1"><li>é¦–å…ˆ push äº†å°å†™æ ‡é¢˜çš„æ–‡ç« </li><li>ä¿®æ”¹äº†æ–‡ç« æ ‡é¢˜ä¸ºå¤§å†™ï¼Œæ­¤æ—¶ Hexo è§£æå…¶ä»–é¡µé¢ä¹Ÿæ›´æ¢äº†å¤§å†™</li><li>ä½†æ˜¯å› ä¸º git å¿½ç•¥å¤§å°å†™ï¼Œæ‰€ä»¥æ›´åä¸ºå¤§å†™çš„å†…å®¹å¹¶æ²¡æœ‰ pushåˆ°ä»“åº“ï¼Œå¯¼è‡´è§£æ pages æ—¶æ²¡æœ‰æ›´æ–°ç›¸åº”çš„èµ„æºè·¯å¾„ï¼›æ­¤æ—¶ç‚¹å‡» Hexoç”Ÿæˆçš„å…¶ä»–é¡µé¢åˆ™èµ„æºåç§°å·²ç»æ›´æ–°ä¸ºå¤§å†™ï¼Œå¯¼è‡´ 404</li></ol><h2 id="ä¿®æ”¹-git-config-æ–‡ä»¶">ä¿®æ”¹ git config æ–‡ä»¶</h2><p>åœ¨åšå®¢æ ¹ç›®å½•ä¸‹ç¼–è¾‘ <code>./.git/config</code> æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[core]</span><br><span class="line">repositoryformatversion = 0</span><br><span class="line">filemode = <span class="literal">false</span></span><br><span class="line">bare = <span class="literal">false</span></span><br><span class="line">logallrefupdates = <span class="literal">true</span></span><br><span class="line">symlinks = <span class="literal">false</span></span><br><span class="line">ignorecase = <span class="literal">true</span></span><br><span class="line"><span class="comment"># ignorecase = false</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>ignorecase</code> ä¸º false</p><p>è¿›è¡Œæ¨é€å³å¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é‡æ–° push æ•´ä¸ªé¡¹ç›®</p><h2 id="å…¨éƒ¨é‡æ–°-push">å…¨éƒ¨é‡æ–° push</h2><p>åœ¨åšå®¢æ ¹ç›®å½• <code>./.deploy_git</code> ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">rm</span> -rf *</span><br><span class="line">git commit -m <span class="string">&#x27;clean all file&#x27;</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Hexo æ’ä»¶è¿›è¡Œ deploy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">hexo clean</span><br><span class="line">hexo d -g</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="http://1mhz.me/2015/hexo-deploy-case-sensitive/">Hexo éƒ¨ç½²åˆ°Github Pages æ–‡ä»¶å¤¹å¤§å°å†™é—®é¢˜ // Yizhao He's Notes (1mhz.me)</a></p><p><ahref="https://blog.csdn.net/weixin_43219615/article/details/102536642">åˆ©ç”¨hexoåœ¨GitHubæ­å»ºåšå®¢æ”¹å˜tagå› ä¸ºå¤§å°å†™é—®é¢˜è€Œ404çš„è§£å†³æ–¹æ³•_hexoçš„nextç”¨tagå°±404_è½¨è¿¹â€â€â€â€çš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
            <tag> ç–‘éš¾æ‚ç—‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LiteFlow - æ‰§è¡Œå™¨åˆå§‹åŒ–</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20%E6%89%A7%E8%A1%8C%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%AD%A6%E4%B9%A0/LiteFlow/LiteFlow%20-%20%E6%89%A7%E8%A1%8C%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96.html</url>
      
        <content type="html"><![CDATA[<h1 id="è‡ªåŠ¨è£…é…">è‡ªåŠ¨è£…é…</h1><p>åŸºäº SpringBoot çš„å®ç°æ–¹å¼è‡ªç„¶ä½¿ç”¨åˆ°äº† starter æœºåˆ¶ï¼Œæ ¸å¿ƒä»£ç åœ¨<code>liteflow-spring-boot-starter</code> åŒ…ä¸‹</p><p>é¦–å…ˆæ¥çœ‹ <code>spring.factories</code> æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.yomahub.liteflow.springboot.config.LiteflowPropertyAutoConfiguration,\</span></span><br><span class="line"><span class="string">  com.yomahub.liteflow.springboot.config.LiteflowMainAutoConfiguration</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ä¸¤ä¸ªé‡è¦çš„è‡ªåŠ¨è£…é…çš„é…ç½®ç±»ï¼š</p><ul><li><strong>LiteflowPropertyAutoConfiguration</strong>ï¼šé…ç½®å±æ€§çš„è§£æï¼Œå°è£…ä¸º<code>LiteflowConfig</code> å®ä¾‹</li><li><strong>LiteflowMainAutoConfiguration</strong>ï¼šLiteFlowçš„æ ¸å¿ƒåŠŸèƒ½å¯¹è±¡åœ¨è¯¥é…ç½®ç±»ä¸‹å®ä¾‹åŒ–<ul><li><strong>SpringAware</strong>ï¼šSpring ApplicationContextçš„è·å–ä¸å°è£…ï¼Œä¾¿äºåç»­ä¸šåŠ¡ä¸­è·å– bean çš„æ“ä½œ</li><li><strong>ComponentScanner</strong>ï¼šç»„ä»¶æ‰«æå™¨ï¼Œç”¨äºæ‰«æä¸å°è£…<code>NodeComponent</code> èŠ‚ç‚¹çš„å®ç°ç±»</li><li><strong>FlowExecutor</strong>ï¼šè§„åˆ™æ‰§è¡Œå™¨</li><li><strong>LiteflowExecutorInit</strong>ï¼šè®¾ç½®æœåŠ¡å¯åŠ¨æ—¶åˆå§‹åŒ–é…ç½®ç”Ÿæ•ˆï¼Œç”¨äºå¯åŠ¨æ—¶ä¸»åŠ¨è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li><li><strong>MonitorBus</strong>ï¼šç›‘æ§ç±»å…ƒæ•°æ®</li></ul></li></ul><h2id="liteflowpropertyautoconfiguration">LiteflowPropertyAutoConfiguration</h2><p>æ€»çš„æ¥è¯´å°±æ˜¯å¯¹é…ç½®å±æ€§çš„åˆå¹¶å’Œå°è£…ï¼Œå®ä¾‹åŒ–<code>LiteflowConfig</code>ï¼Œä¾¿äºåç»­ä¸šåŠ¡çš„ä½¿ç”¨</p><p>åˆå¹¶äº† <code>liteflow</code> é…ç½®å’Œ <code>liteflow.monitor</code>é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;LiteflowProperty.class, LiteflowMonitorProperty.class&#125;)</span></span><br><span class="line"><span class="meta">@PropertySource(</span></span><br><span class="line"><span class="meta">        name = &quot;Liteflow Default Properties&quot;,</span></span><br><span class="line"><span class="meta">        value = &quot;classpath:/META-INF/liteflow-default.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiteflowPropertyAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LiteflowConfig <span class="title function_">liteflowConfig</span><span class="params">(LiteflowProperty property, LiteflowMonitorProperty liteflowMonitorProperty)</span>&#123;</span><br><span class="line">        <span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LiteflowConfig</span>();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        liteflowConfig.setPrintExecutionLog(property.isPrintExecutionLog());</span><br><span class="line">        liteflowConfig.setSubstituteCmpClass(property.getSubstituteCmpClass());</span><br><span class="line">        <span class="keyword">return</span> liteflowConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾èµ–å‰ç½® <code>LiteflowProperty</code> å’Œ<code>LiteflowMonitorProperty</code>beanï¼Œå³æµç¨‹é…ç½®å‚æ•°å’Œç›‘æ§å™¨çš„é…ç½®å‚æ•°ç±»</p><h2id="liteflowmainautoconfiguration">LiteflowMainAutoConfiguration</h2><p>é…ç½®æ ¸å¿ƒçš„å„ç§å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123;LiteflowPropertyAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(LiteflowConfig.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;liteflow&quot;, name = &quot;enable&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@Import(SpringAware.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiteflowMainAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹åŒ–ComponentScanner</span></span><br><span class="line">    <span class="comment">//å¤šåŠ ä¸€ä¸ªSpringAwareçš„æ„ä¹‰æ˜¯ï¼Œç¡®ä¿åœ¨æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™ï¼ŒSpringAwareè¿™ä¸ªbeanå·²ç»è¢«åˆå§‹åŒ–</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ComponentScanner <span class="title function_">componentScanner</span><span class="params">(LiteflowConfig liteflowConfig, SpringAware springAware)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComponentScanner</span>(liteflowConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹åŒ–FlowExecutor</span></span><br><span class="line">    <span class="comment">//å¤šåŠ ä¸€ä¸ªSpringAwareçš„æ„ä¹‰æ˜¯ï¼Œç¡®ä¿åœ¨æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™ï¼ŒSpringAwareè¿™ä¸ªbeanå·²ç»è¢«åˆå§‹åŒ–</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FlowExecutor <span class="title function_">flowExecutor</span><span class="params">(LiteflowConfig liteflowConfig, SpringAware springAware)</span> &#123;</span><br><span class="line">        <span class="type">FlowExecutor</span> <span class="variable">flowExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlowExecutor</span>();</span><br><span class="line">        flowExecutor.setLiteflowConfig(liteflowConfig);</span><br><span class="line">        <span class="keyword">return</span> flowExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//FlowExecutorçš„åˆå§‹åŒ–å·¥ä½œï¼Œå’Œå®ä¾‹åŒ–åˆ†å¼€æ¥</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;liteflow&quot;, name = &quot;parse-on-start&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> LiteflowExecutorInit <span class="title function_">liteflowExecutorInit</span><span class="params">(FlowExecutor flowExecutor)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LiteflowExecutorInit</span>(flowExecutor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹åŒ–MonitorBus</span></span><br><span class="line">    <span class="comment">//å¤šåŠ ä¸€ä¸ªSpringAwareçš„æ„ä¹‰æ˜¯ï¼Œç¡®ä¿åœ¨æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™ï¼ŒSpringAwareè¿™ä¸ªbeanå·²ç»è¢«åˆå§‹åŒ–</span></span><br><span class="line">    <span class="meta">@Bean(&quot;monitorBus&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;liteflow&quot;, name = &quot;monitor.enable-log&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> MonitorBus <span class="title function_">monitorBus</span><span class="params">(LiteflowConfig liteflowConfig, SpringAware springAware)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MonitorBus</span>(liteflowConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º bean çš„åŠ è½½é¡ºåºï¼šLiteflowPropertyAutoConfiguration -&gt;LiteflowConfig -&gt; ComponentScanner &amp; FlowExecutor &amp;MonitorBus -&gt; LiteflowExecutorInit</p><p>LiteflowExecutorInit å’Œ MonitorBus ä¾èµ–ä¸åŒçš„é…ç½®æ¡ä»¶ï¼Œå…¶ä¸­<code>liteflow.parse-on-start</code> é»˜è®¤æ˜¯trueï¼Œ<code>liteflow.monitor.enable-log</code> é»˜è®¤æ˜¯ false</p><h1 id="componentscanner">ComponentScanner</h1><p><code>ComponentScanner</code> åœ¨é¡¹ç›®ä¸­ä¹Ÿè¢«ç¼©å†™ä¸º<code>cmp</code>ï¼Œä¸»è¦æ˜¯ä¾èµ– Spring çš„ <code>BeanPostProcessor</code>æ¥å¯¹ <code>NodeComponent</code>çš„å„ç§å®ç°è¿›è¡Œå‘ç°ã€ä¿å­˜ã€æ‰©å±•ç­‰ä¸€ç³»åˆ—æ“ä½œ</p><h2 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h2><p>é…ç½®ç±»ä¸­ä½¿ç”¨äº†å…¶æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ComponentScanner</span><span class="params">(LiteflowConfig liteflowConfig)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.liteflowConfig = liteflowConfig;</span><br><span class="line">    <span class="keyword">if</span> (liteflowConfig.getPrintBanner()) &#123;</span><br><span class="line">        <span class="comment">// æ‰“å°liteflowçš„LOGO</span></span><br><span class="line">        LOGOPrinter.print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ä¸­ä¸»è¦è¿›è¡Œäº†ä¸¤ä¸ªæ“ä½œï¼š</p><ol type="1"><li><p>å¡«å……å±æ€§ liteflowConfig</p></li><li><p>æ‰“å° LOGOï¼ˆå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ˜¯å¯åŠ¨çš„ç¬¬ä¸€ä¸ª beanï¼‰ï¼›LOGOPrinterå°±æ˜¯ä¸€ä¸ªæ‰“å° LOGO çš„é™æ€æ–¹æ³•å·¥å…·ç±»</p></li></ol><h2 id="beanpostprocessor">BeanPostProcessor</h2><p>æ—¢ç„¶å®ç°äº† <code>BeanPostProcessor</code>æ¥å£ï¼Œé‚£ä¹ˆé‡ç‚¹å°±éœ€è¦å…³æ³¨å…¶å¯¹äº before å’Œ after é’©å­æ–¹æ³•çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComponentScanner</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>before æ–¹æ³•æ˜¯ä¸€ä¸ªç©ºå®ç°ï¼Œé‡ç‚¹å…³æ³¨ after æ–¹æ³•</p><h3 id="å£°æ˜å¼ç»„ä»¶">å£°æ˜å¼ç»„ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯å£°æ˜å¼ç»„ä»¶</span></span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯ï¼Œå°±ç¼“å­˜åˆ°ç±»å±æ€§çš„mapä¸­</span></span><br><span class="line"><span class="keyword">if</span> (LiteFlowProxyUtil.isDeclareCmp(bean.getClass())) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;proxy component[&#123;&#125;] has been found&quot;</span>, beanName);</span><br><span class="line">    List&lt;NodeComponent&gt; nodeComponents = LiteFlowProxyUtil.proxy2NodeComponent(bean, beanName);</span><br><span class="line">    nodeComponents.forEach(</span><br><span class="line">            nodeComponent -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">nodeId</span> <span class="operator">=</span> nodeComponent.getNodeId();</span><br><span class="line">                nodeId = StrUtil.isEmpty(nodeId) ? beanName : nodeId;</span><br><span class="line">                nodeComponentMap.put(nodeId, nodeComponent);</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// åªæœ‰æ³¨è§£æ”¯æŒå•beanå¤šNode,æ‰€ä»¥ä¸€ä¸ªç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (nodeComponents.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> nodeComponents.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä½•åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªå£°æ˜å¼ç»„ä»¶ï¼Œå®ç°æ–¹æ³•æ˜¯<code>LiteFlowProxyUtil.isDeclareCmp</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­ä¸€ä¸ªbeanæ˜¯å¦æ˜¯å£°æ˜å¼ç»„ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDeclareCmp</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="comment">// æŸ¥çœ‹beané‡Œçš„methodæ˜¯å¦æœ‰æ–¹æ³•æ ‡è®°äº†@LiteflowMethodæ ‡æ³¨</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„beanæœ‰å¯èƒ½æ˜¯cglibåŠ å¼ºè¿‡çš„classï¼Œæ‰€ä»¥è¦å…ˆè¿›è¡Œä¸ªåˆ¤æ–­</span></span><br><span class="line">    Class&lt;?&gt; targetClass = getUserClass(clazz);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰æ–¹æ³•æ ‡è®°äº†@LiteflowMethodæ ‡æ³¨ï¼Œæœ‰åˆ™ä¸ºå£°æ˜å¼ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.stream(targetClass.getMethods())</span><br><span class="line">        .anyMatch(method -&gt; method.getAnnotation(LiteflowMethod.class) != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>è·å–çœŸå®çš„ç”¨æˆ·å®šä¹‰ç±»</li><li>åˆ¤æ–­ç±»ä¸­çš„æ–¹æ³•æ˜¯å¦æ ‡è®°äº† <code>@LiteflowMethod</code></li></ol><h3 id="å®ç°ç±»ç»„ä»¶">å®ç°ç±»ç»„ä»¶</h3><p>å®ç°ç±»ç»„ä»¶æœ‰ä¸¤ç§ï¼š</p><ul><li>ç»§æ‰¿è‡ª <code>NodeComponent</code> çš„é€»è¾‘ç»„ä»¶</li><li>å®ç°è‡ª <code>ICmpAroundAspect</code> çš„åˆ‡é¢ç»„ä»¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»„ä»¶çš„æ‰«æå‘ç°ï¼Œæ‰«åˆ°ä¹‹åç¼“å­˜åˆ°ç±»å±æ€§mapä¸­</span></span><br><span class="line"><span class="keyword">if</span> (NodeComponent.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;component[&#123;&#125;] has been found&quot;</span>, beanName);</span><br><span class="line">    <span class="type">NodeComponent</span> <span class="variable">nodeComponent</span> <span class="operator">=</span> (NodeComponent) bean;</span><br><span class="line">    nodeComponentMap.put(beanName, nodeComponent);</span><br><span class="line">    <span class="keyword">return</span> nodeComponent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»„ä»¶Aopçš„å®ç°ç±»åŠ è½½</span></span><br><span class="line"><span class="keyword">if</span> (ICmpAroundAspect.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;component aspect implement[&#123;&#125;] has been found&quot;</span>, beanName);</span><br><span class="line">    cmpAroundAspect = (ICmpAroundAspect) bean;</span><br><span class="line">    <span class="keyword">return</span> cmpAroundAspect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰«æç»„ä»¶çš„é€»è¾‘éƒ½æ˜¯è¿™ç±»æ–¹å¼ï¼š</p><ol type="1"><li>åˆ¤æ–­æ˜¯å¦æ˜¯å…¶å®ç°</li><li>è½¬å‹</li><li>ä¿å­˜åˆ°å¯¹åº”å¼•ç”¨æˆ–å¯¹è±¡</li></ol><p>å¯ä»¥çœ‹åˆ°å¯¹äºé€»è¾‘ç»„ä»¶ï¼Œæ˜¯ä¸€ä¸ª mapç»“æ„ï¼Œå­˜åœ¨å¤šä¸ªç»„ä»¶ï¼›è€Œå¯¹äºåˆ‡é¢ç»„ä»¶ï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ªï¼ˆäº‹å®ä¸Šè¿™æ®µé€»è¾‘æ²¡æœ‰å¯¹å®ç°è¿›è¡Œåˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæœ‰å¤šä¸ªå®ç°çš„bean ä¼šè¿›è¡Œè¦†ç›–ï¼Œæµ‹è¯•ä¸­ä¹Ÿå‘ç°æ˜¯è¿™æ ·ï¼‰</p><h3 id="è„šæœ¬ç»„ä»¶">è„šæœ¬ç»„ä»¶</h3><p>è„šæœ¬ç»„ä»¶ä¹Ÿæœ‰ä¸¤ç§ï¼š</p><ul><li><code>@ScriptBean</code> ä¿®é¥°çš„è„šæœ¬ bean</li><li><code>@ScriptMethod</code> ä¿®é¥°çš„è„šæœ¬æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰«æ@ScriptBeanä¿®é¥°çš„ç±»</span></span><br><span class="line"><span class="type">ScriptBean</span> <span class="variable">scriptBean</span> <span class="operator">=</span> AnnoUtil.getAnnotation(clazz, ScriptBean.class);</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotNull(scriptBean)) &#123;</span><br><span class="line">    <span class="type">ScriptBeanProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptBeanProxy</span>(bean, clazz, scriptBean);</span><br><span class="line">    ScriptBeanManager.addScriptBean(scriptBean.value(), proxy.getProxyScriptBean());</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰«æ@ScriptMethodä¿®é¥°çš„ç±»</span></span><br><span class="line">List&lt;Method&gt; scriptMethods = Arrays.stream(clazz.getMethods()).filter(method -&gt; &#123;</span><br><span class="line">    <span class="type">ScriptMethod</span> <span class="variable">scriptMethod</span> <span class="operator">=</span> AnnoUtil.getAnnotation(method, ScriptMethod.class);</span><br><span class="line">    <span class="keyword">return</span> ObjectUtil.isNotNull(scriptMethod) &amp;&amp; StrUtil.isNotEmpty(scriptMethod.value());</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br><span class="line"><span class="keyword">if</span> (CollUtil.isNotEmpty(scriptMethods)) &#123;</span><br><span class="line">    Map&lt;String, List&lt;Method&gt;&gt; scriptMethodsGroupByValue = CollStreamUtil.groupBy(scriptMethods, method -&gt; &#123;</span><br><span class="line">        <span class="type">ScriptMethod</span> <span class="variable">scriptMethod</span> <span class="operator">=</span> AnnoUtil.getAnnotation(method, ScriptMethod.class);</span><br><span class="line">        <span class="keyword">return</span> scriptMethod.value();</span><br><span class="line">    &#125;, Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;Method&gt;&gt; entry : scriptMethodsGroupByValue.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        List&lt;Method&gt; methods = entry.getValue();</span><br><span class="line">        <span class="type">ScriptMethodProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptMethodProxy</span>(bean, clazz, methods);</span><br><span class="line"></span><br><span class="line">        ScriptBeanManager.addScriptBean(key, proxy.getProxyScriptMethod());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å°†ä¸åŒçš„è„šæœ¬å½¢å¼åŒ…è£…æˆä»£ç†ç±»ï¼Œè½¬æ¢æˆ bean åæ”¾å…¥<code>ScriptBeanManager</code> è¿›è¡Œç®¡ç†</p><p>è½¬æ¢çš„æ ¸å¿ƒåœ¨ <code>getProxyScriptMethod</code>æ–¹æ³•ï¼Œè¿™ä¸ªä¼šåœ¨è„šæœ¬ç›¸å…³æºç ä¸­è¿›ä¸€æ­¥åˆ†æ</p><h1 id="flowexecutor">FlowExecutor</h1><p>æµç¨‹è§„åˆ™ä¸»è¦æ‰§è¡Œå™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè§„åˆ™è¡¨æ‰§è¡Œçš„ä¸»è¦å…¥å£</p><p>è¿™é‡Œä¸»è¦å…³æ³¨å…¶æ„é€ æµç¨‹ï¼Œåˆå§‹åŒ–åœ¨åé¢çš„<code>LiteflowExecutorInit</code> ä¸­è®²è§£</p><h2 id="æ„é€ æ–¹æ³•-1">æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FlowExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®FlowExecutorçš„Holderï¼Œè™½ç„¶å¤§éƒ¨åˆ†åœ°æ–¹éƒ½å¯ä»¥é€šè¿‡Springä¸Šä¸‹æ–‡è·å–åˆ°ï¼Œä½†æ”¾å…¥Holderï¼Œè¿˜æ˜¯ä¸ºäº†æŸäº›åœ°æ–¹èƒ½æ–¹ä¾¿çš„å–åˆ°</span></span><br><span class="line">    FlowExecutorHolder.setHolder(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–DataBus</span></span><br><span class="line">    DataBus.init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FlowExecutor</span><span class="params">(LiteflowConfig liteflowConfig)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.liteflowConfig = liteflowConfig;</span><br><span class="line">    <span class="comment">// æŠŠliteFlowConfigè®¾åˆ°LiteFlowGetterä¸­å»</span></span><br><span class="line">    LiteflowConfigGetter.setLiteflowConfig(liteflowConfig);</span><br><span class="line">    <span class="comment">// è®¾ç½®FlowExecutorçš„Holderï¼Œè™½ç„¶å¤§éƒ¨åˆ†åœ°æ–¹éƒ½å¯ä»¥é€šè¿‡Springä¸Šä¸‹æ–‡è·å–åˆ°ï¼Œä½†æ”¾å…¥Holderï¼Œè¿˜æ˜¯ä¸ºäº†æŸäº›åœ°æ–¹èƒ½æ–¹ä¾¿çš„å–åˆ°</span></span><br><span class="line">    FlowExecutorHolder.setHolder(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (BooleanUtil.isTrue(liteflowConfig.isParseOnStart())) &#123;</span><br><span class="line">        <span class="built_in">this</span>.init(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–DataBus</span></span><br><span class="line">    DataBus.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº Spring çš„å¯åŠ¨æ–¹å¼ï¼Œä½¿ç”¨äº†æ— å‚æ„é€ ï¼Œéšåå°† liteflowConfig ç”¨ setæ–¹æ³•è¿›è¡Œèµ‹å€¼ï¼Œå¸¦æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•åº”è¯¥æ˜¯ä¸ºäº†é Spring ç¯å¢ƒå‡†å¤‡çš„ï¼Œå› ä¸ºåœ¨Spring ç¯å¢ƒä¸­ liteflowConfig ä½¿ç”¨äº† properties çš„æœºåˆ¶ï¼Œè€Œ FlowExecutoré€šè¿‡ <code>@Bean</code> è¿›è¡Œå®ä¾‹åŒ–</p><p>å¯ä»¥çœ‹åˆ°æ— å‚æ„é€ ä¸­ä¸»è¦è¿›è¡Œäº† <code>DataBus.init()</code> æ“ä½œ</p><h2 id="databus">DataBus</h2><p>æ•°æ® BUSï¼Œä¸»è¦ç”¨æ¥ç®¡ç† Slotï¼Œç”¨ä»¥åˆ†é…å’Œå›æ”¶</p><p>Slotå³æ•´ä¸ªè§„åˆ™æµç¨‹è°ƒç”¨æ—¶çš„ç®¡ç†è€…ï¼Œä¿å­˜äº†æ•´ä¸ªè§„åˆ™è¿›è¡Œä¸­çš„æ•°æ®ã€ç»„ä»¶æ­¥éª¤ç­‰ä¿¡æ¯ï¼Œæ¯ä¸€æ¬¡è°ƒç”¨ä¼šç”Ÿæˆæ–°çš„Slotï¼Œå¹¶ä¸”äº’ç›¸éš”ç¦»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer, Slot&gt; SLOTS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentLinkedQueue&lt;Integer&gt; QUEUE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ SLOTS æ²¡æœ‰åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (MapUtil.isEmpty(SLOTS)) &#123;</span><br><span class="line">        <span class="comment">// è·å– liteflowConfigï¼Œåœ¨ Spring ç¯å¢ƒä¸­è¿™é‡Œä¼šä½¿ç”¨å·²ç»æ³¨å…¥çš„ SpringAware ä» ApplicationContext ä¸­è·å–</span></span><br><span class="line">        <span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> LiteflowConfigGetter.get();</span><br><span class="line">        <span class="comment">// ä»é…ç½®ä¸­è·å– slot size å‚æ•°</span></span><br><span class="line">        currentIndexMaxValue = liteflowConfig.getSlotSize();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– SLOTS</span></span><br><span class="line">        SLOTS = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– QUEUE</span></span><br><span class="line">        QUEUE = IntStream.range(<span class="number">0</span>, currentIndexMaxValue)</span><br><span class="line">            .boxed()</span><br><span class="line">            .collect(Collectors.toCollection(ConcurrentLinkedQueue::<span class="keyword">new</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ SLOTS ç”¨æ¥ä¿å­˜åˆ†é…çš„åºå·å’Œ Slot å¯¹è±¡ï¼ŒQUEUE åˆ™æ˜¯ç”¨æ¥ä¿å­˜index</p><p>å³åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿåˆ†é…çš„è¿è¡Œèµ„æ ¼ç”± QUEUE æ§åˆ¶ï¼ŒQUEUEä¼šæ ¹æ®å¹¶å‘æƒ…å†µè¿›è¡Œæ‰©å®¹ï¼Œå…·ä½“çš„èµ„æ ¼ç”± 0 ~ n çš„ int å€¼æ¥è¡¨ç¤º</p><h1 id="liteflowexecutorinit">LiteflowExecutorInit</h1><p>æ‰§è¡Œå™¨åˆå§‹åŒ–ç±»ï¼Œä¸»è¦ç”¨äºåœ¨å¯åŠ¨æ—¶æ‰§è¡Œæ‰§è¡Œå™¨çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œé¿å…åœ¨è¿è¡Œæ‰§è¡Œå™¨æ—¶ç¬¬ä¸€æ¬¡åˆå§‹åŒ–è€Œè€—è´¹æ—¶é—´</p><p>è¯¥ç±»å®ä¾‹åŒ–çš„æ„ä¹‰å°±æ˜¯æ§åˆ¶ä¸Šé¢å¯¹è±¡ FlowExecutorçš„åˆå§‹åŒ–æ“ä½œï¼Œå¦‚æœä¸åœ¨é…ç½®ä¸­è®¾ç½®å¯åŠ¨åˆå§‹åŒ–ï¼Œåˆ™ FlowExecutorçš„åˆå§‹åŒ–å·¥ä½œä¼šæ”¾åœ¨è°ƒç”¨æ—¶è¿›è¡Œ<code>@ConditionalOnProperty(prefix = "liteflow", name = "parse-on-start", havingValue = "true")</code></p><h2 id="æ„é€ æ–¹æ³•-2">æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiteflowExecutorInit</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FlowExecutor flowExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LiteflowExecutorInit</span><span class="params">(FlowExecutor flowExecutor)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.flowExecutor = flowExecutor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">flowExecutor.init(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç±»å®ç°äº† Spring é’©å­ InitializingBeanï¼ŒafterPropertiesSet è¿›è¡Œ<code>FlowExecutor</code> çš„åˆå§‹åŒ–æ“ä½œ</p><h2 id="flowexecutor-çš„-init">FlowExecutor çš„ init</h2><p><code>LiteflowExecutorInit</code> çš„å®ä¾‹åŒ–æ˜¯ä¸ºäº† init<code>FlowExecutor</code>ï¼Œè€Œ <code>FlowExecutor</code>çš„åˆå§‹åŒ–ä¸»è¦ç›®çš„æ˜¯ parse è§„åˆ™æ–‡ä»¶</p><h3 id="id-ç”Ÿæˆå™¨">ID ç”Ÿæˆå™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿›è¡Œidç”Ÿæˆå™¨çš„åˆå§‹åŒ–</span></span><br><span class="line">IdGeneratorHolder.init();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å•ä¾‹åˆ›å»º</span></span><br><span class="line">    INSTANCE = <span class="keyword">new</span> <span class="title class_">IdGeneratorHolder</span>();</span><br><span class="line">    <span class="type">LiteflowConfig</span> <span class="variable">liteflowConfig</span> <span class="operator">=</span> LiteflowConfigGetter.get();</span><br><span class="line">    <span class="comment">// è·å–é…ç½®é¡¹ä¸­çš„ç”Ÿæˆå™¨ç±»è·¯å¾„</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestIdGeneratorClass</span> <span class="operator">=</span> liteflowConfig.getRequestIdGeneratorClass();</span><br><span class="line"></span><br><span class="line">    RequestIdGenerator requestIdGenerator;</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(requestIdGeneratorClass)) &#123;</span><br><span class="line">      <span class="comment">// é»˜è®¤ä¸º DefaultRequestIdGenerator</span></span><br><span class="line">      requestIdGenerator = <span class="keyword">new</span> <span class="title class_">DefaultRequestIdGenerator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å®ä¾‹åŒ–è‡ªå®šä¹‰ç”Ÿæˆå™¨</span></span><br><span class="line">      Class&lt;RequestIdGenerator&gt; idGenerateClass = (Class&lt;RequestIdGenerator&gt;) Class</span><br><span class="line">        .forName(requestIdGeneratorClass);</span><br><span class="line">      <span class="comment">// æ³¨å†Œè¿› bean å®¹å™¨</span></span><br><span class="line">      requestIdGenerator = ContextAwareHolder.loadContextAware().registerBean(idGenerateClass);</span><br><span class="line">    &#125;</span><br><span class="line">    INSTANCE.setRequestIdGenerator(requestIdGenerator);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RequestIdGeneratorException</span>(e.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>IdGeneratorHolder</code> ç”¨äºä¿å­˜å®ä¾‹åŒ–åçš„ ID ç”Ÿæˆå™¨<code>RequestIdGenerator</code>ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹</p><p>åŸºæœ¬æµç¨‹å°±æ˜¯è·å–é…ç½®é¡¹ä¸Šçš„ç”Ÿæˆå™¨ç±»è·¯å¾„ï¼Œç„¶åé€šè¿‡åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¿å­˜åˆ°<code>IdGeneratorHolder</code>è¿™ä¸ªè§’è‰²ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¿›è¡Œé…ç½®åˆ™ä½¿ç”¨é»˜è®¤å®ç°<code>DefaultRequestIdGenerator</code></p><p><strong>é»˜è®¤å®ç° DefaultRequestIdGenerator</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultRequestIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">RequestIdGenerator</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> IdUtil.fastSimpleUUID();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hutool ä¸‹çš„ç®€å• UUID ç”Ÿæˆ</p><h3 id="è§„åˆ™æ–‡ä»¶æºè·¯å¾„">è§„åˆ™æ–‡ä»¶æºè·¯å¾„</h3><p>åœ¨ä¸Šé¢æµç¨‹ä¸­åŠ è½½äº†é€»è¾‘ç»„ä»¶ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£æè§„åˆ™è¡¨</p><p><strong>è§„åˆ™è·¯å¾„ä¸ºç©º</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">ruleSource</span> <span class="operator">=</span> liteflowConfig.getRuleSource();</span><br><span class="line"><span class="keyword">if</span> (StrUtil.isBlank(ruleSource)) &#123;</span><br><span class="line">   <span class="comment">// æŸ¥çœ‹æœ‰æ²¡æœ‰Parserçš„SPIå®ç°</span></span><br><span class="line">   <span class="comment">// æ‰€æœ‰çš„Parserçš„SPIå®ç°éƒ½æ˜¯ä»¥customå½¢å¼æ”¾å…¥çš„ï¼Œä¸”åªæ”¯æŒxmlå½¢å¼</span></span><br><span class="line">   ServiceLoader&lt;ParserClassNameSpi&gt; loader = ServiceLoader.load(ParserClassNameSpi.class);</span><br><span class="line">   Iterator&lt;ParserClassNameSpi&gt; it = loader.iterator();</span><br><span class="line">   <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">      <span class="type">ParserClassNameSpi</span> <span class="variable">parserClassNameSpi</span> <span class="operator">=</span> it.next();</span><br><span class="line">      ruleSource = <span class="string">&quot;el_xml:&quot;</span> + parserClassNameSpi.getSpiClassName();</span><br><span class="line">      liteflowConfig.setRuleSource(ruleSource);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ruleSourceä¸ºç©ºï¼Œè€Œä¸”æ²¡æœ‰spiå½¢å¼çš„æ‰©å±•ï¼Œé‚£ä¹ˆè¯´æ˜çœŸçš„æ²¡æœ‰ruleSource</span></span><br><span class="line">      <span class="comment">// è¿™ç§æƒ…å†µæœ‰å¯èƒ½æ˜¯åŸºäºä»£ç åŠ¨æ€æ„å»ºçš„</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€å—é€»è¾‘æ˜¯åœ¨åˆ¤æ–­å½“é…ç½®æ–‡ä»¶çš„è§„åˆ™æºè·¯å¾„ä¸ºç©ºçš„æƒ…å†µï¼Œæ­¤æ—¶ä¼šä½¿ç”¨ SPIå·¥å…· <code>ServiceLoader</code>å»åŠ è½½è‡ªå®šä¹‰å®ç°çš„è§„åˆ™åŠ è½½å™¨å»æ”¾ç½®æ–°çš„è§„åˆ™è·¯å¾„</p><p><strong>é¡¹ç›®æ–‡ä»¶å’Œæœ¬åœ°æ–‡ä»¶</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæœ‰å‰ç¼€çš„ï¼Œåˆ™ä¸éœ€è¦å†è¿›è¡Œåˆ†å‰²äº†ï¼Œè¯´æ˜æ˜¯ä¸€ä¸ªæ•´ä½“</span></span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰å‰ç¼€ï¼Œè¯´æ˜æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œå¯èƒ½é…ç½®å¤šä¸ªï¼Œæ‰€ä»¥éœ€è¦åˆ†å‰²</span></span><br><span class="line">List&lt;String&gt; sourceRulePathList;</span><br><span class="line"><span class="keyword">if</span> (ReUtil.contains(PREFIX_FORMAT_CONFIG_REGEX, ruleSource)) &#123;</span><br><span class="line">   sourceRulePathList = ListUtil.toList(ruleSource);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="type">String</span> <span class="variable">afterHandleRuleSource</span> <span class="operator">=</span> ruleSource.replace(StrUtil.SPACE, StrUtil.EMPTY);</span><br><span class="line">   sourceRulePathList = ListUtil.toList(afterHandleRuleSource.split(<span class="string">&quot;,|;&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LiteFlowçš„ç‰¹æ€§å¯ä»¥æ”¯æŒä»æœ¬åœ°æ–‡ä»¶åŠ è½½è§„åˆ™ï¼Œæ‰€ä»¥åœ¨æ­¤å¤„åˆ¤æ–­è§„åˆ™æ˜¯æ¥æºäºé¡¹ç›®æ–‡ä»¶è¿˜æ˜¯æœ¬åœ°æ–‡ä»¶</p><p>æ ¹æ®è§„åˆ™å‰ç¼€<code>String PREFIX_FORMAT_CONFIG_REGEX = "xml:|json:|yml:|el_xml:|el_json:|el_yml:"</code>çš„æ­£åˆ™æ¥åŒ¹é…ï¼›å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶åˆ™æ ¹æ® <code>,|;</code> æ¥è¿›è¡Œåˆ†å‰²</p><p>å°†è§„åˆ™æ–‡ä»¶çš„è·¯å¾„éƒ½æ”¾ç½®åœ¨ <code>sourceRulePathList</code>è¿™ä¸ªé›†åˆä¸­</p><h3 id="è§„åˆ™æ–‡ä»¶è§£æ">è§„åˆ™æ–‡ä»¶è§£æ</h3><p>è·å–è§„åˆ™æºåè¦å¯¹è§„åˆ™æ–‡ä»¶è¿›è¡Œè§£æ</p><h4 id="å¤åˆè§„åˆ™é…ç½®">å¤åˆè§„åˆ™é…ç½®</h4><p>è¿™é‡Œåº”è¯¥æ˜¯å®ç°ä¸åŒæ ¼å¼è§„åˆ™åŠ è½½çš„ç‰¹æ€§ï¼Œéœ€è¦è¿›è¡Œç›¸å…³é…ç½®<code>supportMultipleType</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FlowParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">Set&lt;String&gt; parserNameSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; rulePathList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String path : sourceRulePathList) &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æŸ¥æ‰¾å¯¹åº”çš„è§£æå™¨</span></span><br><span class="line">      parser = FlowParserProvider.lookup(path);</span><br><span class="line">      parserNameSet.add(parser.getClass().getName());</span><br><span class="line">      <span class="comment">// æ›¿æ¢æ‰å‰ç¼€æ ‡è¯†ï¼ˆå¦‚ï¼šxml:/json:ï¼‰ï¼Œä¿ç•™å‰©ä¸‹çš„å®Œæ•´åœ°å€</span></span><br><span class="line">      path = ReUtil.replaceAll(path, PREFIX_FORMAT_CONFIG_REGEX, <span class="string">&quot;&quot;</span>);</span><br><span class="line">      rulePathList.add(path);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ”¯æŒå¤šç±»å‹çš„é…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«è§£æ</span></span><br><span class="line">      <span class="keyword">if</span> (BooleanUtil.isTrue(liteflowConfig.isSupportMultipleType())) &#123;</span><br><span class="line">         <span class="comment">// è§£ææ–‡ä»¶</span></span><br><span class="line">         parser.parseMain(ListUtil.toList(path));</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (CyclicDependencyException e) &#123;</span><br><span class="line">      LOG.error(e.getMessage());</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;init flow executor cause error for path &#123;&#125;,reason:&#123;&#125;&quot;</span>, path,</span><br><span class="line">            e.getMessage());</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowExecutorNotInitException</span>(errorMsg);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>éå†è§„åˆ™è·¯å¾„ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„è§£æå™¨</li><li>è®°å½•è§£æå™¨ç±»åï¼ˆä¸»è¦æ˜¯ç”¨äºåç»­éå¤šç±»å‹è§£æå™¨åˆ¤æ–­ä½¿ç”¨ï¼‰</li><li>è·¯å¾„æ”¾å…¥è§„åˆ™è·¯å¾„é›†åˆ</li><li>å¦‚æœæ”¯æŒå¤šç±»å‹é…ç½®æ–‡ä»¶è§£æï¼Œåˆ™ç›´æ¥è¿›è¡Œè§£æ<code>parser.parseMain(ListUtil.toList(path))</code></li><li>catch å¼‚å¸¸ï¼Œæ‰“å°æ—¥å¿—</li></ol><h4 id="å•ç±»å‹é…ç½®">å•ç±»å‹é…ç½®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•ç±»å‹çš„é…ç½®æ–‡ä»¶ï¼Œéœ€è¦ä¸€èµ·è§£æ</span></span><br><span class="line"><span class="keyword">if</span> (BooleanUtil.isFalse(liteflowConfig.isSupportMultipleType())) &#123;</span><br><span class="line">   <span class="comment">// æ£€æŸ¥Parseræ˜¯å¦åªæœ‰ä¸€ä¸ªï¼Œå› ä¸ºå¤šä¸ªä¸åŒçš„parserä¼šé€ æˆå­æµç¨‹çš„æ··ä¹±</span></span><br><span class="line">   <span class="keyword">if</span> (parserNameSet.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> <span class="string">&quot;cannot have multiple different parsers&quot;</span>;</span><br><span class="line">      LOG.error(errorMsg);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MultipleParsersException</span>(errorMsg);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¿›è¡Œå¤šä¸ªé…ç½®æ–‡ä»¶çš„ä¸€èµ·è§£æ</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (parser != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// è§£ææ–‡ä»¶</span></span><br><span class="line">         parser.parseMain(rulePathList);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConfigErrorException</span>(<span class="string">&quot;parse error, please check liteflow config property&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (CyclicDependencyException e) &#123;</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      LOG.error(e.getMessage());</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ChainDuplicateException e) &#123;</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> StrUtil.format(<span class="string">&quot;init flow executor cause error for path &#123;&#125;,reason: &#123;&#125;&quot;</span>, rulePathList,</span><br><span class="line">            e.getMessage());</span><br><span class="line">      LOG.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowExecutorNotInitException</span>(errorMsg);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å•ç±»å‹çš„æµç¨‹ä¸»è¦é’ˆå¯¹è§£æå™¨æ•°é‡è¿›è¡Œäº†åˆ¤æ–­ï¼Œä¹Ÿæ˜¯ä½¿ç”¨<code>parser.parseMain(ListUtil.toList(path))</code> è¿›å…¥è§£ææµç¨‹</p><h4 id="è§£æå™¨">è§£æå™¨</h4><p>è¿™é‡Œä¸»è¦å…ˆæ¥çœ‹ <code>LocalXmlFlowELParser</code> çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalXmlFlowELParser</span> <span class="keyword">extends</span> <span class="title class_">XmlFlowELParser</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseMain</span><span class="params">(List&lt;String&gt; pathList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      List&lt;String&gt; contentList = PathContentParserHolder.loadContextAware().parseContent(pathList);</span><br><span class="line">      parse(contentList);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PathContentParserHolder.loadContextAware().parseContent(pathList)</code>çš„æ“ä½œç”¨äºè·å–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå³è§„åˆ™çš„ ELè¡¨è¾¾å¼ç­‰ï¼ˆå°±æ˜¯è¯»æ–‡ä»¶ï¼Œä¸è¿‡ä¼šæ ¹æ®ä¸åŒç¯å¢ƒé€‰æ‹©ä¸åŒçš„å®ç°ï¼‰</p><p>æœ€åæ‰§è¡Œ <code>BaseXmlFlowParser</code> æŠ½è±¡ç±»æä¾›çš„<code>parse</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(List&lt;String&gt; contentList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   <span class="keyword">if</span> (CollectionUtil.isEmpty(contentList)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   List&lt;Document&gt; documentList = ListUtil.toList();</span><br><span class="line">   <span class="keyword">for</span> (String content : contentList) &#123;</span><br><span class="line">      <span class="comment">// è§£æ XML org.dom4j.DocumentHelperï¼Œè½¬æ¢ä¸º Document å¯¹è±¡</span></span><br><span class="line">      <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> DocumentHelper.parseText(content);</span><br><span class="line">      documentList.add(document);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// è§£æ node</span></span><br><span class="line">   ParserHelper.parseNodeDocument(documentList);</span><br><span class="line">   <span class="comment">// è§£æ chain</span></span><br><span class="line">   ParserHelper.parseChainDocument(documentList, CHAIN_NAME_SET, <span class="built_in">this</span>::parseOneChain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="parserhelper">ParserHelper</h4><p>ä»¥ <code>XML</code> æ ¼å¼çš„è§„åˆ™è¡¨è¾¾ä¸ºä¾‹</p><p><strong>è§£æ node</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xml å½¢å¼çš„ä¸»è¦è§£æè¿‡ç¨‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> documentList documentList</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parseNodeDocument</span><span class="params">(List&lt;Document&gt; documentList)</span> &#123;</span><br><span class="line">   <span class="keyword">for</span> (Document document : documentList) &#123;</span><br><span class="line">      <span class="comment">// è·å– root æ ‡ç­¾</span></span><br><span class="line">      <span class="type">Element</span> <span class="variable">rootElement</span> <span class="operator">=</span> document.getRootElement();</span><br><span class="line">      <span class="comment">// è·å– nodes æ ‡ç­¾</span></span><br><span class="line">      <span class="type">Element</span> <span class="variable">nodesElement</span> <span class="operator">=</span> rootElement.element(NODES);</span><br><span class="line">      <span class="comment">// å½“å­˜åœ¨&lt;nodes&gt;èŠ‚ç‚¹å®šä¹‰æ—¶ï¼Œè§£ænodeèŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (ObjectUtil.isNotNull(nodesElement)) &#123;</span><br><span class="line">         List&lt;Element&gt; nodeList = nodesElement.elements(NODE);</span><br><span class="line">         String id, name, clazz, type, script, file, language;</span><br><span class="line">         <span class="keyword">for</span> (Element e : nodeList) &#123;</span><br><span class="line">            id = e.attributeValue(ID);</span><br><span class="line">            name = e.attributeValue(NAME);</span><br><span class="line">            clazz = e.attributeValue(_CLASS);</span><br><span class="line">            type = e.attributeValue(TYPE);</span><br><span class="line">            script = e.getText();</span><br><span class="line">            file = e.attributeValue(FILE);</span><br><span class="line">            language = e.attributeValue(LANGUAGE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ„å»º node</span></span><br><span class="line">            <span class="type">NodePropBean</span> <span class="variable">nodePropBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NodePropBean</span>().setId(id)</span><br><span class="line">               .setName(name)</span><br><span class="line">               .setClazz(clazz)</span><br><span class="line">               .setScript(script)</span><br><span class="line">               .setType(type)</span><br><span class="line">               .setFile(file)</span><br><span class="line">               .setLanguage(language);</span><br><span class="line"></span><br><span class="line">            ParserHelper.buildNode(nodePropBean);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>ä»é…ç½®çš„ <code>XML</code> è§„åˆ™ä¸­è§£ææ ‡ç­¾</li><li>æ‰¾åˆ° <code>nodes</code> çš„æ ‡ç­¾ï¼›name å¸¸é‡å®šä¹‰åœ¨<code>ChainConstant.NODES</code></li><li>éå† <code>nodes</code> ä¸‹é¢çš„æ¯ä¸€ä¸ª <code>node</code> æ ‡ç­¾ï¼Œæ„å»º<code>NodePropBean</code> node å¯¹è±¡</li><li><code>ParserHelper.buildNode(nodePropBean)</code>å¼€å§‹è§£æèŠ‚ç‚¹ï¼Œè§£æå®Œæˆåä¼šæ”¾ç½®åœ¨ <code>FlowBus</code>ä¸­ï¼ˆè§£æè¿‡ç¨‹ä¸­è¿˜åœ¨åˆ†è¾¨æ˜¯æ™®é€šèŠ‚ç‚¹è¿˜æ˜¯è„šæœ¬èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ”¾åˆ°è„šæœ¬ç›¸å…³æºç ä¸­å†çœ‹ï¼‰</li></ol><p><strong>è§£æ chain</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parseChainDocument</span><span class="params">(List&lt;Document&gt; documentList, Set&lt;String&gt; chainNameSet,</span></span><br><span class="line"><span class="params">      Consumer&lt;Element&gt; parseOneChainConsumer)</span> &#123;</span><br><span class="line">   <span class="comment">// å…ˆåœ¨å…ƒæ•°æ®é‡Œæ”¾ä¸Šchain</span></span><br><span class="line">   <span class="comment">// å…ˆæ”¾æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå¯ä»¥åœ¨parseçš„æ—¶å€™å…ˆæ˜ å°„åˆ°FlowBusçš„chainMapï¼Œç„¶åå†å»è§£æ</span></span><br><span class="line">   <span class="comment">// è¿™æ ·å°±ä¸ç”¨å»åƒä¹‹å‰çš„ç‰ˆæœ¬é‚£æ ·å›å½’è°ƒç”¨</span></span><br><span class="line">   <span class="comment">// åŒæ—¶ä¹Ÿè§£å†³äº†ä¸èƒ½å¾ªç¯ä¾èµ–çš„é—®é¢˜</span></span><br><span class="line">   documentList.forEach(document -&gt; &#123;</span><br><span class="line">      <span class="comment">// è§£æchainèŠ‚ç‚¹</span></span><br><span class="line">      List&lt;Element&gt; chainList = document.getRootElement().elements(CHAIN);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å…ˆåœ¨å…ƒæ•°æ®é‡Œæ”¾ä¸Šchain</span></span><br><span class="line">      chainList.forEach(e -&gt; &#123;</span><br><span class="line">         <span class="comment">// æ ¡éªŒåŠ è½½çš„ chainName æ˜¯å¦æœ‰é‡å¤çš„</span></span><br><span class="line">         <span class="comment">// TODO è¿™é‡Œæ˜¯å¦æœ‰ä¸ªé—®é¢˜ï¼Œå½“æ··åˆæ ¼å¼åŠ è½½çš„æ—¶å€™ï¼Œ2ä¸ªåŒåçš„Chainåœ¨ä¸åŒçš„æ–‡ä»¶é‡Œï¼Œå°±ä¸è¡Œäº†</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">chainName</span> <span class="operator">=</span> Optional.ofNullable(e.attributeValue(ID)).orElse(e.attributeValue(NAME));</span><br><span class="line">         <span class="keyword">if</span> (!chainNameSet.add(chainName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChainDuplicateException</span>(String.format(<span class="string">&quot;[chain name duplicate] chainName=%s&quot;</span>, chainName));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         FlowBus.addChain(chainName);</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="comment">// æ¸…ç©º</span></span><br><span class="line">   chainNameSet.clear();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è§£ææ¯ä¸€ä¸ªchain</span></span><br><span class="line">   <span class="keyword">for</span> (Document document : documentList) &#123;</span><br><span class="line">      <span class="type">Element</span> <span class="variable">rootElement</span> <span class="operator">=</span> document.getRootElement();</span><br><span class="line">      List&lt;Element&gt; chainList = rootElement.elements(CHAIN);</span><br><span class="line">      chainList.forEach(parseOneChainConsumer);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>ä» <code>XML</code> è§„åˆ™ä¸­è§£æ <code>chain</code> æ ‡ç­¾</li><li>éå†æ ‡ç­¾å¤„ç† chain æ•°æ®</li><li>è·å– chainNameï¼Œè§„åˆ™ä¸ºå¦‚æœæ²¡æœ‰é…ç½®ç‹¬ç«‹çš„ id å°±ä½¿ç”¨ name</li><li>åŠ å…¥ chainNameSetï¼Œå¦‚æœ nameé‡å¤åˆ™æŠ›å‡ºå¼‚å¸¸ï¼ˆè¿™ç§æ–¹å¼æ— æ³•å¤„ç†å¤šæ–‡ä»¶çš„é‡å¤é—®é¢˜ï¼Œæˆ‘ç†è§£å¸¦æ¥çš„å½±å“å°±æ˜¯ä¼šå¯¼è‡´è§£æçš„chain è¢«è¦†ç›–ï¼‰</li><li>å…ˆå°† name åŠ å…¥å…ƒæ•°æ®ç®¡ç†ç±»<code>FlowBus</code>ï¼›è¿™ä¸ªæµç¨‹æ˜¯é¢„è£…è½½ï¼Œå…¶å…ƒæ•°æ®ç®¡ç†ä¸­çš„ map valueæ˜¯å ä½å¯¹è±¡</li><li>éå† chain æ ‡ç­¾ï¼Œè°ƒç”¨ä¼ å…¥çš„ <code>Consumer</code>æ–¹æ³•å¼€å§‹è§£æï¼›<code>Consumer</code> æ–¹æ³•ä¸º <code>Parser</code> å®ç°çš„<code>parseOneChain</code> æ–¹æ³•</li></ol><h4 id="el-è§„åˆ™ç»„è£…å™¨">EL è§„åˆ™ç»„è£…å™¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parseOneChainEl</span><span class="params">(JsonNode chainNode)</span> &#123;</span><br><span class="line">   <span class="comment">// æ„å»ºchainBuilder</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">chainId</span> <span class="operator">=</span> Optional.ofNullable(chainNode.get(ID)).orElse(chainNode.get(NAME)).textValue();</span><br><span class="line">   <span class="type">String</span> <span class="variable">el</span> <span class="operator">=</span> chainNode.get(VALUE).textValue();</span><br><span class="line">   <span class="type">LiteFlowChainELBuilder</span> <span class="variable">chainELBuilder</span> <span class="operator">=</span> LiteFlowChainELBuilder.createChain().setChainId(chainId);</span><br><span class="line">   chainELBuilder.setEL(el).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>parseOneChainEl</code> åä¸»è¦æ˜¯è·å– el è§„åˆ™ï¼Œåˆ›å»º<code>LiteFlowChainELBuilder</code> å¯¹è±¡ååœ¨ <code>setEL</code>çš„æ­¥éª¤ä¸­ä¼šè¿›è¡Œ EL è§„åˆ™çš„è§£æï¼Œæœ€ç»ˆè¿”å›<code>List&lt;Condition&gt; conditionList</code></p><p>è§„åˆ™çš„è§£æä½¿ç”¨äº†é˜¿é‡Œå¼€æºçš„ QLExpressï¼Œåé¢ä¼šå•ç‹¬ä¸€ç¯‡æ¥è®²è§£</p><p>åŸºæœ¬ä¸Šåˆ°è¿™é‡Œï¼Œç›¸å…³çš„æ‰§è¡Œç»„ä»¶å°±å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†</p><p>åç»­å…·ä½“çš„æ‰§è¡Œå°±æ˜¯è·å– <code>Chain</code> å¯¹è±¡çš„<code>conditionList</code>ï¼Œéå† list è¿›è¡Œæ‰§è¡Œ</p><h1 id="monitorbus">MonitorBus</h1><p>ç›‘æ§ç±»å…ƒæ•°æ®ï¼Œæ‰“å°æ‰§è¡Œå™¨ç±»</p><p>éœ€è¦é…ç½® condition å‚æ•° <code>monitor.enable-log</code></p><h2 id="æ„é€ æ–¹æ³•-3">æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šæ—¶çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">printLogScheduler</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MonitorBus</span><span class="params">(LiteflowConfig liteflowConfig)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>.liteflowConfig = liteflowConfig;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (BooleanUtil.isTrue(liteflowConfig.getEnableLog())) &#123;</span><br><span class="line">      <span class="built_in">this</span>.printLogScheduler.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">MonitorTimeTask</span>(<span class="built_in">this</span>), liteflowConfig.getDelay(),</span><br><span class="line">            liteflowConfig.getPeriod(), TimeUnit.MILLISECONDS);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘å®šæ—¶çº¿ç¨‹æ± è®¾ç½®ä»»åŠ¡ï¼Œä»»åŠ¡ä¸º<code>new MonitorTimeTask(this)</code>ï¼Œæ˜¯ä¸€ä¸ª<code>TimerTask</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorTimeTask</span> <span class="keyword">extends</span> <span class="title class_">TimerTask</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MonitorBus monitorBus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MonitorTimeTask</span><span class="params">(MonitorBus monitorBus)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.monitorBus = monitorBus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">monitorBus.printStatistics();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>run</code> æ–¹æ³•ä¸ºè°ƒç”¨<code>MonitorBus.printStatistics</code></p><h2 id="æ‰“å°ç»Ÿè®¡æ•°æ®">æ‰“å°ç»Ÿè®¡æ•°æ®</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, BoundedPriorityBlockingQueue&lt;CompStatistics&gt;&gt; statisticsMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printStatistics</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Map&lt;String, BigDecimal&gt; compAverageTimeSpent = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, BigDecimal&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Entry&lt;String, BoundedPriorityBlockingQueue&lt;CompStatistics&gt;&gt; entry : statisticsMap.entrySet()) &#123;</span><br><span class="line">         <span class="type">long</span> <span class="variable">totalTimeSpent</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">for</span> (CompStatistics statistics : entry.getValue()) &#123;</span><br><span class="line">            totalTimeSpent += statistics.getTimeSpent();</span><br><span class="line">         &#125;</span><br><span class="line">         compAverageTimeSpent.put(entry.getKey(), <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(totalTimeSpent)</span><br><span class="line">            .divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(entry.getValue().size()), <span class="number">2</span>, RoundingMode.HALF_UP));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      List&lt;Entry&lt;String, BigDecimal&gt;&gt; compAverageTimeSpentEntryList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">            compAverageTimeSpent.entrySet());</span><br><span class="line"></span><br><span class="line">      Collections.sort(compAverageTimeSpentEntryList, (o1, o2) -&gt; o2.getValue().compareTo(o1.getValue()));</span><br><span class="line"></span><br><span class="line">      <span class="type">StringBuilder</span> <span class="variable">logStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">      logStr.append(<span class="string">&quot;ä»¥ä¸‹ä¸ºLiteFlowä¸­é—´ä»¶ç»Ÿè®¡ä¿¡æ¯ï¼š\n&quot;</span>);</span><br><span class="line">      logStr.append(<span class="string">&quot;======================================================================================\n&quot;</span>);</span><br><span class="line">      logStr.append(<span class="string">&quot;===================================SLOT INFO==========================================\n&quot;</span>);</span><br><span class="line">      logStr.append(MessageFormat.format(<span class="string">&quot;SLOT TOTAL SIZE : &#123;0&#125;\n&quot;</span>, liteflowConfig.getSlotSize()));</span><br><span class="line">      logStr.append(MessageFormat.format(<span class="string">&quot;SLOT OCCUPY COUNT : &#123;0&#125;\n&quot;</span>, DataBus.OCCUPY_COUNT));</span><br><span class="line">      logStr.append(<span class="string">&quot;===============================TIME AVERAGE SPENT=====================================\n&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (Entry&lt;String, BigDecimal&gt; entry : compAverageTimeSpentEntryList) &#123;</span><br><span class="line">         logStr.append(MessageFormat.format(<span class="string">&quot;COMPONENT[&#123;0&#125;] AVERAGE TIME SPENT : &#123;1&#125;\n&quot;</span>, entry.getKey(),</span><br><span class="line">               entry.getValue()));</span><br><span class="line">      &#125;</span><br><span class="line">      logStr.append(<span class="string">&quot;======================================================================================\n&quot;</span>);</span><br><span class="line">      LOG.info(logStr.toString());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;print statistics cause error&quot;</span>, e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>statisticsMap</code> æ˜¯ç”¨æ¥ä¿å­˜ç»„ä»¶æ‰§è¡Œæ—¶ä¸ŠæŠ¥çš„æ•°æ®ï¼Œåœ¨<code>printStatistics</code> æ–¹æ³•ä¸­å¯¹æ•°æ®è¿›è¡Œæ•´ç†å’Œæ‰“å°</p><p>ä¸»è¦æ•°æ®ï¼š</p><ul><li>slot æ§½ä½ç°åœ¨çš„å¤§å°ï¼ˆç”¨æ¥è¡¡é‡æœ€å¤§å¹¶å‘åº¦ï¼‰</li><li>slot å½“å‰çš„å ç”¨æ•°é‡ï¼ˆå±•ç¤ºå½“å‰å¹¶å‘åº¦ï¼‰</li><li>å„ä¸ªç»„ä»¶çš„å¹³å‡è€—æ—¶</li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¼€æºå­¦ä¹  </category>
          
          <category> LiteFlow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> LiteFlow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Maison Premiereâ€™s Tom Collins</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Maison%20Premiere%E2%80%99s%20Tom%20Collins.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Maison%20Premiere%E2%80%99s%20Tom%20Collins.html</url>
      
        <content type="html"><![CDATA[<p><imgsrc="https://assets-prd.punchdrink.com/wp-content/uploads/2023/03/16224141/Article-Tom-Collins-Underrated-Classic-Cocktail-Recipe-500x688.jpg" /></p><h1 id="maison-premiere-çš„æ±¤å§†æŸ¯æ—æ–¯">Maison Premiere çš„æ±¤å§†æŸ¯æ—æ–¯</h1><p><ahref="https://punchdrink.com/recipes/maison-premieres-tom-collins/">MaisonPremiereâ€™s Tom Collins Cocktail Recipe | PUNCH (punchdrink.com)</a></p><p>å¯¹äºæŸäº›è°ƒé…’å¸ˆæ¥è¯´ï¼Œâ€œè¢«ä½ä¼°â€ å¹¶ä¸ä¸€å®šæ„å‘³ç€é²œä¸ºäººçŸ¥</p><p>Maison Premiere çš„å¨å»‰Â·åŸƒåˆ©å¥¥ç‰¹ï¼ˆWilliamElliottï¼‰è®¤ä¸ºï¼Œæ±¤å§†æŸ¯æ—æ–¯æ˜¯æ— å¤„ä¸åœ¨çš„ç»å…¸ï¼Œå€¼å¾— â€å¥½å¥½å¯¹å¾…â€œ</p><p>å…³é”®åœ¨äºæ‰¾åˆ°ä¸€ä¸ªè½»åº¦æ¡¶é™ˆçš„è€æ±¤å§†ï¼ˆä»–ä½¿ç”¨çš„æ˜¯ Ransom OldTomï¼‰ï¼Œå¹¶ä¸”ï¼Œè™½ç„¶å¸¸è§çš„æ˜¯åœ¨ç»ç’ƒæ¯é‡Œè¿›è¡Œè°ƒåˆ¶ï¼Œä¸è¿‡ä¸€ä¸ªåˆé€‚çš„æ±¤å§†æŸ¯æ—æ–¯åº”è¯¥ç»è¿‡shake å¹¶è¿‡æ»¤</p><p>åœ¨å¸ƒé²å…‹æ—çš„é…’å§é‡Œï¼ŒåŸƒåˆ©å¥¥ç‰¹å¯¹é¸¡å°¾é…’çš„åŸºåº•é‡‡ç”¨äº†ç±»ä¼¼å‰å§†é›·ç‰¹ï¼ˆGimletï¼‰çš„æ–¹å¼ï¼Œéœ€è¦æŸ æª¬æ±å’ŒæŸ æª¬ç”œé…’ï¼ˆlemoncordialï¼‰çš„é²œæ˜ç»„åˆï¼Œå†åŠ ä¸Šå°‘é‡çš„æ©™å‘³è‹¦ç²¾</p><h2 id="åŸæ–™">åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>è€æ±¤å§†é‡‘é…’ï¼ˆæœ€å¥½æ˜¯ Ransomï¼‰- 1.5 ç›å¸ï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/2344/ransom-old-tom-gin">RansomOld Tom Gin</a>ï¼‰</li><li>æŸ æª¬ç”œé…’ - 1 ç›å¸ï¼ˆè§æ³¨é‡Šï¼‰</li><li>æµ·å†›åŠ›é‡é‡‘é…’ - 0.5 ç›å¸ï¼ˆæœ€å¥½æ˜¯ Haymanâ€™s Royal Dock <ahref="https://www.diffordsguide.com/beer-wine-spirits/3066/haymans-royal-dock-of-deptford-gin">Hayman'sRoyal Dock of Deptford Gin</a>ï¼‰</li><li>æŸ æª¬æ± - 0.5 ç›å¸</li><li>æ©™å‘³è‹¦ç²¾ - 3 dashes</li><li>è‹æ‰“æ°´ - åŠ æ»¡</li></ul><p><strong>è£…é¥°</strong>ï¼šå®‰é«˜å¤©å¨œè‹¦ç²¾ã€æŸ æª¬è½®ã€ç³–éœœã€å¸ç®¡</p><h2 id="æ­¥éª¤">æ­¥éª¤</h2><ol type="1"><li>å°†å‰äº”ç§åŸæ–™åŠ å…¥æ‘‡å£¶ä¸­ï¼ŒåŠ å†°è¿›è¡Œ shake</li><li>æ»¤å…¥åŠ å†°çš„ 12 ç›å¸æŸ¯æ—æ–¯ç»ç’ƒæ¯ä¸­ï¼Œå°†å®‰é«˜å¤©å¨œè‹¦ç²¾æ»´æµ®åœ¨è¡¨é¢</li><li>ç”¨æŸ æª¬è½®å’Œç³–éœœè£…é¥°ï¼Œæ’å…¥å¸ç®¡</li></ol><h2 id="æ³¨é‡Š">æ³¨é‡Š</h2><h3 id="æŸ æª¬ç”œé…’lemon-cordial">æŸ æª¬ç”œé…’ï¼ˆLemon Cordialï¼‰</h3><p>å°† 10 ä¸ªæŸ æª¬çš®ã€32 ç›å¸ç™½ç³–å’Œ 1ç›å¸ä¼ç‰¹åŠ æ”¾åœ¨å®¹å™¨ä¸­æ··åˆï¼Œç»è¿‡ä¸€å¤œæˆ–æ”¾ç½® 12 å°æ—¶</p><p>åŠ å…¥ 32 ç›å¸æŸ æª¬æ±ï¼Œæ…æ‹Œè‡³ç™½ç³–æº¶è§£</p><p>è¿‡æ»¤ï¼ˆfine-strainï¼‰</p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GoogleCode ConcurrentLinkedHashMap</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/GoogleCode%20ConcurrentLinkedHashMap.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/GoogleCode%20ConcurrentLinkedHashMap.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‚æ•°">å‚æ•°</h1><h2 id="builder">Builder</h2><p>ConcurrentLinkedHashMap æ„é€ æ–¹æ³•ç§æœ‰ï¼Œåªèƒ½é€šè¿‡å…¶é™æ€å†…éƒ¨ç±»<code>Builder</code> æ¥è¿›è¡Œå®ä¾‹åŒ–</p><blockquote><p>ä¸€ä¸ªå®Œå…¨æ”¯æŒå¹¶å‘æ£€ç´¢çš„å“ˆå¸Œè¡¨ï¼Œå¯è°ƒèŠ‚æ›´æ–°é¢„æœŸå¹¶å‘åº¦ï¼Œä»¥åŠé™åˆ¶å…¶æœ€å¤§å®¹é‡</p><p>è¯¥å®ç°ä¸ <code>ConcurrentHashMap</code>çš„ä¸åŒä¹‹å¤„åœ¨äºç»´æŠ¤äº†ä¸€ä¸ªé¡µé¢æ›¿æ¢ç®—æ³•ï¼ˆpage replacementalgorithmï¼‰ï¼Œç”¨äºåœ¨ map è¶…å‡ºå®¹é‡æ—¶åˆ é™¤å…ƒç´ </p><p>è¿™ä¸ª map å®ç°æ²¡æœ‰å…±æœ‰çš„æ„é€ å™¨ï¼Œå®ƒçš„å®ä¾‹æ˜¯é€šè¿‡ <code>Builder</code>åˆ›å»ºçš„</p></blockquote><p><code>Builder</code> æ”¯æŒé“¾å¼èµ‹å€¼ï¼Œä½¿ç”¨å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ConcurrentLinkedHashMap&lt;Integer, String&gt; map =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedHashMap</span>.Builder&lt;Integer, String&gt;()</span><br><span class="line">            .maximumWeightedCapacity(<span class="number">2</span>)</span><br><span class="line">            .weigher(Weighers.singleton())</span><br><span class="line">            .listener((key, value) -&gt; System.out.println(<span class="string">&quot;å…ƒç´ è¢«ä¸¢å¼ƒäº† key=&quot;</span> + key + <span class="string">&quot; value=&quot;</span> + value))</span><br><span class="line">            .concurrencyLevel(<span class="number">32</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>build()</code> æ–¹æ³•è¿›è¡Œ<code>ConcurrentLinkedHashMap</code> çš„å®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConcurrentLinkedHashMap&lt;K, V&gt; <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">  checkState(capacity &gt;= <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedHashMap</span>&lt;K, V&gt;(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å¦‚æœ <code>capacity</code>ï¼Œå³<code>maximumWeightedCapacity</code>æœªè¿›è¡Œèµ‹å€¼ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå…¶ä»–å‚æ•°å‡æœ‰é»˜è®¤å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Builder</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// é»˜è®¤ä¸º -1ï¼Œç»“åˆä¸Šé¢çš„é€»è¾‘ï¼Œä¸è¿›è¡Œèµ‹å€¼å®ä¾‹åŒ–æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">  capacity = -<span class="number">1</span>;</span><br><span class="line">  weigher = Weighers.entrySingleton();</span><br><span class="line">  initialCapacity = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">  concurrencyLevel = DEFAULT_CONCURRENCY_LEVEL;</span><br><span class="line">  listener = (EvictionListener&lt;K, V&gt;) DiscardingListener.INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="maximumweightedcapacity">maximumWeightedCapacity</h2><p>è¡¨ç¤ºè¯¥ mapæœ€å¤§èƒ½å¤Ÿå…è®¸çš„æœ€å¤§é‡é‡ï¼Œå¹¶ä¸”æœ‰å¯èƒ½æš‚æ—¶è¶…è¿‡å®ƒï¼ˆæˆ‘ç†è§£å¯èƒ½é©±é€å…ƒç´ æ˜¯ä¸€ä¸ªæƒ°æ€§è¿‡ç¨‹ï¼‰</p><p>åœ¨å®ä¾‹åŒ– <code>ConcurrentLinkedHashMap</code>æ—¶ï¼Œä½¿ç”¨åŸå­ç±»ä½œä¸ºå®¹é‡çš„è®°å½•å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    capacity = <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(Math.min(builder.capacity, MAXIMUM_CAPACITY));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶‰åŠ <code>capacity</code> çš„æ–¹æ³•ï¼š</p><ul><li>capacityï¼šè·å–å½“å‰ capacity</li><li>setCapacityï¼šè®¾ç½® capacity</li><li>hasOverflowedï¼šåˆ¤æ–­å½“å‰é‡é‡å¤§å°æ˜¯å¦è¶…è¿‡äº† capacity</li></ul><h2 id="initialcapacity">initialCapacity</h2><p>è¡¨ç¤ºåˆå§‹åŒ–åº•å±‚å­˜æ”¾å…ƒç´ çš„ map å®¹é‡ï¼Œé»˜è®¤ä¸º 16</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    data = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMapV8</span>&lt;K, Node&lt;K, V&gt;&gt;(builder.initialCapacity, <span class="number">0.75f</span>, concurrencyLevel);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConcurrentLinkedHashMap åº•å±‚å®ç°å­˜å‚¨çš„ç»“æ„æ˜¯<code>ConcurrentHashMapV8</code>ï¼Œçœ‹åˆ°å…¶å‚æ•°å’Œ JUC ä¸‹é¢çš„<code>ConcurrentHashMap</code>ä¸€æ ·å¤§è‡´å°±å¯ä»¥çŒœåˆ°è¯¥å‚æ•°çš„ä½œç”¨ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åœ¨é¢„ä¼°æ•°æ®é‡æ¥é¿å…é¢‘ç¹ resizeæ“ä½œ</p><p>å¯¹äºè¯¥å‚æ•°æ˜¯å¦‚ä½•ç”¨äºå®ä¾‹åŒ– <code>ConcurrentHashMapV8</code>ï¼Œåœ¨åé¢çš„ <code>concurrencyLevel</code> å‚æ•°è¿›è¡Œå±•ç¤º</p><p>è¯¥å‚æ•°åªç”¨äºå®ä¾‹åŒ– <code>ConcurrentHashMapV8</code></p><h2 id="concurrencylevel">concurrencyLevel</h2><p>é¢„ä¼°çš„å¹¶å‘çº¿ç¨‹æ•°</p><p>å’Œ <code>initialCapacity</code> å‚æ•°ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†å®ä¾‹åŒ–<code>ConcurrentHashMapV8</code>ï¼Œå…¶å‚æ•°çš„ä½œç”¨ä¹Ÿå’Œ<code>ConcurrentHashMap</code> ä¸€æ ·ï¼ˆä½œè€…éƒ½æ˜¯ Doug Leaï¼‰</p><p><code>ConcurrentHashMap</code> æé«˜å¹¶å‘æ€§èƒ½çš„æ€æƒ³å°±æ˜¯ cellåŒ–ï¼ŒæŒ‰ç…§åº•å±‚ Entry æ•°ç»„å¤´å…ƒç´ ä½œä¸ºå¹¶å‘ç²’åº¦ï¼Œé‚£ä¹ˆ<code>concurrencyLevel</code> å’Œ <code>initialCapacity</code>è¿™ä¸¤ä¸ªå‚æ•°å¿…ç„¶åŒæ—¶å½±å“åº•å±‚æ•°ç»„çš„å¤§å°åˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMapV8</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">        initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">long</span>)(<span class="number">1.0</span> + initialCapacity / loadFactor);</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> (size &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="type">int</span>)size);</span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="weigher">weigher</h2><p>é‡é‡å™¨ï¼Œç”¨æ¥è¡¡é‡ä¸€ä¸ªå…ƒç´ å ç”¨äº†å¤šå°‘é‡é‡ï¼Œé»˜è®¤ä¸º<code>SingletonWeigher</code></p><p>å› ä¸º ConcurrentLinkedHashMap çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯åœ¨é™åˆ¶ mapå†…å…ƒç´ çš„å ç”¨ï¼Œé‚£ä¹ˆè¡¡é‡ä¸€ä¸ªå…ƒç´ çš„æƒé‡å°±è¢«æŠ½è±¡ä¸ºäº†<code>Weigher</code></p><p>å…¶ä¸­é™¤äº† <code>Weigher</code> è¿˜æä¾›äº† <code>EntryWeigher</code>çš„æŠ½è±¡ï¼Œç”¨äºå¯¹æ•´ä¸ª KV è¿›è¡Œé‡é‡çš„è¡¡é‡</p><p>å¯¹äº <code>Weigher</code> å®ç°ï¼Œä¼šè¢«è½¬æ¢ä¸º <code>EntryWeigher</code>å®ç°ï¼ˆç»Ÿä¸€å…¥å£ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Builder&lt;K, V&gt; <span class="title function_">weigher</span><span class="params">(Weigher&lt;? <span class="built_in">super</span> V&gt; weigher)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.weigher = (weigher == Weighers.singleton())</span><br><span class="line">      ? Weighers.&lt;K, V&gt;entrySingleton()</span><br><span class="line">      : <span class="keyword">new</span> <span class="title class_">BoundedEntryWeigher</span>&lt;K, V&gt;(Weighers.asEntryWeigher(weigher));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>EntryWeigherView</code> å°±æ˜¯ç”¨æ¥å°† <code>Weigher</code>åŒ…è£…ä¸º <code>EntryWeigher</code> çš„å®ç°</p><p>åˆ—ä¸¾ä¸€äº›è‡ªå¸¦çš„å®ç°</p><ul><li>Weigher<ul><li>SingletonWeigherï¼šä¸€ä¸ª value çš„é‡é‡è§†ä¸º 1</li><li>CollectionWeigherï¼švalue ä¸ºé›†åˆç±»å‹ï¼Œé‡é‡ä¸ºé›†åˆçš„ size</li><li>ListWeigherï¼švalue ä¸º list ç±»å‹ï¼Œé‡é‡ä¸º list çš„ size</li><li>MapWeigherï¼švalue ä¸º map ç±»å‹ï¼Œé‡é‡ä¸º map çš„ size</li></ul></li><li>EntryWeigher<ul><li>BoundedEntryWeigherï¼šå†…éƒ¨ä¸º <code>EntryWeigher</code>å®ç°ï¼Œè¦æ±‚é‡é‡å¤§äºç­‰äº 1</li><li>SingletonEntryWeigherï¼šä¸€ä¸ª KV çš„é‡é‡è§†ä¸º 1</li><li>EntryWeigherViewï¼šç”¨äºåŒ…è£… <code>Weigher</code> çš„å®ç°</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// The eviction support</span></span><br><span class="line">    weigher = builder.weigher;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‚æ•°ä¼šåœ¨ put å…ƒç´ ä»¥åŠä¸€ç³»åˆ—è·å– ordered è§†å›¾æ“ä½œä¸­è¢«ä½¿ç”¨</p><h2 id="listener">listener</h2><p><code>EvictionListener</code> çš„å®ç°ï¼Œç”¨äºé©±é€å…ƒç´ æ—¶è°ƒç”¨è¯¥å®ç°çš„<code>onEviction(K key, V value)</code> æ–¹æ³•è¿›è¡Œé€šçŸ¥</p><p>é»˜è®¤å€¼ä¸º <code>DiscardingListener.INSTANCE</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="comment">// The notification queue and listener</span></span><br><span class="line">    listener = builder.listener;</span><br><span class="line">    pendingNotifications = (listener == DiscardingListener.INSTANCE)</span><br><span class="line">        ? (Queue&lt;Node&lt;K, V&gt;&gt;) DISCARDING_QUEUE</span><br><span class="line">        : <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;Node&lt;K, V&gt;&gt;();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœ listener æ˜¯ä¸€ä¸ªé»˜è®¤å€¼ï¼Œåˆ™<code>pendingNotifications</code> ä¹Ÿä¼šä½¿ç”¨é»˜è®¤é˜Ÿåˆ—ï¼Œå…¶å®ç°å°±æ˜¯ç©ºå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A queue that discards all additions and is always empty. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DiscardingQueue</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;Object&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">poll</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">peek</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> Iterator&lt;Object&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123; <span class="keyword">return</span> emptyList().iterator(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é©±é€å…ƒç´ æ—¶ä¸ä¼šè¿›è¡Œé€šçŸ¥ï¼Œä½¿ç”¨äº†<strong>ç©ºå¯¹è±¡æ¨¡å¼</strong></p><blockquote><p>åœ¨ç©ºå¯¹è±¡æ¨¡å¼ï¼ˆNull Object Patternï¼‰ä¸­ï¼Œä¸€ä¸ªç©ºå¯¹è±¡å–ä»£ NULLå¯¹è±¡å®ä¾‹çš„æ£€æŸ¥</p><p>Null å¯¹è±¡ä¸æ˜¯æ£€æŸ¥ç©ºå€¼ï¼Œè€Œæ˜¯ååº”ä¸€ä¸ªä¸åšä»»ä½•åŠ¨ä½œçš„å…³ç³»ï¼Œè¿™æ ·çš„ Nullå¯¹è±¡ä¹Ÿå¯ä»¥åœ¨æ•°æ®ä¸å¯ç”¨çš„æ—¶å€™æä¾›é»˜è®¤çš„è¡Œä¸º</p></blockquote><h1 id="æ·»åŠ å…ƒç´ ">æ·»åŠ å…ƒç´ </h1><p><code>put</code> å’Œ <code>putIfAbsent</code> æœ€ç»ˆéƒ½è°ƒç”¨<code>put(K key, V value, boolean onlyIfAbsent)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> put(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">putIfAbsent</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> put(key, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">V <span class="title function_">put</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">  <span class="comment">// å…¥å‚æ ¡éªŒ</span></span><br><span class="line">  checkNotNull(key);</span><br><span class="line">  checkNotNull(value);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—æƒé‡</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> <span class="variable">weight</span> <span class="operator">=</span> weigher.weightOf(key, value);</span><br><span class="line"><span class="comment">// åŒ…è£…èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">final</span> WeightedValue&lt;V&gt; weightedValue = <span class="keyword">new</span> <span class="title class_">WeightedValue</span>&lt;V&gt;(value, weight);</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K, V&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K, V&gt;(key, weightedValue);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// put è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; prior = data.putIfAbsent(node.key, node);</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡å†™å…¥ keyï¼Œè§†ä¸ºä¸€æ¬¡ Add</span></span><br><span class="line">    <span class="keyword">if</span> (prior == <span class="literal">null</span>) &#123;</span><br><span class="line">      afterWrite(<span class="keyword">new</span> <span class="title class_">AddTask</span>(node, weight));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å­˜åœ¨ key å¹¶ä¸” onlyIfAbsent = true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onlyIfAbsent) &#123;</span><br><span class="line">      afterRead(prior);</span><br><span class="line">      <span class="keyword">return</span> prior.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// èµ°åˆ°è¯¥ caseï¼Œè¯´æ˜ key å­˜åœ¨å¹¶ä¸” onlyIfAbsent = false</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="keyword">final</span> WeightedValue&lt;V&gt; oldWeightedValue = prior.get();</span><br><span class="line">     <span class="comment">// å¹¶å‘é”™è¯¯ä¸‹è·³å‡ºï¼Œç”± data.putIfAbsent(node.key, node) ç»§ç»­å–å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (!oldWeightedValue.isAlive()) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// æ›´æ–°æƒé‡ï¼Œè§†æƒ…å†µè¿›è¡Œ Update æˆ–è€… read</span></span><br><span class="line">      <span class="keyword">if</span> (prior.compareAndSet(oldWeightedValue, weightedValue)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">weightedDifference</span> <span class="operator">=</span> weight - oldWeightedValue.weight;</span><br><span class="line">        <span class="keyword">if</span> (weightedDifference == <span class="number">0</span>) &#123;</span><br><span class="line">          afterRead(prior);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          afterWrite(<span class="keyword">new</span> <span class="title class_">UpdateTask</span>(prior, weightedDifference));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldWeightedValue.value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¡ç®—æƒé‡">è®¡ç®—æƒé‡</h2><p>ç»è¿‡å‚æ•°æ ¡éªŒåï¼Œé¦–å…ˆè¦è¿›è¡Œæƒé‡çš„è®¡ç®—å’ŒåŒ…è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æƒé‡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">weight</span> <span class="operator">=</span> weigher.weightOf(key, value);</span><br><span class="line"><span class="comment">// åŒ…è£…èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">final</span> WeightedValue&lt;V&gt; weightedValue = <span class="keyword">new</span> <span class="title class_">WeightedValue</span>&lt;V&gt;(value, weight);</span><br><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K, V&gt;(key, weightedValue);</span><br></pre></td></tr></table></figure><p>æƒé‡çš„è®¡ç®—å°±æ˜¯è°ƒç”¨äº† <code>EntryWeigher</code> å®ç°çš„<code>weightOf()</code> æ–¹æ³•</p><p>éšåå°†æƒé‡å€¼å’Œ value åŒ…è£…è¿› <code>WeightedValue</code>ï¼Œå¹¶åŒ…è£…ä¸º<code>Node</code></p><p><code>Node</code> å³ä¸ºé“¾è¡¨çš„èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">AtomicReference</span>&lt;WeightedValue&lt;V&gt;&gt; <span class="keyword">implements</span> <span class="title class_">Linked</span>&lt;Node&lt;K, V&gt;&gt;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªä¿å­˜ KV çš„æ ¸å¿ƒç»“æ„ï¼ˆä¸Šé¢æåˆ°çš„<code>ConcurrentHashMapV8</code>ï¼‰ä¿å­˜çš„å…¶å®æ˜¯ key å’Œ <code>Node</code>çš„æ•°æ®ï¼š<code>final ConcurrentMap&lt;K, Node&lt;K, V&gt;&gt; data;</code></p><h2 id="æ— å†²çª">æ— å†²çª</h2><p>éšåè°ƒç”¨ <code>data</code> çš„ <code>putIfAbsent</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt; prior = data.putIfAbsent(node.key, node);</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¿”å›çš„ prior èŠ‚ç‚¹æƒ…å†µï¼Œåˆ¤æ–­åç»­æµç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€æ¬¡å†™å…¥ keyï¼Œè§†ä¸ºä¸€æ¬¡ Add</span></span><br><span class="line">  <span class="keyword">if</span> (prior == <span class="literal">null</span>) &#123;</span><br><span class="line">    afterWrite(<span class="keyword">new</span> <span class="title class_">AddTask</span>(node, weight));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// å­˜åœ¨ key å¹¶ä¸” onlyIfAbsent = trueï¼Œè§†ä¸ºä¸€æ¬¡ Read</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onlyIfAbsent) &#123;</span><br><span class="line">    afterRead(prior);</span><br><span class="line">    <span class="keyword">return</span> prior.getValue();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ç§æƒ…å†µå‡å¯ä»¥è§†ä¸ºæ— å†²çªæƒ…å†µï¼š</p><ul><li>ä¸å­˜åœ¨ prior</li><li>å­˜åœ¨ prior ä½†æ˜¯ onlyIfAbsent = true</li></ul><p>éšåæ‰§è¡Œç›¸åº”çš„ Add æˆ–è€… Read ä»»åŠ¡ï¼ˆåé¢è§£é‡Šä»»åŠ¡çš„æ“ä½œï¼‰</p><h2 id="éœ€è¦æ›´æ–°">éœ€è¦æ›´æ–°</h2><p>å½“ key å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆä¸Šè¿° put æ–¹æ³•å…¶å®å¹¶æœªå®Œæˆï¼Œåªæ˜¯è¿”å›äº† K å¯¹åº”çš„value å¯¹è±¡ï¼ˆèŠ‚ç‚¹ï¼‰</p><p>å¯ä»¥çŒœæµ‹ä¸‹é¢æµç¨‹éœ€è¦åšçš„æ“ä½œï¼š</p><ul><li>æ›¿æ¢ key å¯¹åº”çš„ valueï¼›å› ä¸º valueå’Œæƒé‡æ˜¯ç»‘å®šå…³ç³»ï¼Œä¹Ÿå³æ›¿æ¢äº†æƒé‡</li><li>è¿›è¡Œ Task æµç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµ°åˆ°è¯¥ caseï¼Œè¯´æ˜ key å­˜åœ¨å¹¶ä¸” onlyIfAbsent = false</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="keyword">final</span> WeightedValue&lt;V&gt; oldWeightedValue = prior.get();</span><br><span class="line">  <span class="comment">// å¹¶å‘é”™è¯¯ä¸‹è·³å‡ºï¼Œç”± data.putIfAbsent(node.key, node) ç»§ç»­å–å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (!oldWeightedValue.isAlive()) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°æƒé‡ï¼Œè§†æƒ…å†µè¿›è¡Œ Update æˆ– Read</span></span><br><span class="line">  <span class="keyword">if</span> (prior.compareAndSet(oldWeightedValue, weightedValue)) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">weightedDifference</span> <span class="operator">=</span> weight - oldWeightedValue.weight;</span><br><span class="line">    <span class="keyword">if</span> (weightedDifference == <span class="number">0</span>) &#123;</span><br><span class="line">      afterRead(prior);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      afterWrite(<span class="keyword">new</span> <span class="title class_">UpdateTask</span>(prior, weightedDifference));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldWeightedValue.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>é¦–å…ˆè·å– prior èŠ‚ç‚¹çš„ <code>WeightedValue</code> ç»“æ„ï¼Œå½“è¯¥ç»“æ„<code>isAlive()</code> ä¸º false æ—¶ï¼Œè¯´æ˜ç°åœ¨çš„ priorèŠ‚ç‚¹åœ¨å¹¶å‘ç¯å¢ƒä¸‹å·²ç»æˆä¸ºè¿‡å»å¼äº†ï¼Œéœ€è¦è·³å‡ºå¾ªç¯ï¼Œé‡æ–°è¿›è¡Œæœ€å¼€å§‹çš„è·å–æµç¨‹</li><li>å½“æ—§èŠ‚ç‚¹æ²¡é—®é¢˜ï¼Œå°±ä¼šè°ƒç”¨ CAS æ–¹æ³•æ¥æ›¿æ¢æ–°çš„ weight å’Œvalueï¼Œå¦‚æœæ›¿æ¢æˆåŠŸåˆ™ä¼šæ ¹æ®æƒé‡å·®å€¼æ¥è¿›è¡Œ Read æˆ–è€… Update ä»»åŠ¡</li><li>å¦‚æœ CAS å¤±è´¥ï¼Œåˆ™ä¼šç»§ç»­å¯¹èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œé‡å¤æµç¨‹</li></ol><h1 id="åˆ é™¤å…ƒç´ ">åˆ é™¤å…ƒç´ </h1><h2 id="æŒ‰-k-åˆ é™¤">æŒ‰ K åˆ é™¤</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K, V&gt; node = data.remove(key);</span><br><span class="line">  <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  makeRetired(node);</span><br><span class="line">  afterWrite(<span class="keyword">new</span> <span class="title class_">RemovalTask</span>(node));</span><br><span class="line">  <span class="keyword">return</span> node.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>é¦–å…ˆä¾èµ– <code>data</code> çš„ <code>remove(key)</code>æ–¹æ³•ï¼Œæ‹¿åˆ°èŠ‚ç‚¹åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœç­‰äº nullï¼Œè¯´æ˜è¯¥ keyæ²¡æœ‰å¯¹åº”çš„å€¼ï¼Œå°±ä¸éœ€è¦è€ƒè™‘åç»­æµç¨‹äº†</li><li>å¦‚æœèŠ‚ç‚¹ä¸ç­‰ nullï¼Œéœ€è¦è¿›è¡Œ<code>makeRetired()</code>ï¼Œæœ¬è´¨æ˜¯ä¿®æ”¹èŠ‚ç‚¹ <code>WeightedValue</code>çš„æƒé‡ä¸ºè´Ÿæ•°ï¼ˆåœ¨æ·»åŠ æµç¨‹ä¸­ï¼Œä¾é æƒé‡æ˜¯å¦ä¸ºè´Ÿä½œä¸º valueè¢«åˆ é™¤çš„æ ‡å¿—ï¼‰</li><li>éšåè¿›è¡Œ Removal ä»»åŠ¡</li></ol><h2 id="æŒ‰-kv-åˆ é™¤">æŒ‰ KV åˆ é™¤</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K, V&gt; node = data.get(key);</span><br><span class="line">  <span class="keyword">if</span> ((node == <span class="literal">null</span>) || (value == <span class="literal">null</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  WeightedValue&lt;V&gt; weightedValue = node.get();</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (weightedValue.contains(value)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (tryToRetire(node, weightedValue)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (data.remove(key, node)) &#123;</span><br><span class="line">          afterWrite(<span class="keyword">new</span> <span class="title class_">RemovalTask</span>(node));</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        weightedValue = node.get();</span><br><span class="line">        <span class="keyword">if</span> (weightedValue.isAlive()) &#123;</span><br><span class="line">          <span class="comment">// retry as an intermediate update may have replaced the value with</span></span><br><span class="line">          <span class="comment">// an equal instance that has a different reference identity</span></span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ é™¤çš„åŸºç¡€ä¸Šå¤šäº†å¯¹ value çš„æ¯”è¾ƒ</p><p>å½“ key å­˜åœ¨æ—¶ï¼Œè¿™é‡Œç”¨äº†å¤šä¸ªåµŒå¥—åˆ¤æ–­æ¥å®ç°ç›®çš„æˆ–ä¿è¯å¹¶å‘ï¼š</p><ol type="1"><li>value æ˜¯å¦èƒ½å¯¹åº”ä¸Šï¼Œå¯¹åº”ä¸ä¸Šç›´æ¥è¿”å›åˆ é™¤å¤±è´¥</li><li>è®© value é€€ä¼‘ï¼Œè°ƒç”¨ <code>tryToRetire(node, weightedValue)</code>æ–¹æ³•ï¼Œå¦‚æœå¤±è´¥å°±é‡æ–°è·å–èŠ‚ç‚¹çš„valueï¼Œè¿›è¡Œå­˜æ´»åˆ¤æ–­ï¼Œå¦‚æœä¾ç„¶å­˜æ´»åˆ™é‡å¤æ•´ä¸ªæµç¨‹ï¼ˆä» 1 å¼€å§‹ï¼‰</li><li>è°ƒç”¨ <code>data.remove(key, node)</code> æ–¹æ³•ï¼Œå¦‚æœæˆåŠŸåˆ™è¿›è¡ŒRemoval ä»»åŠ¡ï¼Œå¤±è´¥åˆ™é‡æ–°æ•´ä¸ªæµç¨‹</li></ol><h2 id="trytoretire">tryToRetire</h2><p>åœ¨ä¸Šè¿°åˆ é™¤æµç¨‹ä¸­ï¼Œéƒ½éœ€è¦è°ƒç”¨ <code>tryToRetire</code> æ–¹æ³•</p><p>æœ¬è´¨ä¸Šæ˜¯å°†èŠ‚ç‚¹ç½®ä¸ºå¤±æ•ˆçŠ¶æ€ï¼Œå¤±æ•ˆçŠ¶æ€æ ¹æ®èŠ‚ç‚¹ value ä¸­çš„<code>WeightedValue</code> çš„ <code>weight</code> æ¥æ ‡ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">tryToRetire</span><span class="params">(Node&lt;K, V&gt; node, WeightedValue&lt;V&gt; expect)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (expect.isAlive()) &#123;</span><br><span class="line">    <span class="keyword">final</span> WeightedValue&lt;V&gt; retired = <span class="keyword">new</span> <span class="title class_">WeightedValue</span>&lt;V&gt;(expect.value, -expect.weight);</span><br><span class="line">    <span class="keyword">return</span> node.compareAndSet(expect, retired);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åç½®è¯»å†™">åç½®è¯»å†™</h1><p>åœ¨ä¸Šè¿°æµç¨‹ä¸­ï¼Œå„ç§æ“ä½œéƒ½ç¦»ä¸å¼€è°ƒç”¨ <code>afterRead</code> å’Œ<code>afterWrite</code> æ–¹æ³•</p><p>åç½®è¯»å†™çš„æ“ä½œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨è°ƒæ•´é“¾è¡¨ç»“æ„æ¥å®ç°LRUï¼Œå¯¹å…ƒç´ è¿›è¡Œå†™å…¥ã€é©±é€å’Œæ’åº</p><h2 id="afterwrite">afterWrite</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterWrite</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">    <span class="comment">// å†™ç¼“å†²åŒºæ·»åŠ ä»»åŠ¡</span></span><br><span class="line">    writeBuffer.add(task);</span><br><span class="line">    <span class="comment">// è®¾ç½® drain çŠ¶æ€ä¸º REQUIRED</span></span><br><span class="line">    drainStatus.lazySet(REQUIRED);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œç¼“å†²åŒºçš„ä»»åŠ¡</span></span><br><span class="line">    tryToDrainBuffers();</span><br><span class="line">    <span class="comment">// é€šçŸ¥ç›‘å¬å™¨</span></span><br><span class="line">    notifyListener();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ drainStatus æ˜¯ä¸€ä¸ªè¢« <code>AtomicReference</code> åŒ…è£…çš„<code>DrainStatus</code>ï¼Œä»£è¡¨å½“å‰ç¼“å†²æ“ä½œçš„çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">DrainStatus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is not taking place. */</span></span><br><span class="line">    IDLE &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !delayable;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is required due to a pending write modification. */</span></span><br><span class="line">    REQUIRED &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is in progress. */</span></span><br><span class="line">    PROCESSING &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determines whether the buffers should be drained.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayable if a drain should be delayed until required</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> if a drain should be attempted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ drainStatus è¢«å¹¶å‘å®‰å…¨å¹¶ lazy è®¾ç½®ä¸º <code>REQUIRED</code>åï¼Œ<code>tryToDrainBuffers()</code> æ–¹æ³•æ¥æ‰§è¡Œå¯¹ç¼“å†²åŒºçš„æ“ä½œ</p><p><strong>tryToDrainBuffers</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">tryToDrainBuffers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (evictionLock.tryLock()) &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">            drainStatus.lazySet(PROCESSING);</span><br><span class="line">            drainBuffers();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            drainStatus.compareAndSet(PROCESSING, IDLE);</span><br><span class="line">            evictionLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–é”èµ„æ ¼ï¼ŒevictionLock æ˜¯ä¸€ä¸ª<code>ReentrantLock</code>ï¼š<code>evictionLock = new ReentrantLock();</code></p><p>å†å°† drainStatus çŠ¶æ€è®¾ç½®ä¸º <code>PROCESSING</code>ï¼›æœ€åè°ƒç”¨æ ¸å¿ƒçš„<code>drainBuffers</code> æ–¹æ³•</p><p>å½“æ‰§è¡Œç»“æŸåå°† drainStatus CAS ä¿®æ”¹ä¸º <code>IDLE</code>ï¼Œè¿›è¡Œè§£é”</p><h2 id="afterread">afterRead</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterRead</span><span class="params">(Node&lt;K, V&gt; node)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å– buffer çš„ indexï¼Œè¿™é‡Œä¸ºäº†é¿å…å¯¹çƒ­ entries çš„äº‰æŠ¢</span></span><br><span class="line">    <span class="comment">// ä¸ªäººç†è§£ç±»ä¼¼é’ˆå¯¹ç¼“å†²åŒºçš„ cell æœºåˆ¶</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bufferIndex</span> <span class="operator">=</span> readBufferIndex();</span><br><span class="line">    <span class="comment">// æ ¹æ® bufferIndex å°† node è®°å½•åœ¨ readBuffer ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">writeCount</span> <span class="operator">=</span> recordRead(bufferIndex, node);</span><br><span class="line">    <span class="comment">// drain æ“ä½œ</span></span><br><span class="line">    drainOnReadIfNeeded(bufferIndex, writeCount);</span><br><span class="line">    <span class="comment">// é€šçŸ¥ç›‘å¬å™¨</span></span><br><span class="line">    notifyListener();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>recordRead</code> çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">recordRead</span><span class="params">(<span class="type">int</span> bufferIndex, Node&lt;K, V&gt; node)</span> &#123;</span><br><span class="line">    <span class="comment">// The location in the buffer is chosen in a racy fashion as the increment</span></span><br><span class="line">    <span class="comment">// is not atomic with the insertion. This means that concurrent reads can</span></span><br><span class="line">    <span class="comment">// overlap and overwrite one another, resulting in a lossy buffer.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">counter</span> <span class="operator">=</span> readBufferWriteCount[bufferIndex];</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">writeCount</span> <span class="operator">=</span> counter.get();</span><br><span class="line">    counter.lazySet(writeCount + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">int</span>) (writeCount &amp; READ_BUFFER_INDEX_MASK);</span><br><span class="line">    readBuffers[bufferIndex][index].lazySet(node);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> writeCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å– readBufferWriteCount çš„ counter çš„ value å +1 å†™å…¥</p><blockquote><p>è¿™é‡Œæ³¨é‡Šä¸­è¯´æ˜äº†è¿™ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ï¼Œæ„å‘³ç€å¯ä»¥å¹¶å‘è¯»å–ï¼Œå¹¶ä¸”ä¼šå¯¼è‡´buffer çš„é‡å å’Œè¦†ç›–ï¼Œè¿˜ä¸æ¸…æ¥šä¸ºä»€ä¹ˆè¿™æ ·å¤„ç†</p><p>æ ¹æ®åç»­ä»£ç è¿™é‡Œè®°å½•çš„ count ä¸»è¦æ˜¯ç”¨äºæ§åˆ¶è¯»ç¼“å†²åŒºçš„ drainæ“ä½œï¼Œå¯èƒ½ä¸éœ€è¦é‚£ä¹ˆå‡†ç¡®ï¼ŒçŒœæµ‹è¿™æ ·å¤„ç†çš„åŸå› æ˜¯å› ä¸ºæ²¡å¿…è¦ä¸ºäº†å¹¶å‘å®‰å…¨ç‰ºç‰²æ€§èƒ½</p></blockquote><p>éšåå°† node è®°å½•åœ¨ readBuffers ä¸­</p><p><strong>drainOnReadIfNeeded</strong></p><p>è¯¥æ–¹æ³•å°±æ˜¯ç”¨äº drain è¯»ç¼“å†²åŒº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainOnReadIfNeeded</span><span class="params">(<span class="type">int</span> bufferIndex, <span class="type">long</span> writeCount)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å– pending æ•°é‡ï¼Œå½“å‰çº¿ç¨‹å¯¹åº”ç¼“å†²åŒºåœ¨ä¸Šä¸€æ­¥æ“ä½œçš„å†™æ•°é‡ - è¯»ç¼“å†²åŒºå¤„ç†çš„æ•°é‡ï¼ˆè®¡ç®—å·®å€¼åˆ¤æ–­æ˜¯å¦åˆ°äº†éœ€è¦åˆ·æ–°çš„é˜ˆå€¼ï¼‰</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">pending</span> <span class="operator">=</span> (writeCount - readBufferDrainAtWriteCount[bufferIndex].get());</span><br><span class="line">    <span class="comment">// READ_BUFFER_THRESHOLD = 32</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">delayable</span> <span class="operator">=</span> (pending &lt; READ_BUFFER_THRESHOLD);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">DrainStatus</span> <span class="variable">status</span> <span class="operator">=</span> drainStatus.get();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦ drain</span></span><br><span class="line">    <span class="keyword">if</span> (status.shouldDrainBuffers(delayable)) &#123;</span><br><span class="line">    tryToDrainBuffers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¯» count è®¡ç®— pending æ•°é‡ï¼Œæ ¹æ® pending å€¼æ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ drainæ“ä½œ</p><p>å…¶ä¸­å¯¹äºæ“ä½œçš„åˆ¤æ–­æ¥è‡ªäº<code>DrainStatus</code>ï¼Œå³çŠ¶æ€æšä¸¾å®ç°çš„æŠ½è±¡æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">DrainStatus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is not taking place. */</span></span><br><span class="line">    IDLE &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !delayable;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is required due to a pending write modification. */</span></span><br><span class="line">    REQUIRED &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A drain is in progress. */</span></span><br><span class="line">    PROCESSING &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determines whether the buffers should be drained.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayable if a drain should be delayed until required</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> if a drain should be attempted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">shouldDrainBuffers</span><span class="params">(<span class="type">boolean</span> delayable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>å¯¹äº<code>REQUIRED</code>ï¼Œè¯´æ˜éœ€è¦ç«‹å³åˆ·æ–°ç¼“å†²åŒºï¼ˆè¿™ä¸ªçŠ¶æ€æœ€ç›´æ¥æ˜¯æ¥è‡ªäºå†™æ“ä½œï¼‰</li><li>å¯¹äº<code>PROCESSING</code>ï¼Œè¯´æ˜å½“å‰å…¶ä»–çº¿ç¨‹æ­£åœ¨å¤„ç†ï¼Œæ‰€ä»¥ä¸éœ€è¦è¯¥çº¿ç¨‹å†è¿›è¡Œæ“ä½œäº†</li><li>å¯¹äº <code>IDLE</code>ï¼Œåˆ™æ ¹æ® pending æ•°é‡å¾—åˆ°çš„ delayableæ¥åˆ¤æ–­</li></ul><p>æœ€åä¹Ÿæ˜¯è°ƒç”¨ <code>tryToDrainBuffers</code> æ–¹æ³•æ¥å¯¹ç¼“å†²åŒºè¿›è¡Œ drainæ“ä½œ</p><h2 id="drainwritebuffer">drainWriteBuffer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainWriteBuffer</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; WRITE_BUFFER_DRAIN_THRESHOLD; i++) &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> writeBuffer.poll();</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    task.run();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–ä¸€å®šæ•°é‡çš„ taskï¼Œç„¶åæ‰§è¡Œ task çš„ run æ–¹æ³•</p><p>æ¯ä¸€æ¬¡ drain æ“ä½œéƒ½æœ‰ä¸€ä¸ªé˜ˆå€¼ï¼ˆWRITE_BUFFER_DRAIN_THRESHOLD =16ï¼‰ï¼Œåº”è¯¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†æ‘Šå·¥ä½œé‡ï¼Œåœ¨ read ä¸­ä¹Ÿæ˜¯è¿™æ ·ç±»ä¼¼çš„è®¾è®¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/** Adds the node to the page replacement policy. */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">AddTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> weight;</span><br><span class="line"></span><br><span class="line">    AddTask(Node&lt;K, V&gt; node, <span class="type">int</span> weight) &#123;</span><br><span class="line">      <span class="built_in">this</span>.weight = weight;</span><br><span class="line">      <span class="built_in">this</span>.node = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;evictionLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      weightedSize.lazySet(weightedSize.get() + weight);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ignore out-of-order write operations</span></span><br><span class="line">      <span class="keyword">if</span> (node.get().isAlive()) &#123;</span><br><span class="line">        evictionDeque.add(node);</span><br><span class="line">        evict();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Removes a node from the page replacement policy. */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RemovalTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node;</span><br><span class="line"></span><br><span class="line">    RemovalTask(Node&lt;K, V&gt; node) &#123;</span><br><span class="line">      <span class="built_in">this</span>.node = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;evictionLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// add may not have been processed yet</span></span><br><span class="line">      evictionDeque.remove(node);</span><br><span class="line">      makeDead(node);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Updates the weighted size and evicts an entry on overflow. */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UpdateTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> weightDifference;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UpdateTask</span><span class="params">(Node&lt;K, V&gt; node, <span class="type">int</span> weightDifference)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.weightDifference = weightDifference;</span><br><span class="line">      <span class="built_in">this</span>.node = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;evictionLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      weightedSize.lazySet(weightedSize.get() + weightDifference);</span><br><span class="line">      applyRead(node);</span><br><span class="line">      evict();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº task çš„å®ç°ï¼Œæœ‰ 3 ç§ï¼š</p><ul><li><code>AddTask</code><ul><li>è°ƒæ•´ weight</li><li><code>evictionDeque</code> æ·»åŠ èŠ‚ç‚¹ï¼ˆå°¾æ’ï¼‰</li><li>è°ƒç”¨é©±é€æ–¹æ³• <code>evict</code></li></ul></li><li><code>RemovalTask</code><ul><li><code>evictionDeque</code> ç§»é™¤èŠ‚ç‚¹</li><li>è®¾ç½®èŠ‚ç‚¹ deadï¼ˆåŒ…æ‹¬è°ƒæ•´ weightï¼‰</li></ul></li><li><code>UpdateTask</code><ul><li>è°ƒæ•´ weight</li><li>è°ƒæ•´ node åˆ°å°¾éƒ¨</li><li>è°ƒç”¨é©±é€æ–¹æ³• <code>evict</code></li></ul></li></ul><p><strong>ä¸ºä»€ä¹ˆ <code>UpdateTask</code> ä¹Ÿéœ€è¦é©±é€å…ƒç´ ï¼Ÿ</strong>å› ä¸ºweight çš„è®¡ç®—æ–¹æ³•æ˜¯ç”±å®ç°ç±»æä¾›çš„ï¼Œå¯èƒ½æ ¹æ®ä¸åŒçš„æƒ…å†µè®¡ç®—weightï¼Œæ›´æ–°æ“ä½œä¹Ÿå¯èƒ½æ›´æ–° weightï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œé©±é€æ“ä½œ</p><p><strong>é©±é€æ–¹æ³• evict</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">evict</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Attempts to evict entries from the map if it exceeds the maximum</span></span><br><span class="line">    <span class="comment">// capacity. If the eviction fails due to a concurrent removal of the</span></span><br><span class="line">    <span class="comment">// victim, that removal may cancel out the addition that triggered this</span></span><br><span class="line">    <span class="comment">// eviction. The victim is eagerly unlinked before the removal task so</span></span><br><span class="line">    <span class="comment">// that if an eviction is still required then a new victim will be chosen</span></span><br><span class="line">    <span class="comment">// for removal.</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡ weight é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">while</span> (hasOverflowed()) &#123;</span><br><span class="line">      <span class="keyword">final</span> Node&lt;K, V&gt; node = evictionDeque.poll();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If weighted values are used, then the pending operations will adjust</span></span><br><span class="line">      <span class="comment">// the size to reflect the correct weight</span></span><br><span class="line">      <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Notify the listener only if the entry was evicted</span></span><br><span class="line">      <span class="keyword">if</span> (data.remove(node.key, node)) &#123;</span><br><span class="line">        <span class="comment">// å¾…é€šçŸ¥é˜Ÿåˆ—</span></span><br><span class="line">        pendingNotifications.add(node);</span><br><span class="line">      &#125;</span><br><span class="line">     <span class="comment">// æ ‡è®°åˆ é™¤</span></span><br><span class="line">      makeDead(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å°±æ˜¯ä¸ºäº†å®ç° LRUï¼Œå¦‚æœè¶…å‡ºäº† weightï¼Œåˆ™ä¼šä»<code>evictionDeque</code> ä¸­ pollå‡ºå…ƒç´ åï¼Œè®°å½•å¾…é€šçŸ¥é˜Ÿåˆ—ï¼Œæ ‡è®°åˆ é™¤</p><p>æ ‡è®°åˆ é™¤åˆ é™¤çš„æ˜¯ Map ç»“æ„ä¸­çš„å…ƒç´ ï¼ˆä¿®æ”¹å…¶ weight æ ‡è®°åˆ é™¤ï¼‰ï¼Œå…¶ä¸­node ä¹Ÿæ˜¯ Map ä¸­æŒæœ‰çš„å¼•ç”¨</p><h2 id="drainreadbuffers">drainReadBuffers</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainReadBuffers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">int</span>) Thread.currentThread().getId();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> start + NUMBER_OF_READ_BUFFERS;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; i++) &#123;</span><br><span class="line">    drainReadBuffer(i &amp; READ_BUFFERS_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">drainReadBuffer</span><span class="params">(<span class="type">int</span> bufferIndex)</span> &#123;</span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">writeCount</span> <span class="operator">=</span> readBufferWriteCount[bufferIndex].get();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; READ_BUFFER_DRAIN_THRESHOLD; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">int</span>) (readBufferReadCount[bufferIndex] &amp; READ_BUFFER_INDEX_MASK);</span><br><span class="line">      <span class="keyword">final</span> AtomicReference&lt;Node&lt;K, V&gt;&gt; slot = readBuffers[bufferIndex][index];</span><br><span class="line">      <span class="keyword">final</span> Node&lt;K, V&gt; node = slot.get();</span><br><span class="line">      <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      slot.lazySet(<span class="literal">null</span>);</span><br><span class="line">      <span class="comment">// æœ¬è´¨ä¸Šå°±æ˜¯å°† evictionDeque ä¸­å¯¹åº”çš„ node ç§»åŠ¨åˆ°é˜Ÿå°¾ï¼ˆLRUï¼‰</span></span><br><span class="line">      applyRead(node);</span><br><span class="line">      readBufferReadCount[bufferIndex]++;</span><br><span class="line">&#125;</span><br><span class="line">readBufferDrainAtWriteCount[bufferIndex].lazySet(writeCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ“ä½œå¯ä»¥æ¦‚æ‹¬æˆå‡ ä¸ªè¦ç‚¹ï¼š</p><ul><li>æ¯ä¸€æ¬¡ drain æ“ä½œåˆ†é…äº† buffer æ“ä½œçš„é˜ˆå€¼</li><li>è·å– nodeï¼Œé‡Šæ”¾ node</li><li>å°† node ç§»åŠ¨åˆ°é˜Ÿå°¾</li><li>è®°å½• readBufferDrainAtWriteCount</li></ul><h1 id="é©±é€ç›‘å¬å™¨">é©±é€ç›‘å¬å™¨</h1><p>æœ€åå°±æ˜¯ <code>notifyListener</code> æ–¹æ³•è°ƒç”¨<code>EvictionListener</code> çš„å®ç°æ¥è¿›è¡Œå…ƒç´ é©±é€çš„é€šçŸ¥åŠŸèƒ½</p><p>ç›¸å…³çš„æ–¹æ³•åœ¨<code>afterRead</code>ã€<code>afterWrite</code>ã€<code>setCapacity</code>ä¸­è¢«è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">notifyListener</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;K, V&gt; node;</span><br><span class="line">    <span class="keyword">while</span> ((node = pendingNotifications.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">  listener.onEviction(node.key, node.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå† pendingNotifications ä¸­è¢«é©±é€çš„ nodeï¼Œè°ƒç”¨ listener çš„<code>onEviction</code> æ–¹æ³•</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://github.com/ben-manes/concurrentlinkedhashmap">ben-manes/concurrentlinkedhashmap:A ConcurrentLinkedHashMap for Java (github.com)</a></p><p>https://code.google.com/p/concurrentlinkedhashmap/</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç»“æ„ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç©ºå¯¹è±¡æ¨¡å¼ - Null Object</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%A9%BA%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F%20-%20Null%20Object.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%A9%BA%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F%20-%20Null%20Object.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>ç©ºå¯¹è±¡æ¨¡å¼ï¼ˆNull ObjectPatternï¼‰ï¼Œä½¿ç”¨ç©ºå¯¹è±¡çš„è¡Œä¸ºï¼ˆç©ºå®ç°ã€æ ¡éªŒç­‰ï¼‰æ¥ä»£æ›¿å¯¹ Nullå€¼çš„åˆ¤æ–­ï¼›ç©ºå¯¹è±¡å¹¶ä¸æ˜¯åœ¨æ£€æŸ¥ç©ºå€¼ï¼Œè€Œæ˜¯é€šè¿‡å¯¹è±¡çš„è¡Œä¸ºå®ç°ä¸è¿›è¡Œä»»ä½•åŠ¨ä½œæˆ–è€…æ ¡éªŒçš„æ•ˆæœï¼Œä»¥æ­¤å¯¹è°ƒç”¨æ–¹éšè—æ›´å¤šçš„å®ç°ç»†èŠ‚</p><p><strong>ç›®çš„</strong>å‘ä¸Šå±‚éšè—æ›´å¤šçš„å®ç°ç»†èŠ‚ï¼ŒåŠ å¼ºç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œå‡å°‘åˆ¤ç©ºåˆ¤æ–­</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong> åœ¨ç°å®ä¸–ç•Œä¸­ä¹Ÿå¾ˆéš¾è¡¨è¾¾ â€ç©ºâ€œè¿™ä¸ªæ¦‚å¿µï¼Œå¾€å¾€ä¼šä½¿ç”¨ â€ç©ºç›’å­â€œã€â€ç©ºé—´â€œæ¥è¿›è¡Œè¡¨è¾¾ï¼Œç±»æ¯”åœ¨ä»£ç ä¸­å°±æ˜¯ä½¿ç”¨è¡¨ç°ç©ºæ¦‚å¿µçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯åˆ¤ç©º<code>obj == null</code> æ¥å®ç°å¯¹ç©ºçš„åˆ¤æ–­</p><h1 id="å®è·µ">å®è·µ</h1><p>æ¨¡æ‹Ÿè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå¯¹ç”¨æˆ·å±•ç¤ºä¸€äº›å•†å“ä¿¡æ¯ï¼Œå…¶ä¸­è¦æ ¹æ®ç”¨æˆ·çš„å±æ€§å¯¹å•†å“è¿›è¡Œè¿‡æ»¤</p><h2 id="é—®é¢˜">é—®é¢˜</h2><p>å¯¹äºæœ€ç»ˆè¿‡æ»¤åçš„å•†å“ï¼Œå¦‚æœæ— æ³•æ»¡è¶³ä¸€å®šæ•°é‡ï¼Œä¾‹å¦‚å•†å“æ•°é‡ &lt;3ï¼Œå°±ä¼šä»é€šç”¨å•†å“æ± ä¸­é€‰æ‹©ä¸€å®šæ•°é‡çš„å•†å“è¿›è¡Œè¡¥ä½</p><p>è¿™æ ·çš„éœ€æ±‚åœ¨ä»£ç æµç¨‹ä¸­å¦‚ä½•è®¾è®¡ï¼Œå¦‚æœåœ¨è¿‡æ»¤æµç¨‹ã€VOè½¬æ¢æµç¨‹ç­‰é˜¶æ®µæ¥å®ç°ï¼Œå°±ä¼šè®©é€»è¾‘çœ‹èµ·æ¥ä¸å¤ªé¡ºç•…</p><p>è¿™æ—¶å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ç©ºå¯¹è±¡æ¨¡å¼</p><h2 id="å®ç°">å®ç°</h2><h3 id="å…¨éƒ¨å•†å“ä¿¡æ¯">å…¨éƒ¨å•†å“ä¿¡æ¯</h3><p>å…ˆå®šä¹‰å‡ºä¸€ä¸ªå•†å“ä¿¡æ¯é›†åˆï¼Œå½“ç„¶è¿™äº›å•†å“ä¿¡æ¯å¯ä»¥é€šè¿‡æ¥å£ã€æ•°æ®åº“ç³»ç»Ÿç­‰æ¥è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer num;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Pair&lt;Integer, Integer&gt; ageRange;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;GoodsInfo&gt; <span class="title function_">getAllGoodsInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ´—è¡£æœº&quot;</span>, <span class="number">10</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">20</span>, <span class="number">50</span>), BigDecimal.valueOf(<span class="number">2000.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;ç¬”è®°æœ¬ç”µè„‘&quot;</span>, <span class="number">21</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">15</span>, <span class="number">50</span>), BigDecimal.valueOf(<span class="number">4999.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ‰«åœ°æœºå™¨äºº&quot;</span>, <span class="number">5</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">25</span>, <span class="number">55</span>), BigDecimal.valueOf(<span class="number">2500.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;å¨å…·&quot;</span>, <span class="number">30</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">30</span>, <span class="number">60</span>), BigDecimal.valueOf(<span class="number">89.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ–‡å…·&quot;</span>, <span class="number">100</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">8</span>, <span class="number">30</span>), BigDecimal.valueOf(<span class="number">30.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;ç©ºè°ƒ&quot;</span>, <span class="number">6</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">30</span>, <span class="number">60</span>), BigDecimal.valueOf(<span class="number">5100.0</span>)),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;å„¿ç«¥ç©å…·&quot;</span>, <span class="number">40</span>, <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">10</span>, <span class="number">50</span>), BigDecimal.valueOf(<span class="number">100.0</span>))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ç±»">ç”¨æˆ·ç±»</h3><p>ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåç»­ä¸šåŠ¡å°†ä¼šæ ¹æ® <code>age</code> å’Œ<code>expectPrice</code> å±æ€§å¯¹å±•ç¤ºçš„å•†å“è¿›è¡Œè¿‡æ»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Pair&lt;BigDecimal, BigDecimal&gt; expectPrice;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿‡æ»¤è§„åˆ™æ¥å£åŠå®ç°">è¿‡æ»¤è§„åˆ™æ¥å£åŠå®ç°</h3><p>æä¾›è¿‡æ»¤è§„åˆ™æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GoodsFilterHandler</span> &#123;</span><br><span class="line">    List&lt;GoodsInfo&gt; <span class="title function_">filter</span><span class="params">(List&lt;GoodsInfo&gt; goodsInfos, User user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¹æ®å¹´é¾„è¿›è¡Œè¿‡æ»¤å®ç°</strong></p><p>æ ¹æ®å•†å“ä¿¡æ¯ä¸Šçš„å¹´é¾„å’Œç”¨æˆ·çš„å¹´é¾„è¿›è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AgeFilter</span> <span class="keyword">implements</span> <span class="title class_">GoodsFilterHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;GoodsInfo&gt; <span class="title function_">filter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; goodsInfos, <span class="keyword">final</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsInfos.stream().filter(</span><br><span class="line">            goodsInfo -&gt; goodsInfo.getAgeRange().getKey() &lt;= user.getAge() &amp;&amp; goodsInfo.getAgeRange().getValue() &gt;= user</span><br><span class="line">                .getAge()).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¹æ®æœŸæœ›ä»·æ ¼åŒºé—´è¿›è¡Œè¿‡æ»¤å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpectPriceFilter</span> <span class="keyword">implements</span> <span class="title class_">GoodsFilterHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;GoodsInfo&gt; <span class="title function_">filter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; goodsInfos, <span class="keyword">final</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsInfos.stream().filter(</span><br><span class="line">            goodsInfo -&gt; user.getExpectPrice().getKey().compareTo(goodsInfo.getPrice()) &lt;= <span class="number">0</span></span><br><span class="line">                &amp;&amp; user.getExpectPrice().getValue().compareTo(goodsInfo.getPrice()) &gt;= <span class="number">0</span>).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿‡æ»¤æµç¨‹æ¨¡æ¿æ–¹æ³•åŠå®ç°">è¿‡æ»¤æµç¨‹æ¨¡æ¿æ–¹æ³•åŠå®ç°</h3><p>è¯¥æŠ½è±¡ç±»ä¸»è¦è¿›è¡Œä¸¤éƒ¨åˆ†æ“ä½œï¼š</p><ul><li>å®ç°ç±»æ³¨å†Œè¿‡æ»¤å™¨å®ç°</li><li><code>filter</code>æ–¹æ³•æ ¹æ®æ³¨å†Œçš„è¿‡æ»¤å™¨å®ç°å¯¹ç»“æœé›†è¿›è¡Œè¿‡æ»¤ï¼Œå…¶ä¸­åœ¨æœ€åé€šè¿‡å·¥å‚æ–¹æ³•å¯¹ç»“æœé›†ç”Ÿæˆä¸åŒçš„<code>Converter</code> å®ç°ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractGoodsFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;GoodsFilterHandler&gt; <span class="title function_">goodsFilterHandlers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">filter</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        List&lt;GoodsFilterHandler&gt; goodsFilterHandlers = goodsFilterHandlers();</span><br><span class="line">        List&lt;GoodsInfo&gt; curGoods = GoodsInfo.getAllGoodsInfo();</span><br><span class="line">        <span class="keyword">for</span> (GoodsFilterHandler handler : goodsFilterHandlers) &#123;</span><br><span class="line">            curGoods = handler.filter(curGoods, user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç”Ÿæˆä¸åŒçš„ Converter å®ç°ç±»</span></span><br><span class="line">        <span class="keyword">return</span> GoodsInfoConverterFactory.buildConverter(curGoods).buildVO();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Common å®ç°</strong></p><p>æ³¨å†Œäº†è¿‡æ»¤è§„åˆ™çš„ä¸¤ä¸ªå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonGoodsFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractGoodsFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;GoodsFilterHandler&gt; <span class="title function_">goodsFilterHandlers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> <span class="title class_">AgeFilter</span>(), <span class="keyword">new</span> <span class="title class_">ExpectPriceFilter</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è½¬æ¢å™¨å·¥å‚ä¸å®ç°">è½¬æ¢å™¨å·¥å‚ä¸å®ç°</h3><ul><li><code>buildConverter</code> æ–¹æ³•æ ¹æ®ç»“æœé›†ç”Ÿæˆä¸åŒçš„å®ç°ç±»</li><li><code>CommonConverter</code> æ²¡æœ‰è¡Œä¸º</li><li><code>LackConverter</code>å³ç©ºå¯¹è±¡æ¨¡å¼çš„å®ç°ï¼Œä¼šåœ¨è¿”å›çš„ç»“æœé›†ä¸Šè¡¥å……æ¨¡æ‹Ÿå•†å“ï¼ˆå¥½å§ï¼Œæ„Ÿè§‰è¿™ä¸ªä¾‹å­æœ‰ç‚¹ç‰µå¼ºï¼‰</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsInfoConverterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_GOODS_INFO_LACK_SIZE</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">GoodsInfoConverterFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GoodsInfoConverter <span class="title function_">buildConverter</span><span class="params">(List&lt;GoodsInfo&gt; goodsInfos)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isEmpty(goodsInfos) || goodsInfos.size() &lt; DEFAULT_GOODS_INFO_LACK_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LackConverter</span>(goodsInfos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonConverter</span>(goodsInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> List&lt;GoodsInfo&gt; result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">buildVO</span><span class="params">()</span> &#123;</span><br><span class="line">            List&lt;GoodsInfo&gt; res = convert();</span><br><span class="line">            <span class="keyword">return</span> res.stream().map(GoodsInfo::getName).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">GoodsInfoConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.result = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CommonConverter</span> <span class="keyword">extends</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CommonConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LackConverter</span> <span class="keyword">extends</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LackConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ArrayList&lt;GoodsInfo&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(result);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> result.size(); i &lt; DEFAULT_GOODS_INFO_LACK_SIZE; i++) &#123;</span><br><span class="line">                res.add(<span class="keyword">new</span> <span class="title class_">GoodsInfo</span>(<span class="string">&quot;æ¨¡æ‹Ÿå•†å“&quot;</span>, <span class="number">1</span>, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨">ä½¿ç”¨</h3><p>ä»»æ„æ„é€ ä¸€ä¸ªç”¨æˆ·ï¼Œç»è¿‡è¿‡æ»¤å™¨è¿”å›å…¶å±•ç¤ºçš„ä¼˜å…ˆçº§é«˜çš„å•†å“</p><p>å…¶ä¸­æ ¹æ®è¿‡æ»¤è§„åˆ™ï¼Œç”¨æˆ· 1 æ— æ³•æ»¡è¶³ &gt;= 3çš„æ¡ä»¶ï¼Œæ‰€ä»¥ä½¿ç”¨äº†æ¨¡æ‹Ÿå•†å“è¿›è¡Œè¡¥ä½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user1.setName(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">    user1.setAge(<span class="number">20</span>);</span><br><span class="line">    user1.setExpectPrice(<span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(BigDecimal.valueOf(<span class="number">10</span>), BigDecimal.valueOf(<span class="number">500</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user2.setName(<span class="string">&quot;æå››&quot;</span>);</span><br><span class="line">    user2.setAge(<span class="number">50</span>);</span><br><span class="line">    user2.setExpectPrice(<span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(BigDecimal.valueOf(<span class="number">2000</span>), BigDecimal.valueOf(<span class="number">7000</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="type">CommonGoodsFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonGoodsFilter</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [æ–‡å…·, å„¿ç«¥ç©å…·, æ¨¡æ‹Ÿå•†å“]</span></span><br><span class="line">    List&lt;String&gt; res1 = filter.filter(user1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [æ´—è¡£æœº, ç¬”è®°æœ¬ç”µè„‘, æ‰«åœ°æœºå™¨äºº, ç©ºè°ƒ]</span></span><br><span class="line">    List&lt;String&gt; res2 = filter.filter(user2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è°ƒæ•´è§„åˆ™</strong></p><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆç©ºå¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘ï¼ˆè¿™é‡Œæ˜¯åˆ¤æ–­ sizeå°äºé˜ˆå€¼ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ç§ç©ºè¡Œä¸ºï¼‰å’Œæ•´ä¸ªè¿‡æ»¤é€»è¾‘æ— å…³ï¼Œä¸šåŠ¡é€»è¾‘ä¸­ä¹Ÿä¸éœ€è¦è¿›è¡Œåˆ¤ç©ºï¼ˆå·¥å‚æ–¹æ³•é™¤å¤–ï¼‰ï¼Œå¯¹äºä¸Šæ¸¸<code>AbstractGoodsFilter</code>è€Œè¨€ï¼Œå®ƒåªæ˜¯åœ¨æ‰§è¡Œè¿‡æ»¤é€»è¾‘ï¼Œè€Œå…·ä½“ç»“æœé›†å¹¶ä¸å…³å¿ƒï¼Œç»“æœé›†çš„è½¬æ¢ç”±ç©ºå¯¹è±¡å®ç°æ¥å®ç°</p><p>å¦‚æœäº§å“éœ€æ±‚è¿›è¡Œå˜åŠ¨ï¼Œå½“ size å°äº 3æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™æ•´ä¸ªå¤§çš„ä¸šåŠ¡é€»è¾‘éƒ½ä¸éœ€è¦å˜åŠ¨ï¼Œåªéœ€è¦æ”¹å˜ç©ºå¯¹è±¡çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LackConverter</span> <span class="keyword">extends</span> <span class="title class_">GoodsInfoConverter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LackConverter</span><span class="params">(<span class="keyword">final</span> List&lt;GoodsInfo&gt; result)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;GoodsInfo&gt; <span class="title function_">convert</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;æ¨èå•†å“å±æ€§ size &lt; &quot;</span> + DEFAULT_GOODS_INFO_LACK_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨">å®é™…åº”ç”¨</h2><p>ä¸Šé¢çš„ä¾‹å­åœ¨ä½¿ç”¨ç©ºå¯¹è±¡å®ç°æ¥è¿›è¡Œç‰¹æ®Šçš„ä¸šåŠ¡æµç¨‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç©ºå¯¹è±¡æ¨¡å¼æ¥å¯¹é»˜è®¤è¡Œä¸ºè¿›è¡Œç©ºå®ç°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸Šæ¸¸è°ƒç”¨çš„åˆ¤ç©ºä»£ç </p><p>ä¾‹å¦‚ Google çš„ <code>ConcurrentLinkedHashMap</code></p><p>åœ¨å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼ˆä½¿ç”¨ <code>ConcurrentLinkedHashMap.Builder</code>å¯¹è±¡ï¼‰ï¼Œ<code>listener</code> å‚æ•°çš„é»˜è®¤å€¼å°±æ˜¯ä¸€ä¸ªå›ºå®šçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Builder</span><span class="params">()</span> &#123;</span><br><span class="line">      capacity = -<span class="number">1</span>;</span><br><span class="line">      weigher = Weighers.entrySingleton();</span><br><span class="line">      initialCapacity = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">      concurrencyLevel = DEFAULT_CONCURRENCY_LEVEL;</span><br><span class="line">      <span class="comment">// é»˜è®¤å®ç° DiscardingListener.INSTANCE</span></span><br><span class="line">      listener = (EvictionListener&lt;K, V&gt;) DiscardingListener.INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é€šè¿‡ <code>Builder</code> è¿›è¡Œå®ä¾‹åŒ–ä¸­ï¼ŒçœŸæ­£åˆ›å»ºçš„<code>ConcurrentLinkedHashMap</code> å¯¹è±¡ä¼šæ ¹æ®é»˜è®¤å€¼è®¾ç½®ä¸€ä¸ªé€šçŸ¥é˜Ÿåˆ—<code>pendingNotifications</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ConcurrentLinkedHashMap</span><span class="params">(Builder&lt;K, V&gt; builder)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// The notification queue and listener</span></span><br><span class="line">    listener = builder.listener;</span><br><span class="line">    pendingNotifications = (listener == DiscardingListener.INSTANCE)</span><br><span class="line">        ? (Queue&lt;Node&lt;K, V&gt;&gt;) DISCARDING_QUEUE</span><br><span class="line">        : <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;Node&lt;K, V&gt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯é»˜è®¤å€¼åˆ™ä¼šä½¿ç”¨ <code>DISCARDING_QUEUE</code></p><p><code>DISCARDING_QUEUE</code>å°±æ˜¯ä¸€ç§ç©ºå®ç°ï¼Œä¼šä¸¢å¼ƒæ‰€æœ‰çš„é€šçŸ¥ï¼ˆå³ä¸é€šçŸ¥ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A queue that discards all entries. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Queue&lt;?&gt; DISCARDING_QUEUE = <span class="keyword">new</span> <span class="title class_">DiscardingQueue</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** A queue that discards all additions and is always empty. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DiscardingQueue</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Object e)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">poll</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">peek</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Iterator&lt;Object&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123; <span class="keyword">return</span> emptyList().iterator(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>ç©ºå¯¹è±¡æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>å®ƒå¯ä»¥åŠ å¼ºç³»ç»Ÿçš„ç¨³å›ºæ€§ï¼Œèƒ½æœ‰æœ‰æ•ˆåœ°é˜²æ­¢ç©ºæŒ‡é’ˆæŠ¥é”™å¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ï¼Œä½¿ç³»ç»Ÿæ›´åŠ ç¨³å®š</li><li>å®ƒèƒ½å¤Ÿå®ç°å¯¹ç©ºå¯¹è±¡æƒ…å†µçš„å®šåˆ¶åŒ–çš„æ§åˆ¶ï¼Œèƒ½å¤ŸæŒæ¡å¤„ç†ç©ºå¯¹è±¡çš„ä¸»åŠ¨æƒ</li><li>å®ƒå¹¶ä¸ä¾é  Client æ¥ä¿è¯æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šè¿è¡Œ</li><li>å®ƒé€šè¿‡ <code>isNull</code> å¯¹ <code>==null</code>çš„æ›¿æ¢ï¼Œæ˜¾å¾—æ›´åŠ ä¼˜é›…ï¼Œæ›´åŠ æ˜“æ‡‚</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://baike.baidu.com/item/ç©ºå¯¹è±¡æ¨¡å¼/22932789?fr=aladdin">ç©ºå¯¹è±¡æ¨¡å¼_ç™¾åº¦ç™¾ç§‘(baidu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç”¨ä¿¡é¸½è§£é‡Š HTTPS</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/%E7%94%A8%E4%BF%A1%E9%B8%BD%E8%A7%A3%E9%87%8A%20HTTPS.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/%E7%94%A8%E4%BF%A1%E9%B8%BD%E8%A7%A3%E9%87%8A%20HTTPS.html</url>
      
        <content type="html"><![CDATA[<p>å¯†ç å­¦æ˜¯ä¸€é—¨æ·±å¥¥éš¾æ‡‚çš„å­¦ç§‘ï¼Œå®ƒå……æ»¡äº†æ•°å­¦è¯æ˜ï¼›ä½†é™¤éæ˜¯æ­£åœ¨å¼€å‘å¯†ç ç³»ç»Ÿï¼Œå¦åˆ™ä¸å¿…äº†è§£å¤ªå¤šæ·±å±‚æ¬¡çš„çŸ¥è¯†</p><p>å¦‚æœä½ æ‰“å¼€è¿™ç¯‡æ–‡ç« æ˜¯å¸Œæœ›åˆ›é€ ä¸‹ä¸€ä»£ HTTPSåè®®ï¼Œé‚£ä¹ˆå¾ˆæŠ±æ­‰ï¼Œåªæœ‰â€œé¸½å­â€æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼›å¦‚æœä½ çš„ç›®çš„ä¸åœ¨äºæ­¤ï¼Œé‚£ä¹ˆè¯·æ¬£èµè¿™ç¯‡æ–‡ç« </p><h1 id="çˆ±ä¸½ä¸é²å‹ƒå’Œ-......-é¸½å­">çˆ±ä¸½ä¸ã€é²å‹ƒå’Œ ...... é¸½å­ï¼Ÿ</h1><p>åœ¨äº’è”ç½‘ä¸Šçš„ä»»ä½•æ´»åŠ¨ï¼ˆé˜…è¯»è¿™ç¯‡æ–‡ç« ã€åœ¨ Amazonå¹³å°è´­ä¹°å•†å“ã€ä¸Šä¼ çŒ«å’ªå›¾ç‰‡ï¼‰å½’æ ¹ç»“åº•æ˜¯åŒæœåŠ¡å™¨å‘é€æˆ–è€…æ¥æ”¶æ¶ˆæ¯</p><p>å¯èƒ½å¬èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹è¿™äº›ä¿¡æ¯æ˜¯ç”±<strong>ä¿¡é¸½</strong>ï¼ˆcarrierpigeonsï¼‰ä¼ é€’çš„ï¼Œæˆ‘çŸ¥é“è¿™ä¸ªæ¯”å–»çœ‹èµ·æ¥å¾ˆéšæ„ï¼Œä½†ç›¸ä¿¡æˆ‘ï¼ŒHTTPSçš„å·¥ä½œæ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œå°½ç®¡è¦å¿«å¾—å¤š</p><p>æ­¤å¤–ï¼Œåé¢ä¼šä½¿ç”¨çˆ±ä¸½ä¸ã€é²å‹ƒã€é©¬æ´›é‡Œæ¥ä»£æ›¿æœåŠ¡å™¨ã€ç”¨æˆ·å’Œé»‘å®¢ï¼›å¦‚æœè¿™ä¸æ˜¯ä½ ç¬¬ä¸€æ¬¡å°è¯•ç†è§£å¯†ç æ¦‚å¿µï¼Œä½ ä¼šè®¤å‡ºè¿™äº›åå­—ï¼Œå› ä¸ºå®ƒä»¬åœ¨ç›¸å…³æŠ€æœ¯æ–‡çŒ®ä¸­è¢«å¹¿æ³›ä½¿ç”¨</p><h1 id="ç¬¬ä¸€æ¬¡å¹¼ç¨šçš„äº¤æµ">ç¬¬ä¸€æ¬¡å¹¼ç¨šçš„äº¤æµ</h1><p>å¦‚æœçˆ±ä¸½ä¸æƒ³è¦å‘é€ä¸€æ¡æ¶ˆæ¯ç»™é²å‹ƒï¼Œå¥¹å°†è¿™æ¡æ¶ˆæ¯ç»‘åœ¨ä¿¡é¸½çš„è…¿ä¸Šè®©å®ƒé£å‘é²å‹ƒï¼›é²å‹ƒæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œçœ‹äº†çœ‹è§‰å¾—éå¸¸å¥½</p><p>ä½†æ˜¯å¦‚æœé©¬æ´›é‡Œæ‹¦æˆªäº†çˆ±ä¸½ä¸æ­£åœ¨é£è¡Œçš„ä¿¡é¸½éšåæ›¿æ¢äº†æ¶ˆæ¯å‘¢ï¼Ÿé²å‹ƒæ— æ³•çŸ¥é“æ¶ˆæ¯åœ¨è¿è¾“çš„è¿‡ç¨‹ä¸­è¢«ç¯¡æ”¹äº†</p><p>è¿™å°±æ˜¯ <strong>HTTP</strong> çš„å·¥ä½œåŸç†ï¼Œå¾ˆå¯æ€•å¯¹å§ï¼Œæˆ‘ä¸ä¼šé€šè¿‡ HTTPå‘é€æˆ‘çš„é“¶è¡Œå‡­è¯ï¼Œä½ ä¹Ÿä¸ä¼š</p><h1 id="åŠ å¯†">åŠ å¯†</h1><p>å¦‚æœçˆ±ä¸½ä¸å’Œé²å‹ƒå¾ˆç‹¡çŒ¾ï¼Œä»–ä»¬äº’ç›¸å®šä¹‰äº†ä¸€å¥—åŠ å¯†è§„åˆ™æ¥ä¹¦å†™æ¶ˆæ¯ï¼Œä¾‹å¦‚å°†å­—æ¯è¡¨ä¸­çš„æ¯ä¸€ä¸ªå­—æ¯éƒ½ä½ç§»3 ä½æ¥è¡¨ç¤º</p><p>ä¸¾ä¸ªä¾‹å­ï¼šD -&gt; Aï¼ŒE -&gt; Bï¼ŒF -&gt; Cï¼ŒåŸæœ¬çš„æ¶ˆæ¯ â€œsecretmessageâ€ å°†ä¼šè¢«æ›¿æ¢æˆ â€œpbzobq jbppxdbâ€</p><p>ç°åœ¨å¦‚æœé©¬æ´›é‡Œæ‹¦æˆªäº†ä¿¡é¸½ï¼Œå¥¹å°†æ— æ³•å°†ä¿¡æ¯è½¬æ¢ä¸ºæœ‰æ„ä¹‰çš„å†…å®¹ï¼Œä¹Ÿæ— æ³•ç†è§£å®ƒçš„æ„æ€ï¼Œå› ä¸ºå¥¹ä¸çŸ¥é“åŠ å¯†æ–¹å¼ï¼ˆsecretcodeï¼‰ï¼›ä½†æ˜¯é²å‹ƒå¯ä»¥è½»æ˜“åœ°å°†æ¶ˆæ¯åå‘è§£ç ï¼Œæ ¹æ® A -&gt; Dï¼ŒB -&gt; Eï¼ŒC-&gt; F çš„è§„åˆ™ï¼Œå°† â€œpbzobq jbppxdbâ€ è§£ç å› â€œsecret messageâ€</p><p>æˆåŠŸäº†ï¼</p><p>è¿™å°±è¢«ç§°ä¸º<strong>å¯¹ç§°åŠ å¯†</strong>ï¼ˆsymmetric keycryptographyï¼‰ï¼Œå› ä¸ºå¦‚æœçŸ¥é“äº†å¦‚ä½•è§£ç ï¼Œå°±çŸ¥é“äº†å¦‚ä½•åŠ å¯†</p><p>ä¸Šé¢æè¿°çš„å¯†ç é€šå¸¸è¢«ç§°ä¸º<strong>å‡¯æ’’å¯†ç </strong>ï¼ˆCaesarcipherï¼‰ï¼›åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ›´ä¸ºå¤æ‚çš„æ–¹å¼ï¼Œä½†ä¸»è¦æ€æƒ³æ˜¯ä¸€æ ·çš„</p><h1 id="æˆ‘ä»¬å¦‚ä½•ç¡®å®šå¯†é’¥">æˆ‘ä»¬å¦‚ä½•ç¡®å®šå¯†é’¥ï¼Ÿ</h1><p>å¦‚æœé™¤äº†å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹å¤–æ²¡æœ‰äººçŸ¥é“ä½¿ç”¨äº†ä»€ä¹ˆå¯†é’¥ï¼Œå¯¹ç§°åŠ å¯†æ˜¯éå¸¸å®‰å…¨çš„ï¼›åœ¨å‡¯æ’’å¯†ç ä¸­ï¼Œå¯†é’¥æ˜¯æˆ‘ä»¬å°†æ¯ä¸ªå­—æ¯ç§»åŠ¨å¤šå°‘ä¸ªå­—æ¯çš„åç§»é‡ï¼›åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨äº†åç§»é‡3ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ 4 æˆ– 12 ç­‰ç­‰</p><p>è¿™ä¸ªä¾‹å­çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœçˆ±ä¸½ä¸å’Œé²å‹ƒåœ¨å¼€å§‹ç”¨é¸½å­å‘é€æ¶ˆæ¯ä¹‹å‰æ²¡æœ‰è§é¢ï¼Œä»–ä»¬å°†æ— æ³•å®‰å…¨åœ°å»ºç«‹å¯†é’¥ï¼›å¦‚æœä»–ä»¬å°†å¯†é’¥éšæ¶ˆæ¯ä¸€èµ·å‘é€ï¼Œé‚£ä¹ˆé©¬æ´›é‡Œå°±ä¼šæ‹¦æˆªå¹¶å‘ç°å¯†é’¥ï¼Œè¿™å°†ä¼šå¯¼è‡´é©¬æ´›é‡Œåœ¨çˆ±ä¸½ä¸å’Œé²å‹ƒåœ¨ç»™æ¶ˆæ¯åŠ å¯†ä¹‹åä¾ç„¶å¯ä»¥éšæ„è·å–ã€ç¯¡æ”¹æ¶ˆæ¯</p><p>è¿™å°±æ˜¯<strong>ä¸­é—´äººæ”»å‡»</strong>ï¼ˆMan in the MiddleAttackï¼‰çš„å…¸å‹ç¤ºä¾‹ï¼Œé¿å…è¿™ç§æ”»å‡»çš„å”¯ä¸€æ–¹æ³•æ˜¯ä¸€èµ·æ›´æ”¹åŠ å¯†ç³»ç»Ÿ</p><h1 id="ä¿¡é¸½æºå¸¦çš„ç›’å­">ä¿¡é¸½æºå¸¦çš„ç›’å­</h1><p>æ‰€ä»¥çˆ±ä¸½ä¸å’Œé²å‹ƒæƒ³å‡ºäº†ä¸€ä¸ªæ›´å¥½çš„æ–¹æ¡ˆï¼Œå½“é²å‹ƒæƒ³è¦å‘çˆ±ä¸½ä¸å‘é€æ¶ˆæ¯æ—¶ï¼Œå°†éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</p><ul><li>é²å‹ƒç»™çˆ±ä¸½ä¸å‘é€ä¸€åªé¸½å­ï¼Œèº«ä¸Šä¸æºå¸¦ä»»ä½•ä¿¡æ¯</li><li>çˆ±ä¸½ä¸è®©è¿™åªé¸½å­æºå¸¦ä¸€ä¸ªç›’å­ï¼Œç›’å­æœ‰é”è€Œä¸”æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œé’¥åŒ™åœ¨çˆ±ä¸½ä¸è¿™é‡Œï¼Œå°†é¸½å­è¿”è¿˜ç»™é²å‹ƒ</li><li>é²å‹ƒå°†æ¶ˆæ¯æ”¾å…¥ç›’å­ï¼Œé”ä¸Šé”ï¼Œå¹¶å†æ¬¡å°†é¸½å­å‘ç»™çˆ±ä¸½ä¸</li><li>çˆ±ä¸½ä¸è·å–åˆ°ç›’å­ï¼Œä½¿ç”¨è‡ªå·±çš„é’¥åŒ™æ‰“å¼€ç›’å­åé˜…è¯»ç›’å­å†…çš„æ¶ˆæ¯</li></ul><p>è¿™ç§æ–¹å¼é©¬æ´›é‡Œåœ¨æ‹¦æˆªåˆ°ä¿¡é¸½åä¹Ÿæ— æ³•ä¿®æ”¹å†…å®¹ï¼Œå› ä¸ºä»–å¹¶æ²¡æœ‰ç›’å­çš„é’¥åŒ™ï¼›å½“çˆ±ä¸½ä¸å¸Œæœ›ç»™é²å‹ƒå‘é€æ¶ˆæ¯æ—¶ï¼Œéµå¾ªåŒæ ·çš„æµç¨‹</p><p>çˆ±ä¸½ä¸å’Œé²å‹ƒå°±æ˜¯ä½¿ç”¨äº†é€šå¸¸ç§°ä¸º<strong>éå¯¹ç§°åŠ å¯†</strong>ï¼ˆasymmetrickeycryptographyï¼‰çš„æŠ€æœ¯ï¼Œä¹‹æ‰€ä»¥ç§°ä¸º<strong>ä¸å¯¹ç§°</strong>ï¼ˆasymmetricï¼‰ï¼Œæ˜¯å› ä¸ºå³ä½¿å¯ä»¥å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼ˆé”ä¸Šç›’å­ï¼‰ï¼Œä¹Ÿæ— æ³•è§£å¯†æ¶ˆæ¯ï¼ˆæ‰“å¼€ç›’å­ï¼‰</p><p>åœ¨æŠ€æœ¯æœ¯è¯­ä¸­ï¼Œç›’å­è¢«ç§°ä¸º<strong>å…¬é’¥</strong>ï¼ˆpublickeyï¼‰ï¼Œç›’å­å¤–é”çš„é’¥åŒ™ç§°ä¸º<strong>ç§é’¥</strong>ï¼ˆprivate keyï¼‰</p><h1 id="å¦‚ä½•ç›¸ä¿¡è¿™ä¸ªç›’å­">å¦‚ä½•ç›¸ä¿¡è¿™ä¸ªç›’å­ï¼Ÿ</h1><p>å¦‚æœç†è§£äº†ä¸Šè¿°å†…å®¹ï¼Œä¼šå‘ç°ä¾ç„¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼›å½“é²å‹ƒæ¥æ”¶åˆ°ç›’å­æ—¶ï¼Œå¦‚ä½•ç¡®å®šè¿™ä¸ªç›’å­å‘é€äºçˆ±ä¸½ä¸è€Œä¸æ˜¯é©¬æ´›é‡Œæ‹¦æˆªäº†é¸½å­ï¼Œå°†ç›’å­æ¢æˆäº†å¥¹æŒæœ‰é’¥åŒ™çš„ç›’å­å‘¢ï¼Ÿ</p><p>çˆ±ä¸½ä¸å†³å®šåœ¨ç›’å­ä¸Šç­¾åï¼Œè¿™æ ·å½“é²å‹ƒæ”¶åˆ°ç›’å­æ—¶ï¼Œä»–æ£€æŸ¥ç­¾åå°±å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸æ˜¯çˆ±ä¸½ä¸å‘é€çš„ç›’å­</p><p>å¯èƒ½ä¼šæœ‰äººè¿™æ ·æƒ³ï¼Œé²å‹ƒä¸€å¼€å§‹æ˜¯å¦‚ä½•è¯†åˆ«çˆ±ä¸½ä¸çš„ç­¾åçš„ï¼Ÿçˆ±ä¸½ä¸å’Œé²å‹ƒé¢ä¸´åŒæ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥ä»–ä»¬å†³å®šï¼Œè®©æ³°å¾·æ¥ä»£æ›¿çˆ±ä¸½ä¸æ¥è¿›è¡Œç­¾å</p><p>è°æ˜¯æ³°ç‰¹ï¼Ÿæ³°å¾·æ˜¯ä¸€ä¸ªéå¸¸æœ‰åã€çŸ¥åä¸”å€¼å¾—ä¿¡èµ–çš„äººï¼Œæ³°å¾·ç»™ä»»ä½•ä¸ªäººç­¾åï¼Œæ¯ä¸ªäººéƒ½ç›¸ä¿¡ä»–åªä¼šç»™åˆæ³•çš„äººç­¾å</p><p>æ¥ä¸‹æ¥ï¼Œæ³°å¾·åªæœ‰åœ¨ç¡®å®šè¦æ±‚ç­¾åçš„äººæ˜¯çˆ±ä¸½ä¸çš„æƒ…å†µä¸‹æ‰ä¼šåœ¨çˆ±ä¸½ä¸ç›’å­ä¸Šç­¾åï¼›å› æ­¤é©¬æ´›é‡Œè®©æ³°å¾·åœ¨è‡ªå·±çš„ç›’å­ä¸Šç­¾ä¸Šçˆ±ä¸½ä¸çš„åå­—ï¼Œæ‰€ä»¥ä¼šè¢«é²å‹ƒå‘ç°è¿™æ˜¯ä¸€ä¸ªéª—å±€</p><p>åœ¨æŠ€æœ¯æœ¯è¯­ä¸­ï¼Œæ³°å¾·é€šå¸¸è¢«ç§°ä¸º<strong>è®¤è¯æœºæ„</strong>ï¼ˆCertificationAuthorityï¼‰ï¼Œæ‚¨é˜…è¯»æœ¬æ–‡æ—¶ä½¿ç”¨çš„æµè§ˆå™¨é™„å¸¦äº†å„ç§è®¤è¯æœºæ„çš„ç­¾å</p><p>æ‰€ä»¥å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿æ¥ç½‘ç»œå¹¶ä¸”ç›¸ä¿¡ç›’å­ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ç›¸ä¿¡æ³°å¾·ï¼Œå¹¶ä¸”æ³°å¾·å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªç›’å­æ˜¯åˆæ³•çš„</p><h1 id="æ²‰é‡çš„ç›’å­">æ²‰é‡çš„ç›’å­</h1><p>çˆ±ä¸½ä¸å’Œé²å‹ƒç°åœ¨æœ‰äº†ä¸€ä¸ªå¯é çš„é€šä¿¡ç³»ç»Ÿï¼Œä½†ä»–ä»¬æ„è¯†åˆ°æºå¸¦ç›’å­çš„é¸½å­æ¯”åªæºå¸¦ä¿¡æ¯çš„é¸½å­é£è¡Œçš„è¦æ…¢ï¼Œå› ä¸ºç›’å­æœ‰ä¸€å®šé‡é‡</p><p>æ‰€ä»¥ä»–ä»¬å†³å®šï¼Œå°†ä½¿ç”¨ç›’å­ï¼ˆéå¯¹ç§°åŠ å¯†ï¼‰æ¥åŠ å¯†å¯†é’¥ï¼Œè€Œä½¿ç”¨å¯¹ç§°å¯†ç å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼ˆè¿˜è®°å¾—å‡¯æ’’å¯†ç å—ï¼Ÿï¼‰</p><p>è¿™æ ·å°±å¯ä»¥ä¸¤å…¨å…¶ç¾ï¼š<strong>å…¼é¡¾éå¯¹ç§°å¯†ç çš„å¯é æ€§å’Œå¯¹ç§°å¯†ç çš„æ•ˆç‡</strong></p><p>åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œæ²¡æœ‰é£è¡Œç¼“æ…¢çš„é¸½å­ï¼Œä½†ä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¶ˆæ¯æ¯”ä½¿ç”¨å¯¹ç§°åŠ å¯†æ›´æ…¢ï¼Œå› æ­¤æˆ‘ä»¬åªä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¥äº¤æ¢åŠ å¯†å¯†é’¥</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://baida.dev/articles/https-explained-with-carrier-pigeons">HTTPSexplained with carrier pigeons</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è£…é¥°æ¨¡å¼ - Decorator</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F%20-%20Decorator.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F%20-%20Decorator.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>è£…é¥°æ¨¡å¼ï¼ˆDecoratorPatternï¼‰ä¹Ÿå«è£…é¥°å™¨æ¨¡å¼ï¼Œå¯ä»¥å®ç°åœ¨ä¸å¿…æ”¹å˜åŸç±»æ–‡ä»¶å’Œä½¿ç”¨ç»§æ‰¿çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°æ‰©å±•ä¸€ä¸ªå¯¹è±¡çš„åŠŸèƒ½ï¼›å®ƒæ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªåŒ…è£…å¯¹è±¡ï¼ˆè£…é¥°å™¨ï¼‰ï¼Œä¹Ÿå°±æ˜¯è£…é¥°æ¥åŒ…è£¹çœŸå®çš„å¯¹è±¡ï¼ˆå§”æ‰˜å¯¹è±¡ï¼‰</p><p><strong>ç›®çš„</strong>æ›´çµæ´»åœ°å¯¹å¯¹è±¡æ–¹æ³•è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ä½¿å¤šä¸ªè£…é¥°å™¨å…±åŒä½œç”¨ï¼Œè£…é¥°å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ä»»æ„ç»„åˆ</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong>åµŒå…¥å¼è®¾å¤‡ï¼Œæ‘„åƒå¤´é€šè¿‡æ¥å£è¿æ¥è®¡ç®—æœºï¼Œå®‰è£…åˆé€‚çš„é©±åŠ¨å’Œè½¯ä»¶ï¼Œæ•´ä¸ªç¡¬ä»¶ç¯å¢ƒå°±å¯ä»¥å…·å¤‡æ‘„å½±æœºçš„åŠŸèƒ½ï¼›è€Œåœ¨å…·å¤‡æ‘„å½±åŠŸèƒ½çš„åŸºç¡€ä¸Šå†è¿æ¥æ–°çš„è®¾å¤‡é¥æ§åº•ç›˜ï¼Œå°±å˜æˆäº†å¯ä»¥ç§»åŠ¨çš„æ‘„åƒè½¦</p><h1 id="å®è·µ">å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œéœ€è¦å¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œå®ç°ä¸€ä¸ªåºåˆ—åŒ–å·¥å…·</p><h2 id="é—®é¢˜">é—®é¢˜</h2><p>å‡è®¾è¦æ±‚åºåˆ—åŒ–æ–¹å¼æœ‰å¤šç§å®ç°ï¼Œè¿™ä¸ªæ²¡é—®é¢˜ï¼Œç»§æ‰¿æ¥å£è¿›è¡Œå¤šå®ç°</p><p>ç°åœ¨è¦å¯¹åŠŸèƒ½è¿›è¡Œæ‹“å±•ï¼Œå¢åŠ å¯¹äºåºåˆ—åŒ–ç»“æœçš„è¡¥å……æ–¹æ³•ï¼ˆPS.ç›´æ¥æ”¹å˜æ–¹æ³•é€»è¾‘ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡åé¢ä»£ç ç›´æ¥ä½¿ç”¨çš„JSONå®ç°ï¼Œä¸å¤ªå¥½è®¾ç½®ä¸€ä¸ªä¿®æ”¹æ–¹æ³•ä¸­é—´é€»è¾‘çš„ä¾‹å­ï¼Œæ‰€ä»¥è¿™æ ·çœ‹èµ·æ¥æœ‰ç‚¹åƒä»£ç†æ¨¡å¼ï¼Œåé¢ä¼šæœ‰æˆ‘å¯¹äºè£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼åŒºåˆ«çš„çœ‹æ³•ï¼‰ï¼Œä¾‹å¦‚å¯¹äºç»“æœè¿›è¡Œæ‘˜è¦æˆ–è€…è¾“å‡ºåˆ°æ–‡ä»¶ç­‰æ“ä½œ</p><p>åœ¨è¿™æ ·çš„åŸºç¡€ä¸Šï¼Œæƒ³è¦å¯¹åŸæœ‰å®ç°æ–¹æ³•è¿›è¡Œå¢å¼ºã€æ‰©å±•ï¼Œå°±éœ€è¦åˆ›å»ºæ–°çš„å®ç°ç±»ï¼Œæˆ–è€…å†è¿›è¡Œä¸€å±‚æŠ½è±¡æ¥è¾¾åˆ°ç›®çš„ï¼Œé‚£å¦‚æœæˆ‘éœ€è¦å³è¿›è¡Œæ‘˜è¦åˆè¿›è¡Œæ–‡ä»¶è¾“å‡ºå‘¢ï¼Ÿ</p><p>å¯ä»¥çœ‹å‡ºæ­¤æ—¶å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>æ¯æ¬¡å¯¹äºæ–¹æ³•é€»è¾‘çš„ä¿®æ”¹å¯èƒ½ä¼šå˜åŠ¨åŸæœ‰ä»£ç </li><li>æ‰©å±•å’Œæ‰©å±•ä¹‹é—´çš„ä¹˜ç§¯å…³ç³»ï¼Œéœ€è¦å®šä¹‰æ›´å¤šçš„æŠ½è±¡</li><li>æ— æ³•åŠ¨æ€æ’æ‹”å®ç°</li></ul><h2 id="å®ç°">å®ç°</h2><h3 id="åºåˆ—åŒ–å™¨æ¥å£">åºåˆ—åŒ–å™¨æ¥å£</h3><p>åªå®šä¹‰ä¸€ä¸ªåºåˆ—åŒ–æ–¹æ³•ï¼Œä¼ å…¥å¯¹è±¡è¾“å‡ºåºåˆ—åŒ–åçš„å­—ç¬¦ä¸²</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">serialize</span><span class="params">(Object obj)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åºåˆ—åŒ–å™¨å®ç°">åºåˆ—åŒ–å™¨å®ç°</h3><p>æä¾›ä¸¤ç§ä¸åŒçš„å®ç°ï¼Œä¸€ç§è¿›è¡Œ JSON åºåˆ—åŒ–ï¼Œä¸€ç§è°ƒç”¨<code>toString</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON åºåˆ—åŒ–å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonSerializer</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// toString åºåˆ—åŒ–å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToStringSerializer</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> obj.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åºåˆ—åŒ–å™¨è£…é¥°">åºåˆ—åŒ–å™¨è£…é¥°</h3><p>åºåˆ—åŒ–å™¨è£…é¥°å¯ä»¥å†æŠ½å‡ºä¸€ä¸ªæ¥å£ç»§æ‰¿åºåˆ—åŒ–å™¨æ¥å£ï¼Œè¿™é‡Œå› ä¸ºéƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª<code>serialize</code> æ–¹æ³•ï¼Œå°±ä¸å†å®šä¹‰æ–°çš„æ¥å£äº†</p><p>åŒæ—¶å¯¹äºåºåˆ—åŒ–å™¨è£…é¥°åŸºç±»ï¼Œå¯ä»¥å®šä¹‰ä¸ºæŠ½è±¡ç±»ï¼Œå†ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¥ç”±åç»­å®ç°ç±»æ¥å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializerDecorator</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Serializer serializer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SerializerDecorator</span><span class="params">(<span class="keyword">final</span> Serializer serializer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.serializer = serializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> serializer.serialize(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‘˜è¦åºåˆ—åŒ–å™¨è£…é¥°">æ‘˜è¦åºåˆ—åŒ–å™¨è£…é¥°</h3><p>é‡å†™ <code>serialize</code>æ–¹æ³•ï¼Œå†è·å–åºåˆ—åŒ–ç»“æœåå†è¿›è¡Œæ‘˜è¦çš„è®¡ç®—å¹¶è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializerDigestDecorator</span> <span class="keyword">extends</span> <span class="title class_">SerializerDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DigestAlgorithm digestAlgorithm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SerializerDigestDecorator</span><span class="params">(<span class="keyword">final</span> Serializer serializer, DigestAlgorithm digestAlgorithm)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serializer);</span><br><span class="line">        <span class="built_in">this</span>.digestAlgorithm = digestAlgorithm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">super</span>.serialize(obj);</span><br><span class="line">        <span class="comment">// è¿”å›çš„æ˜¯åºåˆ—åŒ–åçš„æ‘˜è¦ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> DigestUtil.digester(digestAlgorithm).digestHex(s);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶è¾“å‡ºåºåˆ—åŒ–å™¨è£…é¥°">æ–‡ä»¶è¾“å‡ºåºåˆ—åŒ–å™¨è£…é¥°</h3><p>é‡å†™ <code>serialize</code>æ–¹æ³•ï¼Œåœ¨è·å–åºåˆ—åŒ–ç»“æœåï¼Œè¾“å‡ºè‡³æ–‡ä»¶å¹¶è¿”å›åºåˆ—åŒ–æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializerFileDecorator</span> <span class="keyword">extends</span> <span class="title class_">SerializerDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FileWriter fileWriter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SerializerFileDecorator</span><span class="params">(<span class="keyword">final</span> Serializer serializer, String filePath)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serializer);</span><br><span class="line">        <span class="built_in">this</span>.fileWriter = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="keyword">new</span> <span class="title class_">File</span>(filePath));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">super</span>.serialize(obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        fileWriter.write(s);</span><br><span class="line">        fileWriter.flush();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨">ä½¿ç”¨</h3><p>è£…é¥°å™¨å’Œè£…é¥°å™¨ä¹‹é—´å¯ä»¥ä»»æ„ã€ä¸é™æ¬¡æ•°åœ°åµŒå¥—ï¼Œæœ€ç»ˆçš„ç»“æœä¼šç»è¿‡æ¯ä¸ªè£…é¥°å™¨å’Œå§”æ‰˜å¯¹è±¡çš„å¤„ç†</p><p>æš´éœ²ç›¸å…³çš„æ–¹æ³•è¿˜å¯ä»¥å®ç°åŠ¨æ€åœ°æ›´æ–°è£…é¥°å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// obj</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// JSON åºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">jsonSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonSerializer</span>();</span><br><span class="line">        System.out.println(jsonSerializer.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…è£… digest è£…é¥°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">digestDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializerDigestDecorator</span>(jsonSerializer, DigestAlgorithm.SHA1);</span><br><span class="line">        System.out.println(digestDecorator.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…è£… file è£…é¥°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">fileDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializerFileDecorator</span>(digestDecorator, <span class="string">&quot;./serialize.txt&quot;</span>);</span><br><span class="line">        System.out.println(fileDecorator.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to string åºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">toStringSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringSerializer</span>();</span><br><span class="line">        System.out.println(toStringSerializer.serialize(student));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…è£… digest è£…é¥° å’Œ file è£…é¥°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Serializer</span> <span class="variable">toStringFileDecorator</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SerializerFileDecorator</span>(<span class="keyword">new</span> <span class="title class_">SerializerDigestDecorator</span>(toStringSerializer, DigestAlgorithm.MD5),</span><br><span class="line">                <span class="string">&quot;./serialize2.txt&quot;</span>);</span><br><span class="line">        System.out.println(toStringFileDecorator.serialize(student));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è£…é¥°-ä»£ç†">è£…é¥° &amp; ä»£ç†</h1><p>åœ¨è¿™é‡Œéœ€è¦è®¨è®ºä¸€ä¸ªé—®é¢˜ï¼Œè£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼éƒ½æ˜¯å¯¹æ–¹æ³•è¿›è¡Œå¢å¼ºæˆ–è€…æ‰©å±•ï¼Œé‚£ä¹ˆå®ƒä»¬åˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><p>ç½‘ç»œä¸Šä¹Ÿæœ‰å¾ˆå¤šè®¨è®ºï¼Œä¸‹é¢æ˜¯ä¸€äº›è§‚ç‚¹å’Œæˆ‘çš„çœ‹æ³•ï¼š</p><ul><li><p><strong>ç»„åˆã€èšåˆæ˜¯è£…é¥°æ¨¡å¼ï¼Œç»§æ‰¿æ˜¯ä»£ç†æ¨¡å¼</strong>çœ‹èµ·æ¥æœ‰ä¸€å®šé“ç†ï¼Œæ„Ÿè§‰è£…é¥°æ¨¡å¼è¦æƒ³å®ç°åµŒå¥—çš„æ•ˆæœæ˜¯éœ€è¦ä½¿ç”¨ç»„åˆæ¥å®ç°ï¼Œä½†ä¹Ÿä¼šå­˜åœ¨ä½¿ç”¨ç»„åˆæ¥å®ç°çš„ä»£ç†æ¨¡å¼ï¼ˆé™æ€ä»£ç†ï¼‰ï¼›æ˜¯ä¸æ˜¯ä»ä¸€å®šè§’åº¦æ¥çœ‹çš„è¯ï¼Œç»„åˆã€èšåˆã€ç»§æ‰¿è¿™ç§ç»“æ„çš„é€‰æ‹©ï¼Œå’Œå®ç°ä»€ä¹ˆè®¾è®¡æ¨¡å¼å¹¶æ— å…³ç³»ï¼Ÿ</p><blockquote><p>The real difference is not ownership (composition versusaggregation), but rather type-information.</p><p><ahref="https://stackoverflow.com/questions/18618779/differences-between-proxy-and-decorator-pattern">oop- Differences between Proxy and Decorator Pattern - StackOverflow</a></p></blockquote></li><li><p><strong>è£…é¥°æ¨¡å¼ç”¨äºæ·»åŠ åŠŸèƒ½ï¼Œä»£ç†æ¨¡å¼ç”¨äºå¢å¼ºåŠŸèƒ½</strong>æˆ‘è§‰å¾—ä¸åˆç†ï¼Œè®¾è®¡æ¨¡å¼ä¸åº”è¯¥æ ¹æ® â€œè§„èŒƒâ€æ¥è¿›è¡Œåˆ†ç±»ï¼Œä¹Ÿä¸ä¼šæ ¹æ®æ¨¡ç³Šçš„æè¿°æ¥å‘½å</p></li><li><p><strong>è£…é¥°æ¨¡å¼åœ¨æ‰§è¡ŒæœŸé—´æ‰ä¼šç”±å®¢æˆ·ç«¯æ§åˆ¶ï¼Œä½¿è£…é¥°å™¨å’Œå§”æ‰˜å¯¹è±¡å»ºç«‹è”ç³»ï¼Œåœ¨æ­¤ä¹‹å‰è£…é¥°å™¨ç±»åªçŸ¥é“å§”æ‰˜å¯¹è±¡çš„æ¥å£ï¼›ä»£ç†æ¨¡å¼åœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»çŸ¥é“ä»£ç†å¯¹è±¡çš„å…·ä½“ä¿¡æ¯ï¼ˆæ— è®ºè¿™ä¸ªå¯¹è±¡æ˜¯é€šè¿‡ä»£ç†ç±»æ–¹æ³•åˆ›å»ºè¿˜æ˜¯é€šè¿‡æ³¨å…¥ï¼‰</strong>æˆ‘è®¤ä¸ºè¿™ä¸ªæ˜¯ç›¸è¾ƒè€Œè¨€æœ€æœ‰æ ‡å¿—æ€§çš„åŒºåˆ«äº†ï¼›è£…é¥°çš„è¡Œä¸ºå‘ç”Ÿåœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ— è®ºæ˜¯åˆ›å»ºæ–°çš„è£…é¥°å™¨å¢å¼ºå§”æ‰˜ç±»ï¼Œè¿˜æ˜¯å–æ¶ˆå§”æ‰˜å¯¹è±¡çš„è£…é¥°å™¨ï¼Œéƒ½æ˜¯åŠ¨æ€çš„ï¼›è€Œä»£ç†ç±»ä»ä¸€å¼€å§‹å°±æ˜ç¡®äº†è‡ªå·±çš„å§”æ‰˜ç±»</p><blockquote><p>But a <strong>Proxy</strong> <em>always</em> knows the (more)specific type of the delegatee. In other words, the<strong>Proxy</strong> and its delegatee will have the same base type,but the <strong>Proxy</strong> points to some derived type. A<strong>Decorator</strong> points to its own base type. Thus, thedifference is in compile-time information about the type of thedelegatee.</p></blockquote></li><li><p><strong>è£…é¥°æ¨¡å¼çš„å§”æ‰˜å¯¹è±¡æ¥è‡ªå¤–éƒ¨ï¼Œä»£ç†æ¨¡å¼çš„å§”æ‰˜å¯¹è±¡å¯ä»¥è‡ªå·²åˆ›å»º</strong>å¼•ç”³äºä¸Šä¸€ä¸ªè§‚ç‚¹ï¼Œå¯¹äº â€œå…·ä½“ä¿¡æ¯â€çš„äº†è§£å°±å†³å®šäº†ä»£ç†å¯¹è±¡å¯ä»¥ç›´æ¥åˆ›å»ºå‡ºå§”æ‰˜å¯¹è±¡</p></li></ul><p>äº‹å®ä¸Šç½‘ç»œä¸Šå¯¹äºè£…é¥°æ¨¡å¼ã€ä»£ç†æ¨¡å¼çš„ç•Œå®šä¹Ÿä¸€ç›´åœ¨è®¨è®ºä¸­ï¼Œæ„Ÿè§‰ä¸ä¸€å®šéœ€è¦å…³æ³¨åˆ°åº•ä»€ä¹ˆæ˜¯è£…é¥°ä»€ä¹ˆæ˜¯ä»£ç†ï¼Œè¿˜æ˜¯èƒ½å¤Ÿä½¿ç”¨åˆç†çš„è®¾è®¡è§£å†³</p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>ä½¿ç”¨è£…é¥°æ¨¡å¼å¯ä»¥æ›´çµæ´»åœ°å¯¹å¯¹è±¡æ–¹æ³•è¿›è¡Œæ‰©å±•</p><ul><li>ä¼˜ç‚¹<ul><li>æ— éœ€åˆ›å»ºæ–°å­ç±»å³å¯æ‰©å±•å¯¹è±¡çš„è¡Œä¸º</li><li>å¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤å¯¹è±¡çš„åŠŸèƒ½</li><li>è£…é¥°å™¨å¯ä»¥ä»»æ„ç»„åˆ</li><li>å¯ä»¥å°†å®ç°äº†è®¸å¤šä¸åŒè¡Œä¸ºçš„ä¸€ä¸ªå¤§ç±»æ‹†åˆ†ä¸ºå¤šä¸ªè¾ƒå°çš„ç±»æ¥æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™</li></ul></li><li>ç¼ºç‚¹<ul><li>è™½ç„¶å¯ä»¥æ”¯æŒè¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤å¯¹è±¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®é™…å®ç°èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼ˆè£…é¥°æ ˆï¼‰</li><li>è£…é¥°æ ˆä¸€å®šæ˜¯æœ‰åºçš„</li><li>åˆå§‹åŒ–ä»£ç å˜å¾—ç¹æ‚</li></ul></li></ul><p><strong>è£…é¥°æ¨¡å¼çš„é€‚ç”¨ç¯å¢ƒ</strong></p><ul><li>åœ¨ä¸å½±å“å…¶ä»–å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä»¥åŠ¨æ€ã€é€æ˜çš„æ–¹å¼ç»™å•ä¸ªå¯¹è±¡æ·»åŠ èŒè´£</li><li>éœ€è¦åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡å¢åŠ åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½ä¹Ÿå¯ä»¥åŠ¨æ€åœ°è¢«æ’¤é”€</li><li>å½“ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æ–¹å¼å¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å……æˆ–è€…é‡‡ç”¨ç»§æ‰¿ä¸åˆ©äºç³»ç»Ÿæ‰©å±•å’Œç»´æŠ¤æ—¶ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æƒ…å†µä¸»è¦æœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡ç‹¬ç«‹çš„æ‰©å±•ï¼Œä¸ºæ”¯æŒæ¯ä¸€ç§ç»„åˆå°†äº§ç”Ÿå¤§é‡çš„å­ç±»ï¼Œä½¿å¾—å­ç±»æ•°ç›®å‘ˆçˆ†ç‚¸æ€§å¢é•¿ï¼›ç¬¬äºŒç±»æ˜¯å› ä¸ºç±»å®šä¹‰ä¸èƒ½ç»§æ‰¿ï¼ˆå¦‚<code>final</code> ç±»ï¼‰</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://refactoringguru.cn/design-patterns/decorator">è£…é¥°è®¾è®¡ï¼ˆè£…é¥°è€…æ¨¡å¼/ è£…é¥°å™¨æ¨¡å¼ï¼‰ (refactoringguru.cn)</a></p><p><ahref="https://stackoverflow.com/questions/18618779/differences-between-proxy-and-decorator-pattern">oop- Differences between Proxy and Decorator Pattern - StackOverflow</a></p><p><ahref="https://www.kancloud.cn/digest/xing-designpattern/143730">è®¾è®¡æ¨¡å¼ï¼ˆä¹ï¼‰è£…é¥°æ¨¡å¼ï¼ˆDecoratorï¼‰Â· å†™æœ€å¥½çš„è®¾è®¡æ¨¡å¼ä¸“æ  Â· çœ‹äº‘ (kancloud.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å•¤é…’èŠ±ï¼šä½ éœ€è¦çŸ¥é“çš„çŸ¥è¯†</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86.html</url>
      
        <content type="html"><![CDATA[<img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/hops.jpg" class=""><p>è®°å½•æ˜¾ç¤ºç¬¬ä¸€ä¸ªå–åˆ°å•¤é…’çš„äººè·ä»Šæœ‰ 9000å¹´ä¹‹ä¹…ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œäººä»¬ä½¿ç”¨å•¤é…’èŠ±ä¸ºäº†é˜²è…ï¼Œæˆ–è€…ä¸ºäº†æ·»åŠ é£å‘³å’Œé¦™æ°”çš„å†å²å¹¶ä¸ä¹…è¿œ</p><p>å¦‚ä»Šï¼Œå•¤é…’ä¸­ä¸æ·»åŠ å•¤é…’èŠ±æ˜¯ä¸å¯æ€è®®çš„è¡Œä¸ºï¼›å®ƒä¸ä»…å¯ä»¥ä¿æŠ¤å•¤é…’çš„æ–°é²œï¼Œä¹Ÿå¯ä»¥ä¸°å¯Œå•¤é…’çš„å‘³é“</p><p>æœ¬æ–‡å°†ä»‹ç»ä½ å¯èƒ½ä¸çŸ¥é“çš„å•¤é…’èŠ±çŸ¥è¯†ï¼Œç°åœ¨æ˜¯æ—¶å€™äº†è§£å…³äºå®¶åº­é…¿é€ çš„åŸºæœ¬åŸæ–™ä¹‹ä¸€çš„æ–°ä¸œè¥¿äº†</p><h1 id="è®¤è¯†å•¤é…’èŠ±">è®¤è¯†å•¤é…’èŠ±</h1><h2 id="ä»€ä¹ˆæ˜¯å•¤é…’èŠ±">ä»€ä¹ˆæ˜¯å•¤é…’èŠ±</h2><p>å•¤é…’èŠ±æ¥è‡ªå•¤é…’èŠ±æ¤ç‰©é›Œæ ªï¼Œä¹Ÿè¢«ç§°ä¸º HumulusLupulusï¼›å®ƒä»¬çš„å½¢çŠ¶åƒä¸€ä¸ªå€’ç½®çš„ç»¿è‰²æ¾æœï¼Œå•¤é…’èŠ±æ˜¯è¿™ç§ç‰¹æ®Šæ¤ç‰©çš„èŠ±æœµï¼›å¥‡æ€ªçš„äº‹å®æ˜¯ï¼šé…’èŠ±ä¸æ˜¯è‘¡è„è—¤ï¼Œå®ƒæ˜¯ä¸€ä¸ªèŒï¼Œè¿™æ„å‘³ç€æ¤ç‰©ä¸ä¼šç”¨å·é¡»è€Œæ˜¯ç”¨å®ƒçš„å«©ææ¥æ”€çˆ¬</p><p>é…¿é…’å¸ˆä½¿ç”¨åŒ…å«åœ¨è¿™äº›èŠ±ä¸­çš„ç²¾æ²¹å’Œæ ‘è„‚ï¼Œä½ å¿…é¡»å°†å…¶å¶å­å‰¥å¼€ï¼Œæ‰èƒ½å¾—åˆ°é»„è‰²çš„è›‡éº»ç´ è…ºï¼Œåœ¨è¿™å…¶ä¸­ä½ å¯ä»¥æ‰¾åˆ°æ·»åŠ åˆ°å•¤é…’ä¸­çš„ç‰©è´¨</p><p>åœ¨å¸‚åœºä¸­å¯ä»¥çœ‹åˆ°å•¤é…’èŠ±æœ‰å¾ˆå¤šç§åŒ…è£…æ–¹å¼ï¼Œæœ€å¸¸è§çš„æ˜¯çœ‹åˆ°å®ƒçš„é¢—ç²’æˆ–æ˜¯å¹²èŠ±çŠ¶æ€ï¼›ä¸€äº›äººä½¿ç”¨å•¤é…’èŠ±ç²¾æ²¹ï¼Œæ‰€ä»¥æœ€è¿‘æœ‰äººå¼€å‘äº†ä¸€ç§å«åšhop hash æˆ– hop crack çš„è›‡éº»ç²‰ï¼ˆlupulin powderï¼‰æ¥ä¾›ä½¿ç”¨</p><h2 id="ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬">ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬</h2><p>ä¸€å¼€å§‹å•¤é…’é…¿é…’å¸ˆåœ¨é…¿é€ è¿‡ç¨‹ä¸­ä½¿ç”¨å•¤é…’èŠ±æ˜¯ä¸ºäº†å°†å•¤é…’ä¿å­˜æ›´é•¿æ—¶é—´ï¼Œå› ä¸ºåœ¨é‚£ä¸ªæ—¶ä»£ï¼Œä¿å­˜é£Ÿç‰©çš„æ–¹æ³•å¾ˆå°‘ï¼Œå†°ç®±è¿˜æ²¡æœ‰å‘æ˜ï¼Œæ‰€ä»¥äººä»¬å¿…é¡»æ‰¾åˆ°è‡ªç„¶çš„æ–¹æ³•æ¥é˜²æ­¢é£Ÿç‰©å’Œé¥®æ–™å˜è´¨ï¼Œä»–ä»¬å°è¯•äº†äº†ä¸åŒçš„è‰æœ¬æ¤ç‰©å’Œæ²¹ç­‰ç‰©è´¨ï¼Œä½†æ²¡æœ‰æ•ˆæœæ˜¾è‘—çš„æ–¹æ³•</p><p>åœ¨æ³•å›½ä¸€äº›è®°è½½è®°å½•äº†åœ¨ 9ä¸–çºªå•¤é…’é…¿é€ è¿‡ç¨‹ä¸­å¼€å§‹æœ‰å•¤é…’èŠ±çš„åŠ å…¥ï¼Œå¾·å›½äººä¹Ÿæœ‰åœ¨ 12ä¸–çºªå¼€å§‹ä½¿ç”¨å®ƒä½œä¸ºé˜²è…å‰‚çš„è®°å½•ï¼Œå¹¶å¼€å§‹åœ¨æ¬§æ´²å’Œè‹±å›½æ¨å¹¿ï¼Œåœ¨é‚£ä¸ªæ—¶ä»£ä¹‹å‰ç”Ÿäº§çš„ä¸ä½¿ç”¨å•¤é…’èŠ±çš„å•¤é…’ï¼Œç°å¦‚ä»Šè¢«äººç§°ä¸ºGruit æˆ– Grut</p><p>å•¤é…’èŠ±ä¹Ÿæœ‰åŠ©äºèµ‹äºˆå•¤é…’ç‹¬ç‰¹çš„é¦™æ°”å’Œé£å‘³ï¼›å®ƒæ˜¯è‹¦çš„ï¼Œæœ‰ä¸€äº›æ–¹æ³•å¯ä»¥æ ¹æ®å•¤é…’èŠ±æ¥è¡¡é‡å•¤é…’çš„è‹¦å‘³ï¼›æ ¹æ®å“ç§å’Œç§æ¤åœ°çš„ä¸åŒï¼Œå•¤é…’èŠ±å…·æœ‰ä¸åŒçš„å‘³é“å’Œé¦™å‘³ï¼Œç„¶åå°†å…¶è½¬ç§»åˆ°å•¤é…’ä¸­</p><p>å•¤é…’èŠ±çš„è‹¦å‘³ä¸éº¦èŠ½çš„ç”œå‘³å½¢æˆå¯¹æ¯”ï¼Œå•¤é…’èŠ±ç§ç±»å’Œè´¨é‡çš„ä¸åŒä¼šæä¾›å‡ºå„ç§å„æ ·çš„ç‰©è´¨</p><h2 id="ä»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬">ä»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬</h2><p>å•¤é…’èŠ±ç”Ÿé•¿éœ€è¦ç‰¹æ®Šçš„ç¯å¢ƒï¼Œå®ƒä»¬åœ¨çº¬åº¦ 35 åˆ° 55åº¦ä¹‹é—´ç”Ÿé•¿æœ€äº‹å®œï¼Œå—åŒ—åŠçƒç»´åº¦èŒƒå›´éƒ½å·®ä¸å¤š</p><p>å®ƒä»¬æ›´å–œæ¬¢å¹³å¦çš„åœ°å½¢ï¼Œæ­¤å¤–è¿˜ä¼šå—åˆ°å¯’å†·å†¬å­£å’Œå¤å­£æ—¥ç…§æ—¶é—´é•¿çš„æ˜¾è‘—å½±å“ï¼Œæ‰€ä»¥æœ€å¥½ç»™å®ƒä»¬æ‰¾ä¸ªé¿é£çš„åœ°æ–¹ï¼›è¿™äº›æƒ…å†µå¹¶ä¸å¸¸è§ï¼Œæ‰€ä»¥åœ¨æŸäº›å›½å®¶æ›´æœ‰å¯èƒ½å‘ç”Ÿ</p><p>å•¤é…’èŠ±æœ€é‡è¦çš„äº§åŒºä½äºå¾·å›½ã€æ·å…‹å…±å’Œå›½ã€ç¾å›½å’Œè‹±å›½ï¼›ç¾å›½å’Œå¾·å›½éƒ½æ˜¯å•¤é…’èŠ±çš„ä¸»è¦ç”Ÿäº§å›½ï¼Œé…¿é…’å¸ˆå€¾å‘äºå°†å®ƒä»¬åˆ†åˆ«ç§°ä¸ºâ€œæ–°ä¸–ç•Œé…’èŠ±â€ å’Œ â€œæ—§ä¸–ç•Œé…’èŠ±â€</p><p>å•¤é…’èŠ±ä»¬ä¸éœ€è¦ç…§é¡¾ä¹Ÿèƒ½è“¬å‹ƒç”Ÿé•¿ï¼Œå®ƒä»¬æ‰¾åˆ°äº†åœ¨å¤§è‡ªç„¶ä¸­ç”Ÿå­˜çš„æ–¹æ³•ï¼›å½“ç„¶ä¹Ÿæœ‰é‡ç”Ÿå•¤é…’èŠ±åˆ†å¸ƒåœ¨å…¶ä»–åœ°æ–¹ï¼Œæ¯”å¦‚æ¾³å¤§åˆ©äºšï¼Œé‚£é‡Œå¹¶æ²¡æœ‰ä¸“é—¨ç§æ¤å•¤é…’èŠ±çš„å†œåœº</p><h2 id="å¦‚ä½•ç”¨äºå•¤é…’">å¦‚ä½•ç”¨äºå•¤é…’</h2><p>åœ¨ä½¿ç”¨å•¤é…’èŠ±æ—¶ï¼Œå¿…é¡»å°†å®ƒä»¬åˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„ç±»åˆ«</p><p>ç”¨äºè·å¾—è‹¦å‘³çš„å•¤é…’èŠ± Î±é…¸å«é‡å¾ˆé«˜ï¼Œè¿™ç§ç‰¹è´¨ä½¿å•¤é…’å‘³é“æ›´åŠ è‹¦æ¶©ï¼Œä½†æ˜¯å®ƒä¼šåœ¨é¦™æ°”å’Œé£å‘³æ–¹é¢ä¸å¤Ÿç²¾è‡´ï¼›è¦è·å¾—å•¤é…’èŠ±ä¸­çš„è‹¦å‘³ç‰©è´¨å¹¶å°†å…¶ä½œç”¨äºå•¤é…’ï¼Œéœ€è¦å°†å•¤é…’èŠ±è¿›è¡Œç…®æ²¸ï¼Œè‹¦å‘³çš„ç¨‹åº¦å¾€å¾€å–å†³äºç…®æ²¸å•¤é…’èŠ±çš„æ—¶é—´ï¼Œæ—¶é—´è¶Šé•¿è‹¦å‘³ç‰©è´¨å°±ä¼šè¶Šå¤š</p><p>å¦ä¸€ç±»æ˜¯é¦™å‘³å•¤é…’èŠ±ï¼Œå®ƒä»¬çš„ Î±é…¸å«é‡è¾ƒä½æ›´ä¾èµ–ç²¾æ²¹ï¼Œè¿™ä¸€ç‰¹è´¨ä½¿å®ƒä»¬çš„å‘³é“æ›´åŠ ç‹¬ç‰¹å’Œç¾å‘³ï¼›ä¸ºäº†èƒå–å‡ºå•¤é…’èŠ±çš„é¦™å‘³å’Œé£å‘³ï¼Œéœ€è¦éå¸¸å°å¿ƒåœ°å¤„ç†ï¼Œå¦‚æœèŠ±å¾ˆé•¿æ—¶é—´è¿›è¡Œç…®æ²¸ï¼Œå°†å¤±å»å®ƒä»¬ç‹¬ç‰¹çš„ç‰¹æ€§</p><p>ä¹Ÿæœ‰ä¸€äº›ç§ç±»çš„å•¤é…’èŠ±å…·æœ‰ç±»ä¼¼çš„ Î±é…¸å’Œç²¾æ²¹ç‰¹æ€§ï¼Œä½¿è¿™ä¸¤ç§ç‰¹æ€§äº’ç›¸å¹³è¡¡</p><p>ä½ ä¸èƒ½å¿˜è®°å•¤é…’èŠ±çš„ä¸»è¦ç”¨é€”ï¼Œå®ƒæ˜¯å•¤é…’çš„é˜²è…å‰‚ï¼Œå®ƒä»¬çš„æŠ—èŒèƒ½åŠ›å¯ä»¥é˜²æ­¢äº§å“åœ¨æ²¡æœ‰ä»»ä½•å†·è—æ‰‹æ®µçš„æƒ…å†µä¸‹è¿‡å¿«å˜è´¨ï¼›æˆ‘ä»¬ç°åœ¨æœ‰æ›´å¥½çš„æ–¹æ³•æ¥ä¿å­˜å•¤é…’ï¼Œä½†è¿™å¹¶ä¸é‡è¦ï¼Œå•¤é…’èŠ±å·²ç»æˆä¸ºé…¿é€ è¿‡ç¨‹ä¸­å¿…ä¸å¯å°‘çš„åŸºç¡€ï¼›å¾ˆéš¾ç›¸ä¿¡å•¤é…’èŠ±å¹¶ä¸æ˜¯è‡ªå•¤é…’é…¿é€ å†å²å¼€å§‹å°±è¢«ä½¿ç”¨</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/Why-are-hops-added-to-beer.jpg" class=""><h2 id="æœ‰è¶£å°çŸ¥è¯†">æœ‰è¶£å°çŸ¥è¯†</h2><ul><li>å•¤é…’èŠ±æ¤ç‰©é›„æ ªä¸äº§ç”Ÿä¸ºå•¤é…’æä¾›ç‹¬ç‰¹é£å‘³å’Œé¦™æ°”æ‰€éœ€çš„ç²¾æ²¹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå•¤é…’èŠ±å†œåœºåªä½¿ç”¨é›Œæ ª</li><li>å•¤é…’èŠ±å®¶æ—å’Œå¤§éº»åŒå±åŒä¸€ç§‘ï¼šå¤§éº»ç§‘ï¼ˆCannabaceaeï¼‰ï¼›æ­£å› å¦‚æ­¤å¦‚æœå–å¤ªå¤šçš„è¯ï¼Œå•¤é…’ä¼šè®©ä½ æµå£æ°´æ˜¯å¯ä»¥ç†è§£çš„ï¼ˆå•¤é…’èŠ±çš„æ±‰è¯­è¢«ç¿»è¯‘ä¸ºè›‡éº»ï¼Œè¯‘è€…è¿™ä¹ˆç¿»è¯‘çš„åŸå› è‚¯å®šæ˜¯å› ä¸ºåˆ†ç±»å­¦ï¼›å½“ç„¶è¿™é‡Œåº”è¯¥æ˜¯ä½œè€…çš„ç©ç¬‘ï¼Œè¡¨è¾¾çš„æ˜¯å¯¹å•¤é…’çš„å–œçˆ±ï¼Œå•¤é…’èŠ±é‡Œæ˜¯æ²¡æœ‰å››æ°¢å¤§éº»é…šçš„ï¼‰</li><li>ç½—é©¬äººè¿‡å»æŠŠå•¤é…’èŠ±åšæˆæ²™æ‹‰é£Ÿç”¨ï¼Œå°±åƒç°åœ¨äººä»¬åƒèŠ¦ç¬‹çš„æ–¹å¼ä¸€æ ·</li><li>ä½ å¯ä»¥ç»™é¸¡å–‚é£Ÿå•¤é…’èŠ±ï¼Œå•¤é…’èŠ±é€‚åˆå®ƒä»¬çš„æ¶ˆåŒ–ç³»ç»Ÿï¼Œå¯ä»¥é˜²æ­¢ç»†èŒè¿›å…¥è‚ é“ï¼›ä½†æ˜¯å•¤é…’èŠ±å¹¶ä¸é€‚åˆçŒ«å’Œç‹—ï¼Œå¯èƒ½å¯¹å…¶æœ‰æ¯’ï¼Œå¯¼è‡´è¿™äº›å® ç‰©é«˜çƒ§ç”šè‡³æ­»äº¡ï¼›å› æ­¤ï¼Œå¦‚æœä½ å®¶é‡Œæœ‰å® ç‰©ï¼Œè¯·ç¡®ä¿å•¤é…’èŠ±åŸæ–™è¿œç¦»å®ƒä»¬</li><li>å•¤é…’ï¼ˆbeerï¼‰å’Œè‰¾å°”å•¤é…’ï¼ˆaleï¼‰ä¹‹é—´çš„åŒºåˆ«ä¸€ç›´å­˜åœ¨ç€ä¸€åœºæˆ˜äº‰ï¼Œå½“å•¤é…’èŠ±å¼€å§‹æˆä¸ºé…¿é€ è¿‡ç¨‹ä¸­çš„ä¸€ç§åŸºæœ¬åŸæ–™æ—¶ï¼Œé…¿é…’å¸ˆå¼€å§‹å°†åŠ äº†å•¤é…’èŠ±çš„å•¤é…’ç§°ä¸ºbeerï¼Œè€Œ aleç§°å‘¼çš„å°±æ˜¯ä¸å«å•¤é…’èŠ±çš„äº§å“ï¼›ä¸€äº›å›½å®¶ç¦æ­¢åœ¨é…¿é€ è¿‡ç¨‹ä¸­ä½¿ç”¨å•¤é…’èŠ±ï¼Œåœ¨äº¨åˆ©å…­ä¸–ï¼ˆHenryVIï¼‰çš„å¹²é¢„ä¸‹ï¼Œä»–å–œæ¬¢å–åŠ äº†å•¤é…’èŠ±çš„å•¤é…’ï¼Œå•¤é…’èŠ±æ‰æˆä¸ºäº†é…¿é€ ä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</li></ul><h1 id="å•¤é…’å’Œå•¤é…’èŠ±çš„åŒ–å­¦">å•¤é…’å’Œå•¤é…’èŠ±çš„åŒ–å­¦</h1><h2 id="ä»€ä¹ˆæ˜¯-hop-harvest">ä»€ä¹ˆæ˜¯ hop harvest</h2><p>å•¤é…’èŠ±å¿…é¡»åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ”¶è·ï¼Œä¸€ç³»åˆ—å› ç´ å†³å®šäº†ä»€ä¹ˆæ˜¯é€‚åˆæ”¶è·çš„å­£èŠ‚ï¼Œä¾‹å¦‚çƒæœæˆç†Ÿåº¦å’Œæ°´åˆ†å«é‡ã€å¤©æ°”æ¡ä»¶å’Œå•¤é…’èŠ±ç”Ÿé•¿è¿‡ç¨‹ä¸­çš„è™«å®³å‹åŠ›ç­‰ç­‰ï¼›ä¸€å¹´ä¸­æ”¶è·å•¤é…’èŠ±çš„æœ€ä½³æ—¶é—´æ˜¯ç§‹å­£ï¼Œå³8 æœˆä¸‹æ—¬å’Œ 9 æœˆå¤§éƒ¨åˆ†æ—¶é—´</p><p>å·²æœ‰ç§‘å­¦ç ”ç©¶è¡¨æ˜ï¼Œé‡‡æ”¶æ—¥æœŸå¯¹å•¤é…’èŠ±å“è´¨æœ‰ç€é‡è¦å½±å“ï¼Œæ¨è¿Ÿæ”¶è·å¯èƒ½è¢«è¯¯è®¤ä¸ºä¼šè·å¾—æ›´å¥½çš„æ”¶ç›Šï¼Œä½†äº‹å®è¯æ˜å•¤é…’èŠ±å¯èƒ½ä¼šå¤±å»éƒ¨åˆ†ç‰¹æœ‰çš„é¦™æ°”ï¼Œä¹Ÿä¼šç¼©çŸ­å®ƒä»¬çš„å­˜å‚¨å¯¿å‘½ï¼Œæ°§åŒ–å¯èƒ½ä¼šåŠ é€Ÿæœ€ç»ˆå¯¼è‡´å•¤é…’èŠ±çš„æŒ¥å‘æ€§é¦™å‘³æ¶ˆå¤±</p><p>å¦ä¸€æ–¹é¢ï¼Œè¿‡æ—©æ”¶è·ä¼šé™ä½é£å‘³å¹¶ä¼šé™ä½æœªæ¥æ”¶è·å­£èŠ‚çš„äº§é‡ï¼›åœ¨æœ‰å¤§é‡å•¤é…’èŠ±å†œåœºçš„åœ°åŒºï¼Œä»–ä»¬è®¡ç®—å‡ºå½“çƒæœè¾¾åˆ°dry matter çš„ 23%æ—¶æ˜¯é€‚åˆçš„æ”¶è·æ—¶é—´ï¼›æ ¹æ®å•¤é…’èŠ±çš„ç§ç±»å’Œç¯å¢ƒæ¡ä»¶çš„ä¸åŒï¼Œå•¤é…’èŠ±ç§æ¤æˆ·æ¯ 4åˆ° 7 å¤©å°±ä¼šå¢åŠ  1% çš„ dry matter</p><p>å•¤é…’èŠ±ä¸Šçš„ä¸€äº›æ˜æ˜¾å˜åŒ–å°†æä¾›çº¿ç´¢è¯´æ˜æ˜¯å¦å‡†å¤‡å¥½æ”¶å‰²ï¼Œä¾‹å¦‚èŠ±æœµä»ç»¿è‰²å˜ä¸ºç•¥å¸¦é»„è‰²çš„ç¾Šçš®çº¸è´¨åœ°ã€è›‡éº»ç´ è…ºä¹Ÿä»æµ…é»„è‰²å˜ä¸ºæ·±é»„è‰²æ¥è¿‘æ©™è‰²ï¼›æ”¶è´§æ—¶ï¼Œéœ€è¦ç¡®ä¿çƒæœæ²¡æœ‰å®Œå…¨å˜ä¸ºè¤è‰²</p><h2 id="ä»€ä¹ˆè®©å•¤é…’èŠ±å‘³é“å¦‚æ­¤ä¸åŒ">ä»€ä¹ˆè®©å•¤é…’èŠ±å‘³é“å¦‚æ­¤ä¸åŒ</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œå•¤é…’èŠ±çš„ä¸åŒé£å‘³å’Œé¦™æ°”ä¸»è¦å–å†³äºå®ƒä»¬ç”Ÿé•¿çš„åœ°æ–¹ï¼Œä¸åŒçš„å¤©æ°”æ¡ä»¶ã€åœŸå£¤å’Œç§æ¤æ–¹å¼ä¼šä»¥ä¸åŒçš„å½¢å¼æœ€ç»ˆå½±å“å•¤é…’èŠ±çš„ç‰¹æ€§</p><p>æ­¤å¤–ï¼Œæ”¶è·çš„æ—¶é—´ä¹Ÿå¯èƒ½ä¼šå½±å“å•¤é…’èŠ±çš„é£å‘³å’Œé¦™æ°”</p><p>å¦ä¸€ä¸ªå…³äºå‘³é“çš„é‡è¦å› ç´ æ˜¯æ¯ç§å•¤é…’èŠ±ä¸­çš„ Î±é…¸å’Œç²¾æ²¹çš„å«é‡ï¼›å®ƒä»¬ä¸­çš„å¤§å¤šæ•°åœ¨å…¶å«é‡ä¸Šæœ‰æ‰€å·®å¼‚ï¼Œä½†åªæœ‰å°‘æ•°å“ç§çš„å•¤é…’èŠ±å…·æœ‰è¿™äº›ç‰©è´¨çš„å¹³è¡¡ï¼Œè¿™ä½¿å®ƒä»¬å˜å¾—è‹¦æ¶©ï¼Œä½†å……æ»¡ç‹¬ç‰¹çš„å‘³é“</p><p>Î± é…¸æ‰€å çš„æ¯”é‡ï¼Œé€šå¸¸åœ¨ 2% è‡³ 19%ä¹‹é—´ï¼›æ¬§æ´²äººå¯¹å•¤é…’èŠ±æ›´æ„Ÿå…´è¶£ï¼Œå®ƒä»¬çš„å•¤é…’èŠ±å«æœ‰ 5% è‡³ 9% çš„ Î±é…¸ï¼›Dual-compound å•¤é…’èŠ±åœ¨æ¬§æ´²æ›´ä¸ºå¸¸è§ï¼›åŒæ—¶ï¼Œç¾å›½å•¤é…’èŠ±å“ç§çš„ Î±é…¸å«é‡è¾ƒé«˜ï¼Œåœ¨ 8% è‡³ 19% ä¹‹é—´ï¼Œè¿™ä¼šä½¿å¾—è¿™äº›å•¤é…’èŠ±æ›´è‹¦</p><h2 id="å•¤é…’èŠ±çš„å“ç§">å•¤é…’èŠ±çš„å“ç§</h2><p>å•¤é…’èŠ±æœ‰å¾ˆå¤šç§ï¼Œä½†å®ƒä»¬éƒ½å¯ä»¥é›†ä¸­åœ¨ä¸‰ç§ç±»å‹ï¼šè´µæ—å•¤é…’èŠ±ï¼ˆNobleHopsï¼‰ã€ç¾å¼å•¤é…’èŠ±ï¼ˆAmerican Hopsï¼‰å’Œè‹±å¼å•¤é…’èŠ±ï¼ˆEnglish Hopsï¼‰</p><p>è´µæ—å•¤é…’èŠ±æ¥è‡ªå¾·å›½å’Œæ·å…‹å…±å’Œå›½ï¼Œè¢«è®¤ä¸ºæ˜¯æœ€ç»å…¸çš„å•¤é…’èŠ±ç±»å‹ï¼›å…¶ä¸­åŒ…æ‹¬Saaz å’Œ Tettnanger ç­‰å“ç§ï¼Œè¿™äº›ç±»å‹çš„å•¤é…’èŠ±å«æœ‰è¾ƒå°‘çš„ Î±é…¸ï¼Œå¹¶å«æœ‰é«˜æ°´å¹³çš„è›‡éº»çƒ¯ç²¾æ²¹</p><p>ç¾å¼å•¤é…’èŠ±å¾€å¾€æ›´å¤§èƒ†ï¼Œè€Œä¸”é¦™å‘³æ›´åŠ æ˜æ˜¾ï¼›å®ƒä»¬å«æœ‰å¤§é‡çš„æœˆæ¡‚çƒ¯ç²¾æ²¹ï¼Œè¿™ä½¿å®ƒä»¬æ•£å‘å‡ºæ¾æ ‘å’ŒæŸ‘æ©˜çš„é¦™å‘³ï¼Œå¯ä»¥å°†Cascade å’Œ Centennial å“ç§åˆ†ç±»åœ¨è¿™ä¸€ç±»åˆ«</p><p>æœ€åï¼Œè‹±å¼å•¤é…’èŠ±æ›´åŠ ç²¾è‡´å¾®å¦™ï¼›å®ƒä»¬çš„æœˆæ¡‚çƒ¯å«é‡å¾ˆä½ï¼Œè¿™èµ‹äºˆäº†å®ƒä»¬æ³¥åœŸã€æœ¨è´¨ã€è‰æœ¬ç­‰å‘³é“ï¼›ä¸è´µæ—å•¤é…’èŠ±å’Œç¾å¼å•¤é…’èŠ±ç›¸æ¯”ï¼Œè‹±å¼å•¤é…’èŠ±åªä½¿ç”¨åœ¨ä¸–ç•Œå„åœ°å°‘é‡çš„å•¤é…’å“ç§ï¼Œä½†å®ƒä»¬å¯¹é…¿é€ è‹±å¼å•¤é…’è‡³å…³é‡è¦</p><h2 id="æ·»åŠ çš„æ—¶æœº">æ·»åŠ çš„æ—¶æœº</h2><p>é€šå¸¸é…¿é…’å¸ˆåœ¨ç³–åŒ–ååŠ å…¥å•¤é…’èŠ±ï¼Œè¿™æ˜¯è°·ç‰©ä»éº¦èŠ½å˜æˆéº¦èŠ½æ±åï¼Œéœ€è¦å¼€å§‹è¿›è¡Œç…®æ²¸çš„æ—¶å€™</p><p>å½“å•¤é…’èŠ±å’Œéº¦èŠ½æ±ä¸€èµ·ç…®æ²¸æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªå«åšå¼‚æ„åŒ–ï¼ˆisomerisationï¼‰çš„è¿‡ç¨‹ï¼›è¿™ä¸ªæ“ä½œä¼šå°†Î± é…¸è½¬åŒ–ä¸º å¼‚æ„çš„ Î± é…¸ï¼ˆiso-alphaacidsï¼‰ï¼›è¿™ä¸€è¿‡ç¨‹ä½¿æœ€ç»ˆäº§ç‰©äº§ç”Ÿè‹¦å‘³ï¼Œå•¤é…’èŠ±ç…®æ²¸çš„æ—¶é—´è¶Šä¹…ï¼Œå•¤é…’å°±ä¼šè¶Šè‹¦ï¼Œæ‰€ä»¥ä¸€èˆ¬å»ºè®®å•¤é…’èŠ±çš„ç…®æ²¸æ—¶é—´ä¸è¶…è¿‡45 åˆ†é’Ÿ</p><p>å¦‚æœä½ æƒ³æ›´ä¸“æ³¨äºå•¤é…’èŠ±é£å‘³ï¼Œä½ å¿…é¡»å‡å°‘å…¶ç…®æ²¸æ—¶é—´ï¼›ç¨ååŠ å…¥å•¤é…’èŠ±ï¼Œè®©å®ƒä»¬æ²¸è…¾çš„æ—¶é—´åœ¨15 åˆ†é’Ÿåˆ° 30 åˆ†é’Ÿä¹‹é—´</p><p>å¦‚æœå•¤é…’èŠ±çš„é¦™æ°”æ›´é‡è¦ï¼Œé‚£ä¹ˆæœ€å¥½åœ¨æœ€ååŠ å…¥ï¼Œç…®æ²¸æ—¶é—´ä¸è¶…è¿‡ 5 åˆ†é’Ÿ</p><p>ä¸€äº›é…¿é…’å¸ˆç”šè‡³åœ¨å‘é…µè¿‡ç¨‹ä¸­å†åŠ å…¥å•¤é…’èŠ±ï¼Œè¿™ç§åšæ³•è¢«ç§°ä¸ºå¹²æŠ•ï¼ˆdryhoppingï¼‰ï¼ŒåŒ…æ‹¬åœ¨éº¦èŠ½æ±å†·å´åå°†å•¤é…’èŠ±æµ¸æ³¡å…¶ä¸­ï¼›è¿™ç§æ–¹æ³•å¯èƒ½éœ€è¦å‡ å¤©ç”šè‡³å‡ å‘¨çš„æ—¶é—´ï¼Œä½†å¹¶ä¸æ˜¯æ¯ä¸ªäººéƒ½è®¤ä¸ºè¿™ç§åšæ³•èµ·åˆ°äº†å®è´¨æ€§ä½œç”¨ï¼ˆä¸ªäººè®¤ä¸ºï¼Œå¹²æŠ•çš„é—®é¢˜åœ¨äºæˆæœ¬å’Œæ”¶ç›Šä¸æˆæ­£æ¯”ï¼Œåªè¦æˆæœ¬å¤§ä¸€å®šä¼šæœ‰æ”¶ç›Šçš„ï¼‰</p><p>å¯¹äºè‹¦å‘³çš„æµ‹é‡ï¼Œæœ‰ IBUï¼ˆInternational Bitterness Unitï¼‰è¿™ä¸€å›½é™…ç»Ÿä¸€å•ä½ï¼Œé…¿é…’å¸ˆåœ¨ä½¿ç”¨ Î± é…¸æ—¶åº”ç†Ÿæ‚‰è¿™äº›æµ‹é‡æ–¹æ³•</p><p>å•¤é…’å…¬å¸ä¸€èˆ¬éƒ½æœ‰èƒ½å¤Ÿç²¾ç¡®æµ‹é‡è‹¦åº¦å€¼çš„æœºå™¨ï¼Œå¯¹äºå®¶é…¿è€…ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å…¬å¼å¯¹IBU è¿›è¡Œè®¡ç®—ï¼ˆ<a href="https://homebrewacademy.com/ibu-calculator/">IBUcalculator</a>ï¼‰</p><h1 id="å•¤é…’èŠ±å“ç§å…¥é—¨">å•¤é…’èŠ±å“ç§å…¥é—¨</h1><h2 id="è´µæ—é…’èŠ±noblecontinental-hops">è´µæ—é…’èŠ±ï¼ˆNoble/ContinentalHopsï¼‰</h2><p>è¿™ç§å•¤é…’èŠ±å“ç§çš„å•¤é…’å£æ„Ÿç»†è…»ã€è¾›è¾£ï¼Œå…·æœ‰èŠ±é¦™å’Œæ³¥åœŸå‘³ï¼Œèµ·æºäºä¸­æ¬§ï¼Œä¸»è¦äº§åœ°æ˜¯æ·å…‹å…±å’Œå›½å’Œå¾·å›½ï¼Œå®ƒä»¬çš„æ‹‰æ ¼ï¼ˆlagersï¼‰å’Œçš®å°”æ£®ï¼ˆpilsnersï¼‰å•¤é…’å…·æœ‰æ ‡å¿—æ€§çš„é£å‘³ç‰¹å¾ï¼Œè¦å½’åŠŸäºè¿™ç§å•¤é…’èŠ±å“ç§å«æœ‰é«˜æ¯”ä¾‹çš„çš„è›‡éº»çƒ¯ç²¾æ²¹ï¼ˆessentialoil humuleneï¼‰</p><p>é…¿é…’å¸ˆå°†å…¶æè¿°ä¸ºè¾›è¾£ã€è¯è‰ã€è‰æœ¬ã€èŠ±é¦™ã€é»‘èƒ¡æ¤’ç­‰å‘³é“ï¼›å››ç§ Î±é…¸å«é‡ä½çš„è´µæ—å“ç§è¢«è®¤ä¸ºæ˜¯ä¼ ç»Ÿå“ç§ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å¾·å›½ - æ–¯æ´¾å°”ç‰¹ï¼ˆGerman Spaltï¼‰</li><li>å¾·å›½ - å“ˆæ‹‰é“ï¼ˆGerman Hallertauï¼‰</li><li>å¾·å›½ - æ³°ç‰¹æ˜‚ï¼ˆGerman Tettnangï¼‰</li><li>å¾·å›½ - èµ«æ–¯å¸ƒé²å…‹ï¼ˆCzech Hersbruckerï¼‰</li><li>æ·å…‹ - è¨å…¹ï¼ˆCzech Saazï¼‰</li></ul><p>é…¿é…’å¸ˆé€šå¸¸ä½¿ç”¨è¿™äº›å…·æœ‰è¾›è¾£ã€å¹³ç¨³çš„è‹¦å‘³å’ŒèŠ±é¦™çš„å•¤é…’èŠ±æ¥åˆ¶ä½œä½ IBUçš„å•¤é…’ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Bohemian Pilsner Urquell</li><li>Samuel Adams Noble Pils</li><li>Trumer Pils</li><li>Czech Saaz characteristics</li></ul><h2 id="è‹±å¼é…’èŠ±english-hops">è‹±å¼é…’èŠ±ï¼ˆEnglish Hopsï¼‰</h2><p>è¿™ç§ç±»å‹çš„å•¤é…’èŠ±ç”± 15ä¸–çºªçš„æ³•å…°å¾·æ–¯ï¼ˆFlandersï¼‰å¼€å§‹è¿›å£ï¼Œå› ä¸ºå…·æœ‰ä¼˜è‰¯çš„é˜²è…ç‰¹è´¨å¯ä»¥å¸®åŠ©å•¤é…’ä¿æŒé•¿ä¹…çš„æ–°é²œ</p><p>è‹±å¼é…’èŠ±ç±»ä¼¼äºæ¬§æ´²çš„å“ç§ï¼Œä½†å…·æœ‰æ›´å¤šçš„æœ¨è´¨ã€è¾›è¾£ã€æ°´æœå‘³å’Œæ³¥åœŸå‘³ï¼Œä»¥åŠè¾ƒä½çš„æœˆæ¡‚çƒ¯å«é‡</p><p>é…¿é…’å¸ˆå°†è¿™äº›å•¤é…’èŠ±æè¿°ä¸ºæ³¥åœŸã€é¦™è‰ã€èŠ±é¦™ã€è‰æœ¬å’Œæ°´æœï¼Œæœ€å¸¸è§çš„ç±»å‹æœ‰ï¼š</p><ul><li>ç¦æ ¼ï¼ˆFuggleï¼‰</li><li>ä¸œè‚¯ç‰¹éƒ¡å¤ä¸ï¼ˆEast Kent Goldingï¼‰</li><li>æœåœ£è€…ï¼ˆPilgrimï¼‰</li><li>åå­—ç‡•é›€ï¼ˆBramling Crossï¼‰</li><li>å¡”å‰ç‰¹ï¼ˆTargetï¼‰</li><li>æŒ‘æˆ˜è€…ï¼ˆChallengerï¼‰</li></ul><p>é…¿é…’å¸ˆå°†é€‰æ‹©è¿™ç§å•¤é…’èŠ±å“ç§æ¥é…¿é€ ä»¥ä¸‹é£æ ¼ï¼š</p><ul><li>Peterâ€™s Best Bitter</li><li>Abbot Ale</li><li>Spitfireâ€™s Amber Kentish Ale</li><li>Timothy Taylor Landlord</li></ul><h2 id="ç¾å¼é…’èŠ±american-hops">ç¾å¼é…’èŠ±ï¼ˆAmerican Hopsï¼‰</h2><p>è¿™ç§é…’èŠ±å“ç§ä½“ç§¯å¤§ã€æ›´è‹¦ã€ç‰¹ç‚¹é²œæ˜ï¼Œä½ å¯ä»¥åœ¨å¸‚åœºä¸Šæ‰¾åˆ°è¶…è¿‡ 50ç§ä¸åŒçš„å“ç§</p><p>å¤§å¤šæ•°ç¾å›½é…¿é…’å¸ˆéƒ½ä½¿ç”¨å®ƒä»¬æ¥é…¿é€ å¸¦æœ‰æ ‘è„‚ã€æ¾è„‚å’ŒæŸ‘æ©˜å‘³çš„æµ…è‰²å•¤é…’</p><p>åŸºæœ¬ä¸Šè¿™äº›éå¸¸èŠ³é¦™çš„æ¤ç‰©æ˜¯å‡ ä¹æ‰€æœ‰ç¾å¼ IPA ï¼ˆAmericanIPAï¼‰çš„æ ‡å¿—ï¼Œèµ‹äºˆå®ƒä»¬æ˜æ˜¾çš„é¦™å‘³å’Œè‹¦å‘³ï¼›é…¿é…’å¸ˆé€šå¸¸å¯¹è¿™ç§å•¤é…’èŠ±å“ç§çš„æè¿°åŒ…æ‹¬çƒ­å¸¦æ°´æœã€æŸ‘æ©˜ã€è‘¡è„æŸšã€è¾›è¾£ã€æ ‘è„‚å’Œæ¾è„‚ï¼Œæœ€å—æ¬¢è¿çš„ç¾å›½å•¤é…’èŠ±åˆ—è¡¨åŒ…æ‹¬è‘—åçš„å››ä¸ªCï¼š</p><ul><li>å¥‡åŠªå…‹ï¼ˆChinookï¼‰</li><li>å¡æ–¯å¡ç‰¹ï¼ˆCascadeï¼‰</li><li>å“¥ä¼¦å¸ƒï¼ˆColumbusï¼‰</li><li>ä¸–çºªï¼ˆCentennialï¼‰</li></ul><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´åå‘æ°´æœé£å‘³çš„å“ç§ï¼š</p><ul><li>è¥¿æ¥šï¼ˆCitraï¼‰</li><li>è¥¿å§†ç§‘ï¼ˆSimcoeï¼‰</li><li>äºšéº»é»„ï¼ˆAmarilloï¼‰</li></ul><p>è®¸å¤šç¾å›½äººå–œæ¬¢å››ç§ C é…¿é€ çš„å•¤é…’ï¼Œç‰¹åˆ«æ˜¯ï¼š</p><ul><li>Racer 5 IPA</li><li>Sierra Nevada Pale Ale</li><li>Amber IPA</li><li>American West Coast IPA</li><li>Ranger IPA</li></ul><h2 id="æ–°ä¸–ç•Œé…’èŠ±new-world-hops">æ–°ä¸–ç•Œé…’èŠ±ï¼ˆNew World Hopsï¼‰</h2><p>å°½ç®¡è¿™äº›å•¤é…’èŠ±æ¥è‡ªä¸–ç•Œå„åœ°ï¼Œä½†å®ƒä»¬éƒ½å…·æœ‰ç›¸åŒçš„çƒ­å¸¦æ°´æœå’ŒæŸ‘æ©˜é£å‘³ï¼Œç°åœ¨æœ€æµè¡Œçš„æ˜¯ï¼š</p><ul><li>è¥¿æ¥šï¼ˆCitraï¼‰ï¼šæ¥è‡ªç¾å›½ï¼Œå¸¦æœ‰æŸ‘æ©˜ã€æŸ æª¬ã€è èå’ŒèŠ’æœå‘³é“</li><li>åŸƒå°”å¾·æ‹‰å¤šï¼ˆEl Doradoï¼‰ï¼šæ¥è‡ªç¾å›½ï¼Œå¸¦æœ‰ç”œç“œã€è èç­‰å‘³é“</li><li>äºšéº»é»„ï¼ˆAmarilloï¼‰ï¼šæ¥è‡ªç¾å›½ï¼Œå¸¦æœ‰æŸ‘æ©˜å’Œæ©™å­å‘³é“</li><li>é©¬èµ›å…‹ï¼ˆMosaicï¼‰ï¼šè¿™ç§ç¾å›½å•¤é…’èŠ±å¸¦æœ‰ç™¾é¦™æœã€æµ†æœã€æŸ‘æ©˜ã€èŠ’æœç­‰å‘³é“ï¼Œè¿˜æœ‰ç‹¬ç‰¹çš„ç³–æœæ„Ÿè§‰</li><li>é“¶æ²³ï¼ˆGalaxyï¼‰ï¼šæ¥è‡ªæ¾³å¤§åˆ©äºšï¼Œå¸¦æœ‰æŸ‘æ©˜ã€çƒ­å¸¦æ°´æœç­‰é£å‘³</li><li>è«å›¾ä¼Šå¡ï¼ˆMotuekaï¼‰ï¼šæ¥è‡ªæ–°è¥¿å…°ï¼Œå…·å¤‡çƒ­å¸¦æ°´æœã€æŸ æª¬ç­‰é£å‘³</li></ul><p>ä½¿ç”¨è¿™äº›å•¤é…’èŠ±çš„å•¤é…’å¾ˆæµè¡Œï¼Œä½ åº”è¯¥è¯•è¯•ï¼š</p><ul><li>Hazy IPA</li><li>NEIPA</li><li>Feral Biggie Juice</li></ul><p>å¦‚ä»Šå…¨çƒå¸‚åœºä¸Šå¯ç”¨çš„å•¤é…’èŠ±ç±»å‹å‡ ä¹æ— ç©·æ— å°½ï¼›ä¸€äº›æ•°æ®ä¼°è®¡ï¼Œé…¿é€ äº§ä¸šç§æ¤äº†120 ç§ä¸åŒçš„å•¤é…’èŠ±ï¼Œç”šè‡³è¿˜æœ‰æ›´å¤šçš„å®éªŒå“ç§æˆ–è®¸å¾ˆå¿«å°±ä¼šè¿›å…¥å¸‚åœº</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/American-hops.jpg" class=""><h1 id="å•¤é…’èŠ±çš„é£å‘³">å•¤é…’èŠ±çš„é£å‘³</h1><blockquote><p>When I read descriptions with flowery language, I find it not justuselessâ€”but sometimes misleading.</p></blockquote><p>é¦–å…ˆï¼Œå•¤é…’èŠ±çš„å‘³é“å’Œé¦™æ°”æå…¶å¤æ‚ï¼Œå³ä½¿æ˜¯åœ¨ä¸€ä¸ªå“ç§ä¸­ï¼Œä¸åŒå“è´¨çš„è¡¨è¾¾ä¹Ÿå¯èƒ½æ˜¯ä¸‡èŠ±ç­’ï¼Œä¹Ÿå–å†³äºå•¤é…’èŠ±çš„ä½¿ç”¨æ–¹å¼ä»¥åŠä¸å…¶ä»–å“ç§çš„ç»„åˆï¼›åœ¨æ—©äº›å¹´ï¼Œè¯†åˆ«å‡ºè®¸å¤šé¥®é…’è€…ç†Ÿæ‚‰çš„ä¸»åŠ›å“ç§ï¼ˆCascade- å¡æ–¯å¡ç‰¹ã€Chinook -å¥‡åŠªå…‹ï¼‰å°±è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å¦‚ä»Šå·²ç»æ— æ³•æ»¡è¶³ç°çŠ¶ï¼Œé‚£ä¹ˆå•¤é…’å‚è¯¥å¦‚ä½•ä¼ è¾¾å•¤é…’çš„å‘³é“å‘¢ï¼Ÿ</p><p>å…¶æ¬¡ï¼Œå¦‚æœç›´æ¥é™ˆåˆ—å‡ºå‘³é“å’Œé¦™æ°”å¯èƒ½ä¼šè¿‡äºæŠ½è±¡ï¼Œä½†å¦‚æœä½¿ç”¨ â€œæ¤°å­â€æ¥è¿›è¡Œæè¿°ï¼Œæ˜¯æˆ‘ä»¬éƒ½å¯ä»¥ç†è§£çš„è¡¨è¾¾</p><p>ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼ŒBarth-Hass å…¬å¸çš„ Georg Drexlerä¸ä¸€ä½é¦™æ°´åˆ¶é€ å•†åˆä½œï¼Œæå‡ºäº†ä¸€ä¸ªå•¤é…’èŠ±é£å‘³çš„åˆ†ç±»æ³•ï¼Œæè¿°è¿™é¡¹ç ”ç©¶çš„å­¦æœ¯è®ºæ–‡å°šæœªå…¬å¼€ï¼Œä½†Milk The Funk å‘å¸ƒäº† Drexler çš„åˆ†ç±»æ–¹æ³•</p><p>ä¸‹é¢æ˜¯ä»–æå‡ºçš„å‡ ä¸ªç±»åˆ«ï¼Œä¹Ÿé™„å¸¦äº†æ‹¥æœ‰è¿™ç§é£å‘³ã€è¡¨è¾¾æ¯”è¾ƒæ˜æ˜¾çš„å•¤é…’èŠ±å“ç§ï¼ˆæ‹¬å·å†…ï¼‰</p><ul><li><strong>èŠ±é¦™ï¼ˆ<em>Ella</em>ï¼‰</strong>ï¼šæ¥éª¨æœ¨èŠ±ã€æ´‹ç”˜èŠèŠ±ã€å±±è°·ç™¾åˆã€èŒ‰è‰èŠ±ã€è‹¹æœèŠ±ã€ç«ç‘°ã€å¤©ç«ºè‘µã€åº·ä¹ƒé¦¨ã€ä¸é¦™ã€è–°è¡£è‰</li><li><strong>æŸ‘æ©˜ï¼ˆ<em>MandarinaBavaria</em>ï¼‰</strong>ï¼šè‘¡è„æŸšã€æ©™å­ã€é’æŸ ã€æŸ æª¬ã€ä½›æ‰‹æŸ‘ã€æŸ æª¬è‰ã€å§œã€æ©˜å­</li><li><strong>ç”œæ°´æœï¼ˆ<em>Mosaic</em>ï¼‰</strong>ï¼šé¦™è•‰ã€è¥¿ç“œã€èœœç“œã€æ¡ƒå­ã€æå­ã€ç™¾é¦™æœã€è”æã€å¹²æœã€æå­ã€è èã€æ¨±æ¡ƒã€çŒ•çŒ´æ¡ƒã€èŠ’æœã€ç•ªçŸ³æ¦´</li><li><strong>ç»¿è‰²æ°´æœï¼ˆ<em>HallertauBlanc</em>ï¼‰</strong>ï¼šæ¢¨ã€æ˜†æ–¯ã€è‹¹æœã€é¹…è“ã€ç™½è‘¡è„é…’è‘¡è„</li><li><strong>çº¢æµ†æœï¼ˆ<em>Monroe</em>ï¼‰</strong>ï¼šé»‘åŠ ä»‘ã€çº¢åŠ ä»‘ã€è“è“ã€æ ‘è“ã€é»‘è“ã€è‰è“ã€é‡ç”Ÿè‰è“ã€è”“è¶Šè“</li><li><strong>ç„¦ç³–ï¼ˆ<em>Triskel</em>ï¼‰</strong>ï¼šé»„æ²¹ã€å·§å…‹åŠ›ã€é…¸å¥¶ã€èœ‚èœœã€å¥¶æ²¹ã€ç„¦ç³–ã€å¤ªå¦ƒç³–ã€å’–å•¡ï¼Œé¦™è‰ã€å†¬åŠ è±†ï¼ˆTonkaï¼Œé›¶é™µé¦™è±†ï¼Œ<ahref="https://www.nosetime.com/xiangshui/116580.html">ç¥–ç›ç‘é¦¥éƒå…¸è—ç³»åˆ—-æœ«è¯ä¸å†¬åŠ è±†</a>ï¼‰</li><li><strong>æœ¨è´¨ï¼ˆ<em>Relax</em>ï¼‰</strong>ï¼šçƒŸè‰ã€å¹²é‚‘ç™½å…°åœ°ã€æ©¡æœ¨ã€çš®é©ã€åŠåœ†ã€é¦™æ–™ã€æ²¡è¯ã€æ ‘è„‚ã€æ³¥åœŸã€é›ªæ¾ã€æ¾æ ‘</li><li><strong>è–„è·ï¼ˆ<em>Polaris</em>ï¼‰</strong>ï¼šè–„è·ã€æŸ æª¬æ²¹ã€æ¨Ÿè„‘ã€è–„è·é†‡ã€è‘¡è„é…’é…µæ¯</li><li><strong>é¦™è‰ï¼ˆ<em>Columbus</em>ï¼‰</strong>ï¼šçˆ±å¤«èŠã€éƒé‡‘é¦™ã€ç½—å‹’ã€æ¬§èŠ¹ã€é¾™è’¿ã€è³èã€èŒ´é¦™ã€ç™¾é‡Œé¦™ã€è¿·è¿­é¦™ã€é©¬éƒå…°ã€ç»¿èŒ¶ã€çº¢èŒ¶ã€ä¼´ä¾£èŒ¶ã€é¼ å°¾è‰</li><li><strong>è¾›è¾£ï¼ˆ<em>Saazer</em>ï¼‰</strong>ï¼šèƒ¡æ¤’ã€è¾£æ¤’ã€å’–å–±ã€æœæ¾å­ã€èŒ´é¦™ã€è‚‰è±†è”»ã€ç”˜è‰ã€ä¸é¦™ã€ç”Ÿå§œé¢åŒ…ã€èŒ´é¦™ç±½</li><li><strong>é’è‰ï¼ˆ<em>Herkules</em>ï¼‰</strong>ï¼šæ–°é²œåˆ‡å‰²çš„è‰ã€å¹²è‰ã€ç•ªèŒ„å¶ã€é’æ¤’ã€è¨éº»</li><li><strong>æ¤ç‰©ï¼ˆ<em>Summit</em>ï¼‰</strong>ï¼šèŠ¹èœæ±¤ã€èŠ¹èœæ ¹ã€éŸ­èœã€æ´‹è‘±ã€æœé²œè“Ÿã€å¤§è’œã€é‡ç”Ÿå¤§è’œ</li></ul><p><em>PS</em>ï¼šæ¯”è¾ƒå¤šï¼Œé£å‘³æœ¬èº«å°±æ˜¯ä¸€é—¨ç„å­¦ï¼Œå½“ç„¶æœ€æ ‡å¿—çš„çƒ­å¸¦æ°´æœï¼Œç”šè‡³æ˜¯æ ¸æœç­‰è¿˜æ˜¯ä¼šä½“ç°çš„å¾ˆæ˜æ˜¾</p><img src="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E5%95%A4%E9%85%92%E8%8A%B1%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E7%9F%A5%E8%AF%86/Hop-Flavor-Wheel-sgn.png" class=""><p>flavor wheel ä¸‹è½½åœ°å€</p><p><a href="https://peertobeer.net/category/beer-downloads/">DownloadsArchives - Peer To Beer</a></p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://homebrewacademy.com/beer-hops/">Beer Hops: All YouNeed to Know | Homebrew Academy</a></p><p><ahref="https://www.beervanablog.com/beervana/2020/1/5/describing-the-flavor-of-hops">Describingthe Flavors of Hops â€” Beervana (beervanablog.com)</a></p><p><a href="https://renegadebrewing.com/hops/">What Are Hops In Beer?(Why Add It?) (renegadebrewing.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç²¾é…¿å•¤é…’ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Guava RateLimiter</title>
      <link href="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter.html</url>
      
        <content type="html"><![CDATA[<h1 id="é™æµ">é™æµ</h1><p>é™æµæ˜¯ä¿æŠ¤é«˜å¹¶å‘ç³»ç»Ÿçš„ä¸‰æŠŠåˆ©å™¨ä¹‹ä¸€ï¼ˆé™æµã€ç¼“å­˜ã€é™çº§ï¼‰ï¼›å…¶ç›®çš„æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®æˆ–è¯·æ±‚è¿›è¡Œé™é€Ÿæˆ–è€…ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„çš„è¯·æ±‚è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡æˆ–è¿›è¡Œæµé‡æ•´å½¢</p><p>é™æµçš„ç±»å‹å¯å¤§è‡´åˆ†ä¸ºï¼š</p><ul><li>é™åˆ¶æ€»å¹¶å‘æ•° - æ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± </li><li>é™åˆ¶ç¬æ—¶å¹¶å‘æ•° - nginx çš„ limitconn æ¨¡å—ã€Java Semaphoreé™åˆ¶å¹¶å‘</li><li>é™åˆ¶æ—¶é—´çª—å£å†…çš„å¹³å‡é€Ÿç‡ - Guava çš„ RateLimiter</li><li>å…¶ä»– - æ ¹æ®ç½‘ç»œæµé‡ã€CPU å ç”¨ç‡ã€å†…å­˜å ç”¨ç‡ç­‰ä½œä¸ºæ ‡å‡†æ¥è¿›è¡Œé™æµ</li></ul><h1 id="æ¡¶æ¼-ä»¤ç‰Œæ¡¶">æ¡¶æ¼ &amp; ä»¤ç‰Œæ¡¶</h1><p>æ¡¶æ¼å’Œä»¤ç‰Œæ¡¶æŒ‡çš„æ˜¯é™æµçš„ä¸¤ç§æ¨¡å‹ï¼Œå…¶ç›®çš„éƒ½æ˜¯é™æµä»¥è¾¾åˆ°é™åˆ¶æ—¶é—´çª—å£å†…çš„å¹³å‡é€Ÿç‡çš„ç›®çš„</p><p>æ¡¶æ¼æ˜¯æ¥æ”¶è¯·æ±‚ï¼Œå¹¶æŒ‰ç…§ä¸€å®šçš„é€Ÿç‡é€šè¿‡è¯·æ±‚</p><p>ä»¤ç‰Œæ¡¶æ˜¯æŒ‰ç…§å›ºå®šçš„é€Ÿç‡ç”Ÿäº§ä»¤ç‰Œï¼Œè¯·æ±‚éœ€è¦è·å–å¯¹åº”çš„ä»¤ç‰Œæ‰èƒ½é€šè¿‡</p><h1 id="ratelimiter">RateLimiter</h1><p>Guava æ˜¯ Java é¢†åŸŸä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œå®ƒåŒ…å«äº† Google åœ¨ Javaé¡¹ç›®ä¸­ä½¿ç”¨ä¸€äº›æ ¸å¿ƒåº“</p><p>å…¶ä¸­å°±æœ‰é™æµç›¸å…³çš„ <code>RateLimiter</code>å·¥å…·ï¼Œåº•å±‚åŸºäºä»¤ç‰Œæ¡¶æ€æƒ³ï¼Œæä¾›äº†å¹³æ»‘çªå‘é™æµï¼ˆSmoothBurstyï¼‰å’Œå¹³æ»‘é¢„çƒ­é™æµï¼ˆSmoothWarmingUpï¼‰å¤šç§å®ç°</p><p>ç±»å›¾å±æ€§å¦‚ä¸‹ï¼š</p><img src="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter/RateLimiter%E7%B1%BB%E5%9B%BE.png" class=""><h2 id="åˆ›å»º">åˆ›å»º</h2><p>æœ€ç»ˆçš„å®ç°ç±»éƒ½æ˜¯ <code>SmoothRateLimiter</code>çš„å†…éƒ¨ç±»ï¼Œä½†æ˜¯åˆ›å»ºæ–¹æ³•æ”¾åœ¨äº†æ›´ä¸Šå±‚çš„ <code>RateLimiter</code>ä¸­ï¼ˆå·¥å‚ï¼‰</p><p>è°ƒç”¨ <code>RateLimiter.create()</code> é™æ€æ–¹æ³•è¿›è¡Œåˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NO.1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(<span class="type">double</span> permitsPerSecond)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> create(SleepingStopwatch.createFromSystemTimer(), permitsPerSecond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NO.2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">long</span> warmupPeriod, TimeUnit unit)</span> &#123;</span><br><span class="line">    checkArgument(warmupPeriod &gt;= <span class="number">0</span>, <span class="string">&quot;warmupPeriod must not be negative: %s&quot;</span>, warmupPeriod);</span><br><span class="line">    <span class="keyword">return</span> create(</span><br><span class="line">        SleepingStopwatch.createFromSystemTimer(), permitsPerSecond, warmupPeriod, unit, <span class="number">3.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>SmoothBursty</strong></p><p>å…ˆçœ‹å‚æ•°åˆ—è¡¨ä¸º <code>double permitsPerSecond</code>çš„æ–¹æ³•ï¼Œ<code>SleepingStopwatch.createFromSystemTimer()</code>åˆ›å»ºäº†ä¸€ä¸ª <code>SleepingStopwatch</code> åè°ƒç”¨äº†ä¸‹ä¸€å±‚åˆ›å»ºæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(SleepingStopwatch stopwatch, <span class="type">double</span> permitsPerSecond)</span> &#123;</span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmoothBursty</span>(stopwatch, <span class="number">1.0</span> <span class="comment">/* maxBurstSeconds */</span>);</span><br><span class="line">    rateLimiter.setRate(permitsPerSecond);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SleepingStopwatch</code>çš„ç›®çš„æ˜¯è®°å½•åˆ›å»ºæ—¶é—´å’Œè®¡ç®—ç›¸å¯¹æ—¶é—´ï¼Œæ•´ä¸ª <code>RateLimiter</code>çš„æ—¶é—´éƒ½æ˜¯ç›¸å¯¹åˆ›å»ºæ—¶é—´è€Œè¨€çš„ï¼Œä¹Ÿå°±æ˜¯æ—¶é—´çš„è¿ç®—ä¾èµ–<code>SleepingStopwatch</code> å¯¹è±¡</p><p><code>new SmoothBursty(stopwatch, 1.0)</code>çš„å‚æ•°é™¤äº†æ—¶é—´ç›¸å…³çš„å¯¹è±¡ï¼Œå°±æ˜¯ <code>maxBurstSeconds = 1</code>äº†ï¼Œå¯ä»¥çœ‹å‡ºé»˜è®¤çš„ <code>SmoothBursty</code>å…¶åº”å¯¹çªå‘æµé‡çš„è®¾ç½®æ˜¯å¤šå­˜å‚¨æ—¶é—´ä¸º 1s çš„è®¸å¯</p><p>è€Œåè°ƒç”¨äº†<code>rateLimiter.setRate(permitsPerSecond)</code>ï¼Œè¿™ä¸ªå…ˆæ”¾åœ¨åé¢</p><p><strong>SmoothWarmingUp</strong></p><p>å‚æ•°åˆ—è¡¨ä¸º<code>double permitsPerSecond, long warmupPeriod, TimeUnit unit</code>çš„æ–¹æ³•ï¼Œå…ˆå¯¹å‚æ•°è¿›è¡Œäº†æ ¡éªŒï¼Œéšåä¹Ÿè°ƒç”¨äº†ä¸‹ä¸€å±‚çš„åˆ›å»ºæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">static</span> RateLimiter <span class="title function_">create</span><span class="params">(</span></span><br><span class="line"><span class="params">    SleepingStopwatch stopwatch,</span></span><br><span class="line"><span class="params">    <span class="type">double</span> permitsPerSecond,</span></span><br><span class="line"><span class="params">    <span class="type">long</span> warmupPeriod,</span></span><br><span class="line"><span class="params">    TimeUnit unit,</span></span><br><span class="line"><span class="params">    <span class="type">double</span> coldFactor)</span> &#123;</span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmoothWarmingUp</span>(stopwatch, warmupPeriod, unit, coldFactor);</span><br><span class="line">    rateLimiter.setRate(permitsPerSecond);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å’Œ <code>SmoothBursty</code> ç±»ä¼¼ï¼Œå¤šäº† <code>warmupPeriod</code>ç›¸å…³çš„å‚æ•°ï¼Œä¹Ÿæ˜¯ç”¨æ¥å®ç° WarmingUp çš„å…³é”®å‚æ•°</p><p>åé¢ä¹Ÿè°ƒç”¨äº† <code>rateLimiter.setRate(permitsPerSecond)</code></p><h2 id="è®¾ç½®-rate">è®¾ç½® rate</h2><p>rate çš„è®¾ç½®å…³é”®å‚æ•°æ˜¯<code>permitsPerSecond</code>ï¼Œè¿™æ˜¯ä½¿ç”¨è€…ä¼ å…¥çš„å‚æ•°ï¼Œä»£è¡¨æ¯ç§’å¸Œæœ›ç”Ÿäº§çš„è®¸å¯æ•°é‡ï¼ˆä¸ä¸€å®šä»£è¡¨QPSï¼Œå› ä¸ºæ¯æ¬¡è¯·æ±‚è®¸å¯ä¸ä¸€å®šè¯·æ±‚ä¸€ä¸ªï¼‰</p><p>è°ƒç”¨ <code>RateLimiter</code> çš„ <code>setRate</code>æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œåœ¨æ¯æ¬¡åˆ›å»º <code>RateLimiter</code>æ—¶ï¼Œåˆ›å»ºæ–¹æ³•åœ¨å®ä¾‹åŒ–åä¹Ÿä¼šè°ƒç”¨ä¸€æ¬¡è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setRate</span><span class="params">(<span class="type">double</span> permitsPerSecond)</span> &#123;</span><br><span class="line">    checkArgument(</span><br><span class="line">        permitsPerSecond &gt; <span class="number">0.0</span> &amp;&amp; !Double.isNaN(permitsPerSecond), <span class="string">&quot;rate must be positive&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex()) &#123; <span class="comment">// è·å–é”</span></span><br><span class="line">        doSetRate(permitsPerSecond, stopwatch.readMicros());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œéšåè·å–é”è°ƒç”¨ <code>doSetRate</code>æ–¹æ³•ï¼›è¿™é‡Œå¯ä»¥è¿›è¡Œä¸€ä¸ªçŒœæƒ³ï¼Œè®¾ç½® rateå’Œè·å–è®¸å¯ä¿è¯å¹¶å‘çš„é”ä¸€å®šæ˜¯åŒä¸€æŠŠï¼Œçœ‹èµ·æ¥ç»Ÿä¸€å°è£…åˆ°äº†<code>mutex()</code> æ–¹æ³•é‡Œï¼Œè€Œåè°ƒç”¨äº† <code>doSetRate</code></p><p><strong>SmoothRateLimiter çš„ doSetRate</strong></p><p>åœ¨ <code>RateLimiter</code> ä¸­ï¼Œ<code>doSetRate</code>æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œ<code>SmoothRateLimiter</code> è¿›è¡Œäº†å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">long</span> nowMicros)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    resync(nowMicros);</span><br><span class="line">    <span class="type">double</span> <span class="variable">stableIntervalMicros</span> <span class="operator">=</span> SECONDS.toMicros(<span class="number">1L</span>) / permitsPerSecond;</span><br><span class="line">    <span class="built_in">this</span>.stableIntervalMicros = stableIntervalMicros;</span><br><span class="line">    doSetRate(permitsPerSecond, stableIntervalMicros);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè°ƒç”¨ <code>resync</code> æ–¹æ³•é‡æ–°è®¡ç®—<code>this.storedPermits</code> å’Œ<code>this.nextFreeTicketMicros</code>è¿™ä¸¤ä¸ªé‡è¦å±æ€§ï¼›è¿™æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ–¹æ³•ï¼Œåœ¨åç»­æµç¨‹ä¸­ä¼šæœ‰å¤šä¸ªæ“ä½œéƒ½è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå…·ä½“å®ç°åœ¨åé¢è¿›è¡Œåˆ†æ</p><p>æ ¹æ®å‚æ•° <code>permitsPerSecond</code>è®¡ç®—å‡ºä¸€ç§’å†…è®¸å¯ç”Ÿäº§çš„é—´éš”ï¼Œèµ‹å€¼ç»™<code>this.stableIntervalMicros</code></p><p>ç»§ç»­è°ƒç”¨ <code>doSetRate</code></p><p><strong>SmoothBursty çš„ doSetRate</strong></p><p><code>SmoothRateLimiter</code> çš„ <code>doSetRate</code>ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œ<code>SmoothBursty</code> è¿›è¡Œäº†å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">double</span> stableIntervalMicros)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">double</span> stableIntervalMicros)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">oldMaxPermits</span> <span class="operator">=</span> <span class="built_in">this</span>.maxPermits;</span><br><span class="line">    maxPermits = maxBurstSeconds * permitsPerSecond;</span><br><span class="line">    <span class="keyword">if</span> (oldMaxPermits == Double.POSITIVE_INFINITY) &#123;</span><br><span class="line">        <span class="comment">// if we don&#x27;t special-case this, we would get storedPermits == NaN, below</span></span><br><span class="line">        storedPermits = maxPermits;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç­‰æ¯”ç¼©æ”¾å·²ç»å­˜å‚¨çš„è®¸å¯æ•°é‡</span></span><br><span class="line">        storedPermits =</span><br><span class="line">            (oldMaxPermits == <span class="number">0.0</span>)</span><br><span class="line">            ? <span class="number">0.0</span> <span class="comment">// initial state</span></span><br><span class="line">            : storedPermits * maxPermits / oldMaxPermits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦è®¡ç®—äº†æ–°çš„ <code>maxPermits</code>ï¼Œå¹¶æ ¹æ®æ—§çš„<code>maxPermits</code>ï¼Œå³ <code>oldMaxPermits</code> è®¡ç®—äº†<code>storedPermits</code> çš„å€¼</p><p>ç›¸å½“äºè®¾ç½®äº†æ–°çš„ <code>permitsPerSecond</code>ï¼Œéœ€è¦è®¡ç®—æ–°çš„<code>maxPermits</code>ï¼Œå¹¶ç­‰æ¯”ç¼©æ”¾å·²ç»å­˜å‚¨çš„è®¸å¯æ•°é‡</p><h2 id="è·å–è®¸å¯permits">è·å–è®¸å¯ï¼ˆpermitsï¼‰</h2><p>åˆ›å»º <code>RateLimiter</code> å¯¹è±¡åï¼Œä½¿ç”¨ <code>acquire</code> æˆ–è€…<code>tryAcquire</code> æ–¹æ³•æ¥è·å–è®¸å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> RateLimiter.create(<span class="number">10</span>);</span><br><span class="line"><span class="type">double</span> <span class="variable">sleepTime</span> <span class="operator">=</span> rateLimiter.acquire(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„è¿”å›å€¼æ˜¯ç­‰å¾…çš„æ—¶é—´ï¼Œå¹¶ä¸”åœ¨è¿”å›ä¹‹å‰è¯¥çº¿ç¨‹ä¸€ç›´åœ¨ç­‰å¾…</p><p>ç€é‡çœ‹ä¸‹ <code>acquire</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> permits)</span> &#123; <span class="comment">// å‚æ•° permits ä»£è¡¨ä¸€æ¬¡éœ€è¦è·å–çš„è®¸å¯æ•°é‡</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">microsToWait</span> <span class="operator">=</span> reserve(permits); <span class="comment">// è°ƒç”¨ reserve æ–¹æ³•</span></span><br><span class="line">    stopwatch.sleepMicrosUninterruptibly(microsToWait); <span class="comment">// microsToWait &gt; 0 åˆ™ sleep</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1.0</span> * microsToWait / SECONDS.toMicros(<span class="number">1L</span>); <span class="comment">// æ¢ç®—æˆ s è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯é€šè¿‡ <code>reserve</code> æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªéœ€è¦ç­‰å¾…çš„å¾®ç§’å€¼<code>microsToWait</code>ï¼Œå¦‚æœå¤§äº 0 åˆ™è¿›è¡Œ sleep æ“ä½œï¼ˆä½¿ç”¨çš„åŒæ ·æ˜¯Guava åŒ…ä¸‹çš„ <code>Uninterruptibles</code>ï¼Œå…ˆä¸å…³æ³¨ï¼‰</p><p>æœ€ç»ˆå°†ç­‰å¾…çš„å¾®ç§’æ¢ç®—æˆå•ä½ç§’è¿”å›</p><p><strong>reserve</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserve</span><span class="params">(<span class="type">int</span> permits)</span> &#123;</span><br><span class="line">    checkPermits(permits); <span class="comment">// å‚æ•°æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mutex()) &#123; <span class="comment">// ä¸Šé”</span></span><br><span class="line">        <span class="keyword">return</span> reserveAndGetWaitLength(permits, stopwatch.readMicros());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•é‡Œä¸»è¦åšäº†ä¸¤éƒ¨åˆ†æ“ä½œ</p><ol type="1"><li>æ ¡éªŒå‚æ•° <code>permits</code> åˆæ³•æ€§ï¼Œå…¶å®å°±æ˜¯æ˜¯å¦å¤§äº 0<code>checkArgument(permits &gt; 0, "Requested permits (%s) must be positive", permits);</code></li><li>ä½¿ç”¨ <code>synchronized</code> å…³é”®å­—ä¸Šé”ï¼ˆ<code>mutex</code>æ–¹æ³•è¿”å›çš„æ˜¯ <code>this.mutexDoNotUseDirectly</code> ä¸€ä¸ª<code>Object</code> å¯¹è±¡ï¼‰ï¼Œä¸Šé”åæ‰§è¡Œ<code>reserveAndGetWaitLength</code> æ–¹æ³•</li></ol><p><strong>reserveAndGetWaitLength</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserveAndGetWaitLength</span><span class="params">(<span class="type">int</span> permits, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">momentAvailable</span> <span class="operator">=</span> reserveEarliestAvailable(permits, nowMicros);</span><br><span class="line">    <span class="keyword">return</span> max(momentAvailable - nowMicros, <span class="number">0</span>); <span class="comment">// è®¡ç®—ä¸€ä¸‹æ˜¯ä¸æ˜¯éœ€è¦ wait</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ–¹æ³•å â€œè·å–ç­‰å¾…é•¿åº¦â€ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œä¸»è¦æ˜¯é€šè¿‡<code>reserveEarliestAvailable</code>è·å–ä¸€ä¸ªæ—¶é—´ï¼ˆè¿™ä¸ªæ—¶é—´åœ¨åé¢çš„æ–¹æ³•ä¸­å¯çŸ¥æ˜¯ä¸‹ä¸€æ¬¡è·å–è®¸å¯çš„æ—¶é—´ï¼‰åï¼Œåœ¨æ¬¡æ–¹æ³•æœ€ç»ˆç¡®è®¤éœ€è¦ç­‰å¾…çš„æ—¶é—´å¹¶è¿”å›<code>max(momentAvailable - nowMicros, 0)</code>ï¼Œå¦‚æœä¸éœ€è¦ç­‰å¾…ï¼ˆ<code>momentAvailable - nowMicros &lt; 0</code>ï¼‰ï¼Œåˆ™è¿”å›0</p><p><strong>arliestAvailable</strong></p><p><code>RateLimiter</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç”±<code>SmoothRateLimiter</code> è¿›è¡Œäº†å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="type">long</span> <span class="title function_">reserveEarliestAvailable</span><span class="params">(<span class="type">int</span> permits, <span class="type">long</span> nowMicros)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserveEarliestAvailable</span><span class="params">(<span class="type">int</span> requiredPermits, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    resync(nowMicros); <span class="comment">// é‡æ–°è®¡ç®— storedPermits å’Œ nextFreeTicketMicros</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">returnValue</span> <span class="operator">=</span> nextFreeTicketMicros; <span class="comment">// ä¿å­˜ nextFreeTicketMicrosï¼Œå› ä¸ºåé¢å¯èƒ½ä¼šè¢«æ›´æ–°</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">storedPermitsToSpend</span> <span class="operator">=</span> min(requiredPermits, <span class="built_in">this</span>.storedPermits); <span class="comment">// ä»“åº“èƒ½æä¾›çš„è®¸å¯</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">freshPermits</span> <span class="operator">=</span> requiredPermits - storedPermitsToSpend; <span class="comment">// è¿™æ¬¡è¯·æ±‚è¶…å‡ºä»“åº“èƒ½åŠ›çš„è®¸å¯</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">waitMicros</span> <span class="operator">=</span> <span class="comment">// ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        storedPermitsToWaitTime(<span class="built_in">this</span>.storedPermits, storedPermitsToSpend)</span><br><span class="line">        + (<span class="type">long</span>) (freshPermits * stableIntervalMicros);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.nextFreeTicketMicros = LongMath.saturatedAdd(nextFreeTicketMicros, waitMicros); <span class="comment">// æ ¹æ®ç­‰å¾…æ—¶é—´å»¶é•¿ä¸‹ä¸€æ¬¡èƒ½å¤Ÿè·å–è®¸å¯çš„æ—¶é—´</span></span><br><span class="line">    <span class="built_in">this</span>.storedPermits -= storedPermitsToSpend; <span class="comment">// è°ƒæ•´ä»“åº“è®¸å¯æ•°é‡ï¼›å³ freshPermits &gt; 0ï¼ŒstoredPermits ä¸€å®š = 0</span></span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œå°±è°ƒç”¨äº†æ–¹æ³• <code>resync()</code>ï¼Œè¯¥æ–¹æ³•çš„ç›®çš„æ˜¯é‡æ–°è®¡ç®—<code>this.storedPermits</code> å’Œ<code>this.nextFreeTicketMicros</code> è¿™ä¸¤ä¸ªé‡è¦å±æ€§</p><p>æ¥ä¸‹æ¥çš„å‡ è¡Œæ“ä½œå¯ä»¥æ¦‚æ‹¬ä¸ºï¼šå¦‚æœéœ€è¦è·å–çš„è®¸å¯å¤§äºå½“å‰å·²ç»å­˜å‚¨çš„è®¸å¯ï¼Œé‚£ä¹ˆè®¡ç®—å‡ºè¶…å‡ºçš„è®¸å¯æ•°é‡<code>freshPermits</code>ï¼Œè°ƒç”¨ <code>storedPermitsToWaitTime</code>æ–¹æ³•è¿”å›å€¼åŠ ä¸Š <code>è¶…å‡ºçš„è®¸å¯æ•°é‡ Ã— è®¸å¯ç”Ÿäº§é—´éš”</code>å³å¯ç®—å‡ºéœ€è¦é¢å¤–ç­‰å¾…çš„æ—¶é•¿ï¼›è¿™é‡Œå¯¹äº <code>SmoothBursty</code>æ¥è¯´ï¼Œè¿”å›å›ºå®šæ˜¯ 0ï¼Œä¹Ÿå°±æ˜¯é¢å¤–çš„ç­‰å¾…æ—¶é—´å°±æ˜¯<code>è¶…å‡ºçš„è®¸å¯æ•°é‡ Ã— è®¸å¯ç”Ÿäº§é—´éš”</code></p><p>æœ€åæ›´æ–°è¿™æ¬¡æ“ä½œå <code>this.nextFreeTicketMicros</code> å’Œ<code>this.storedPermits</code> çš„å€¼ï¼Œè¿”å›ä¸€å¼€å§‹ä¿å­˜çš„<code>this.nextFreeTicketMicros</code></p><p><strong>è¿™é‡Œéœ€è¦æ€è€ƒä¸€ä¸ªé—®é¢˜</strong>ï¼šä¸ºä»€ä¹ˆè¿”å›çš„æ˜¯<code>resync</code> åçš„<code>nextFreeTicketMicros</code>ï¼Ÿå¦‚æœä»¤ç‰Œæ•°é‡ä¸å¤Ÿï¼Œè¿™ä¸ªå€¼ä¸æ˜¯è¢«å‘åæ›´æ–°äº†å—ï¼Ÿè¿™é‡Œå°±ä½“ç°å‡º<code>RateLimiter</code>æ•´ä½“çš„ä¸€ä¸ªæ€æƒ³ï¼Œå³æ¯ä¸€ä¸ªè¯·æ±‚è¿‡æ¥æœ¬è´¨ä¸Šéƒ½èƒ½æ‹¿åˆ°è®¸å¯ï¼Œæ— éæ˜¯ç­‰å¾…å¤šé•¿æ—¶é—´æ‰èƒ½æ‰§è¡Œï¼Œå¯¹äºè¶…å‡ºéƒ¨åˆ†æ¥è¯´ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨ç­‰å¾…ï¼Œå°†è¿™éƒ¨åˆ†æ—¶é—´å…¨éƒ¨äº¤ç»™ä¸‹ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œç­‰å¾…äº†ï¼Œæˆ‘è‡ªå·±æ¦‚æ‹¬èµ·æ¥å°±æ˜¯<strong>æƒ°æ€§è®¡ç®— + ä»¥å½“å‰çº¿ç¨‹ä¸ºä¸»</strong></p><p><strong>resync</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">resync</span><span class="params">(<span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    <span class="comment">// if nextFreeTicket is in the past, resync to now</span></span><br><span class="line">    <span class="keyword">if</span> (nowMicros &gt; nextFreeTicketMicros) &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">newPermits</span> <span class="operator">=</span> (nowMicros - nextFreeTicketMicros) / coolDownIntervalMicros();</span><br><span class="line">        storedPermits = min(maxPermits, storedPermits + newPermits);</span><br><span class="line">        nextFreeTicketMicros = nowMicros;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„ç›®çš„æ˜¯é‡æ–°è®¡ç®— <code>this.storedPermits</code> å’Œ<code>this.nextFreeTicketMicros</code> è¿™ä¸¤ä¸ªé‡è¦å±æ€§</p><p>å¦‚æœå½“å‰æ—¶é—´è¶…è¿‡äº†ä¹‹å‰è®¡ç®—çš„ä¸‹ä¸€æ¬¡è·å–è®¸å¯çš„æ—¶é—´ï¼Œåˆ™å¼€å§‹æ›´æ–°ï¼š</p><ol type="1"><li>å…ˆè®¡ç®—æ–°äº§ç”Ÿçš„è®¸å¯æ•°é‡ï¼ˆ<code>coolDownIntervalMicros()</code>è¿”å›çš„æ˜¯è®¸å¯ç”Ÿäº§çš„å›ºå®šé—´éš”ï¼‰</li><li>æ›´æ–° <code>this.storedPermits</code>ä¸ºåˆé€‚çš„å€¼ï¼ˆ<code>SmoothBursty</code> æœ€å¤šåªèƒ½å¤šå­˜å‚¨ 1s çš„è®¸å¯ï¼‰</li><li>æ›´æ–° <code>this.nextFreeTicketMicros</code> ä¸ºå‚æ•°<code>nowMicros</code></li></ol><h2 id="é¢„çƒ­warmingup">é¢„çƒ­ï¼ˆWarmingUpï¼‰</h2><p>ä¸Šé¢çš„åˆ†æä¸»è¦æ˜¯å¯¹ <code>SmoothBursty</code>è¿›è¡Œäº†åˆ†æï¼Œè¿˜æä¾›äº†ä¸€ç§å®ç°æ˜¯ <code>SmoothWarmingUp</code></p><p><code>SmoothWarmingUp</code> é€‚ç”¨äºèµ„æºéœ€è¦é¢„çƒ­çš„åœºæ™¯ï¼Œç›¸æ¯”<code>SmoothBursty</code> æ˜¯å¯¹çªå‘æµé‡è¿›è¡Œä¿è¯ï¼Œé€šè¿‡<code>maxBurstSeconds</code>æ¥è®¡ç®—é¢å¤–å­˜å‚¨çš„ä»¤ç‰Œæ•°é‡ï¼Œ<code>SmoothWarmingUp</code> ä½¿ç”¨<code>warmupPeriod</code> å‚æ•°æ¥è®¾ç½®é¢„çƒ­çš„æ—¶é•¿</p><p>ç”±äºé¢„çƒ­æœºåˆ¶çš„å­˜åœ¨ï¼Œå…¶ç”Ÿäº§è®¸å¯çš„é€Ÿåº¦æ˜¯åº”è¯¥æ˜¯åŠ¨æ€çš„ï¼Œå¦‚ä¸‹å›¾</p><img src="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter/%E8%AE%B8%E5%8F%AF%E9%A2%84%E7%83%AD.drawio.png" class="" title="è®¸å¯é¢„çƒ­.drawio"><p>å…¶è®¸å¯æ•°é‡è¶Šå¤šï¼Œè¯´æ˜è¿˜æ²¡åˆ°ç¨³å®šæ—¶æœŸï¼Œè®¸å¯çš„ç”Ÿäº§é—´éš”å°±è¦è¶Šé•¿ï¼›è®¸å¯å°‘è¯´æ˜å¤„äºç¨³å®šæœŸ</p><p><strong>å…³é”®å±æ€§è®¡ç®—</strong></p><p>æ ¹æ®è¯¥å›¾å¯ä»¥è®¡ç®—å‡ºä¸€äº›æ•°å€¼ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ï¼Œä»<code>thresholdPermits</code> åˆ° 0 çš„æ—¶é—´ï¼Œæ˜¯ä» <code>maxPermits</code>åˆ° <code>thresholdPermits</code>æ—¶é—´çš„ä¸€åŠï¼Œä¹Ÿå°±æ˜¯æ¢¯å½¢çš„é¢ç§¯æ˜¯é•¿æ–¹å½¢é¢ç§¯çš„ 2 å€ï¼Œæ¢¯å½¢çš„é¢ç§¯æ˜¯<code>warmupPeriod</code></p><p>å› ä¸ºåœ¨åˆ›å»º <code>SmoothWarmingUp</code> é»˜è®¤çš„ coldFactor ä¸º 3<code>SleepingStopwatch.createFromSystemTimer(), permitsPerSecond, warmupPeriod, unit, 3.0);</code></p><p>æ¢¯å½¢é¢ç§¯ä¸º <code>warmupPeriod</code>ï¼Œè€Œé•¿æ–¹å½¢é¢ç§¯ä¸º<code>stableInterval Ã— thresholdPermits</code>ï¼Œå³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warmupPeriod = <span class="number">2</span> * stableInterval * thresholdPermits</span><br></pre></td></tr></table></figure><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¾—å‡º <code>thresholdPermits</code> çš„å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thresholdPermits = <span class="number">0.5</span> * warmupPeriod / stableInterval</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ ¹æ®æ¢¯å½¢é¢ç§¯çš„è®¡ç®—å…¬å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warmupPeriod = <span class="number">0.5</span> * (stableInterval + coldInterval) * (maxPermits - thresholdPermits)</span><br></pre></td></tr></table></figure><p>å¾—å‡º <code>maxPermits</code> ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxPermits = thresholdPermits + <span class="number">2.0</span> * warmupPeriod / (stableInterval + coldInterval)</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† <code>thresholdPermits</code> å’Œ<code>maxPermits</code> çš„å€¼</p><p>æœ€åæ˜¯å†·å´æ—¶é—´çš„é—´éš”ï¼Œå¯¹åº”åˆ°å›¾ä¸­ä»£è¡¨çš„æ˜¯æ–œçº¿çš„æ–œç‡ï¼Œå³ç”±ç¨³å®šåˆ°å†·å´ä¸­çš„é€Ÿåº¦ï¼›åœ¨ä»£ç ä¸­ä¸ºï¼š</p><p>è¯¥æ–¹æ³• <code>SmoothBursty</code> çš„å®ç°å§‹ç»ˆè¿”å› 0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">double</span> <span class="title function_">coolDownIntervalMicros</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> warmupPeriodMicros / maxPermits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>doSetRate</strong></p><p>ä¸Šé¢åˆ†æäº† <code>SmoothBursty</code> çš„ <code>doSetRate</code>å®ç°ï¼Œè¿™é‡Œæ¥çœ‹ <code>SmoothWarmingUp</code> çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">doSetRate</span><span class="params">(<span class="type">double</span> permitsPerSecond, <span class="type">double</span> stableIntervalMicros)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">oldMaxPermits</span> <span class="operator">=</span> maxPermits;</span><br><span class="line">    <span class="type">double</span> <span class="variable">coldIntervalMicros</span> <span class="operator">=</span> stableIntervalMicros * coldFactor; <span class="comment">// coldFactor æ˜¯å›ºå®šçš„ 3</span></span><br><span class="line">    thresholdPermits = <span class="number">0.5</span> * warmupPeriodMicros / stableIntervalMicros;</span><br><span class="line">    maxPermits =</span><br><span class="line">        thresholdPermits + <span class="number">2.0</span> * warmupPeriodMicros / (stableIntervalMicros + coldIntervalMicros);</span><br><span class="line">    slope = (coldIntervalMicros - stableIntervalMicros) / (maxPermits - thresholdPermits); <span class="comment">// è®¡ç®—æ–œç‡ï¼Œå¯¹è¾¹ / ä¸´è¾¹</span></span><br><span class="line">    <span class="keyword">if</span> (oldMaxPermits == Double.POSITIVE_INFINITY) &#123;</span><br><span class="line">        <span class="comment">// if we don&#x27;t special-case this, we would get storedPermits == NaN, below</span></span><br><span class="line">        storedPermits = <span class="number">0.0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        storedPermits =</span><br><span class="line">            (oldMaxPermits == <span class="number">0.0</span>)</span><br><span class="line">            ? maxPermits <span class="comment">// initial state is cold</span></span><br><span class="line">            : storedPermits * maxPermits / oldMaxPermits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è®¡ç®—äº†ç›¸å…³çš„å±æ€§å¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡ï¼Œè®¡ç®—æ–¹æ³•éƒ½å’Œä¸Šå›¾ä¸€è‡´</p><p><strong>acquire çš„ storedPermitsToWaitTime</strong></p><p><code>acquire</code> æµç¨‹å’Œ <code>SmoothBursty</code>åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äº <code>storedPermitsToWaitTime</code> æ–¹æ³•çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserveEarliestAvailable</span><span class="params">(<span class="type">int</span> requiredPermits, <span class="type">long</span> nowMicros)</span> &#123;</span><br><span class="line">    resync(nowMicros);</span><br><span class="line">    <span class="type">long</span> <span class="variable">returnValue</span> <span class="operator">=</span> nextFreeTicketMicros;</span><br><span class="line">    <span class="type">double</span> <span class="variable">storedPermitsToSpend</span> <span class="operator">=</span> min(requiredPermits, <span class="built_in">this</span>.storedPermits);</span><br><span class="line">    <span class="type">double</span> <span class="variable">freshPermits</span> <span class="operator">=</span> requiredPermits - storedPermitsToSpend;</span><br><span class="line">    <span class="type">long</span> <span class="variable">waitMicros</span> <span class="operator">=</span></span><br><span class="line">        storedPermitsToWaitTime(<span class="built_in">this</span>.storedPermits, storedPermitsToSpend) <span class="comment">// åœ¨äºè¿™é‡Œçš„æ–¹æ³•</span></span><br><span class="line">        + (<span class="type">long</span>) (freshPermits * stableIntervalMicros);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.nextFreeTicketMicros = LongMath.saturatedAdd(nextFreeTicketMicros, waitMicros);</span><br><span class="line">    <span class="built_in">this</span>.storedPermits -= storedPermitsToSpend;</span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>waitMicros</code> ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯ä»<code>storedPermits</code> ä¸­è·å–èŠ±è´¹çš„æ—¶é—´ï¼Œä¸€éƒ¨åˆ†æ˜¯ç­‰å¾…<code>freshPermits</code> äº§ç”ŸèŠ±è´¹çš„æ—¶é—´ï¼›<code>SmoothBursty</code>çš„è¯¥æ–¹æ³•å®ç°å›ºå®šè¿”å› 0ï¼Œå³ä¸å­˜åœ¨ä» <code>storedPermits</code>è·å–è®¸å¯çš„èŠ±è´¹ï¼Œè€Œ <code>SmoothWarmingUp</code> å®ç°è¾ƒä¸ºå¤æ‚</p><p>ç”±äºéœ€è¦é¢„çƒ­ï¼Œæ‰€ä»¥ä»å­˜å‚¨çš„è®¸å¯ä¸­ä¸­å–è®¸å¯éœ€è¦èŠ±è´¹ä¸€å®šçš„æ—¶é—´ï¼Œå…¶å®å°±æ˜¯è¦è®¡ç®—ä¸‹å›¾ä¸­ï¼Œé˜´å½±éƒ¨åˆ†çš„é¢ç§¯</p><img src="/%E5%BC%80%E5%8F%91/%E5%B9%B6%E5%8F%91/Guava%20RateLimiter/%E8%AE%B8%E5%8F%AF%E9%A2%84%E7%83%AD%E8%8E%B7%E5%8F%96%E8%AE%B8%E5%8F%AF.drawio.png" class="" title="è®¸å¯é¢„çƒ­è·å–è®¸å¯.drawio"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">storedPermitsToWaitTime</span><span class="params">(<span class="type">double</span> storedPermits, <span class="type">double</span> permitsToTake)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">availablePermitsAboveThreshold</span> <span class="operator">=</span> storedPermits - thresholdPermits;</span><br><span class="line">    <span class="type">long</span> <span class="variable">micros</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// measuring the integral on the right part of the function (the climbing line)</span></span><br><span class="line">    <span class="comment">// å¦‚æœå³è¾¹æ¢¯å½¢éƒ¨åˆ†æœ‰ permitsï¼Œé‚£ä¹ˆå…ˆä»å³è¾¹éƒ¨åˆ†è·å– permitsï¼Œè®¡ç®—æ¢¯å½¢éƒ¨åˆ†çš„é˜´å½±éƒ¨åˆ†çš„é¢ç§¯</span></span><br><span class="line">    <span class="keyword">if</span> (availablePermitsAboveThreshold &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">        <span class="comment">// ä»å³è¾¹éƒ¨åˆ†è·å–çš„ permits æ•°é‡</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">permitsAboveThresholdToTake</span> <span class="operator">=</span> min(availablePermitsAboveThreshold, permitsToTake);</span><br><span class="line">        <span class="comment">// TODO(cpovirk): Figure out a good name for this variable.</span></span><br><span class="line">        <span class="comment">// æ¢¯å½¢é¢ç§¯å…¬å¼ï¼š(ä¸Šåº• + ä¸‹åº•) Ã— é«˜ / 2</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">length</span> <span class="operator">=</span> permitsToTime(availablePermitsAboveThreshold)</span><br><span class="line">            + permitsToTime(availablePermitsAboveThreshold - permitsAboveThresholdToTake);</span><br><span class="line">        micros = (<span class="type">long</span>) (permitsAboveThresholdToTake * length / <span class="number">2.0</span>);</span><br><span class="line">        permitsToTake -= permitsAboveThresholdToTake;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// measuring the integral on the left part of the function (the horizontal line)</span></span><br><span class="line">    <span class="comment">// åŠ ä¸Šé•¿æ–¹å½¢éƒ¨åˆ†çš„é˜´å½±é¢ç§¯</span></span><br><span class="line">    micros += (stableIntervalMicros * permitsToTake);</span><br><span class="line">    <span class="keyword">return</span> micros;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹äºç»™å®šçš„ x å€¼ï¼Œè®¡ç®— y å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">double</span> <span class="title function_">permitsToTime</span><span class="params">(<span class="type">double</span> permits)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> stableIntervalMicros + permits * slope;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°†è¿™éƒ¨åˆ†ç­‰å¾…æ—¶é—´è¿”å›ï¼Œè¾¾åˆ°é¢„çƒ­ç­‰å¾…çš„ç›®çš„</p><h1 id="é‡ç‚¹é—®é¢˜">é‡ç‚¹é—®é¢˜</h1><h2 id="è®¸å¯ä»å“ªæ¥">è®¸å¯ä»å“ªæ¥</h2><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œå¯ä»¥å¾—å‡ºï¼Œæ‰€è°“çš„è®¸å¯æ˜¯æƒ°æ€§çš„è¿ç®—ï¼Œå¹¶ä¸æ˜¯è¡¨é¢ç†è§£çš„å¯èƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹åœ¨ç”Ÿäº§è®¸å¯ï¼Œè€Œæ˜¯å½“è¯·æ±‚è¿›å…¥æ—¶æ‰ä¼šè®¡ç®—è®¸å¯ç›¸å…³çš„æ•°æ®ï¼ˆä¸‹ä¸€æ¬¡è®¸å¯æ—¶é—´ã€å­˜å‚¨çš„è®¸å¯æ•°é‡ã€æ»¡è¶³å½“å‰è¯·æ±‚è®¸å¯éœ€è¦ç­‰å¾…çš„æ—¶é—´ç­‰ï¼‰ï¼Œç„¶åå¯¹è¯¥è¯·æ±‚è¡Œä¸ºè¿›è¡Œå¤„ç†</p><h2 id="å¹¶å‘å®‰å…¨æ˜¯å¦‚ä½•ä¿è¯çš„">å¹¶å‘å®‰å…¨æ˜¯å¦‚ä½•ä¿è¯çš„</h2><p>å¹¶å‘ä¸»è¦å‡ºç°åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼Œ<code>setRate</code> è®¾ç½®é€Ÿç‡æ–¹æ³•å’Œ<code>acquire</code> è·å–è®¸å¯æ–¹æ³•å†…ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿäº’æ–¥</p><p>å…³é”®çš„æ–¹æ³•åœ¨ <code>reserve()</code> å†…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">reserve</span><span class="params">(<span class="type">int</span> permits)</span> &#123;</span><br><span class="line">    checkPermits(permits);</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex()) &#123;</span><br><span class="line">        <span class="keyword">return</span> reserveAndGetWaitLength(permits, stopwatch.readMicros());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆç€é‡å…³æ³¨ <code>mutex()</code> è¿”å›äº†ä»€ä¹ˆå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Can&#x27;t be initialized in the constructor because mocks don&#x27;t call the constructor.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Object mutexDoNotUseDirectly;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">mutex</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">mutex</span> <span class="operator">=</span> mutexDoNotUseDirectly;</span><br><span class="line">    <span class="keyword">if</span> (mutex == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            mutex = mutexDoNotUseDirectly;</span><br><span class="line">            <span class="keyword">if</span> (mutex == <span class="literal">null</span>) &#123;</span><br><span class="line">                mutexDoNotUseDirectly = mutex = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mutex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæœ‰å‡ ä¸ªç–‘é—®ä¸ç­”æ¡ˆï¼š</p><ul><li><code>Object mutex = mutexDoNotUseDirectly</code> ä¸ºä»€ä¹ˆä¸ç›´æ¥æ“ä½œ<code>this.mutexDoNotUseDirectly</code>ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡</li><li><code>mutexDoNotUseDirectly</code>é”å¯¹è±¡çš„åˆ›å»ºæœ‰å¿…è¦ä½¿ç”¨æ‡’æ±‰å¼å—ï¼Ÿ<code>RateLimiter</code>åœ¨å®ä¾‹åŒ–åç›´æ¥æ‰§è¡Œäº† <code>reserve</code>æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‡’åŠ è½½çš„å•ä¾‹æ„ä¹‰æ˜¯ä»€ä¹ˆ</li><li>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ <code>synchronized (this)</code>ï¼ŒåŒ…è£…äº†ä¸€ä¸ªæ–¹æ³•<code>mutex()</code> æ¥è¿”å›é”å¯¹è±¡</li></ul><p><strong>ç¬¬ä¸€ä¸ªé—®é¢˜</strong>ï¼šå‡å°‘ <code>volatile</code>å¯¹å†…å­˜çš„è¯»è¯·æ±‚ï¼›<code>mutexDoNotUseDirectly</code>æ˜¯å¯è§çš„ï¼Œæ¯æ¬¡è¯»å–éƒ½ä¼šè®¿é—®å†…å­˜ï¼Œä½¿ç”¨ä¸´æ—¶å˜é‡å¯¹äºä¸éœ€è¦å¯è§æ€§çš„åœºæ™¯èƒ½å‡å°‘è®¿é—®å†…å­˜çš„æ¬¡æ•°</p><blockquote><p>It avoids an additional volatile read of the field once itâ€™sdetermined to be non-null. è¯¦è§issueï¼šhttps://github.com/google/guava/issues/3381</p></blockquote><p><strong>ç¬¬äºŒä¸ªé—®é¢˜</strong>ï¼šæºä»£ç æ³¨é‡Šä¸­ä¹Ÿå·²ç»è§£é‡Šäº†ç›®çš„ï¼š<code>// Can't be initialized in the constructor because mocks don't call the constructor.</code></p><p>ä½œè€…æ˜¯è€ƒè™‘åˆ°ä½¿ç”¨ Mockito æ¡†æ¶æ—¶ï¼Œç”¨ mock æ–¹æ³•åˆ›å»º<code>RateLimiter</code> çš„ mockå¯¹è±¡ä¸ä¼šæ‰§è¡Œå…¶æ„é€ å™¨ï¼Œè¯¥é”å¯¹è±¡ä¸ä¼šè¢«å®ä¾‹åŒ–ï¼›å¹¶ä¸”æˆå‘˜å˜é‡ç›´æ¥èµ‹å€¼ä¹Ÿä¼šè¢«è§£é‡Šä¸ºæ„é€ å™¨çš„ä¸€éƒ¨åˆ†</p><blockquote><p>Inline field initialization is syntactic sugar for initializing fromthe constructor. è¯¦è§issueï¼šhttps://github.com/google/guava/issues/3066</p></blockquote><p><strong>ç¬¬ä¸‰ä¸ªé—®é¢˜</strong>ï¼šæ›´æ–¹ä¾¿æ§åˆ¶é”ç²’åº¦ï¼Œå¹¶ä¸”é¿å…ä½¿ç”¨<code>this</code> ä½œä¸ºé”å¯¹è±¡æ˜¯ä¸€ç§è§„èŒƒï¼Œå› ä¸ºæ— æ³•å¾—çŸ¥å¤–éƒ¨æ˜¯å¦ä¹Ÿæ˜¯ç”¨<code>this</code> ä½œä¸ºé”æ¥ä½¿ç”¨</p><blockquote><p>å¯ä»¥å‚è€ƒè¯¥å›ç­”ï¼šhttps://stackoverflow.com/questions/12397427/what-is-different-between-method-synchronized-vs-object-synchronized</p></blockquote><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/60979444">è¶…è¯¦ç»†çš„GuavaRateLimiteré™æµåŸç†è§£æ - çŸ¥ä¹ (zhihu.com)</a></p><p><ahref="https://blog.csdn.net/egg1996911/article/details/103928573">Guavaé™æµå™¨RateLimiterä¸­mutexDoNotUseDirectly/é”çš„ä½¿ç”¨_DengDengLeiçš„åšå®¢-CSDNåšå®¢</a></p><p><ahref="https://blog.csdn.net/shenchaohao12321/article/details/112143092">RateLimiteræºç åˆ†æ(Guava å’Œ Sentinel å®ç°)_ä¸€ç›´ä¸æ‡‚çš„åšå®¢-CSDNåšå®¢_sentinelratelimiter</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> å¹¶å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Guava </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¯¹è±¡åˆ›å»ºä¸å±æ€§è®¾ç½®</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>åœ¨ Spring æ¡†æ¶å’Œ MVCä¸‰å±‚æ¨¡å¼ä¸‹ï¼Œå¯¹äºåˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶å¯¹å±æ€§è¿›è¡Œèµ‹å€¼çš„æ“ä½œä¸éœ€è¦å¤æ‚çš„è®¾è®¡</p><p>ä»£ç ä¸­åˆ›å»ºçš„å¯¹è±¡å¾€å¾€æ˜¯ä¸€ä¸ª â€œè´«è¡€æ¨¡å‹â€ï¼Œåªç”¨æ¥å……å½“æ•°æ®çš„ä¼ é€’è€…</p><p>åº”è¯¥æ ¹æ®ä¸åŒçš„ç±»åŠå…¶åŠŸèƒ½é€‰æ‹©åˆé€‚çš„å¯¹è±¡åˆ›å»ºæ–¹å¼</p><h1 id="æ–¹å¼">æ–¹å¼</h1><h2 id="set-æ–¹æ³•">set æ–¹æ³•</h2><p>æœ€å¸¸è§çš„æ–¹å¼ï¼›åˆ›å»ºå¯¹è±¡åï¼Œä½¿ç”¨ set æ–¹æ³•æ¥å¯¹å±æ€§è¿›è¡Œèµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">student.setName(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">student.setAge(<span class="number">20</span>);</span><br></pre></td></tr></table></figure><h2 id="æœ‰å‚æ„é€ ">æœ‰å‚æ„é€ </h2><p>å¯¹éœ€è¦èµ‹å€¼çš„å±æ€§è®¾ç½®ä¸ºæœ‰å‚æ„é€ ä¸­çš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šä½¿ç”¨æœ‰å‚æ„é€ å™¨æ¥åˆ›å»ºå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure><h2 id="é“¾å¼èµ‹å€¼">é“¾å¼èµ‹å€¼</h2><p>å°† set æ–¹æ³•æ”¹é€ ï¼Œå°† <code>this</code> å¯¹è±¡è¿”å›è¾¾æˆé“¾å¼èµ‹å€¼çš„æ•ˆæœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">alias</span><span class="params">(String alias)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.alias = alias;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">age</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¯¹è±¡å’Œèµ‹å€¼æ“ä½œæ›´æµç•…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>().name(<span class="string">&quot;å¼ ä¸‰&quot;</span>).age(<span class="number">20</span>).alias(<span class="string">&quot;å¼ ä¸‰ä¸‰&quot;</span>);</span><br></pre></td></tr></table></figure><p><strong>Lombok</strong></p><p>Lombok çš„ <code>@Accessors(chain = true, fluent = true)</code>æ³¨è§£å¯ä»¥ç”Ÿæˆç±»ä¼¼çš„æ¨¡æ¿ä»£ç ï¼›è¯¥æ³¨è§£ä¸»è¦æ˜¯å¯¹ Beanæ–¹æ³•ï¼ˆ<code>@Getter</code> å’Œ<code>@Setter</code>ï¼‰çš„ç”Ÿæˆè¿›è¡Œè¿›ä¸€æ­¥çš„é…ç½®</p><p><code>@Accessors</code> çš„å‚æ•°ï¼š</p><ul><li>fluent - ä¸º true æ—¶ç”Ÿæˆçš„ set æ–¹æ³•åç§°ä¸ä¼šå¸¦ä¸Š <code>set</code>å‰ç¼€ï¼Œå³ä»¥å˜é‡åä½œä¸ºæ–¹æ³•å</li><li>chain - ä¸º true æ—¶ç”Ÿæˆçš„ setæ–¹æ³•ä¼šä»¥å½“å‰å¯¹è±¡ä½œä¸ºè¿”å›å€¼ï¼Œè¾¾åˆ°é“¾å¼èµ‹å€¼çš„æ•ˆæœ</li><li>prefix - è¿‡æ»¤å›ºå®šå‰ç¼€çš„å˜é‡ï¼Œä¸å¯¹æ‰€é…ç½®å‰ç¼€çš„å˜é‡ç”Ÿæˆ set æ–¹æ³•</li></ul><h2 id="builder">Builder</h2><p>å¯ä»¥ç§°ä¸ºç”Ÿæˆå™¨è®¾è®¡æ¨¡å¼</p><p>åˆ›å»ºå‡ºä¸€ä¸ª <code>Builder</code> ç”Ÿæˆå™¨æ¥å¯¹å¯¹è±¡çš„åˆ›å»ºè¿›è¡Œç®¡ç†</p><p><code>Builder</code>å¯ä»¥å¯¹åˆ›å»ºå¯¹è±¡è¿‡ç¨‹ä¸­çš„æµç¨‹è¿›è¡Œä¼˜åŒ–ï¼Œå‡å°‘é€‰é…å‚æ•°ï¼Œå¯ä»¥åœ¨åˆ›å»ºå‰å°±å¯¹å±æ€§è¿›è¡Œæ ¡éªŒï¼ˆä¼˜ç‚¹å°±æ˜¯ç”Ÿæˆå™¨æ¨¡å¼çš„ä¼˜ç‚¹ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StudentBuilder <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StudentBuilder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StudentBuilder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> StudentBuilder <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> StudentBuilder <span class="title function_">alias</span><span class="params">(String alias)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.alias = alias;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> StudentBuilder <span class="title function_">age</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Student <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="comment">// name å’Œ age å¿…é¡»èµ‹å€¼</span></span><br><span class="line">          <span class="comment">// å¦‚æœ alias è®¾ç½®äº†ï¼Œåˆ™ä»¥è®¾ç½®çš„å€¼ä¸ºå‡†ï¼›å¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä½¿ç”¨ name</span></span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">            student.setName(Assert.notBlank(<span class="built_in">this</span>.name));</span><br><span class="line">            student.setAge(Assert.notNull(<span class="built_in">this</span>.age));</span><br><span class="line">            student.setAlias(Optional.ofNullable(<span class="built_in">this</span>.alias).orElse(<span class="built_in">this</span>.name));</span><br><span class="line">            <span class="keyword">return</span> student;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>builder()</code> æ–¹æ³•åˆ›å»ºç”Ÿæˆå™¨ï¼Œå¯¹ç”Ÿæˆå™¨èµ‹å€¼åè°ƒç”¨<code>build()</code> æ–¹æ³•åˆ›å»ºå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;å¼ ä¸‰&quot;</span>).age(<span class="number">20</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// build æ–¹æ³•è°ƒç”¨ä¹‹å‰å…¶å®æ˜¯ä¸€ä¸ª Builder å¯¹è±¡</span></span><br><span class="line"><span class="type">StudentBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;å¼ ä¸‰&quot;</span>).age(<span class="number">20</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> builder.build();</span><br></pre></td></tr></table></figure><p><strong>Lombok</strong></p><p>Lombok ä¸­ä½¿ç”¨ <code>@Builder</code> æ³¨è§£å¯ä»¥è‡ªåŠ¨ç”Ÿæˆæ¨¡æ¿ä»£ç </p><h1 id="æ€»ç»“">æ€»ç»“</h1><table><colgroup><col style="width: 8%" /><col style="width: 24%" /><col style="width: 66%" /></colgroup><thead><tr class="header"><th>æ–¹å¼</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr class="odd"><td>set æ–¹æ³•</td><td>ç®€å•ç›´æ¥</td><td>å†™æ³•ç¹æ‚ï¼›æ— æ³•ä»æ•´ä½“æ§åˆ¶å˜é‡èµ‹å€¼æƒ…å†µ</td></tr><tr class="even"><td>æœ‰å‚æ„é€ </td><td>å¯¹å±æ€§èµ‹å€¼è¿›è¡Œæœ‰åŠ›çº¦æŸ</td><td>ä¸çµæ´»ï¼Œå¦‚æœæœ€ç»ˆå¯¹è±¡ç§ç±»å¤šä¼šå‡ºç°å¤šä¸ªä¸åŒå‚æ•°çš„æœ‰å‚æ„é€ å™¨ï¼Œæˆ–è€…å¤§è€Œå…¨å‚æ•°çš„æ„é€ å™¨</td></tr><tr class="odd"><td>é“¾å¼èµ‹å€¼</td><td>å†™æ³•æµç•…</td><td>ç®€å•çš„ä¼˜åŒ–ï¼Œä½†æ˜¯ä¹Ÿåªè§£å†³äº†å†™æ³•ç¹æ‚çš„é—®é¢˜</td></tr><tr class="even"><td>Builder</td><td>åŠŸèƒ½å¼ºå¤§å¯æ‰©å±•</td><td>è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºæ›´å¤šå¯¹è±¡ï¼›å®ç°å¤æ‚</td></tr></tbody></table><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p>https://blog.csdn.net/weixin_45796051/article/details/121946894</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä»£ç è§„èŒƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Crimson Sour</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Crimson%20Sour.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Crimson%20Sour.html</url>
      
        <content type="html"><![CDATA[<figure><imgsrc="https://assets-prd.punchdrink.com/wp-content/uploads/2022/09/14141915/Article-lactic-syrup-800x450.jpg"alt="Article-lactic-syrup-800x450.jpg (800Ã—450) (punchdrink.com)" /><figcaption aria-hidden="true">Article-lactic-syrup-800x450.jpg(800Ã—450) (punchdrink.com)</figcaption></figure><h1 id="æ·±çº¢é…¸é…’-crimson-sour">æ·±çº¢é…¸é…’ Crimson Sour</h1><p><a href="https://punchdrink.com/recipes/crimson-sour/">Crimson SourVermouth Cocktail Recipe | PUNCH (punchdrink.com)</a></p><blockquote><p>Sour ä½œä¸ºåè¯ç›´æ¥æœ‰â€é…¸å‘³é¸¡å°¾é…’â€œçš„æ„æ€</p><p>a drink made from strong alcohol, lemon, or lime juice, sugar, andice</p><p>Whisky Sour å¨å£«å¿Œé…¸å‘³é¸¡å°¾é…’</p></blockquote><p>å¨œå¡”è Â· å¤§å«åœ¨å¥¹çš„ä¹¦ <em>Drink Lightly</em>ä¸­å»ºè®®å¤§å®¶åˆ¶ä½œè¿™æ¯é¸¡å°¾é…’æ—¶ä½¿ç”¨å¤§é‡åº”å­£çš„æŸ‘æ©˜ç±»æ°´æœ</p><p>æ–°é²œçš„è¡€æ©™æ˜¯è¿™åœºç§€çš„æ˜æ˜Ÿï¼Œâ€œé™¤äº†çœ‹èµ·æ¥å…‰å½©ç…§äººä¹‹å¤–ï¼Œå®ƒè¿˜æ‹¥æœ‰ç¾ä¸½çš„ç”œå‘³ï¼Œå¹¶ä¸”å…·æœ‰ä¸€ç§ä»¤äººé™¶é†‰çš„ã€å‡ ä¹ç†Ÿé€äº†çš„è¦†ç›†å­å‘³é“â€</p><h2 id="åŸæ–™">åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>æµ“çƒˆçš„ç”œå‘³ç¾æ€ - 1.5 ç›å¸ï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/7232/lejon-sweet-vermouth">LeJonSweet Vermouth</a>ï¼‰</li><li>æ–°é²œæŸ æª¬æ± - 0.75 ç›å¸</li><li>æ–°é²œè¡€æ©™æ± - 0.75 ç›å¸</li><li>å¯å¯è±†ç¢é‡‘å·´åˆ© - 0.5 ç›å¸ï¼ˆè§æ³¨é‡Šï¼‰</li><li>é¦™è‰ä¹³é…¸ç³–æµ† - 0.5 ç›å¸ï¼ˆè§æ³¨é‡Šï¼‰</li></ul><p><strong>è£…é¥°ï¼š</strong>è¡€æ©™åŠåœ†åˆ‡ç‰‡ï¼ˆcrescentï¼‰ã€æŸ æª¬è½®</p><h2 id="æ­¥éª¤">æ­¥éª¤</h2><ol type="1"><li>å°†æ‰€æœ‰åŸæ–™å’Œå†°å—æ··åˆï¼Œè¿›è¡ŒçŸ­æš‚çš„ shake</li><li>æ»¤å…¥è£…æ»¡ç¢å†°çš„åŒå±‚å²©çŸ³æ¯ï¼ˆDouble Rocksglassï¼‰ï¼›é¡¶éƒ¨è¡¥å……æ›´å¤šçš„ç¢å†°ï¼Œåƒé›ªå †ä¸€æ ·</li><li>ä½¿ç”¨è¡€æ©™åŠåœ†åˆ‡ç‰‡å’ŒæŸ æª¬è½®è¿›è¡Œè£…é¥°ï¼Œæ’ä¸Šå¸ç®¡</li></ol><h2 id="æ³¨é‡Š">æ³¨é‡Š</h2><h3 id="å¯å¯è±†ç¢é‡‘å·´åˆ©cacao-nib-campari">å¯å¯è±†ç¢é‡‘å·´åˆ©ï¼ˆCacao NibCampariï¼‰</h3><ul><li>å¯å¯è±†ç¢ - 25 å…‹</li><li>é‡‘å·´åˆ© - 750 æ¯«å‡</li></ul><p>å°†å¯å¯è±†ç¢é“ºåœ¨çƒ¤ç›˜ï¼Œçƒ˜çƒ¤ 3 åˆ° 4 åˆ†é’Ÿç›´åˆ°äº§ç”Ÿé¦™å‘³å¹¶å˜ä¸ºæ·±æ£•è‰²</p><p>å†·å´åå€’å…¥ä¸€ä¸ªå¯ä»¥å¯†å°çš„å®¹å™¨ä¸­ä¸é‡‘å·´åˆ©æ··åˆï¼Œç›–ä¸Šç›–å­é™ç½® 24ä¸ªå°æ—¶ï¼Œä½¿ç”¨æ»¤ç½‘ï¼ˆchinoiseï¼‰è¿‡æ»¤åè£…ç“¶å†·è—</p><h3 id="é¦™è‰ä¹³é…¸ç³–æµ†vanilla-lactic-syrup">é¦™è‰ä¹³é…¸ç³–æµ†ï¼ˆVanilla LacticSyrupï¼‰</h3><ul><li>åŸºç¡€ç³–æµ† - 500 å…‹ï¼ˆç³–æ°´æ¯” 1:1ï¼‰</li><li>Tahitian é¦™è‰æå–ç‰© - 4 å…‹ï¼ˆ<ahref="https://www.amazon.com/-/zh/dp/B004QQ7YVM/ref=sr_1_1?__mk_zh_CN=äºšé©¬é€Šç½‘ç«™&amp;crid=3JYYCZAUEANB5&amp;keywords=Tahitian+vanilla+extract&amp;qid=1672675608&amp;sprefix=chinoise%2Caps%2C776&amp;sr=8-1">Amazon.com:Cook's Pure South Pacific Vanilla Extract 4 oz</a>ï¼‰</li><li>ä¹³é…¸ç²‰ - 2 å…‹</li><li>çŠ¹å¤ªç›ï¼ˆkosher saltï¼‰ - 1 pinch</li></ul><blockquote><p>Kosher salt</p><p>Kosher saltæŒ‡çš„æ˜¯å®Œå…¨ä¸åŠ ç¢˜ç›ï¼Œå¹¶ä¸”ç›çš„æ™¶ä½“é¢—ç²’ä¼šæ¯”ä¸€èˆ¬çš„ç›è¦å¤§ä¸€äº›</p><p>ä¸€èˆ¬çš„é£Ÿç›ä¸­éƒ½ä¼šåŠ ç¢˜ï¼Œè¿™æ ·ä¼šè®©ç›å¸¦æœ‰ç¢˜çš„å‘³é“ï¼Œä¹Ÿä¼šå½±å“åˆ°èœè‚´æœ€ç»ˆçš„å‘³é“ï¼Œä½¿ç”¨Kosher salt å°±ä¸ä¼šæœ‰è¿™äº›é—®é¢˜</p><p>å¦å¤–ï¼ŒKosher saltç”±äºæ™¶ä½“é¢—ç²’æ›´å¤§ï¼Œèƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°ä»è‚‰ç±»ä¸­å¸æ”¶æ°´åˆ†ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å¸®åŠ©è‚‰ç±»è¿›è¡Œç¬¦åˆçŠ¹å¤ªäººæ•™è§„å¤„ç†ï¼ˆé™¤å»è¡€æ¶²ï¼‰ï¼Œè¿™ç§å¤„ç†åçš„é£Ÿç‰©ç§°ä¹‹ä¸ºKosher foodï¼Œè¿™ä¹Ÿæ˜¯ Kosher salt åå­—çš„ç”±æ¥</p></blockquote><blockquote><p>1 pinch</p><p>ç¿»è¯‘ä¸ºä¸€æ’®</p><p>a pinch of salt å¾€å¾€ä¹Ÿè¡¨ç¤º â€œä¸å¯å°½ä¿¡â€</p><p>take ... with a pinch of salt â€œå¯¹ ... ä¸å¯å°½ä¿¡ã€æŒä¿ç•™æ„è§â€</p></blockquote><p>åœ¨ä¸€ä¸ªç¢—ä¸­æ··åˆç³–æµ†ã€é¦™è‰ç²¾ã€ä¹³é…¸ç²‰å’Œç›</p><p>ä½¿ç”¨æ…æ‹Œå™¨æ…æ‹Œï¼Œç›´åˆ°ä¹³é…¸å’Œç›æº¶è§£ï¼›å€’å…¥å¯†å°å®¹å™¨ä¸­å†·è— 4 å‘¨</p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES çš„é™åˆ¶å’Œç–‘éš¾é—®é¢˜</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%E9%99%90%E5%88%B6%E3%80%81%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%E9%99%90%E5%88%B6%E3%80%81%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98.html</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong><em>Programmers know the benefits of everything and thetradeoffs of nothing.</em></strong></p><p><em>ç¨‹åºå‘˜çŸ¥é“ä»»ä½•äº‹æƒ…çš„æ”¶ç›Šï¼Œå´ä¸å»æƒè¡¡åˆ©å¼Š</em></p><p><ahref="https://www.simplethread.com/relational-databases-arent-dinosaurs-theyre-sharks/">RelationalDatabases Arenâ€™t Dinosaurs, Theyâ€™re Sharks - Simple Thread</a></p></blockquote><h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>ä½¿ç”¨å…³ç³»å‹æ•°æ®çš„æ€æƒ³å»æ“ä½œ ESï¼Œä¼šå‘ç°å¾ˆå¤šåŠŸèƒ½çš„å®ç°å’Œæƒ³è±¡ä¸­æœ‰å‡ºå…¥</p><p>æˆ–è€… ESèƒ½å¤Ÿå®ç°å¾ˆå¤šæ“ä½œï¼Œä½†åŒæ—¶åˆæœ‰å¾ˆå¤šé™åˆ¶ï¼Œåœ¨è§£å†³äº†ä¸€äº›é—®é¢˜åŸºç¡€ä¸Šï¼ˆå¤©ç„¶åˆ†å¸ƒå¼é€‚åˆå¤§æ•°æ®é‡ã€tophit è¿™ç§æ–¹ä¾¿çš„åŠŸèƒ½ã€æ¨¡ç³Šæœç´¢åˆ†è¯å™¨ï¼‰ï¼Œæ˜¯å¦ä¹Ÿå¼•å…¥äº†ä¸€äº›æ–°é—®é¢˜</p><p>è®°å½•ä¸‹ ESéš¾ä»¥å¤„ç†çš„é—®é¢˜ä»¥åŠå½“å‰çš„å¤„ç†æ–¹æ³•ï¼Œæ˜¯å¦å¯ä»¥æœ‰æ›´å¥½çš„å¤„ç†æ–¹å¼ï¼Œæˆ–è€…é€‰å‹ä¸­é¿å…å¤„ç†æ­¤ç±»é—®é¢˜</p><h1 id="æ·±åº¦åˆ†é¡µ">æ·±åº¦åˆ†é¡µ</h1><p>ES ä½œä¸ºå¤©ç„¶çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ•°æ®åˆ†æ•£è‡³å„ä¸ª shard è¿›è¡Œå­˜å‚¨</p><p>å¸¦æ¥çš„é—®é¢˜å°±æ˜¯éšç€åˆ†é¡µæ·±åº¦çš„å¢åŠ ï¼Œæˆæœ¬çš„å¢åŠ ä¹Ÿä¼šæ›´åŠ æ˜æ˜¾</p><p>ES å‡è®¾ä¸€é¡µæœ‰ 100 æ¡æ•°æ®ï¼Œéœ€è¦æŸ¥è¯¢ç¬¬ 100 é¡µæ•°æ®ï¼ˆå³ from = 9900ï¼Œsize= 100ï¼‰ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æŸ¥è¯¢ 10000æ¡æ•°æ®ï¼Œæ±‡æ€»ç»™åè°ƒèŠ‚ç‚¹åï¼Œå†æœ‰åè°ƒèŠ‚ç‚¹æ’åºï¼Œæœ€ç»ˆé€‰å–çœŸå®å‘½ä¸­çš„ 100æ¡æ•°æ®è¿”å›</p><p>æ‰€ä»¥å¯¹äºæ·±åº¦åˆ†é¡µ ES è¿›è¡Œäº†é™åˆ¶ï¼Œé»˜è®¤çš„é…ç½®æ˜¯ from + size &lt;10000ï¼Œå¤§äºé™åˆ¶çš„æŸ¥è¯¢æ“ä½œä¼šè¢«æ‹’ç»</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>æ²¡æœ‰å¥½çš„åŠæ³•ï¼Œé™åˆ¶è·³é¡µçš„æ·±åº¦ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢æ›´ç²¾å‡†çš„æ•°æ®å°±å¢åŠ æŸ¥è¯¢æ¡ä»¶æ¥ç¼©å°èŒƒå›´</p><p>ä¸šåŠ¡ç»å¤§å¤šæ•°åœºæ™¯åº”è¯¥ä¹Ÿæ²¡æœ‰æŸ¥çœ‹è¿™ä¹ˆå¤šé¡µæ•°æ®çš„å¿…è¦</p><p>å¯ä»¥ä½¿ç”¨ search afterã€scrollé¿å…æ·±åº¦åˆ†é¡µé™åˆ¶ï¼Œä½†æ˜¯éƒ½æœ‰å„è‡ªåœºæ™¯çš„é™åˆ¶</p><h1 id="ç´¢å¼•åˆ·æ–°é—´éš”">ç´¢å¼•åˆ·æ–°é—´éš”</h1><p>ç´¢å¼•ä¸‹ä¼šæœ‰ä¸€ä¸ªå‚æ•°å€¼ <code>refresh_interval</code>ï¼Œè¡¨ç¤º ESåˆ·æ–°ç´¢å¼•çš„é—´éš”</p><p>åˆšè¿›è¡Œç´¢å¼•çš„æ–‡æ¡£å¹¶ä¸ä¼šç«‹å³å¯¹æœç´¢å¯è§ï¼Œè€Œæ˜¯æ»¡è¶³ä¸€å®šçš„è¦æ±‚åæ‰ä¼šå°†buffer ä¸­çš„æ•°æ®å»ºç«‹ç´¢å¼•å†™å…¥æ–‡ä»¶åŒºï¼Œå…¶ä¸­ <code>refresh_interval</code>å‚æ•°æŒ‡å®šä¸€å®šçš„æ—¶é—´é—´éš”åå°†æ•°æ®è¿›è¡Œç´¢å¼•</p><p><code>refresh_interval</code> çš„å•ä½ï¼š</p><ul><li>ms</li><li>s</li><li>m</li></ul><p>å•ä½ç¼ºçœå€¼ä¸º msï¼Œå¦‚æœé…ç½®ä¸º <code>-1</code>åˆ™è¡¨ç¤ºä¸åˆ·æ–°ç´¢å¼•ï¼Œå½“éœ€è¦å¯¼å‡ºå¤§é‡æ•°æ®æ—¶ï¼Œå¯ä»¥å°†<code>refresh_interval</code> è®¾ç½®ä¸º <code>-1</code>åŠ å¿«å¯¼å…¥é€Ÿåº¦ï¼Œå¯¼å…¥å®Œæˆåå†è®¾ç½®åˆ·æ–°é—´éš”æˆ–è€…æ‰‹åŠ¨åˆ·æ–°</p><p><strong>è®¾ç½® refresh_interval</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /<span class="punctuation">&#123;</span>index<span class="punctuation">&#125;</span>/_settings</span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">  <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>å¼ºåˆ¶åˆ·æ–°</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="punctuation">&#123;</span>index<span class="punctuation">&#125;</span>/_doc?refresh</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>æ ¹æ®ä¸šåŠ¡æƒ…å†µåˆç†è®¾ç½®åˆ·æ–°é—´éš”ï¼Œéœ€è¦å…¼é¡¾ ESå‹åŠ›å’Œæ•°æ®å®æ—¶æ€§è¦æ±‚ï¼Œæš‚æ—¶é…ç½®çš„ 500 ms</p><p>ä½†æ˜¯ scroll + update by doc id çš„æ›´æ–°æ–¹å¼æ˜¯å¦ä¼šå› ä¸º scrollçš„å¿«ç…§ç‰¹æ€§å’Œç´¢å¼•åˆ·æ–°æ—¶é—´é—®é¢˜è€Œå¯¼è‡´æ•°æ®é”™è¯¯ï¼Ÿè¿™ç§æƒ…å†µæ€ä¹ˆé¿å…</p><p>ä¸åŠæ—¶åˆ·æ–°ä¹Ÿä¼šå¯¼è‡´ update by query æ“ä½œå†²çª</p><h1 id="æ ¹æ®æ¡ä»¶æ›´æ–°-update-by-query">æ ¹æ®æ¡ä»¶æ›´æ–° update by query</h1><p>update by query æ“ä½œçœ‹èµ·æ¥ç±»ä¼¼ SQL ä¸­çš„<code>UPDATE FROM ... SET ... WHERE ...</code>ï¼Œä½†ä½¿ç”¨èµ·æ¥ä¹Ÿæœ‰å¾ˆå¤šé™åˆ¶</p><p>æ›´æ–°å†…å®¹ä½¿ç”¨ script æŒ‡å®šï¼Œä¾‹å¦‚ï¼Œå§“åä¸º <code>å¼ ä¸‰</code> çš„æ•°æ® age +1</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST my-index/_update_by_query</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ctx._source.age++&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;painless&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å› ä¸º ES çš„é”æœºåˆ¶æ¯”è¾ƒç®€å•ï¼Œå¯¹äºå†²çªåªèƒ½é€‰æ‹©ä¸¤ç§æ“ä½œ</p><blockquote><p><strong><code>conflicts</code></strong></p><p>(Optional, string) What to do if update by query hits versionconflicts: <code>abort</code> or <code>proceed</code>. Defaults to<code>abort</code>.</p></blockquote><p>åŒæ—¶éœ€è¦è¿›è¡Œæ‰‹åŠ¨åˆ·æ–°ï¼Œå¦åˆ™å¯èƒ½ä¼šé¢‘ç¹å†²çª</p><blockquote><p><strong><code>refresh</code></strong></p><p>(Optional, Boolean) If <code>true</code>, Elasticsearch refreshesaffected shards to make the operation visible to search. Defaults to<code>false</code>.</p></blockquote><p>æ­¤å¤–ï¼ŒES å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯é€šè¿‡ RESTè¿›è¡Œäº¤äº’ï¼Œè¿æ¥æ—¶é—´æ˜¯å­˜åœ¨é™åˆ¶çš„ï¼Œé»˜è®¤æ˜¯ 30 s</p><p>å½“è„šæœ¬å…·æœ‰ä¸€å®šçš„å¤„ç†é€»è¾‘ï¼Œå¹¶ä¸”æ•°æ®é‡è¾ƒå¤§ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨é™åˆ¶æ—¶é—´å†…æ²¡æœ‰å¤„ç†å®Œæˆï¼Œå°±ä¼šæŠ›å‡ºè¶…æ—¶å¼‚å¸¸</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>é…ç½®è¿æ¥æ—¶é—´ï¼Œå‡å°‘æ›´æ–°çš„æ–‡æ¡£æ•°é‡ï¼Œæ¯æ¬¡å†™å…¥éƒ½è¿›è¡Œæ›´æ–°</p><h1 id="list-å­—æ®µå¢åˆ å…ƒç´ ">list å­—æ®µå¢åˆ å…ƒç´ </h1><p>ES mapping ä¸­å­—æ®µæ˜¯ä¸é™åˆ¶å…ƒç´ æ•°é‡çš„ï¼ˆæ„Ÿè§‰å’Œç´¢å¼•çš„å®ç°æ–¹å¼æœ‰å…³ï¼‰</p><p>ä¾‹å¦‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;my-index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field_1&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;field_2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ•°æ®å¯ä»¥æ˜¯</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;field_1&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;field_2&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨æ›´æ–° listå­—æ®µæ—¶å°±éœ€è¦è€ƒè™‘æ›´æ–°æ–¹å¼ï¼Œå¦‚æœæ˜¯åˆ·æ–°æ–‡æ¡£è¿›è¡Œè¦†ç›–ï¼Œä¼šä¸ä¼šå‡ºç°æ•°æ®é”™è¯¯ï¼Ÿ</p><p>å‡è®¾ä¸€ä¸ªæ“ä½œè¦ç»™å­—æ®µå¢åŠ ä¸€ä¸ªå…ƒç´  1ï¼Œè€Œå¦ä¸€ä¸ªæ“ä½œè¦åˆ é™¤å…ƒç´  2</p><table><colgroup><col style="width: 5%" /><col style="width: 50%" /><col style="width: 45%" /></colgroup><thead><tr class="header"><th style="text-align: center;">æ—¶é—´</th><th style="text-align: center;">çº¿ç¨‹ 1</th><th style="text-align: center;">çº¿ç¨‹ 2</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">T1</td><td style="text-align: center;">æŸ¥è¯¢æ–‡æ¡£æ•°æ® docï¼Œå¾—åˆ° field =[2,3]</td><td style="text-align: center;">/</td></tr><tr class="even"><td style="text-align: center;">T2</td><td style="text-align: center;">å¤„ç†å¾—çŸ¥ï¼Œéœ€è¦å†™å…¥çš„æ•°æ® field =[1,2,3]</td><td style="text-align: center;">æŸ¥è¯¢æ–‡æ¡£æ•°æ® docï¼Œå¾—åˆ° field =[2,3]</td></tr><tr class="odd"><td style="text-align: center;">T3</td><td style="text-align: center;">å†™å…¥ ESï¼Œfield = [1,2,3]</td><td style="text-align: center;">å¤„ç†å¾—çŸ¥ï¼Œéœ€è¦å†™å…¥çš„æ•°æ® field =[3]</td></tr><tr class="even"><td style="text-align: center;">T4</td><td style="text-align: center;">/</td><td style="text-align: center;">å†™å…¥ ESï¼Œfield = [3]</td></tr></tbody></table><p>æœ€ç»ˆå¯¼è‡´æ•°æ®é”™è¯¯ï¼ˆæ²¡æœ‰ DB çš„é”æœºåˆ¶é‚£ä¹ˆæ–¹ä¾¿ï¼‰</p><p><strong>update by query</strong></p><p>å½“ç„¶å¯ä»¥ä½¿ç”¨ update by queryæ¥ä½¿ç”¨è„šæœ¬è¿›è¡Œæ“ä½œï¼Œç›¸å½“äºæŠŠä¸€éƒ¨åˆ†è¿ç®—é€»è¾‘æ”¾åœ¨äº† ES æ¥æ‰§è¡Œ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST my-index/_update_by_query</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;if(ctx._source.projectIds == null)&#123;ctx._source.projectIds = [];ctx._source.projectIds.add(params.id);&#125;else&#123;def index = ctx._source.projectIds.indexOf(params.id);if(index == -1)&#123;ctx._source.projectIds.add(params.id);&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;painless&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>ä½¿ç”¨ update by queryè„šæœ¬è¿›è¡Œå¢åˆ ï¼Œé…ç½®è¿æ¥æ—¶é—´ï¼Œé™åˆ¶æ›´æ–°çš„æ•°æ®é‡ï¼ˆæ—¶é—´ä½œä¸ºæ¡ä»¶ï¼‰</p><h1 id="æŠ˜å èšåˆä¸æ”¯æŒæ»šåŠ¨æŸ¥è¯¢">æŠ˜å ã€èšåˆä¸æ”¯æŒæ»šåŠ¨æŸ¥è¯¢</h1><p>scrollï¼Œsearch after å¯ä»¥ä¸å—æ·±åº¦åˆ†é¡µçš„é™åˆ¶ï¼Œç°åœ¨çš„å®¢æˆ·ç«¯å¯¹äº scrollæ“ä½œåŒ…è£…çš„æ¯”è¾ƒç®€å•ï¼ˆæ²¡æ³•æŒ‡å®šæ•°æ®é›†sizeï¼‰ï¼Œå¹¶ä¸”ä¸€æ¬¡æ€§å–å‡ºæ‰€æœ‰æ•°æ®è¿›å…¥å†…å­˜</p><p>æ‰€ä»¥ä½¿ç”¨ search after æ¥å®ç°å¯¹æ›´å¤§é‡æ•°æ®çš„æŸ¥è¯¢ï¼ˆå¯¼å‡ºï¼‰</p><p>ä½†æŠ˜å ï¼ˆCollapseï¼‰å’Œèšåˆï¼ˆAggregationsï¼‰æ“ä½œæ— æ³•æ”¯æŒ scroll æˆ–è€…search after çš„æŸ¥è¯¢æ–¹å¼</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å¯¹äºæŠ˜å æˆ–è€…èšåˆçš„æ•°æ®ä½¿ç”¨åˆ†é¡µè¿›è¡ŒæŸ¥è¯¢ï¼Œæ— æ³•é¿å…æ·±åº¦åˆ†é¡µçš„é™åˆ¶</p><h1 id="èšåˆæ¡¶æ•°é‡é™åˆ¶">èšåˆæ¡¶æ•°é‡é™åˆ¶</h1><p>ES çš„èšåˆä»åŠŸèƒ½ä¸Šå¯ä»¥åˆ†ä¸º 3 ç±»ï¼š</p><ul><li>æ¡¶èšåˆï¼ˆBucketï¼‰ï¼šå¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ï¼ˆåˆ†æ¡¶ï¼‰ï¼›ç±»ä¼¼ <code>GROUP BY</code><ul><li>Date histogram æ—¥æœŸç›´æ–¹å›¾</li><li>Range èŒƒå›´</li><li>Terms å­—æ®µå€¼</li><li>...</li></ul></li><li>æŒ‡æ ‡èšåˆï¼ˆMetricï¼‰ï¼šå¯¹æ¡¶å†…æ•°æ®è¿›è¡ŒæŒ‡æ ‡çš„è®¡ç®—ï¼›ç±»ä¼¼èšåˆå‡½æ•°<ul><li>Avg å¹³å‡æ•°</li><li>Max æœ€å¤§å€¼</li><li>Sum æ±‚å’Œ</li><li>...</li></ul></li><li>ç®¡é“èšåˆï¼ˆPipelineï¼‰ï¼šä»¥å…¶ä»–èšåˆä½œä¸ºå…ƒæ•°æ®çš„èšåˆï¼›ç›¸å½“äºåœ¨å…¶ä»–èšåˆçš„åŸºç¡€ä¸Šå†æ¬¡è¿›è¡Œæ“ä½œ<ul><li>Bucket selector æ¡¶é€‰æ‹©å™¨</li><li>Bucket sort æ¡¶æ’åº</li><li>Max bucket æœ€å¤§çš„æ¡¶</li><li>...</li></ul></li></ul><p>æ¡¶èšåˆä¸­æœ€å¸¸è§çš„åœºæ™¯å°±æ˜¯æ ¹æ®å­—æ®µå€¼è¿›è¡Œåˆ†æ¡¶ï¼ˆç›¸å½“äº<code>GROUP BY</code> å¤šä¸ªå­—æ®µï¼‰</p><p>ä½†æ˜¯ ES ä¸­å¯¹äºæ¡¶çš„æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œå½“ä¸€æ¬¡è¯·æ±‚è¶…è¿‡æ¡¶æ•°é‡é™åˆ¶ï¼ˆé»˜è®¤ä¸º<code>123</code>ï¼‰ï¼Œåˆ™æŸ¥è¯¢ä¼šè¿”å›é”™è¯¯<code>trying to create too many buckets. must be less than or equal to: [100000] but was [100001]</code></p><p>è¿™æ˜¯ 6.x ä»¥åç‰ˆæœ¬çš„ç‰¹æ€§ï¼Œ ç›®çš„æ˜¯é™åˆ¶å¤§æ‰¹é‡èšåˆæ“ä½œï¼Œ è§„é¿æ€§èƒ½é£é™©</p><p>å½“ç„¶å¯ä»¥è¿›è¡Œé…ç½®ï¼Œä½†ä¹Ÿå°±æ„å‘³ç€å¯èƒ½æ‰¿æ‹…æ›´å¤šçš„æ€§èƒ½é£é™©</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;search.max_buckets&quot;</span><span class="punctuation">:</span> <span class="number">20000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>æ¡¶èšåˆçš„ size</strong></p><p>åŒæ—¶ï¼Œæ¡¶èšåˆéœ€è¦æŒ‡å®š <code>size</code> å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ ESå¹¶ä¸ä¼šç›´æ¥è®¡ç®—å‡ºæ‰€æœ‰çš„æ¡¶</p><p>å‡è®¾ <code>size</code> è®¾ç½®ä¸º<code>1000</code>ï¼Œæ­¤æ—¶æ•°æ®ä¸­æ ¹æ®æŸä¸ªç»´åº¦åˆ†æ¡¶æœ‰ <code>1500</code>ä¸ªï¼Œé‚£ä¹ˆ ES åªä¼šé€‰æ‹© top 1000 ä¸ªæ¡¶è¿›è¡Œè¿”å›</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å¯¹äºæ¡¶èšåˆçš„<code>size</code>ï¼Œç»™å®šä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œåœ¨çŸ­æœŸå†…åº”è¯¥ä¸ä¼šå‡ºç°è¿™ä¹ˆæ¡¶ï¼Œå¦‚æœè¶…å‡ºé™åˆ¶åˆ™ç”±æŸ¥è¯¢é€»è¾‘æ‰‹åŠ¨è¿›è¡Œæ¡¶çš„åˆ’åˆ†ï¼ŒåŒæ—¶ä¸šåŠ¡æ˜¯ä¸æ˜¯ä¸šåŠ¡è¦æ€è€ƒï¼Œéœ€ä¸éœ€è¦å…³æ³¨ä¸€ä¸ªç»´åº¦æ•°æ®ä¸‹æ‰€æœ‰å€¼çš„ç»“æœï¼ˆæ¯”å¦‚åªå…³æ³¨top çš„æ•°æ®ï¼‰</p><p>å¯¹äºæ¡¶æ•°é‡æ˜¾ç¤ºï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼Œå®šæ—¶èšåˆä¸­é—´ç»“æœï¼ˆç‰ºç‰²å®æ—¶æ€§ï¼Œå¯¹æŸ¥è¯¢æœ‰åˆ©ï¼‰ï¼Œèšåˆè¿‡ç¨‹ä¸­å¯ä»¥æ‰‹åŠ¨æ‹†åˆ†èšåˆç»´åº¦æ¥å‡å°‘æ¡¶çš„æ•°é‡</p><h1 id="èšåˆåæ’åºå’Œåˆ†é¡µ">èšåˆåæ’åºå’Œåˆ†é¡µ</h1><p>èšåˆåæ˜¯æ— æ³•æŒ‰ç…§æ–‡æ¡£å†…å­—æ®µé¡ºåºæ¥è¿›è¡Œæ’åºçš„ï¼ˆè¿™ç‚¹åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­åº”è¯¥ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œä½†æ˜¯ES çš„æŠ˜å æ“ä½œå¯ä»¥æŒ‰ç…§æ–‡æ¡£é¡ºåºè¿›è¡Œ</p><p>èšåˆåçš„æ’åºè‚¯å®šåªèƒ½é€šè¿‡èšåˆç»´åº¦æ¥è¿›è¡Œæ’åºï¼ˆæ¡¶èšåˆçš„ keyæˆ–è€…æŒ‡æ•°èšåˆçš„ç»“æœï¼‰ï¼Œæ’åºå’Œåˆ†é¡µçš„å®ç°ä½¿ç”¨ç®¡é“èšåˆä¸­çš„<code>Bucket sort</code> å®ç°</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;sales_per_month&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;date_histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;calendar_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;month&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total_sales&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;sum&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sales_bucket_sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;bucket_sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span> <span class="attr">&quot;total_sales&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span> </span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">3</span>                                </span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ“ä½œï¼š</p><ul><li>å¯¹æ—¥æœŸæŒ‰æœˆè¿›è¡Œæ¡¶èšåˆ</li><li>å¯¹ <code>price</code> å­—æ®µè¿›è¡Œ <code>sum</code> çš„æŒ‡æ•°èšåˆ</li><li>å¯¹æ¡¶èšåˆè¿›è¡Œæ’åºå’Œåˆ†é¡µï¼ŒæŒ‰ç…§æŒ‡æ•°èšåˆ <code>total_sales</code>ç»“æœå€’åºï¼Œå– 3 æ¡æ•°æ®</li></ul><p>è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯åµŒå¥—çš„æ¡¶èšåˆï¼Œ<code>bucket_sort</code>æ˜¯æ— æ³•å¯¹ä¸Šå±‚æ¡¶ï¼Œæˆ–è€…å¯¹å…¨å±€çš„æ¡¶è¿›è¡Œåˆ†é¡µæ“ä½œ</p><blockquote><p>ES æ–‡æ¡£åŸæ–‡ <ahref="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/search-aggregations-pipeline-bucket-sort-aggregation.html">Bucketsort aggregation | Elasticsearch Guide [8.5] | Elastic</a></p><p>The <code>bucket_sort</code> aggregation, like all pipelineaggregations, is executed after all other non-pipeline aggregations.This means the sorting only applies to whatever buckets are alreadyreturned from the parent aggregation. For example, if the parentaggregation is <code>terms</code> and its <code>size</code> is set to<code>10</code>, the <code>bucket_sort</code> will only sort over those10 returned term buckets.</p></blockquote><p>åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå‡è®¾å¯¹ Aã€Bå­—æ®µè¿›è¡Œèšåˆæ“ä½œï¼Œç„¶ååœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œåˆ†é¡µåæœ‰ 5 æ¡æ•°æ®</p><p>A - 1ã€A - 2ã€B - 1ã€B - 2ã€B - 3</p><p>é‚£ä¹ˆä½¿ç”¨ <code>bucket_sort</code> åˆ†é¡µåï¼Œå‡è®¾<code>from = 0ï¼Œsize = 1</code></p><p>ç†æƒ³æƒ…å†µä¸‹æ˜¯åªè¿”å› A - 1 è¿™ä¸€æ¡</p><p>ä½†å› ä¸ºåªå¯¹ <code>parent</code> æ¡¶æœ‰æ•ˆï¼Œå®é™…çš„è¿”å›ä¼šæ˜¯</p><p>A - 1 å’Œ B - 1ï¼Œå› ä¸º <code>size</code> åªé™åˆ¶äº† Bå­—æ®µåˆ†æ¡¶çš„æ¡¶æ•°é‡</p><blockquote><p>æ‘˜è‡ªç½‘ç»œhttps://blog.csdn.net/weixin_29715563/article/details/112106227</p><p>å¼ è¶…å¤§ä½¬æŒ‡å‡ºï¼šåˆ†æç³»ç»Ÿé‡Œè·‘å…¨é‡çš„ group by æˆ‘è§‰å¾—æ˜¯åˆç†çš„éœ€æ±‚ï¼Œclickhouse å¾ˆæ“…é•¿åšè¿™ç§äº‹ï¼Œes å¦‚æœä¸åœ¨è¿™æ–¹é¢åŠ å¼ºï¼Œåˆ†æåœºæ™¯å¾ˆå¤šä¼šè¢«clickhouse æ›¿æ‰</p><p>è…¾è®¯å¤§ä½¬æŒ‡å‡ºï¼šèšåˆè¿™å—æ¯”è¾ƒçœ‹åœºæ™¯ã€‚å› ä¸ºæˆ‘è¿™è¾¹æœ‰ä¸€äº›ä¸šåŠ¡æ˜¯åšèšåˆï¼Œä¹Ÿå°±æ˜¯olap åœºæ™¯ï¼Œå¤šç»´åˆ†æï¼ŒESå¹¶ä¸æ˜¯ç‰¹åˆ«æ“…é•¿ï¼Œå¦‚æœæœ‰ä¸°å¯Œçš„å¤šç»´åˆ†æåœºæ™¯ï¼Œè¿˜æœ‰æ¯”è¾ƒé«˜çš„æ€§èƒ½è¦æ±‚ã€‚æˆ‘å»ºè®®å¯ä»¥è°ƒç ”ä¸‹clickhouseã€‚æˆ‘ä»¬è¿™è¾¹æµ‹è¯„è¿‡å¼€æºå’Œå†…éƒ¨çš„å¤§éƒ¨åˆ†åœºæ™¯ clickhouseå‡ åäº¿çš„çº§åˆ«ï¼ŒåŸºæœ¬ä¹Ÿåœ¨ç§’çº§è¿”å›ç”šè‡³æ¯«ç§’çº§</p></blockquote><p><strong>Kibana æ˜¯æ€æ ·å®ç°çš„</strong></p><p>åœ¨ Kibana ä¸Šé…ç½®å›¾è¡¨ï¼Œçœ‹èµ·æ¥èƒ½ç›´æ¥å®ç°å¾ˆç±»ä¼¼çš„åŠŸèƒ½</p><img src="/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%E9%99%90%E5%88%B6%E3%80%81%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98/Kibana%E7%9A%84%E8%81%9A%E5%90%88%E5%9B%BE%E8%A1%A8.jpg" class=""><p>å¹¶ä¸”è¿˜æ”¯æŒè·³é¡µï¼Œä¸è¿‡çœ‹äº†å…¶è¯·æ±‚ï¼Œåœ¨åˆ·æ–°æ—¶ç›´æ¥è¿›è¡Œäº†ä¸€æ¬¡å¤§è¯·æ±‚ï¼Œè¿”å›äº†æ‰€æœ‰æ•°æ®ï¼Œæœ€ååº”è¯¥æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„åˆ†é¡µæ“ä½œ</p><p>æ‰€ä»¥çœ‹èµ·æ¥ ES çš„èšåˆæœ¬èº«å°±æ— æ³•æ”¯æŒåµŒå¥—åˆ†é¡µçš„æ“ä½œ</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>ä½¿ç”¨é»˜è®¤å€¼ï¼Œå®šæ—¶èšåˆä¸­é—´ç»“æœï¼ˆç‰ºç‰²å®æ—¶æ€§ï¼Œå¯¹æŸ¥è¯¢æœ‰åˆ©ï¼‰ï¼Œå°±å¯ä»¥æ ¹æ®ä¸­é—´ç»“æœè¿›è¡Œåˆ†é¡µäº†ï¼Œä¸šåŠ¡ä¹Ÿéœ€è¦è€ƒè™‘æ˜¯å¦æœ‰å¿…è¦è·³é¡µï¼Œèšåˆåçš„ç»“æœæ˜¯åŠ¨æ€çš„ã€éç›´è§‚çš„ï¼Œè·³é¡µæŸ¥è¯¢è¿˜æœ‰æ„ä¹‰å—</p><p>åŒæ—¶å¯¹äºåµŒå¥—èšåˆã€æŠ˜å çš„åœºæ™¯ï¼Œæ‹¼æ¥ä¸€ä¸ªç”¨äºèšåˆçš„ keyä½œä¸ºèšåˆå­—æ®µï¼ˆç›¸å½“äºä¸šåŠ¡æ•°æ®æ‰‹åŠ¨æ‹¼æ¥ä¸€ä¸ªkeyï¼Œä½¿ä¸€å±‚èšåˆå®ç°åµŒå¥—èšåˆçš„æ•ˆæœï¼Œåªèƒ½é’ˆå¯¹å›ºå®šéœ€æ±‚ï¼Œä¸§å¤±äº†çµæ´»æ€§ï¼‰</p><h1 id="æ¡¶èšåˆå‡†ç¡®æ€§">æ¡¶èšåˆå‡†ç¡®æ€§</h1><p>ESçš„æ¡¶èšåˆä¼šç”±å„ä¸ªåˆ†ç‰‡èšåˆå‡ºç»“æœåå†äº¤ç”±åè°ƒèŠ‚ç‚¹æ±‡æ€»æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯æ­¤æ—¶æ±‡æ€»æ•°æ®æ˜¯æ²¡æœ‰å…¨å±€è§†é‡çš„ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¡¶çš„ä¸å‡†ç¡®</p><p>è¿™ä¸ªå‚æ•°ç”±æ¡¶èšåˆçš„ <code>shard_size</code> è¿›è¡Œæ§åˆ¶ï¼Œé»˜è®¤å–å€¼ä¸º<code>size Ã— 1.5 + 10</code></p><p>ä¹Ÿå°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹åªä¼šèšåˆ <code>shard_size</code>å¤§å°çš„ç»“æœè¿”å›ç»™åè°ƒèŠ‚ç‚¹ï¼Œå†æœ‰åè°ƒèŠ‚ç‚¹åˆå¹¶ç»“æœï¼Œè¿”å›å‡º <code>size</code>æ‰€éœ€æ•°é‡çš„æ¡¶ï¼ˆå¯ä»¥çœ‹å‡º <code>shard size</code> ä¸å¯èƒ½å°äº<code>size</code>ï¼‰</p><p>ä¹Ÿå°±æ˜¯æœ€ç»ˆç»“æœçš„æ¡¶å¹¶ä¸æ˜¯ç»å¯¹å‡†ç¡®çš„ï¼Œéœ€è¦åˆç†è®¾ç½®<code>shard_size</code> å¹³è¡¡å‡†ç¡®æ€§å’Œæ€§èƒ½</p><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å› ä¸ºèšåˆæ¡¶æ•°é‡é™åˆ¶ï¼Œ<code>size</code>è®¾ç½®äº†ä¸€ä¸ªçŸ­æœŸæ¥çœ‹è¶³å¤Ÿå¤§çš„å€¼ï¼Œæ‰€ä»¥ <code>shard_size</code> åŒæ ·å¾ˆå¤§</p><p>åº”è¯¥æš‚æ—¶ä¸ä¼šå­˜åœ¨æ¡¶ä¸å‡†ç¡®é—®é¢˜</p><h1 id="åŸºæ•°èšåˆå‡†ç¡®æ€§">åŸºæ•°èšåˆå‡†ç¡®æ€§</h1><p>å› ä¸ºåˆ†é¡µå±•ç¤ºçš„è¦æ±‚ï¼Œå¯¹äºèšåˆæˆ–è€…æŠ˜å åï¼Œéœ€è¦ç»Ÿè®¡æ¡¶çš„æ•°é‡</p><p>åµŒå¥—æ“ä½œæ— æ³•è¿›è¡ŒåŸºæ•°èšåˆï¼Œæ‰€ä»¥æ­¤å¤„ä¹Ÿä½¿ç”¨äº†ä¸šåŠ¡æ‰‹åŠ¨æ‹¼æ¥çš„èšåˆkeyï¼Œè¿›è¡Œ <code>cardinality</code> æ“ä½œ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=<span class="number">0</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸºæ•°èšåˆè™½ç„¶å¯ä»¥ç»Ÿè®¡å‡ºåŸºæ•°ï¼Œä½†åº•å±‚ä½¿ç”¨ HyperLogLogè¿›è¡Œå®ç°ï¼Œä¹Ÿå°±æ˜¯å¸¦æœ‰ä¸€å®šçš„è¯¯å·®</p><figure><imgsrc="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/images/cardinality_error.png"alt="cardinality_error.png (1000Ã—400) (elastic.co)" /><figcaption aria-hidden="true">cardinality_error.png (1000Ã—400)(elastic.co)</figcaption></figure><p>è¯¯å·®æ˜¯æ¯”è¾ƒå°çš„ï¼Œå³ä½¿é˜ˆå€¼ä½è‡³ 100ï¼Œå³ä½¿åœ¨ç™¾ä¸‡ +åŸºæ•°æ—¶ï¼Œè¯¯å·®ä»ç„¶å¾ˆä½ï¼ˆå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸º1 - 6%ï¼‰</p><p>å…è®¸è¯¯å·®å­˜åœ¨ä¼šå¯¼è‡´æœ€ç»ˆæ€»é¡µæ•°ä¸å‡†ç¡®ï¼Œæˆ–è€…æ¯æ¬¡æŸ¥è¯¢éƒ½æœ‰æ‰€åŒºåˆ«</p><p>ä¸è¿‡ <code>cardinality</code> æ”¯æŒç²¾åº¦å‚æ•°<code>precision_threshold</code>ï¼Œå¦‚æœåŸºæ•°æ•°é‡åœ¨æŒ‡å®šç²¾åº¦ä»¥å†…ï¼Œé‚£ä¹ˆå°±ä¸å­˜åœ¨è¯¯å·®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=<span class="number">0</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;precision_threshold&quot;</span><span class="punctuation">:</span> <span class="number">100</span> </span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„</strong></p><p>å› ä¸ºæœ¬èº« ES å°±æœ‰æ·±åº¦åˆ†é¡µçš„é™åˆ¶ï¼ˆé»˜è®¤10000ï¼‰ï¼Œæ‰€ä»¥å¯¹äºåŸºæ•°èšåˆä¹ŸæŒ‡å®šäº†<code>precision_threshold = 10000</code></p><p>è¿™æ ·å¯¹äºåŸºæ•° 10000 ä»¥å†…çš„æ•°æ®ä¼šè¿”å›ç²¾ç¡®å€¼ï¼Œè¶…è¿‡ 10000å°±ä¸éœ€è¦å…³æ³¨ç²¾ç¡®çš„å€¼ï¼Œåªå‘å‰ç«¯è¿”å› 10000 é™åˆ¶è·³é¡µæ·±åº¦</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lua åŸºæœ¬è¯­æ³•</title>
      <link href="/%E5%BC%80%E5%8F%91/DB/Redis/Lua%20%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95.html"/>
      <url>/%E5%BC%80%E5%8F%91/DB/Redis/Lua%20%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95.html</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºæœ¬è¯­æ³•">åŸºæœ¬è¯­æ³•</h1><h2 id="å˜é‡å®šä¹‰">å˜é‡å®šä¹‰</h2><p><strong>åŸºæœ¬çš„æ“ä½œ</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="number">2</span></span><br><span class="line">str = <span class="string">&quot;hello world&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a + b)</span><br><span class="line"><span class="built_in">print</span>(str)</span><br></pre></td></tr></table></figure><strong>å¤šé‡èµ‹å€¼è¯­å¥</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a,b = <span class="number">1</span>,<span class="number">2</span>;</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure> <strong>å€¼ä¸ºnil</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--å€¼ä¸ºnil</span></span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment">--å€¼ä¸ºnil</span></span><br></pre></td></tr></table></figure><p><strong>åå…­è¿›åˆ¶ä¸ç§‘å­¦è®¡æ•°æ³•</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0x11</span></span><br><span class="line">b = <span class="number">2e10</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure></p><h2 id="æ•°å­—è¿ç®—ç¬¦">æ•°å­—è¿ç®—ç¬¦</h2><p><strong>Lua æ”¯æŒåŠ å‡ä¹˜é™¤ã€å¹‚ç­‰å¤šç§è¿ç®—</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(a+b)</span><br><span class="line"><span class="built_in">print</span>(a-b)</span><br><span class="line"><span class="built_in">print</span>(a/b)</span><br><span class="line"><span class="built_in">print</span>(a*b)</span><br><span class="line"><span class="built_in">print</span>(b^a)</span><br><span class="line"><span class="built_in">print</span>(a^b)</span><br><span class="line"><span class="built_in">print</span>(a==b)</span><br><span class="line"><span class="built_in">print</span>(a~=b) <span class="comment">--luaçš„ä¸ç­‰äºç¬¦å·ä¸º&quot;~=&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a&gt;=b)</span><br><span class="line"><span class="built_in">print</span>(a&lt;=b)</span><br></pre></td></tr></table></figure><h2 id="é€»è¾‘è¿ç®—ç¬¦ä¸-truefalse">é€»è¾‘è¿ç®—ç¬¦ä¸ trueã€false</h2><p><strong>æ³¨æ„ï¼š0 ä¸º trueï¼Œnil ä¸º false</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="literal">nil</span></span><br><span class="line">b = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"><span class="built_in">print</span>(a <span class="keyword">and</span> b)</span><br><span class="line"><span class="built_in">print</span>(a <span class="keyword">or</span> b)</span><br><span class="line"><span class="built_in">print</span>(<span class="keyword">not</span> b)</span><br></pre></td></tr></table></figure><p><strong>ä¸‰å…ƒè¡¨è¾¾å¼</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a &lt;=<span class="number">0</span> <span class="keyword">and</span> <span class="string">&quot;å°äºç­‰äº 0&quot;</span> <span class="keyword">or</span> <span class="string">&quot;å¤§äº 0&quot;</span>) <span class="comment">--è¾“å‡º&quot;å°äºç­‰äº 0&quot;</span></span><br></pre></td></tr></table></figure></p><h2 id="å­—ç¬¦ä¸²">å­—ç¬¦ä¸²</h2><p><strong>å•å¼•å·åŒå¼•å·å‡å¯</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;hello world a&#x27;</span></span><br><span class="line">b = <span class="string">&quot;hello world b&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><strong>è½¬ä¹‰å­—ç¬¦</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;hello world\næ¢è¡Œ&#x27;</span> <span class="comment">--\næ¢è¡Œ</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure><strong>ä¸­æ‹¬å·ä¿ç•™åŸå§‹å€¼ï¼ˆå¿½ç•¥è½¬ä¹‰ï¼‰</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">[[&#x27;hello world\næ¢è¡Œ&#x27;]]</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure><strong>å­—ç¬¦ä¸²ä½¿ç”¨ ".." è¿›è¡Œè¿æ¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;hello &#x27;</span></span><br><span class="line">b = <span class="string">&#x27;world&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a..b)</span><br></pre></td></tr></table></figure><p><strong>tostring(param) ä¸ tonumber(param)</strong>å¦‚æœtonumber()è½¬æ¢å¤±è´¥åˆ™å€¼ä¸ºnil</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">tostring</span>(<span class="number">1000</span>)</span><br><span class="line">b = <span class="string">&#x27;world&#x27;</span></span><br><span class="line">c = <span class="built_in">tonumber</span>(<span class="string">&quot;500&quot;</span>)</span><br><span class="line">d = <span class="built_in">tonumber</span>(<span class="string">&quot;str&quot;</span>) <span class="comment">--å€¼ä¸ºnil</span></span><br><span class="line"><span class="built_in">print</span>(a..b)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="built_in">print</span>(d)</span><br></pre></td></tr></table></figure><p><strong>å˜é‡å‰åŠ  '#' è·å–å­—ç¬¦ä¸²é•¿åº¦</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;hello world&quot;</span></span><br><span class="line"><span class="built_in">print</span>(#a)</span><br></pre></td></tr></table></figure><h2 id="å‡½æ•°">å‡½æ•°</h2><p><strong>å‡½æ•°çš„åŸºæœ¬å½¢å¼</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a,b)</span></span></span><br><span class="line"><span class="built_in">print</span>(a + b)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure><strong>æ²¡æœ‰ä¼ å‚çš„å‚æ•°å€¼ä¸º nil</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a,b,c)</span></span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p><strong>å¯ä»¥ return å¤šä¸ªå€¼ï¼Œå¤šä¸ªå€¼å¯ä»¥é…åˆå¤šé‡èµ‹å€¼è¯­å¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a,b,c)</span></span></span><br><span class="line"><span class="keyword">return</span> a,b,c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(f(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> aa,bb,cc = f(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(aa)</span><br><span class="line"><span class="built_in">print</span>(bb)</span><br><span class="line"><span class="built_in">print</span>(cc)</span><br></pre></td></tr></table></figure><h2 id="table-ç»“æ„">table ç»“æ„</h2><p><strong>table ç±»ä¼¼æ•°ç»„ï¼Œä½†æ˜¯å¯ä»¥å­˜æ•°å­—ã€å­—ç¬¦ä¸²ã€å…¶ä»–tableã€å‡½æ•°åœ¨ä¸€ä¸ª table ä¸­</strong> <strong>table ä¸‹æ ‡ä» 1å¼€å§‹</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p><strong>ä¸‹æ ‡è¶Šç•Œçš„å…ƒç´ ä¸º nil</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">10</span>])</span><br></pre></td></tr></table></figure><p><strong>æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line">tab[<span class="number">10</span>] = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">10</span>])</span><br></pre></td></tr></table></figure><strong>æœ€åæ’å…¥å…ƒç´ </strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(tab,<span class="string">&quot;no.n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">5</span>])</span><br></pre></td></tr></table></figure><strong>æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(tab,<span class="number">3</span>,<span class="string">&quot;no.3&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">3</span>])</span><br></pre></td></tr></table></figure><strong>åˆ é™¤å…ƒç´ </strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>,&#123;&#125;,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(tab,<span class="number">2</span>,<span class="string">&quot;no.2&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> del = <span class="built_in">table</span>.<span class="built_in">remove</span>(tab,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(del)</span><br></pre></td></tr></table></figure> <strong>å­—ç¬¦ä¸²ä½œä¸ºä¸‹æ ‡key</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;</span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">b = <span class="string">&#x27;world&#x27;</span>,</span><br><span class="line">c = <span class="number">100</span>,</span><br><span class="line">d = &#123;&#125;,</span><br><span class="line">e = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tab.a)</span><br><span class="line"><span class="built_in">print</span>(tab.b)</span><br><span class="line"><span class="built_in">print</span>(tab.c)</span><br><span class="line"><span class="built_in">print</span>(tab.d)</span><br><span class="line"><span class="built_in">print</span>(tab.e)</span><br></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šç¬¦å·ä¸‹æ ‡</strong> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tab = &#123;</span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tab[<span class="string">&quot;...&quot;</span>] = <span class="string">&quot;....&quot;</span></span><br><span class="line">tab[<span class="string">&quot;abc&quot;</span>] = <span class="string">&quot;abc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tab[<span class="string">&quot;...&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(tab[<span class="string">&quot;abc&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(tab.abc)</span><br></pre></td></tr></table></figure> å­—ç¬¦ä¸²ä½œä¸ºä¸‹æ ‡å¯ä»¥ä½¿ç”¨<code>tab.abc</code>ï¼Œç‰¹æ®Šç¬¦å·åªèƒ½é€šè¿‡ <code>tab["..."]</code>å½¢å¼æŒ‡å®šä¸‹æ ‡</p><h2 id="åˆ†æ”¯åˆ¤æ–­">åˆ†æ”¯åˆ¤æ–­</h2><p><strong>ä»¥ if å’Œ end ä¸ºä»£ç å—ï¼Œæ”¯æŒ elseif</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">5</span></span><br><span class="line"><span class="keyword">if</span> a==<span class="number">10</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a==10&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> a == <span class="number">9</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a==9&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> a&gt;<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a&gt;5&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> a&lt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a&lt;=5&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>0 ä¸º trueï¼Œnil ä¸º false</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0</span></span><br><span class="line">b = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;0 is true&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;0 is false&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;nil is true&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;nil is false&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="å¾ªç¯">å¾ªç¯</h2><p><strong>èµ·å§‹å€¼ä¸º 0ï¼Œåˆ° 10 ç»“æŸ</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">0</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>èµ·å§‹å€¼ä¸º 10ï¼Œæ­¥é•¿ä¸º -1ï¼Œåˆ° 0 ç»“æŸ</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">0</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>å¾ªç¯ä¸­ i çš„å€¼ä¸èƒ½æ›´æ”¹ï¼ˆå¾ªç¯æ‰€ç”¨çš„å€¼å…¶å®æ˜¯å˜é‡ içš„å€¼æ‹·è´ï¼‰</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">0</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line">i = <span class="number">5</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>break è¯­å¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">0</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">6</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>while è¯­å¥</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="number">10</span></span><br><span class="line"><span class="keyword">while</span> num &gt; <span class="number">5</span> <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(num)</span><br><span class="line">num = num - <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="è¡¥å……">è¡¥å……</h2><p><strong>string.char() æ”¯æŒåè¿›åˆ¶ã€åå…­è¿›åˆ¶ç­‰</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">104</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">0x6C</span>,<span class="number">0x6f</span>) <span class="comment">--&quot;hello&quot;</span></span><br><span class="line"><span class="built_in">print</span>(s)</span><br></pre></td></tr></table></figure><p><strong>string.byte() å–å‡ºç¬¬ n ä½å­—æ¯çš„åè¿›åˆ¶</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">104</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">0x6C</span>,<span class="number">0x6f</span>)</span><br><span class="line">n = <span class="built_in">string</span>.<span class="built_in">byte</span>(s,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(n)</span><br></pre></td></tr></table></figure><p><strong>0x00 åœ¨ lua å­—ç¬¦ä¸²ä¸­ä¸ä¼šå½±å“å­—ç¬¦ä¸²çš„ç»“æŸï¼Œå–å€¼ä¸º0</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">104</span>,<span class="number">101</span>,<span class="number">0x00</span>,<span class="number">108</span>,<span class="number">0x6C</span>,<span class="number">0x6f</span>)</span><br><span class="line">n = <span class="built_in">string</span>.<span class="built_in">byte</span>(s,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(n) <span class="comment">--&quot;0&quot;</span></span><br><span class="line"><span class="built_in">print</span>(#s) <span class="comment">--&quot;6&quot;</span></span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ‰‹å†Œ">å‚è€ƒæ‰‹å†Œ</h1><p><ahref="https://www.runoob.com/manual/lua53doc/contents.html#contents">Lua5.3 å‚è€ƒæ‰‹å†Œ - ç›®å½• (runoob.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> DB </category>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis è„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - AÃ±ejo Highball</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20A%C3%B1ejo%20Highball.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20A%C3%B1ejo%20Highball.html</url>
      
        <content type="html"><![CDATA[<figure><imgsrc="https://assets-prd.punchdrink.com/wp-content/uploads/2022/11/17163411/Article-Anejo-Highball-500x687.jpg"alt="Article-Anejo-Highball-500x687.jpg (500Ã—687) (punchdrink.com)" /><figcaption aria-hidden="true">Article-Anejo-Highball-500x687.jpg(500Ã—687) (punchdrink.com)</figcaption></figure><h1 id="æœ‰å¹´ä»£çš„å—¨æ£’-aÃ±ejo-highball">æœ‰å¹´ä»£çš„å—¨æ£’ AÃ±ejo Highball</h1><p><a href="https://punchdrink.com/recipes/flatliner/">[AÃ±ejo HighballCocktail Recipe | PUNCH(punchdrink.com)](https://punchdrink.com/recipes/anejo-highball/)</a></p><blockquote><p>aÃ±ejo (plural aÃ±ejos) - A tequila or rum which has been aged.</p><p>é™ˆå¹´çš„é¾™èˆŒå…°æˆ–è€…æœ—å§†</p></blockquote><p>åœ¨ 90 å¹´ä»£é£é¡ä¸€æ—¶çš„è‹¹æœå’Œè”æå‘³ â€œtinisâ€ä¸­ï¼Œå‡ºç°äº†ä¸€ç±»æ›´ä¸ºæŸ”å’Œçš„é¸¡å°¾é…’ï¼Œå¯¹ä¸–ç•Œå„åœ°çš„è°ƒé…’æ–¹æ³•äº§ç”Ÿäº†æ·±è¿œçš„å½±å“</p><p>AÃ±ejo Highballå°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œå®ƒä»¥æœ—å§†é…’ã€åº“æ‹‰ç´¢é…’ã€é’æŸ æ±å’Œå§œæ±å•¤é…’çš„ç®€å•ç»„åˆï¼Œå´å‘ˆç°å‡ºç²¾å½©ä¸€è¯¾</p><h2 id="åŸæ–™">åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>é™ˆå¹´æœ—å§† - 1.5 ç›å¸</li><li>åº“æ‹‰ç´¢é…’ - 0.5 ç›å¸ï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/734/pierre-ferrand-dry-curacao">PierreFerrand Dry Curacao</a>ï¼‰</li><li>é’æŸ æ± - 0.25 ç›å¸</li><li>å®‰é«˜å¤©å¨œè‹¦ç²¾ - 2 dashesï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/3505/angostura-orange-bitters">AngosturaOrange Bitters</a>ï¼‰<em>æ²¡æœ‰æŒ‡æ˜ Angosturaå“ªç§è‹¦ç²¾ï¼Œæ„Ÿè§‰æ©™å‘³å¯èƒ½æ€§æ›´å¤§</em></li><li>å§œæ±å•¤é…’ - 2 ç›å¸</li></ul><p><strong>è£…é¥°ï¼š</strong>é’æŸ è½®ï¼Œæ©™å­åˆ‡ç‰‡</p><h2 id="æ­¥éª¤">æ­¥éª¤</h2><ol type="1"><li>åœ¨ç››æ»¡å†°å—çš„æµ·æ³¢æ¯ï¼ˆHighballglassï¼‰ä¸­ï¼ŒåŠ å…¥æœ—å§†é…’ã€åº“æ‹‰ç´¢é…’ã€è±å§†æ±å’Œå®‰é«˜å¤©å¨œè‹¦ç²¾</li><li>é¡¶éƒ¨å€’å…¥å§œæ±å•¤é…’</li><li>ä½¿ç”¨é’æŸ è½®å’Œæ©™å­ç‰‡è¿›è¡Œè£…é¥°</li></ol>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RECIPES - Flatliner</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Flatliner.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/RECIPES%20-%20Flatliner.html</url>
      
        <content type="html"><![CDATA[<p><imgsrc="https://assets-prd.punchdrink.com/wp-content/uploads/2022/12/20113103/Article-Espresso-Martini-Telluride-Flatliner-Recipe-800x450.jpg" /></p><h1 id="å¿ƒè„åœè·³å™¨-flatliner">å¿ƒè„åœè·³å™¨ Flatliner</h1><p><a href="https://punchdrink.com/recipes/flatliner/">FlatlinerEspresso Martini Cocktail Recipe Riff | PUNCH (punchdrink.com)</a></p><p>ä¸èˆ¬æŸ”æ»‘ï¼Œæ³¡æ²«å››æº¢ï¼Œç§‘ç½—æ‹‰å¤šå·ï¼ˆColoradoï¼‰ç‰¹è±ç‘å¾·ï¼ˆTellurideï¼‰çš„éæ­£å¼é…’å•ï¼Œå’Œæ„å¼æµ“ç¼©é©¬å¤©å°¼ï¼ˆEspressoMartiniï¼‰å’Œæ³¥çŸ³æµï¼ˆMudslideï¼‰ç›¸ä¼¼ï¼Œä½†å¯¹äºæ»‘é›ªå°é•‡å±…æ°‘è€Œè¨€ï¼Œå®ƒæ˜¯å½“åœ°çš„ç»å…¸</p><p>å°½ç®¡è°ƒé…’å¸ˆå²è’‚å¤« Â· ç¦æ–¯ç‰¹ï¼ˆSteve Fosterï¼‰èµ·åˆæ˜¯åœ¨ The Peaks Resort&amp; Spa ä¾›åº”è¿™ä¸€é¸¡å°¾é…’ï¼Œä½†é…æ–¹å·²ç»ä¼ éäº†æ•´ä¸ªåŸå¸‚</p><p>å¦‚ä»Šä½ ä¼šåœ¨ New Sheridan Chop House çœ‹åˆ°ç¦æ–¯ç‰¹æ­£åœ¨ shakingFlatliner</p><h2 id="åŸæ–™">åŸæ–™</h2><p><em>Serving: 1</em></p><ul><li>ä¼ç‰¹åŠ  - 1 ç›å¸</li><li>ç”˜éœ²å’–å•¡åˆ©å£é…’ - 1 ç›å¸ï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/248/kahlua-coffee-liqueur">KahlÃºacoffee liqueur</a>ï¼‰</li><li>ç™¾åˆ©ç”œé…’ - 1 ç›å¸ï¼ˆ<ahref="https://www.diffordsguide.com/beer-wine-spirits/526/baileys-irish-cream-liqueur">BaileysIrish cream liqueur</a>ï¼‰</li><li>æ„å¼æµ“ç¼©å’–å•¡ - 1 ä»½ or å†·æ³¡å’–å•¡ - 1 ç›å¸</li></ul><p><strong>è£…é¥°ï¼š</strong> å’–å•¡è±† - 3 ç²’</p><h2 id="æ­¥éª¤">æ­¥éª¤</h2><ol type="1"><li>å°†æ‰€æœ‰åŸæ–™åŠ å…¥è£…æ»¡å†°å—çš„æ‘‡å£¶ï¼Œå¼€å§‹ shake</li><li>æ»¤å…¥è¶å½¢æ¯ï¼ˆCoupe glassï¼‰ï¼Œç„¶åç”¨å’–å•¡è±†ä½œä¸ºè£…é¥°</li></ol>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¸¡å°¾é…’ </tag>
            
            <tag> recipes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç²¾é…¿å•¤é…’å…¥é—¨</title>
      <link href="/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E7%B2%BE%E9%85%BF%E5%95%A4%E9%85%92.html"/>
      <url>/%E4%BA%BA%E7%94%9F/%E5%AE%BF%E9%86%89/%E7%B2%BE%E9%85%BF%E5%95%A4%E9%85%92.html</url>
      
        <content type="html"><![CDATA[<h1 id="ç²¾é…¿">ç²¾é…¿</h1><blockquote><p>åœ¨å…¬å¸çš„æŠ€æœ¯åˆ†äº«å‘¨ä¼šä¸Šè¿›è¡Œåˆ†äº«çš„æ–‡æ¡£</p><p>åªæ˜¯è¿›äº†ç®€å•çš„ä»‹ç»ï¼Œå¹¶ä¸”å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ç®€ç•¥åœ°æè¿°äº†ä¸€ä¸‹</p><p>å¯¹äºä¸äº†è§£ç²¾é…¿çš„æœ‹å‹å¯ä»¥å€Ÿæ­¤äº†è§£ä¸€ä¸‹ Craft Beer</p></blockquote><h2 id="ä»€ä¹ˆæ˜¯-craft-beer">ä»€ä¹ˆæ˜¯ Craft Beer</h2><p><strong>ç¾å›½çš„ç²¾é…¿è¿åŠ¨</strong></p><p>20 ä¸–çºªå¼€å§‹ï¼Œç¾å›½å…ˆåç»å†ä¸€æˆ˜ã€ç¦é…’ä»¤ã€äºŒæˆ˜ï¼Œå¯¼è‡´å•¤é…’è¿…é€Ÿé€€å‡ºå¸‚åœº</p><p>20 ä¸–çºª 70å¹´ä»£ï¼Œå…³äºå®¶é…¿å•¤é…’çš„ä¹¦ç±ä»è‹±å›½æµå‡ºï¼Œä¹¦ä¸­å‘¼åä½¿ç”¨ç³–æµ†ä¹‹ç±»å¥‡ç‰¹çš„åŸæ–™ï¼›å¼—é›·å¾·.åŸƒå…‹å“ˆå¾·ï¼ˆFredEckhardtï¼‰å‡ºç‰ˆäº†ä¸€æœ¬é¢˜ä¸ºã€Šæ‹‰æ ¼å•¤é…’è®ºã€‹çš„ä¹¦ï¼Œè™½æ˜¯è–„è–„ä¸€å†Œï¼Œä½†æŠ€æœ¯ä¸Šæè¿°éå¸¸è¯¦ç»†ã€‚å¯ä»¥æ¯«ä¸å¤¸å¼ çš„è¯´ï¼Œå®¶é…¿æ–¹å¼ä¸ºç²¾é…¿å•¤é…’è¿åŠ¨æä¾›äº†æ€æƒ³ã€æ¿€æƒ…å’Œäººç‰©ï¼Œæ˜¯é‡è¦çš„æºæ³‰</p><p>1976å¹´ï¼Œç¾å›½å¼€å§‹å‡ºç°æœ€æ—©çš„ç²¾é…¿é…’å‚ï¼Œç”Ÿäº§ç“¶ä¸­å‘é…µçš„æ³¢ç‰¹ã€ä¸–æ¶›å’Œæ·¡è‰²è‰¾å°”ä¾›åº”ç»™æ—©å·²ä¹ æƒ¯æ·¡å‘³æ‹‰æ ¼çš„é…’å§</p><p>1978 å¹´ 10 æœˆ 14 å·ï¼Œæ€»ç»Ÿ Jimmy Carter ç­¾ç½²äº† 1337å·è®®æ¡ˆã€‚è¿™ä»½è®®æ¡ˆå°†å®¶åº­é…¿é€ å°é‡è‡ªäº§è‡ªç”¨çš„å•¤é…’æˆ–çº¢é…’åˆæ³•åŒ–ã€‚ä»æ­¤ï¼Œç¾å›½è§è¯äº†é…¿é…’æ–‡åŒ–çš„å¤å…´å’Œå°å‹é…’å‚çš„è“¬å‹ƒå‘å±•ã€‚åˆ°1986 å¹´ 3 æœˆï¼Œ5 å®¶è‡ªé…¿é…’å§åœ¨ç¾å›½è¥ä¸š</p><p>ç¾å›½é…’å‚çš„æ€»æ•°ä» 1978 å¹´çš„ 42 å®¶å˜æˆ 2012 å¹´çš„ 2750å®¶ï¼Œç”šè‡³è¶…è¿‡äº†ç¾å›½æ®–æ°‘åœ°æ—¶ä»£çš„å¤§çº¦æ•°å­—ï¼›å¢é•¿çš„å…¶ä¸­ç»å¤§å¤šæ•°éƒ½æ˜¯å°å‹ç‹¬ç«‹é…’å‚</p><p><strong>ç²¾é…¿çš„ç±»å®˜æ–¹å®šä¹‰</strong></p><p>ç²¾é…¿å¹¶ä¸æ˜¯å•¤é…’çš„æ¦‚å¿µï¼Œè€Œæ˜¯å•¤é…’å‚çš„æ¦‚å¿µ</p><p>ç¾å›½å•¤é…’é…¿é€ å•†åä¼šï¼ˆBrewersAssociationï¼‰å‡ºå°çš„æ ‡å‡†ï¼Œå¯¹ç²¾é…¿é…’å‚çš„å®šä¹‰ä¸ºï¼š<strong>å°å‹</strong>ã€<strong>ç‹¬ç«‹</strong>ã€<strong>ä¼ ç»Ÿ</strong></p><ul><li>å°å‹ï¼šå¹´äº§é‡åœ¨ 600 ä¸‡åŠ 600 ä¸‡æ¡¶ä»¥ä¸‹</li><li>ç‹¬ç«‹ï¼šå…¶äº§æƒä¸èƒ½ä¸ºå…¶å®ƒéç²¾é…¿é…’å‚çš„é…’ç±»ä¼ä¸šè´­ä¹°ï¼Œç®¡ç†æˆ–æ§è‚¡è¶…è¿‡25%</li><li>ä¼ ç»Ÿï¼šè¦ä½¿ç”¨ä¼ ç»Ÿæˆ–åˆ›æ–°çš„åŸææ–™ï¼Œéµå¾ªä¼ ç»Ÿæˆ–åˆ›æ–°çš„é…¿é€ æ–¹æ³•æ¥å®ç°å…¶é…¿é€ å‡ºå•¤é…’çš„å£å‘³</li></ul><blockquote><p>é¹…å²›ï¼š<ahref="https://item.jd.com/100008724119.html">äº¬ä¸œé“¾æ¥</a></p><p>æ‹³å‡»çŒ«ï¼š<a href="http://www.boxingcatbrewery.com/cn/">Boxing CatBrewery</a></p></blockquote><p><strong>å’Œå·¥ä¸šå•¤é…’çš„åŒºåˆ«</strong></p><ul><li>æ›´é«˜çš„åŸæ–™æˆæœ¬</li><li>æ›´ä¸°å¯Œçš„å•¤é…’é£æ ¼</li><li>æ›´å¤šåˆ›æ„</li><li>å•¤é…’ Pub é—¨åº—ï¼Œæä¾›ç®€é¤</li><li>æ›´è‰ºæœ¯çš„ç¾å­¦è®¾è®¡</li><li>æ›´è´µ</li></ul><p><strong>å·¥å‚åº—</strong></p><p>Craft Beerçš„é…’å‚è§„æ¨¡è¾ƒå°ï¼Œä¸ºäº†çªå‡ºç²¾é…¿çš„ç†å¿µå¾€å¾€ä¼šå°†ç”Ÿäº§å·¥å‚å¯¹å¤–å¼€æ”¾ï¼Œå¯ä»¥é¢„çº¦å‚è§‚</p><p>å·¥å‚åº—æ‘’å¼ƒäº†åˆ†çº§æ‰¹å‘å•†ã€åˆ†çº§ä»£ç†ç­‰ä¸­é—´ç¹å†—ç¯èŠ‚å¯ä»¥é™ä½æˆæœ¬</p><p><a href="https://vitaminseabrewing.com/">VSB(vitaminseabrewing.com)</a></p><p><a href="https://treehousebrew.com/">Tree House BrewingCompany</a></p><h2 id="å•¤é…’é£æ ¼">å•¤é…’é£æ ¼</h2><p><strong>BJCP</strong></p><p>å•¤é…’å“é…’å¸ˆèµ„æ ¼è®¤è¯åä¼š(BJCPï¼ŒBeer Judge Certification Program) äº1985 å¹´åˆ›å»ºäºç¾å›½</p><p>å®—æ—¨æ˜¯æ¨å¹¿ä¸ä¼ æ’­å•¤é…’ç›¸å…³çš„å„ç±»çŸ¥è¯†ä¸æ–‡åŒ–ï¼Œæå‡å¤§ä¼—å¯¹å•¤é…’çš„è®¤çŸ¥ã€å“é…’å’Œè¯„ä¼°æ°´å¹³ï¼›åˆ›é€ ä¸€ä¸ªå•¤é…’è¡Œä¸šè§„èŒƒçš„è¯„ä»·ç¨‹åºï¼Œå¼•å¯¼å•¤é…’çˆ±å¥½è€…å¦‚ä½•æ­£ç¡®è¯„ä»·åŠé¥®ç”¨å•¤é…’ï¼Œä¾¿äºå¯¹è¿™äº›é…’ç±»è¿›è¡Œæ’åå’Œè¯„æ¯”</p><p>BJCPå®šæœŸæ¨å‡ºå•¤é…’åˆ†ç±»æŒ‡å—å¯¹å•¤é…’åŠ ä»¥ç§‘å­¦åˆ†ç±»ï¼Œè¯¥æŒ‡å—ä¹Ÿå·²æˆä¸ºä¸–ç•Œå•¤é…’å¸‚åœºçš„é£å‘æ ‡ï¼Œæœ‰åŠ©äºå•¤å‹å“é‰´ã€è‡ªé…¿æ¯”èµ›ç­¹åŠã€é…¿å‹å‚èµ›ã€ç”šè‡³æ–°å•¤é…’é£æ ¼çš„åˆ›æ–°</p><p><ahref="D:\Relax\Beer\BJCPä¸–ç•Œå•¤é…’åˆ†ç±»æŒ‡å—ä¸­æ–‡2015ç‰ˆ.pdf">BJCPä¸–ç•Œå•¤é…’åˆ†ç±»æŒ‡å—ä¸­æ–‡2015ç‰ˆ</a></p><p><a href="https://www.bjcp.org/">Beer Judge Certification Program â€“Promoting beer literacy, recognizing beer tasting and evaluation skills.(bjcp.org)</a></p><p><strong>é”™è¯¯çš„åˆ†ç±»æ–¹å¼</strong></p><p>å•¤é…’ç»å¸¸ä¼šè¢«æŒ‰ç…§é¢œè‰²è¿›è¡Œåˆ†ç±»ï¼Œæ¯”å¦‚é»‘å•¤ã€é»„å•¤ã€ç™½å•¤</p><p>ä½†æ˜¯è¿™ç§åˆ†ç±»æ–¹å¼æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºé£æ ¼å’Œé¢œè‰²æ— å…³ï¼›ä¸€ç§é£æ ¼å¾€å¾€æœ‰ä¸€å®šçš„è‰²åº¦èŒƒå›´ï¼Œä½†å¹¶ä¸å†³å¯¹ï¼Œå¹¶ä¸”è‰²åº¦èŒƒå›´å¯èƒ½ä¹Ÿå¾ˆå¤§ï¼Œæ‰€ä»¥ä¸å¯èƒ½é€šè¿‡é¢œè‰²å»åŒºåˆ†å•¤é…’çš„é£æ ¼</p><p>å•¤é…’çš„è‰²åº¦æ›´å¤šæ¥æºäºé…¿é€ æ—¶æ‰€ç”¨çš„æ·±è‰²éº¦èŠ½æ¯”é‡ï¼Œæƒ³é…¿é€ é»‘è‰²çš„IPAã€æ›´æµ…çš„ä¸–æ¶›ä¹Ÿæœªå°ä¸å¯</p><p><strong>å·¥ä¸šå•¤é…’ä¹Ÿæœ‰é£æ ¼</strong></p><p>å¸¸è¯´çš„å·¥ä¸šå•¤é…’å…¶å®æ˜¯å±äºæ‹‰æ ¼ï¼ˆLagerï¼‰è¿™ä¸ªå¤§åˆ†ç±»ä¸‹</p><blockquote><p>æ‹‰æ ¼æœ¬èº«ä¹Ÿæ˜¯å•¤é…’åˆ†ç±»ä¸­çš„ä¸€ç§åˆ›æ–°ï¼Œæœ¬èº«æ‹‰æ ¼ä¹Ÿæ˜¯è¾ƒéš¾é…¿é€ çš„å•¤é…’ï¼Œå› ä¸ºå®ƒçš„éš¾ç‚¹åœ¨äºä½æ¸©ã€‚æœ€æ—©åªæœ‰åœ¨å¾·å›½åŒ—éƒ¨ä¸€äº›åå†·åœ°åŒºå°†å•¤é…’æ”¾åœ¨å†°å†·çš„å±±æ´é‡Œçª–è—æ‰å½¢æˆäº†è¿™ç§é£æ ¼ï¼ˆLageråœ¨å¾·è¯­é‡Œæ˜¯çª–è—çš„æ„æ€ï¼‰</p></blockquote><p>é‚£ä¹ˆæ‹‰æ ¼å•¤é…’é£é¡ä¸–ç•Œçš„åŸå› ï¼š</p><ul><li>å£å‘³æ¸…æ·¡ï¼Œæ›´æ¸…çˆ½</li><li>ä»·æ ¼ä¾¿å®œ</li><li>åº¦æ•°è¾ƒä½ï¼Œç¤¾äº¤å±æ€§</li><li>å‘é…µéš¾åº¦å°äºè‰¾å°”å•¤é…’</li><li>æ›´å®¹æ˜“å·¥ä¸šç”Ÿäº§</li><li>é£æ ¼ç¨³å®š</li><li>ä¸»æµå›½å®¶çš„æ¨åŠ¨ï¼Œå…ˆå…¥ä¸ºä¸»</li></ul><p><strong>è‰¾å°”å’Œæ‹‰æ ¼</strong></p><p>è‰¾å°”ï¼ˆAleï¼‰å’Œæ‹‰æ ¼ï¼ˆLagerï¼‰æœ€åˆæŒ‡çš„æ˜¯ä¸åŒçš„é…µæ¯ç±»å‹ï¼Œè€Œé…µæ¯ç±»å‹èƒ½å¸¦æ¥ä¸åŒçš„é£å‘³</p><p><strong>è‰¾å°”</strong>é…µæ¯éœ€è¦æ›´é«˜çš„æ¸©åº¦ï¼ˆ15â„ƒ~25â„ƒï¼‰ï¼Œå‘é…µè¿‡ç¨‹ä¸­äº§ç”Ÿæ›´å¤šçš„ä»£è°¢ç‰©è´¨ï¼Œå…¶ä¸­åŒ…æ‹¬ç»™å•¤é…’æä¾›å¤æ‚é¦™æ°”çš„é…¯ç±»ã€é…šç±»ã€é†›ç±»ç­‰é£å‘³çš„ç‰©è´¨ï¼Œä¹ŸåŒ…æ‹¬ä¸å¥½çš„ç‰©è´¨å¦‚åŒä¹™é…°ç­‰ï¼›å‘é…µæ—¶ä¼šäº§ç”Ÿæ›´å¤šçš„çƒ­é‡</p><p><strong>æ‹‰æ ¼</strong>é…µæ¯éœ€è¦æ¸©åº¦æ›´ä½ï¼ˆ4â„ƒ~12â„ƒï¼‰ï¼Œå‘é…µæ›´åŠ å½»åº•ï¼Œä»£è°¢äº§ç‰©è¾ƒå°‘ï¼Œå‘³é“æ›´åŠ æ¸…å†½ï¼Œå¹²å‡€ï¼Œçˆ½å£</p><figure><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252037761.jpg"alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><p><strong>ç¾å¼é£æ ¼</strong></p><p>ç²¾é…¿è¿åŠ¨å‘èµ·äºç¾å›½ï¼Œæ‰€ä»¥å¦‚ä»Šçš„å•¤é…’é£æ ¼ä¸­ç»å¸¸èƒ½çœ‹åˆ°ä»¥ Americanå¼€å¤´çš„é£æ ¼åç§°</p><p>ç¾å¼é£æ ¼å’Œä¼ ç»Ÿé£æ ¼ï¼ˆPale Ale å’Œ American Pale Aleã€Lager å’Œ AmericanLagerï¼‰æœ€å¤§çš„åŒºåˆ«åœ¨äºä½¿ç”¨<strong>ç¾å¼é…’èŠ±</strong>æ›¿ä»£<strong>ä¼ ç»Ÿé…’èŠ±</strong>ï¼ŒåŸºäºæ­¤å•¤é…’é£æ ¼ä¹Ÿç»å¸¸è¢«åˆ†ç±»ä¸ºæ¬§å¼å’Œç¾å¼ä¸¤å¤§ç±»ï¼ˆå¹¶ä¸ä¸¥è°¨ï¼‰</p><p>ç¾å¼é…’èŠ±ä¹Ÿè¢«ç§°ä¸ºæ–°ä¸–ç•Œé…’èŠ±ï¼Œä¼ ç»Ÿçš„æ¬§æ´²é…’èŠ±æ›´å€¾å‘äºæä¾›è‹¦åº¦ã€è¾›è¾£å’Œè‰æœ¬é£å‘³ï¼Œç¾å¼é…’èŠ±æ›´å€¾å‘äºæä¾›é¦™å‘³ã€æŸ‘æ©˜ç±»ã€ç“œæœã€çƒ­å¸¦æ°´æœç­‰å‘³é“</p><blockquote><p>å¡æ–¯å¡ç‰¹ 1972 å¹´å•†å“åŒ–</p><p>è¥¿æ¥š 2008 å¹´å•†å“åŒ–</p><p>é‡‘ç‰Œ 1790 å¹´å•†å“åŒ–</p></blockquote><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/image-20220315235328107.png" alt="image-20220315235328107" style="zoom: 67%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252038370.png" alt="image-20220315235403042" style="zoom:67%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252038169.png" alt="image-20220315235344666" style="zoom: 67%;" /></p><p><strong>ä¸¾ä¸€äº›æœ‰ç‰¹ç‚¹çš„é£æ ¼</strong></p><p>ï¼ˆä¸‹é¢çš„é£æ ¼åç§°å¹¶ä¸ä¸¥è°¨ï¼Œæ›´å¤šçš„æ˜¯å•†ä¸šåŒ–é£æ ¼çš„å«æ³•ï¼‰</p><ul><li><strong>å°åº¦æ·¡è‰²è‰¾å°”ï¼ˆIPAï¼‰</strong>ï¼šæ›´å¤šçš„å•¤é…’èŠ±å¸¦æ¥æ›´é«˜çš„è‹¦åº¦ä»¥åŠæ›´å¤šçš„é£å‘³<ahref="https://item.jd.com/100011983501.html">åŒ—å¹³æœºå™¨ç™¾èŠ±æ·±å¤„IPA</a></li><li><strong>å¤æ–¯ï¼ˆGoseï¼‰</strong>ï¼šä¹³é…¸ã€ç›æ°´ã€é¦™æ–™ <ahref="https://item.jd.com/10030440794661.html">ç‰›å•¤å ‚å¸éƒ½æµ·ç›</a></li><li><strong>å…°æ¯”å…‹ï¼ˆLambicsï¼‰</strong>ï¼šé‡èŒå‘é…µï¼Œæ›´é…¸ï¼Œå˜ä½“æ˜¯æ°´æœå…°æ¯”å…‹å’Œæ³•æŸ”<a href="https://item.jd.com/7907410.html">æ—å¾·æ›¼</a></li><li><strong>ç‰›å¥¶ä¸–æ¶›ï¼ˆMilkStoutï¼‰</strong>ï¼šåŠ äº†ä¹³ç³–çš„ä¸–æ¶›ï¼Œå¾€å¾€è¿½æ±‚æ›´é«˜çš„ç³Šç²¾æ¯”é‡ <ahref="https://item.jd.com/100012559742.html">æ‰“å—æµ·ç‹¸èŠ±ç”Ÿç‰›å¥¶ä¸–æ¶›</a></li><li><strong>å°éº¦å•¤é…’ï¼ˆWheatï¼‰</strong>ï¼šå°éº¦ä½œä¸ºé‡è¦åŸæ–™ï¼Œæœ‰ä¸€å®šé…¸åº¦<ul><li><strong>å¾·å¼å°éº¦</strong>ï¼šåŸæ–™å•ä¸€ï¼ˆ1516 å¹´ã€Šå¾·å›½çº¯å‡€å•¤é…’æ³•ã€‹ï¼‰ <ahref="https://item.jd.com/100018726016.html">æµ·åº•æå¾·å¼å°éº¦</a></li><li><strong>æ¯”åˆ©æ—¶å°éº¦</strong>ï¼šé¦™æ–™çš„åŠ å…¥ï¼Œç”œæ©™çš®ã€èŠ«è½ç±½ <ahref="https://item.jd.com/100020388832.html">1664ç™½å•¤</a></li></ul></li><li><strong>è¥¿æ‰“ï¼ˆCiderï¼‰</strong>ï¼šè‹¹æœé…’ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ°´æœï¼‰ï¼Œæ›´å¤šçš„æ®‹ç³–<a href="https://item.jd.com/53259108790.html">è¯±æƒ‘ï¼ˆTEMPTï¼‰7å·</a></li><li><strong>ä¿®é“é™¢ï¼ˆTrappist &amp;Abbeyï¼‰</strong>ï¼šæ¯”åˆ©æ—¶å•¤é…’ï¼Œç”±ä¿®é“é™¢ï¼ˆTrappistï¼‰æˆ–ä¿®é“é™¢æˆæƒï¼ˆAbbeyï¼‰é…¿é€ ï¼Œæ”¶å…¥ç”¨äºæ…ˆå–„æˆ–ç¤¾åŒºæœåŠ¡ï¼Œå…¨çƒå…±æœ‰11å®¶ä¿®é“é™¢é…’å‚ï¼›ä¼ ç»Ÿã€é«˜é…’ç²¾åº¦ã€åšé‡ã€ç„¦ç³–ï¼Œè¾…æ–™å¤§å¤šæ•°åŠ å…¥äº†æ¯”åˆ©æ—¶æ£•ç³–<ahref="https://item.jd.com/3306054.html">ç½—æ–¯ç¦ï¼ˆRochefortï¼‰10å·</a></li></ul><p><strong>æ›´å¤šåˆ›æ„</strong></p><p>ç²¾é…¿è¿åŠ¨é™¤äº†å¤åˆ»å†å²ä¸Šçš„ä¼ ç»Ÿå•¤é…’é£æ ¼ï¼ˆIPA - 18 ä¸–çºªã€å¤æ–¯ - 16ä¸–çºªï¼‰ï¼Œä¹Ÿå¸¦æ¥äº†æ›´å¤šé£æ ¼åˆ›æ„çš„æ¢ç´¢</p><ul><li><strong>é¦™æ§ŸIPAï¼ˆBrut IPAï¼‰</strong>ï¼š2017å¹´é¦–åˆ›ï¼Œä½¿ç”¨è‘¡è„ç³–æ·€ç²‰é…¶ï¼Œæ›´ä½çš„è‹¦å‘³ï¼Œæ›´ä½çš„æ®‹ç³–æ„å‘³ç€æ›´å¹²çš„å£æ„Ÿ</li><li><strong>é…’èŠ±å¹²æŠ•ï¼ˆDryHopï¼‰</strong>ï¼šä¸€ç§é…’èŠ±æ·»åŠ æ–¹å¼ï¼Œé€‚ç”¨äºå„ç§çªå‡ºé…’èŠ±é£å‘³ç±»çš„é£æ ¼ï¼Œå•¤é…’èŠ±ä¸å‚ä¸ç…®æ²¸å’Œæ—‹æ²‰é˜¶æ®µï¼Œè€Œåœ¨å†·å´ã€å‘é…µè¿‡ç¨‹ä¸­åŠ å…¥å•¤é…’èŠ±ï¼Œç›®çš„æ˜¯é™ä½è‹¦åº¦å¢åŠ é¦™å‘³</li><li><strong>ç‡•éº¦ä¸–æ¶›ï¼ˆOatmealStoutï¼‰</strong>ï¼šæ·»åŠ ç‡•éº¦ï¼Œè¿½æ±‚æ›´é‡çš„é…’ä½“</li><li><strong>é…’èŠ±æ‹‰æ ¼ï¼ˆHoppyLagerï¼‰</strong>ï¼šæ–°æ—¶ä»£é£æ ¼ï¼Œåœ¨ä¼ ç»Ÿæ‹‰æ ¼é£æ ¼ä¸‹åŠ å…¥å¤§é‡æ–°ä¸–ç•Œé…’èŠ±ï¼Œæ‹‰æ ¼çš„å£æ„Ÿå’Œæ›´å¤šçš„é…’èŠ±é¦™å‘³å’Œè‹¦åº¦</li><li><strong>æ°´æœå•¤é…’ï¼ˆFruitBeerï¼‰</strong>ï¼šé…¿é€ è¿‡ç¨‹ä¸­åŠ å…¥æ°´æœç”šè‡³æœæ³¥ï¼ˆæˆ‘è§‰å¾—å¾ˆéš¾å–ï¼‰</li></ul><h2 id="å¿«ç‚¹å¼€å–">å¿«ç‚¹å¼€å–</h2><p><strong>å•¤é…’çš„å±æ€§</strong></p><figure><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252038639.png"alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><p>å•¤é…’çš„é…’æ ‡ä¸Šæ ‡æ³¨äº†è¿™ç“¶å•¤é…’çš„åŸºæœ¬ä¿¡æ¯</p><ul><li>é…’å‚ï¼ˆBrandï¼‰ï¼šBrew Dog</li><li>åç§°ï¼ˆNameï¼‰ï¼šLayer Cake</li><li>é£æ ¼ï¼ˆStyleï¼‰ï¼šMarshmallow &amp; Chocolate Stout æ£‰èŠ±ç³– &amp;å·§å…‹åŠ›ä¸–æ¶›ï¼ˆé…’å‚è‡ªå·±å®šä¹‰çš„é£æ ¼ï¼‰</li><li>é…’ç²¾åº¦ï¼ˆABVï¼‰ï¼š7%</li><li>å®¹é‡ï¼ˆvolumeï¼‰ï¼š440 ml</li></ul><p>é™¤æ­¤ä¹‹å¤–å•¤é…’çš„ä¿¡æ¯</p><ul><li><p>è‹¦åº¦ï¼ˆIBUï¼‰ï¼šä¸åŒçš„é£æ ¼è‹¦åº¦å·®å¼‚ä¼šå¾ˆå¤§ï¼ŒIPAï¼ˆ40 ~100ï¼‰ã€è‹±å¼è‹¦å•¤ï¼ˆ30 ~ 70ï¼‰ã€æ·å…‹æ‹‰æ ¼ï¼ˆ20 ~ 40ï¼‰ã€è¥¿æ‰“é…’ï¼ˆ5 ~20ï¼‰</p></li><li><p>å•¤é…’è‰²åº¦ï¼ˆEBCï¼‰ï¼šå•¤é…’è‰²åº¦ï¼Œç™½ -&gt; é»„ -&gt; æ£• -&gt; é»‘</p></li><li><p>ç»ˆäº†æ¯”é‡ï¼ˆFGï¼‰ï¼šæ•°å€¼è¶Šå¤§æ„å‘³ç€è¶Šé«˜çš„æ®‹ç³–ï¼Œä¹Ÿå¯èƒ½æœ‰æ›´åšé‡çš„é…’ä½“</p></li><li><p>äºŒæ¬¡å‘é…µæ–¹å¼ï¼šç“¶ä¸­äºŒå‘ï¼Œè¿˜æ˜¯åªæœ‰ä¸€å‘åæ‰“å…¥äºŒæ°§åŒ–ç¢³è£…ç“¶</p></li><li><p>ç½è£…æ€èŒæ–¹å¼ï¼šå›½äº§å•¤é…’ï¼Œç”Ÿå•¤ã€çº¯ç”Ÿ</p></li><li><p>å…¶ä»–æ“ä½œï¼šåŸæµ†ã€ä¸€ç•ªæ¦¨</p></li></ul><p><strong>ä¸€äº›åè¯</strong></p><ul><li>å¹² &amp; ç”œï¼šå¹²æŒ‡çš„æ˜¯æ›´å°‘çš„æ®‹ç³–ï¼Œç”œåˆ™ç›¸åï¼ˆå¹²çº¢ã€åŠå¹²ã€ç”œçº¢ï¼‰</li><li>è½» &amp;é‡ï¼šé…’ä½“ä¸­ç³Šç²¾ã€è›‹ç™½è´¨çš„å«é‡ï¼Œæ›´é‡çš„é…’ä½“æ„å‘³ç€æ›´åšçš„å£æ„Ÿ</li><li>æ³¡æ²«ï¼šä¸€æ–¹é¢æ¥è‡ªäºŒæ°§åŒ–ç¢³çš„å«é‡ï¼Œä¸€èˆ¬è€Œè¨€è¶Šæ¸…çˆ½çš„é£æ ¼è¶Šè¿½æ±‚æ›´å¤šçš„äºŒæ°§åŒ–ç¢³ï¼›å¦ä¸€æ–¹é¢æ›´é‡çš„é…’ä½“æ›´èƒ½äº§ç”Ÿæ›´ç»µå¯†çš„æ³¡æ²«</li></ul><p><strong>é€‚é¥®æ¸©åº¦</strong></p><p>ä¸€å®šè¦å†°é•‡</p><p>è‰¾å°”ç±»å¯ä»¥æ¯”æ‹‰æ ¼ç±»æ¸©åº¦ç¨é«˜ï¼Œæœ‰åŠ©äºé£å‘³çš„æ•£å‘ï¼Œä½†è‚¯å®šè¦è¿œè¿œä½äºå®¤æ¸©ï¼ˆæ²¡æœ‰æš–æ°”çš„å†¬å¤©é™¤å¤–ï¼‰</p><p><strong>é…é¤</strong></p><p>å•¤é…’æœ¬èº«å°±æ˜¯å¤§ä¼—çš„é…’ç§ï¼Œå–å•¤é…’çš„æ—¶å€™æ­é…é«˜çƒ­é‡çš„ç®€é¤æ„Ÿè§‰å°±æ›´çˆ½äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå•¤é…’å§å¾€å¾€éƒ½æä¾›ç®€é¤ï¼›ä¹Ÿå¯ä»¥æ­é…ç”œå“</p><p><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039603.png" /></p><p><a href="https://www.brewdog.com/uk/bar_pages/bar/locator">BarLocator (brewdog.com)</a></p><h1 id="é…¿é€ ">é…¿é€ </h1><h2 id="è®¾å¤‡">è®¾å¤‡</h2><p>é…¿é€ å•¤é…’çš„æœ¬è´¨å°±æ˜¯ç²‰ç¢éº¦èŠ½ã€ç³–åŒ–éº¦èŠ½ã€ç…®æ²¸éº¦æ±ã€å†·å´éº¦æ±ã€å‘é…µéº¦æ±</p><p><strong>ç²‰ç¢éº¦èŠ½</strong>éœ€è¦ç”¨åˆ°<strong>ç²‰ç¢æœº</strong>ï¼Œä¸€èˆ¬ä½¿ç”¨å¯¹ç¢¾ç»“æ„ï¼Œå› ä¸ºæœ€å¥½çš„ç²‰ç¢ç¨‹åº¦æ˜¯æŒ¤å‡ºéº¦èƒšä½†ä¿ç•™éº¸çš®ï¼Œå› ä¸ºéº¸çš®åœ¨åç»­æµç¨‹ä¸­å¯ä»¥å¯¹éº¦æ±è¿›è¡Œè¿‡æ»¤ï¼Œå‡å°‘è›‹ç™½è´¨ç­‰ç‰©è´¨ï¼Œä½¿é…’ä½“æ›´æ¸…æ¾ˆã€æ›´ç¨³å®š</p><p><strong>ç³–åŒ–éº¦èŠ½</strong>éœ€è¦<strong>ä¿æ¸©æ¡¶</strong>ï¼Œå› ä¸ºéœ€è¦ä¸€å®šçš„æ¸©åº¦ï¼ˆ65â„ƒå·¦å³ï¼‰è®©éº¦èŠ½å†…çš„é…¶è¿›è¡Œå·¥ä½œï¼Œåˆ†è§£æ·€ç²‰ä¸ºéº¦èŠ½ç³–ã€ç³Šç²¾ä»¥åŠå…¶ä»–äº§ç‰©ï¼Œéº¦èŠ½ç³–å°±æ˜¯é…’ç²¾çš„æ¥æº</p><p><strong>ç…®æ²¸éº¦æ±</strong>éœ€è¦<strong>ç…®æ²¸æ¡¶</strong>ï¼Œä¿æŒé«˜æ¸©ç…®æ²¸ï¼Œè®©å¼‚å‘³ç‰©è´¨è’¸å‘ï¼ˆäºŒç”²åŸºç¡«é†šï¼‰ï¼Œä»¥åŠæŠ•æ”¾é…’èŠ±ã€è¾…æ–™é€šè¿‡ç…®æ²¸æ¥èƒå–é£å‘³ï¼Œè¿˜æœ‰æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯æ€èŒ</p><p><strong>å†·å´éº¦æ±</strong>éœ€è¦ç”¨åˆ°<strong>å†·å´ç›˜ç®¡</strong>ï¼Œæ›´é«˜çº§çš„è®¾å¤‡å¯ä»¥ä½¿ç”¨<strong>æ¢çƒ­å™¨</strong>ä»¥åŠ<strong>å†·æ°´æœº</strong>ï¼Œç›®çš„æ˜¯è®©éº¦æ±å°½å¯èƒ½å¿«é€Ÿåœ°å†·å´åˆ°é€‚å®œæŠ•æ”¾é…µæ¯çš„æ¸©åº¦ï¼Œå‡å°‘æ°§åŒ–</p><p><strong>å‘é…µéº¦æ±</strong>éœ€è¦ç”¨åˆ°<strong>å‘é…µæ¡¶</strong>ï¼Œå¯†é—­ã€èƒ½å¤Ÿå®‰è£…<strong>å•å‘é˜€</strong>ï¼ˆå‘é…µè¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿå¤§é‡çš„çƒ­å’ŒäºŒæ°§åŒ–ç¢³éœ€è¦æ’å‡ºï¼‰</p><h2 id="åŸæ–™">åŸæ–™</h2><p><strong>åŸºæœ¬åŸæ–™</strong></p><p>å•¤é…’çš„å››å¤§åŸæ–™ï¼š</p><ul><li>éº¦èŠ½ï¼šå¤§éº¦éº¦èŠ½ï¼ŒæŸäº›é£æ ¼å¯èƒ½ä¼šä½¿ç”¨å°éº¦éº¦èŠ½</li><li>å•¤é…’èŠ±ï¼šè›‡éº»ç§‘æ¤ç‰©ï¼Œæœ€æ—©æ˜¯ç”¨æ¥ä¿é²œï¼Œç°åœ¨ç”¨æ¥èµ‹äºˆå•¤é…’é¦™å‘³å’Œè‹¦å‘³</li><li>é…µæ¯ï¼šå„ç§é…µæ¯ï¼Œä½†æ€»ä½“åˆ†ä¸ºè‰¾å°”å’Œæ‹‰æ ¼ä¸¤ç±»ï¼Œé…µæ¯ç”Ÿäº§å‚å®¶ä¼šæœ‰é’ˆå¯¹æ­¤ç±»é…µæ¯çš„è¯¦ç»†å‚æ•°<ahref="http://wxtest.seastad.com/fermentation-solutions/you-create-beer/you-create-beer.html?id=1">é…¿å•¤é…’çš„ä½ â€¢ Fermentis (seastad.com)</a></li><li>æ°´ï¼šè¿™ä¸ªå°±ä¸è§£é‡Šäº†</li></ul><p><strong>å„ç§è¾…æ–™</strong></p><p>é™¤äº†æœ€åŸºæœ¬çš„åŸæ–™ï¼Œå•¤é…’ä¸­å¾€å¾€è¿˜åŠ å…¥ä¸åŒçš„è¾…æ–™ï¼Œæœ‰çš„å¯èƒ½æ˜¯å› ä¸ºé£æ ¼éœ€è¦ï¼Œä¹Ÿæœ‰çš„å¯èƒ½æ˜¯é…¿é€ è€…çš„åˆ›æ„</p><p>æ¯”å¦‚ï¼š</p><ul><li>æ¯”åˆ©æ—¶å°éº¦éœ€è¦åŠ å…¥ç”œæ©™çš®å’ŒèŠ«è½ç±½</li><li>æ¯”åˆ©æ—¶ä¿®é“é™¢å•¤é…’éœ€è¦åŠ å…¥æ£•ç³–</li><li>ç‰›å¥¶ä¸–æ¶›éœ€è¦åŠ å…¥ä¹³ç³–</li><li>ç‡•éº¦ä¸–æ¶›éœ€è¦åŠ å…¥ç‡•éº¦</li><li>çƒŸç†å•¤é…’éœ€è¦åŠ å…¥çƒŸç†æœ¨</li><li>èœ‚èœœé…’éœ€è¦åŠ å…¥èœ‚èœœ</li><li>ä»¥åŠå„ç§åˆ›æ„åŠ å…¥èŠ±æ¤’ï¼ˆ<ahref="https://item.jd.com/10028156058690.html">å•¤ä¼‘é…¿é€ èŠ±æ¤’ç”Ÿå§œé£å‘³</a>ï¼‰ã€èŠ±èŒ¶ï¼ˆ<ahref="https://item.jd.com/69394013613.html">é«˜å¤§å¸ˆ</a>ï¼‰ã€æœæ±ã€é¦™è‰ç­‰ç­‰</li></ul><figure><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039419.png"alt="image-20220316014349585" /><figcaption aria-hidden="true">image-20220316014349585</figcaption></figure><p><strong>éº¦èŠ½çš„ç§ç±»</strong></p><p>é…¿é€ ç”¨çš„éº¦èŠ½é€šå¸¸ç§°ä¸ºåŸºç¡€éº¦èŠ½å’Œç‰¹ç§éº¦èŠ½ï¼ŒåŸºç¡€éº¦èŠ½æ˜¯éº¦æ±ä¸­éº¦èŠ½ç³–çš„ä¸»ä½“å’ŒåŸºæœ¬ç‰¹å¾ï¼Œè€Œç‰¹ç§éº¦èŠ½ä¸»è¦å¸¦æ¥æ›´å¤šçš„é£å‘³å’Œè‰²åº¦</p><figure><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039668.png"alt="image-20220316014132216" /><figcaption aria-hidden="true">image-20220316014132216</figcaption></figure><p>æ¯”å¦‚å¾ˆå¤šåç§°ä¸­å¸¦æœ‰ â€œå·§å…‹åŠ›â€çš„å•¤é…’ï¼Œå¯èƒ½å¹¶ä¸æ˜¯æ·»åŠ äº†å·§å…‹åŠ›ï¼Œè€Œæ˜¯ç‰¹ç§éº¦èŠ½å¸¦æ¥çš„å·§å…‹åŠ›é£å‘³</p><p><strong>å•¤é…’èŠ±çš„ç§ç±»</strong></p><p>å•¤é…’èŠ±çš„é¦™å‘³æ¥è‡ªäºæ¤ç‰©ä¸­æ‰€åŒ…å«çš„Î±â€”é…¸ã€Î²â€”é…¸å’Œé¦™ç²¾æ²¹ï¼ŒÎ±â€”é…¸å’ŒÎ²â€”é…¸ç»è¿‡é«˜æ¸©åä¼šæˆä¸ºå•¤é…’ä¸­çš„è‹¦å‘³ç‰©è´¨ï¼Œä½†ç»è¿‡é«˜æ¸©å¼‚æ„åæ‰èƒ½æ›´å¤šæº¶äºæ°´ï¼Œå¸¦æ¥å•¤é…’èŠ±çš„é¦™å‘³ï¼Œæ‰€ä»¥å•¤é…’èŠ±å¾€å¾€æ˜¯è‹¦å‘³å’Œé¦™å‘³å¹¶å­˜</p><p>å¹²æŠ•çš„æ–¹å¼å¯ä»¥é¿å…å•¤é…’èŠ±çš„è‹¦å‘³è¿›å…¥å•¤é…’ï¼Œä½†ä¹Ÿå‡å°‘äº†é¦™å‘³ï¼Œæ‰€ä»¥å¹²æŠ•å¾€å¾€éœ€è¦æ›´å¤§é‡çš„å•¤é…’èŠ±</p><p>å•¤é…’èŠ±æœ‰ä¸åŒçš„å“ç§ï¼Œåœ¨ç…®æ²¸è¿‡ç¨‹ä¸­ä¸åŒçš„æ—¶é—´æŠ•å…¥ç…®æ²¸æ¡¶ï¼Œæ¥è¾¾åˆ°å¢åŠ è‹¦å‘³å’Œé¦™å‘³çš„ç›®çš„</p><figure><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039251.png"alt="image-20220316015005883" /><figcaption aria-hidden="true">image-20220316015005883</figcaption></figure><p><strong>å•ä¸€é…’èŠ±</strong></p><p>æœ‰çš„é…’æ¬¾ä¼šæ ‡æ³¨è‡ªå·±æ˜¯<strong>å•ä¸€é…’èŠ±ï¼ˆSingle-Hoppedï¼‰</strong>ï¼Œæ„æ€æ˜¯æ‰€ä½¿ç”¨çš„åŸæ–™é‡ŒåªåŒ…å«ä¸€ç§å“ç§çš„å•¤é…’èŠ±</p><p>ä¸€èˆ¬æ‰€ä½¿ç”¨çš„é…’èŠ±æ˜¯æœ€æ–°åŸ¹è‚²å‡ºçš„ã€é£å‘³æ›´ç‹¬ç‰¹çš„æ–°å“ç§ï¼Œèƒ½å¤Ÿæ›´å¥½çš„æ„ŸçŸ¥åˆ°è¿™ç§é…’èŠ±çš„é£å‘³</p><figure><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039769.png"alt="image-20220316015127042" /><figcaption aria-hidden="true">image-20220316015127042</figcaption></figure><h2 id="æµç¨‹">æµç¨‹</h2><ul><li><p>ç¬¬ä¸€æ¬¡å‘é…µï¼ˆ2 å‘¨ï¼‰</p><ul><li><p>ç²‰ç¢éº¦èŠ½</p></li><li><p>ç³–åŒ–</p></li><li><p>æ´—ç³Ÿ</p></li><li><p>ç…®æ²¸</p></li><li><p>æ·»åŠ è¾…æ–™ã€é…’èŠ±</p></li><li><p>å†·å´</p></li><li><p>æµ‹ç³–ï¼ˆåˆå§‹æ¯”é‡ï¼‰</p></li><li><p>è£…å‘é…µæ¡¶</p></li><li><p>æŠ•æ”¾é…µæ¯</p></li><li><p>æ¶²å°</p></li></ul></li><li><p>ç¬¬äºŒæ¬¡å‘é…µï¼ˆè‡³å°‘ 2 å‘¨ï¼‰</p><ul><li><p>æµ‹ç³–ï¼ˆç»ˆäº†æ¯”é‡ï¼‰</p></li><li><p>é…ç½®äºŒå‘ç”¨ç³–</p></li><li><p>è£…ç“¶</p></li><li><p>å†·è—</p></li></ul></li></ul><p>ä»ç…®æ²¸åçš„æ•´ä¸ªæµç¨‹éƒ½éœ€è¦å¯¹å™¨æè¿›è¡Œæ¶ˆæ¯’ï¼Œç‰¹åˆ«æ˜¯å‘é…µæ¡¶ä»¥åŠç®¡é“ï¼Œå¦‚æœè¿™æ¡¶é…’è¢«æ‚èŒæ±¡æŸ“ï¼Œå°±è¯¥æ‰”äº†</p><p><a href="https://www.youtube.com/watch?v=Wxo9PHc3jNw">How to MakeBeer, the Animation. - YouTube</a></p><h2 id="å·¥å…·">å·¥å…·</h2><p><strong>è¯„åˆ†ç½‘ç«™</strong></p><p><a href="https://untappd.com/">Untappd â€“ Drink Socially â€“ Free iOSand Android App</a></p><p><a href="https://www.jiuhuar.com/">ç²¾é…¿å•¤é…’å’Œå•¤é…’ä¸–ç•Œ-é…’èŠ±å„¿(jiuhuar.com)</a></p><p><strong>é…æ–¹æ¨¡æ‹Ÿ</strong></p><p><a href="https://web.brewfather.app/tabs/tools">Brewfather</a></p><h2 id="è¿˜æœ‰">è¿˜æœ‰</h2><p><strong>æ˜¯å¦å®‰å…¨</strong></p><p>æ–°é—»ç»å¸¸æŠ¥é“å–å‡é…’ç”²é†‡ä¸­æ¯’çš„æ¡ˆä¾‹</p><p>å®¶é…¿å•¤é…’ä»å·¥è‰ºåˆ°è®¾å¤‡è‚¯å®šæ— æ³•å’Œé…’å‚ç›¸æ¯”ï¼Œç¡®å®ç›¸å¯¹åº”çš„å¼‚å‘³ç‰©è´¨å’Œä¸å¥½çš„äº§ç‰©ï¼ˆç”²é†‡ç­‰ï¼‰ä¼šæ›´å¤š</p><p>ä½†å•¤é…’å±äºé…¿é€ é…’ï¼Œé…¿é€ é…’æ‰€äº§ç”Ÿçš„é…’ç²¾åº¦å°±æ˜¯æ¯”è¾ƒä½çš„ï¼Œæ‰€ä»¥å…¶ä»–ä»£è°¢äº§ç‰©ä¼šæ›´å°‘ï¼Œç”²é†‡ä¸­æ¯’å¾€å¾€æ¥è‡ªäºè’¸é¦é…’ç±»ï¼Œæœ¬èº«çš„ç”²é†‡æµ“åº¦ä¼šåœ¨è’¸é¦åå˜å¾—å¾ˆé«˜ä»è€Œè¶…è¿‡é˜ˆå€¼ï¼›å…¶æ¬¡ç”²é†›çš„ä¸»è¦æ¥æºæ˜¯æœèƒ¶ï¼Œå¯¹äºå•¤é…’æ¥è¯´åŸæ–™é‡Œæœèƒ¶çš„æ¥æºéå¸¸å°‘</p><p>æ‰€ä½¿ç”¨çš„é…µæ¯å¾€å¾€ä¹Ÿæ˜¯ç”Ÿç‰©å…¬å¸ç ”åˆ¶çš„äº§å“ï¼Œæ‰€å¸¦æ¥çš„è´Ÿé¢ä»£è°¢äº§ç‰©ä¼šæ›´å°‘</p><p>é£Ÿå“æ£€æµ‹ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œå•¤é…’ç›¸å…³ç‰©è´¨æ£€æµ‹çš„ä»·æ ¼åœ¨ 200 å…ƒå·¦å³</p><p><strong>å¤§å¸ˆæ¯</strong></p><blockquote><p>2012å¹´ï¼Œä¸­å›½ç¬¬ä¸€æ‰¹å®¶é…¿çˆ±å¥½è€…å’Œå•¤é…’å‘çƒ§å‹å¼€å§‹æˆç«‹ç¤¾å›¢ã€åä¼šï¼Œç»„ç»‡å„ç§äº¤æµæ´»åŠ¨ã€‚2012å¹´ 8æœˆï¼Œç¬¬ä¸€æœ¬ä¸­æ–‡å•¤é…’å®¶é…¿ä¹¦ã€Šå–è‡ªå·±é…¿çš„å•¤é…’ã€‹ä½œè€…é«˜å²©ï¼Œåœ¨å—äº¬åˆ›åŠäº†å¤§å¸ˆæ¯å…¨å›½å®¶é…¿å•¤é…’å¤§å¥–èµ›ï¼ˆä»¥ä¸‹ç®€ç§°å¤§å¸ˆæ¯ï¼‰ï¼Œè¯„é€‰å‡ºä¼˜ç§€çš„å®¶é…¿ä½œå“å’Œé…¿é€ è€…ï¼Œä»¥é¢‚æ‰¬é…¿é€ çš„è‰ºæœ¯å’Œç§‘å­¦</p><p>å¤§å¸ˆæ¯å¸çº³äº†è¯¸å¤šå›½å†…æ·±è€•äºè¡Œä¸šçš„å…ˆè¡Œè€…ï¼Œå½¢æˆå¤§å¸ˆæ¯å…¨å›½å®¶é…¿å•¤é…’å¤§å¥–èµ›ç»„å§”ä¼šï¼Œåˆ¶å®šå¹¶éµå¾ªç»„å§”ä¼šç« ç¨‹ï¼Œç§‰æ‰¿â€œå…¬å¹³ã€åˆç†ã€ç§‘å­¦â€çš„ä»·å€¼è§‚ï¼Œä¸æ–­æå‡å¤§å¸ˆæ¯çš„å½±å“åŠ›å’Œå…¬ä¿¡åŠ›ã€‚</p></blockquote><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039610.jpg" style="zoom: 50%;" /></p><p><a href="https://mp.weixin.qq.com/s/A2HxAoD_XUNVORqIWppcQA">2022å¡”ç½—æ–¯Â·å¤§å¸ˆæ¯ å®¶é…¿èµ›ï¼Œèµ›åˆ¶è¯´æ˜&amp;åˆ†ç»„è§„åˆ™</a></p><p><a href="https://mp.weixin.qq.com/s/vQdHVW-YuGWcpzzNXmcabA">2022å¡”ç½—æ–¯Â·å¤§å¸ˆæ¯ å¹¿å·ç«™æŠ¥åå¼€å§‹</a></p><p><strong>æˆ‘é…¿çš„å•¤é…’</strong></p><p>æ›¾ç»å‚è¿‡ 2020 å¹´å¤§å¸ˆæ¯ï¼Œè¯„åˆ†</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039065.jpg" style="zoom:33%;" /><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039471.jpg" style="zoom:33%;" /></p><p><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039794.jpg" /></p><h1 id="è‰ºæœ¯å’Œæ–‡åŒ–">è‰ºæœ¯å’Œæ–‡åŒ–</h1><h2 id="é…’å‚-é…’æ ‡">é…’å‚ &amp; é…’æ ‡</h2><p><strong>æ‰“å—æµ·ç‹¸ï¼ˆBelching Beaverï¼‰</strong></p><p><a href="https://belchingbeaver.com/">Belching Beaver Brewery</a></p><p><strong>åŒ—é…¿ï¼ˆNorth Brewingï¼‰</strong></p><p><a href="https://shop.northbrewing.com/">North Brewing Co OnlineShop</a></p><p><strong>å²¬è§’ï¼ˆBallast Pointï¼‰</strong></p><p><a href="https://ballastpoint.com/">Homepage - Ballast PointBrewing</a></p><p><strong>ä¼Ÿå¤§ç†å¿µï¼ˆGreat Notionï¼‰</strong></p><p><a href="https://greatnotion.com/">Great Notion | Home</a></p><p><strong>ç¾å¥‡ä¹ï¼ˆMikkellerï¼‰</strong></p><p><a href="https://mikkeller.com/">Mikkeller</a></p><p><strong>è”åˆè‰ºæœ¯ï¼ˆCollective Artsï¼‰</strong></p><p><a href="https://collectiveartsbrewing.com/de/">Home - CollectiveArts Germany (collectiveartsbrewing.com)</a></p><h2 id="è¡ç”Ÿæ´»åŠ¨">è¡ç”Ÿæ´»åŠ¨</h2><p><strong>åˆé…¿</strong></p><p>åˆé…¿å°±æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ªä¸åŒçš„ç²¾é…¿å‚ç‰Œåœ¨ä¸€èµ·åˆä½œé…¿é€ ä¸€æ¬¾é…’ï¼Œå°±æœ‰ç‚¹å„¿åƒé‚»å±…ä¹‹é—´çš„ä¸²é—¨ä¸€æ ·ï¼Œä»Šå¤©æˆ‘å»ä½ é‚£å„¿ï¼Œæ˜å¤©ä½ æ¥æˆ‘è¿™å„¿ï¼Œå¤§å®¶åä¸€åï¼ŒèŠä¸€èŠï¼Œåƒä¸ªé¥­</p><p>é™¤äº†è”ç»œæ„Ÿæƒ…ï¼Œåˆé…¿è¿˜æœ‰ä¸€ä¸ªé‡è¦æ„ä¹‰å°±æ˜¯èƒ½å¤Ÿå°†å½¼æ­¤çš„äº§å“ç‰¹ç‚¹èåˆåœ¨ä¸€èµ·ï¼Œåˆ›é€ å‡ºæ›´å…·ç‰¹è‰²çš„äº§å“ï¼›åˆé…¿çš„è¿‡ç¨‹å…¶å®ä¹Ÿæ˜¯ä¸ªæŠ€æœ¯äº¤æµä¸åˆ†äº«çš„è¿‡ç¨‹ï¼Œå–å½¼ä¹‹é•¿ï¼Œè¡¥å·±ä¹‹çŸ­</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039709.png" alt="image-20220320171652123" style="zoom: 50%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039981.png" alt="image-20220320171714327" style="zoom:50%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039874.png" alt="image-20220320171722436" style="zoom: 50%;" /></p><p><strong>é…’å¤´æ¥ç®¡</strong></p><p>å•¤é…’å§å¼•å…¥ä¸€æ‰¹æŸé…’å‚çš„å•¤é…’è€Œä¸¾åŠçš„å¸¦æœ‰å¹¿å‘Šæ€§è´¨ã€ä¸»é¢˜æ€§è´¨ã€ä¿ƒé”€æ€§è´¨çš„è¥é”€æ´»åŠ¨</p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039483.png" alt="image-20220320171908796" style="zoom:50%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039798.png" alt="image-20220320171914991" style="zoom:50%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252039116.png" alt="image-20220320171926205" style="zoom:50%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040917.png" alt="image-20220320173347954" style="zoom:50%;" /></p><p><strong>å±•è§ˆä¼š &amp; å•¤é…’èŠ‚</strong></p><p><ahref="https://www.jiuhuar.com/news/6225b9248ba5b044278b4569.html">ã€ŒDesignç²¾é…¿ã€è‰ºæœ¯å±•å’Œæ˜¥å­£å•¤é…’ç•…é¥®å¤§ä¼šæ¥å•¦ï¼(jiuhuar.com)</a></p><p><ahref="https://mp.weixin.qq.com/s/8zT6i8Alnaw2D7Tg7nwPYg">2021äº¬Aå…«ä¹˜å…«å‚èŠ‚æŒ‡å—ï¼Œè¿™ä¸ªå‘¨æœ«ç­‰ä½ æ¥ç©ï¼(qq.com)</a></p><p><ahref="https://mp.weixin.qq.com/s/36PlJmIOa5tvlmFWGIVARQ">å•¤é…’èŠ‚æ¥äº†ï¼ |ç¬¬äºŒå±Šã€è·³å•¤æ‹æ¡£ã€å¹¿å·ç²¾é…¿å•¤é…’èŠ‚ï¼Œä¸‹å‘¨è§ï¼ (qq.com)</a></p><p><strong>å•¤é…’è·‘</strong></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040418.png" alt="image-20220320172308492" style="zoom:50%;" /></p><p><ahref="https://mp.weixin.qq.com/s/DCBIJeQYdWRUF_XcpCydlQ">æˆ‘ä»¬èµåŠ©äº†ä¸€åœºå¿«ä¹çš„ã€2020å¦é—¨å•¤é…’è·‘âˆ£RUNFOR BEERã€‘ (qq.com)</a></p><p><strong>èŠ‚æ—¥æ´»åŠ¨</strong></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040128.png" alt="image-20220320173409737" style="zoom: 67%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040081.png" alt="image-20220320173420348" style="zoom:50%;" /></p><p><ahref="https://mp.weixin.qq.com/s/woOyTmWUATl7-0p-K6EDkw">ç…é¥¼èŠ‚åé—ç—‡ï½œäº¬æ´¥å¤§æˆ˜å…¨å›é¡¾(qq.com)</a></p><p><strong>è·¨ç•Œ</strong></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040229.png" alt="image-20220320173649555" style="zoom:50%;" /></p><p><img src="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252040814.png" alt="image-20220320173657609" style="zoom:50%;" /></p><p><ahref="https://mp.weixin.qq.com/s/qW5M9Eduzz0jn2H-o9bZHw">æ–‡æœ«æœ‰ç¦åˆ©ï½œé“é…¿X FIRSTé’å¹´ç”µå½±å±• (qq.com)</a></p><h2 id="éƒ½åœ¨é…’é‡Œ">ã€Šéƒ½åœ¨é…’é‡Œã€‹</h2><p>æœ€åæ¨èä¸€éƒ¨æœºæ ¸çš„çºªå½•ç‰‡</p><p><ahref="https://www.bilibili.com/video/BV1R5411s7ZY?spm_id_from=333.999.0.0">ã€Œ4Ké‡åˆ¶ç‰ˆã€ååœ¨ä¸€èµ·ï¼Œä¸ºç”Ÿæ´»å¹²æ¯ï¼šç²¾é…¿å•¤é…’çºªå½•ç‰‡ã€Šéƒ½åœ¨é…’é‡Œã€‹ç¬¬ä¸‰é›†ã€Šç¾å¼å‘¨æœ«ã€‹_å“”å“©å“”å“©_bilibili</a></p><p><imgsrc="https://kuga-pic-1258855810.cos.ap-beijing.myqcloud.com/202212252042908.jpg" /></p>]]></content>
      
      
      <categories>
          
          <category> äººç”Ÿ </category>
          
          <category> å®¿é†‰ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç²¾é…¿å•¤é…’ </tag>
            
            <tag> åƒå–ç©ä¹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¡¥æ¥æ¨¡å¼ - Bridge</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F%20-%20Bridge.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F%20-%20Bridge.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>æ¡¥æ¥ï¼ˆbridgeï¼‰æ¨¡å¼é¦–å…ˆçš„åœºæ™¯æ˜¯å†…éƒ¨å®ç°é€»è¾‘åˆ†ä¸ºå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—åˆå¯èƒ½å¯¹åº”å¤šç§å®ç°</p><p>åœ¨æ¡¥æ¥å†…éƒ¨ï¼Œè¿™äº›ä¸åŒç±»å‹çš„æ¨¡å—æŒ‰ç…§ç»„åˆæˆ–èšåˆçš„æ–¹å¼ç»„ç»‡åœ¨ä¸€èµ·ï¼Œå°†é€»è¾‘æ¨¡å—æŠ½è±¡éƒ¨åˆ†ä¸å®ç°éƒ¨åˆ†ç›¸åˆ†ç¦»</p><p><strong>ç›®çš„</strong>é™ä½å†…éƒ¨å¤šç§ç±»å‹é€»è¾‘æ¨¡å—çš„è€¦åˆï¼Œæ‰©å±•å˜æˆä»¥å„æ¨¡å—ä¸ºå•ä½ï¼Œæ›´ä¸ºçµæ´»</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong> <ahref="https://vans.com.cn/customs.html">Vansè‡ªç”±å®šåˆ¶é‹_Vans(èŒƒæ–¯)ä¸­å›½å®˜æ–¹ç½‘ç«™</a></p><p>çƒé‹å®šåˆ¶ï¼Œä»é€‰æ‹©æ¬¾å¼å¼€å§‹ï¼Œå¯¹ä¸åŒçš„éƒ¨ä½ï¼ˆé‹å¤´ã€é‹è…°ã€ä¾§è¾¹æ¡çº¹ã€é‹å¸¦ç­‰ï¼‰é€‰æ‹©ä¸åŒçš„è®¾è®¡ï¼ˆé¢œè‰²ã€å›¾æ¡ˆã€æè´¨ç­‰ï¼‰ï¼Œæœ€ç»ˆäº§å‡ºæœ€ç»ˆäº§å“ï¼ˆæ¡¥æ¥æ¨¡å¼çš„æœ€ç»ˆæˆå“å¯ä»¥è®¤ä¸ºæ˜¯ç»„åˆäº†å¤šä¸ªæ¨¡å—é€»è¾‘çš„æ‰§è¡Œå™¨ï¼‰</p><p>é’ˆå¯¹ä¸åŒéƒ¨ä½é€‰æ‹©ä¸åŒçš„è®¾è®¡ï¼Œè€Œä¸æ˜¯å¹³é“ºå‡ºç¬›å¡å°”ç§¯å¼çš„é…ç½®è¡¨ï¼Œå°±æ˜¯æ¡¥æ¥æ¨¡å¼å¸Œæœ›å®ç°çš„è§£è€¦çš„ç›®çš„</p><h1 id="å®è·µ">å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œæ¯”å¦‚æœåŠ¡å†…å¸Œæœ›å®ç°ä¸€ä¸ªæ¶ˆæ¯é€šçŸ¥åŠŸèƒ½</p><p>æ¶ˆæ¯åˆ†ä¸ºå¤šç§è®°å½•æ–¹å¼ï¼šç¼“å­˜ã€æ•°æ®åº“</p><p>é€šçŸ¥çš„æ–¹å¼ä¹Ÿåˆ†ä¸ºå¤šç§æ–¹å¼ï¼šé‚®ä»¶ã€å¾®ä¿¡</p><p>æœåŠ¡å†…å®šä¹‰ä»€ä¹ˆçº§åˆ«çš„æ¶ˆæ¯é€šè¿‡ä»€ä¹ˆæ–¹å¼è¿›è¡Œé€šçŸ¥</p><h2 id="é—®é¢˜">é—®é¢˜</h2><p>å¦‚æœå°†æ‰€éœ€è¦çš„å‘é€æ–¹å¼è¿›è¡Œå®ç°ï¼Œéœ€è¦å®ç° 4 ç§æ‰§è¡Œå™¨ï¼ˆ2 Ã—2ï¼‰ï¼Œå“ªæ€•æ˜¯æœåŠ¡ä¸­å¯ä»¥è¿›è¡Œé€‰æ‹©ï¼Œä¹Ÿéœ€è¦å…¨éƒ¨è¿›è¡Œå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEmailNotifier</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å­˜æ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€ç”µå­é‚®ä»¶&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheWeChatNotifier</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å­˜æ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€å¾®ä¿¡&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å¦‚æœåç»­æœ‰è°ƒæ•´ï¼Œå¢åŠ äº†æ–°çš„è®°å½•æ–¹å¼æˆ–è€…é€šçŸ¥æ–¹å¼ï¼Œé‚£ä¹ˆéœ€è¦éœ€è¦åˆ›å»ºçš„ç±»å°±æ›´å¤šäº†ï¼Œå¹¶ä¸”å¯èƒ½è¿˜å­˜åœ¨ç›¸åŒçš„é€»è¾‘è¢«å®ç°äº†å¤šä»½ä¸ä¾¿äºç»´æŠ¤</p><p>é—®é¢˜å‡ºç°çš„åŸå› æ˜¯å› ä¸ºå°†è®°å½•æ–¹å¼å’Œé€šçŸ¥æ–¹å¼è¿™ä¸¤ç§äº’ä¸å…³è”çš„æ¨¡å—<strong>åœ¨å®ç°ä¸­è€¦åˆåœ¨ä¸€èµ·</strong></p><h2 id="å®ç°">å®ç°</h2><h3 id="é€šçŸ¥æ–¹å¼">é€šçŸ¥æ–¹å¼</h3><p><strong>å®šä¹‰æ¥å£</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String msg)</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿›è¡Œå®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”µå­é‚®ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailSender</span> <span class="keyword">implements</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€ç”µå­é‚®ä»¶:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾®ä¿¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeChatSender</span> <span class="keyword">implements</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€å¾®ä¿¡:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®°å½•æ–¹å¼">è®°å½•æ–¹å¼</h3><p><strong>å®šä¹‰æ¥å£</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Recorder</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(String msg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿›è¡Œå®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼“å­˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRecorder</span> <span class="keyword">implements</span> <span class="title class_">Recorder</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®°å½•åˆ°ç¼“å­˜:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DbRecorder</span> <span class="keyword">implements</span> <span class="title class_">Recorder</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®°å½•åˆ°æ•°æ®åº“:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»„ç»‡è€…">ç»„ç»‡è€…</h3><p><strong>æŠ½è±¡ç»„ç»‡è€…</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractNotifier</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Recorder recorder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sender sender;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractNotifier</span><span class="params">(<span class="keyword">final</span> Recorder recorder, <span class="keyword">final</span> Sender sender)</span> &#123;</span><br><span class="line">        Assert.notNull(recorder);</span><br><span class="line">        Assert.notNull(sender);</span><br><span class="line">        <span class="built_in">this</span>.recorder = recorder;</span><br><span class="line">        <span class="built_in">this</span>.sender = sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        recorder.record(msg);</span><br><span class="line">        sender.send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»§æ‰¿æ„é€ æ¨¡å—çš„å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomNotifier</span> <span class="keyword">extends</span> <span class="title class_">AbstractNotifier</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomNotifier</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">DbRecorder</span>(), <span class="keyword">new</span> <span class="title class_">EmailSender</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸šåŠ¡æ‰©å±•">ä¸šåŠ¡æ‰©å±•</h3><p>éœ€è¦å¢åŠ æ–°çš„å‘é€æ–¹å¼ï¼Œæ¯”å¦‚çŸ­ä¿¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortMessageSender</span> <span class="keyword">implements</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€çŸ­ä¿¡:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦è¿›è¡Œæ–°çš„ notifier çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlusNotifier</span> <span class="keyword">extends</span> <span class="title class_">AbstractNotifier</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PlusNotifier</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">CacheRecorder</span>(), <span class="keyword">new</span> <span class="title class_">ShortMessageSender</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨">å®é™…åº”ç”¨</h2><p>JDBCé©±åŠ¨ä¸ºæ‰€æœ‰çš„å…³ç³»å‹æ•°æ®åº“æä¾›ä¸€ä¸ªé€šç”¨çš„æ ‡å‡†ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ¡¥æ¥æ¨¡å¼çš„å…¸å‹åº”ç”¨</p><h3 id="è¿›è¡Œè¿æ¥">è¿›è¡Œè¿æ¥</h3><p>å…ˆå›é¡¾ä¸€ä¸‹ JDBC çš„ä½¿ç”¨ï¼Œä½¿ç”¨ JDBC è¿æ¥ MySQLæ•°æ®åº“ä¸»è¦åˆ†ä¸ºè¿™æ ·å‡ æ­¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åŠ è½½ MySQL é©±åŠ¨æ³¨å…¥åˆ° DriverManager</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.æä¾› JDBC è¿æ¥çš„ URLã€ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test_db?&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.åˆ›å»ºæ•°æ®åº“çš„è¿æ¥</span></span><br><span class="line"><span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url, username, password);</span><br><span class="line"></span><br><span class="line"><span class="comment">//4.åˆ›å»º statement å®ä¾‹</span></span><br><span class="line"><span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line"></span><br><span class="line"><span class="comment">//5.æ‰§è¡Œ SQL è¯­å¥</span></span><br><span class="line"><span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;select * from test&quot;</span>;</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line"></span><br><span class="line"><span class="comment">//6.å…³é—­è¿æ¥å¯¹è±¡</span></span><br><span class="line">connection.close();</span><br></pre></td></tr></table></figure><h3 id="driver">Driver</h3><p><code>Class.forName("com.mysql.cj.jdbc.Driver");</code> è·å–äº† Driverå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Driver</span> <span class="keyword">extends</span> <span class="title class_">NonRegisteringDriver</span> <span class="keyword">implements</span> <span class="title class_">java</span>.sql.Driver &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Driver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ³¨å†Œé©±åŠ¨</span></span><br><span class="line">            DriverManager.registerDriver(<span class="keyword">new</span> <span class="title class_">Driver</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Can&#x27;t register driver!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨ <code>DriverManager</code> é™æ€æ–¹æ³•<code>registerDriver()</code> æ–¹æ³•æ¥å°† MySQL é©±åŠ¨æ³¨å†Œåˆ°<code>DriverManager</code></p><h3 id="drivermanager">DriverManager</h3><p><code>registerDriver()</code> æ–¹æ³•å…·ä½“å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">registerDriver</span><span class="params">(java.sql.Driver driver)</span></span><br><span class="line">    <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"><span class="comment">// ç›´æ¥è°ƒç”¨ä¸‹é¢çš„åŒåé™æ€æ–¹æ³•</span></span><br><span class="line">    registerDriver(driver, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">registerDriver</span><span class="params">(java.sql.Driver driver,DriverAction da)</span><span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">// registeredDrivers æ˜¯ä¸€ä¸ª list,ç”¨ DriverInfo å®ä¾‹å°è£… Driver</span></span><br><span class="line">    <span class="keyword">if</span>(driver != <span class="literal">null</span>) &#123;</span><br><span class="line">        registeredDrivers.addIfAbsent(<span class="keyword">new</span> <span class="title class_">DriverInfo</span>(driver, da));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is for compatibility with the original DriverManager</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;registerDriver: &quot;</span> + driver);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>registeredDrivers</code> é™æ€å˜é‡æ˜¯ä¸€ä¸ª list</p><p>æ³›å‹ <code>DriverInfo</code> æ˜¯é©±åŠ¨ä¿¡æ¯çš„åŒ…è£…ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverManager</span> &#123;</span><br><span class="line">    <span class="comment">// List of registered JDBC drivers</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="driverinfo">DriverInfo</h3><p><code>DriverInfo</code> ç±»ä¸­å°è£…äº† <code>java.sql.Driver</code>æ¥å£ï¼Œç±»ä¼¼ Driver ä¿¡æ¯ç®¡ç†è€…çš„è§’è‰²</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DriverInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Driver driver;</span><br><span class="line">    DriverAction da;</span><br><span class="line">    DriverInfo(Driver driver, DriverAction action) &#123;</span><br><span class="line">        <span class="built_in">this</span>.driver = driver;</span><br><span class="line">        da = action;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="connection">Connection</h3><p>æ¥ä¸‹æ¥è¿›è¡Œè¿æ¥çš„è·å–ï¼Œ<code>Connection connection = DriverManager.getConnection(url, username, password);</code></p><p><code>Connection</code>æ¥å£æ˜¯å’Œç‰¹å®šæ•°æ®åº“çš„è¿æ¥ä¼šè¯ï¼Œ<strong>ä¸åŒçš„æ•°æ®åº“çš„è¿æ¥ä¼šè¯éƒ½ä¸ç›¸åŒ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Connection</span>  <span class="keyword">extends</span> <span class="title class_">Wrapper</span>, AutoCloseable &#123;</span><br><span class="line"></span><br><span class="line">    Statement <span class="title function_">createStatement</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>DriverManager</code> ä¸­çš„ <code>getConnection</code>æ–¹æ³•ï¼Œä» <code>registeredDrivers</code>è¿›è¡Œé€‰æ‹©å¯¹åº”æ•°æ®åº“é©±åŠ¨ä¸‹çš„è¿æ¥å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(String url,String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    java.util.<span class="type">Properties</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Properties();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">        info.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (password != <span class="literal">null</span>) &#123;</span><br><span class="line">        info.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ä¸‹é¢çš„é™æ€æ–¹æ³• getConnection</span></span><br><span class="line"><span class="comment">//  Worker method called by the public getConnection() methods.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(</span></span><br><span class="line"><span class="params">    String url, java.util.Properties info, Class&lt;?&gt; caller)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * When callerCl is null, we should check the application&#x27;s</span></span><br><span class="line"><span class="comment">         * (which is invoking this class indirectly)</span></span><br><span class="line"><span class="comment">         * classloader, so that the JDBC driver class outside rt.jar</span></span><br><span class="line"><span class="comment">         * can be loaded from here.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">callerCL</span> <span class="operator">=</span> caller != <span class="literal">null</span> ? caller.getClassLoader() : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(DriverManager.class) &#123;</span><br><span class="line">        <span class="comment">// synchronize loading of the correct classloader.</span></span><br><span class="line">        <span class="keyword">if</span> (callerCL == <span class="literal">null</span>) &#123;</span><br><span class="line">            callerCL = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(url == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;The url cannot be null&quot;</span>, <span class="string">&quot;08001&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    println(<span class="string">&quot;DriverManager.getConnection(\&quot;&quot;</span> + url + <span class="string">&quot;\&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Walk through the loaded registeredDrivers attempting to make a connection.</span></span><br><span class="line">    <span class="comment">// Remember the first exception that gets raised so we can reraise it.</span></span><br><span class="line">    <span class="type">SQLException</span> <span class="variable">reason</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(DriverInfo aDriver : registeredDrivers) &#123;</span><br><span class="line">        <span class="comment">// If the caller does not have permission to load the driver then</span></span><br><span class="line">        <span class="comment">// skip it.</span></span><br><span class="line">        <span class="keyword">if</span>(isDriverAllowed(aDriver.driver, callerCL)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                println(<span class="string">&quot;    trying &quot;</span> + aDriver.driver.getClass().getName());</span><br><span class="line">                <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> aDriver.driver.connect(url, info);</span><br><span class="line">                <span class="keyword">if</span> (con != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Success!</span></span><br><span class="line">                    println(<span class="string">&quot;getConnection returning &quot;</span> + aDriver.driver.getClass().getName());</span><br><span class="line">                    <span class="keyword">return</span> (con);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (reason == <span class="literal">null</span>) &#123;</span><br><span class="line">                    reason = ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;    skipping: &quot;</span> + aDriver.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we got here nobody could connect.</span></span><br><span class="line">    <span class="keyword">if</span> (reason != <span class="literal">null</span>)    &#123;</span><br><span class="line">        println(<span class="string">&quot;getConnection failed: &quot;</span> + reason);</span><br><span class="line">        <span class="keyword">throw</span> reason;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    println(<span class="string">&quot;getConnection: no suitable driver found for &quot;</span>+ url);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;No suitable driver found for &quot;</span>+ url, <span class="string">&quot;08001&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="connection-å®ç°">Connection å®ç°</h3><p>åœ¨ <code>Connection</code> æ¥å£çš„å…·ä½“å®ç°éƒ¨åˆ†ï¼ŒMySQLçš„è¿æ¥æ˜¯é€šè¿‡ä¸¤å±‚å®ç°å®ŒæˆæŠ½è±¡éƒ¨åˆ†çš„å®ç°</p><p>ä¸åŒçš„æ•°æ®åº“ä¼šè¿›è¡Œä¸åŒçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionImpl</span> <span class="keyword">implements</span> <span class="title class_">JdbcConnection</span>, SessionEventListener, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4009476458425101761L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">SQLPermission</span> <span class="variable">SET_NETWORK_TIMEOUT_PERM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLPermission</span>(<span class="string">&quot;setNetworkTimeout&quot;</span>);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JdbcConnection</span> <span class="keyword">extends</span> <span class="title class_">Connection</span>, MysqlConnection, TransactionEventHandler &#123;</span><br><span class="line">    JdbcPropertySet <span class="title function_">getPropertySet</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">changeUser</span><span class="params">(String var1, String var2)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“">æ€»ç»“</h3><p><code>DriverManager</code> ä½œä¸ºç»„ç»‡è€…ï¼Œç»„ç»‡äº†<code>Driver</code>ï¼ˆç”±ç®¡ç†è€… <code>DriverInfo</code> è¿›è¡Œç®¡ç†ï¼‰å’Œ<code>Connection</code> ä¸¤ç±»æ¨¡å—</p><p>æ ¹æ®ä½¿ç”¨çš„æ•°æ®åº“ä¸åŒçµæ´»åœ°è¿›è¡Œè¿æ¥çš„é€‰æ‹©</p><p>å¯¹åº”çš„ç±»å›¾ï¼š</p><img src="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F%20-%20Bridge/jdbc%E7%B1%BB%E5%9B%BE.drawio.png" class="" title="jdbcç±»å›¾.drawio"><h1 id="æ€»ç»“-1">æ€»ç»“</h1><p>å½“å­˜åœ¨ä¸€æ®µé€»è¾‘ä¸­åˆ†ä¸ºå¤šç±»æ¨¡å—æ—¶ï¼Œå¯ä»¥è€ƒè™‘å°†å„æ¨¡å—åˆ†åˆ«å®ç°å†è¿›è¡Œç»„ç»‡é™ä½è€¦åˆ</p><ul><li>ä¼˜ç‚¹<ul><li>å¯ä»¥å°†åºå¤§çš„ç±»æ‹†åˆ†æˆæ›´æœ‰å±‚æ¬¡çš„ç»“æ„ï¼Œå±‚æ¬¡ä¹‹é—´ä¸å­˜åœ¨è€¦åˆ</li><li>ä¾¿äºæ¨¡å—å®ç°çš„æ‰©å±•ï¼ˆå¼€é—­ï¼‰</li><li>åˆ‡æ¢ä¸åŒçš„å®ç°æ›´åŠ æ–¹ä¾¿</li><li>æ¯ä¸ªæ¨¡å—åˆå¯ä»¥å®šä¹‰å‡ºæŠ½è±¡éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†ï¼ˆå•ä¸€èŒè´£ï¼‰</li></ul></li><li>ç¼ºç‚¹<ul><li>åœ¨å·²å­˜åœ¨çš„åŠŸèƒ½ä¸Šè¿›è¡Œæ”¹é€ å·¥ç¨‹é‡è¾ƒå¤§ï¼ˆä¸åŒäºé€‚é…å™¨æ¨¡å¼ï¼‰</li><li>é«˜å†…èšçš„ç±»è¿›è¡Œæ¡¥æ¥è®¾è®¡ä¼šä½¿ä»£ç æ›´åŠ å¤æ‚</li></ul></li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://refactoringguru.cn/design-patterns/bridge">æ¡¥æ¥è®¾è®¡æ¨¡å¼(refactoringguru.cn)</a></p><p><ahref="https://blog.csdn.net/MY9526/article/details/108738263">æ¡¥æ¥æ¨¡å¼çš„å®é™…ä½¿ç”¨_æœ€åä¸€ä¸ªNPEçš„åšå®¢-CSDNåšå®¢_æ¡¥æ¥æ¨¡å¼å®æˆ˜</a></p><p><ahref="https://www.cnblogs.com/EthanWong/p/16079803.html">è®¾è®¡æ¨¡å¼å­¦ä¹ ç¬”è®°ï¼ˆä¹ï¼‰æ¡¥æ¥æ¨¡å¼åŠå…¶åº”ç”¨- å½’æ–¯å› - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¸ƒéš† &amp; å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨</title>
      <link href="/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/%E5%B8%83%E9%9A%86%20&amp;%20%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95/%E5%B8%83%E9%9A%86%20&amp;%20%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p><strong>ç‰¹å¾ or å…¨éƒ¨</strong></p><p>åœ¨å®é™…éœ€æ±‚ä¸­ï¼Œå¾€å¾€å­˜åœ¨ç±»ä¼¼éœ€æ±‚ï¼š</p><ul><li>é»‘ç™½åå•ï¼›ä¾‹å¦‚æ‰‹æœºå·ã€ç½‘ç«™ç­‰ï¼Œéœ€è¦è¿‡æ»¤æ‰åœ¨é»‘åå•ä¸­çš„æ•°æ®ï¼Œæˆ–è€…æ”¾è¡Œåœ¨ç™½åå•ä¸­çš„æ•°æ®</li><li>æ¨èå»é‡ï¼›é¦–é¡µæ–°é—»ã€è§†é¢‘ç­‰èµ„æºå·²ç»ç»™ç”¨æˆ·æ¨èè¿‡çš„ä¸è¿›è¡Œé‡å¤æ¨é€</li><li>ç¼“å­˜ç©¿é€ï¼›ä¿è¯ç¼“å­˜å±‚èƒ½æ­£å¸¸å·¥ä½œï¼Œä¸è¢«ç‰¹æ®Šè¯·æ±‚å¤§é‡é€ æˆç¼“å­˜ç©¿é€</li></ul><p>æœ€å®¹æ˜“æƒ³åˆ°çš„ï¼Œå°±æ˜¯é€šè¿‡ä¸€ä¸ªé›†åˆä¾‹å¦‚ Mapã€Listç­‰ç»“æ„å°†æ•°æ®å­˜å‚¨èµ·æ¥ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­</p><p>è¿™æ ·ç›¸å½“äºæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½è¿›è¡Œäº†ä¸€éå­˜å‚¨ï¼Œå¦‚æœéœ€è¦çš„åªæ˜¯è¿‡æ»¤åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦å°†æ•°æ®å…¨éƒ¨å­˜å‚¨ä¸‹æ¥ï¼Œåªéœ€è¦å­˜å‚¨æ•°æ®çš„ç‰¹å¾å€¼ï¼Œå°±å¯ä»¥èŠ‚çœå¤§é‡çš„ç©ºé—´</p><p>æ‰€ä»¥å‡ºç°äº†å¸ƒéš†è¿‡æ»¤å™¨ç­‰æ¦‚ç‡å‹ç»“æ„ï¼ˆprobabilistic datastructureï¼‰ï¼Œå¯ä»¥åœ¨ä½¿ç”¨å¾ˆå°‘ç©ºé—´çš„æƒ…å†µä¸‹å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤æ“ä½œï¼Œå½“ç„¶é€šè¿‡ç‰¹å¾å€¼è¿›è¡Œå­˜å‚¨å¯èƒ½ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>è¯¯åˆ¤ç‡</li><li>æ‰©ç¼©å®¹ä¾ç„¶éœ€è¦æ•°æ®å…¨é›†ï¼ˆæ•°æ®é‡ä¸åŒ¹é…ä¼šå¯¼è‡´ç©ºé—´æµªè´¹æˆ–è¯¯åˆ¤ç‡ä¸Šå‡ï¼‰</li><li>åˆ é™¤æ“ä½œéš¾ä»¥å®ç°</li></ul><p>éœ€è¦åœ¨æŠ€æœ¯å’Œä¸šåŠ¡ä¸¤æ–¹é¢è¿›è¡Œå–èˆ</p><h1 id="å¸ƒéš†">å¸ƒéš†</h1><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆbloom filterï¼‰ç”±ä¸€ä¸²å¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡ç»„æˆï¼ˆä½å›¾bitmapï¼‰ï¼Œå¯ä»¥å°†å…¶çœ‹æˆä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„</p><p>å½“ä¸€ä¸ªå…ƒç´ è¿›å…¥æ—¶ï¼Œä¸æ˜¯å­˜å‚¨è¯¥å…ƒç´ æœ¬èº«ï¼Œè€Œæ˜¯é€šè¿‡å¤šä¸ªå“ˆå¸Œç®—æ³•ï¼Œè®¡ç®—å‡ºè¯¥å…ƒç´ çš„å¤šä¸ªä¸‹æ ‡ï¼Œéšååœ¨ä½å›¾ä¸­å°†å¯¹åº”çš„ä¸‹æ ‡æ‰“ä¸Šæ ‡è®°ï¼ˆbitä½ç½®ä¸º1ï¼‰ï¼Œå½“éœ€è¦åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸä¸ªå…ƒç´ æ—¶ï¼Œä¹Ÿæ˜¯è¿›è¡Œå“ˆå¸Œåï¼Œåˆ¤æ–­å…¶éœ€è¦çš„ä¸‹æ ‡æ˜¯å¦å…¨ä¸º1</p><p>å¯ä»¥çœ‹å‡ºï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¸¦æœ‰ä¸€å®šçš„è¯¯åˆ¤ç‡ï¼Œå¦‚æœå¾ˆå¤šå…ƒç´ çš„ä¸‹æ ‡æ­£å¥½å¤åˆäº†æŸä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œé‚£ä¹ˆè¯¥å…ƒç´ å°±ä¼šè¢«è¯¯åˆ¤å­˜åœ¨ï¼š</p><ul><li>è¯´å­˜åœ¨ä½†ä¸ä¸€å®šå­˜åœ¨</li><li>è¯´ä¸å­˜åœ¨ä¸€å®šä¸å­˜åœ¨</li></ul><p>å›¾ç¤ºæ¨¡æ‹Ÿæµç¨‹ï¼šhttps://www.jasondavies.com/bloomfilter/</p><p><strong>å‚æ•°é€‰æ‹©</strong></p><p>ä¹Ÿå¯ä»¥çœ‹å‡ºå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ç‡å’Œä»¥ä¸‹å‚æ•°ç›¸å…³ï¼š</p><ul><li>è¿‡æ»¤å™¨ä¸­ä½å›¾çš„ä½æ•°</li><li>å“ˆå¸Œç®—æ³•çš„æ•°é‡å’Œè´¨é‡</li></ul><p><ahref="https://hur.st/bloomfilter/?n=400000000&amp;p=0.01&amp;m=&amp;k=">Bloomfilter calculator (hur.st)</a> å¯ä»¥è¿›è¡Œå¸ƒéš†è¿‡æ»¤å™¨å‚æ•°çš„é¢„ä¼°</p><table><colgroup><col style="width: 7%" /><col style="width: 25%" /><col style="width: 66%" /></colgroup><thead><tr class="header"><th style="text-align: center;">å‚æ•°å€¼</th><th style="text-align: center;">å«ä¹‰</th><th style="text-align: center;">å…¬å¼</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">n</td><td style="text-align: center;">è¿‡æ»¤å™¨ä¸­çš„å…ƒç´ æ•°é‡</td><tdstyle="text-align: center;"><code>n = ceil(m / (-k / log(1 - exp(log(p) / k))))</code></td></tr><tr class="even"><td style="text-align: center;">p</td><td style="text-align: center;">è¯¯åˆ¤ç‡</td><tdstyle="text-align: center;"><code>p = pow(1 - exp(-k / (m / n)), k)</code></td></tr><tr class="odd"><td style="text-align: center;">m</td><td style="text-align: center;">è¿‡æ»¤å™¨ä½¿ç”¨çš„ç©ºé—´å¤§å°</td><tdstyle="text-align: center;"><code>m = ceil((n * log(p)) / log(1 / pow(2, log(2))));</code></td></tr><tr class="even"><td style="text-align: center;">k</td><td style="text-align: center;">å“ˆå¸Œç®—æ³•æ•°é‡</td><tdstyle="text-align: center;"><code>k = round((m / n) * log(2));</code></td></tr></tbody></table><p><strong>æ— æ³•åˆ é™¤</strong></p><p>å¸ƒéš†è¿‡æ»¤å™¨æ˜¯æ— æ³•åˆ é™¤å…ƒç´ çš„ï¼Œå› ä¸ºä¸€æ—¦å­˜å‚¨ç‰¹å¾åï¼Œåˆ é™¤ä¼šå¯¼è‡´è¿å¸¦å…¶ä»–å…ƒç´ çš„æ ‡è®°ä¸€èµ·åˆ é™¤</p><p>ä¸ºäº†èƒ½è®©å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤æ“ä½œï¼Œè¡ç”Ÿå‡ºäº†å˜ä½“ç»“æ„ï¼Œè®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆcountingbloom filterï¼‰</p><p><strong>å®é™…åº”ç”¨</strong></p><p><a href="https://toutiao.io/posts/mtrvsx/preview">Nowç›´æ’­å‘ç°é¡µçŸ­è§†é¢‘ç€‘å¸ƒæµä¼˜åŒ– - å¼€å‘è€…å¤´æ¡ (toutiao.io)</a></p><h1 id="è®¡æ•°å¸ƒéš†">è®¡æ•°å¸ƒéš†</h1><p>ä½¿ç”¨ä¸€ä¸ª counteræ•°ç»„æ¥æ›¿ä»£ä¹‹å‰çš„ä½å›¾ï¼Œåœ¨è¿›è¡Œæ ‡è®°æ—¶å¯ä»¥è®°å½•ä¸€å…±æ ‡è®°äº†å¤šå°‘æ¬¡ï¼Œæ˜¾è€Œæ˜“è§ç©ºé—´å ç”¨ä¼šæ‰©å¤§ä¸å°‘</p><p>åœ¨è¿›è¡Œåˆ¤æ–­æ—¶ <code>counter &gt; 0</code> å³è¡¨ç¤ºäº†ä¹‹å‰çš„<code>index == 1</code> æ“ä½œ</p><p>è®¡æ•°å™¨ä¹Ÿæ— æ³•é¿å…è¯¯åˆ ï¼Œåªæ˜¯èƒ½å¤§å¹…åº¦é™ä½è¯¯åˆ æ¦‚ç‡</p><h1 id="å¸ƒè°·é¸Ÿ">å¸ƒè°·é¸Ÿ</h1><p>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„å‡çº§ï¼Œæœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>æ”¯æŒåŠ¨æ€çš„æ–°å¢å’Œåˆ é™¤å…ƒç´ </li><li>æä¾›äº†æ¯”ä¼ ç»Ÿå¸ƒéš†è¿‡æ»¤å™¨æ›´é«˜çš„æŸ¥æ‰¾æ€§èƒ½ï¼Œå³ä½¿åœ¨æ¥è¿‘æ»¡ç©ºé—´çš„æƒ…å†µä¸‹ï¼ˆè®¿é—®å†…å­˜æ¬¡æ•°ä½ï¼‰</li><li>è¦æ±‚ä¸€å®šè¯¯åˆ¤ç‡ä¸‹ï¼Œç©ºé—´å ç”¨ä¸€èˆ¬æ›´å°</li></ul><p><strong>å¸ƒè°·é¸Ÿ hash</strong></p><blockquote><p>å½“å‘ç°é¸Ÿè›‹å ç”¨äº†è‡ªå·±çš„ä½ç½®æ—¶ï¼Œå°±æŠŠå®ƒæ¨èµ°</p></blockquote><p>å‡è®¾æœ‰ä¸¤ä¸ª hash è¡¨ï¼Œè®°ä¸º T1 å’Œ T2</p><p>åŒæ—¶æœ‰ä¸¤å¥— hash ç®—æ³•ï¼Œè®°ä¸º H1 å’Œ H2</p><p>æ·»åŠ å…ƒç´ æµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>æ ¹æ® H1 è®¡ç®—å…¶åœ¨ T1 çš„ä½ç½®ä¸‹æ ‡</li><li>å¦‚æœè¯¥ä½ç½®æ²¡æœ‰æ ‡è®°åˆ™è¿›è¡Œæ ‡è®°ï¼Œå¦‚æœæ ‡è®°äº†åˆ™ç»§ç»­</li><li>æ ¹æ® H2 è®¡ç®—å…¶åœ¨ T2 çš„ä½ç½®ä¸‹æ ‡</li><li>å¦‚æœè¯¥ä½ç½®æ²¡æœ‰æ ‡è®°åˆ™è¿›è¡Œæ ‡è®°ï¼Œå¦‚æœæ ‡è®°äº†åˆ™è¯´æ˜æ‰€æœ‰ä½ç½®éƒ½å·²ç»è¢«å ç”¨ï¼Œéšæœºè¸¢å‡ºT1 æˆ–è€… T2 ä¸Šè¯¥ä¸‹æ ‡çš„å…ƒç´ ï¼Œå°†è‡ªå·±æ”¾å…¥ä¸‹æ ‡</li><li>è¢«è¸¢å‡ºçš„å…ƒç´ é‡å¤ä¸Šè¿°æµç¨‹æŸ¥æ‰¾è‡ªå·±çš„ä½ç½®</li><li>ç»è¿‡ <code>MaxLoop</code>é˜ˆå€¼åè¿˜å­˜åœ¨å…ƒç´ æ²¡æœ‰åˆé€‚çš„ä½ç½®ï¼Œåˆ™å…ƒç´ æ·»åŠ å¤±è´¥ï¼Œè¯´æ˜éœ€è¦è¿›è¡Œæ‰©å®¹äº†</li></ol><p>å›¾ç¤ºæ¨¡æ‹Ÿæµç¨‹ï¼šhttp://www.lkozma.net/cuckoo_hashing_visualization/</p><p><strong>è¿‡æ»¤å™¨çš„ hash</strong></p><p>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨çš„ hash æ˜¯å¯¹å¸ƒè°·é¸Ÿ hash çš„æ”¹è¿›</p><p>å¸ƒè°·é¸Ÿ hash ä¸­ï¼Œå“ˆå¸Œè¡¨å­˜å‚¨çš„æ˜¯å…ƒç´ çš„åŸå§‹å€¼ xï¼Œä¸‹æ ‡ p1 p2çš„è®¡ç®—å…¬å¼ä¸º</p><ul><li><code>p1 = hash1(x) % L</code></li><li><code>p2 = hash2(x) % L</code></li></ul><p>è€Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨å¯¹äºä¸‹æ ‡çš„è®¡ç®—ä¸ºï¼š</p><ul><li><code>h1(x) = hash(x)</code></li><li><code>h2(x) = h1(x) âŠ• hash(x's fingerprint)</code></li></ul><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®— h2ï¼ˆä½ç½® 2ï¼‰æ—¶ï¼Œå¯¹ x çš„ fingerprint è¿›è¡Œäº†ä¸€ä¸ªhash è®¡ç®—ï¼Œå…¬å¼ä¸­çš„å¼‚æˆ–æ“ä½œè·å¾—äº†ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼šä½ç½® h2 å¯ä»¥é€šè¿‡ä½ç½® h1å’Œ h1 ä¸­å­˜å‚¨çš„ fingerprintè®¡ç®—å‡ºæ¥ï¼Œå³å½“å…ƒç´ è¢«è¸¢å‡ºæ—¶ï¼Œæ ¹æ®å½“å‰ä½ç½®å’Œå…ƒç´ çš„æŒ‡çº¹ï¼Œå°±å¯ä»¥å¾—åˆ°å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®</p><p><strong>å¼‚æˆ–ä¸å¯¹å¶</strong></p><p>ç”± h2 çš„è®¡ç®—å…¬å¼<code>h2(x) = h1(x) âŠ• hash(x's fingerprint)</code>ï¼Œä¸¤ä¸ªä½ç½®å…·æœ‰å¯¹å¶æ€§</p><p>åªè¦ä¿è¯ <code>hash(x's fingerprint) !=0</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç¡®ä¿<code>h2 != h1</code>ï¼Œä¹Ÿå°±å¯ä»¥ç¡®ä¿ï¼Œä¸ä¼šå‡ºç°è‡ªå·±è¸¢è‡ªå·±çš„æ­»å¾ªç¯é—®é¢˜</p><p>ä¸ºä»€ä¹ˆéœ€è¦å¯¹æŒ‡çº¹è¿›è¡Œå“ˆå¸Œè¿ç®—å‘¢ï¼Ÿå› ä¸ºå¦‚æœæŒ‡çº¹çš„é•¿åº¦æ˜¯ 8bitï¼Œé‚£ä¹ˆå¼‚æˆ–æ“ä½œåªä¼šæ”¹å˜å½“å‰ä½ç½® h1(x) çš„ä½ 8 ä½ï¼Œé«˜ä½ä¸ä¼šæ”¹å˜ï¼Œå°±ç®—ä½8 ä½å®Œå…¨ä¸ä¸€æ ·ï¼Œæœ€åè®¡ç®—å‡ºæ¥çš„ä½ç½®æœ€è¿œä¹Ÿåªæœ‰ 256ä½ï¼Œä¸ºäº†æ•£åˆ—æ›´å……åˆ†ï¼Œæ‰€ä»¥å¯¹æŒ‡çº¹å…ˆè¿›è¡Œä¸€æ¬¡å“ˆå¸Œæ“ä½œ</p><p><strong>æŒ‡çº¹</strong></p><p>æŒ‡çº¹å…¶å®å°±æ˜¯å…ƒæ•°æ®çš„ç‰¹å¾å€¼ï¼Œè¿›è¡Œå“ˆå¸Œåå–çš„å›ºå®š n ä¸ª bit ä½</p><p><strong>ç©ºé—´åˆ©ç”¨ç‡</strong></p><p>ç”±äºæŒ‡çº¹æ˜¯å¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œè¿ç®—åå›ºå®šçš„ bitä½ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå‡ºç°è¯¯åˆ¤çš„æƒ…å†µ</p><p>åœ¨å®Œç¾çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘ç”Ÿå“ˆå¸Œå†²çªä¹‹å‰ï¼Œå®ƒçš„ç©ºé—´åˆ©ç”¨ç‡æœ€é«˜åªæœ‰50%</p><p>å¦‚æœå¯¹æ•°ç»„è¿›è¡Œå±•å¼€ï¼Œå½“ä¸€ä¸ªä½ç½®å¯ä»¥å­˜æ”¾å¤šä¸ªæ•°æ®æ—¶ï¼Œç©ºé—´åˆ©ç”¨ç‡ä¼šæå‡ï¼›å¦‚æœä¸€ä¸ªä¸‹æ ‡å¯ä»¥æ”¾2ã€4ã€8 ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œç©ºé—´åˆ©ç”¨ç‡å°±ä¼šé£™å‡åˆ° 84%ã€95%ã€98%</p><p><strong>åˆ é™¤çš„é™åˆ¶</strong></p><p>å¦‚æœéœ€è¦å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ”¯æŒåˆ é™¤ï¼Œå®ƒå¿…é¡»çŸ¥é“ä¸€ä¸ªæ•°æ®æ’å…¥è¿‡å¤šå°‘æ¬¡ï¼ˆå¦åˆ™ä¹Ÿä¼šè¯¯åˆ ï¼‰</p><p>å¹¶ä¸”ä¸èƒ½è®©åŒä¸€ä¸ªæ•°æ®æ’å…¥ <code>kb+1</code> æ¬¡ï¼›ä¸ªäººè®¤ä¸ºå¦‚æœæ’å…¥è¶…è¿‡äº†<code>kb+1</code> æ¬¡ï¼Œå°±ä¼šå¯¼è‡´æ’å…¥ä¸€å®šå¤±è´¥</p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>å¸ƒè°·é¸Ÿçš„ä¼˜ç¼ºç‚¹ï¼š</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>è®¿é—®å†…å­˜æ¬¡æ•°ä½</li><li>Hash å‡½æ•°è®¡ç®—ç®€å•</li><li>æ”¯æŒåˆ é™¤æ“ä½œ</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å†…å­˜ç©ºé—´ä¸è”ç³»ï¼ŒCPU æ¶ˆè€—å¤§</li><li>å®¹æ˜“å‡ºç°è£…å¡«å¾ªç¯é—®é¢˜ï¼Œç©ºé—´å ç”¨è¶Šå¤šç¢°æ’è¶Šå¤šï¼Œæ’å…¥æ•ˆç‡è¶Šä½</li><li>æŸ¥è¯¢è¯¯åˆ¤ç‡</li><li>åˆ é™¤æ“ä½œé™åˆ¶å¤šï¼Œä¼šå½±å“æ’å…¥æ€§èƒ½å’Œè¯¯åˆ é™¤</li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p>https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf</p><p><ahref="https://zhuanlan.zhihu.com/p/348865590">å¸ƒéš†ï¼Œç‰›é€¼ï¼å¸ƒè°·é¸Ÿï¼Œç‰›é€¼ï¼- çŸ¥ä¹ (zhihu.com)</a></p><p><ahref="https://juejin.cn/post/6844903861749055502">å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ—¶äº†ï¼Œæœªæ¥å±äºå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼Ÿ- æ˜é‡‘ (juejin.cn)</a></p><p><ahref="https://zhuanlan.zhihu.com/p/462815302">å¸ƒéš†è¿‡æ»¤å™¨ä¸å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ -çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ç»“æ„ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®¡é“æ¨¡å¼ - Pipeline</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AE%A1%E9%81%93%E6%A8%A1%E5%BC%8F%20-%20Pipeline.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AE%A1%E9%81%93%E6%A8%A1%E5%BC%8F%20-%20Pipeline.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><p>ç®¡é“æ¨¡å¼ï¼ˆPipeline Patternï¼‰æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of CommandPatternï¼‰çš„å˜ä½“ï¼›åŒºåˆ«åœ¨äºè´£ä»»é“¾æ˜¯å°†å¤„ç†å™¨æŒ‰ç…§é“¾æ¡ç»„ç»‡èµ·æ¥ï¼Œå¾…å¤„ç†çš„ä¸Šä¸‹æ–‡æŒ‰ç…§é“¾æ¡æ‰¾åˆ°èƒ½å¤Ÿå¤„ç†è‡ªå·±çš„å¤„ç†å™¨ï¼Œä¸€èˆ¬åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªå¤„ç†å™¨ï¼›è€Œç®¡é“æ¨¡å¼æ˜¯é“¾æ¡ä¸­çš„æ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½éœ€è¦å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œå¤„ç†</p><p><strong>ç›®çš„</strong>é™ä½ä¸šåŠ¡é€»è¾‘æµç¨‹çš„è€¦åˆæ€§ï¼Œå°†æ•´ä¸ªè¿‡ç¨‹ä¸­æ‰€æœ‰çš„å¤„ç†å™¨éš”ç¦»å¼€ï¼Œæ›´æ–¹ä¾¿æ‰©å±•æµç¨‹ä¸Šæ–°çš„ä¸šåŠ¡é€»è¾‘</p><p><strong>ç°å®ä¸–ç•Œç±»æ¯”</strong> å·¥å‚çš„ç”Ÿäº§æµæ°´çº¿ï¼Œè½¦æ¶ -&gt; å‘é€æœº-&gt; å¤–å£³ -&gt; å†…é¥° -&gt; æ€»è£… -&gt;è´¨æ£€ï¼Œæ•´è¾†è½¦åœ¨ä¼ é€å¸¦åˆä¸€ä¸ªç¯èŠ‚è¿è¾“è‡³å¦ä¸€ä¸ªç¯èŠ‚ï¼Œæ¯ä¸ªå¤„ç†ç¯èŠ‚éƒ½å¯¹æ±½è½¦å¤„ç†è‡ªå·±çš„éƒ¨åˆ†ï¼Œæœ€ç»ˆäº§å‡ºæˆå“</p><h1 id="å®è·µ">å®è·µ</h1><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œæ¯”å¦‚è®¢å•æœåŠ¡å†…æŸ¥è¯¢æ¥å£æŠŠæœ€ç»ˆè®¢å•å®ä½“ç»„è£…ä¸ºä¸€ä¸ª VO</p><p>é™¤äº†åŸæœ‰çš„å®ä½“å±æ€§ï¼Œæ¯”å¦‚å†…éƒ¨æ•°æ®éœ€è¦å¯¹ä¼˜æƒ é‡‘é¢è¿›è¡Œè®¡ç®—ï¼Œå¤–éƒ¨æ•°æ®éœ€è¦è¡¥å……ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ç­‰</p><h2 id="é—®é¢˜">é—®é¢˜</h2><p>å¦‚æœå°†æ‰€æœ‰æ­¥éª¤æŠ½ä¸ºæ–¹æ³•ï¼Œåˆ™ä»£ç ä¸€èˆ¬ä¼šå®ç°ä¸ºè¿™æ ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">buildVO</span><span class="params">(OrderBo bo)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">OrderInfoVo</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="built_in">this</span>.wrapVo(bo);</span><br><span class="line">    <span class="built_in">this</span>.calMitigateSum(vo);</span><br><span class="line">    <span class="built_in">this</span>.buildUserInfo(vo);</span><br><span class="line">    <span class="built_in">this</span>.buildCommodityInfo(vo);</span><br><span class="line">    <span class="keyword">return</span> vo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢å¦‚æœå¯¹ VO çš„å­—æ®µæœ‰äº†æ–°çš„è¦æ±‚ï¼Œæ¯”å¦‚å¢åŠ ç‰©æµä¿¡æ¯ï¼›æˆ–è€…å¯¹ç”Ÿæˆ VOçš„æµç¨‹æœ‰äº†æ–°çš„è¦æ±‚ï¼Œæ¯”å¦‚æ ¹æ®æŸ¥è¯¢æ¡ä»¶è¿›è¡Œç¼“å­˜ï¼Œå°±ä¼šæœ‰ä»¥ä¸‹åå¤„ï¼š</p><ul><li>åœ¨ <code>buildVO</code>ä¸­å®ç°ç¼“å­˜é€»è¾‘ï¼Œè¿åäº†æ–¹æ³•çš„å•ä¸€èŒè´£ï¼Œç»´æŠ¤åœ¨å¤–é¢å¯èƒ½åˆéœ€è¦ç»´æŠ¤ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£</li><li>å°†æ¥æ¯åŠ å…¥ä¸€ä¸ªæ–°çš„å¤„ç†æ­¥éª¤æˆ–è€…åˆ é™¤æŸä¸ªæ­¥éª¤ï¼Œéƒ½è¦ä¿®æ”¹<code>buildVO</code> æ–¹æ³•</li></ul><p>è¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ç®¡é“æ¨¡å¼è§£å†³ä»¥ä¸Šç¼ºç‚¹</p><h2 id="å®ç°">å®ç°</h2><h3 id="ä¸Šä¸‹æ–‡">ä¸Šä¸‹æ–‡</h3><p>ä¸Šä¸‹æ–‡ç»´æŠ¤ç€æ•´ä¸ªä¸šåŠ¡é“¾æ¡ä¸­é—´çš„ç»“æœå’Œæœ€ç»ˆçš„ç»“æœæ•°æ®</p><p><strong>ç®¡é“ä¸Šä¸‹æ–‡çˆ¶ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ é€’åˆ°ç®¡é“çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PipelineContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¼€å§‹æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime startTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†ç»“æŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime endTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ•°æ®åç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…·ä½“çš„ä¸šåŠ¡æ•°æ®ä¸Šä¸‹æ–‡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸šåŠ¡ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderVOContext</span> <span class="keyword">extends</span> <span class="title class_">PipelineContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¢å•ä¸šåŠ¡æ¨¡å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> OrderBO bo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¢å• VO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> OrderVO vo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨¡å‹åˆ›å»ºå‡ºé”™æ—¶çš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String errorMsg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶ä»–å‚æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;build OrderVO&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†å™¨">å¤„ç†å™¨</h3><p><strong>å¤„ç†å™¨çˆ¶ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“ä¸­çš„ä¸Šä¸‹æ–‡å¤„ç†å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContextHandler</span>&lt;T <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context å¤„ç†æ—¶çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å› true åˆ™è¡¨ç¤ºç”±ä¸‹ä¸€ä¸ª ContextHandler ç»§ç»­å¤„ç†ï¼Œè¿”å› false åˆ™è¡¨ç¤ºå¤„ç†ç»“æŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(T context)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¡ç®—ä¼˜æƒ é‡‘é¢</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalMitigateSumHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--è®¡ç®—ä¼˜æƒ é‡‘é¢--&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¡ç®—æµç¨‹</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">mitigateSum</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        context.getVo().setMitigateSum(mitigateSum);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ„é€ ç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">buildUserInfoHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--æ„é€ ç”¨æˆ·ä¿¡æ¯--&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.getUserById(context.getBo().getUserId());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">            context.setErrorMsg(<span class="string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºï¼Œid=&quot;</span> + context.getBo().getUserId());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        context.getVo().setUserName(user.getName());</span><br><span class="line">        context.getVo().setUserAge(user.getAge());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ„é€ å•†å“ä¿¡æ¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">buildGoodsInfoHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--æ„é€ å•†å“ä¿¡æ¯--&quot;</span>);</span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> goodsClient.getGoodsBySku(context.getBo().getGoodsSku());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(goods)) &#123;</span><br><span class="line">            context.setErrorMsg(<span class="string">&quot;æŸ¥è¯¢å•†å“ä¿¡æ¯ä¸ºç©ºï¼Œid=&quot;</span> + context.getBo().getGoodsSku());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        context.getVo().setGoodsSku(goods.getSku());</span><br><span class="line">        context.getVo().setGoodsName(goods.getName());</span><br><span class="line">context.getVo().setGoodsPrice(goods.getPrice());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»„ç»‡å¤„ç†å™¨">ç»„ç»‡å¤„ç†å™¨</h3><p>ç°åœ¨ä¸šåŠ¡ Context å’Œ Handler éƒ½å®šä¹‰å¥½äº†ï¼Œé‚£ä¹ˆä½¿ç”¨ä»€ä¹ˆæ–¹å¼å°† Handlerç»„ç»‡èµ·æ¥å‘¢ï¼Ÿæœ‰å¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>Handler å¯¹è±¡æŒæœ‰ä¸‹ä¸€ä¸ª Handler çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä½¿ç”¨<code>nextHandler</code>å±æ€§æ¥ä¿å­˜ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›ç¼ºç‚¹æ˜¯æ— æ³•ç›´è§‚äº†è§£æ•´ä¸ªä¸šåŠ¡é“¾æ¡éƒ½æœ‰å“ªäº›å¤„ç†å™¨ï¼Œå¹¶ä¸”å¢åˆ å¤„ç†å™¨éœ€è¦ä¿®æ”¹å…¶ä»–å¤„ç†å™¨çš„å±æ€§</li><li>è‡ªå®šä¹‰æ³¨è§£å°†é¡ºåºä¿¡æ¯å’Œ Handlerçš„å®ç°ç»‘å®šï¼›è¿™æ ·ä¹Ÿæ— æ³•ç›´è§‚äº†è§£åˆ°ä¸€æ®µä¸šåŠ¡éƒ½æœ‰å¤šå°‘ä¸ªå¤„ç†å™¨</li><li>ç»´æŠ¤ä¸€ä¸ªè·¯ç”±è¡¨ï¼ŒåŸºäº Springçš„è‡ªåŠ¨æ³¨å…¥æ¥å®ç°å’Œç®¡ç†è·¯ç”±è¡¨ï¼Œä½¿ç”¨ä¸€ä¸ªæ‰§è¡Œå™¨è§’è‰²åªæœ‰å¤„ç†å™¨é›†åˆä½œä¸ºå…¥å£</li></ul><p><strong>æ„é€ è·¯ç”±è¡¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“è·¯ç”±çš„é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PipelineRouteConfig</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•°æ®ç±»å‹-&gt;ç®¡é“ä¸­å¤„ç†å™¨ç±»å‹åˆ—è¡¨ çš„è·¯ç”±</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span></span><br><span class="line">    Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;,</span><br><span class="line">        List&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt;&gt;&gt; PIPELINE_ROUTE_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * åœ¨è¿™é‡Œé…ç½®å„ç§ä¸Šä¸‹æ–‡ç±»å‹å¯¹åº”çš„å¤„ç†ç®¡é“ï¼šé”®ä¸ºä¸Šä¸‹æ–‡ç±»å‹ï¼Œå€¼ä¸ºå¤„ç†å™¨ç±»å‹çš„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PIPELINE_ROUTE_MAP.put(OrderVOContext.class,</span><br><span class="line">                               Arrays.asList(</span><br><span class="line">                                       CalMitigateSumHandler.class,</span><br><span class="line">                                       buildUserInfoHandler.class,</span><br><span class="line">                                       buildGoodsInfoHandler.class</span><br><span class="line">                               ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†æ¥å…¶ä»– Context çš„ç®¡é“é…ç½®</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨ Spring å¯åŠ¨æ—¶ï¼Œæ ¹æ®è·¯ç”±è¡¨ç”Ÿæˆå¯¹åº”çš„ç®¡é“æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;pipelineRouteMap&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;, List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt;&gt; getHandlerPipelineMap() &#123;</span><br><span class="line">        <span class="keyword">return</span> PIPELINE_ROUTE_MAP.entrySet()</span><br><span class="line">                                 .stream()</span><br><span class="line">                                 .collect(Collectors.toMap(Map.Entry::getKey, <span class="built_in">this</span>::toPipeline));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®ç»™å®šçš„ç®¡é“ä¸­ ContextHandler çš„ç±»å‹çš„åˆ—è¡¨ï¼Œæ„å»ºç®¡é“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt; toPipeline(</span><br><span class="line">            Map.Entry&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;, List&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;&gt;&gt;&gt; entry) &#123;</span><br><span class="line">        <span class="keyword">return</span> entry.getValue()</span><br><span class="line">                    .stream()</span><br><span class="line">                    .map(appContext::getBean)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext appContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        appContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç®¡é“æ‰§è¡Œå™¨</strong></p><p>ç®¡é“æ‰§è¡Œå™¨æ ¹æ®ä¼ å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®çš„ç±»å‹ï¼Œæ‰¾åˆ°å…¶å¯¹åº”çš„ç®¡é“ï¼Œç„¶åå°†ä¸Šä¸‹æ–‡æ•°æ®æ”¾å…¥ç®¡é“ä¸­å»è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“æ‰§è¡Œå™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PipelineExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼•ç”¨ PipelineRouteConfig ä¸­çš„ pipelineRouteMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt;,</span><br><span class="line">                List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="built_in">super</span> PipelineContext&gt;&gt;&gt; pipelineRouteMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒæ­¥å¤„ç†è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     * å¦‚æœå¤„ç†æ—¶ä¸Šä¸‹æ–‡æ•°æ®æµé€šåˆ°æœ€åä¸€ä¸ªå¤„ç†å™¨ä¸”æœ€åä¸€ä¸ªå¤„ç†å™¨è¿”å› trueï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¤„ç†è¿‡ç¨‹ä¸­ç®¡é“æ˜¯å¦ç•…é€šï¼Œç•…é€šè¿”å› trueï¼Œä¸ç•…é€šè¿”å› false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">acceptSync</span><span class="params">(PipelineContext context)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(context, <span class="string">&quot;ä¸Šä¸‹æ–‡æ•°æ®ä¸èƒ½ä¸º null&quot;</span>);</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°æ•°æ®ç±»å‹</span></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">PipelineContext</span>&gt; dataType = context.getClass();</span><br><span class="line">        <span class="comment">// è·å–æ•°æ®å¤„ç†ç®¡é“</span></span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">ContextHandler</span>&lt;? <span class="built_in">super</span> PipelineContext&gt;&gt; pipeline = pipelineRouteMap.get(dataType);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(pipeline)) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;&#123;&#125; çš„ç®¡é“ä¸ºç©º&quot;</span>, dataType.getSimpleName());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç®¡é“æ˜¯å¦ç•…é€š</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lastSuccess</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ContextHandler&lt;? <span class="built_in">super</span> PipelineContext&gt; handler : pipeline) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å½“å‰å¤„ç†å™¨å¤„ç†æ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­å‘ä¸‹å¤„ç†</span></span><br><span class="line">                lastSuccess = handler.handle(context);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                lastSuccess = <span class="literal">false</span>;</span><br><span class="line">                logger.error(<span class="string">&quot;[&#123;&#125;] å¤„ç†å¼‚å¸¸ï¼Œhandler=&#123;&#125;&quot;</span>, context.getName(), handler.getClass().getSimpleName(), ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸å†å‘ä¸‹å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (!lastSuccess) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lastSuccess;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨ç®¡é“">ä½¿ç”¨ç®¡é“</h3><p>åŸæ¥çš„ <code>buildVO</code> å¯ä»¥å¼•å…¥ç®¡é“æ¥è¿›è¡Œå®ç°äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">buildVO</span><span class="params">(OrderBo bo)</span> &#123;</span><br><span class="line">    <span class="type">OrderVOContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="built_in">this</span>.createContext(bo);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> pipelineExecutor.acceptSync(data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµç¨‹æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="keyword">return</span> CommonResponse.success(data.getInstanceId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.error(<span class="string">&quot;build vo å¤±è´¥ï¼š&#123;&#125;&quot;</span>, data.getErrorMsg());</span><br><span class="line">    <span class="keyword">return</span> CommonResponse.failed(data.getErrorMsg());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ å¤„ç†å™¨">å¢åŠ å¤„ç†å™¨</h3><p>å¦‚æœéœ€è¦åœ¨æµç¨‹ä¸­å¢åŠ æ–°ä¸šåŠ¡</p><p><strong>åˆ›å»ºæ–°çš„å¤„ç†å™¨å®ç°ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">newTaskHandler</span> <span class="keyword">implements</span> <span class="title class_">ContextHandler</span>&lt;OrderVOContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handle</span><span class="params">(InstanceBuildContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--æ‰§è¡Œæ–°ä¸šåŠ¡--&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹æ‰‹åŠ¨ç»´æŠ¤çš„é™æ€è·¯ç”±è¡¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    PIPELINE_ROUTE_MAP.put(OrderVOContext.class,</span><br><span class="line">                           Arrays.asList(</span><br><span class="line">                               CalMitigateSumHandler.class,</span><br><span class="line">                               buildUserInfoHandler.class,</span><br><span class="line">                               newTaskHandler.class, <span class="comment">// æµç¨‹ä¸­å¢åŠ äº†æ–°é€»è¾‘</span></span><br><span class="line">                               buildGoodsInfoHandler.class</span><br><span class="line">                           ));</span><br></pre></td></tr></table></figure><h3 id="å¼‚æ­¥å¤„ç†">å¼‚æ­¥å¤„ç†</h3><p>å¯¹äºæ­¥éª¤ç¹å¤šçš„ä»»åŠ¡ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬æ›´éœ€è¦çš„æ˜¯å¼‚æ­¥å¤„ç†ï¼Œæ¯”å¦‚æŸäº›è€—æ—¶é•¿çš„å®šæ—¶ä»»åŠ¡ï¼Œç®¡é“å¤„ç†å¼‚æ­¥åŒ–éå¸¸çš„ç®€å•</p><p>åœ¨ PipelineExecutor ä¸­å¼•å…¥å¼‚æ­¥çš„å¤„ç†æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡é“çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolTaskExecutor pipelineThreadPool; <span class="comment">// å¤„ç†å¼‚æ­¥çš„çº¿ç¨‹æ± </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼‚æ­¥å¤„ç†è¾“å…¥çš„ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context  ä¸Šä¸‹æ–‡æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callback å¤„ç†å®Œæˆçš„å›è°ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acceptAsync</span><span class="params">(PipelineContext context, BiConsumer&lt;PipelineContext, Boolean&gt; callback)</span> &#123;</span><br><span class="line">    pipelineThreadPool.execute(() -&gt; &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> acceptSync(context);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback.accept(context, success);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>é€šè¿‡ç®¡é“æ¨¡å¼ï¼Œå¯ä»¥å¤§å¹…é™ä½äº†ç³»ç»Ÿçš„è€¦åˆåº¦å’Œæå‡äº†å†…èšç¨‹åº¦ä¸æ‰©å±•æ€§ï¼š</p><ul><li><p>ä¼˜ç‚¹</p><ul><li><code>buildVO</code> æ‰€åœ¨çš„ç±»åªè´Ÿè´£å¤„ç†å¼•å¯¼ BOè¿›å…¥ç®¡é“çš„ä¸šåŠ¡æµç¨‹ï¼Œè€Œä¸å…³æ³¨å…·ä½“ä¸šåŠ¡é€»</li><li><code>PipelineExecutor</code> æŠ½è±¡å®šä¹‰ï¼Œä¸å…³å¿ƒä¸šåŠ¡ç»†èŠ‚</li><li>æ¯ä¸ª <code>ContextHandler</code>åªè´Ÿè´£è‡ªå·±çš„ä¸šåŠ¡ï¼Œä¸éœ€è¦çŸ¥é“é“¾è·¯ç»“æ„ï¼Œä¸å…¶ä»–å¤„ç†å™¨è§£è€¦</li><li>å¯¹äºå¤„ç†å™¨æ–°å¢ã€åˆ é™¤ã€è°ƒæ•´é¡ºåºç­‰æ“ä½œï¼Œåªéœ€è¦ä¿®æ”¹è·¯ç”±è¡¨ï¼Œå’Œä¸šåŠ¡é€»è¾‘è„±ç¦»</li></ul></li><li><p>ç¼ºç‚¹</p><ul><li>å¤§çš„ Context å¯¹è±¡ï¼Œè®©ä¸šåŠ¡æ•°æ®ç²’åº¦å¾ˆç²—ï¼ˆä¸Šå¸å¯¹è±¡ï¼‰</li><li>å’Œç­–ç•¥ä¸€æ ·ï¼Œå¯èƒ½é€ æˆå®ç°ç±»è†¨èƒ€</li><li>é”™è¯¯ä¿¡æ¯éœ€è¦ä¿å­˜åœ¨ Context å¯¹è±¡ä¸­ï¼Œèµ°å®Œæ‰€æœ‰å¤„ç†å™¨æ‰ä¼šå°†é”™è¯¯è¿”å›</li></ul></li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/370363597">è®¾è®¡æ¨¡å¼æœ€ä½³å¥—è·¯2 â€”â€”åŸºäº Spring å®ç°ç®¡é“æ¨¡å¼çš„æœ€ä½³å®è·µ - çŸ¥ä¹ (zhihu.com)</a></p><p><ahref="https://refactoringguru.cn/design-patterns/chain-of-responsibility">è´£ä»»é“¾è®¾è®¡æ¨¡å¼ï¼ˆèŒè´£é“¾æ¨¡å¼ï¼‰(refactoringguru.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQ æœ€ä½³å®è·µ</title>
      <link href="/%E5%BC%80%E5%8F%91/MQ/RocketMQ%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"/>
      <url>/%E5%BC%80%E5%8F%91/MQ/RocketMQ%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html</url>
      
        <content type="html"><![CDATA[<h1 id="topic-ä¸-tag">Topic ä¸ Tag</h1><p>åœ¨ RocketMQ ä¸­ï¼ŒTopic å’Œ Tag éƒ½æ˜¯ä¸šåŠ¡ä¸Šç”¨æ¥å½’ç±»çš„æ ‡è¯†ï¼Œé€šè¿‡åˆç†çš„ä½¿ç”¨Topic å’Œ Tag å¯ä»¥è®©ä¸šåŠ¡ç»“æ„æ¸…æ™°ï¼Œæ›´å¯ä»¥æé«˜æ•ˆç‡</p><p><strong>Topic</strong> æ˜¯æ¶ˆæ¯ä¸»é¢˜ï¼Œé€šè¿‡ Topicå¯¹ä¸åŒçš„ä¸šåŠ¡æ¶ˆæ¯è¿›è¡Œåˆ†ç±» <strong>Tag</strong>æ˜¯æ¶ˆæ¯æ ‡ç­¾ï¼Œç”¨æ¥è¿›ä¸€æ­¥åŒºåˆ†æŸä¸ª Topicä¸‹çš„æ¶ˆæ¯åˆ†ç±»ï¼Œæ˜¯æ¶ˆæ¯ç”Ÿäº§æ—¶å³ç”±æ¶ˆæ¯ç”Ÿäº§è€…è®¾ç½®çš„å±æ€§</p><p>Topic å’Œ Tag çš„é€‰æ‹©ï¼Œå»ºè®®ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢åˆ¤æ–­ï¼š</p><ul><li><strong>æ¶ˆæ¯ç±»å‹æ˜¯å¦ä¸€è‡´ï¼š</strong>æ™®é€šæ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ï¼›ä¸åŒæ¶ˆæ¯ä½¿ç”¨ä¸åŒçš„Topicï¼Œæ— æ³•é€šè¿‡ Tag è¿›è¡ŒåŒºåˆ†</li><li><strong>ä¸šåŠ¡æ˜¯å¦ç›¸å…³è”ï¼š</strong>æ²¡æœ‰å…³è”çš„ä¸šåŠ¡åº”è¯¥ä½¿ç”¨ä¸åŒçš„Topic</li><li><strong>æ¶ˆæ¯ä¼˜å…ˆçº§æ˜¯å¦ä¸€è‡´ï¼š</strong>åŒä¸€ä¸ª Topicå†…åº”è¯¥æ˜¯åŒæ ·ä¼˜å…ˆçº§çš„æ¶ˆæ¯</li><li><strong>é‡çº§æ˜¯å¦ç›¸å½“ï¼š</strong>ä¸šåŠ¡é‡å°ä½†å®æ—¶æ€§é«˜çš„æ¶ˆæ¯å’Œä¸šåŠ¡é‡å¤§çš„æ¶ˆæ¯æ”¾åœ¨ä¸€ä¸ªTopic å†…ï¼Œå¯èƒ½ä¼šå¯¼è‡´é¥¥é¥¿</li></ul><p>ä»¥ç”µå•†ç³»ç»Ÿä¸ºä¾‹ï¼Œè®¢å•æ¶ˆæ¯å’Œæ”¯ä»˜æ¶ˆæ¯å±äºä¸åŒçš„ä¸šåŠ¡ï¼Œè®¾ç½® TOPIC_ORDER å’ŒTOPIC_PAY å…¶ä¸­è®¢å•æ¶ˆæ¯æ ¹æ®å•†å“ç§ç±»å†åˆ’åˆ†ä¸ºä¸åŒçš„tagï¼Œä¾‹å¦‚ç”µå™¨ç±»ã€æœè£…ç±»ã€å›¾ä¹¦ç±»ç­‰æ”¯ä»˜æ¶ˆæ¯æ ¹æ®ä¸åŒçš„æ”¯ä»˜æ¸ é“åˆ’åˆ†ï¼Œä¾‹å¦‚é“¶è¡Œå¡ã€æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ç­‰</p><h1 id="æ¶ˆè´¹å¹‚ç­‰">æ¶ˆè´¹å¹‚ç­‰</h1><p>ä¸ºäº†é˜²æ­¢æ¶ˆæ¯é‡å¤æ¶ˆè´¹å¯¼è‡´ä¸šåŠ¡å¤„ç†å¼‚å¸¸ï¼ŒRocketMQæ¶ˆè´¹è€…åœ¨æ¥æ”¶æ¶ˆæ¯åï¼Œæœ‰å¿…è¦æ ¹æ®ä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Key å¯¹æ¶ˆæ¯è¿›è¡Œå¹‚ç­‰å¤„ç†</p><p>ä¸ªäººè®¤ä¸ºéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Keyï¼Œæ— è®ºæ˜¯åœ¨ Consumerå±‚åšå»é‡å®ç°ä¸šåŠ¡å¹‚ç­‰ï¼ˆå»é‡è¡¨ï¼‰ï¼Œè¿˜æ˜¯ä¸šåŠ¡é€»è¾‘ä¸Šåšå¹‚ç­‰ï¼ˆçŠ¶æ€æœºã€ç‰ˆæœ¬æ ¡éªŒï¼‰ï¼Œéƒ½åº”è¯¥æ˜¯ä½¿ç”¨ä¸šåŠ¡æ„ä¹‰ä¸Šçš„å”¯ä¸€æ ‡è¯†ï¼Œè€Œä¸æ˜¯ä¾èµ–Message ID</p><p><strong>æ¶ˆæ¯é‡å¤çš„åœºæ™¯</strong></p><ul><li><strong>Producer ç«¯ï¼š</strong>å‘é€æ¶ˆæ¯æ—¶ï¼ŒBrockerå·²ç»æ”¶åˆ°æ¶ˆæ¯å¹¶æŒä¹…åŒ–ï¼Œä½† ACKç”±äºç½‘ç»œåŸå› æœªæˆåŠŸè¿”å›ç»™ç”Ÿäº§è€…ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œç”Ÿäº§è€…ä¼šå†ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼›æˆ–è€…ä¸Šæ¸¸ä¸šåŠ¡è®¤ä¸ºå¤±è´¥é‡æ–°è¿›è¡Œäº†è°ƒç”¨ï¼Œå°±å¯èƒ½ä¼šå‘é€é‡å¤çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”æ˜¯ä¸åŒçš„Message ID</li><li><strong>Brocker ç«¯ï¼š</strong>æŠ•é€’æ¶ˆæ¯ç»™æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…çš„ offsetå› ä¸ºç½‘ç»œç­‰åŸå› æäº¤å¤±è´¥ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯è‡³å°‘ä¸€æ¬¡ï¼ŒBrockerä¼šå†æ¬¡æŠ•é€’æ¶ˆæ¯</li><li><strong>Consumer ç«¯ï¼š</strong>æœåŠ¡æ‰©ç¼©å®¹å¯¼è‡´çš„ rebalanceæ“ä½œï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯æ¶ˆè´¹è€…çš„ offset æ²¡æœ‰åŠæ—¶æäº¤</li></ul><p>å› ä¸ºä¸åŒçš„ Message IDå¯¹åº”çš„æ¶ˆæ¯å†…å®¹å¯èƒ½ç›¸åŒï¼Œæœ‰å¯èƒ½å‡ºç°å†²çªï¼ˆé‡å¤ï¼‰çš„æƒ…å†µï¼Œæ‰€ä»¥çœŸæ­£å®‰å…¨çš„å¹‚ç­‰å¤„ç†ï¼Œä¸å»ºè®®ä»¥Message ID ä½œä¸ºå¤„ç†ä¾æ®</p><p>æœ€å¥½çš„æ–¹å¼æ˜¯ä»¥ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ä½œä¸ºå¹‚ç­‰å¤„ç†çš„å…³é”®ä¾æ®ï¼Œè€Œä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å¯ä»¥é€šè¿‡æ¶ˆæ¯Key è®¾ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">consumer.subscribe(<span class="string">&quot;ons_test&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="keyword">new</span> <span class="title class_">MessageListener</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> message.getKey()</span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸šåŠ¡å”¯ä¸€æ ‡è¯†çš„ Key åšå¹‚ç­‰å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="è®¢é˜…å…³ç³»">è®¢é˜…å…³ç³»</h1><p>è®¢é˜…å…³ç³»éœ€è¦ä¿æŒä¸€è‡´ï¼Œä¸€è‡´çš„å®šä¹‰æ˜¯ï¼š<strong>åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸‹æ‰€æœ‰Consumer å®ä¾‹æ‰€è®¢é˜…çš„ Topicã€Tagã€Tag çš„é¡ºåºå¿…é¡»å®Œå…¨ä¸€è‡´</strong></p><p>å¦‚æœè®¢é˜…å…³ç³»ä¸ä¸€è‡´ï¼Œæ¶ˆæ¯æ¶ˆè´¹çš„é€»è¾‘å°±ä¼šæ··ä¹±ï¼Œç”šè‡³å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</p><p><strong>ä¸ºä»€ä¹ˆä¼šä¸¢å¤±ï¼Ÿ</strong></p><p>å½“ä¸€ä¸ª Consumer æ¶ˆè´¹ä¸€ä¸ª Queue æ—¶ï¼Œä¼šåœ¨ ConsumerQueueä¸­ä¿å­˜è¯¥æ¶ˆè´¹è€…å’Œæ¶ˆæ¯çš„ç›¸å…³ä¿¡æ¯</p><p>ConsumerQueue ä¸­ä¿å­˜äº†å¦‚ä¸‹ä¿¡æ¯ï¼š</p><ul><li>å‰ 8 ä¸ªå­—èŠ‚è®°å½•æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„åç§»é‡</li><li>ä¸­é—´ 4 ä¸ªå­—èŠ‚è®°å½•æ¶ˆæ¯å¤§å°</li><li>æœ€å 8 ä¸ªå­—èŠ‚è®°å½•æ¶ˆæ¯ä¸­ tag çš„ hashcode</li></ul><p>å‡å¦‚ä¸€ä¸ª Consumer è®¢é˜…äº† Topic1 ä¸­çš„ Tag1ï¼Œé‚£è¿™ä¸ª Consumeræ‹‰å–æ¶ˆæ¯æ—¶ï¼Œé¦–å…ˆä» Name Server è·å–è®¢é˜…å…³ç³»ï¼Œå¾—åˆ°å½“å‰ Consumerè®¢é˜…çš„æ‰€æœ‰ tag çš„ hashcode é›†åˆ codeSetï¼›æ¯æ¬¡ä» ConsumerQueueè·å–ä¸€æ¡è®°å½•ï¼Œå°±è¦åˆ¤æ–­æœ€å 8 ä¸ªå­—èŠ‚ tag hashcode æ˜¯å¦åœ¨ codeSet ä¸­ï¼Œæ¯”å¦‚Tag2 ä¸åœ¨ codeSet ä¸­ï¼Œå°±ä¼šè¢«è¿‡æ»¤æ‰</p><p>æ‰€ä»¥ä¸æ­£ç¡®çš„è®¢é˜…å…³ç³»ä¼šå¯¼è‡´è¯¥ ConsumerQueue ä¸­çš„æ¶ˆæ¯è¢«é”™è¯¯ä¸¢å¼ƒäº†</p><h1 id="æ¶ˆæ¯å †ç§¯">æ¶ˆæ¯å †ç§¯</h1><p>å½“å®¢æˆ·ç«¯æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸ŠæœåŠ¡ç«¯æ¶ˆæ¯å‘é€çš„é€Ÿåº¦ï¼Œä¾¿ä¼šå‡ºç°æ¶ˆæ¯å †ç§¯</p><p>æ¶ˆæ¯å †ç§¯çš„ä¸»è¦å½±å“ï¼š</p><ul><li>æ¶ˆè´¹å»¶è¿Ÿ</li><li>ç”Ÿäº§è€…æ— æ³•æˆåŠŸå‘é€æ¶ˆæ¯ï¼ˆæ— æ³•ç”Ÿäº§ï¼‰</li></ul><p>ä»¥ä¸‹åœºæ™¯éœ€è¦ç€é‡å…³æ³¨æ¶ˆæ¯å †ç§¯å’Œå»¶è¿Ÿé—®é¢˜ï¼š</p><ul><li>ä¸šåŠ¡ç³»ç»Ÿä¸Šä¸‹æ¸¸èƒ½åŠ›ä¸åŒ¹é…é€ æˆçš„æŒç»­å †ç§¯ï¼Œä¸”æ— æ³•è‡ªè¡Œæ¢å¤</li><li>ä¸šåŠ¡ç³»ç»Ÿå¯¹æ¶ˆæ¯çš„æ¶ˆè´¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼Œå³ä½¿æ˜¯çŸ­æš‚çš„å †ç§¯é€ æˆçš„æ¶ˆæ¯å»¶è¿Ÿä¹Ÿæ— æ³•æ¥å—</li></ul><p>å®¢æˆ·ç«¯ Push æ¨¡å¼åˆ°æ¶ˆè´¹æ¶ˆæ¯æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š</p><ul><li><strong>è·å–æ¶ˆæ¯ï¼š</strong>é€šè¿‡é•¿è½®è¯¢æ‰¹é‡æ‹‰å–çš„æ–¹å¼ä» Brockeræ‹‰å–æ¶ˆæ¯ï¼Œè¿™ä¸€é˜¶æ®µååé‡è¾ƒé«˜ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆ</li><li><strong>æ¶ˆè´¹ &amp;æäº¤ï¼š</strong>ä¾èµ–ä¸šåŠ¡çš„å¤„ç†è€—æ—¶å’Œæ¶ˆè´¹é€»è¾‘çš„å¹¶å‘åº¦</li></ul><p>æ‰€ä»¥é€šè¿‡æ¶ˆæ¯æ¶ˆè´¹çš„ä¸¤å¤§æ­¥éª¤æ¥çœ‹ï¼Œæ¶ˆæ¯å †ç§¯çš„ä¸»è¦é—®é¢˜å‡ºç°åœ¨ç¬¬äºŒé˜¶æ®µï¼Œå³<strong>æ¶ˆè´¹è€—æ—¶</strong>å’Œ<strong>æ¶ˆè´¹å¹¶å‘åº¦</strong></p><p><strong>æ¶ˆè´¹è€—æ—¶</strong></p><p>å½±å“æ¶ˆè´¹è€—æ—¶çš„æ¶ˆè´¹é€»è¾‘ä¸»è¦åˆ†ä¸º CPU å†…å­˜è®¡ç®—å’Œå¤–éƒ¨ IOæ“ä½œï¼›ç”±äºå¤§éƒ¨åˆ†æœåŠ¡å™¨åœºæ™¯éƒ½æ˜¯ IOå¯†é›†å‹ï¼Œä¸šåŠ¡ä»£ç åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæ¶‰åŠå¤æ‚çš„è¿ç®—ï¼Œå†…éƒ¨è€—æ—¶ç›¸æ¯” IOè€—æ—¶æ¥è¯´å¯ä»¥å¿½ç•¥ä¸è®°</p><p>IO æ“ä½œé€šå¸¸åŒ…å«ä»¥ä¸‹é€»è¾‘ï¼š</p><ul><li>è¯»å†™å¤–éƒ¨æ•°æ®åº“ï¼Œä¾‹å¦‚ MySQL</li><li>è¯»å†™å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿï¼Œä¾‹å¦‚ Redis</li><li>ä¸‹æ¸¸ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚ Dubbo è°ƒç”¨æˆ–è€…ä¸‹æ¸¸ HTTP æ¥å£è°ƒç”¨</li></ul><p><strong>æ¶ˆè´¹å¹¶å‘åº¦</strong></p><p>ä¸åŒçš„æ¶ˆæ¯ç±»å‹å¯¹åº”ä¸åŒçš„å¹¶å‘åº¦é…ç½®ç­–ç•¥</p><table><thead><tr class="header"><th>æ¶ˆæ¯ç±»å‹</th><th>å¹¶å‘åº¦</th></tr></thead><tbody><tr class="odd"><td>æ™®é€šæ¶ˆæ¯</td><td>å•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡</td></tr><tr class="even"><td>å®šæ—¶å’Œå»¶æ—¶æ¶ˆæ¯</td><td>å•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡</td></tr><tr class="odd"><td>äº‹åŠ¡æ¶ˆæ¯</td><td>å•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡</td></tr><tr class="even"><td>é¡ºåºæ¶ˆæ¯</td><td>Minï¼ˆå•èŠ‚ç‚¹çº¿ç¨‹æ•° Ã— èŠ‚ç‚¹æ•°é‡ï¼Œåˆ†åŒºæ•°ï¼‰</td></tr></tbody></table><p>æ­¤å¤–å•èŠ‚ç‚¹çš„å¹¶å‘åº¦éœ€è¦è°¨æ…è®¾ç½®ï¼Œä¸èƒ½ç›²ç›®ç›´æ¥è°ƒå¤§çº¿ç¨‹æ•°ï¼Œè®¾ç½®è¿‡å¤§çš„çº¿ç¨‹æ•°åè€Œä¼šå¸¦æ¥å¤§é‡çš„çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€</p><p>ç†æƒ³ç¯å¢ƒä¸‹å•èŠ‚ç‚¹çš„æœ€ä¼˜çº¿ç¨‹æ•°è®¡ç®—æ¨¡å‹å¦‚ä¸‹ï¼š</p><ul><li>å•æœº CPU æ ¸æ•°ä¸º C</li><li>çº¿ç¨‹åˆ‡æ¢è€—æ—¶å¿½ç•¥ä¸è®¡ï¼ŒIO æ“ä½œä¸æ¶ˆè€— CPU</li><li>çº¿ç¨‹æœ‰è¶³å¤Ÿæ¶ˆæ¯ç­‰å¾…å¤„ç†ï¼Œä¸”å†…å­˜å……è¶³</li><li>é€»è¾‘ä¸­ CPU è®¡ç®—è€—æ—¶ä¸º T1ï¼Œå¤–éƒ¨ IO æ“ä½œä¸º T2</li></ul><p>åˆ™å•ä¸ªçº¿ç¨‹èƒ½è¾¾åˆ°çš„ TPS ä¸º<code>1 / (T1 + T2)</code>ï¼Œå¦‚æœCPUä½¿ç”¨ç‡è¾¾åˆ°ç†æƒ³çŠ¶æ€100%ï¼Œé‚£ä¹ˆå•æœºè¾¾åˆ°æœ€å¤§èƒ½åŠ›æ—¶éœ€è¦è®¾ç½® <code>C Ã— (T1 + T2) / T1</code>ä¸ªçº¿ç¨‹</p><h1 id="è¯»å†™é˜Ÿåˆ—">è¯»å†™é˜Ÿåˆ—</h1><p>æ–°å»º Topic éœ€è¦é…ç½®ç›¸å…³çš„å±æ€§ <code>writeQueueNums</code> å’Œ<code>readQueueNums</code>ï¼Œåˆ†åˆ«ä»£è¡¨å†™é˜Ÿåˆ—çš„æ•°é‡å’Œè¯»é˜Ÿåˆ—çš„æ•°é‡</p><p>å…¶ä¸­ <code>writeQueueNums</code> å’Œ <code>readQueueNums</code>çš„å‚æ•°å¯ä»¥è‡ªç”±é…ç½®ï¼Œ<strong>ä¸ºä»€ä¹ˆå¯ä»¥è‡ªç”±é…ç½®å‘¢è€Œä¸æ˜¯å¿…é¡»ç›¸ç­‰å‘¢ï¼Ÿ</strong></p><blockquote><p><strong>å¤‡æ³¨</strong>ï¼šè¯»å†™é˜Ÿåˆ—å’Œè¯»å†™åˆ†ç¦»ä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µ</p><p>è¯»å†™åˆ†ç¦»æŒ‡çš„æ˜¯ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å…³äºè¯»å†™è¯·æ±‚åˆ†é…çš„é—®é¢˜</p><p>è¯»å†™é˜Ÿåˆ—åœ¨åšè·¯ç”±ä¿¡æ¯æ—¶ä½¿ç”¨ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶ï¼Œä½¿ç”¨å†™é˜Ÿåˆ—ä¸ªæ•°è¿”å›è·¯ç”±ä¿¡æ¯ï¼Œè€Œæ¶ˆæ¯æ¶ˆè´¹æ—¶æŒ‰ç…§è¯»é˜Ÿåˆ—ä¸ªæ•°è¿”å›è·¯ç”±ä¿¡æ¯ï¼Œåœ¨ç‰©ç†æ–‡ä»¶å±‚é¢ï¼Œåªæœ‰å†™é˜Ÿåˆ—æ‰ä¼šåˆ›å»ºæ–‡ä»¶</p></blockquote><p><strong>è¯»å†™é˜Ÿåˆ—æ•°é‡ä¸åŒ¹é…æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ</strong></p><ul><li>å†™å¤šè¯»å°‘ï¼šå¤šå‡ºæ¥çš„å†™é˜Ÿåˆ—æ— æ³•è¢«æ¶ˆè´¹</li><li>è¯»å¤šå†™å°‘ï¼šConsumerå¯¹åº”çš„å¤šå‡ºæ¥çš„è¯»é˜Ÿåˆ—æ²¡æœ‰æ¶ˆæ¯ï¼Œä¹Ÿå°±ä¸ä¼šä»è¯¥è¯»é˜Ÿåˆ—æ¶ˆè´¹ä»»ä½•æ¶ˆæ¯</li></ul><p><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡</strong></p><p>è®¾ç½®è¯»å†™é˜Ÿåˆ—æ•°çš„ç›®çš„åœ¨äºæ–¹ä¾¿é˜Ÿåˆ—çš„ç¼©å®¹å’Œæ‰©å®¹</p><p>ä¸€ä¸ª Topic åœ¨æ¯ä¸ª Brocker ä¸Šåˆ›å»ºäº† 128 ä¸ªé˜Ÿåˆ—ï¼Œç°åœ¨éœ€è¦å°†é˜Ÿåˆ—ç¼©å®¹åˆ°64 ä¸ªï¼Œæ€ä¹ˆåšæ‰èƒ½ 100% ä¸ä¼šä¸¢å¤±æ¶ˆæ¯ï¼Œå¹¶ä¸”æ— éœ€é‡å¯åº”ç”¨ç¨‹åº</p><p>è§£å†³åŠæ³•ï¼š</p><ol type="1"><li>å…ˆå°†å†™é˜Ÿåˆ—ç¼©å®¹ï¼ˆ128 è°ƒæ•´ä¸º 64ï¼‰ï¼›åç»­æ•°æ®è¯·æ±‚ä¼šè¿›å…¥ 0 è‡³ 63çš„å†™é˜Ÿåˆ—ä¸­ï¼Œç”±ä¹‹å‰çš„ Consumer è¿›è¡Œæ¶ˆè´¹</li><li>ç­‰å¾… 64 è‡³ 127 é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¢«æ¶ˆè´¹å®Œæˆ</li><li>ç¼©å®¹è¯»é˜Ÿåˆ—ï¼ˆ128 è°ƒæ•´ä¸º 64ï¼‰ï¼›æ­¤æ—¶ Consumer é‡æ–°åˆ†é…ï¼Œå¯¹åº” 64ä¸ªå†™é˜Ÿåˆ—</li></ol><p><strong>åŒæ—¶ç¼©å®¹å†™é˜Ÿåˆ—å’Œè¯»é˜Ÿåˆ—å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†æ¶ˆæ¯æœªè¢«æ¶ˆè´¹</strong></p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://help.aliyun.com/document_detail/69109.html">æœ€ä½³å®è·µ(aliyun.com)</a></p><p><ahref="https://www.cnblogs.com/liaowenhui/p/15717353.html">RocketMQè®¢é˜…å…³ç³»ä¸ä¸€è‡´- JustJavaIt - åšå®¢å›­ (cnblogs.com)</a></p><p><ahref="https://blog.csdn.net/qian_348840260/article/details/108975241">rocketmqä¸­çš„è¯»å†™é˜Ÿåˆ—_å…«è’å…­åˆå”¯æˆ‘ç‹¬å°Š-CSDNåšå®¢_rocketmqè¯»å†™é˜Ÿåˆ—</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> MQ </category>
          
          <category> RocketMQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES cardinality å’Œ HyperLogLog</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20cardinality%20%E5%92%8C%20HyperLogLog.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20cardinality%20%E5%92%8C%20HyperLogLog.html</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºæ•°èšåˆ">åŸºæ•°èšåˆ</h1><p>åŸºæ•°èšåˆå±äºèšåˆä¸­çš„åº¦é‡èšåˆï¼Œè®¡ç®—ä¸åŒå€¼çš„<strong>è¿‘ä¼¼è®¡æ•°</strong></p><p>éœ€è¦æ³¨æ„ï¼Œèšåˆå‡ºçš„ç»“æœæ˜¯ä¸€ä¸ªè¿‘ä¼¼å€¼ï¼ŒåŸå› æ˜¯åº•å±‚ç»“æ„ä½¿ç”¨çš„HyperLogLogï¼Œå…·æœ‰ä¸€å®šè¯¯å·®</p><h2 id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</h2><p>å‡å®š index å­˜å‚¨çš„å”®å–æ•°æ®ï¼Œå¸Œæœ›æŸ¥è¯¢æœ‰å¤šå°‘ç§ä¸åŒçš„å•†å“ç±»å‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /sales/_search?size=<span class="number">0</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¹‹å‰çš„å­¦ç”Ÿ index ä¸ºä¾‹ï¼ŒæŸ¥è¯¢æœ‰å‡ ä¸ªç­çº§ä¸‹æœ‰å¥³å­¦ç”Ÿ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;female&quot;</span> <span class="comment">// ç»“æœé›†æŸ¥è¯¢æ€§åˆ«ä¸ºå¥³æ€§</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="comment">// ä¸å…³æ³¨ hits ç»“æœé›†</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;class_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœï¼Œé€‰å– <code>hits</code> å’Œ <code>aggregations</code>éƒ¨åˆ†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;class_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å› ä¸º <code>size</code> ä¸º 0ï¼Œæ‰€ä»¥ <code>hits</code>ä¸­æ²¡æœ‰è¿”å›çš„æ–‡æ¡£</p><p><code>aggregations</code> ä¸‹è‡ªå®šä¹‰ç»“æœé›†åç§° <code>class_count</code>è¿”å›çš„å€¼ä¸º 2ï¼Œè¯´æ˜ç­çº§ä¸‹æœ‰å¥³å­¦ç”Ÿçš„ç­çº§æ•°é‡ä¸º 2</p><h2 id="è¿‘ä¼¼å€¼ä¸ç²¾ç¡®é˜ˆå€¼å‚æ•°">è¿‘ä¼¼å€¼ä¸ç²¾ç¡®é˜ˆå€¼å‚æ•°</h2><p>ç”±äºè¿”å›ç»“æœæ˜¯ä¸€ä¸ªè¿‘ä¼¼å€¼ï¼Œæ‰€ä»¥ <code>cardinality</code> æ”¯æŒ<code>precision_threshold</code> å‚æ•°ï¼Œç”¨æ¥è®¾ç½®ç²¾ç¡®é˜ˆå€¼</p><p>é˜ˆå€¼å‚æ•°çš„æœ¬è´¨æ˜¯ä½¿ç”¨ç©ºé—´æ¢å–å‡†ç¡®æ€§ï¼Œé»˜è®¤æ˜¯ 3000ï¼Œæœ€å¤§æ”¯æŒ 40000ï¼Œè¶…è¿‡40000 çš„è®¾ç½®ä¸ºæŒ‰ç…§ 40000 æ¥å¤„ç†</p><p>ä½äºé˜ˆå€¼çš„è®¡æ•°æ›´ç¬¦åˆå‡†ç¡®å€¼ï¼Œé«˜äºé˜ˆå€¼çš„è®¡æ•°åˆ™ä¼šæ›´åŠ æ¨¡ç³Š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;female&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;class_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;precision_threshold&quot;</span><span class="punctuation">:</span> <span class="number">200000</span> <span class="comment">// ç²¾åº¦é˜ˆå€¼ï¼Œäº‹å®ä¸Šå†…éƒ¨å°†è¯¥å‚æ•°è§†ä¸º 40000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è®¡ç®—ç²¾ç¡®çš„è®¡æ•°éœ€è¦å°†å€¼åŠ è½½è‡³å“ˆå¸Œé›†åˆå¹¶è¿”å›å¤§å°ï¼Œå½“åŸºæ•°ç‰¹åˆ«å¤§æ—¶ï¼Œéœ€è¦å ç”¨éå¸¸å¤šèµ„æº</p><p>æ‰€ä»¥ ES é€‰æ‹© HyperLogLog ç®—æ³•æ¥å®ç°<code>cardinality</code>ï¼Œè¿™ç§æ–¹å¼åŸºäºå€¼çš„å“ˆå¸Œè®¡æ•°ï¼Œæœ‰ä¸€äº›ç‰¹æ€§ï¼š</p><ul><li>å¯é…ç½®çš„ç²¾åº¦ï¼Œå¯ä»¥é€‰æ‹©ç”¨å†…å­˜æ¢å–ç²¾åº¦</li><li>ä½åŸºæ•°é›†åˆä¸­æ˜¯ç²¾å‡†çš„</li><li>å›ºå®šçš„å†…å­˜ä½¿ç”¨ç‡ï¼Œæ— è®ºå”¯ä¸€å€¼æœ‰å¤šå°‘ï¼Œåªå–å†³äºè®¾ç½®çš„ç²¾åº¦</li></ul><p>HyperLogLog + +ç®—æ³•ä¾èµ–äºæ•£åˆ—å€¼çš„å‰å¯¼é›¶ï¼Œæ•°æ®é›†ä¸­æ•£åˆ—çš„ç²¾ç¡®åˆ†å¸ƒä¼šå½±å“åŸºæ•°çš„å‡†ç¡®æ€§</p><p>ESå®˜æ–¹æ–‡æ¡£æä¾›çš„æ•°æ®æ˜¾ç¤ºï¼Œå…·ä½“çš„å‡†ç¡®æ€§å–å†³äºæ•°æ®é›†æƒ…å†µï¼Œä½†å¤§éƒ¨åˆ†åœºæ™¯çš„å‡†ç¡®æ€§éƒ½è¿˜æ˜¯è‰¯å¥½çš„ï¼Œ<strong>å³ä½¿é˜ˆå€¼è®¾ç½®ä¸º100ï¼Œåœ¨ç™¾ä¸‡ã€åƒä¸‡åŸºæ•°ä¸‹ï¼Œè¯¯å·®èŒƒå›´ä¹Ÿæ§åˆ¶åœ¨äº† 1% ~ 6%ï¼›å½“é˜ˆå€¼è®¾ç½®ä¸º10000ï¼Œè¯¯å·®åŸºæœ¬åœ¨ 1% å·¦å³</strong></p><h2 id="è„šæœ¬-runtime-field">è„šæœ¬ runtime field</h2><p><code>cardinality</code>åƒå…¶ä»–èšåˆæ“ä½œä¸€æ ·ï¼Œæ˜¯å¯ä»¥ä½¿ç”¨è„šæœ¬æ‹¼æ¥å­—æ®µçš„</p><p>å¦‚æœå¸Œæœ›å¯¹ä¸¤ä¸ªå­—æ®µçš„ç»„åˆè¿›è¡Œæ“ä½œï¼Œåˆ›å»ºä¸€ä¸ª runtime fieldç»„åˆä»–ä»¬ç„¶åè¿›è¡ŒåŸºæ•°èšåˆ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;runtime_mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender_and_age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="string">&quot;emit(doc[&#x27;gender&#x27;].value + &#x27;&amp;&#x27; + doc[&#x27;age&#x27;].value)&quot;</span> <span class="comment">// æ‹¼æ¥ gender å’Œ age å­—æ®µ</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type_promoted_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;cardinality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gender_and_age&quot;</span> <span class="comment">// æ ¹æ® runtime field è¿›è¡ŒåŸºæ•°æ“ä½œ</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœæ˜¯ 6ï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªæ–‡æ¡£çš„ runtime field<code>gender_and_age</code> å€¼éƒ½ä¸º <code>male&amp;20</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type_promoted_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="hyperloglog">HyperLogLog</h1><p>HyperLogLogæ˜¯ä¸€ç§åŸºæ•°è®¡æ•°çš„ç®—æ³•ï¼Œæ—¨åœ¨ä½¿ç”¨è¾ƒå°‘å†…å­˜çš„æƒ…å†µä¸‹å¾—åˆ°åŸºæ•°æ•°é‡çš„è¿‘ä¼¼ç²¾ç¡®å€¼</p><h2 id="åŸºæ•°è®¡æ•°æ–¹å¼">åŸºæ•°è®¡æ•°æ–¹å¼</h2><p>åŸºæ•°è®¡æ•°ï¼ˆcardinalitycountingï¼‰é€šå¸¸ç”¨æ¥ç»Ÿè®¡ä¸€ä¸ªé›†åˆä¸­ä¸é‡å¤çš„å…ƒç´ ä¸ªæ•°ï¼Œä¾‹å¦‚ç»Ÿè®¡æŸä¸ªç½‘ç«™çš„UVï¼Œæˆ–è€…ç”¨æˆ·æœç´¢ç½‘ç«™çš„å…³é”®è¯æ•°é‡ç­‰</p><p>å¦‚ä½•è®¡ç®—è®¡æ•°å¸¸è§çš„æœ‰å¤šç§æ–¹å¼</p><ul><li>B æ ‘<ul><li>åˆ©ç”¨æ ‘å­˜å‚¨å…·ä½“å…ƒç´ </li><li>ä¼˜ç‚¹ï¼šæ’å…¥å’ŒæŸ¥æ‰¾æ•ˆç‡é«˜ï¼Œç»Ÿè®¡æ•°æ®æ—¶å¯ä»¥å¿«é€Ÿåšåˆ°è®°å½•ä¸å»é‡ï¼Œè®¡ç®—åŸºæ•°æ—¶åªéœ€è¦ç»Ÿè®¡å¶å­èŠ‚ç‚¹ä¸ªæ•°å³å¯</li><li>ç¼ºç‚¹ï¼šæ²¡æœ‰èŠ‚çœå†…å­˜ï¼Œéœ€è¦å­˜å‚¨æ•°æ®å…¨é›†</li></ul></li><li>bitmap<ul><li>ä½¿ç”¨ bit ä½è¿›è¡Œæ ‡è®°ï¼Œå³æŠ›å¼ƒå…·ä½“å…ƒç´ å†…å®¹åªå­˜å‚¨ç‰¹å¾å€¼</li><li>ä¼˜ç‚¹ï¼šèŠ‚çº¦å†…å­˜ï¼Œç»“æœå¯ä»¥è¿›è¡Œæ–¹ä¾¿çš„ä½è¿ç®—æ“ä½œï¼ˆåˆå¹¶ - ä¸ï¼Œå·®é›† -æˆ–ï¼‰</li><li>ç¼ºç‚¹ï¼šç©ºé—´å ç”¨ä»ç„¶è¾ƒå¤§</li></ul></li><li>æ¦‚ç‡ç®—æ³•<ul><li>ç›®å‰ç”¨äºåŸºæ•°è®¡æ•°çš„æ¦‚ç‡ç®—æ³•æœ‰ï¼šLCã€LLCã€HLL ç­‰</li><li>ä¼˜ç‚¹ï¼šLLã€HLL ç­‰èƒ½å¤Ÿåœ¨ç©ºé—´æ›´å°çš„æƒ…å†µä¸‹è¿›è¡ŒåŸºæ•°è®¡ç®—</li><li>ç¼ºç‚¹ï¼šæœ‰ä¸€å®šè¯¯å·®</li></ul></li></ul><h2 id="hll">HLL</h2><p>HLL ä¸­å®é™…å­˜å‚¨çš„æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º m çš„å¤§æ•°ç»„ Sï¼Œå°†å¾…ç»Ÿè®¡çš„æ•°æ®é›†åˆåˆ’åˆ†æˆ mç»„ï¼Œæ¯ç»„æ ¹æ®ç®—æ³•è®°å½•ä¸€ä¸ªç»Ÿè®¡å€¼å­˜å…¥æ•°ç»„ä¸­</p><p>æ•°ç»„çš„å¤§å° m ç”±ç®—æ³•å®ç°æ–¹è‡ªå·±ç¡®å®šï¼ŒRedis ä¸­è¿™ä¸ªæ•°ç»„çš„å¤§å°æ˜¯ 16834ï¼Œmè¶Šå¤§è¯¯å·®è¶Šå°ï¼Œä½†éœ€è¦çš„å†…å­˜ç©ºé—´ä¹Ÿè¶Šå¤§</p><p>HLL çš„æ•°å­¦åŸç†çœ‹ä¸æ‡‚ï¼Œå¤§è‡´å°±æ˜¯ n é‡ä¼¯åŠªåˆ©åŸç†</p><p>é€šè¿‡å¤šæ¬¡æŠ›ç¡¬å¸ï¼Œç›´åˆ°æŠ›åˆ°æ­£é¢ä¸ºæ­¢ï¼Œè¿™æ˜¯ä¸€æ¬¡ä¼¯åŠªåˆ©è¿‡ç¨‹ï¼›å½“ä¸€ç›´æŠ›ç¡¬å¸ï¼Œç›´åˆ°å¤šæ¬¡å‡ºç°æ­£é¢ï¼Œå°†å‡ºç°æ­£é¢çš„æŠ•æ·æ¬¡æ•°å€¼è®°ä¸ºk1ã€k2ã€k3...knï¼Œæœ€å¤§å€¼è®°ä¸º kmaxï¼Œé‚£ä¹ˆå¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š</p><ul><li>n æ¬¡ä¼¯åŠªåˆ©è¿‡ç¨‹çš„æŠ•æ·æ¬¡æ•°éƒ½ä¸å¤§äº kmax</li><li>n æ¬¡ä¼¯åŠªåˆ©è¿‡ç¨‹ï¼Œè‡³å°‘æœ‰ä¸€æ¬¡æŠ•æ·æ¬¡æ•°ç­‰äº kmax</li></ul><p>æœ€åç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„æ¨è®ºï¼Œæœ€ç»ˆçš„ç»“æœå°±æ˜¯ï¼š<strong>è¿›è¡Œäº† næ¬¡è¿›è¡ŒæŠ›ç¡¬å¸å®éªŒï¼Œæ¯æ¬¡åˆ†åˆ«è®°å½•ä¸‹ç¬¬ä¸€æ¬¡æŠ›åˆ°æ­£é¢çš„æŠ›æ·æ¬¡æ•° kï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ næ¬¡å®éªŒä¸­æœ€å¤§çš„æŠ›æ·æ¬¡æ•° kmax æ¥é¢„ä¼°å®éªŒç»„æ•°é‡ n</strong>ï¼›è¿™å°±æ˜¯ HLLç®—æ³•çš„æ•°å­¦ç†è®ºåŸºç¡€</p><p>æ­¤å¤– HLL ä¸ºäº†æé«˜å‡†ç¡®æ€§ä¹Ÿåšäº†å…¶ä»–ä¼˜åŒ–</p><p><strong>åˆ†æ¡¶å¹³å‡</strong></p><p>HLLçš„åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨é›†åˆä¸­æ•°å­—çš„æ¯”ç‰¹ä¸²ç¬¬ä¸€ä¸ª1å‡ºç°ä½ç½®çš„æœ€å¤§å€¼æ¥é¢„ä¼°æ•´ä½“åŸºæ•°ï¼Œä½†æ˜¯è¿™ç§é¢„ä¼°æ–¹æ³•å­˜åœ¨è¾ƒå¤§è¯¯å·®ï¼Œä¸ºäº†æ”¹å–„è¯¯å·®æƒ…å†µï¼ŒHLLä¸­å¼•å…¥åˆ†æ¡¶å¹³å‡çš„æ¦‚å¿µ</p><p>ä¸ºäº†é¿å…ä¸€ç»„å®éªŒä¸­çš„è¿æ°”å½±å“ï¼Œå°†ç»Ÿè®¡æ•°æ®åˆ’åˆ†å¤šä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶å„è‡ªç»Ÿè®¡è‡ªå·±çš„kmaxè®¡ç®—åŸºæ•°é¢„ä¼°å€¼ï¼Œæœ€ç»ˆå¯¹å„ä¸ªæ¡¶çš„åŸºæ•°é¢„ä¼°å€¼è¿›è¡Œåˆå¹¶ï¼Œä½¿ç”¨è°ƒå’Œå¹³å‡æ•°çš„æ–¹å¼è¿›ä¸€æ­¥é™ä½è¯¯å·®</p><p><strong>åå·®ä¿®æ­£</strong></p><p>è™½ç„¶è°ƒå’Œå¹³å‡æ•°èƒ½å¤Ÿé€‚å½“ä¿®æ­£ç®—æ³•è¯¯å·®ï¼Œä½†ä½œè€…ç»™å‡ºä¸€ç§åˆ†é˜¶æ®µä¿®æ­£ç®—æ³•</p><p>å½“ HLLç®—æ³•å¼€å§‹ç»Ÿè®¡æ•°æ®æ—¶ï¼Œç»Ÿè®¡æ•°ç»„ä¸­å¤§éƒ¨åˆ†ä½ç½®éƒ½æ˜¯ç©ºæ•°æ®ï¼Œå¹¶ä¸”éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½å¡«æ»¡æ•°ç»„ï¼Œè¿™ç§é˜¶æ®µå¼•å…¥ä¸€ç§å°èŒƒå›´ä¿®æ­£æ–¹æ³•ï¼›å½“HLL ç®—æ³•ä¸­ç»Ÿè®¡æ•°ç»„å·²æ»¡çš„æ—¶å€™ï¼Œéœ€è¦ç»Ÿè®¡çš„æ•°æ®åŸºæ•°å¾ˆå¤§ï¼Œè¿™æ—¶å€™ hashç©ºé—´ä¼šå‡ºç°å¾ˆå¤šç¢°æ’æƒ…å†µï¼Œè¿™ç§é˜¶æ®µå¼•å…¥ä¸€ç§å¤§èŒƒå›´ä¿®æ­£æ–¹æ³•</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/search-aggregations-metrics-cardinality-aggregation.html#search-aggregations-metrics-cardinality-aggregation">Cardinalityaggregation | Elasticsearch Guide 8.5</a></p><p><ahref="https://juejin.cn/post/7067816471128342564">ç¥å¥‡çš„HyperLogLogç®—æ³•ã€è½¬è½½#æ¶‰åŠåˆ°æ•°å­¦åŸç†ã€‘ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="http://content.research.neustar.biz/blog/hll.html">Sketch ofthe Day: HyperLogLog â€” Cornerstone of a Big Data Infrastructure â€“ AKTech Blog (neustar.biz)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
            <tag> ES ç¢ç‰‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES æŠ˜å æ“ä½œ</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20%E6%8A%98%E5%8F%A0%E5%92%8C%E8%81%9A%E5%90%88.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20%E6%8A%98%E5%8F%A0%E5%92%8C%E8%81%9A%E5%90%88.html</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1><h2 id="æŠ˜å å’Œèšåˆ">æŠ˜å å’Œèšåˆ</h2><p>æ—¥å¸¸ä¼šæœ‰å¾ˆå¤šåœºæ™¯å¸Œæœ›å°†å¹³é¢æ•°æ®æŒ‰ç…§ä¸€å®šçš„æ¡ä»¶ç»„åˆèµ·æ¥ï¼Œå¹¶æŒ‰ç…§ä¸€å®šè§„åˆ™è¿›è¡Œè®¡ç®—</p><p>èšåˆå°†æ‚¨çš„æ•°æ®æ±‡æ€»ä¸ºæŒ‡æ ‡ã€ç»Ÿè®¡æˆ–å…¶ä»–åˆ†æ</p><p>å¯ä»¥å¸®åŠ©ä½ å›ç­”ç±»ä¼¼å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>æˆ‘çš„ç½‘é¡µå¹³å‡åŠ è½½æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ ¹æ®äº¤æ˜“é‡è°æ˜¯æˆ‘æœ€æœ‰ä»·å€¼çš„å®¢æˆ·ï¼Ÿ</li><li>åœ¨æˆ‘çš„ç½‘ç«™ä¸Šå¤§æ–‡ä»¶çš„è¡¡é‡æ ‡å‡†æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ¯ä¸ªäº§å“ç±»åˆ«æœ‰å¤šå°‘ç§äº§å“ï¼Ÿ</li></ul><p>åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œèšåˆä»¥ <code>GROUP BY</code>å…³é”®å­—å’Œèšåˆå‡½æ•°çš„æ–¹å¼è¿›è¡Œå®ç°</p><p>ä¾‹å¦‚ç»Ÿè®¡æ¯ä¸ªç­çº§ä¸‹ç”·ç”Ÿçš„äººæ•°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> `classId`,<span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> <span class="string">&#x27;number&#x27;</span> <span class="keyword">FROM</span> `student` <span class="keyword">WHERE</span> `gender` <span class="operator">=</span> &quot;male&quot; <span class="keyword">GROUP</span> <span class="keyword">BY</span> `classId`;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ç­çº§å³ <code>classId</code> å­—æ®µè¿›è¡Œèšåˆï¼Œä½¿ç”¨<code>COUNT()</code> èšåˆå‡½æ•°æ¥ç»Ÿè®¡æ•°é‡</p><h2 id="æ¨¡æ‹Ÿ">æ¨¡æ‹Ÿ</h2><p>æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯æ¥ä½¿ç”¨ ES å®ç°éœ€æ±‚ï¼Œè®¾ç½®è¿™æ ·ä¸€ä¸ªç´¢å¼•</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT /student-index/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿæ•°æ®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /student-index/_doc</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å¼ ä¸‰&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">70</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;æå››&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">19</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">72.5</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;ç‹äº”&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">80</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">21</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">75</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å°çº¢&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">19</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;female&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">50</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å°å…°&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;female&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">51</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;è›‹è›‹&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">,</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;male&quot;</span><span class="punctuation">,</span><span class="attr">&quot;class&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span><span class="number">90</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="æŠ˜å ">æŠ˜å </h1><p>åœ¨ ES é™¤äº†èšåˆ <code>aggregations</code> å¤–ï¼Œæœ‰ä¸€ç§ç±»ä¼¼èšåˆçš„æ“ä½œ<code>collapse</code> æŠ˜å </p><blockquote><p>ä½ å¯ä»¥ä½¿ç”¨ collapseå‚æ•°æ¥åŸºäºå­—æ®µå€¼æŸ¥è¯¢ç»“æœï¼›æ¯ä¸ªæŠ˜å ä»…é€‰æ‹©æ’åºé å‰çš„æ–‡æ¡£æ¥å®ŒæˆæŠ˜å </p></blockquote><p>è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºæŠ˜å å’Œèšåˆè¿˜æ˜¯æœ‰ä½¿ç”¨ä¸Šçš„åŒºåˆ«çš„ï¼Œèšåˆæ›´å…³æ³¨çš„æ˜¯èšåˆåçš„ç»“æœï¼Œè€ŒæŠ˜å æ˜¯åœ¨åŸç»“æœé›†åŸºç¡€ä¸Šå°†å­—æ®µå»é‡ï¼Œå¹¶ä¸”å¯ä»¥åƒåˆ†é¡µä¸€æ ·å¯¹æŠ˜å ç»“æœè¿›è¡Œåˆ†é¡µ</p><p>ä¾‹å¦‚è¿™æ ·ä¸€ç»„æ•°æ®</p><table><thead><tr class="header"><th style="text-align: center;">name</th><th style="text-align: center;">class</th><th style="text-align: center;">time</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">å¼ ä¸‰</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td></tr><tr class="even"><td style="text-align: center;">æå››</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td></tr><tr class="odd"><td style="text-align: center;">ç‹äº”</td><td style="text-align: center;">1</td><td style="text-align: center;">3</td></tr></tbody></table><p>æ ¹æ® <code>time</code> å€’åºï¼ŒæŒ‰ç…§ <code>class</code>è¿›è¡ŒæŠ˜å ï¼Œ<code>size</code> ä¸º 1ï¼Œè¿”å›çš„ç»“æœåº”è¯¥æ˜¯<code>class = 1</code> çš„æ•°æ®ï¼Œå› ä¸ºå‘½ä¸­äº† <code>name = "ç‹äº”"</code>çš„æ–‡æ¡£</p><p>å½“ <code>from</code> ä¸º 1 æ—¶ï¼Œè¿”å›<code>class = 2</code>ï¼Œæ­¤æ—¶æ‰€æœ‰æŠ˜å åçš„æ•°æ®éƒ½å·²ç»æŸ¥è¯¢å®Œæˆ</p><p>æŠ˜å æ›´åƒæ˜¯å¯¹äºæŸ¥è¯¢çš„ä¸€ç§ç‰¹æ®Šæ“ä½œï¼Œå…¶å‚æ•°ä½¿ç”¨ä¹Ÿå’Œ <code>query</code>åœ¨åŒä¸€å±‚çº§ï¼Œè¿”å›ä½“ä¸­ä¹Ÿæ˜¯åœ¨ <code>hits</code> ä¸­è¿”å›æ–‡æ¡£</p><h2 id="æŠ˜å æŸ¥è¯¢">æŠ˜å æŸ¥è¯¢</h2><p>å¯¹äºæ¨¡æ‹Ÿçš„æ•°æ®ï¼Œå¯¹ <code>class</code>å­—æ®µæŠ˜å ï¼Œç­çº§çš„é¡ºåºæŒ‰ç…§ç”·ç”Ÿçš„å¹´é¾„æ’åºï¼Œå–ç¬¬äºŒå</p><p>å³å…¨æ ¡å¹´é¾„ç¬¬äºŒå¤§çš„ç”·æ€§å­¦ç”Ÿæ‰€åœ¨çš„ç­çº§</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /student-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="comment">// ä¸æŸ¥è¯¢ç¬¬ä¸€æ¡</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›çš„ç»“æœï¼Œåªå– hits éƒ¨åˆ†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student-index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k-mmzoQBCTaFCHoW7hai&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">75</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">2</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">21</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>_source</code>ç»“æœé€‰å–äº†æŠ˜å æ‰€å‘½ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡æ¡£ï¼ˆæŠ˜å çš„ä¾æ®ï¼‰ï¼›<code>fields</code>åˆ™æ˜¯æŠ˜å çš„å­—æ®µï¼Œè¯´æ˜å¹´é¾„ç¬¬äºŒå¤§çš„ç”·ç”Ÿæ‰€åœ¨çš„ç­çº§æ˜¯ 2 ç­</p><h2 id="æ‰©å±•ç»“æœ">æ‰©å±•ç»“æœ</h2><p>ä¸Šé¢æŠ˜å çš„ç®€å•æ“ä½œå¯ä»¥çœ‹åˆ°ï¼Œè¿”å›çš„ hitsä¸­åŒ…å«äº†ä¸€ä¸ªæŠ˜å ä¾æ®çš„æ–‡æ¡£ï¼ˆæ’åºæ¡ä»¶çš„ç¬¬ä¸€ä¸ªæ–‡æ¡£ï¼‰</p><p>å¦‚æœéœ€è¦è¿”å›æŠ˜å å­—æ®µä¸‹çš„æ‰€æœ‰æ–‡æ¡£ï¼ˆæˆ‘è®¤ä¸ºæ›´åƒæ˜¯åˆ†ç»„æ“ä½œï¼‰ï¼Œå¯ä»¥ä½¿ç”¨<code>inner_hit</code> å‚æ•°å®ç°</p><p>å–å…¨æ ¡å¹´é¾„ç¬¬äºŒå¤§çš„ç”·æ€§å­¦ç”Ÿæ‰€åœ¨çš„ç­çº§ä¸‹é¢çš„æ‰€æœ‰å­¦ç”Ÿï¼Œä¸”æŒ‰ç…§èº«é«˜æ­£åºæ’åˆ—</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">POST /student-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student_in_class&quot;</span><span class="punctuation">,</span> <span class="comment">// è‡ªå®šçš„ç»“æœé›†åå­—</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span> <span class="comment">// inner_hits å†…æ–‡æ¡£æ•°é‡</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// è¿™ä¸ªæ’åºå‚æ•°æ˜¯ inner hitï¼Œå†…éƒ¨æ–‡æ¡£çš„æ’åº</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// è¿™ä¸ªæ’åºå‚æ•°æ˜¯æŸ¥è¯¢æ¡ä»¶çš„æ’åº</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœå‰åŠéƒ¨åˆ†å’ŒæŠ˜å æŸ¥è¯¢ä¸€æ ·ï¼Œåªå– <code>inner_hit</code>å­—æ®µä¸‹çš„ç»“æœé›†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;student_in_class&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student-index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kemmzoQBCTaFCHoWyxaJ&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æå››&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">72.5</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="number">72.5</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student-index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k-mmzoQBCTaFCHoW7hai&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">75</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="number">75</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>inner_hits</code> ä¸‹æ˜¯ <code>student_in_class</code>è‡ªå®šçš„ç»“æœé›†åç§°ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸€æ¬¡ <code>inner_hits</code>å¯ä»¥è®¾ç½®å¤šä¸ªä¸åŒè§„åˆ™çš„ç»“æœé›†è¯·æ±‚ï¼ˆ<code>inner_hits</code>å‚æ•°æ˜¯ä¸ªæ•°ç»„ï¼‰</p><p>è¿”å›çš„ç»“æœä¸­åŒ…å«äº† 2 ç­ä¸‹çš„ä¸¤åå­¦ç”Ÿï¼Œå¹¶ä¸”æ ¹æ® <code>height</code>å­—æ®µè¿›è¡Œäº†æ’åº</p><h2 id="search-after">search after</h2><p>æŠ˜å æ“ä½œåŒæ ·æ”¯æŒ search after æ“ä½œ</p><p>å› ä¸ºæœ¬è´¨ä¸Š ES ä¹Ÿæ˜¯æ’åºåæ ¹æ®æ–‡æ¡£é¡ºåºå¯¹æŠ˜å å­—æ®µè¿›è¡Œæ“ä½œï¼Œå½“ searchafter å­—æ®µç•¥è¿‡è¯¥å€¼åï¼Œç»§ç»­å¯¹æœªæŠ˜å å­—æ®µå€¼è¿›è¡ŒæŠ˜å æ“ä½œ</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œ<strong>åªæœ‰å½“æŠ˜å å­—æ®µå’Œæ’åºå­—æ®µæ˜¯åŒä¸€å­—æ®µæ—¶æ‰èƒ½ä½¿ç”¨è¯¥æ–¹å¼ï¼ŒåŒæ—¶ä¸å…è®¸äºŒçº§æ’åº</strong></p><p>è¯­æ³•å’ŒåŸºæœ¬æŸ¥è¯¢ä¸€è‡´</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET /search&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user.id&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;user.id&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;search_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;dd5ce1ad&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="äºŒçº§æŠ˜å ">äºŒçº§æŠ˜å </h2><p>å¯¹æŸä¸€ä¸ªå­—æ®µæŠ˜å åï¼Œ<code>inner_hits</code>å†…è¿˜å¯ä»¥å¯¹å…¶ä»–å­—æ®µå†è¿›è¡Œä¸€æ¬¡æŠ˜å </p><p>ä½†äºŒæ¬¡æŠ˜å æ— æ³•ä½¿ç”¨ <code>inner_hits</code>å‚æ•°ï¼Œå³æŠ˜å åªèƒ½æ”¯æŒåˆ°äºŒçº§</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;student_in_class&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;collapse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;height&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ ¹æ® <code>class</code> æŠ˜å åçš„å†…éƒ¨æ–‡æ¡£ï¼Œå†æ ¹æ® <code>height</code>è¿›è¡ŒæŠ˜å æ“ä½œ</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
            <tag> ES ç¢ç‰‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES çš„ from size å’Œ scroll å’Œ search after</title>
      <link href="/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%20from%20size%20%E5%92%8C%20scroll%20%E5%92%8C%20search%20after.html"/>
      <url>/%E5%BC%80%E5%8F%91/ES/ES%20%E7%9A%84%20from%20size%20%E5%92%8C%20scroll%20%E5%92%8C%20search%20after.html</url>
      
        <content type="html"><![CDATA[<h1 id="from-size">from size</h1><p>from size æ˜¯æœ€å¸¸è§çš„åˆ†é¡µæ–¹å¼ï¼Œç±»æ¯” MySQL çš„ offset limit</p><p>ç”±äº ES æ˜¯å¤©ç„¶åˆ†å¸ƒå¼çš„ï¼Œæ•°æ®åˆ†æ•£åœ¨å„ä¸ª shards ä¸Šï¼Œæ‰€ä»¥éœ€è¦æŸ¥è¯¢<code>from + size</code> çš„æ¡æ•°æ—¶ï¼Œcoordinate node å°±å‘è¯¥ index çš„å…¶ä½™çš„shards å‘é€åŒæ ·çš„è¯·æ±‚ï¼Œç­‰æ±‡æ€»åˆ° <code>(shards Ã— (from + size))</code>æ¡æ•°æ—¶åœ¨ coordinate node å†è¿›è¡Œä¸€æ¬¡æ’åºï¼Œæœ€ç»ˆæŠ½å–å‡ºçœŸæ­£ from åçš„ sizeæ¡ç»“æœ</p><p>æ˜¾è€Œæ˜“è§ï¼Œå½“ shardsè¾ƒå¤šã€åˆ†é¡µæ·±åº¦å¾ˆå¤§æ—¶ï¼Œè¿™ç§æ–¹å¼å­˜åœ¨å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ ES é»˜è®¤æ·±åº¦ä¸º<code>from + size &lt;= 10000</code> çš„åŸå› </p><h2 id="routing-æœºåˆ¶">Routing æœºåˆ¶</h2><p>å†™å…¥æ–‡æ¡£æ—¶æŒ‡å®šå­˜å‚¨çš„åˆ†ç‰‡</p><p>å®˜æ–¹æä¾›çš„å…¬å¼å¦‚ä¸‹ï¼š<code>shard_num = hash(_routing) % num_primary_shards</code></p><ul><li><code>_routing</code> ä»£è¡¨æä¾›è·¯ç”±çš„å­—æ®µã€‚é»˜è®¤æƒ…å†µä¸‹ä¸ºæ–‡æ¡£çš„ ID</li><li><code>num_primary_shards</code> ä»£è¡¨çš„ä¸º primary shardçš„ä¸ªæ•°ï¼Œè¿™ä¸ªåœ¨æ¯ä¸ªç´¢å¼•ç±»å‹åˆ›å»ºä¹‹å‰å°±è¢«è®¾ç½®äº†ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®ä¹Ÿå¯ä»¥è®© ESé»˜è®¤è®¾ç½®ã€‚å› ä¸º ESç‰ˆæœ¬ä¸åŒï¼Œè®¾ç½®çš„é»˜è®¤å€¼ä¹Ÿä¸åŒã€‚è¯¥å€¼åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºç´¢å¼•ç±»å‹è¢«è®¾ç½®å®Œæˆä¹‹åæ— æ³•æ— æ³•ä¿®æ”¹ï¼ˆä¿®æ”¹è·¯ç”±æœºåˆ¶å°±ä»£è¡¨éœ€è¦è¿ç§»æ•°æ®ï¼‰</li><li><code>shard_num</code> ä»£è¡¨æ•°æ®è½åœ¨çš„ shard ç¼–å·</li></ul><p>åŸºæœ¬æµç¨‹æ˜¯ ESæ ¹æ®è·¯ç”±å­—æ®µè®¡ç®—å…¶å“ˆå¸Œå€¼ï¼Œå†ä¸ä¸»åˆ†ç‰‡æ•°é‡å–ä½™ï¼Œè®¡ç®—å¾—å‡ºæ•°æ®è½åœ¨çš„åˆ†ç‰‡ç¼–å·</p><p>æ­¤å¤–å¦‚æœåªæ ¹æ® <code>_routing</code>ä¼šå‡ºç°æ•°æ®å€¾æ–œï¼Œå¯ä»¥é‡‡å–æŠ˜ä¸­æ–¹æ¡ˆï¼Œä½¿ç”¨<code>routing_partition_size</code> å‚æ•°ï¼Œæ¥ä½¿åŒä¸€ç±»<code>_routing</code> è·¯ç”±åˆ°ä¸»åˆ†ç‰‡çš„ä¸€ä¸ªå­é›†ä¸­</p><p><code>shard_num = (hash(_routing) + hash(_id) % routing_partition_size) % num_primary_shards</code></p><h2 id="restful">restful</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="java">Java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// searchRequest</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hero-index&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// åˆ†é¡µæ¡ä»¶</span></span><br><span class="line">    searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// term name = &quot;&quot;</span></span><br><span class="line">    <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// bool ç±»å‹ä¸º must not</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery().mustNot(termQueryBuilder);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶ç»„è£…è¿› searchSourceBuilder</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> <span class="title class_">TimeValue</span>(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="search-after">search after</h1><p>ES 5 å¼•å…¥çš„æ–°æœºåˆ¶</p><p>ç®€å•æ¦‚æ‹¬ search after å¦‚ä½•ä½¿ç”¨ï¼š</p><ul><li>å¿…é¡»å…ˆæŒ‡å®šæ’åºè§„åˆ™ï¼ˆéœ€è¦è·å–æ’åºåæ ‡ï¼‰</li><li>æ¯”å¦‚ä»ç¬¬ä¸€é¡µå¼€å§‹ï¼ˆä»ä¸­é—´å¼€å§‹ä¹Ÿæ— æ³•çŸ¥é“ä¸­é—´çš„å…·ä½“ä½ç½®ï¼‰</li><li>ä»ç¬¬ä¸€é¡µå¼€å§‹ä»¥åæ¯æ¬¡éƒ½å¸¦ä¸Š<code>search_after=lastEmittedDocFieldValue</code><code>lastEmittedDocFieldValue</code> å°±æ˜¯ä¸‹ä¸€é¡µå¼€å§‹çš„ keysetåæ ‡ï¼ˆä¹Ÿå°±æ˜¯è¿™ä¸ªå‚æ•°æŠŠæ·±åº¦åˆ†é¡µå˜æˆäº†å¸¸æ•°çº§åˆ†é¡µï¼‰</li></ul><p><strong>å’Œ from size ç›¸æ¯”ï¼Œæ— è®ºå»åˆ°ç¬¬å‡ é¡µï¼Œcoordinate node å‘å…¶å®ƒnode å‘é€çš„è¯·æ±‚å§‹ç»ˆå°±æ˜¯è¯·æ±‚ size ä¸ªdocsï¼›å³æ— è®ºåˆ†é¡µæ·±åº¦æ˜¯å¤šå°‘ï¼Œéƒ½æ˜¯å¸¸é‡çº§çš„å¼€é”€</strong></p><p>å…¶å®ç°åŸç†å’Œå…³ç³»å‹æ•°æ®åº“å¸¸ä½¿ç”¨çš„ keysetåˆ†é¡µæ€æƒ³ä¸€è‡´ï¼Œä¸šåŠ¡å¦¥åï¼ˆåªèƒ½æŒ‰é¡ºåºåˆ†é¡µè€Œä¸èƒ½è·³è½¬é¡µæ•°ï¼‰æ¥å®ç°æ€§èƒ½çš„æå‡</p><p>ä½†éœ€è¦æ³¨æ„ï¼Œçœ‹ä¼¼ search after æ˜¯ä¸€ä¸ª O(1)çº§åˆ«çš„æ“ä½œï¼Œä½†éšç€åˆ†é¡µæ·±åº¦çš„å¢åŠ ï¼Œå…¶å†…éƒ¨é€»è¾‘æ‰«æçš„ docæ•°é‡ä¹Ÿåœ¨ä¸æ–­å¢åŠ ï¼Œä¾ç„¶ä¼šå½±å“æŸ¥è¯¢æ€§èƒ½ï¼Œåªæ˜¯ç›¸æ¯” from sizeæ–¹å¼æœ‰ä¸€å®šæå‡ï¼ˆMySQL å•è¡¨æŸ¥è¯¢çš„åˆ†é¡µä¹Ÿæ˜¯å¦‚æ­¤ï¼‰</p><p>æ­¤å¤–ï¼Œå¦‚æœå­—æ®µåŒºåˆ†åº¦ä¸é«˜ï¼Œåˆ™ä¼šå¿½ç•¥æŸäº›æ•°æ®ï¼›ä¾‹å¦‚æ ¹æ® ageä½œä¸ºæ’åºæ¡ä»¶ï¼Œæ­¤æ—¶å¦‚æœæ¯é¡µæ•°æ®å– 1000 æ¡ï¼Œè€ŒæŸä¸ª age æ•°æ® count &gt;1000ï¼Œåˆ™ä¼šå¿½ç•¥åç»­æ•°æ®ï¼›<strong>è§£å†³æ–¹æ³•æ˜¯æ’åºå­—æ®µå”¯ä¸€ï¼Œæˆ–è€…ç»„åˆåçš„å¤šä¸ªæ’åºæ¡ä»¶å”¯ä¸€</strong></p><h2 id="restful-1">restful</h2><p>ç¬¬ä¸€æ¬¡æŸ¥è¯¢å’Œæ™®é€šæŸ¥è¯¢ä¸€è‡´</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>éšåçš„æŸ¥è¯¢å¢åŠ  <code>search_after</code>æŸ¥è¯¢æ¡ä»¶ï¼Œå€¼ä¸ºæœ€åä¸€æ¡æ•°æ®æ’åºå­—æ®µçš„å€¼</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;search_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="number">35</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;i-mnlIQBCTaFCHoWJhbM&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="java-1">Java</h2><p>åŒ from size ä¸€è‡´</p><p>ç¬¬äºŒæ¬¡æŸ¥è¯¢åŠä¹‹åéœ€è¦<code>searchSourceBuilder.searchAfter(new Object[1]);</code> æ¥è®¾ç½®<code>search_after</code> å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchAfter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// searchRequest</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hero-index&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// åˆ†é¡µæ¡ä»¶</span></span><br><span class="line">    searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// term name = &quot;&quot;</span></span><br><span class="line">    <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// bool ç±»å‹ä¸º must not</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery().mustNot(termQueryBuilder);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶ç»„è£…è¿› searchSourceBuilder</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> <span class="title class_">TimeValue</span>(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸Šæ‰¹æ•°æ®æœ€åä¸€æ¡çš„æ’åºå­—æ®µå€¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">lastHitOrderFieldValue</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// set è¿› searchAfter å±æ€§ä¸­</span></span><br><span class="line">    searchSourceBuilder.searchAfter(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;lastHitOrderFieldValue&#125;);</span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="scroll">scroll</h1><p>å¦‚æœä¸€å¼€å§‹å°±æ˜ç¡®åœ°æŸ¥è¯¢å…¨é‡çš„æ•°æ®ï¼Œæ— è®ºä½¿ç”¨ from size è¿˜æ˜¯ searchafteréƒ½ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œè¦ä¹ˆä¾ç„¶å­˜åœ¨æ·±åº¦åˆ†é¡µçš„é—®é¢˜ï¼Œè¦ä¹ˆéœ€è¦å¤šæ¬¡è¯·æ±‚ï¼Œæ‰€ä»¥å¼•å…¥äº†scroll æ–¹å¼</p><p>scroll å°±æ˜¯æŠŠä¸€æ¬¡çš„æŸ¥è¯¢ç»“æœç¼“å­˜ä¸€å®šçš„æ—¶é—´ï¼Œå¦‚<code>scroll = 1m</code> åˆ™æŠŠæŸ¥è¯¢ç»“æœåœ¨ä¸‹ä¸€æ¬¡è¯·æ±‚ä¸Šæ¥æ—¶æš‚å­˜ 1 åˆ†é’Ÿ</p><p>response æ¯”ä¼ ç»Ÿçš„è¿”å›å¤šäº†ä¸€ä¸ª <code>scroll_id</code>ï¼Œä¸‹æ¬¡å¸¦ä¸Šè¿™ä¸ª<code>scroll_id</code> å³å¯æ‰¾å›è¿™ä¸ªç¼“å­˜çš„ç»“æœ</p><p>æœ¬è´¨ä¸Šæ˜¯è®©å„ä¸ª shard å°†ç»“æœç¼“å­˜ï¼Œæ­¤å¤–ä¹Ÿæœ‰å¾ˆå¤šä¼˜åŒ–ï¼ˆå• shardå‡å°‘è¯·æ±‚æ•°é‡ã€å‰ªæç­‰ï¼‰æ¥æé«˜æ€§èƒ½</p><h2 id="restful-2">restful</h2><p>ç¬¬ä¸€æ¬¡è¯·æ±‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /hero-index/_search?scroll=<span class="number">1</span>m</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>éšå</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_search/scroll</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;scroll&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;scroll_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFlN0TlRCWW5pUktHLWxvMEdDN3Zya2cAAAAAAAAA_hZkVXh5THJ1SFR1dVVPQlJJX3JDZWRR&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="java-2">Java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scrollSearch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// searchRequest</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hero-index&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// åˆ†é¡µæ¡ä»¶</span></span><br><span class="line">    searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// term name = &quot;&quot;</span></span><br><span class="line">    <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// bool ç±»å‹ä¸º must not</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery().mustNot(termQueryBuilder);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¡ä»¶ç»„è£…è¿› searchSourceBuilder</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> <span class="title class_">TimeValue</span>(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ scroll</span></span><br><span class="line">    <span class="type">Scroll</span> <span class="variable">scroll</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scroll</span>(TimeValue.timeValueMinutes(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    searchRequest.scroll(scroll);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšååº”è¯¥å¾ªç¯æŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scrollAfterSearch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰ scroll</span></span><br><span class="line">    <span class="type">Scroll</span> <span class="variable">scroll</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scroll</span>(TimeValue.timeValueMinutes(<span class="number">1</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">scrollId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">SearchScrollRequest</span> <span class="variable">searchScrollRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchScrollRequest</span>(scrollId);</span><br><span class="line">    searchScrollRequest.scroll(scroll);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    searchScrollRequest.scroll(scroll);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.scroll(searchScrollRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;totalHits:&quot;</span> + search.getHits().getTotalHits().value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹</p><h1 id="æ‹“å±•">æ‹“å±•</h1><p>æ–‡ç«  <strong>ã€Šä¸šç•Œéš¾é¢˜ - â€è·¨åº“åˆ†é¡µâ€ çš„å››ç§æ–¹æ¡ˆã€‹</strong></p><h2 id="éœ€æ±‚äº§ç”Ÿ">éœ€æ±‚äº§ç”Ÿ</h2><p><strong>åˆ†é¡µéœ€æ±‚</strong></p><p>å¯¹äºæ•°æ®çš„æŸ¥è¯¢ï¼Œå¾ˆå¤šä¸šåŠ¡éƒ½æœ‰åˆ†é¡µæ‹‰å–æ•°æ®çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šåˆ†é¡µæ‹‰å–èŠå¤©è®°å½•ã€å•†å“ä¿¡æ¯ã€å›¾ç‰‡æ•°æ®ç­‰</p><p>é™¤äº†å¯¹æ•°æ®é›†æ‹†åˆ†ï¼Œå¾€å¾€è¿˜éœ€è¦ä¸šåŠ¡å­—æ®µè¿›è¡Œæ’åº</p><p>æ¯”å¦‚å–ç¬¬ 3 é¡µçš„è®¢å•æ•°æ®ï¼Œæ¯é¡µ 100æ¡ï¼Œæ ¹æ®åˆ›å»ºæ—¶é—´å€’åºï¼›å¯ä»¥æ ¹æ®åˆ›å»ºæ—¶é—´å»ºç«‹ç´¢å¼•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">200</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure><p><strong>åˆ†åº“åˆ†è¡¨</strong></p><p>éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œä¸ºäº†åº”å¯¹æ•°æ®é‡å¤§ã€è¯·æ±‚é‡å¤§ç­‰é—®é¢˜ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†æ¨ªå‘æ‰©å±•</p><p>å¼•å…¥åˆ†åº“åˆ†è¡¨åï¼Œæ•°æ®æ ¹æ® patition key è·¯ç”±è§„åˆ™å†™å…¥ä¸åŒçš„åº“è¡¨ä¸­</p><p>åŒæ—¶ä¸ºäº†è®©è¯»å†™å‹åŠ›å°½å¯èƒ½å‡åŒ€åˆ†å¸ƒåœ¨å„ä¸ªåº“ä¸­ï¼Œå¾€å¾€ä¼šè®¾ç½®åˆé€‚çš„ patitionkey</p><p>å½“åˆ†åº“åˆ†è¡¨åéœ€è¦è¿›è¡Œç¤ºä¾‹çš„åˆ†é¡µéœ€æ±‚æ—¶ï¼Œå°±æ— æ³•é€šè¿‡ç®€å•çš„è¯·æ±‚ä¸€ä¸ªåº“å®ç°ç›®çš„äº†ï¼ˆå‡è®¾åˆ†è¡¨é”®ä¸æ˜¯ä½¿ç”¨çš„åˆ›å»ºæ—¶é—´ï¼Œäº‹å®ä¸Šä½¿ç”¨åˆ›å»ºæ—¶é—´èŒƒå›´ä½œä¸ºåˆ†è¡¨é”®ä¹Ÿæ²¡ä»»ä½•æ„ä¹‰ï¼‰</p><p>æ’åºçš„ä¾æ®æ˜¯æ—¶é—´ï¼Œåˆ†è¡¨çš„ä¾æ®æ˜¯å…¶ä»–å­—æ®µï¼Œå› æ­¤æ•°æ®åº“ä¸§å¤±äº†åˆ›å»ºæ—¶é—´æ’åºçš„å…¨å±€è§†é‡</p><p>æœ¬æ–‡å°±åœ¨è®¨è®ºå¦‚ä½•æ»¡è¶³ è·¨è¶Šå¤šä¸ªæ°´å¹³æ‹†åˆ†æ•°æ®åº“çš„åˆ†é¡µæŸ¥è¯¢é—®é¢˜</p><h2 id="å…¨å±€è§†é‡">å…¨å±€è§†é‡</h2><p>å½“æ•°æ®åˆ†å¸ƒåœ¨ä¸¤ä¸ªåº“ä¸­ï¼Œæ— è®ºå“ªä¸ªåˆ†åº“çš„ç¬¬ä¸‰é¡µï¼Œéƒ½ä¸ä¸€å®šä¼šæ˜¯å…¨å±€æ’åºçš„ç¬¬ä¸‰é¡µæ•°æ®</p><p>æƒ…å†µå¦‚ä¸‹ï¼š</p><ul><li>ä¸€èˆ¬æƒ…å†µï¼šä¸¤ä¸ªåº“å„å ç¬¬ä¸‰é¡µæ•°æ®çš„ä¸€éƒ¨åˆ†</li><li>æç«¯æƒ…å†µï¼šä¸¤ä¸ªåº“å„å ä¸€åŠ</li><li>æç«¯æƒ…å†µï¼šç¬¬ä¸‰é¡µæ•°æ®å®Œå…¨æ¥è‡ªäºä¸€ä¸ªåº“</li></ul><p>ç”±äºæŸ¥è¯¢å‰å¹¶ä¸æ¸…æ¥šæ•°æ®åˆ°åº•æ˜¯å¦‚ä½•åˆ†å¸ƒåœ¨å„ä¸ªåˆ†åº“ä¸Šçš„ï¼Œæ‰€ä»¥æ¯ä¸ªåº“éƒ½è¿”å›3 é¡µæ•°æ®ï¼Œæ‰€å¾—åˆ°çš„ 6é¡µæ•°æ®å†è¿›è¡Œæ’åºï¼Œæ­¤æ—¶è·å¾—äº†æ ¹æ®åˆ›å»ºæ—¶é—´æ’åºçš„å…¨å±€è§†é‡ï¼Œå†ä» 6é¡µæ•°æ®ä¸­æŠ½å–éœ€è¦çš„ç¬¬ 3 é¡µæ•°æ®</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>ä¸šåŠ¡æ— æŸï¼Œç²¾å‡†è¿”å›</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li><p>æ¯æ¬¡éœ€è¦å‘å„åˆ†åº“æŸ¥è¯¢çš„æ•°æ®é‡å’Œ shardæ•°é‡å€æ•°çº§ç›¸å…³ï¼Œå’Œé¡µç ï¼ˆæ·±åº¦ï¼‰æŒ‡æ•°çº§ç›¸å…³</p></li><li><p>éœ€è¦äºŒæ¬¡æ’åº</p></li><li><p>éœ€è¦æ›´å¤š IO èµ„æº</p></li></ul><h2 id="ç¦æ­¢è·³é¡µ">ç¦æ­¢è·³é¡µ</h2><p>ç”±ä¸šåŠ¡è¿›è¡Œå¦¥åï¼Œä¸å…è®¸è¿›è¡Œé¡µæ•°çš„éšæ„è·³è½¬ï¼Œåªå…è®¸ä¾æ¬¡è¿›è¡Œ ä¸‹ä¸€é¡µæ“ä½œï¼Œå°±èƒ½å‡å°‘æ·±åº¦åˆ†é¡µå¸¦æ¥çš„æ€§èƒ½å½±å“</p><p>è¢«ç§°ä¸º keyset åˆ†é¡µã€search after ç­‰</p><p>é¦–å…ˆè¿™ç§æ–¹å¼éœ€è¦å…ˆè¿›è¡Œæ’åºï¼Œæ¯”å¦‚ä½¿ç”¨åˆ›å»ºæ—¶é—´ä½œä¸ºæ’åºå­—æ®µï¼Œç¬¬ä¸€é¡µæ—¶å„åˆ†åº“æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">0</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>å½“ç‚¹å‡»ä¸‹ä¸€é¡µæ—¶ï¼Œæ ¹æ®ç¬¬ä¸€é¡µæ•°æ®çš„æœ€åä¸€æ¡ï¼Œå³ç¬¬ä¸€é¡µä¸­æœ€å°åˆ›å»ºæ—¶é—´çš„æ•°æ®ï¼ˆå‡è®¾æ˜¯1669820860000ï¼‰ï¼Œå„åˆ†åº“æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">WHERE</span> `createdTime` <span class="operator">&gt;</span> <span class="number">1669820860000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">0</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œé™¤ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ï¼Œåé¢æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦å¸¦ä¸Šæ’åºæ¡ä»¶ä¸‹ï¼Œä¸Šä¸€æ¬¡æŸ¥è¯¢æœ€åæ•°æ®çš„æ’åºå€¼ï¼Œè¿™ä¹Ÿæ˜¯æ— æ³•è¿›è¡Œè·³é¡µçš„åŸå› ï¼Œå› ä¸ºä¸é€šè¿‡æŸ¥è¯¢æ— æ³•çŸ¥é“æ‰€éœ€é¡µæ•°æ®çš„search after æ¡ä»¶æ˜¯å¤šå°‘</p><p>ç¦æ­¢è·³é¡µåæ¯ä¸ªåˆ†åº“ä¸€æ¬¡éƒ½åªæŸ¥è¯¢ä¸€é¡µæ•°æ®ï¼ŒæŸ¥è¯¢æ•°æ®é‡åªå’Œåˆ†åº“æ•°é‡å€æ•°çº§ç›¸å…³</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ€§èƒ½ç›¸å¯¹è¾ƒå¥½ï¼Œä¸å—å…¨å±€è§†é‡ä¸­æ·±åº¦åˆ†é¡µæŒ‡æ•°çº§å½±å“</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>ä¸šåŠ¡è¿›è¡Œä¸èƒ½è·³é¡µçš„å¦¥å</li><li>æ’åºå­—æ®µéœ€è¦å…·æœ‰åŒºåˆ†åº¦</li></ul><h2 id="å…è®¸ç²¾åº¦æŸå¤±">å…è®¸ç²¾åº¦æŸå¤±</h2><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œpatition key è§„åˆ™éƒ½å°½å¯èƒ½ä½¿æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨å„åˆ†åº“ä¸­</p><p>æ‰€ä»¥å¯ä»¥ç†æƒ³è®¤ä¸ºï¼Œæ¯ä¸ªåˆ†åº“éƒ½å®Œæ•´åŒ…å«äº†æ•°æ®çš„ä¸€éƒ¨åˆ†</p><p>å‡è®¾éœ€è¦å–ç¬¬ 100 é¡µæ•°æ®ï¼Œæœ‰ 2ä¸ªåˆ†åº“ï¼Œå¯ä»¥å„å–æ¯ä¸ªåˆ†åº“çš„åŠé¡µæ•°æ®å†å¾—åˆ°æ•°æ®çš„å¹¶é›†</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">9450</span>,<span class="number">50</span>;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼æœ€ç»ˆç»“æœåªèƒ½æ˜¯è¿‘ä¼¼ç»“æœï¼Œå¹¶ä¸ç²¾å‡†</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ€§èƒ½ç›¸å¯¹è¾ƒå¥½ï¼Œä¸å—å…¨å±€è§†é‡ä¸­æ·±åº¦åˆ†é¡µæŒ‡æ•°çº§å½±å“</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>ä¸šåŠ¡è¿›è¡Œç²¾åº¦æŸå¤±çš„å¦¥å</li></ul><h2 id="äºŒæ¬¡æŸ¥è¯¢">äºŒæ¬¡æŸ¥è¯¢</h2><p>è¿™ç§æ–¹å¼æ—¢èƒ½åšåˆ°ç²¾å‡†æ•°æ®ï¼Œä¹Ÿèƒ½å‡å°‘æŸ¥è¯¢é‡</p><p>åŸºæœ¬çš„æ€æƒ³æ˜¯é€šè¿‡å¤šæ¬¡æŸ¥è¯¢æ¥è·å¾—å…¨å±€è§†é‡ï¼Œå†æ ¹æ®å…¨å±€è§†é‡åœ¨ç»“æœé›†ä¸­æŠ½å–éœ€è¦çš„æ•°æ®</p><p>å‡è®¾ä¸€é¡µæŸ¥è¯¢ 5 æ¡æ•°æ®ï¼ŒæŸ¥è¯¢ç¬¬ 201 é¡µï¼Œæœ‰ä¸‰ä¸ªåˆ†åº“ï¼›å•è¡¨æŸ¥è¯¢å¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">1000</span>,<span class="number">5</span>;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸€æ­¥ï¼š</strong></p><p>æ”¹å†™æŸ¥è¯¢ï¼Œå„åˆ†åº“æŒ‰ç†æƒ³æƒ…å†µä¸‹æ•°æ®åˆ†å¸ƒè¿›è¡ŒæŸ¥è¯¢ï¼Œå³</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span> LIMIT <span class="number">333</span>,<span class="number">5</span>;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœ</p><table><thead><tr class="header"><th style="text-align: center;">A</th><th style="text-align: center;">B</th><th style="text-align: center;">C</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">523</td><td style="text-align: center;">423</td><td style="text-align: center;">500</td></tr><tr class="even"><td style="text-align: center;">423</td><td style="text-align: center;">421</td><td style="text-align: center;">400</td></tr><tr class="odd"><td style="text-align: center;">323</td><td style="text-align: center;">400</td><td style="text-align: center;">300</td></tr><tr class="even"><td style="text-align: center;">223</td><td style="text-align: center;">320</td><td style="text-align: center;">200</td></tr><tr class="odd"><td style="text-align: center;">123</td><td style="text-align: center;">320</td><td style="text-align: center;">100</td></tr></tbody></table><p><strong>ç¬¬äºŒæ­¥ï¼š</strong></p><p>ç»“æœé›†æ’åºåï¼Œæ‰¾åˆ°æ’åºå­—æ®µç¬¬ä¸€ä½çš„å€¼ï¼Œ<code>createdTime DESC</code>ï¼Œå³åˆ›å»ºæ—¶é—´çš„æœ€å¤§å€¼</p><p>å¯ä»¥å¾—åˆ°æ˜¯åˆ†åº“ A è¿”å›çš„ 523</p><p><strong>ç¬¬ä¸‰æ­¥ï¼š</strong></p><p>æ‰©å¤§æŸ¥è¯¢èŒƒå›´ï¼ŒæŸ¥è¯¢æ¡ä»¶ä½¿ç”¨ <code>between</code>è¯­å¥ï¼Œæœ€å¤§å€¼ä¸ºå…¨å±€æœ€å¤§å€¼ï¼ˆ523ï¼‰ï¼Œæœ€å°å€¼ä¸ºè¯¥åˆ†åº“è¿”å›ç»“æœé›†çš„æœ€å¤§å€¼ï¼ˆB-423ï¼ŒC-500ï¼‰</p><p>å› ä¸ºæœ€å¤§å€¼åœ¨åˆ†åº“ A ç»“æœé›†ä¸­ï¼Œæ‰€ä»¥ A æ˜¯ä¸éœ€è¦äºŒæ¬¡è¯·æ±‚çš„ï¼ˆ523 å’Œ 123æ•°æ®ä¸­å¿…ç„¶è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„ç»“æœé›†ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `order_B` <span class="keyword">WHERE</span> `createdTime` <span class="keyword">BETWEEN</span> <span class="number">523</span> <span class="keyword">AND</span> <span class="number">423</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `order_C` <span class="keyword">WHERE</span> `createdTime` <span class="keyword">BETWEEN</span> <span class="number">523</span> <span class="keyword">AND</span> <span class="number">500</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `createdTime` <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><p>Bã€C å¯èƒ½ä¼šè¿”å›æ›´å¤šçš„æ•°æ®ï¼Œç»“æœé›†æ›´æ–°ä¸º</p><table><thead><tr class="header"><th style="text-align: center;">A</th><th style="text-align: center;">B</th><th style="text-align: center;">C</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;">520</td></tr><tr class="even"><td style="text-align: center;"></td><td style="text-align: center;">499</td><td style="text-align: center;">510</td></tr><tr class="odd"><td style="text-align: center;">523</td><td style="text-align: center;">423</td><td style="text-align: center;">500</td></tr><tr class="even"><td style="text-align: center;">423</td><td style="text-align: center;">421</td><td style="text-align: center;">400</td></tr><tr class="odd"><td style="text-align: center;">323</td><td style="text-align: center;">400</td><td style="text-align: center;">300</td></tr><tr class="even"><td style="text-align: center;">223</td><td style="text-align: center;">320</td><td style="text-align: center;">200</td></tr><tr class="odd"><td style="text-align: center;">123</td><td style="text-align: center;">320</td><td style="text-align: center;">100</td></tr></tbody></table><p><strong>ç¬¬å››æ­¥ï¼š</strong></p><p>æ¨æ–­å…¨å±€è§†é‡</p><p>åœ¨åˆ†åº“ A ä¸­ï¼Œ523 æ˜¯ç¬¬ 333 æ¡æ•°æ®</p><p>åœ¨åˆ†åº“ B ä¸­ï¼ŒåŠ ä¸Šæ–°è¿”å›çš„ 1 æ¡æ•°æ®ï¼Œ523 æ˜¯ç¬¬ 333 - 1 - 1 = 331æ¡æ•°æ®</p><p>åœ¨åˆ†åº“ C ä¸­ï¼ŒåŠ ä¸Šæ–°è¿”å›çš„ 2 æ¡æ•°æ®ï¼Œ523 æ˜¯ç¬¬ 333 - 2 -1 = 330æ¡æ•°æ®</p><p>æ­¤æ—¶å¾—åˆ°æ•´ä¸ªç»“æœé›†ä¸­çš„æœ€å¤§å€¼ 523 åœ¨å…¨å±€çš„ offset åº”è¯¥æ˜¯ 333 + 331 +330 = 994</p><p><strong>ç¬¬äº”æ­¥ï¼š</strong></p><p>å·²ç»æœ‰äº† 523 è¿™ä¸ªæ•°æ®çš„å…¨å±€è§†é‡ï¼Œoffset 994</p><p>åˆæœ‰äº†ç»“æœé›† 18 æ¡æ•°æ®</p><p>é‚£ä¹ˆæ’åºåå°±å¯ä»¥åœ¨ç»“æœé›†ä¸­æ‰¾åˆ° offset 1000 limit 5 çš„æ•°æ®é›†äº†</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ—¢èƒ½ç²¾å‡†è·å–ç»“æœï¼Œåˆèƒ½é¿å…æ·±åº¦åˆ†é¡µ</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li><p>é€»è¾‘å¤æ‚</p></li><li><p>éœ€è¦å¤šæ¬¡æŸ¥è¯¢</p></li></ul><h2 id="æ€»ç»“">æ€»ç»“</h2><table><thead><tr class="header"><th style="text-align: center;">æ–¹å¼</th><th style="text-align: center;">ä¼˜ç‚¹</th><th style="text-align: center;">ç¼ºç‚¹</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">å…¨å±€è§†é‡</td><td style="text-align: center;">ç²¾ç¡®</td><td style="text-align: center;">æ€§èƒ½é—®é¢˜</td></tr><tr class="even"><td style="text-align: center;">ç¦æ­¢è·³é¡µ</td><td style="text-align: center;">é¿å…æ·±åº¦åˆ†é¡µ</td><td style="text-align: center;">ä¸šåŠ¡å¦¥å</td></tr><tr class="odd"><td style="text-align: center;">å…è®¸ç²¾åº¦æŸå¤±</td><td style="text-align: center;">é¿å…æ·±åº¦åˆ†é¡µ</td><td style="text-align: center;">ä¸šåŠ¡å¦¥å</td></tr><tr class="even"><td style="text-align: center;">äºŒæ¬¡æŸ¥è¯¢</td><td style="text-align: center;">ç²¾ç¡® + é¿å…æ·±åº¦åˆ†é¡µ</td><td style="text-align: center;">å¤šæ¬¡æŸ¥è¯¢</td></tr></tbody></table><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><a href="https://www.jianshu.com/p/91d03b16af77">Elasticsearch 5.xæºç åˆ†æï¼ˆ3ï¼‰from size, scroll å’Œ search after - ç®€ä¹¦(jianshu.com)</a></p><p><ahref="https://developer.aliyun.com/article/713865">ä¸šç•Œéš¾é¢˜-â€œè·¨åº“åˆ†é¡µâ€çš„å››ç§æ–¹æ¡ˆ-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº(aliyun.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> ES </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
            <tag> ES ç¢ç‰‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¢å‘å¯¹è±¡å…­å¤§åŸåˆ™</title>
      <link href="/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99.html"/>
      <url>/%E5%BC%80%E5%8F%91/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99.html</url>
      
        <content type="html"><![CDATA[<h1 id="å…­å¤§åŸåˆ™">å…­å¤§åŸåˆ™</h1><table><colgroup><col style="width: 15%" /><col style="width: 53%" /><col style="width: 31%" /></colgroup><thead><tr class="header"><th>è®¾è®¡åŸåˆ™</th><th>æ¦‚è¿°</th><th>ç›®çš„</th></tr></thead><tbody><tr class="odd"><td>å¼€é—­åŸåˆ™</td><td>å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­</td><td>æ˜“äºç»´æŠ¤</td></tr><tr class="even"><td>å•ä¸€èŒè´£</td><td>ä¸€ä¸ªç±»åªå¹²ä¸€ä»¶äº‹ï¼Œå®ç°ç±»è¦å•ä¸€</td><td>æå‡å¯è¯»æ€§</td></tr><tr class="odd"><td>é‡Œæ°æ›¿æ¢</td><td>ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•</td><td>å¥å£®æ€§ã€é˜²æ­¢é”™è¯¯ç»§æ‰¿</td></tr><tr class="even"><td>è¿ªç±³ç‰¹æ³•åˆ™</td><td>æœ€å°‘çŸ¥é“ï¼Œå¯¹è±¡ä¹‹é—´å°‘å»ºç«‹è”ç³»</td><td>ä½è€¦åˆ</td></tr><tr class="odd"><td>æ¥å£éš”ç¦»</td><td>ä¸€ä¸ªæ¥å£åªå¹²ä¸€ä»¶äº‹ï¼Œæ¥å£è¦ç²¾ç®€å•ä¸€</td><td>é«˜å†…èš</td></tr><tr class="even"><td>ä¾èµ–å€’ç½®</td><td>é«˜å±‚ä¸åº”è¯¥ä¾èµ–ä½å±‚ï¼Œè¦é¢å‘æ¥å£ç¼–ç¨‹</td><td>åˆ©äºç»“æ„å‡çº§</td></tr></tbody></table><h2 id="å¼€é—­åŸåˆ™">å¼€é—­åŸåˆ™</h2><blockquote><p><em>Software entities like classes,modules and functions should beopen for extension but closed for modifications.</em></p><p><em>ä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚ç±»ï¼Œæ¨¡å—å’Œå‡½æ•°åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­</em></p></blockquote><p>éšç€ä¸šåŠ¡å‘å±•éœ€è¦å¢åŠ æ–°çš„æ–¹æ³•ï¼Œæœ‰å‡ ç§æ–¹å¼ï¼š</p><ul><li><strong>åœ¨æ¥å£ä¸Šæ·»åŠ æ–°æ–¹æ³•</strong><ul><li>å¯¼è‡´æ¯ä¸€ä¸ªå®ç°ç±»éƒ½éœ€è¦è¿›è¡Œå®ç°ï¼Œæ”¹åŠ¨é‡å¤§</li><li>ä¸ä¸€å®šæ‰€æœ‰çš„å®ç°ç±»éƒ½éœ€è¦è¯¥æ–¹æ³•</li></ul></li><li><strong>ä¿®æ”¹å®ç°ç±»æ—§æ–¹æ³•</strong><ul><li>æ›¿ä»£åŸæœ‰æ—§æ–¹æ³•åŠŸèƒ½ï¼Œå¦‚æœåŒæ—¶éœ€è¦ä½¿ç”¨æ—§æ–¹æ³•åˆ™æ— æ³•é‡‡ç”¨æ­¤æ–¹å¼ï¼ˆ<code>getPrice()</code>è·å–çš„æ˜¯åŸä»·æ ¼è¿˜æ˜¯æ‰“æŠ˜åä»·æ ¼ï¼Ÿå¦‚æœéœ€è¦åŒæ—¶è·å–åŸä»·å’Œæ‰“æŠ˜åä»·æ ¼å¦‚ä½•å¤„ç†ï¼‰</li></ul></li><li><strong>é¢å‘æ‰©å±•ï¼Œä½¿ç”¨æ–°æ¥å£æˆ–è€…æ–°ç±»ç»§æ‰¿çˆ¶ç±»</strong><ul><li>æ–°æ¥å£æ–¹æ³•æ¥å£ï¼Œéœ€è¦çš„ç±»è¿›è¡Œå®ç°</li><li>æ–°ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œåœ¨çˆ¶ç±»åŸºç¡€ä¸Šå¢åŠ æ–¹æ³•</li></ul></li></ul><p><strong>æ˜æ˜¾é¢å‘æ‰©å±•æ›´å®¹æ˜“ç»´æŠ¤ï¼Œè¿™å°±æ˜¯å¼€é—­åŸåˆ™çš„ç›®çš„</strong></p><h2 id="å•ä¸€èŒè´£">å•ä¸€èŒè´£</h2><blockquote><p><em>There should never be more than one reason for a class to change.â€”â€” Robert C. Martin</em></p><p><em>ä¸€ä¸ªç±»åº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› ï¼Œå¦åˆ™ç±»åº”è¯¥è¢«æ‹†åˆ†</em></p></blockquote><p>æ§åˆ¶ä¸šåŠ¡å®ç°çš„ç²’åº¦é—®é¢˜ï¼›ä¸€ä¸ªç±»å¯ä»¥å…·å¤‡ä»»æ„æ•°é‡çš„æ–¹æ³•ï¼Œä½†éƒ½å±äºåŒä¸€ä¸ªåŠŸèƒ½ç°‡ä¸­</p><p><strong>ä¸¥æ ¼æ§åˆ¶ç±»ä¸­æ–¹æ³•çš„ç²’åº¦ï¼Œå¿…è¦æ—¶è¿›è¡Œåˆ†æä¸æ‹†åˆ†</strong></p><h2 id="é‡Œæ°æ›¿æ¢">é‡Œæ°æ›¿æ¢</h2><blockquote><p><em>Inheritance should ensure that any property proved aboutsupertype objects also holds for subtype objects. â€”â€” Liskov</em></p><p><em>ç»§æ‰¿å¿…é¡»ç¡®ä¿çˆ¶ç±»æ‰€æ‹¥æœ‰çš„æ€§è´¨åœ¨å­ç±»ä¸­ä»ç„¶æˆç«‹</em></p></blockquote><p>åœ¨é‡Œæ°æ›¿æ¢åŸåˆ™çš„æŒ‡å¯¼æ–¹é’ˆä¸‹ï¼Œå¯å¾—å‡ºï¼šä»…ä»…ä¾æ®ä¸¤ä¸ªç±»ä¹‹é—´æœ‰æ²¡æœ‰ "is a"çš„å…³ç³»ï¼Œæ¥åˆ¤æ–­ä¸¤ä¸ªç±»èƒ½ä¸èƒ½å‘ç”Ÿç»§æ‰¿å…³ç³»æ˜¯ä¸å¤Ÿçš„</p><p>åº”è¯¥éµå®ˆä¸€ä¸ªå¤§åŸåˆ™ï¼š<strong>ä»»ä½•ä½¿ç”¨çˆ¶ç±»çš„åœ°æ–¹ï¼Œéƒ½èƒ½è¢«é€æ˜çš„æ›¿æ¢æˆå­ç±»ï¼Œä¸”æ›¿æ¢æˆå­ç±»åï¼Œç¨‹åºè¡Œä¸ºä¸ä¼šå‘ç”Ÿé—®é¢˜</strong></p><p>ä¸åº”è¯¥æ»¥ç”¨ç»§æ‰¿å…³ç³»ï¼Œé¸µé¸Ÿæ˜¯å¦æ˜¯é¸Ÿçš„å­ç±»ï¼ˆä¸ä¼šé£ï¼‰ï¼Œé²¸é±¼æ˜¯å¦æ˜¯é±¼çš„å­ç±»ï¼ˆæ²¡æœ‰è…®ï¼‰ï¼Œç»§æ‰¿å…·æœ‰ä¾µå…¥æ€§ï¼Œå½“éœ€è¦ä½¿ç”¨ç»§æ‰¿å…³ç³»æ—¶éœ€è¦è¾¨æ˜æ˜¯å¦æ˜¯çœŸæ­£çš„ç»§æ‰¿ï¼Œ<strong>çˆ¶ç±»çš„æ¯ä¸ªæ–¹æ³•éƒ½å¿…é¡»é€‚ç”¨äºå­ç±»</strong></p><ol type="1"><li>å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†æ˜¯ä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•</li><li>å­ç±»å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•</li><li>å­ç±»é‡è½½çˆ¶ç±»æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å½¢å‚è¦æ¯”çˆ¶ç±»æ–¹æ³•æ›´ä¸ºå®½æ¾</li><li>å­ç±»å®ç°çˆ¶ç±»æŠ½è±¡æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„è¿”å›å€¼è¦æ¯”çˆ¶ç±»æ–¹æ³•æ›´ä¸ºä¸¥æ ¼</li></ol><h2 id="è¿ªç±³ç‰¹æ³•åˆ™">è¿ªç±³ç‰¹æ³•åˆ™</h2><blockquote><p><em>talk only to your immediate friends. â€”â€” Ian Holland</em></p><p><em>åªå’Œç›´æ¥çš„æœ‹å‹äº¤æµ</em></p></blockquote><p>è¿ªç±³ç‰¹æ³•åˆ™ä¹Ÿç§°ä¸ºæœ€å°‘çŸ¥é“åŸåˆ™ï¼Œæœ€å°‘çŸ¥é“åŒ…å«ä¸¤ä¸ªç›®çš„ï¼š</p><ul><li><strong>åªå’Œç›´æ¥çš„æœ‹å‹äº¤äº’</strong><ul><li>ä¾‹å¦‚ MVCæ¶æ„ï¼Œè§†å›¾å±‚å’Œä¸šåŠ¡å±‚äº¤äº’ï¼Œä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚äº¤äº’ï¼Œè§†å›¾å±‚ä¸åº”è¯¥å’ŒæŒä¹…å±‚äº§ç”Ÿè”ç³»</li></ul></li><li><strong>è¾ƒå°‘å¯¹æœ‹å‹çš„äº†è§£</strong><ul><li>ç±»é—¨é¢æ¨¡å¼ï¼ˆé—¨é¢æŒ‡æš´éœ²é‡è¦å·¥ä½œçš„ç®€å•å…¥å£ï¼Œè€Œè¿ªç±³ç‰¹æ³•åˆ™åœ¨äºåªæš´éœ²è¯¥æš´éœ²çš„å…¥å£ï¼Œè¿˜æ˜¯æœ‰æ‰€åŒºåˆ«ï¼‰æ€æƒ³ï¼Œå¯¹å¤–åªæš´éœ²èƒ½å¤Ÿæ»¡è¶³å¤–éƒ¨éœ€è¦çš„å†…å®¹</li></ul></li></ul><p><strong>ç›®çš„åœ¨äºé™ä½ç±»ä¹‹é—´çš„è€¦åˆå…³ç³»</strong></p><h2 id="æ¥å£éš”ç¦»">æ¥å£éš”ç¦»</h2><blockquote><p><em>Interface Segregation Principle, ISP</em></p><p><em>ä½è€¦åˆã€é«˜å†…èšä¸­çš„é«˜å†…èš</em></p></blockquote><p>æ¥å£éš”ç¦»åŸåˆ™ä¸­æ‰€è¯´çš„æ¥å£å¹¶ä¸æ˜¯ç‹­æ„çš„æŒ‡ Java ä¸­çš„Interfaceï¼Œè€Œæ˜¯ä¸€åˆ‡çš„æä¾›æ–¹æ³•å®šä¹‰çš„å¯¹è±¡ï¼Œä¾‹å¦‚ Javaä¸­çš„æ¥å£ã€æŠ½è±¡ç±»ã€å®ä½“ç±»</p><p>æ¥å£éš”ç¦»çš„åŸåˆ™ï¼š</p><ul><li>å®¢æˆ·ç«¯ä¸ä¾èµ–ä¸éœ€è¦çš„æ¥å£</li><li>ç±»é—´ä¾èµ–å…³ç³»å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Š</li><li>æ¥å£åº”è¯¥ç»†åŒ–ï¼Œä¸åº”è¯¥å…·å¤‡è‡ƒè‚¿çš„æ–¹æ³•</li></ul><p>ä¾‹å¦‚å‘é€æ–¹å¼çš„å®ç°ç±»<code>Send</code>ï¼Œæ­¤æ—¶å…·å¤‡ä¸¤ç§å‘é€æ–¹å¼ï¼šé‚®ä»¶å’ŒçŸ­ä¿¡ï¼Œå¦‚æœå°†æ–¹æ³•éƒ½æ”¾åœ¨<code>Send</code> ç±»ä¸­ï¼Œåˆ™åº”è¯¥åˆ†åˆ«å®šä¹‰ <code>sendEmail()</code> å’Œ<code>sendNotice()</code>ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸åˆ©äºåé¢çš„æ‹“å±•ï¼›å¥½çš„è§£å†³æ–¹æ³•åº”è¯¥æ˜¯å®šä¹‰æ¥å£ï¼Œç„¶ååˆ†åˆ«åˆ›å»º<code>EmailSend</code> å’Œ <code>NoticeSend</code>ä¸¤ä¸ªå®ç°ç±»ï¼Œè¿™å°±æ˜¯æ¥å£éš”ç¦»çš„ç›®çš„</p><p>æ¥å£éš”ç¦»å’Œå•ä¸€åŸåˆ™çœ‹ä¼¼å†²çªï¼Œç›®æ ‡æ˜¯è¾¾åˆ°äºŒè€…çš„å¹³è¡¡</p><p><strong>é¿å…æ¥å£æ±¡æŸ“</strong></p><h2 id="ä¾èµ–å€’ç½®">ä¾èµ–å€’ç½®</h2><blockquote><p><em>Dependence Inversion Principle,DIP</em></p><p><em>ä¸ä¾èµ–äºå…·ä½“å®ç°ï¼Œè€Œä¾èµ–äºæŠ½è±¡</em></p></blockquote><p>ä¸æ­£ç¡®çš„ä¾èµ–å…³ç³»æ˜¯ä¸Šå±‚è°ƒç”¨ä¸‹å±‚ï¼Œä¸Šå±‚ä¾èµ–ä¸‹å±‚</p><p>é¢å‘å¯¹è±¡å…¶å®å°±æ˜¯ä¾èµ–å€’ç½®çš„ä¸€ç§ä½“ç°ï¼Œä¾èµ–å€’ç½®è®©ä¸‹å±‚ä¾èµ–ä¸Šå±‚ï¼Œæ¯”å¦‚æ¥å£ï¼Œæ¥å£æ–¹æ³•çš„æ‰©å±•ä¼šå½±å“æ‰€æœ‰å®ç°ç±»ï¼Œä½†æŠ½è±¡å±‚çš„å˜åŠ¨è¿œè¿œå°‘äºå®ç°å±‚ï¼Œæ‰€ä»¥ä¾èµ–å€’ç½®å¯ä»¥å¾ˆå¥½åœ°é¿å…é¢‘ç¹çš„ä¿®æ”¹</p><p><strong>é¢å‘æ¥å£ç¼–ç¨‹</strong></p><h1 id="è¡¥å……">è¡¥å……</h1><h2 id="å¦‚ä½•æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™">å¦‚ä½•æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™</h2><p>é‡Œæ°æ›¿æ¢çš„åŸåˆ™æŒ‡ï¼šéœ€è¦ä½¿ç”¨çˆ¶ç±»çš„åœ°æ–¹å¯ä»¥æ›¿æ¢ä¸ºå­ç±»ä½¿ç”¨ï¼Œå› ä¸ºçˆ¶ç±»çš„æ–¹æ³•åœ¨å­ç±»ä¸Šåº”è¯¥ä¿æŒä¸€è‡´</p><p>åœ¨å®é™…ä¸­é‡åˆ°ç›´æ¥ç»§æ‰¿ä¸èƒ½æ»¡è¶³é‡Œæ°æ›¿æ¢çš„åœºæ™¯ï¼Œå°±<strong>è¯´æ˜æŠ½è±¡ä¸è¶³ï¼Œéœ€è¦å‘ä¸ŠæŠ½è±¡</strong></p><p>å¦‚æœä¸€ä¸ª <code>Add</code> ç±»çš„ <code>compute(int n)</code>æ“ä½œä¸ºåŠ æ³•ï¼Œå‡æ³•ä¹Ÿæƒ³è¦è¿›è¡Œå®ç°ï¼Œåˆ™ç»§æ‰¿ <code>Add</code> ç±»åé‡å†™äº†<code>compute(int n)</code>æ–¹æ³•ï¼Œæ­¤æ—¶åˆ™è¿åäº†é‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œæ•´ä¸ªæ–¹æ³•çš„å®ç°è¢«é‡å†™äº†</p><p>å‘ä¸ŠæŠ½è±¡å‡º <code>Compute</code> æ¥å£ï¼Œå³å¯ä»¥å®ç°é‡Œæ°æ›¿æ¢åŸåˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Compute</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(<span class="type">int</span> n)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Add</span> <span class="keyword">implements</span> <span class="title class_">Compute</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> n)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åŠ æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Subtract</span> <span class="keyword">implements</span> <span class="title class_">Compute</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> n)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‡æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><p><ahref="https://refactoringguru.cn/design-patterns">å¸¸ç”¨è®¾è®¡æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ(refactoringguru.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘ </category>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä»£ç è§„èŒƒ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
